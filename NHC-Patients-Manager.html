<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>NHC Patients Manager — Gestion Patients v1.4.0</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
<style>
/* ===== Design System Variables - Medical UI ===== */
:root {
  /* Palette médicale moderne - Bleu et turquoise pastel */
  --primary: #7EC8E3;
  --primary-dark: #5DB3D4;
  --primary-light: #9DD9ED;
  --secondary: #6DD5ED;
  --success: #52D1A6;
  --warning: #FFB67A;
  --danger: #FF8585;
  --info: #7EC8E3;

  /* Fonds très lumineux et clairs */
  --bg-primary: #FFFFFF;
  --bg-secondary: #F8FAFB;
  --bg-tertiary: #F0F4F8;
  --bg-dark: #FAFBFC;

  /* Textes doux et lisibles */
  --text-primary: #1A2332;
  --text-secondary: #6B7785;
  --text-muted: #9BA5B1;
  --text-inverse: #ffffff;

  /* Bordures très subtiles */
  --border: #E8ECF0;
  --border-light: #F2F5F8;

  /* Ombres très douces - effet flottant */
  --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.03);
  --shadow: 0 2px 8px 0 rgb(0 0 0 / 0.06);
  --shadow-md: 0 4px 12px 0 rgb(0 0 0 / 0.08);
  --shadow-lg: 0 8px 20px 0 rgb(0 0 0 / 0.10);
  --shadow-xl: 0 12px 32px 0 rgb(0 0 0 / 0.12);

  /* Coins arrondis - style moderne et doux */
  --radius-sm: 0.5rem;
  --radius: 0.75rem;
  --radius-md: 1rem;
  --radius-lg: 1.25rem;
  --radius-full: 9999px;

  /* Transitions fluides */
  --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
  --transition-fast: all 0.18s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Dark Mode */
[data-theme="dark"] {
  --bg-primary: #0f172a;
  --bg-secondary: #1e293b;
  --bg-tertiary: #334155;
  --bg-dark: #020617;
  
  --text-primary: #f1f5f9;
  --text-secondary: #cbd5e1;
  --text-muted: #94a3b8;
  
  --border: #334155;
  --border-light: #475569;
}

/* ===== Base Styles ===== */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  font-size: 16px;
  scroll-behavior: smooth;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  color: var(--text-primary);
  background: var(--bg-secondary);
  line-height: 1.6;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* ===== Layout ===== */
.app {
  display: grid;
  grid-template-columns: 280px 1fr;
  min-height: 100vh;
  transition: var(--transition);
}

.app.sidebar-collapsed {
  grid-template-columns: 80px 1fr;
}

/* ===== Sidebar - Medical UI ===== */
.sidebar {
  background: var(--bg-primary);
  color: var(--text-primary);
  padding: 2rem 1.25rem;
  position: sticky;
  top: 0;
  height: 100vh;
  overflow-y: auto;
  overflow-x: hidden;
  transition: var(--transition);
  box-shadow: 2px 0 16px 0 rgb(0 0 0 / 0.04);
  border-right: 1px solid var(--border-light);
  z-index: 30;
}

.brand {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-bottom: 2rem;
  padding: 0 0.5rem;
}

.logo {
  width: 52px;
  height: 52px;
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  border-radius: var(--radius-lg);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  color: white;
  font-size: 1.25rem;
  box-shadow: var(--shadow);
  flex-shrink: 0;
}

.brand-title {
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--text-primary);
  line-height: 1.3;
}

.nav-section {
  margin: 1.5rem 0 0.5rem;
  padding: 0 0.75rem;
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--text-muted);
  font-weight: 600;
}

.nav {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 0.875rem;
  padding: 0.875rem 1rem;
  border-radius: var(--radius-md);
  background: transparent;
  border: none;
  color: var(--text-secondary);
  cursor: pointer;
  transition: var(--transition-fast);
  position: relative;
  text-align: left;
  width: 100%;
  font-size: 0.9rem;
  font-weight: 500;
}

.nav-item:hover {
  background: var(--bg-secondary);
  color: var(--text-primary);
  transform: translateX(3px);
}

.nav-item.active {
  background: linear-gradient(135deg, rgba(126, 200, 227, 0.12) 0%, rgba(109, 213, 237, 0.12) 100%);
  color: var(--primary-dark);
  box-shadow: var(--shadow-sm);
  border-left: 3px solid var(--primary);
  font-weight: 600;
}

.nav-icon {
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.nav-badge {
  margin-left: auto;
  padding: 0.25rem 0.625rem;
  font-size: 0.75rem;
  background: var(--primary);
  color: white;
  border-radius: var(--radius-full);
  font-weight: 600;
  min-width: 24px;
  text-align: center;
}

/* ===== Main Content ===== */
.main {
  padding: 1.5rem;
  background: var(--bg-secondary);
  min-height: 100vh;
}

.header {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-bottom: 1.5rem;
  flex-wrap: wrap;
}

.search-box {
  flex: 1;
  min-width: 300px;
  position: relative;
}

.search-input {
  width: 100%;
  padding: 0.875rem 1.25rem 0.875rem 3rem;
  border: 1.5px solid var(--border);
  border-radius: var(--radius-lg);
  background: var(--bg-primary);
  font-size: 0.9rem;
  transition: var(--transition-fast);
  box-shadow: var(--shadow-sm);
}

.search-input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(126, 200, 227, 0.15);
  background: white;
}

.search-icon {
  position: absolute;
  left: 1rem;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-muted);
  pointer-events: none;
}

/* ===== Buttons - Medical UI ===== */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 0.625rem;
  padding: 0.875rem 1.5rem;
  border-radius: var(--radius-md);
  font-weight: 600;
  font-size: 0.9rem;
  cursor: pointer;
  transition: var(--transition-fast);
  border: none;
  white-space: nowrap;
  letter-spacing: 0.01em;
}

.btn-primary {
  background: var(--primary);
  color: white;
  box-shadow: var(--shadow);
}

.btn-primary:hover {
  background: var(--primary-dark);
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.btn-secondary {
  background: var(--bg-primary);
  color: var(--text-primary);
  border: 1.5px solid var(--border);
  box-shadow: var(--shadow-sm);
}

.btn-secondary:hover {
  background: var(--bg-secondary);
  border-color: var(--primary);
  transform: translateY(-1px);
}

.btn-danger {
  background: var(--danger);
  color: white;
  box-shadow: var(--shadow);
}

.btn-danger:hover {
  background: #FF6B6B;
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.btn-success {
  background: var(--success);
  color: white;
  box-shadow: var(--shadow);
}

.btn-success:hover {
  background: #42C596;
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.btn-icon {
  padding: 0.5rem;
  border-radius: var(--radius-full);
}

/* ===== Cards - Medical UI ===== */
.card {
  background: var(--bg-primary);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow);
  border: 1px solid var(--border-light);
  overflow: hidden;
  transition: var(--transition);
}

.card:hover {
  box-shadow: var(--shadow-md);
  border-color: var(--border);
}

.card-header {
  padding: 1.5rem 1.75rem;
  border-bottom: 1px solid var(--border-light);
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: var(--bg-secondary);
}

.card-title {
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--text-primary);
  letter-spacing: -0.01em;
}

.card-body {
  padding: 1.75rem;
}

/* ===== KPI Cards - Medical UI ===== */
.kpi-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1.5rem;
  margin-bottom: 2rem;
}

.kpi-card {
  background: var(--bg-primary);
  padding: 2rem;
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow);
  border: 1px solid var(--border-light);
  position: relative;
  overflow: hidden;
  transition: var(--transition);
}

.kpi-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 4px;
  height: 100%;
  background: var(--primary);
}

.kpi-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-md);
  border-color: var(--primary);
}

.kpi-value {
  font-size: 2.25rem;
  font-weight: 700;
  margin: 0.75rem 0 0.5rem 0;
  color: var(--primary-dark);
  letter-spacing: -0.02em;
}

.kpi-label {
  font-size: 0.875rem;
  color: var(--text-secondary);
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.kpi-change {
  font-size: 0.8rem;
  margin-top: 0.75rem;
  display: flex;
  align-items: center;
  gap: 0.375rem;
  font-weight: 500;
}

.kpi-change.positive {
  color: var(--success);
}

.kpi-change.negative {
  color: var(--danger);
}

/* ===== Tables - Medical UI ===== */
.table-container {
  overflow-x: auto;
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow);
  border: 1px solid var(--border-light);
}

.table {
  width: 100%;
  background: var(--bg-primary);
  border-collapse: separate;
  border-spacing: 0;
  table-layout: fixed;
}

.table thead {
  background: var(--bg-secondary);
}

.table th {
  padding: 1.125rem 1.25rem;
  text-align: left;
  font-size: 0.75rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.075em;
  color: var(--text-secondary);
  border-bottom: 2px solid var(--border);
}

.table td {
  padding: 1.125rem 1.25rem;
  border-bottom: 1px solid var(--border-light);
  font-size: 0.9rem;
  overflow: hidden;
  text-overflow: ellipsis;
  color: var(--text-primary);
}

.table tbody tr {
  transition: var(--transition-fast);
}

.table tbody tr:hover {
  background: rgba(126, 200, 227, 0.04);
}

/* ===== Badge - Medical UI ===== */
.badge {
  display: inline-flex;
  align-items: center;
  padding: 0.375rem 0.875rem;
  font-size: 0.75rem;
  font-weight: 600;
  border-radius: var(--radius-full);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.badge-success {
  background: rgba(82, 209, 166, 0.12);
  color: var(--success);
  border: 1px solid rgba(82, 209, 166, 0.25);
}

.badge-warning {
  background: rgba(255, 182, 122, 0.12);
  color: var(--warning);
  border: 1px solid rgba(255, 182, 122, 0.25);
}

.badge-danger {
  background: rgba(255, 133, 133, 0.12);
  color: var(--danger);
  border: 1px solid rgba(255, 133, 133, 0.25);
}

.badge-info {
  background: rgba(126, 200, 227, 0.12);
  color: var(--info);
  border: 1px solid rgba(126, 200, 227, 0.25);
}

/* ===== Progress Bar ===== */
.progress {
  height: 8px;
  background: var(--bg-tertiary);
  border-radius: var(--radius-full);
  overflow: hidden;
  position: relative;
}

.progress-bar {
  height: 100%;
  border-radius: var(--radius-full);
  transition: width 0.3s ease;
  position: relative;
  overflow: hidden;
}

.progress-bar::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0;
  right: 0;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
  animation: shimmer 2s infinite;
}

@keyframes shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

/* ===== Modal ===== */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(4px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 100;
  opacity: 0;
  visibility: hidden;
  transition: var(--transition);
}

.modal.active {
  opacity: 1;
  visibility: visible;
}

.modal-content {
  background: var(--bg-primary);
  border-radius: var(--radius-lg);
  width: 90%;
  max-width: 800px;
  max-height: 90vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  box-shadow: var(--shadow-xl);
  transform: scale(0.9);
  transition: var(--transition);
}

.modal.active .modal-content {
  transform: scale(1);
}

.modal-header {
  padding: 1.5rem;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.modal-title {
  font-size: 1.25rem;
  font-weight: 700;
}

.modal-close {
  background: none;
  border: none;
  font-size: 1.5rem;
  color: var(--text-muted);
  cursor: pointer;
  padding: 0.25rem;
  border-radius: var(--radius);
  transition: var(--transition-fast);
}

.modal-close:hover {
  background: var(--bg-tertiary);
  color: var(--text-primary);
}

.modal-body {
  padding: 1.5rem;
  overflow-y: auto;
  flex: 1;
}

.modal-footer {
  padding: 1rem 1.5rem;
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: flex-end;
  gap: 0.5rem;
}

/* ===== Modal with Sidebar ===== */
.modal-body-split {
  display: grid;
  grid-template-columns: 1fr;
  gap: 1.5rem;
  padding: 1.5rem;
  overflow-y: auto;
  flex: 1;
}

/* When sidebar is visible, use two column layout */
.modal-body-split.has-sidebar {
  grid-template-columns: 320px 1fr;
}

.patient-info-sidebar {
  background: var(--bg-secondary);
  border-radius: var(--radius-lg);
  padding: 1.5rem;
  height: fit-content;
  position: sticky;
  top: 0;
  box-shadow: var(--shadow-sm);
}

.modal-form-content {
  flex: 1;
  min-width: 0;
}

/* Responsive: Stack vertically on smaller screens */
@media (max-width: 1024px) {
  .modal-body-split {
    grid-template-columns: 1fr;
    gap: 1rem;
  }

  .patient-info-sidebar {
    position: static;
  }

  .modal-with-sidebar {
    max-width: 90% !important;
  }
}

/* ===== Tutorial System ===== */
.tutorial-modal .modal-content {
  max-width: 900px;
  max-height: 90vh;
  display: flex;
  flex-direction: column;
}

.tutorial-step {
  display: none;
}

.tutorial-step.active {
  display: block;
  animation: fadeInUp 0.4s ease;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.tutorial-header {
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  color: white;
  padding: 2rem;
  text-align: center;
}

.tutorial-header h2 {
  font-size: 1.75rem;
  margin-bottom: 0.5rem;
}

.tutorial-header p {
  opacity: 0.9;
  font-size: 1rem;
}

.tutorial-progress {
  display: flex;
  gap: 0.5rem;
  padding: 1rem 1.5rem;
  background: var(--bg-tertiary);
  border-bottom: 1px solid var(--border);
}

.tutorial-progress-dot {
  flex: 1;
  height: 4px;
  background: var(--border);
  border-radius: var(--radius-full);
  transition: var(--transition);
}

.tutorial-progress-dot.completed {
  background: var(--primary);
}

.tutorial-progress-dot.active {
  background: var(--primary);
  box-shadow: 0 0 8px var(--primary);
}

.tutorial-content {
  padding: 2rem;
  overflow-y: auto;
  flex: 1;
}

.tutorial-step-number {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  color: white;
  border-radius: var(--radius-full);
  font-weight: 700;
  font-size: 1.25rem;
  margin-bottom: 1rem;
  box-shadow: var(--shadow);
}

.tutorial-content h3 {
  font-size: 1.5rem;
  color: var(--text-primary);
  margin-bottom: 1rem;
}

.tutorial-content p {
  color: var(--text-secondary);
  line-height: 1.8;
  margin-bottom: 1.5rem;
  font-size: 1rem;
}

.tutorial-feature {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  padding: 1.5rem;
  margin-bottom: 1.5rem;
}

.tutorial-feature h4 {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  font-size: 1.1rem;
  color: var(--text-primary);
  margin-bottom: 0.75rem;
}

.tutorial-feature-icon {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
  background: var(--primary);
  color: white;
  border-radius: var(--radius);
  flex-shrink: 0;
}

.tutorial-feature p {
  margin: 0;
  padding-left: 2.5rem;
  font-size: 0.95rem;
}

.tutorial-feature ul {
  margin: 0.75rem 0 0 0;
  padding-left: 4rem;
}

.tutorial-feature li {
  color: var(--text-secondary);
  margin-bottom: 0.5rem;
  font-size: 0.95rem;
}

.tutorial-tip {
  background: #fef3c7;
  border-left: 4px solid #f59e0b;
  padding: 1rem 1.25rem;
  border-radius: var(--radius);
  margin: 1.5rem 0;
}

[data-theme="dark"] .tutorial-tip {
  background: #78350f;
  border-left-color: #fbbf24;
}

.tutorial-tip strong {
  color: #f59e0b;
  display: block;
  margin-bottom: 0.5rem;
}

[data-theme="dark"] .tutorial-tip strong {
  color: #fbbf24;
}

.tutorial-tip p {
  margin: 0;
  color: #78350f;
  font-size: 0.95rem;
}

[data-theme="dark"] .tutorial-tip p {
  color: #fef3c7;
}

.tutorial-navigation {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 1rem;
  padding: 1.5rem;
  border-top: 1px solid var(--border);
  background: var(--bg-secondary);
}

.tutorial-step-indicator {
  color: var(--text-muted);
  font-size: 0.9rem;
  font-weight: 600;
}

.tutorial-nav-buttons {
  display: flex;
  gap: 0.75rem;
}

.tutorial-screenshot {
  background: var(--bg-tertiary);
  border: 2px solid var(--border);
  border-radius: var(--radius-md);
  padding: 1rem;
  margin: 1.5rem 0;
  text-align: center;
}

.tutorial-screenshot-placeholder {
  background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
  height: 200px;
  border-radius: var(--radius);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-muted);
  font-size: 3rem;
  margin-bottom: 0.75rem;
}

.tutorial-screenshot-caption {
  font-size: 0.85rem;
  color: var(--text-muted);
  font-style: italic;
}

/* ===== Patient Details Card ===== */
.patient-details-card {
  font-size: 0.95rem;
}

.info-section {
  padding: 1.5rem;
  background: var(--bg-secondary);
  border-radius: var(--radius-lg);
  border: 1px solid var(--border);
}

.info-item {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.info-label {
  font-size: 0.8rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  font-weight: 600;
}

.info-value {
  font-size: 1rem;
  color: var(--text-primary);
  font-weight: 500;
}

/* ===== Form Elements - Medical UI ===== */
.form-group {
  margin-bottom: 1.5rem;
}

.form-label {
  display: block;
  margin-bottom: 0.625rem;
  font-size: 0.875rem;
  font-weight: 600;
  color: var(--text-primary);
  letter-spacing: 0.01em;
}

.form-input,
.form-select,
.form-textarea {
  width: 100%;
  padding: 0.875rem 1rem;
  border: 1.5px solid var(--border);
  border-radius: var(--radius-md);
  background: var(--bg-primary);
  font-size: 0.9rem;
  transition: var(--transition-fast);
  box-shadow: var(--shadow-sm);
}

.form-input:focus,
.form-select:focus,
.form-textarea:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(126, 200, 227, 0.15);
  background: white;
}

.form-textarea {
  min-height: 100px;
  resize: vertical;
}

.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1rem;
}

/* ===== Searchable Select Container ===== */
.searchable-select-container {
  position: relative;
  display: block;
  width: 100%;
}

.searchable-select-dropdown {
  display: none;
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  max-height: 300px;
  overflow-y: auto;
  background: var(--bg-primary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow-lg);
  z-index: 1000;
  margin-top: 2px;
}

.searchable-select-option {
  padding: 0.75rem;
  cursor: pointer;
  border-bottom: 1px solid var(--border);
  transition: background 0.2s;
}

.searchable-select-option:hover {
  background: var(--bg-secondary);
}

.searchable-select-option:last-child {
  border-bottom: none;
}

/* ===== Toast Notifications ===== */
.toast-container {
  position: fixed;
  bottom: 1rem;
  right: 1rem;
  z-index: 99;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.toast {
  background: var(--bg-dark);
  color: white;
  padding: 1rem 1.5rem;
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-xl);
  display: flex;
  align-items: center;
  gap: 0.75rem;
  min-width: 300px;
  animation: slideIn 0.3s ease;
}

@keyframes slideIn {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

.toast.success {
  background: var(--success);
}

.toast.error {
  background: var(--danger);
}

.toast.warning {
  background: var(--warning);
}

/* ===== Dropdown Menu ===== */
.dropdown {
  position: relative;
}

.dropdown-menu {
  position: absolute;
  top: 100%;
  right: 0;
  margin-top: 0.5rem;
  background: var(--bg-primary);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-lg);
  min-width: 200px;
  opacity: 0;
  visibility: hidden;
  transform: translateY(-10px);
  transition: var(--transition-fast);
  z-index: 50;
}

.dropdown-menu.show {
  opacity: 1;
  visibility: visible;
  transform: translateY(0);
}

.dropdown-item {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.75rem 1rem;
  cursor: pointer;
  transition: var(--transition-fast);
  border: none;
  background: none;
  width: 100%;
  text-align: left;
  color: var(--text-primary);
}

.dropdown-item:hover {
  background: var(--bg-secondary);
}

.dropdown-divider {
  height: 1px;
  background: var(--border);
  margin: 0.25rem 0;
}

/* ===== Charts ===== */
.chart-container {
  position: relative;
  height: 300px;
  padding: 1rem;
}

.stat-bars {
  display: flex;
  align-items: flex-end;
  gap: 0.5rem;
  height: 150px;
  padding: 1rem 0;
}

.stat-bar {
  flex: 1;
  background: linear-gradient(180deg, var(--primary-light) 0%, var(--primary-dark) 100%);
  border-radius: var(--radius) var(--radius) 0 0;
  position: relative;
  min-width: 30px;
  transition: var(--transition);
}

.stat-bar:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-md);
}

.stat-bar.success {
  background: linear-gradient(180deg, #34d399 0%, var(--success) 100%);
}

.stat-bar.warning {
  background: linear-gradient(180deg, #fbbf24 0%, var(--warning) 100%);
}

.stat-bar.danger {
  background: linear-gradient(180deg, #f87171 0%, var(--danger) 100%);
}

/* ===== Calendar Styles ===== */
.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 0.5rem;
}

.calendar-day-header {
  text-align: center;
  font-weight: 600;
  color: var(--text-secondary);
  padding: 0.75rem;
  font-size: 0.875rem;
  background: var(--bg-secondary);
  border-radius: var(--radius-sm);
}

.calendar-day {
  min-height: 100px;
  padding: 0.5rem;
  background: var(--bg-primary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  position: relative;
  transition: var(--transition);
  cursor: pointer;
}

.calendar-day:hover {
  border-color: var(--primary);
  box-shadow: var(--shadow-sm);
  transform: translateY(-2px);
}

.calendar-day.other-month {
  background: var(--bg-tertiary);
  opacity: 0.5;
}

.calendar-day.today {
  border: 2px solid var(--primary);
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
}

.calendar-day-number {
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 0.25rem;
  font-size: 0.875rem;
}

.calendar-day.today .calendar-day-number {
  color: var(--primary);
  font-size: 1rem;
}

.calendar-events {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
  margin-top: 0.5rem;
}

.calendar-event {
  font-size: 0.75rem;
  padding: 0.25rem 0.5rem;
  border-radius: var(--radius-sm);
  display: flex;
  align-items: center;
  gap: 0.25rem;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  transition: var(--transition);
}

.calendar-event:hover {
  transform: scale(1.02);
  box-shadow: var(--shadow-sm);
}

.calendar-event.appointment {
  background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
  color: #667eea;
  border-left: 3px solid #667eea;
}

.calendar-event.switch {
  background: linear-gradient(135deg, rgba(240, 147, 251, 0.2) 0%, rgba(245, 87, 108, 0.2) 100%);
  color: #f093fb;
  border-left: 3px solid #f093fb;
}

.calendar-event.to-call {
  background: linear-gradient(135deg, rgba(251, 191, 36, 0.15) 0%, rgba(245, 158, 11, 0.15) 100%);
  color: #d97706;
  border: 1px dashed #f59e0b;
  border-left: 3px solid #f59e0b;
  font-style: italic;
}

.calendar-event.completed {
  background: linear-gradient(135deg, rgba(34, 197, 94, 0.2) 0%, rgba(22, 163, 74, 0.2) 100%);
  color: #22c55e;
  border-left: 3px solid #22c55e;
  opacity: 0.85;
}

.calendar-event-icon {
  font-size: 0.875rem;
  flex-shrink: 0;
}

.calendar-more-events {
  font-size: 0.7rem;
  color: var(--text-muted);
  text-align: center;
  padding: 0.25rem;
  cursor: pointer;
  font-weight: 600;
}

.calendar-more-events:hover {
  color: var(--primary);
}

/* ===== Loading States ===== */
.skeleton {
  background: linear-gradient(90deg, var(--bg-tertiary) 25%, var(--bg-secondary) 50%, var(--bg-tertiary) 75%);
  background-size: 200% 100%;
  animation: loading 1.5s infinite;
  border-radius: var(--radius);
}

@keyframes loading {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

.spinner {
  width: 40px;
  height: 40px;
  border: 3px solid var(--bg-tertiary);
  border-top-color: var(--primary);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* ===== Responsive Design ===== */
@media (max-width: 1024px) {
  .app {
    grid-template-columns: 1fr;
  }
  
  .sidebar {
    position: fixed;
    transform: translateX(-100%);
    transition: transform 0.3s ease;
  }
  
  .sidebar.open {
    transform: translateX(0);
  }
  
  .kpi-grid {
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  }
}

@media (max-width: 768px) {
  .header {
    flex-direction: column;
    align-items: stretch;
  }
  
  .search-box {
    min-width: 100%;
  }
  
  .form-grid {
    grid-template-columns: 1fr;
  }
  
  .table {
    font-size: 0.85rem;
  }
  
  .table th,
  .table td {
    padding: 0.75rem 0.5rem;
  }
}

/* ===== Utilities ===== */
.hidden { display: none !important; }
.view { display: none; }
.view.active { display: block; }

.text-center { text-align: center; }
.text-right { text-align: right; }
.text-muted { color: var(--text-muted); }
.text-small { font-size: 0.875rem; }

.mt-1 { margin-top: 0.5rem; }
.mt-2 { margin-top: 1rem; }
.mt-3 { margin-top: 1.5rem; }
.mb-1 { margin-bottom: 0.5rem; }
.mb-2 { margin-bottom: 1rem; }
.mb-3 { margin-bottom: 1.5rem; }

.flex { display: flex; }
.flex-center { display: flex; align-items: center; justify-content: center; }
.flex-between { display: flex; align-items: center; justify-content: space-between; }
.gap-1 { gap: 0.5rem; }
.gap-2 { gap: 1rem; }

/* ===== Print Styles ===== */
@media print {
  .sidebar,
  .header,
  .btn,
  .modal {
    display: none !important;
  }
  
  .app {
    grid-template-columns: 1fr;
  }
  
  .main {
    padding: 0;
  }
}

/* ===== Animations ===== */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.fade-in {
  animation: fadeIn 0.3s ease;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.slide-up {
  animation: slideUp 0.3s ease;
}

/* New Advanced Animations */
@keyframes successPulse {
  0%, 100% {
    transform: scale(1);
    box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
  }
  50% {
    transform: scale(1.05);
    box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
  }
}

@keyframes countUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-10px); }
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  75% { transform: translateX(5px); }
}

@keyframes slideInRight {
  from {
    opacity: 0;
    transform: translateX(100%);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

@keyframes slideOutRight {
  from {
    opacity: 1;
    transform: translateX(0);
  }
  to {
    opacity: 0;
    transform: translateX(100%);
  }
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes bounceIn {
  0% {
    opacity: 0;
    transform: scale(0.3);
  }
  50% {
    opacity: 1;
    transform: scale(1.05);
  }
  70% {
    transform: scale(0.9);
  }
  100% {
    transform: scale(1);
  }
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

@keyframes wiggle {
  0%, 100% { transform: rotate(-3deg); }
  50% { transform: rotate(3deg); }
}

.animate-success {
  animation: successPulse 0.6s ease-out;
}

.animate-count-up {
  animation: countUp 0.5s ease-out;
}

.animate-float {
  animation: float 3s ease-in-out infinite;
}

.animate-bounce-in {
  animation: bounceIn 0.5s ease-out;
}

.animate-wiggle {
  animation: wiggle 0.3s ease-in-out 3;
}

/* ===== Cycle Tabs ===== */
.cycle-tabs {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
}

.cycle-tab {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem;
  background: var(--bg-secondary);
  border: 2px solid var(--border);
  border-radius: var(--radius-lg);
  cursor: pointer;
  transition: var(--transition);
  position: relative;
  overflow: hidden;
}

.cycle-tab:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
  border-color: var(--primary);
}

.cycle-tab.active {
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  color: white;
  border-color: var(--primary-dark);
}

.cycle-tab.active .cycle-tab-subtitle {
  color: rgba(255, 255, 255, 0.9);
}

.cycle-tab-icon {
  font-size: 1.5rem;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-primary);
  border-radius: var(--radius-md);
}

.cycle-tab.active .cycle-tab-icon {
  background: rgba(255, 255, 255, 0.2);
}

.cycle-tab-title {
  font-weight: 700;
  font-size: 1rem;
}

.cycle-tab-subtitle {
  font-size: 0.75rem;
  color: var(--text-muted);
  margin-top: 0.25rem;
}

.cycle-tab-count {
  margin-left: auto;
  padding: 0.25rem 0.75rem;
  background: var(--bg-primary);
  border-radius: var(--radius-full);
  font-weight: 700;
  font-size: 0.9rem;
}

.cycle-tab.active .cycle-tab-count {
  background: rgba(255, 255, 255, 0.2);
}

/* ===== Ordonnance Cards ===== */
.ordo-card {
  display: flex;
  align-items: center;
  padding: 1rem;
  background: var(--bg-primary);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  margin-bottom: 0.5rem;
  transition: var(--transition);
}

.ordo-card:hover {
  background: var(--bg-secondary);
  border-color: var(--primary);
}

.ordo-card.expired {
  border-left: 4px solid var(--danger);
  background: rgba(239, 68, 68, 0.05);
}

.ordo-card.warning {
  border-left: 4px solid var(--warning);
  background: rgba(245, 158, 11, 0.05);
}

.ordo-card.valid {
  border-left: 4px solid var(--success);
}

.ordo-info {
  flex: 1;
}

.ordo-patient {
  font-weight: 700;
  font-size: 1rem;
  margin-bottom: 0.25rem;
}

.ordo-details {
  display: flex;
  gap: 1rem;
  font-size: 0.875rem;
  color: var(--text-secondary);
}

.ordo-detail {
  display: flex;
  align-items: center;
  gap: 0.25rem;
}

.ordo-actions {
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

.ordo-status {
  padding: 0.5rem 1rem;
  border-radius: var(--radius-md);
  font-weight: 600;
  font-size: 0.875rem;
  text-align: center;
  min-width: 100px;
}

.ordo-status.expired {
  background: var(--danger);
  color: white;
}

.ordo-status.urgent {
  background: rgba(239, 68, 68, 0.1);
  color: var(--danger);
}

.ordo-status.warning {
  background: rgba(245, 158, 11, 0.1);
  color: var(--warning);
}

.ordo-status.valid {
  background: rgba(16, 185, 129, 0.1);
  color: var(--success);
}

/* ===== Calendar Grid ===== */
.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 0.25rem;
  margin-top: 1rem;
}

.calendar-header {
  padding: 0.5rem;
  text-align: center;
  font-weight: 600;
  font-size: 0.75rem;
  text-transform: uppercase;
  color: var(--text-secondary);
  background: var(--bg-tertiary);
  border-radius: var(--radius-sm);
}

.calendar-day {
  padding: 0.5rem;
  min-height: 60px;
  background: var(--bg-primary);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-sm);
  font-size: 0.75rem;
  position: relative;
}

.calendar-day.has-renewal {
  background: rgba(245, 158, 11, 0.1);
  border-color: var(--warning);
}

.calendar-day.has-expired {
  background: rgba(239, 68, 68, 0.1);
  border-color: var(--danger);
}

.calendar-day-number {
  font-weight: 600;
  margin-bottom: 0.25rem;
}

.calendar-event {
  font-size: 0.65rem;
  padding: 0.125rem 0.25rem;
  background: var(--primary);
  color: white;
  border-radius: var(--radius-sm);
  margin-top: 0.125rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* ===== Empty States ===== */
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 3rem 2rem;
  text-align: center;
  min-height: 300px;
}

.empty-state-icon {
  width: 120px;
  height: 120px;
  margin-bottom: 1.5rem;
  opacity: 0.6;
  animation: float 3s ease-in-out infinite;
}

.empty-state-title {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 0.5rem;
}

.empty-state-description {
  font-size: 1rem;
  color: var(--text-secondary);
  margin-bottom: 1.5rem;
  max-width: 400px;
}

.empty-state-action {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1.5rem;
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  color: white;
  border: none;
  border-radius: var(--radius-md);
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  box-shadow: var(--shadow);
}

.empty-state-action:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

/* ===== Glassmorphism Effects ===== */
.glass {
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px) saturate(180%);
  -webkit-backdrop-filter: blur(10px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

[data-theme="dark"] .glass {
  background: rgba(15, 23, 42, 0.6);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.modal.glass .modal-content {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
}

[data-theme="dark"] .modal.glass .modal-content {
  background: rgba(15, 23, 42, 0.95);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

/* ===== Command Palette ===== */
.command-palette {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(4px);
  display: flex;
  align-items: flex-start;
  justify-content: center;
  padding-top: 15vh;
  z-index: 200;
  opacity: 0;
  visibility: hidden;
  transition: var(--transition);
}

.command-palette.active {
  opacity: 1;
  visibility: visible;
}

.command-palette-content {
  background: var(--bg-primary);
  border-radius: var(--radius-lg);
  width: 90%;
  max-width: 640px;
  box-shadow: var(--shadow-xl);
  overflow: hidden;
  transform: scale(0.95) translateY(-20px);
  transition: var(--transition);
}

.command-palette.active .command-palette-content {
  transform: scale(1) translateY(0);
}

.command-palette-search {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 1.25rem;
  border-bottom: 1px solid var(--border);
}

.command-palette-search svg {
  color: var(--text-muted);
  flex-shrink: 0;
}

.command-palette-input {
  flex: 1;
  border: none;
  background: transparent;
  font-size: 1.1rem;
  color: var(--text-primary);
  outline: none;
}

.command-palette-input::placeholder {
  color: var(--text-muted);
}

.command-palette-results {
  max-height: 400px;
  overflow-y: auto;
  padding: 0.5rem;
}

.command-palette-item {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.75rem 1rem;
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: var(--transition-fast);
  border: 1px solid transparent;
}

.command-palette-item:hover,
.command-palette-item.selected {
  background: var(--bg-secondary);
  border-color: var(--primary);
}

.command-palette-item-icon {
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-tertiary);
  border-radius: var(--radius);
  flex-shrink: 0;
}

.command-palette-item.selected .command-palette-item-icon {
  background: var(--primary);
  color: white;
}

.command-palette-item-content {
  flex: 1;
}

.command-palette-item-title {
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 0.125rem;
}

.command-palette-item-description {
  font-size: 0.875rem;
  color: var(--text-secondary);
}

.command-palette-item-kbd {
  padding: 0.25rem 0.5rem;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  font-size: 0.75rem;
  font-family: monospace;
  color: var(--text-secondary);
}

.command-palette-empty {
  text-align: center;
  padding: 3rem 2rem;
  color: var(--text-muted);
}

/* ===== Breadcrumbs ===== */
.breadcrumbs {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 1rem;
  padding: 0.75rem 1rem;
  background: var(--bg-primary);
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-sm);
  flex-wrap: wrap;
}

.breadcrumb-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  color: var(--text-secondary);
  font-size: 0.9rem;
  transition: var(--transition-fast);
}

.breadcrumb-item:hover {
  color: var(--primary);
}

.breadcrumb-item.active {
  color: var(--text-primary);
  font-weight: 600;
}

.breadcrumb-separator {
  color: var(--text-muted);
  font-size: 0.75rem;
}

/* ===== Enhanced Loading Skeleton ===== */
.skeleton-card {
  background: var(--bg-primary);
  border-radius: var(--radius-lg);
  padding: 1.5rem;
  box-shadow: var(--shadow);
}

.skeleton-line {
  height: 16px;
  background: linear-gradient(
    90deg,
    var(--bg-secondary) 25%,
    var(--bg-tertiary) 50%,
    var(--bg-secondary) 75%
  );
  background-size: 200% 100%;
  animation: loading 1.5s ease-in-out infinite;
  border-radius: var(--radius-sm);
  margin-bottom: 0.75rem;
}

.skeleton-line.large {
  height: 32px;
}

.skeleton-line.small {
  height: 12px;
}

.skeleton-avatar {
  width: 48px;
  height: 48px;
  border-radius: var(--radius-full);
  background: linear-gradient(
    90deg,
    var(--bg-secondary) 25%,
    var(--bg-tertiary) 50%,
    var(--bg-secondary) 75%
  );
  background-size: 200% 100%;
  animation: loading 1.5s ease-in-out infinite;
}

/* ===== Enhanced Toast Notifications ===== */
.toast {
  position: relative;
  overflow: hidden;
  animation: slideInRight 0.3s ease-out;
}

.toast.removing {
  animation: slideOutRight 0.3s ease-in forwards;
}

.toast-progress {
  position: absolute;
  bottom: 0;
  left: 0;
  height: 3px;
  background: rgba(255, 255, 255, 0.5);
  animation: toastProgress 3s linear;
}

@keyframes toastProgress {
  from { width: 100%; }
  to { width: 0%; }
}

.toast-close {
  background: none;
  border: none;
  color: white;
  cursor: pointer;
  padding: 0.25rem;
  margin-left: auto;
  opacity: 0.8;
  transition: var(--transition-fast);
}

.toast-close:hover {
  opacity: 1;
}

/* ===== Form Validation ===== */
.form-group.has-error .form-input,
.form-group.has-error .form-select,
.form-group.has-error .form-textarea {
  border-color: var(--danger);
  animation: shake 0.3s ease-in-out;
}

.form-group.has-success .form-input,
.form-group.has-success .form-select,
.form-group.has-success .form-textarea {
  border-color: var(--success);
}

.form-error {
  display: flex;
  align-items: center;
  gap: 0.25rem;
  color: var(--danger);
  font-size: 0.875rem;
  margin-top: 0.5rem;
}

.form-success {
  display: flex;
  align-items: center;
  gap: 0.25rem;
  color: var(--success);
  font-size: 0.875rem;
  margin-top: 0.5rem;
}

/* ===== Mobile Bottom Navigation ===== */
.mobile-nav {
  display: none;
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--bg-primary);
  border-top: 1px solid var(--border);
  padding: 0.5rem;
  z-index: 40;
  box-shadow: 0 -4px 6px -1px rgb(0 0 0 / 0.1);
}

.mobile-nav-items {
  display: flex;
  justify-content: space-around;
  align-items: center;
}

.mobile-nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.25rem;
  padding: 0.5rem;
  border-radius: var(--radius);
  color: var(--text-secondary);
  font-size: 0.75rem;
  transition: var(--transition-fast);
  border: none;
  background: none;
  cursor: pointer;
}

.mobile-nav-item.active {
  color: var(--primary);
  background: rgba(59, 130, 246, 0.1);
}

.mobile-nav-item svg {
  width: 24px;
  height: 24px;
}

@media (max-width: 768px) {
  .mobile-nav {
    display: block;
  }

  .main {
    padding-bottom: 5rem;
  }
}

/* ===== Enhanced KPI Cards ===== */
.kpi-card {
  position: relative;
  overflow: hidden;
}

.kpi-card::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(
    135deg,
    rgba(255, 255, 255, 0) 0%,
    rgba(255, 255, 255, 0.1) 100%
  );
  pointer-events: none;
}

.kpi-sparkline {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 30px;
  opacity: 0.3;
}

/* ===== Notification Badge ===== */
.notification-badge {
  position: absolute;
  top: -4px;
  right: -4px;
  background: var(--danger);
  color: white;
  border-radius: var(--radius-full);
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.75rem;
  font-weight: 700;
  animation: pulse 2s infinite;
}

/* ===== Success Checkmark ===== */
.success-checkmark {
  width: 80px;
  height: 80px;
  margin: 0 auto;
}

.success-checkmark-circle {
  stroke-dasharray: 166;
  stroke-dashoffset: 166;
  stroke-width: 2;
  stroke-miterlimit: 10;
  stroke: var(--success);
  fill: none;
  animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
}

.success-checkmark-check {
  transform-origin: 50% 50%;
  stroke-dasharray: 48;
  stroke-dashoffset: 48;
  animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
}

@keyframes stroke {
  100% {
    stroke-dashoffset: 0;
  }
}

/* ===== Responsive Optimizations ===== */
@media (max-width: 768px) {
  .table td,
  .table th {
    padding: 0.75rem 0.5rem;
    font-size: 0.85rem;
  }
}

@media (max-width: 576px) {
  .table td,
  .table th {
    padding: 0.5rem 0.25rem;
    font-size: 0.8rem;
  }
}

/* ===== Prescription Templates Styles ===== */
.duration-option {
  cursor: pointer;
  display: block;
}

.duration-option input[type="radio"] {
  display: none;
}

.duration-card {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 1rem;
  background: var(--bg-tertiary);
  border: 2px solid var(--border);
  border-radius: var(--radius);
  font-weight: 600;
  color: var(--text-primary);
  transition: var(--transition);
  text-align: center;
  min-height: 60px;
}

.duration-option:hover .duration-card {
  border-color: var(--primary);
  background: var(--bg-secondary);
}

.duration-option input[type="radio"]:checked + .duration-card {
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  border-color: var(--primary);
  color: white;
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.template-item {
  padding: 1rem;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  margin-bottom: 0.5rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  transition: var(--transition);
}

.template-item:hover {
  border-color: var(--primary);
  background: var(--bg-secondary);
}

.template-item-info {
  flex: 1;
}

.template-item-name {
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 0.25rem;
}

.template-item-proto {
  font-size: 14px;
  color: var(--text-secondary);
}

.template-item-actions {
  display: flex;
  gap: 0.5rem;
}

</style>
<!-- SheetJS library for Excel file support -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- Chart.js library for statistics graphs -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
<div class="app">
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="brand">
      <div class="logo">NPM</div>
      <div class="brand-title">NHC Patients Manager</div>
    </div>
    
    <div class="nav-section">Navigation</div>
    <nav class="nav" id="nav">
      <button class="nav-item active" data-view="dashboard">
        <span class="nav-icon">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>
        </span>
        <span>Tableau de bord</span>
      </button>
      
      <button class="nav-item" data-view="patients">
        <span class="nav-icon">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>
        </span>
        <span>Patients</span>
        <span class="nav-badge" id="countPatients">0</span>
      </button>
      
      <button class="nav-item" data-view="archived">
        <span class="nav-icon">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path d="M4 3a2 2 0 100 4h12a2 2 0 100-4H4z"></path><path fill-rule="evenodd" d="M3 8h14v7a2 2 0 01-2 2H5a2 2 0 01-2-2V8zm5 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>
        </span>
        <span>Archivés</span>
        <span class="nav-badge" id="countArchived">0</span>
      </button>
      
      <button class="nav-item" data-view="ordos">
        <span class="nav-icon">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"></path></svg>
        </span>
        <span>Ordonnances</span>
      </button>
      
      <button class="nav-item" data-view="switches">
        <span class="nav-icon">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path></svg>
        </span>
        <span>Switch Pompes</span>
        <span class="nav-badge" id="countSwitches">0</span>
      </button>
      
      <button class="nav-item" data-view="appointments">
        <span class="nav-icon">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path></svg>
        </span>
        <span>Suivis / RDV</span>
        <span class="nav-badge" id="countAppointments">0</span>
      </button>

      <button class="nav-item" data-view="tasks">
        <span class="nav-icon">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path><path d="M8 11a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"></path></svg>
        </span>
        <span>Tâches</span>
        <span class="nav-badge" id="countTasks">0</span>
      </button>

      <button class="nav-item" data-view="catalogs">
        <span class="nav-icon">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z"></path></svg>
        </span>
        <span>Référentiels</span>
      </button>
      
      <button class="nav-item" data-view="report">
        <span class="nav-icon">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"></path></svg>
        </span>
        <span>Statistiques</span>
      </button>
      
      <button class="nav-item" data-view="backup">
        <span class="nav-icon">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
        </span>
        <span>Import/Export</span>
      </button>
      
      <button class="nav-item" data-view="debug">
        <span class="nav-icon">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
        </span>
        <span>Debug</span>
      </button>
      
      <button class="nav-item" data-view="update">
        <span class="nav-icon">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path></svg>
        </span>
        <span>Mise à jour</span>
      </button>
      
      <button class="nav-item" data-view="about">
        <span class="nav-icon">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"></path></svg>
        </span>
        <span>À propos</span>
      </button>
    </nav>
    
    <div class="nav-section" style="margin-top: 2rem;">Aide</div>
    <div style="padding: 0 0.75rem; margin-bottom: 1rem;">
      <button class="btn btn-primary" onclick="startTutorial()" style="width: 100%; background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
          <path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z"></path>
        </svg>
        <span>🎓 Tutoriel</span>
      </button>
    </div>
    
    <div class="nav-section">Thème</div>
    <div style="padding: 0 0.75rem;">
      <button class="btn btn-secondary" onclick="toggleTheme()" style="width: 100%;">
        <span id="themeIcon">🌙</span>
        <span id="themeText">Mode sombre</span>
      </button>
    </div>
  </aside>
  
  <!-- Main Content -->
  <main class="main">
    <!-- Header -->
    <header class="header">
      <div class="search-box">
        <svg class="search-icon" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
        <input type="text" class="search-input" id="globalSearch" placeholder="Rechercher... (Ctrl+K)">
      </div>
      
      <button class="btn btn-secondary" id="btnAddPatient">
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path></svg>
        Nouveau patient
      </button>
      
      <button class="btn btn-info" id="btnImportCSV" style="background: var(--info); margin-left: 10px;">
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
        Importer CSV
      </button>
      
      <div class="dropdown">
        <button class="btn btn-primary" id="btnQuickActions">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z"></path></svg>
          Actions rapides
        </button>
        <div class="dropdown-menu" id="qaMenu">
          <button class="dropdown-item" onclick="newPatient()">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 7a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V7z"></path></svg>
            Nouveau patient
          </button>
          <button class="dropdown-item" onclick="openSwitchModal()">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path></svg>
            Planifier switch
          </button>
          <button class="dropdown-item" onclick="openAppointmentModal()">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path></svg>
            Nouveau RDV
          </button>
          <button class="dropdown-item" onclick="fcOpen()">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path></svg>
            Fast Check Ordonnances
          </button>
          <button class="dropdown-item" onclick="fcoOpen()">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path></svg>
            Fast Create Ordo
          </button>
        </div>
      </div>
    </header>
    
    <!-- Views -->
    <!-- Dashboard View -->
    <section id="dashboard" class="view active">
      <!-- Welcome Header - Medical UI -->
      <div style="background: linear-gradient(135deg, rgba(126, 200, 227, 0.08) 0%, rgba(109, 213, 237, 0.08) 100%); padding: 2.5rem; border-radius: var(--radius-lg); margin-bottom: 2rem; box-shadow: var(--shadow); border: 1px solid rgba(126, 200, 227, 0.15); position: relative; overflow: hidden;">
        <div style="position: absolute; top: -50px; right: -50px; width: 200px; height: 200px; background: rgba(126, 200, 227, 0.06); border-radius: 50%;"></div>
        <div style="position: absolute; bottom: -30px; left: -30px; width: 150px; height: 150px; background: rgba(109, 213, 237, 0.06); border-radius: 50%;"></div>
        <div style="position: relative; z-index: 1; display: flex; justify-content: space-between; align-items: center;">
          <div>
            <h1 style="color: var(--text-primary); font-size: 2rem; font-weight: 700; margin: 0 0 0.75rem 0; letter-spacing: -0.02em;">
              Tableau de Bord
            </h1>
            <p style="color: var(--text-secondary); font-size: 1rem; margin: 0; font-weight: 500;" id="dashboardWelcome">
              Bienvenue ! Voici votre vue d'ensemble
            </p>
          </div>
          <!-- Action Buttons -->
          <div style="display: flex; gap: 0.875rem; align-items: center;">
            <!-- Shortcuts Button -->
            <button id="shortcutsBtn" onclick="toggleShortcuts()" style="background: white; border: 1.5px solid var(--border); color: var(--primary); padding: 1rem; border-radius: var(--radius-md); cursor: pointer; transition: var(--transition); font-size: 1.25rem; display: flex; align-items: center; justify-content: center; width: 56px; height: 56px; box-shadow: var(--shadow-sm);" title="Raccourcis">
              🔗
            </button>
            <!-- Notification Bell -->
            <button id="notificationBell" onclick="toggleNotifications()" style="background: white; border: 1.5px solid var(--border); color: var(--primary); padding: 1rem; border-radius: var(--radius-md); cursor: pointer; transition: var(--transition); font-size: 1.25rem; display: flex; align-items: center; justify-content: center; width: 56px; height: 56px; position: relative; box-shadow: var(--shadow-sm);" title="Notifications">
              🔔
              <span id="notificationBadge" style="position: absolute; top: -4px; right: -4px; background: var(--danger); color: white; border-radius: 50%; width: 22px; height: 22px; display: none; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 700; border: 2px solid white; box-shadow: var(--shadow);"></span>
            </button>
          </div>
        </div>
      </div>

      <!-- Notification Panel - Medical UI -->
      <div id="notificationPanel" style="display: none; margin-bottom: 2rem; background: white; border-radius: var(--radius-lg); box-shadow: var(--shadow-md); border: 1px solid var(--border-light); overflow: hidden; animation: slideDown 0.3s ease;">
        <div style="background: var(--primary); padding: 1.25rem 1.75rem; color: white; display: flex; justify-content: space-between; align-items: center;">
          <h3 style="margin: 0; font-size: 1.1rem; font-weight: 700; letter-spacing: -0.01em;">🔔 Notifications</h3>
          <button onclick="toggleNotifications()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.5rem; border-radius: var(--radius); cursor: pointer; font-size: 1rem; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; transition: var(--transition);" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">✕</button>
        </div>
        <div id="notificationList" style="max-height: 600px; overflow-y: auto; background: var(--bg-secondary);">
          <!-- Notifications seront générées dynamiquement -->
        </div>
      </div>

      <!-- Shortcuts Panel - Medical UI -->
      <div id="shortcutsPanel" style="display: none; margin-bottom: 2rem; background: white; border-radius: var(--radius-lg); box-shadow: var(--shadow-md); border: 1px solid var(--border-light); overflow: hidden; animation: slideDown 0.3s ease;">
        <div style="background: var(--warning); padding: 1.25rem 1.75rem; color: white; display: flex; justify-content: space-between; align-items: center;">
          <h3 style="margin: 0; font-size: 1.1rem; font-weight: 700; letter-spacing: -0.01em;">🔗 Raccourcis</h3>
          <div style="display: flex; gap: 0.75rem; align-items: center;">
            <button onclick="openShortcutManager()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.5rem 1rem; border-radius: var(--radius); cursor: pointer; font-size: 0.875rem; font-weight: 600; transition: var(--transition);" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'" title="Gérer les raccourcis">⚙️ Gérer</button>
            <button onclick="toggleShortcuts()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.5rem; border-radius: var(--radius); cursor: pointer; font-size: 1rem; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; transition: var(--transition);" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">✕</button>
          </div>
        </div>
        <div id="shortcutsList" style="padding: 1.5rem; background: var(--bg-secondary); min-height: 100px;">
          <!-- Raccourcis seront générés dynamiquement -->
        </div>
      </div>

      <!-- Actions rapides - Medical UI -->
      <div class="card" style="background: linear-gradient(135deg, rgba(126, 200, 227, 0.06) 0%, rgba(109, 213, 237, 0.06) 100%); border: 2px dashed rgba(126, 200, 227, 0.3); margin-bottom: 2rem;">
        <div class="card-body">
          <h3 style="margin: 0 0 1.5rem 0; color: var(--primary-dark); font-weight: 700; font-size: 1.1rem; letter-spacing: -0.01em;">⚡ Actions rapides</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <button class="btn btn-primary" onclick="newPatient()" style="justify-content: center; padding: 1rem;">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 7a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V7z"></path></svg>
              Nouveau patient
            </button>
            <button class="btn btn-secondary" onclick="openSwitchModal()" style="justify-content: center; padding: 1rem;">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path></svg>
              Planifier switch
            </button>
            <button class="btn btn-secondary" onclick="openAppointmentModal()" style="justify-content: center; padding: 1rem;">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path></svg>
              Nouveau RDV
            </button>
            <button class="btn btn-secondary" onclick="fcOpen()" style="justify-content: center; padding: 1rem;">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path></svg>
              Fast Check Ordonnances
            </button>
            <button class="btn btn-success" onclick="fcoOpen()" style="justify-content: center; padding: 1rem;">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path></svg>
              Fast Create Ordo
            </button>
            <button class="btn btn-secondary" onclick="openTaskModal()" style="justify-content: center; padding: 1rem;">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path><path d="M8 11a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"></path></svg>
              Nouvelle tâche
            </button>
          </div>
        </div>
      </div>

      <!-- Statistiques principales - Medical UI -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
        <!-- Patients -->
        <div style="background: white; border: 1px solid var(--border-light); border-radius: var(--radius-lg); padding: 2rem; box-shadow: var(--shadow); transition: var(--transition); cursor: pointer; position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-6px)'; this.style.boxShadow='var(--shadow-md)'; this.style.borderColor='var(--primary)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='var(--shadow)'; this.style.borderColor='var(--border-light)'">
          <div style="position: absolute; top: -15px; right: 10px; font-size: 5rem; opacity: 0.06;">👥</div>
          <div style="position: relative; z-index: 1;">
            <div style="font-size: 0.875rem; color: var(--text-secondary); font-weight: 600; margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em;">Patients actifs</div>
            <div style="font-size: 2.75rem; font-weight: 700; line-height: 1; color: var(--primary);" id="kpiPatients">0</div>
            <div style="font-size: 0.875rem; color: var(--text-muted); margin-top: 0.75rem; font-weight: 500;">File active totale</div>
          </div>
        </div>

        <!-- Ordonnances -->
        <div style="background: white; border: 1px solid var(--border-light); border-radius: var(--radius-lg); padding: 2rem; box-shadow: var(--shadow); transition: var(--transition); cursor: pointer; position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-6px)'; this.style.boxShadow='var(--shadow-md)'; this.style.borderColor='var(--secondary)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='var(--shadow)'; this.style.borderColor='var(--border-light)'">
          <div style="position: absolute; top: -15px; right: 10px; font-size: 5rem; opacity: 0.06;">📋</div>
          <div style="position: relative; z-index: 1;">
            <div style="font-size: 0.875rem; color: var(--text-secondary); font-weight: 600; margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em;">Ordonnances ≤30j</div>
            <div style="font-size: 2.75rem; font-weight: 700; line-height: 1; color: var(--secondary);" id="kpiRenews">0</div>
            <div style="font-size: 0.875rem; color: var(--text-muted); margin-top: 0.75rem; font-weight: 500;">À renouveler bientôt</div>
          </div>
        </div>

        <!-- Score qualité -->
        <div style="background: white; border: 1px solid var(--border-light); border-radius: var(--radius-lg); padding: 2rem; box-shadow: var(--shadow); transition: var(--transition); cursor: pointer; position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-6px)'; this.style.boxShadow='var(--shadow-md)'; this.style.borderColor='var(--success)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='var(--shadow)'; this.style.borderColor='var(--border-light)'">
          <div style="position: absolute; top: -15px; right: 10px; font-size: 5rem; opacity: 0.06;">⭐</div>
          <div style="position: relative; z-index: 1;">
            <div style="font-size: 0.875rem; color: var(--text-secondary); font-weight: 600; margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em;">Score qualité</div>
            <div style="font-size: 2.75rem; font-weight: 700; line-height: 1; color: var(--success);" id="kpiScore">0%</div>
            <div style="font-size: 0.875rem; color: var(--text-muted); margin-top: 0.75rem; font-weight: 500;">Complétude des données</div>
          </div>
        </div>

        <!-- Protocoles -->
        <div style="background: white; border: 1px solid var(--border-light); border-radius: var(--radius-lg); padding: 2rem; box-shadow: var(--shadow); transition: var(--transition); cursor: pointer; position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-6px)'; this.style.boxShadow='var(--shadow-md)'; this.style.borderColor='var(--warning)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='var(--shadow)'; this.style.borderColor='var(--border-light)'">
          <div style="position: absolute; top: -15px; right: 10px; font-size: 5rem; opacity: 0.06;">💊</div>
          <div style="position: relative; z-index: 1;">
            <div style="font-size: 0.875rem; color: var(--text-secondary); font-weight: 600; margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em;">Protocoles actifs</div>
            <div style="font-size: 2.75rem; font-weight: 700; line-height: 1; color: var(--warning);" id="kpiProtos">0</div>
            <div style="font-size: 0.875rem; color: var(--text-muted); margin-top: 0.75rem; font-weight: 500;">Types de pompes</div>
          </div>
        </div>
      </div>

      <!-- Calendrier mensuel - Medical UI -->
      <div class="card" style="margin-bottom: 2rem;">
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
          <h3 class="card-title" style="display: flex; align-items: center; gap: 0.5rem; margin: 0; color: var(--text-primary);">
            <span>📅</span>
            Calendrier du mois
          </h3>
          <div style="display: flex; gap: 0.75rem; align-items: center;">
            <button id="calendarPrevMonth" class="btn" style="background: var(--bg-secondary); color: var(--text-primary); padding: 0.625rem 0.875rem; border: 1px solid var(--border);" title="Mois précédent">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
              </svg>
            </button>
            <span id="calendarMonthYear" style="font-weight: 600; min-width: 150px; text-align: center; color: var(--primary-dark);"></span>
            <button id="calendarNextMonth" class="btn" style="background: var(--bg-secondary); color: var(--text-primary); padding: 0.625rem 0.875rem; border: 1px solid var(--border);" title="Mois suivant">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
              </svg>
            </button>
            <button id="calendarToday" class="btn btn-primary" style="padding: 0.625rem 1.25rem; margin-left: 0.5rem;" title="Aujourd'hui">
              Aujourd'hui
            </button>
          </div>
        </div>
        <div class="card-body" style="padding: 1.5rem;">
          <div id="dashboardCalendar"></div>
          <!-- Légende -->
          <div style="display: flex; gap: 2rem; justify-content: center; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border); flex-wrap: wrap;">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <span style="font-size: 1rem;">📅</span>
              <span style="font-size: 0.875rem; color: var(--text-secondary);">RDV avec date précise</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <span style="font-size: 1rem;">🔄</span>
              <span style="font-size: 0.875rem; color: var(--text-secondary);">Switch planifié</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <span style="font-size: 1rem;">✅</span>
              <span style="font-size: 0.875rem; color: #22c55e;">Événement effectué</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Patients à rappeler ce mois - Medical UI -->
      <div class="card" id="calendarToCallSection" style="margin-bottom: 2rem; display: none;">
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
          <h3 class="card-title" style="display: flex; align-items: center; gap: 0.5rem; margin: 0;">
            <span>📞</span>
            Patients à rappeler ce mois
          </h3>
          <span class="badge" id="calendarToCallCount" style="background: var(--warning); color: white; font-weight: 700; padding: 0.375rem 0.875rem;">0</span>
        </div>
        <div class="card-body" style="padding: 0;">
          <div id="calendarToCallList" style="max-height: 300px; overflow-y: auto;">
            <!-- Généré dynamiquement -->
          </div>
        </div>
      </div>

      <!-- Répartition des protocoles - Pleine largeur -->
      <div class="card" style="margin-bottom: 1.5rem;">
        <div class="card-header">
          <h3 class="card-title" style="display: flex; align-items: center; gap: 0.5rem; margin: 0;">
            <span>📊</span>
            Répartition des protocoles
          </h3>
        </div>
        <div class="card-body">
          <div id="dashboardProtocolsChart" style="min-height: 250px;">
            <p class="text-muted text-center">Chargement...</p>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Patients View -->
    <section id="patients" class="view">
      <div class="card">
        <div class="card-header" style="flex-wrap: wrap;">
          <h3 class="card-title">Liste des patients</h3>
          <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <select class="form-select" id="sortPatients" style="width: auto;">
              <option value="name">Trier par nom (A-Z)</option>
              <option value="recent">Plus récents</option>
              <option value="renewal">Date de renouvellement puis nom</option>
              <option value="doctor">Médecin puis nom (A-Z)</option>
              <option value="center">Centre puis nom (A-Z)</option>
              <option value="protocol">Matériel puis nom (A-Z)</option>
            </select>
            <button class="btn btn-success" onclick="exportToExcel()">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
              </svg>
              Export Excel
            </button>
            <button class="btn btn-primary" onclick="openAdvancedExportModal()">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                <path d="M5 4a1 1 0 00-2 0v7.268a2 2 0 000 3.464V16a1 1 0 102 0v-1.268a2 2 0 000-3.464V4zM11 4a1 1 0 10-2 0v1.268a2 2 0 000 3.464V16a1 1 0 102 0V8.732a2 2 0 000-3.464V4zM16 3a1 1 0 011 1v7.268a2 2 0 010 3.464V16a1 1 0 11-2 0v-1.268a2 2 0 010-3.464V4a1 1 0 011-1z"></path>
              </svg>
              Export avancé
            </button>
          </div>
        </div>
        <div class="card-body">
          <div class="table-container">
            <table class="table" id="tblPatients">
              <thead>
                <tr>
                  <th style="width: 25%;">Nom & Prénom</th>
                  <th style="width: 20%;">Matériel</th>
                  <th style="width: 20%;">Médecin</th>
                  <th style="width: 15%;">Centre</th>
                  <th style="width: 20%;">Date de renouvellement</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Archived Patients View -->
    <section id="archived" class="view">
      <div class="card">
        <div class="card-header" style="flex-wrap: wrap;">
          <h3 class="card-title">Patients archivés</h3>
          <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <select class="form-select" id="filterArchivedStatus" style="width: auto;">
              <option value="all">Tous les archivés</option>
              <option value="temporary_pause">Arrêts temporaires</option>
              <option value="permanent_pause">Arrêts définitifs</option>
            </select>
            <select class="form-select" id="sortArchived" style="width: auto;">
              <option value="name">Trier par nom (A-Z)</option>
              <option value="recent">Plus récents</option>
              <option value="pauseDate">Date d'arrêt puis nom</option>
            </select>
          </div>
        </div>
        <div class="card-body">
          <!-- Statistics Row - Medical UI -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
            <div style="background: white; border: 1px solid var(--border-light); border-radius: var(--radius-lg); padding: 1.5rem; box-shadow: var(--shadow);">
              <div style="font-size: 0.8rem; color: var(--text-secondary); font-weight: 600; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em;">Arrêts temporaires</div>
              <div style="font-size: 2.25rem; font-weight: 700; color: var(--warning);" id="countTemporaryPause">0</div>
            </div>
            <div style="background: white; border: 1px solid var(--border-light); border-radius: var(--radius-lg); padding: 1.5rem; box-shadow: var(--shadow);">
              <div style="font-size: 0.8rem; color: var(--text-secondary); font-weight: 600; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em;">Arrêts définitifs</div>
              <div style="font-size: 2.25rem; font-weight: 700; color: var(--danger);" id="countPermanentPause">0</div>
            </div>
            <div style="background: white; border: 1px solid var(--border-light); border-radius: var(--radius-lg); padding: 1.5rem; box-shadow: var(--shadow);">
              <div style="font-size: 0.8rem; color: var(--text-secondary); font-weight: 600; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em;">Total archivés</div>
              <div style="font-size: 2.25rem; font-weight: 700; color: var(--text-secondary);" id="countTotalArchived">0</div>
            </div>
          </div>
          
          <div class="table-container">
            <table class="table" id="tblArchived">
              <thead>
                <tr>
                  <th style="width: 25%;">Nom & Prénom</th>
                  <th style="width: 15%;">Statut</th>
                  <th style="width: 15%;">Date d'arrêt</th>
                  <th style="width: 15%;">Matériel</th>
                  <th style="width: 15%;">Médecin</th>
                  <th style="width: 15%;">Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Prescriptions View -->
    <section id="ordos" class="view">
      <!-- Cycle Overview -->
      <div class="kpi-grid mb-3">
        <div class="kpi-card" style="border-left-color: var(--primary);">
          <div class="kpi-label">Cycle actuel</div>
          <div class="kpi-value" id="currentCycleLabel">-</div>
          <div class="text-small text-muted" id="currentCycleRange">-</div>
        </div>
        
        <div class="kpi-card" style="border-left-color: var(--warning);">
          <div class="kpi-label">À renouveler (cycle)</div>
          <div class="kpi-value" id="currentCycleRenewals">0</div>
          <div class="text-small text-muted">Dans le cycle actuel</div>
        </div>
        
        <div class="kpi-card" style="border-left-color: var(--danger);">
          <div class="kpi-label">Expirées</div>
          <div class="kpi-value" id="expiredCount">0</div>
          <div class="text-small text-muted">À traiter en urgence</div>
        </div>
        
        <div class="kpi-card" style="border-left-color: var(--success);">
          <div class="kpi-label">En règle</div>
          <div class="kpi-value" id="validCount">0</div>
          <div class="text-small text-muted">Ordonnances valides</div>
        </div>
      </div>
      
      <!-- Cycle Tabs -->
      <div class="card mb-3">
        <div class="card-header">
          <h3 class="card-title">Vue par cycles</h3>
          <div class="flex gap-1">
            <select class="form-select" id="ordoYearFilter" style="width: auto;">
              <option value="2024">2024</option>
              <option value="2025" selected>2025</option>
              <option value="2026">2026</option>
            </select>
            <button class="btn btn-primary" onclick="exportCurrentCycleToPDF()" title="Exporter le cycle en cours en PDF">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v3.586l-1.293-1.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V8z" clip-rule="evenodd"></path></svg>
              Exporter PDF
            </button>
            <button class="btn btn-secondary" onclick="refreshOrdonnances()">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path></svg>
            </button>
          </div>
        </div>
        <div class="card-body">
          <div class="cycle-tabs mb-3">
            <button class="cycle-tab active" data-cycle="1">
              <span class="cycle-tab-icon">❄️</span>
              <div>
                <div class="cycle-tab-title">Cycle 1</div>
                <div class="cycle-tab-subtitle">Janvier - Avril</div>
              </div>
              <span class="cycle-tab-count" id="cycle1Count">0</span>
            </button>
            <button class="cycle-tab" data-cycle="2">
              <span class="cycle-tab-icon">☀️</span>
              <div>
                <div class="cycle-tab-title">Cycle 2</div>
                <div class="cycle-tab-subtitle">Mai - Août</div>
              </div>
              <span class="cycle-tab-count" id="cycle2Count">0</span>
            </button>
            <button class="cycle-tab" data-cycle="3">
              <span class="cycle-tab-icon">🍂</span>
              <div>
                <div class="cycle-tab-title">Cycle 3</div>
                <div class="cycle-tab-subtitle">Septembre - Décembre</div>
              </div>
              <span class="cycle-tab-count" id="cycle3Count">0</span>
            </button>
          </div>
          
          <div id="cyclePatientsList"></div>
        </div>
      </div>
      
      <!-- Upcoming Renewals -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Renouvellements à venir (30 prochains jours)</h3>
          <div class="flex gap-1">
            <button class="btn btn-success" onclick="openAdvancedPrescriptionCreation()">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"></path></svg>
              Créer ordonnance
            </button>
            <button class="btn btn-primary" onclick="startBatchRenewal()">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path></svg>
              Renouvellement groupé
            </button>
          </div>
        </div>
        <div class="card-body">
          <div id="upcomingRenewalsList"></div>
        </div>
      </div>
      
      <!-- Expired Prescriptions -->
      <div class="card mt-3">
        <div class="card-header" style="background: rgba(239, 68, 68, 0.1);">
          <h3 class="card-title" style="color: var(--danger);">⚠️ Ordonnances expirées</h3>
        </div>
        <div class="card-body">
          <div id="expiredList"></div>
        </div>
      </div>
    </section>
    
    <!-- Switches View -->
    <section id="switches" class="view">
      <div class="card mb-3">
        <div class="card-header">
          <h3 class="card-title">🔄 Gestion des Switches de Pompes</h3>
          <button class="btn btn-primary" onclick="openSwitchModal()">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"></path>
            </svg>
            Nouveau Switch
          </button>
        </div>
      </div>
      
      <!-- Filters -->
      <div class="card mb-3">
        <div class="card-body">
          <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
            <label style="display: flex; align-items: center; gap: 0.5rem;">
              <input type="radio" name="switchFilter" value="all" checked onchange="renderSwitches()">
              <span>Tous</span>
            </label>
            <label style="display: flex; align-items: center; gap: 0.5rem;">
              <input type="radio" name="switchFilter" value="planned" onchange="renderSwitches()">
              <span>📅 Prévus</span>
            </label>
            <label style="display: flex; align-items: center; gap: 0.5rem;">
              <input type="radio" name="switchFilter" value="completed" onchange="renderSwitches()">
              <span>✅ Effectués</span>
            </label>
          </div>
        </div>
      </div>
      
      <!-- Timeline View Toggle -->
      <div class="card mb-3">
        <div class="card-body">
          <div style="display: flex; gap: 1rem; align-items: center; justify-content: space-between;">
            <div style="display: flex; gap: 1rem;">
              <button class="btn btn-secondary" id="btnListView" onclick="toggleSwitchView('list')">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>
                Vue Liste
              </button>
              <button class="btn btn-primary" id="btnTimelineView" onclick="toggleSwitchView('timeline')">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path></svg>
                Vue Timeline
              </button>
            </div>
            <div style="color: var(--text-muted); font-size: 14px;">
              <span id="timelineMonthDisplay"></span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Timeline View Container - Medical UI -->
      <div id="timelineViewContainer" style="display: none;">
        <div class="card mb-3">
          <div class="card-header">
            <h3 class="card-title" style="color: var(--text-primary);">📅 Timeline des Switches - <span id="timelineMonth"></span></h3>
          </div>
          <div class="card-body" style="padding: 2rem; background: var(--bg-secondary);">
            <div id="timelineContent" style="position: relative; min-height: 400px;"></div>
          </div>
        </div>

        <!-- Légende - Medical UI -->
        <div class="card mb-3">
          <div class="card-body">
            <div style="display: flex; gap: 2rem; flex-wrap: wrap; justify-content: center; align-items: center;">
              <div style="display: flex; align-items: center; gap: 0.625rem;">
                <div style="width: 18px; height: 18px; border-radius: 50%; background: var(--danger); box-shadow: var(--shadow-sm);"></div>
                <span style="font-size: 0.9rem; color: var(--text-primary); font-weight: 500;">En retard</span>
              </div>
              <div style="display: flex; align-items: center; gap: 0.625rem;">
                <div style="width: 18px; height: 18px; border-radius: 50%; background: var(--warning); box-shadow: var(--shadow-sm);"></div>
                <span style="font-size: 0.9rem; color: var(--text-primary); font-weight: 500;">Aujourd'hui</span>
              </div>
              <div style="display: flex; align-items: center; gap: 0.625rem;">
                <div style="width: 18px; height: 18px; border-radius: 50%; background: var(--primary); box-shadow: var(--shadow-sm);"></div>
                <span style="font-size: 0.9rem; color: var(--text-primary); font-weight: 500;">Cette semaine</span>
              </div>
              <div style="display: flex; align-items: center; gap: 0.625rem;">
                <div style="width: 18px; height: 18px; border-radius: 50%; background: var(--success); box-shadow: var(--shadow-sm);"></div>
                <span style="font-size: 0.9rem; color: var(--text-primary); font-weight: 500;">Ce mois</span>
              </div>
              <div style="display: flex; align-items: center; gap: 0.625rem;">
                <div style="width: 18px; height: 18px; border-radius: 50%; background: var(--text-muted); box-shadow: var(--shadow-sm);"></div>
                <span style="font-size: 0.9rem; color: var(--text-primary); font-weight: 500;">Effectué</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- List View Container (existing cards) -->
      <div id="listViewContainer">
      
      <!-- Switches à venir ce mois - Medical UI -->
      <div class="card mb-3">
        <div class="card-header">
          <h3 class="card-title" style="color: var(--text-primary);">📅 Switches prévus ce mois</h3>
          <span class="badge" id="countSwitchesMonth" style="background: var(--warning); color: white;">0</span>
        </div>
        <div class="card-body">
          <div id="switchesMonth"></div>
        </div>
      </div>

      <!-- Switches futurs - Medical UI -->
      <div class="card mb-3">
        <div class="card-header">
          <h3 class="card-title" style="color: var(--text-primary);">⏳ Switches futurs</h3>
          <span class="badge" id="countSwitchesFuture" style="background: var(--secondary); color: white;">0</span>
        </div>
        <div class="card-body">
          <div id="switchesFuture"></div>
        </div>
      </div>

      <!-- Switches passés - Medical UI -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title" style="color: var(--text-primary);">🔄 Switches effectués</h3>
          <span class="badge" id="countSwitchesPast" style="background: var(--success); color: white;">0</span>
        </div>
        <div class="card-body">
          <div id="switchesPast"></div>
        </div>
      </div>
      </div><!-- End List View Container -->
    </section>
    
    <!-- Appointments/Follow-ups View -->
    <section id="appointments" class="view">
      <!-- Dashboard RDV - Medical UI -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
        <!-- RDV ce mois -->
        <div style="background: white; border: 1px solid var(--border-light); border-radius: var(--radius-lg); padding: 2rem; box-shadow: var(--shadow); transition: var(--transition); cursor: pointer; position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-6px)'; this.style.boxShadow='var(--shadow-md)'; this.style.borderColor='var(--primary)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='var(--shadow)'; this.style.borderColor='var(--border-light)'">
          <div style="position: absolute; top: -15px; right: 10px; font-size: 5rem; opacity: 0.06;">📅</div>
          <div style="position: relative; z-index: 1;">
            <div style="font-size: 0.875rem; color: var(--text-secondary); font-weight: 600; margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em;">RDV ce mois</div>
            <div style="font-size: 2.75rem; font-weight: 700; line-height: 1; color: var(--primary);" id="kpiAppointmentsThisMonth">0</div>
            <div style="font-size: 0.875rem; color: var(--text-muted); margin-top: 0.75rem; font-weight: 500;">Rendez-vous planifiés</div>
          </div>
        </div>

        <!-- À rappeler -->
        <div style="background: white; border: 1px solid var(--border-light); border-radius: var(--radius-lg); padding: 2rem; box-shadow: var(--shadow); transition: var(--transition); cursor: pointer; position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-6px)'; this.style.boxShadow='var(--shadow-md)'; this.style.borderColor='var(--warning)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='var(--shadow)'; this.style.borderColor='var(--border-light)'">
          <div style="position: absolute; top: -15px; right: 10px; font-size: 5rem; opacity: 0.06;">📞</div>
          <div style="position: relative; z-index: 1;">
            <div style="font-size: 0.875rem; color: var(--text-secondary); font-weight: 600; margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em;">À rappeler</div>
            <div style="font-size: 2.75rem; font-weight: 700; line-height: 1; color: var(--warning);" id="kpiAppointmentsToCall">0</div>
            <div style="font-size: 0.875rem; color: var(--text-muted); margin-top: 0.75rem; font-weight: 500;">Patients à contacter</div>
          </div>
        </div>

        <!-- 30 prochains jours -->
        <div style="background: white; border: 1px solid var(--border-light); border-radius: var(--radius-lg); padding: 2rem; box-shadow: var(--shadow); transition: var(--transition); cursor: pointer; position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-6px)'; this.style.boxShadow='var(--shadow-md)'; this.style.borderColor='var(--secondary)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='var(--shadow)'; this.style.borderColor='var(--border-light)'">
          <div style="position: absolute; top: -15px; right: 10px; font-size: 5rem; opacity: 0.06;">⏰</div>
          <div style="position: relative; z-index: 1;">
            <div style="font-size: 0.875rem; color: var(--text-secondary); font-weight: 600; margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em;">30 prochains jours</div>
            <div style="font-size: 2.75rem; font-weight: 700; line-height: 1; color: var(--secondary);" id="kpiAppointmentsNext30">0</div>
            <div style="font-size: 0.875rem; color: var(--text-muted); margin-top: 0.75rem; font-weight: 500;">Suivis à venir</div>
          </div>
        </div>

        <!-- Réalisés -->
        <div style="background: white; border: 1px solid var(--border-light); border-radius: var(--radius-lg); padding: 2rem; box-shadow: var(--shadow); transition: var(--transition); cursor: pointer; position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-6px)'; this.style.boxShadow='var(--shadow-md)'; this.style.borderColor='var(--success)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='var(--shadow)'; this.style.borderColor='var(--border-light)'">
          <div style="position: absolute; top: -15px; right: 10px; font-size: 5rem; opacity: 0.06;">✅</div>
          <div style="position: relative; z-index: 1;">
            <div style="font-size: 0.875rem; color: var(--text-secondary); font-weight: 600; margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em;">Réalisés</div>
            <div style="font-size: 2.75rem; font-weight: 700; line-height: 1; color: var(--success);" id="kpiAppointmentsDone">0</div>
            <div style="font-size: 0.875rem; color: var(--text-muted); margin-top: 0.75rem; font-weight: 500;">Total effectués</div>
          </div>
        </div>
      </div>
      
      <!-- Contrôles -->
      <div class="card mb-3">
        <div class="card-body">
          <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center; justify-content: space-between;">
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
              <button class="btn btn-primary" onclick="openAppointmentModal()">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"></path>
                </svg>
                Planifier un suivi
              </button>
              
              <div style="display: flex; gap: 0.5rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--bg-secondary); border-radius: var(--radius); cursor: pointer;">
                  <input type="radio" name="appointmentFilter" value="all" checked onchange="renderAppointments()">
                  <span>Tous</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--bg-secondary); border-radius: var(--radius); cursor: pointer;">
                  <input type="radio" name="appointmentFilter" value="thisMonth" onchange="renderAppointments()">
                  <span>Ce mois</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--bg-secondary); border-radius: var(--radius); cursor: pointer;">
                  <input type="radio" name="appointmentFilter" value="next30" onchange="renderAppointments()">
                  <span>30 jours</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--bg-secondary); border-radius: var(--radius); cursor: pointer;">
                  <input type="radio" name="appointmentFilter" value="toCall" onchange="renderAppointments()">
                  <span>À rappeler</span>
                </label>
              </div>
            </div>
            
            <input type="text" class="form-input" id="appointmentSearch" placeholder="🔍 Rechercher un patient..." style="max-width: 300px;" oninput="renderAppointments()">
          </div>
        </div>
      </div>
      
      <!-- Liste des RDV -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">📅 Suivis planifiés</h3>
        </div>
        <div class="card-body">
          <div id="appointmentsList"></div>
        </div>
      </div>
    </section>

    <!-- Tasks View -->
    <section id="tasks" class="view">
      <!-- Dashboard Tâches - Medical UI -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
        <!-- À faire -->
        <div style="background: white; border: 1px solid var(--border-light); border-radius: var(--radius-lg); padding: 2rem; box-shadow: var(--shadow); transition: var(--transition); cursor: pointer; position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-6px)'; this.style.boxShadow='var(--shadow-md)'; this.style.borderColor='var(--primary)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='var(--shadow)'; this.style.borderColor='var(--border-light)'">
          <div style="position: absolute; top: -15px; right: 10px; font-size: 5rem; opacity: 0.06;">📋</div>
          <div style="position: relative; z-index: 1;">
            <div style="font-size: 0.875rem; color: var(--text-secondary); font-weight: 600; margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em;">À faire</div>
            <div style="font-size: 2.75rem; font-weight: 700; line-height: 1; color: var(--primary);" id="kpiTasksTodo">0</div>
            <div style="font-size: 0.875rem; color: var(--text-muted); margin-top: 0.75rem; font-weight: 500;">Tâches en attente</div>
          </div>
        </div>

        <!-- En cours -->
        <div style="background: white; border: 1px solid var(--border-light); border-radius: var(--radius-lg); padding: 2rem; box-shadow: var(--shadow); transition: var(--transition); cursor: pointer; position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-6px)'; this.style.boxShadow='var(--shadow-md)'; this.style.borderColor='var(--secondary)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='var(--shadow)'; this.style.borderColor='var(--border-light)'">
          <div style="position: absolute; top: -15px; right: 10px; font-size: 5rem; opacity: 0.06;">⏳</div>
          <div style="position: relative; z-index: 1;">
            <div style="font-size: 0.875rem; color: var(--text-secondary); font-weight: 600; margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em;">En cours</div>
            <div style="font-size: 2.75rem; font-weight: 700; line-height: 1; color: var(--secondary);" id="kpiTasksInProgress">0</div>
            <div style="font-size: 0.875rem; color: var(--text-muted); margin-top: 0.75rem; font-weight: 500;">Tâches actives</div>
          </div>
        </div>

        <!-- Urgentes -->
        <div style="background: white; border: 1px solid var(--border-light); border-radius: var(--radius-lg); padding: 2rem; box-shadow: var(--shadow); transition: var(--transition); cursor: pointer; position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-6px)'; this.style.boxShadow='var(--shadow-md)'; this.style.borderColor='var(--danger)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='var(--shadow)'; this.style.borderColor='var(--border-light)'">
          <div style="position: absolute; top: -15px; right: 10px; font-size: 5rem; opacity: 0.06;">🔴</div>
          <div style="position: relative; z-index: 1;">
            <div style="font-size: 0.875rem; color: var(--text-secondary); font-weight: 600; margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em;">Urgentes</div>
            <div style="font-size: 2.75rem; font-weight: 700; line-height: 1; color: var(--danger);" id="kpiTasksUrgent">0</div>
            <div style="font-size: 0.875rem; color: var(--text-muted); margin-top: 0.75rem; font-weight: 500;">Nécessitent attention</div>
          </div>
        </div>

        <!-- Terminées -->
        <div style="background: white; border: 1px solid var(--border-light); border-radius: var(--radius-lg); padding: 2rem; box-shadow: var(--shadow); transition: var(--transition); cursor: pointer; position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-6px)'; this.style.boxShadow='var(--shadow-md)'; this.style.borderColor='var(--success)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='var(--shadow)'; this.style.borderColor='var(--border-light)'">
          <div style="position: absolute; top: -15px; right: 10px; font-size: 5rem; opacity: 0.06;">✅</div>
          <div style="position: relative; z-index: 1;">
            <div style="font-size: 0.875rem; color: var(--text-secondary); font-weight: 600; margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em;">Terminées</div>
            <div style="font-size: 2.75rem; font-weight: 700; line-height: 1; color: var(--success);" id="kpiTasksCompleted">0</div>
            <div style="font-size: 0.875rem; color: var(--text-muted); margin-top: 0.75rem; font-weight: 500;">Tâches accomplies</div>
          </div>
        </div>
      </div>

      <!-- Contrôles -->
      <div class="card mb-3">
        <div class="card-body">
          <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center; justify-content: space-between;">
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
              <button class="btn btn-primary" onclick="openTaskModal()">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"></path>
                </svg>
                Nouvelle tâche
              </button>

              <button class="btn btn-secondary" onclick="exportTasksToCSV()">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                </svg>
                Exporter CSV
              </button>

              <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--bg-secondary); border-radius: var(--radius); cursor: pointer;">
                  <input type="radio" name="taskStatusFilter" value="all" checked onchange="renderTasks()">
                  <span>Toutes</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--bg-secondary); border-radius: var(--radius); cursor: pointer;">
                  <input type="radio" name="taskStatusFilter" value="todo" onchange="renderTasks()">
                  <span>À faire</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--bg-secondary); border-radius: var(--radius); cursor: pointer;">
                  <input type="radio" name="taskStatusFilter" value="in_progress" onchange="renderTasks()">
                  <span>En cours</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--bg-secondary); border-radius: var(--radius); cursor: pointer;">
                  <input type="radio" name="taskStatusFilter" value="completed" onchange="renderTasks()">
                  <span>Terminées</span>
                </label>
              </div>

              <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--bg-secondary); border-radius: var(--radius); cursor: pointer;">
                  <input type="radio" name="taskPriorityFilter" value="all" checked onchange="renderTasks()">
                  <span>Toutes priorités</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--bg-secondary); border-radius: var(--radius); cursor: pointer;">
                  <input type="radio" name="taskPriorityFilter" value="urgent" onchange="renderTasks()">
                  <span>🔴 Urgent</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--bg-secondary); border-radius: var(--radius); cursor: pointer;">
                  <input type="radio" name="taskPriorityFilter" value="high" onchange="renderTasks()">
                  <span>🟠 Haute</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--bg-secondary); border-radius: var(--radius); cursor: pointer;">
                  <input type="radio" name="taskPriorityFilter" value="normal" onchange="renderTasks()">
                  <span>🟡 Normale</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--bg-secondary); border-radius: var(--radius); cursor: pointer;">
                  <input type="radio" name="taskPriorityFilter" value="low" onchange="renderTasks()">
                  <span>🟢 Basse</span>
                </label>
              </div>
            </div>

            <input type="text" class="form-input" id="taskSearch" placeholder="🔍 Rechercher une tâche..." style="max-width: 300px;" oninput="renderTasks()">
          </div>
        </div>
      </div>

      <!-- Liste des tâches -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">📋 Liste des tâches</h3>
        </div>
        <div class="card-body">
          <div id="tasksList"></div>
        </div>
      </div>
    </section>

    <!-- Catalogs View -->
    <section id="catalogs" class="view">
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1rem;">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Médecins</h3>
            <span class="badge badge-info" id="countDocs">0</span>
          </div>
          <div class="card-body">
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
              <input type="text" class="form-input" id="newDocInput" placeholder="Nom du médecin" style="flex: 1;">
              <button class="btn btn-primary" onclick="addDoc()">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"></path>
                </svg>
                Ajouter
              </button>
            </div>
            <div id="docsList"></div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Centres</h3>
            <span class="badge badge-info" id="countCenters">0</span>
          </div>
          <div class="card-body">
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
              <input type="text" class="form-input" id="newCenterInput" placeholder="Nom du centre" style="flex: 1;">
              <button class="btn btn-primary" onclick="addCenter()">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"></path>
                </svg>
                Ajouter
              </button>
            </div>
            <div id="centersList"></div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Protocoles / Matériels</h3>
            <span class="badge badge-info" id="countProtos">0</span>
          </div>
          <div class="card-body">
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
              <input type="text" class="form-input" id="newProtoInput" placeholder="Nom du protocole" style="flex: 1;">
              <button class="btn btn-primary" onclick="addProto()">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"></path>
                </svg>
                Ajouter
              </button>
            </div>
            <div id="protosList"></div>
          </div>
        </div>

        <div class="card">
          <div class="card-header" style="background: linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%); color: white;">
            <h3 class="card-title">📄 Templates d'Ordonnances</h3>
            <span class="badge" style="background: white; color: var(--secondary);" id="countTemplates">0</span>
          </div>
          <div class="card-body">
            <div style="margin-bottom: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: var(--radius); border: 1px solid var(--border);">
              <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                <svg width="20" height="20" fill="currentColor" style="color: var(--info);" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
                <strong style="color: var(--info);">Gestion des templates</strong>
              </div>
              <p style="font-size: 14px; color: var(--text-secondary); margin: 0;">
                Liez vos templates d'ordonnances aux protocoles pour une génération automatique. Uploadez vos documents Word (.docx) ou utilisez le template par défaut.
              </p>
            </div>

            <button class="btn btn-primary" onclick="openTemplateUploadModal()" style="width: 100%; margin-bottom: 1rem;">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
              </svg>
              Uploader un template
            </button>

            <div id="templatesList"></div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Report View -->
    <section id="report" class="view">
      <div style="margin-bottom: 1.5rem;">
        <h2 style="color: var(--primary); font-weight: 700; margin-bottom: 0.5rem;">📊 Statistiques comparatives</h2>
        <p class="text-muted">Comparaison des indicateurs entre le cycle en cours et le cycle précédent</p>
      </div>

      <!-- Sélecteur de cycles -->
      <div class="card mb-3">
        <div class="card-body">
          <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px;">
              <label class="form-label">Cycle en cours</label>
              <select class="form-input" id="currentCycleSelect">
                <option value="">Sélectionner un cycle...</option>
              </select>
            </div>
            <div style="flex: 1; min-width: 200px;">
              <label class="form-label">Cycle à comparer</label>
              <select class="form-input" id="previousCycleSelect">
                <option value="">Sélectionner un cycle...</option>
              </select>
            </div>
            <button class="btn btn-primary" onclick="compareStatistics()" style="align-self: flex-end;">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11 4a1 1 0 10-2 0v4a1 1 0 102 0V7zm-3 1a1 1 0 10-2 0v3a1 1 0 102 0V8zM8 9a1 1 0 00-2 0v2a1 1 0 102 0V9z" clip-rule="evenodd"></path></svg>
              Comparer
            </button>
          </div>
        </div>
      </div>

      <!-- KPIs comparatifs -->
      <div id="statsComparison" style="display: none;">
        <!-- KPIs Grid -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
          <!-- Patients actifs -->
          <div class="card">
            <div class="card-body">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="color: var(--text-secondary); font-size: 0.9rem;">Patients actifs</span>
                <svg width="24" height="24" fill="currentColor" style="color: var(--primary);" viewBox="0 0 20 20"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"></path></svg>
              </div>
              <div style="display: flex; align-items: baseline; gap: 0.5rem; margin-bottom: 0.5rem;">
                <span id="kpiPatients1" style="font-size: 2rem; font-weight: 700; color: var(--primary);">-</span>
                <span style="color: var(--text-secondary);">→</span>
                <span id="kpiPatients2" style="font-size: 2rem; font-weight: 700;">-</span>
              </div>
              <div id="kpiPatientsEvol" class="badge">-</div>
            </div>
          </div>

          <!-- Taux complétion ordonnances -->
          <div class="card">
            <div class="card-body">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="color: var(--text-secondary); font-size: 0.9rem;">Efficacité ordonnances</span>
                <svg width="24" height="24" fill="currentColor" style="color: var(--warning);" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"></path></svg>
              </div>
              <div style="display: flex; align-items: baseline; gap: 0.5rem; margin-bottom: 0.5rem;">
                <span id="kpiOrdos1" style="font-size: 2rem; font-weight: 700; color: var(--warning);">-</span>
                <span style="color: var(--text-secondary);">→</span>
                <span id="kpiOrdos2" style="font-size: 2rem; font-weight: 700;">-</span>
              </div>
              <div id="kpiOrdosEvol" class="badge">-</div>
            </div>
          </div>

          <!-- Suivis effectués -->
          <div class="card">
            <div class="card-body">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="color: var(--text-secondary); font-size: 0.9rem;">Suivis effectués</span>
                <svg width="24" height="24" fill="currentColor" style="color: var(--info);" viewBox="0 0 20 20"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path></svg>
              </div>
              <div style="display: flex; align-items: baseline; gap: 0.5rem; margin-bottom: 0.5rem;">
                <span id="kpiSuivis1" style="font-size: 2rem; font-weight: 700; color: var(--info);">-</span>
                <span style="color: var(--text-secondary);">→</span>
                <span id="kpiSuivis2" style="font-size: 2rem; font-weight: 700;">-</span>
              </div>
              <div id="kpiSuivisEvol" class="badge">-</div>
            </div>
          </div>

          <!-- Switchs effectués -->
          <div class="card">
            <div class="card-body">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="color: var(--text-secondary); font-size: 0.9rem;">Switchs effectués</span>
                <svg width="24" height="24" fill="currentColor" style="color: #8b5cf6;" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path></svg>
              </div>
              <div style="display: flex; align-items: baseline; gap: 0.5rem; margin-bottom: 0.5rem;">
                <span id="kpiSwitchs1" style="font-size: 2rem; font-weight: 700; color: #8b5cf6;">-</span>
                <span style="color: var(--text-secondary);">→</span>
                <span id="kpiSwitchs2" style="font-size: 2rem; font-weight: 700;">-</span>
              </div>
              <div id="kpiSwitchsEvol" class="badge">-</div>
            </div>
          </div>

          <!-- Arrêts temporaires -->
          <div class="card">
            <div class="card-body">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="color: var(--text-secondary); font-size: 0.9rem;">Arrêts temporaires</span>
                <svg width="24" height="24" fill="currentColor" style="color: #f59e0b;" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
              </div>
              <div style="display: flex; align-items: baseline; gap: 0.5rem; margin-bottom: 0.5rem;">
                <span id="kpiTempPause1" style="font-size: 2rem; font-weight: 700; color: #f59e0b;">-</span>
                <span style="color: var(--text-secondary);">→</span>
                <span id="kpiTempPause2" style="font-size: 2rem; font-weight: 700;">-</span>
              </div>
              <div id="kpiTempPauseEvol" class="badge">-</div>
            </div>
          </div>

          <!-- Arrêts définitifs -->
          <div class="card">
            <div class="card-body">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="color: var(--text-secondary); font-size: 0.9rem;">Arrêts définitifs</span>
                <svg width="24" height="24" fill="currentColor" style="color: #ef4444;" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>
              </div>
              <div style="display: flex; align-items: baseline; gap: 0.5rem; margin-bottom: 0.5rem;">
                <span id="kpiPermPause1" style="font-size: 2rem; font-weight: 700; color: #ef4444;">-</span>
                <span style="color: var(--text-secondary);">→</span>
                <span id="kpiPermPause2" style="font-size: 2rem; font-weight: 700;">-</span>
              </div>
              <div id="kpiPermPauseEvol" class="badge">-</div>
            </div>
          </div>

          <!-- Score qualité moyen -->
          <div class="card">
            <div class="card-body">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="color: var(--text-secondary); font-size: 0.9rem;">Score qualité moyen</span>
                <svg width="24" height="24" fill="currentColor" style="color: var(--success);" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
              </div>
              <div style="display: flex; align-items: baseline; gap: 0.5rem; margin-bottom: 0.5rem;">
                <span id="kpiScore1" style="font-size: 2rem; font-weight: 700; color: var(--success);">-</span>
                <span style="color: var(--text-secondary);">→</span>
                <span id="kpiScore2" style="font-size: 2rem; font-weight: 700;">-</span>
              </div>
              <div id="kpiScoreEvol" class="badge">-</div>
            </div>
          </div>
        </div>

        <!-- Graphique comparatif -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">📈 Évolution des indicateurs</h3>
          </div>
          <div class="card-body">
            <canvas id="comparisonChart" style="max-height: 400px;"></canvas>
          </div>
        </div>
      </div>

      <!-- Message d'attente -->
      <div id="statsWaiting" class="alert alert-info">
        <strong>Sélectionnez deux cycles à comparer</strong><br>
        Choisissez le cycle en cours et un cycle précédent dans les menus déroulants ci-dessus, puis cliquez sur "Comparer" pour afficher les statistiques.
      </div>
    </section>
    
    <!-- Backup View -->
    <section id="backup" class="view">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Import / Export</h3>
        </div>
        <div class="card-body">
          <div class="form-grid">
            <div>
              <h4 class="mb-2">Export des données</h4>
              <button class="btn btn-primary mb-2" id="btnExportJson">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
                Exporter tout (JSON)
              </button>
              <button class="btn btn-secondary" id="btnExportRefs">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 1 1 0 000 2H6a2 2 0 00-2 2v6h16V7a2 2 0 00-2-2h-1a1 1 0 100-2 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path></svg>
                Exporter référentiels
              </button>
            </div>
            
            <div>
              <h4 class="mb-2">Import JSON</h4>
              <input type="file" class="form-input" id="fileImport" accept=".json">
              <div class="text-small text-muted mt-1">Remplace toutes les données actuelles</div>
            </div>
            
            <div>
              <h4 class="mb-2">Import CSV Intelligent</h4>
              <button class="btn btn-success" onclick="openCSVImport()">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                Import CSV avancé
              </button>
              <div class="text-small text-muted mt-1">
                • Détection automatique du format<br>
                • Aperçu des données<br>
                • Mapping manuel des colonnes<br>
                • Support multi-encodage
              </div>
            </div>
          </div>
          
          <!-- Auto-Save System -->
          <hr style="margin: 2rem 0; border: none; border-top: 2px solid var(--border);">
          
          <div>
            <h3 style="margin-bottom: 1rem; color: var(--primary);">
              💾 Sauvegarde automatique
            </h3>
            
            <div class="alert alert-info" style="margin-bottom: 1.5rem;">
              <strong>Protection automatique de vos données</strong><br>
              Configurez une sauvegarde automatique qui met à jour un fichier JSON à chaque modification, sans intervention manuelle.
            </div>
            
            <div class="card" style="background: var(--bg-secondary); margin-bottom: 1rem;">
              <div class="card-body">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                  <div>
                    <strong style="font-size: 1.1rem;">État de la sauvegarde automatique</strong>
                  </div>
                  <div id="autoSaveStatus" style="display: flex; align-items: center; gap: 0.5rem;">
                    <span class="badge badge-secondary">Non configurée</span>
                  </div>
                </div>
                
                <div id="autoSaveInfo" style="display: none; padding: 1rem; background: var(--bg-primary); border-radius: var(--radius); margin-bottom: 1rem;">
                  <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem 1rem; font-size: 0.9rem;">
                    <strong>📁 Fichier :</strong>
                    <span id="autoSaveFileName">-</span>
                    
                    <strong>🕐 Dernière sauvegarde :</strong>
                    <span id="autoSaveLastTime">Jamais</span>
                    
                    <strong>📊 Éléments sauvegardés :</strong>
                    <span id="autoSaveCount">-</span>
                  </div>
                </div>
                
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                  <button class="btn btn-primary" id="btnConfigureAutoSave" onclick="configureAutoSave()">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path>
                    </svg>
                    Configurer la sauvegarde
                  </button>
                  
                  <button class="btn btn-success hidden" id="btnEnableAutoSave" onclick="toggleAutoSave(true)">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    Activer
                  </button>
                  
                  <button class="btn btn-warning hidden" id="btnDisableAutoSave" onclick="toggleAutoSave(false)">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M13.477 14.89A6 6 0 015.11 6.524l8.367 8.368zm1.414-1.414L6.524 5.11a6 6 0 018.367 8.367zM18 10a8 8 0 11-16 0 8 8 0 0116 0z" clip-rule="evenodd"></path>
                    </svg>
                    Désactiver
                  </button>
                  
                  <button class="btn btn-secondary hidden" id="btnSaveNow" onclick="saveNow()">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h5a2 2 0 012 2v7a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2h5v5.586l-1.293-1.293zM9 4a1 1 0 012 0v2H9V4z"></path>
                    </svg>
                    Sauvegarder maintenant
                  </button>
                  
                  <button class="btn btn-info hidden" id="btnRestoreFromAutoSave" onclick="restoreFromAutoSave()">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path>
                    </svg>
                    Restaurer depuis la sauvegarde
                  </button>
                </div>
                
                <div class="alert alert-warning" id="autoSaveFallbackNotice" style="margin-top: 1rem; display: none;">
                  <strong>⚠️ Navigateur non supporté</strong><br>
                  Votre navigateur ne supporte pas la sauvegarde automatique dans un fichier unique. Utilisez Chrome ou Edge pour cette fonctionnalité.
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Debug View -->
    <section id="debug" class="view">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Debug & Maintenance</h3>
        </div>
        <div class="card-body">
          <div class="form-grid">
            <button class="btn btn-secondary" id="btnListKeys">📋 Lister les clés</button>
            <button class="btn btn-secondary" id="btnSwitchKey">🔄 Dupliquer la clé</button>
            <button class="btn btn-warning" id="btnMigrateV1">📦 Migrer depuis v1</button>
            <button class="btn btn-danger" id="btnPurgeV1">🗑️ Purger v1</button>
          </div>

          <hr style="margin: 2rem 0; border: none; border-top: 2px solid var(--border);">

          <div style="background: rgba(239, 68, 68, 0.1); border: 2px solid #ef4444; border-radius: var(--radius-md); padding: 1.5rem;">
            <h4 style="color: #ef4444; margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
              <span style="font-size: 1.5rem;">⚠️</span>
              Zone Dangereuse
            </h4>
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">
              Cette action supprimera <strong>TOUTES</strong> les données de l'application de manière irréversible.
            </p>
            <button class="btn btn-danger" id="btnOpenPurgeModal" style="background: #dc2626; border-color: #dc2626;">
              🗑️ PURGE TOTALE - Supprimer toutes les données
            </button>
          </div>
          <pre id="dbgOut" class="mt-3" style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius-md); font-family: monospace; font-size: 0.875rem;"></pre>
        </div>
      </div>
    </section>
    
    <!-- Update System View -->
    <section id="update" class="view">
      <div class="card mb-3">
        <div class="card-header">
          <h3 class="card-title">🔄 Système de mise à jour</h3>
        </div>
        <div class="card-body">
          <div class="alert alert-info mb-3">
            <strong>ℹ️ Mise à jour automatique via GitHub</strong><br>
            <strong>Méthode recommandée :</strong> Configurez l'URL RAW du fichier <code>version.json</code> sur GitHub.<br>
            Exemple : <code>https://raw.githubusercontent.com/username/repo/main/version.json</code><br><br>
            ✅ Avantages : Détection automatique même si le nom du fichier change (v1.0 → v2.0)<br>
            ✅ Notes de version incluses<br><br>
            <em>Méthode alternative :</em> URL directe du fichier HTML (nécessite de reconfigurer si le nom change)
          </div>

          <!-- GitHub Configuration -->
          <div class="mb-4">
            <h4>⚙️ Configuration de mise à jour</h4>
            <div class="form-group">
              <label for="githubRawUrl">URL RAW sur GitHub (version.json recommandé)</label>
              <input type="text" id="githubRawUrl" class="form-control" placeholder="https://raw.githubusercontent.com/..." value="">
              <small class="text-muted">
                Ex: https://raw.githubusercontent.com/maouex/NHC-Patients-Manager/main/version.json<br>
                💡 Pour obtenir l'URL RAW : Ouvrez votre fichier sur GitHub → Cliquez sur "Raw" → Copiez l'URL
              </small>
            </div>
            <div class="form-group mt-2">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" id="autoCheckUpdates" style="cursor: pointer;">
                <span>Vérifier automatiquement les mises à jour au démarrage</span>
              </label>
            </div>
            <button class="btn btn-primary mt-2" id="btnSaveGithubConfig">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
              </svg>
              Enregistrer la configuration
            </button>
          </div>

          <div class="mb-3">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--bg-tertiary); border-radius: var(--radius-md);">
              <div>
                <div style="font-weight: 600; font-size: 1.1rem;">Version actuelle</div>
                <div class="text-muted" style="font-size: 0.9rem;" id="currentVersion">v1.0</div>
              </div>
              <div style="text-align: right;">
                <div class="text-muted" style="font-size: 0.85rem;">Dernière vérification</div>
                <div id="lastUpdateCheck" style="font-size: 0.9rem;">Jamais</div>
              </div>
            </div>
          </div>
          
          <div class="mb-3" id="updateAvailableNotice" style="display: none;">
            <div class="alert alert-success">
              <strong>✨ Mise à jour disponible !</strong><br>
              Version <span id="availableVersion"></span> prête à être installée.
            </div>
          </div>
          
          <div class="form-grid">
            <button class="btn btn-primary" id="btnCheckUpdate">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path>
              </svg>
              Vérifier les mises à jour
            </button>

            <button class="btn btn-success" id="btnDownloadUpdate" style="display: none;">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
              </svg>
              Télécharger la mise à jour
            </button>

            <button class="btn btn-primary" id="btnInstallUpdate" style="display: none;">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
              </svg>
              Installer et remplacer le fichier
            </button>
          </div>
          
          <div class="mt-4" id="updateInfo" style="display: none;">
            <h4>📋 Informations sur la mise à jour</h4>
            <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius-md); font-family: monospace; font-size: 0.875rem;" id="updateDetails"></div>
          </div>
          
          <div class="mt-4">
            <h4>📜 Historique des mises à jour</h4>
            <div id="updateHistory" style="max-height: 300px; overflow-y: auto;">
              <p class="text-muted">Aucune mise à jour installée</p>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- About View -->
    <section id="about" class="view">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">À propos de NHC Patients Manager</h3>
        </div>
        <div class="card-body">
          <h4>Version 1.1.0</h4>
          <p class="text-muted mt-2"><strong>🆕 Nouveautés de la version 1.1.0 :</strong></p>
          <ul class="mt-2" style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
            <li>🚀 <strong>Système de mise à jour amélioré</strong> : Support changement de nom de fichier via version.json</li>
            <li>✅ Détection automatique des nouvelles versions même si le fichier change de nom (v1.0 → v2.0)</li>
            <li>📝 Affichage des notes de version lors des mises à jour</li>
            <li>🔧 Filtrage complet des patients archivés dans toutes les vues (ordonnances, cycles, statistiques)</li>
            <li>🐛 Correction : les patients archivés n'apparaissent plus dans les ordonnances manquantes si archivés avant la date de renouvellement</li>
          </ul>

          <p class="text-muted mt-3"><strong>Fonctionnalités principales :</strong></p>
          <ul class="mt-2">
            <li>👥 Gestion complète des patients (actifs, arrêts temporaires/définitifs)</li>
            <li>📋 Gestion des ordonnances et cycles de renouvellement</li>
            <li>🔄 Planification et suivi des switchs de pompes</li>
            <li>📅 Gestion des rendez-vous avec rappels</li>
            <li>📊 Tableau de bord avec statistiques en temps réel</li>
            <li>📥 Import/Export CSV intelligent avec détection automatique</li>
            <li>📄 Export Excel et PDF groupé par médecin</li>
            <li>📚 Référentiels (Protocoles, Médecins, Centres)</li>
            <li>🔍 Recherche et filtres avancés</li>
            <li>📜 Historique des modifications patients</li>
            <li>🔄 Système de mise à jour automatique via GitHub</li>
            <li>🌙 Mode sombre/clair</li>
            <li>💾 Sauvegarde automatique locale avec backup</li>
            <li>📱 Compatible mobile/tablette/desktop</li>
          </ul>
          <p class="text-muted mt-3">© 2024 NHC Patients Manager - Tous droits réservés</p>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Patient Modal -->
<div class="modal" id="patientModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="modalTitle">Nouveau patient</h2>
      <button class="modal-close" id="closePatient">&times;</button>
    </div>
    
    <div class="modal-body">
      <form id="patientForm" class="form-grid">
        <div class="form-group">
          <label class="form-label">Nom *</label>
          <input type="text" class="form-input" id="lastName" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">Prénom *</label>
          <input type="text" class="form-input" id="firstName" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">Date de naissance</label>
          <input type="date" class="form-input" id="dob">
        </div>
        
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" class="form-input" id="email">
        </div>
        
        <div class="form-group">
          <label class="form-label">Téléphone</label>
          <input type="tel" class="form-input" id="phone">
        </div>
        
        <div class="form-group">
          <label class="form-label">Adresse</label>
          <input type="text" class="form-input" id="address" placeholder="Ex: 123 Rue de la Paix, 75001 Paris">
        </div>
        
        <div class="form-group">
          <label class="form-label">Code Patient</label>
          <input type="text" class="form-input" id="patientCode" placeholder="Ex: 12345">
          <div class="text-small text-muted mt-1">Code utilisé pour les ordonnances en ligne</div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Médecin</label>
          <select class="form-select" id="docId">
            <option value="">-- Sélectionner --</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Centre</label>
          <select class="form-select" id="centerId">
            <option value="">-- Sélectionner --</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Protocole</label>
          <select class="form-select" id="protoId">
            <option value="">-- Sélectionner --</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Date de renouvellement d'ordonnance</label>
          <div style="display: flex; gap: 0.5rem;">
            <input type="text" class="form-input" id="renewalDate" placeholder="JJ/MM/AAAA" pattern="\d{2}/\d{2}/\d{4}">
            <button type="button" class="btn btn-secondary" onclick="suggestRenewalDate()" title="Suggérer la prochaine date">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path></svg>
            </button>
          </div>
          <div class="text-small text-muted mt-1" id="cycleInfo">
            Le cycle sera calculé automatiquement selon la date
          </div>
        </div>
        
        <div class="form-group" style="grid-column: span 2;">
          <label class="form-label">Notes</label>
          <textarea class="form-textarea" id="notes"></textarea>
        </div>
      </form>
    </div>
    
    <div class="modal-footer">
      <div style="display: flex; gap: 0.5rem; margin-right: auto;">
        <button class="btn btn-warning hidden" id="btnChangeStatus" style="background: #f59e0b;">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path></svg>
          Changer statut
        </button>
        <button class="btn hidden" id="btnGeneratePrescription" style="background: linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%); color: white;" onclick="openGeneratePrescriptionModal()">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V8z" clip-rule="evenodd"></path>
          </svg>
          Générer Ordonnance
        </button>
      </div>
      <button class="btn btn-danger hidden" id="btnDeletePatient">Supprimer</button>
      <button class="btn btn-secondary" onclick="document.getElementById('patientModal').classList.remove('active')">Annuler</button>
      <button class="btn btn-primary" id="btnSavePatient">Enregistrer</button>
    </div>
  </div>
</div>

<!-- Fast Check Modal -->
<div class="modal" id="fastModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">⚡ Fast Check - Vérification rapide</h2>
      <button class="modal-close" id="fcClose">&times;</button>
    </div>
    
    <div class="modal-body">
      <div class="text-center">
        <div style="display: flex; align-items: center; justify-content: center; gap: 0.75rem; margin-bottom: 1rem;">
          <h3 id="fcPatient" style="color: var(--primary); margin: 0;">-</h3>
          <button class="btn btn-secondary btn-sm" id="fcCopy" title="Copier le nom dans le presse-papier">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
              <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"></path>
              <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"></path>
            </svg>
            Copier
          </button>
        </div>
        
        <!-- Code Patient Section -->
        <div style="margin-bottom: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: var(--radius); border: 1px solid var(--border);">
          <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-bottom: 0.5rem;">
            <span class="text-muted" style="font-size: 0.9rem;">Code Patient:</span>
            <span id="fcCodeDisplay" style="font-weight: 600; color: var(--primary); font-size: 1.1rem;">-</span>
          </div>
          <div id="fcCodeInputContainer" style="display: none; margin-top: 0.5rem;">
            <input type="text" class="form-input" id="fcCodeInput" placeholder="Saisir le code patient" style="text-align: center; max-width: 200px; margin: 0 auto;">
          </div>
          <div style="display: flex; gap: 0.5rem; justify-content: center; margin-top: 0.75rem;">
            <button class="btn btn-primary btn-sm" id="fcOrdonnance" disabled>
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
              </svg>
              Ordonnance
            </button>
            <button class="btn btn-secondary btn-sm" id="fcEditCode" title="Modifier le code patient">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path>
              </svg>
              Modifier code
            </button>
            <button class="btn btn-success btn-sm hidden" id="fcSaveCode">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
              </svg>
              Enregistrer
            </button>
          </div>
        </div>
        
        <p class="text-muted mb-2">Ordonnance actuelle :</p>
        <div style="display: flex; justify-content: center; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
          <input type="text" class="form-input" id="fcOrdo" style="width: 200px; text-align: center; font-size: 1.1rem;">
          <span id="fcCycle" class="badge badge-info" style="padding: 0.5rem 1rem;">-</span>
        </div>
        <p class="text-small text-muted">Patient <span id="fcIndex">0</span> sur <span id="fcTotal">0</span></p>
        <div class="progress mt-2" style="height: 10px;">
          <div class="progress-bar" id="fcProgress" style="background: linear-gradient(90deg, var(--primary), var(--secondary)); width: 0%;"></div>
        </div>
      </div>
    </div>
    
    <div class="modal-footer" style="justify-content: space-between;">
      <button class="btn btn-secondary" id="fcPrev">← Précédent</button>
      <div class="flex gap-1">
        <button class="btn btn-secondary" id="fcSkip">Passer →</button>
        <button class="btn btn-warning" id="fcCorrect">Corriger</button>
        <button class="btn btn-success hidden" id="fcUpdate">Valider</button>
      </div>
    </div>
  </div>
</div>

<!-- Cycle Selection Modal for Fast Create Ordo -->
<div class="modal" id="fcoCycleSelectionModal">
  <div class="modal-content" style="max-width: 500px;">
    <div class="modal-header">
      <h2 class="modal-title">📅 Sélection du cycle</h2>
      <button class="modal-close" onclick="showModal(false, 'fcoCycleSelectionModal')">&times;</button>
    </div>

    <div class="modal-body">
      <p class="text-center text-muted mb-3">Sélectionnez le cycle pour lequel générer les ordonnances</p>

      <div id="fcoCycleOptions" style="display: flex; flex-direction: column; gap: 1rem;">
        <!-- Cycle options will be populated here -->
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="showModal(false, 'fcoCycleSelectionModal')">Annuler</button>
    </div>
  </div>
</div>

<!-- Fast Create Ordo Modal -->
<div class="modal" id="fastCreateOrdoModal">
  <div class="modal-content" style="max-width: 600px;">
    <div class="modal-header">
      <h2 class="modal-title">📝 Fast Create Ordo - Génération rapide</h2>
      <button class="modal-close" id="fcoClose">&times;</button>
    </div>

    <div class="modal-body">
      <div class="text-center">
        <div style="display: flex; align-items: center; justify-content: center; gap: 0.75rem; margin-bottom: 1rem;">
          <h3 id="fcoPatient" style="color: var(--primary); margin: 0;">-</h3>
        </div>

        <!-- Template Selection -->
        <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--bg-secondary); border-radius: var(--radius); border: 1px solid var(--border);">
          <label class="form-label" style="font-weight: 600;">Template d'ordonnance</label>
          <select class="form-input" id="fcoTemplate">
            <option value="">Sélectionner un template...</option>
          </select>
        </div>

        <!-- Date Selection -->
        <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--bg-secondary); border-radius: var(--radius); border: 1px solid var(--border);">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div>
              <label class="form-label" style="font-weight: 600;">Date de début</label>
              <input type="date" class="form-input" id="fcoStartDate">
            </div>
            <div>
              <label class="form-label" style="font-weight: 600;">Date de fin</label>
              <input type="date" class="form-input" id="fcoEndDate">
            </div>
          </div>

          <!-- Duration radio buttons -->
          <div style="margin-top: 1rem;">
            <label class="form-label" style="font-weight: 600; margin-bottom: 0.5rem;">Durée de l'ordonnance</label>
            <div style="display: flex; gap: 1rem; justify-content: center;">
              <label style="display: flex; align-items: center; gap: 0.5rem;">
                <input type="radio" name="fcoDuration" value="1" onchange="fcoUpdateEndDate()">
                <span>1 mois</span>
              </label>
              <label style="display: flex; align-items: center; gap: 0.5rem;">
                <input type="radio" name="fcoDuration" value="3" checked onchange="fcoUpdateEndDate()">
                <span>3 mois</span>
              </label>
              <label style="display: flex; align-items: center; gap: 0.5rem;">
                <input type="radio" name="fcoDuration" value="6" onchange="fcoUpdateEndDate()">
                <span>6 mois</span>
              </label>
              <label style="display: flex; align-items: center; gap: 0.5rem;">
                <input type="radio" name="fcoDuration" value="9" onchange="fcoUpdateEndDate()">
                <span>9 mois</span>
              </label>
              <label style="display: flex; align-items: center; gap: 0.5rem;">
                <input type="radio" name="fcoDuration" value="12" onchange="fcoUpdateEndDate()">
                <span>12 mois</span>
              </label>
            </div>
          </div>
        </div>

        <!-- Checkbox for Formation technique Initiale -->
        <div style="margin-bottom: 1rem;">
          <label style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
            <input type="checkbox" id="fcoFormationInitiale">
            <span>Formation technique Initiale</span>
          </label>
        </div>

        <p class="text-small text-muted">Patient <span id="fcoIndex">0</span> sur <span id="fcoTotal">0</span></p>
        <div class="progress mt-2" style="height: 10px;">
          <div class="progress-bar" id="fcoProgress" style="background: linear-gradient(90deg, var(--primary), var(--secondary)); width: 0%;"></div>
        </div>
      </div>
    </div>

    <div class="modal-footer" style="justify-content: space-between;">
      <button class="btn btn-secondary" id="fcoPrev">← Précédent</button>
      <div class="flex gap-1">
        <button class="btn btn-secondary" id="fcoSkip">Passer →</button>
        <button class="btn btn-success" id="fcoValidate">Valider →</button>
      </div>
    </div>
  </div>
</div>

<!-- Advanced Prescription Creation Modal -->
<div class="modal" id="advancedPrescriptionModal">
  <div class="modal-content" style="max-width: 800px;">
    <div class="modal-header">
      <h2 class="modal-title">📝 Création d'ordonnance avancée</h2>
      <button class="modal-close" onclick="apcClose()">&times;</button>
    </div>

    <div class="modal-body">
      <!-- Selection View -->
      <div id="apcSelectionView">
        <!-- Cycle Selection -->
        <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--bg-secondary); border-radius: var(--radius); border: 1px solid var(--border);">
          <label class="form-label" style="font-weight: 600; margin-bottom: 0.75rem; display: block;">📅 Sélection du cycle</label>
          <div id="apcCycleOptions" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem;">
            <!-- Cycle options will be populated here -->
          </div>
        </div>

        <!-- Filters -->
        <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--bg-secondary); border-radius: var(--radius); border: 1px solid var(--border);">
          <label class="form-label" style="font-weight: 600; margin-bottom: 0.75rem; display: block;">🔍 Filtres</label>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div>
              <label class="form-label" style="font-size: 0.9rem;">Médecin</label>
              <select class="form-input" id="apcDoctorFilter">
                <option value="">Tous les médecins</option>
              </select>
            </div>
            <div>
              <label class="form-label" style="font-size: 0.9rem;">Centre</label>
              <select class="form-input" id="apcCenterFilter">
                <option value="">Tous les centres</option>
              </select>
            </div>
            <div>
              <label class="form-label" style="font-size: 0.9rem;">Matériel</label>
              <select class="form-input" id="apcProtocolFilter">
                <option value="">Tous les matériels</option>
              </select>
            </div>
            <div style="display: flex; align-items: flex-end;">
              <button class="btn btn-secondary" onclick="apcApplyFilters()" style="width: 100%;">
                Appliquer les filtres
              </button>
            </div>
          </div>
        </div>

        <!-- Patients List -->
        <div style="margin-bottom: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: var(--radius); border: 1px solid var(--border);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
            <label class="form-label" style="font-weight: 600; margin: 0;">👥 Patients (<span id="apcPatientCount">0</span>)</label>
            <div style="display: flex; gap: 0.5rem;">
              <button class="btn btn-sm btn-secondary" onclick="apcSelectAll()">Tout sélectionner</button>
              <button class="btn btn-sm btn-secondary" onclick="apcDeselectAll()">Tout désélectionner</button>
            </div>
          </div>
          <div id="apcPatientsList" style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 0.5rem;">
            <p class="text-muted text-center" style="padding: 2rem;">Sélectionnez un cycle pour voir les patients</p>
          </div>
        </div>
      </div>

      <!-- Configuration View (hidden by default) -->
      <div id="apcConfigView" style="display: none;">
        <div class="text-center">
          <div style="display: flex; align-items: center; justify-content: center; gap: 0.75rem; margin-bottom: 1rem;">
            <h3 id="apcCurrentPatient" style="color: var(--primary); margin: 0;">-</h3>
          </div>

          <!-- Template Selection -->
          <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--bg-secondary); border-radius: var(--radius); border: 1px solid var(--border);">
            <label class="form-label" style="font-weight: 600;">📄 Template d'ordonnance</label>
            <select class="form-input" id="apcCurrentTemplate">
              <option value="">Sélectionner un template...</option>
            </select>
          </div>

          <!-- Date Selection -->
          <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--bg-secondary); border-radius: var(--radius); border: 1px solid var(--border);">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div>
                <label class="form-label" style="font-weight: 600;">Date de début</label>
                <input type="date" class="form-input" id="apcCurrentStartDate" onchange="apcUpdateCurrentEndDate()">
              </div>
              <div>
                <label class="form-label" style="font-weight: 600;">Date de fin</label>
                <input type="date" class="form-input" id="apcCurrentEndDate">
              </div>
            </div>

            <!-- Duration radio buttons -->
            <div style="margin-top: 1rem;">
              <label class="form-label" style="font-weight: 600; margin-bottom: 0.5rem;">Durée de l'ordonnance</label>
              <div style="display: flex; gap: 1rem; justify-content: center;">
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                  <input type="radio" name="apcCurrentDuration" value="1" onchange="apcUpdateCurrentEndDate()">
                  <span>1 mois</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                  <input type="radio" name="apcCurrentDuration" value="3" checked onchange="apcUpdateCurrentEndDate()">
                  <span>3 mois</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                  <input type="radio" name="apcCurrentDuration" value="6" onchange="apcUpdateCurrentEndDate()">
                  <span>6 mois</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                  <input type="radio" name="apcCurrentDuration" value="9" onchange="apcUpdateCurrentEndDate()">
                  <span>9 mois</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                  <input type="radio" name="apcCurrentDuration" value="12" onchange="apcUpdateCurrentEndDate()">
                  <span>12 mois</span>
                </label>
              </div>
            </div>
          </div>

          <!-- Checkbox for Formation technique Initiale -->
          <div style="margin-bottom: 1rem;">
            <label style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
              <input type="checkbox" id="apcCurrentFormationInitiale">
              <span>Formation technique Initiale</span>
            </label>
          </div>

          <p class="text-small text-muted">Patient <span id="apcCurrentIndex">0</span> sur <span id="apcTotalCount">0</span></p>
          <div class="progress mt-2" style="height: 10px;">
            <div class="progress-bar" id="apcProgressBar" style="background: linear-gradient(90deg, var(--primary), var(--secondary)); width: 0%;"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer" id="apcSelectionFooter">
      <button class="btn btn-secondary" onclick="apcClose()">Annuler</button>
      <button class="btn btn-success" onclick="apcStartConfiguration()">
        Continuer
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20" style="margin-left: 0.5rem;"><path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
      </button>
    </div>

    <div class="modal-footer" id="apcConfigFooter" style="display: none; justify-content: space-between;">
      <button class="btn btn-secondary" id="apcPrev">← Précédent</button>
      <div class="flex gap-1">
        <button class="btn btn-secondary" id="apcSkip">Passer →</button>
        <button class="btn btn-success" id="apcValidate">Valider →</button>
      </div>
    </div>
  </div>
</div>

<!-- Patient Details Modal -->
<div class="modal" id="patientDetailsModal">
  <div class="modal-content" style="max-width: 800px;">
    <div class="modal-header">
      <h2 class="modal-title">👤 Détails du patient</h2>
      <button class="modal-close" onclick="showModal(false, 'patientDetailsModal')">&times;</button>
    </div>
    
    <div class="modal-body">
      <div id="patientDetailsContent" class="patient-details-card">
        <!-- Contenu généré dynamiquement -->
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="showModal(false, 'patientDetailsModal')">Fermer</button>
      <button class="btn" id="btnViewOrdonnance" style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); color: white;" disabled>
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
          <path d="M9 2a2 2 0 00-2 2v8a2 2 0 002 2h6a2 2 0 002-2V6.414A2 2 0 0016.414 5L14 2.586A2 2 0 0012.586 2H9z"></path>
          <path d="M3 8a2 2 0 012-2v10h8a2 2 0 01-2 2H5a2 2 0 01-2-2V8z"></path>
        </svg>
        Ordonnance
      </button>
      <button class="btn" id="btnGenerateFromDetails" style="background: linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%); color: white;">
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V8z" clip-rule="evenodd"></path>
        </svg>
        Générer Ordonnance
      </button>
      <button class="btn btn-primary" id="btnEditFromDetails">
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
          <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path>
        </svg>
        Modifier
      </button>
    </div>
  </div>
</div>

<!-- Appointment Modal -->
<div class="modal" id="appointmentModal">
  <div class="modal-content modal-with-sidebar" style="max-width: 1200px;">
    <div class="modal-header">
      <h2 class="modal-title" id="appointmentModalTitle">Planifier un suivi</h2>
      <button class="modal-close" onclick="showModal(false, 'appointmentModal')">&times;</button>
    </div>

    <div class="modal-body modal-body-split">
      <!-- Patient Info Sidebar -->
      <div class="patient-info-sidebar" id="appointmentPatientInfo" style="display: none;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem; border-radius: var(--radius) var(--radius) 0 0; margin: -1.5rem -1.5rem 1rem -1.5rem;">
          <div style="display: flex; align-items: center; gap: 1rem;">
            <div style="width: 60px; height: 60px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem;">
              👤
            </div>
            <div style="flex: 1;">
              <div style="font-weight: 700; font-size: 1.25rem;" id="appointmentPatientName">-</div>
              <div style="font-size: 0.875rem; opacity: 0.9;" id="appointmentPatientDob">-</div>
            </div>
          </div>
        </div>

        <div style="display: flex; flex-direction: column; gap: 1rem;">
          <div class="info-item">
            <div class="info-label">📞 Téléphone</div>
            <div class="info-value" id="appointmentPatientPhone" style="font-weight: 600; color: var(--primary);">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">📧 Email</div>
            <div class="info-value" id="appointmentPatientEmail" style="font-size: 0.875rem; word-break: break-word;">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">👨‍⚕️ Médecin</div>
            <div class="info-value" id="appointmentPatientDoctor">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">🏥 Centre</div>
            <div class="info-value" id="appointmentPatientCenter">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">💊 Protocole</div>
            <div class="info-value" id="appointmentPatientProtocol">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">📅 Renouvellement</div>
            <div class="info-value" id="appointmentPatientRenewal">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">📊 Score qualité</div>
            <div id="appointmentPatientScore">-</div>
          </div>
          <div class="info-item" id="appointmentPatientNotesContainer" style="display: none;">
            <div class="info-label">📝 Notes</div>
            <div class="info-value" id="appointmentPatientNotes" style="font-size: 0.875rem; max-height: 100px; overflow-y: auto;">-</div>
          </div>
        </div>
      </div>

      <!-- Main Form Content -->
      <div class="modal-form-content">
        <!-- Alert for existing appointments -->
        <div id="existingAppointmentsAlert" class="alert alert-info" style="display: none; margin-bottom: 1rem;">
          <strong>ℹ️ Rendez-vous existants pour ce patient :</strong>
          <div id="existingAppointmentsList" style="margin-top: 0.5rem;"></div>
        </div>

        <form id="appointmentForm" class="form-grid">
        <div class="form-group" style="grid-column: span 2;">
          <label class="form-label">Patient *</label>
          <select class="form-select" id="appointmentPatientId" required>
            <option value="">-- Sélectionner un patient --</option>
          </select>
        </div>
        
        <div class="form-group" style="grid-column: span 2;">
          <label class="form-label">Type d'échéance *</label>
          <div style="display: flex; gap: 1rem;">
            <label style="display: flex; align-items: center; gap: 0.5rem;">
              <input type="radio" name="appointmentType" value="date" checked onchange="toggleAppointmentType()">
              <span>📅 Date exacte</span>
            </label>
            <label style="display: flex; align-items: center; gap: 0.5rem;">
              <input type="radio" name="appointmentType" value="month" onchange="toggleAppointmentType()">
              <span>📆 Mois (à préciser)</span>
            </label>
          </div>
        </div>
        
        <div class="form-group" id="appointmentDateGroup">
          <label class="form-label">Date du RDV *</label>
          <input type="text" class="form-input" id="appointmentDate" placeholder="JJ/MM/AAAA" pattern="\d{2}/\d{2}/\d{4}">
        </div>

        <div class="form-group" id="appointmentTimeGroup">
          <label class="form-label">Heure (optionnel)</label>
          <input type="time" class="form-input" id="appointmentTime">
        </div>

        <div class="form-group hidden" id="appointmentMonthGroup">
          <label class="form-label">Mois *</label>
          <input type="text" class="form-input" id="appointmentMonth" placeholder="MM/AAAA" pattern="\d{2}/\d{4}">
        </div>
        
        <div class="form-group" style="grid-column: span 2;">
          <label class="form-label">Notes</label>
          <textarea class="form-input" id="appointmentNotes" rows="3" placeholder="Motif du suivi, remarques..."></textarea>
        </div>
      </form>
      </div><!-- End modal-form-content -->
    </div><!-- End modal-body-split -->

    <div class="modal-footer">
      <button class="btn btn-danger hidden" id="btnDeleteAppointment" onclick="deleteAppointment()">Supprimer</button>
      <button class="btn btn-secondary" onclick="showModal(false, 'appointmentModal')">Annuler</button>
      <button class="btn btn-primary" onclick="saveAppointment()">Enregistrer</button>
    </div>
  </div>
</div>

<!-- Complete Appointment Modal -->
<div class="modal" id="completeAppointmentModal">
  <div class="modal-content">
    <div class="modal-header" style="background: linear-gradient(135deg, var(--success), #059669); color: white;">
      <h2 class="modal-title">✅ Marquer comme réalisé</h2>
      <button class="modal-close" onclick="showModal(false, 'completeAppointmentModal')" style="color: white;">&times;</button>
    </div>
    
    <div class="modal-body">
      <div class="alert alert-success" style="margin-bottom: 1.5rem;">
        <strong id="completePatientName"></strong><br>
        RDV prévu : <span id="completeAppointmentInfo"></span>
      </div>
      
      <form class="form-grid">
        <div class="form-group" style="grid-column: span 2;">
          <label class="form-label">Notes sur ce suivi</label>
          <textarea class="form-input" id="completeNotes" rows="2" placeholder="Compte-rendu, observations..."></textarea>
        </div>
        
        <div class="form-group" style="grid-column: span 2;">
          <hr style="margin: 1rem 0;">
          <h4 style="margin-bottom: 1rem; color: var(--primary);">📅 Planifier le prochain suivi</h4>
        </div>
        
        <div class="form-group" style="grid-column: span 2;">
          <label class="form-label">Type d'échéance *</label>
          <div style="display: flex; gap: 1rem;">
            <label style="display: flex; align-items: center; gap: 0.5rem;">
              <input type="radio" name="nextAppointmentType" value="date" checked onchange="toggleNextAppointmentType()">
              <span>📅 Date exacte</span>
            </label>
            <label style="display: flex; align-items: center; gap: 0.5rem;">
              <input type="radio" name="nextAppointmentType" value="month" onchange="toggleNextAppointmentType()">
              <span>📆 Mois</span>
            </label>
          </div>
        </div>
        
        <div class="form-group" id="nextAppointmentDateGroup">
          <label class="form-label">Date du prochain RDV *</label>
          <input type="text" class="form-input" id="nextAppointmentDate" placeholder="JJ/MM/AAAA" pattern="\d{2}/\d{2}/\d{4}">
        </div>

        <div class="form-group" id="nextAppointmentTimeGroup">
          <label class="form-label">Heure (optionnel)</label>
          <input type="time" class="form-input" id="nextAppointmentTime">
        </div>

        <div class="form-group hidden" id="nextAppointmentMonthGroup">
          <label class="form-label">Mois *</label>
          <input type="text" class="form-input" id="nextAppointmentMonth" placeholder="MM/AAAA" pattern="\d{2}/\d{4}">
        </div>
        
        <div class="form-group" style="grid-column: span 2;">
          <label class="form-label">Notes pour le prochain suivi</label>
          <textarea class="form-input" id="nextAppointmentNotes" rows="2"></textarea>
        </div>
      </form>
    </div>
    
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="showModal(false, 'completeAppointmentModal')">Annuler</button>
      <button class="btn btn-success" onclick="confirmCompleteAppointment()">
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
        </svg>
        Valider et planifier le suivant
      </button>
    </div>
  </div>
</div>

<!-- Switch Modal -->
<div class="modal" id="switchModal">
  <div class="modal-content modal-with-sidebar" style="max-width: 1200px;">
    <div class="modal-header">
      <h2 class="modal-title" id="switchModalTitle">Nouveau Switch de Pompe</h2>
      <button class="modal-close" onclick="showModal(false, 'switchModal')">&times;</button>
    </div>

    <div class="modal-body modal-body-split">
      <!-- Patient Info Sidebar -->
      <div class="patient-info-sidebar" id="switchPatientInfo" style="display: none;">
        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 1rem; border-radius: var(--radius) var(--radius) 0 0; margin: -1.5rem -1.5rem 1rem -1.5rem;">
          <div style="display: flex; align-items: center; gap: 1rem;">
            <div style="width: 60px; height: 60px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem;">
              👤
            </div>
            <div style="flex: 1;">
              <div style="font-weight: 700; font-size: 1.25rem;" id="switchPatientName">-</div>
              <div style="font-size: 0.875rem; opacity: 0.9;" id="switchPatientDob">-</div>
            </div>
          </div>
        </div>

        <div style="display: flex; flex-direction: column; gap: 1rem;">
          <div class="info-item">
            <div class="info-label">📞 Téléphone</div>
            <div class="info-value" id="switchPatientPhone" style="font-weight: 600; color: var(--primary);">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">📧 Email</div>
            <div class="info-value" id="switchPatientEmail" style="font-size: 0.875rem; word-break: break-word;">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">👨‍⚕️ Médecin</div>
            <div class="info-value" id="switchPatientDoctor">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">🏥 Centre</div>
            <div class="info-value" id="switchPatientCenter">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">💊 Protocole actuel</div>
            <div class="info-value" id="switchPatientProtocol">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">📅 Renouvellement</div>
            <div class="info-value" id="switchPatientRenewal">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">📊 Score qualité</div>
            <div id="switchPatientScore">-</div>
          </div>
          <div class="info-item" id="switchPatientNotesContainer" style="display: none;">
            <div class="info-label">📝 Notes</div>
            <div class="info-value" id="switchPatientNotes" style="font-size: 0.875rem; max-height: 100px; overflow-y: auto;">-</div>
          </div>
        </div>
      </div>

      <!-- Main Form Content -->
      <div class="modal-form-content">
        <!-- Alert for existing switches -->
        <div id="existingSwitchesAlert" class="alert alert-info" style="display: none; margin-bottom: 1rem;">
          <strong>ℹ️ Switchs existants pour ce patient :</strong>
          <div id="existingSwitchesList" style="margin-top: 0.5rem;"></div>
        </div>

        <form id="switchForm" class="form-grid">
        <div class="form-group" style="grid-column: span 2;">
          <label class="form-label">Patient *</label>
          <select class="form-select" id="switchPatientId" required>
            <option value="">-- Sélectionner un patient --</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Ancien protocole</label>
          <input type="text" class="form-input" id="switchOldProto" readonly style="background: var(--bg-tertiary);">
        </div>
        
        <div class="form-group">
          <label class="form-label">Nouveau protocole *</label>
          <select class="form-select" id="switchNewProtoId" required>
            <option value="">-- Sélectionner --</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Date prévue du switch *</label>
          <input type="text" class="form-input" id="switchDate" placeholder="JJ/MM/AAAA" pattern="\d{2}/\d{2}/\d{4}" required>
        </div>

        <div class="form-group">
          <label class="form-label">Heure (optionnel)</label>
          <input type="time" class="form-input" id="switchTime">
        </div>

        <div class="form-group">
          <label class="form-label">Statut</label>
          <select class="form-select" id="switchStatus">
            <option value="planned">📅 Prévu</option>
            <option value="completed">✅ Effectué</option>
          </select>
        </div>
        
        <div class="form-group" style="grid-column: span 2;">
          <label class="form-label">Notes</label>
          <textarea class="form-input" id="switchNotes" rows="3"></textarea>
        </div>
      </form>
      </div><!-- End modal-form-content -->
    </div><!-- End modal-body-split -->

    <div class="modal-footer">
      <button class="btn btn-danger hidden" id="btnDeleteSwitch" onclick="deleteSwitch()">Supprimer</button>
      <button class="btn btn-secondary" onclick="showModal(false, 'switchModal')">Annuler</button>
      <button class="btn btn-primary" onclick="saveSwitch()">Enregistrer</button>
    </div>
  </div>
</div>

<!-- Task Modal -->
<div class="modal" id="taskModal">
  <div class="modal-content" style="max-width: 700px;">
    <div class="modal-header">
      <h2 class="modal-title" id="taskModalTitle">Nouvelle tâche</h2>
      <button class="modal-close" onclick="showModal(false, 'taskModal')">&times;</button>
    </div>

    <div class="modal-body">
      <form id="taskForm" class="form-grid">
        <div class="form-group" style="grid-column: span 2;">
          <label class="form-label">Titre *</label>
          <input type="text" class="form-input" id="taskTitle" required placeholder="Ex: Appeler le patient...">
        </div>

        <div class="form-group" style="grid-column: span 2;">
          <label class="form-label">Description</label>
          <textarea class="form-input" id="taskDescription" rows="3" placeholder="Détails de la tâche..."></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Statut *</label>
          <select class="form-select" id="taskStatus" required>
            <option value="todo">À faire</option>
            <option value="in_progress">En cours</option>
            <option value="completed">Terminée</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Priorité *</label>
          <select class="form-select" id="taskPriority" required>
            <option value="low">🟢 Basse</option>
            <option value="normal" selected>🟡 Normale</option>
            <option value="high">🟠 Haute</option>
            <option value="urgent">🔴 Urgente</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Date d'échéance</label>
          <input type="text" class="form-input" id="taskDueDate" placeholder="JJ/MM/AAAA" pattern="\d{2}/\d{2}/\d{4}">
        </div>

        <div class="form-group">
          <label class="form-label">Heure d'échéance</label>
          <input type="time" class="form-input" id="taskDueTime">
        </div>

        <div class="form-group" style="grid-column: span 2;">
          <label class="form-label">Type de liaison</label>
          <select class="form-select" id="taskRelationType" onchange="updateTaskRelationOptions()">
            <option value="none">Aucune</option>
            <option value="patient">Patient</option>
            <option value="doctor">Médecin</option>
            <option value="center">Centre</option>
            <option value="protocol">Protocole</option>
          </select>
        </div>

        <div class="form-group" id="taskRelationGroup" style="grid-column: span 2; display: none;">
          <label class="form-label" id="taskRelationLabel">Sélectionner</label>
          <select class="form-select" id="taskRelationId">
            <option value="">-- Sélectionner --</option>
          </select>
        </div>

        <div class="form-group" style="grid-column: span 2;">
          <label class="form-label">Tags (séparés par des virgules)</label>
          <input type="text" class="form-input" id="taskTags" placeholder="important, urgent, rappel...">
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <button class="btn btn-danger hidden" id="btnDeleteTask" onclick="deleteTask()">Supprimer</button>
      <button class="btn btn-secondary" onclick="showModal(false, 'taskModal')">Annuler</button>
      <button class="btn btn-primary" onclick="saveTask()">Enregistrer</button>
    </div>
  </div>
</div>

<!-- Validate Switch Modal (with prescription question) -->
<div class="modal" id="validateSwitchModal">
  <div class="modal-content" style="max-width: 600px;">
    <div class="modal-header">
      <h2 class="modal-title">✅ Valider le Switch</h2>
      <button class="modal-close" onclick="showModal(false, 'validateSwitchModal')">&times;</button>
    </div>
    
    <div class="modal-body">
      <div style="margin-bottom: 20px; padding: 15px; background: var(--bg-tertiary); border-radius: var(--radius-md); border-left: 4px solid var(--info);">
        <p style="margin-bottom: 10px; font-weight: 600;">📋 Informations du switch</p>
        <p id="validateSwitchInfo" style="color: var(--text-secondary);"></p>
      </div>
      
      <div style="margin-bottom: 20px; padding: 20px; background: var(--bg-secondary); border-radius: var(--radius-md); border: 2px solid var(--border);">
        <p style="margin-bottom: 15px; font-weight: 600; font-size: 16px;">📝 Ordonnance initiale</p>
        <p style="margin-bottom: 15px; color: var(--text-secondary);">Une ordonnance initiale a-t-elle été effectuée pour ce switch ?</p>
        
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
          <button class="btn btn-secondary" onclick="selectPrescriptionOption('yes')" id="btnPrescYes" style="flex: 1;">
            ✅ Oui
          </button>
          <button class="btn btn-secondary" onclick="selectPrescriptionOption('no')" id="btnPrescNo" style="flex: 1;">
            ❌ Non
          </button>
        </div>
        
        <div id="prescriptionDateInput" style="display: none;">
          <label class="form-label">Date de renouvellement de l'ordonnance *</label>
          <input type="text" class="form-input" id="prescriptionRenewalDate" placeholder="JJ/MM/AAAA" pattern="\d{2}/\d{2}/\d{4}">
          <div class="text-small text-muted mt-1">📅 Date de la prochaine ordonnance de renouvellement</div>
        </div>
        
        <div id="prescriptionNoInfo" style="display: none; padding: 10px; background: rgba(245, 158, 11, 0.1); border-radius: var(--radius); border-left: 3px solid var(--warning); margin-top: 10px;">
          <p style="color: var(--warning); font-size: 14px; margin: 0;">
            ℹ️ La date de renouvellement sera définie à la date du switch.
          </p>
        </div>
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="showModal(false, 'validateSwitchModal')">Annuler</button>
      <button class="btn btn-success" id="btnConfirmValidateSwitch" onclick="confirmValidateSwitch()" disabled>
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
        Valider le Switch
      </button>
    </div>
  </div>
</div>

<!-- Purge Totale Modal -->
<div class="modal" id="purgeTotaleModal">
  <div class="modal-content" style="max-width: 600px;">
    <div class="modal-header" style="background: linear-gradient(135deg, #dc2626, #991b1b); color: white;">
      <h2 class="modal-title" style="display: flex; align-items: center; gap: 0.5rem;">
        <span style="font-size: 1.5rem;">⚠️</span>
        PURGE TOTALE
      </h2>
      <button class="modal-close" onclick="showModal(false, 'purgeTotaleModal')" style="color: white;">&times;</button>
    </div>

    <div class="modal-body">
      <!-- Avertissement -->
      <div style="background: rgba(239, 68, 68, 0.1); border: 2px solid #ef4444; border-radius: var(--radius-md); padding: 1.5rem; margin-bottom: 1.5rem;">
        <h3 style="color: #dc2626; margin: 0 0 1rem 0; font-size: 1.25rem;">
          ⚠️ ATTENTION : Action irréversible
        </h3>
        <p style="margin: 0 0 0.5rem 0; color: var(--text-primary);">
          Cette action supprimera <strong>TOUTES</strong> les données suivantes :
        </p>
        <ul style="margin: 0; padding-left: 1.5rem; color: var(--text-secondary);">
          <li>Tous les patients (<strong id="purgePatientCount">0</strong>)</li>
          <li>Tous les rendez-vous (<strong id="purgeAppointmentCount">0</strong>)</li>
          <li>Tous les switchs (<strong id="purgeSwitchCount">0</strong>)</li>
          <li>Tous les médecins (<strong id="purgeDoctorCount">0</strong>)</li>
          <li>Tous les centres (<strong id="purgeCenterCount">0</strong>)</li>
          <li>Tous les protocoles (<strong id="purgeProtocolCount">0</strong>)</li>
          <li>Tous les templates</li>
          <li>Toutes les tâches</li>
          <li>Tout l'historique</li>
        </ul>
      </div>

      <!-- Export avant purge -->
      <div style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 1.5rem; margin-bottom: 1.5rem;">
        <h4 style="margin: 0 0 1rem 0; color: var(--primary);">
          💾 Sauvegarde recommandée
        </h4>
        <p style="margin: 0 0 1rem 0; color: var(--text-secondary);">
          Avant de purger, il est fortement recommandé d'exporter vos données.
        </p>
        <button class="btn btn-primary" onclick="exportBeforePurge()" style="width: 100%;">
          📥 Exporter toutes les données (JSON)
        </button>
      </div>

      <!-- Confirmations -->
      <div style="margin-bottom: 1.5rem;">
        <h4 style="margin: 0 0 1rem 0; color: #dc2626;">
          ✋ Confirmations requises
        </h4>

        <label style="display: flex; align-items: start; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: var(--radius); margin-bottom: 0.5rem; cursor: pointer;">
          <input type="checkbox" id="purgeConfirm1" style="margin-top: 0.25rem;">
          <span style="color: var(--text-primary);">
            Je comprends que cette action est <strong>irréversible</strong>
          </span>
        </label>

        <label style="display: flex; align-items: start; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: var(--radius); margin-bottom: 0.5rem; cursor: pointer;">
          <input type="checkbox" id="purgeConfirm2" style="margin-top: 0.25rem;">
          <span style="color: var(--text-primary);">
            J'ai <strong>exporté mes données</strong> ou je n'en ai pas besoin
          </span>
        </label>

        <label style="display: flex; align-items: start; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: var(--radius); cursor: pointer;">
          <input type="checkbox" id="purgeConfirm3" style="margin-top: 0.25rem;">
          <span style="color: var(--text-primary);">
            Je veux vraiment <strong>supprimer TOUTES les données</strong>
          </span>
        </label>
      </div>

      <!-- Confirmation finale par texte -->
      <div style="margin-bottom: 1.5rem;">
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #dc2626;">
          Tapez <code style="background: var(--bg-tertiary); padding: 0.25rem 0.5rem; border-radius: var(--radius); color: #dc2626; font-weight: 700;">PURGER TOUT</code> pour confirmer
        </label>
        <input
          type="text"
          id="purgeConfirmText"
          class="form-input"
          placeholder="PURGER TOUT"
          style="border-color: #dc2626;"
          autocomplete="off"
        >
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="showModal(false, 'purgeTotaleModal')">
        Annuler
      </button>
      <button class="btn btn-danger" id="btnConfirmPurge" onclick="executePurgeTotale()" disabled style="background: #dc2626; border-color: #dc2626;">
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20" style="margin-right: 0.5rem;">
          <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
        </svg>
        PURGER TOUTES LES DONNÉES
      </button>
    </div>
  </div>
</div>

<!-- CSV Import Modal -->
<div class="modal" id="csvImportModal">
  <div class="modal-content" style="max-width: 1400px;">
    <div class="modal-header">
      <h2 class="modal-title">📊 Import CSV Avancé - Mapping Intelligent</h2>
      <button class="modal-close" onclick="showModal(false, 'csvImportModal')">&times;</button>
    </div>
    
    <div class="modal-body" style="max-height: 80vh; overflow-y: auto;">
      <!-- Drop Zone -->
      <div class="drop-zone" id="dropZone" style="border: 3px dashed var(--primary); border-radius: 12px; padding: 60px; text-align: center; background: var(--bg-tertiary); cursor: pointer; transition: all 0.3s; margin-bottom: 30px;">
        <div class="drop-zone-icon" style="font-size: 48px; margin-bottom: 15px;">📁</div>
        <div class="drop-zone-text" style="font-size: 18px; margin-bottom: 10px;">Glissez-déposez votre fichier ici</div>
        <div class="drop-zone-hint" style="color: var(--text-muted); font-size: 14px;">ou cliquez pour sélectionner (CSV, Excel, TSV, TXT)</div>
        <input type="file" id="csvFileInputAdv" accept=".csv,.tsv,.txt,.xlsx,.xls" style="display: none;">
      </div>
      
      <!-- File Info -->
      <div class="file-info" id="csvFileInfo" style="display: none; background: #e8f5e9; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #27ae60;">
        <h3 style="margin-bottom: 15px; color: #27ae60;">📄 Informations du fichier</h3>
        <div id="csvFileInfoContent" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;"></div>
      </div>
      
      <!-- Options Panel -->
      <div class="options-panel" id="csvOptionsPanel" style="display: none; background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #f39c12;">
        <div style="margin: 10px 0; display: flex; align-items: center; gap: 10px;">
          <input type="checkbox" id="csvHasHeaders" checked style="width: 18px; height: 18px; cursor: pointer;">
          <label for="csvHasHeaders" style="cursor: pointer;">La première ligne contient les en-têtes</label>
        </div>
        <div style="margin: 10px 0; display: flex; align-items: center; gap: 10px;">
          <input type="checkbox" id="csvAutoDetect" checked style="width: 18px; height: 18px; cursor: pointer;">
          <label for="csvAutoDetect" style="cursor: pointer;">Détection automatique des colonnes</label>
        </div>
      </div>
      
      <!-- Alert Box -->
      <div id="csvAlertBox" style="display: none; padding: 15px; border-radius: 8px; margin-bottom: 20px;"></div>
      
      <!-- Preview Container -->
      <div class="preview-container" id="csvPreviewContainer" style="display: none;">
        <div class="preview-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2>📋 Mapping des colonnes</h2>
          <div class="stats" style="display: flex; gap: 20px;">
            <div style="text-align: center;">
              <div id="csvColCount" style="font-size: 24px; font-weight: 700; color: var(--primary);">0</div>
              <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase;">Colonnes</div>
            </div>
            <div style="text-align: center;">
              <div id="csvRowCountStat" style="font-size: 24px; font-weight: 700; color: var(--primary);">0</div>
              <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase;">Lignes</div>
            </div>
            <div style="text-align: center;">
              <div id="csvMappedCount" style="font-size: 24px; font-weight: 700; color: var(--success);">0</div>
              <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase;">Mappées</div>
            </div>
          </div>
        </div>
        
        <!-- Mapping Table -->
        <div style="overflow-x: auto; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 20px;">
          <table id="csvMappingTable" style="width: 100%; border-collapse: separate; border-spacing: 0; min-width: 800px;"></table>
        </div>
        
        <!-- Actions -->
        <div class="modal-footer" style="display: flex; gap: 15px; justify-content: space-between; align-items: center;">
          <div style="display: flex; gap: 10px;">
            <button class="btn btn-secondary" onclick="csvRedetect()">🔄 Re-détecter</button>
            <button class="btn btn-secondary" onclick="csvClearMapping()">🗑️ Effacer mapping</button>
          </div>
          <div style="display: flex; gap: 10px;">
            <button class="btn btn-secondary" onclick="csvReset()">Annuler</button>
            <button class="btn btn-success" id="csvBtnImport" onclick="csvExecuteImport()" disabled>
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
              Importer les données
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Advanced Export Modal -->
<div class="modal" id="advancedExportModal">
  <div class="modal-content" style="max-width: 900px;">
    <div class="modal-header">
      <h2 class="modal-title">📊 Export Excel avancé - Filtres multiples</h2>
      <button class="modal-close" onclick="showModal(false, 'advancedExportModal')">&times;</button>
    </div>
    <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">

      <!-- Filtres Médecins -->
      <div style="margin-bottom: 1.5rem;">
        <h4 style="margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
          </svg>
          Médecins
        </h4>
        <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
          <button class="btn btn-sm btn-secondary" onclick="selectAllFilterDoctors(true)">Tout sélectionner</button>
          <button class="btn btn-sm btn-secondary" onclick="selectAllFilterDoctors(false)">Tout désélectionner</button>
        </div>
        <div id="filterDoctors" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 0.5rem;"></div>
      </div>

      <!-- Filtres Protocoles/Matériels -->
      <div style="margin-bottom: 1.5rem;">
        <h4 style="margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
            <path d="M3 12v3c0 1.657 3.134 3 7 3s7-1.343 7-3v-3c0 1.657-3.134 3-7 3s-7-1.343-7-3z"></path>
            <path d="M3 7v3c0 1.657 3.134 3 7 3s7-1.343 7-3V7c0 1.657-3.134 3-7 3S3 8.657 3 7z"></path>
            <path d="M17 5c0 1.657-3.134 3-7 3S3 6.657 3 5s3.134-3 7-3 7 1.343 7 3z"></path>
          </svg>
          Matériels / Protocoles
        </h4>
        <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
          <button class="btn btn-sm btn-secondary" onclick="selectAllFilterProtocols(true)">Tout sélectionner</button>
          <button class="btn btn-sm btn-secondary" onclick="selectAllFilterProtocols(false)">Tout désélectionner</button>
        </div>
        <div id="filterProtocols" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 0.5rem;"></div>
      </div>

      <!-- Filtres Centres -->
      <div style="margin-bottom: 1.5rem;">
        <h4 style="margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a1 1 0 110 2h-3a1 1 0 01-1-1v-2a1 1 0 00-1-1H9a1 1 0 00-1 1v2a1 1 0 01-1 1H4a1 1 0 110-2V4zm3 1h2v2H7V5zm2 4H7v2h2V9zm2-4h2v2h-2V5zm2 4h-2v2h2V9z" clip-rule="evenodd"></path>
          </svg>
          Centres
        </h4>
        <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
          <button class="btn btn-sm btn-secondary" onclick="selectAllFilterCenters(true)">Tout sélectionner</button>
          <button class="btn btn-sm btn-secondary" onclick="selectAllFilterCenters(false)">Tout désélectionner</button>
        </div>
        <div id="filterCenters" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 0.5rem;"></div>
      </div>

      <!-- Filtres Statuts -->
      <div style="margin-bottom: 1.5rem;">
        <h4 style="margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
          </svg>
          Statuts
        </h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.5rem;">
          <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: var(--bg-tertiary); border-radius: var(--radius); cursor: pointer;">
            <input type="checkbox" id="filterStatusValid" checked style="cursor: pointer;">
            <span style="color: var(--success);">✅ Valide</span>
          </label>
          <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: var(--bg-tertiary); border-radius: var(--radius); cursor: pointer;">
            <input type="checkbox" id="filterStatusSoon" checked style="cursor: pointer;">
            <span style="color: var(--info);">⏰ Bientôt à renouveler</span>
          </label>
          <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: var(--bg-tertiary); border-radius: var(--radius); cursor: pointer;">
            <input type="checkbox" id="filterStatusUrgent" checked style="cursor: pointer;">
            <span style="color: var(--warning);">⚠️ Urgent</span>
          </label>
          <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: var(--bg-tertiary); border-radius: var(--radius); cursor: pointer;">
            <input type="checkbox" id="filterStatusExpired" checked style="cursor: pointer;">
            <span style="color: var(--danger);">❌ Expiré</span>
          </label>
        </div>
      </div>

      <!-- Filtre par période -->
      <div style="margin-bottom: 1.5rem;">
        <h4 style="margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
          </svg>
          Période de renouvellement (optionnel)
        </h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div class="form-group">
            <label for="filterDateFrom">Date de début</label>
            <input type="date" id="filterDateFrom" class="form-control">
          </div>
          <div class="form-group">
            <label for="filterDateTo">Date de fin</label>
            <input type="date" id="filterDateTo" class="form-control">
          </div>
        </div>
      </div>

      <!-- Tri des résultats -->
      <div style="margin-bottom: 1.5rem;">
        <h4 style="margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
            <path d="M3 3a1 1 0 000 2h11a1 1 0 100-2H3zM3 7a1 1 0 000 2h7a1 1 0 100-2H3zM3 11a1 1 0 100 2h4a1 1 0 100-2H3zM15 8a1 1 0 10-2 0v5.586l-1.293-1.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L15 13.586V8z"></path>
          </svg>
          Ordre de tri
        </h4>
        <select class="form-select" id="exportSortBy" style="max-width: 400px;">
          <option value="name">Trier par nom (A-Z)</option>
          <option value="renewal">Date de renouvellement puis nom</option>
          <option value="doctor">Médecin puis nom (A-Z)</option>
          <option value="center">Centre puis nom (A-Z)</option>
          <option value="protocol">Matériel puis nom (A-Z)</option>
        </select>
      </div>

      <!-- Résumé des filtres -->
      <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius); border-left: 4px solid var(--primary);">
        <h4 style="margin: 0 0 0.5rem 0;">📊 Résumé</h4>
        <p id="filterSummary" style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">Sélectionnez vos filtres ci-dessus</p>
      </div>

    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="showModal(false, 'advancedExportModal')">Annuler</button>
      <button class="btn btn-success" onclick="executeAdvancedExport()">
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
        </svg>
        Exporter vers Excel
      </button>
    </div>
  </div>
</div>

<!-- Export Confirmation Modal -->
<div class="modal" id="exportConfirmModal">
  <div class="modal-content" style="max-width: 700px; max-height: 85vh;">
    <div class="modal-header">
      <h2>Options d'export</h2>
      <button class="close-button" onclick="showModal(false, 'exportConfirmModal')">×</button>
    </div>
    <div class="modal-body" style="text-align: center; padding: 30px; overflow-y: auto;">
      <div style="font-size: 48px; margin-bottom: 20px;">📝</div>
      <p style="font-size: 16px; margin-bottom: 30px; color: #64748b;">
        Souhaitez-vous ajouter des commentaires à chaque patient avant l'export ?
      </p>
      <div id="exportConfirmSummary" style="background: #f1f5f9; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 14px;">
      </div>
      <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
        <button class="btn btn-secondary" onclick="proceedToExport('csv')" style="flex: 1; min-width: 250px;">
          <svg style="width:18px;height:18px;margin-right:8px;" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Non, export CSV direct
        </button>
        <button class="btn btn-primary" onclick="startPatientReview()" style="flex: 1; min-width: 250px;">
          <svg style="width:18px;height:18px;margin-right:8px;" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Oui, ajouter commentaires + PDF
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Patient Review Modal -->
<div class="modal" id="patientReviewModal">
  <div class="modal-content" style="max-width: 800px;">
    <div class="modal-header">
      <h2>
        <span id="reviewProgressText">Revue des patients (1 / 10)</span>
      </h2>
      <button class="close-button" onclick="cancelPatientReview()">×</button>
    </div>
    <div class="modal-body" style="padding: 30px;">
      <!-- Progress bar -->
      <div style="background: #e2e8f0; height: 8px; border-radius: 4px; margin-bottom: 30px; overflow: hidden;">
        <div id="reviewProgressBar" style="background: linear-gradient(90deg, #3b82f6, #06b6d4); height: 100%; width: 0%; transition: width 0.3s;"></div>
      </div>

      <!-- Patient Card -->
      <div id="reviewPatientCard" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
          <div>
            <h3 id="reviewPatientName" style="margin: 0 0 5px 0; font-size: 22px;">Nom du patient</h3>
            <p id="reviewPatientDob" style="margin: 0; opacity: 0.9; font-size: 14px;">Date de naissance</p>
          </div>
          <div id="reviewPatientStatus" style="background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 600;">
            STATUT
          </div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px;">
          <div>
            <div style="opacity: 0.8; font-size: 12px; margin-bottom: 4px;">📧 Email</div>
            <div id="reviewPatientEmail" style="font-size: 14px;">—</div>
          </div>
          <div>
            <div style="opacity: 0.8; font-size: 12px; margin-bottom: 4px;">📞 Téléphone</div>
            <div id="reviewPatientPhone" style="font-size: 14px;">—</div>
          </div>
          <div>
            <div style="opacity: 0.8; font-size: 12px; margin-bottom: 4px;">👨‍⚕️ Médecin</div>
            <div id="reviewPatientDoctor" style="font-size: 14px;">—</div>
          </div>
          <div>
            <div style="opacity: 0.8; font-size: 12px; margin-bottom: 4px;">🏥 Centre</div>
            <div id="reviewPatientCenter" style="font-size: 14px;">—</div>
          </div>
          <div>
            <div style="opacity: 0.8; font-size: 12px; margin-bottom: 4px;">💊 Matériel/Protocole</div>
            <div id="reviewPatientProtocol" style="font-size: 14px;">—</div>
          </div>
          <div>
            <div style="opacity: 0.8; font-size: 12px; margin-bottom: 4px;">📅 Renouvellement</div>
            <div id="reviewPatientRenewal" style="font-size: 14px;">—</div>
          </div>
        </div>
      </div>

      <!-- Notes existantes -->
      <div id="reviewExistingNotes" style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none;">
        <div style="font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 8px;">📋 Notes existantes :</div>
        <div id="reviewExistingNotesContent" style="font-size: 14px; color: #334155;"></div>
      </div>

      <!-- Commentaire pour l'export -->
      <div style="margin-bottom: 20px;">
        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #334155;">
          💬 Commentaire pour l'export PDF :
        </label>
        <textarea
          id="reviewCommentInput"
          rows="4"
          placeholder="Ajoutez un commentaire spécifique pour ce patient dans l'export PDF..."
          style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-family: inherit; font-size: 14px; resize: vertical;"
        ></textarea>
        <div style="font-size: 12px; color: #64748b; margin-top: 5px;">
          Ce commentaire sera affiché uniquement dans l'export PDF
        </div>
      </div>

      <!-- Navigation buttons -->
      <div style="display: flex; gap: 10px; justify-content: space-between;">
        <button class="btn btn-secondary" id="reviewPrevBtn" onclick="previousPatientReview()" disabled>
          <svg style="width:18px;height:18px;margin-right:8px;" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M15 19l-7-7 7-7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Précédent
        </button>
        <button class="btn btn-secondary" onclick="skipAllReview()" style="flex: 1;">
          Passer tout
        </button>
        <button class="btn btn-primary" id="reviewNextBtn" onclick="nextPatientReview()">
          <span id="reviewNextBtnText">Suivant</span>
          <svg style="width:18px;height:18px;margin-left:8px;" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M9 5l7 7-7 7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Template Upload Modal -->
<div class="modal" id="templateUploadModal">
  <div class="modal-content" style="max-width: 700px;">
    <div class="modal-header">
      <h2 class="modal-title">📄 Ajouter un Template d'Ordonnance</h2>
      <button class="modal-close" onclick="showModal(false, 'templateUploadModal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Nom du template</label>
        <input type="text" class="form-input" id="templateName" placeholder="Ex: Ordonnance CPAP Standard">
      </div>

      <div class="form-group">
        <label class="form-label">Protocole associé</label>
        <select class="form-input" id="templateProto">
          <option value="">Sélectionner un protocole...</option>
        </select>
        <small class="text-muted">Ce template sera utilisé automatiquement pour ce protocole</small>
      </div>

      <div class="form-group">
        <label class="form-label">Type de template</label>
        <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
            <input type="radio" name="templateType" value="default" checked onchange="toggleTemplateUpload()">
            <span>Template par défaut</span>
          </label>
          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
            <input type="radio" name="templateType" value="upload" onchange="toggleTemplateUpload()">
            <span>Uploader un document</span>
          </label>
        </div>
      </div>

      <div id="uploadSection" style="display: none;">
        <div class="form-group">
          <label class="form-label">Document Word (.docx)</label>
          <input type="file" class="form-input" id="templateFile" accept=".docx,.doc" onchange="handleTemplateFileUpload(event)">
          <small class="text-muted">Uploadez votre ordonnance au format Word</small>
        </div>
        <div id="filePreview" style="display: none; padding: 1rem; background: var(--bg-secondary); border-radius: var(--radius); margin-top: 1rem;">
          <strong>Aperçu du fichier :</strong>
          <div id="filePreviewContent" style="margin-top: 0.5rem; font-size: 14px; color: var(--text-secondary);"></div>
        </div>
      </div>

      <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: var(--radius); border-left: 4px solid var(--info);">
        <strong style="color: var(--info);">ℹ️ Champs automatiques</strong>
        <p style="font-size: 14px; color: var(--text-secondary); margin: 0.5rem 0 0 0;">
          Les champs suivants seront remplis automatiquement : Nom patient, Date de naissance, Médecin, Date début, Date fin, Durée, Protocole/Matériel
        </p>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="showModal(false, 'templateUploadModal')">Annuler</button>
      <button class="btn btn-primary" onclick="saveTemplate()">
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
          <path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h5a2 2 0 012 2v7a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2h5v5.586l-1.293-1.293zM9 4a1 1 0 012 0v2H9V4z"></path>
        </svg>
        Enregistrer
      </button>
    </div>
  </div>
</div>

<!-- Generate Prescription Modal -->
<div class="modal" id="generatePrescriptionModal">
  <div class="modal-content" style="max-width: 650px;">
    <div class="modal-header">
      <h2 class="modal-title">📋 Générer une Ordonnance</h2>
      <button class="modal-close" onclick="showModal(false, 'generatePrescriptionModal')">&times;</button>
    </div>
    <div class="modal-body">
      <!-- Patient Info Card -->
      <div style="padding: 1.5rem; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; border-radius: var(--radius); margin-bottom: 1.5rem;">
        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
          <svg width="40" height="40" fill="white" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
          </svg>
          <div>
            <h3 id="prescPatientName" style="margin: 0; font-size: 1.5rem;">Patient</h3>
            <p id="prescPatientDob" style="margin: 0; opacity: 0.9;">Date de naissance</p>
          </div>
        </div>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; font-size: 0.9rem;">
          <div>
            <strong>Médecin :</strong> <span id="prescDoctor">-</span>
          </div>
          <div>
            <strong>Protocole :</strong> <span id="prescProtocol">-</span>
          </div>
        </div>
      </div>

      <!-- Template Selection -->
      <div class="form-group">
        <label class="form-label">Template d'ordonnance</label>
        <select class="form-input" id="prescTemplateSelect">
          <option value="">Sélectionner un template...</option>
        </select>
        <small class="text-muted" id="prescTemplateHint"></small>
      </div>

      <!-- Duration -->
      <div class="form-group">
        <label class="form-label">Durée de l'ordonnance</label>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem;">
          <label class="duration-option">
            <input type="radio" name="prescDuration" value="3" checked>
            <span class="duration-card">3 mois</span>
          </label>
          <label class="duration-option">
            <input type="radio" name="prescDuration" value="6">
            <span class="duration-card">6 mois</span>
          </label>
          <label class="duration-option">
            <input type="radio" name="prescDuration" value="9">
            <span class="duration-card">9 mois</span>
          </label>
          <label class="duration-option">
            <input type="radio" name="prescDuration" value="12">
            <span class="duration-card">12 mois</span>
          </label>
        </div>
      </div>

      <!-- Start Date -->
      <div class="form-group">
        <label class="form-label">Date de début</label>
        <input type="date" class="form-input" id="prescStartDate" onchange="updatePrescEndDate()">
      </div>

      <!-- End Date (Auto-calculated) -->
      <div class="form-group">
        <label class="form-label">Date de fin (calculée automatiquement)</label>
        <input type="date" class="form-input" id="prescEndDate" readonly style="background: var(--bg-secondary);">
      </div>

      <!-- Formation technique Initiale Option -->
      <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: var(--radius);">
        <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
          <input type="checkbox" id="prescFormationInitiale" style="width: 18px; height: 18px;">
          <div>
            <strong>Formation technique Initiale</strong>
            <p style="font-size: 14px; color: var(--text-secondary); margin: 0.25rem 0 0 0;">
              Cocher cette case pour indiquer qu'une formation technique initiale est requise
            </p>
          </div>
        </label>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="showModal(false, 'generatePrescriptionModal')">Annuler</button>
      <button class="btn btn-success" onclick="generatePrescriptionPDF()">
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v3.586l-1.293-1.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V8z" clip-rule="evenodd"></path>
        </svg>
        Générer l'ordonnance PDF
      </button>
    </div>
  </div>
</div>

<!-- Shortcut Manager Modal -->
<div class="modal" id="shortcutManagerModal">
  <div class="modal-content" style="max-width: 700px;">
    <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
      <h2 class="modal-title">🔗 Gestion des Raccourcis</h2>
      <button class="modal-close" onclick="showModal(false, 'shortcutManagerModal')" style="color: white;">&times;</button>
    </div>

    <div class="modal-body">
      <!-- Add New Shortcut Form -->
      <div style="background: var(--bg-secondary); border-radius: var(--radius-md); padding: 1.5rem; margin-bottom: 1.5rem;">
        <h3 style="margin: 0 0 1rem 0; font-size: 1.1rem;">➕ Nouveau Raccourci</h3>

        <div style="display: grid; gap: 1rem;">
          <div>
            <label class="form-label">Nom du raccourci *</label>
            <input type="text" class="form-input" id="shortcutName" placeholder="Ex: Google Drive">
          </div>

          <div>
            <label class="form-label">URL *</label>
            <input type="url" class="form-input" id="shortcutUrl" placeholder="https://...">
          </div>

          <div>
            <label class="form-label">Icône (emoji)</label>
            <input type="text" class="form-input" id="shortcutIcon" placeholder="Ex: 📁 🌐 📊" maxlength="2" style="width: 100px;">
            <div class="text-small text-muted mt-1">Un emoji pour représenter le raccourci</div>
          </div>

          <button class="btn btn-primary" onclick="addShortcut()" style="width: 100%;">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
            </svg>
            Ajouter le raccourci
          </button>
        </div>
      </div>

      <!-- Shortcuts List -->
      <div>
        <h3 style="margin: 0 0 1rem 0; font-size: 1.1rem;">📋 Mes Raccourcis</h3>
        <div id="shortcutsManagerList">
          <!-- Généré dynamiquement -->
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="showModal(false, 'shortcutManagerModal')">Fermer</button>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<script>
// ===== NOUVEAU SYSTÈME AUTO-UPDATE - IndexedDB + Intégrité =====
(async function() {
  'use strict';

  const DB_NAME = 'NHC_UpdateManager';
  const DB_VERSION = 1;
  const STORE_NAME = 'updates';
  const UPDATE_MARKER_KEY = 'nhc-active-update-version';

  console.log('🚀 AUTO-UPDATE: Démarrage du système de mise à jour...');

  // Fonction pour ouvrir IndexedDB
  function openUpdateDB() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open(DB_NAME, DB_VERSION);

      request.onerror = () => {
        console.error('❌ Erreur ouverture IndexedDB:', request.error);
        reject(request.error);
      };

      request.onsuccess = () => {
        console.log('✅ IndexedDB ouvert avec succès');
        resolve(request.result);
      };

      request.onupgradeneeded = (event) => {
        console.log('🔧 Création/mise à jour du schéma IndexedDB...');
        const db = event.target.result;

        // Créer le store si nécessaire
        if (!db.objectStoreNames.contains(STORE_NAME)) {
          const objectStore = db.createObjectStore(STORE_NAME, { keyPath: 'version' });
          objectStore.createIndex('installedAt', 'installedAt', { unique: false });
          objectStore.createIndex('active', 'active', { unique: false });
          console.log('✅ Object store créé');
        }
      };
    });
  }

  // Fonction pour récupérer la mise à jour active
  function getActiveUpdate(db) {
    return new Promise((resolve, reject) => {
      const transaction = db.transaction([STORE_NAME], 'readonly');
      const objectStore = transaction.objectStore(STORE_NAME);
      const index = objectStore.index('active');
      const request = index.get(true);

      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
  }

  // Extraire la version du fichier actuel
  const currentVersion = document.title.match(/v?(\d+\.\d+\.\d+)/);
  const fileVersion = currentVersion ? currentVersion[1] : '0.0.0';

  console.log(`📄 Version du fichier actuel: ${fileVersion}`);

  try {
    // Ouvrir IndexedDB
    const db = await openUpdateDB();

    // Vérifier s'il y a une mise à jour active
    const activeUpdate = await getActiveUpdate(db);

    if (activeUpdate && activeUpdate.htmlContent) {
      console.log(`🔍 Mise à jour active trouvée: v${activeUpdate.version}`);

      // Vérifier si la version de la mise à jour est différente du fichier
      if (activeUpdate.version !== fileVersion) {
        console.log(`🔄 Application de la mise à jour v${activeUpdate.version} (fichier: v${fileVersion})`);

        // Vérifier l'intégrité si un checksum est disponible
        if (activeUpdate.checksum) {
          console.log('🔐 Vérification de l\'intégrité...');
          const hash = await crypto.subtle.digest(
            'SHA-256',
            new TextEncoder().encode(activeUpdate.htmlContent)
          );
          const hashHex = Array.from(new Uint8Array(hash))
            .map(b => b.toString(16).padStart(2, '0'))
            .join('');

          if (hashHex !== activeUpdate.checksum) {
            console.error('❌ CORRUPTION DÉTECTÉE ! Checksum invalide.');
            console.error(`   Attendu: ${activeUpdate.checksum}`);
            console.error(`   Reçu:    ${hashHex}`);

            // Désactiver cette mise à jour corrompue
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const objectStore = transaction.objectStore(STORE_NAME);
            activeUpdate.active = false;
            activeUpdate.corruptedAt = new Date().toISOString();
            objectStore.put(activeUpdate);

            showCriticalError('Mise à jour corrompue détectée et désactivée. Le fichier original sera utilisé.');
            db.close();
            return;
          }

          console.log('✅ Intégrité vérifiée');
        }

        // Appliquer la mise à jour en remplaçant le document
        console.log('✅ Application de la mise à jour...');

        // Utiliser document.write pour remplacer complètement le contenu
        // C'est la SEULE méthode qui fonctionne de manière persistante
        document.open();
        document.write(activeUpdate.htmlContent);
        document.close();

        db.close();
        return; // Stop execution
      } else {
        console.log('ℹ️ Version de la mise à jour identique au fichier, pas de remplacement nécessaire');
      }
    } else {
      console.log('ℹ️ Aucune mise à jour active, chargement du fichier original');
    }

    db.close();

  } catch (error) {
    console.error('❌ Erreur dans le système AUTO-UPDATE:', error);
    console.log('⚠️ Chargement du fichier original...');
    // Continue avec le fichier original en cas d'erreur
  }

  function showCriticalError(message) {
    // Afficher une alerte critique au démarrage
    setTimeout(() => {
      if (window.showToast) {
        showToast('⚠️ ' + message, 'error');
      } else {
        alert('⚠️ ' + message);
      }
    }, 1000);
  }

})();

// ===== MAIN APPLICATION CODE =====
(function() {
'use strict';

// ===== Configuration =====
const DB_KEY = 'nhc-care-v4';
const LEGACY_KEY = 'nhc-care-v1';

// ===== State Management =====
let state = {
  patients: [],
  docs: [],
  centers: [],
  protos: [],
  switches: [],
  appointments: [],
  prescriptionTemplates: [],
  tasks: [],
  shortcuts: []
};

let currentPatientId = null;
let currentSwitchId = null;
let currentAppointmentId = null;
let currentTaskId = null;
let fcState = { list: [], index: 0 };

// ===== Database Functions =====
function loadDB() {
  try {
    const stored = localStorage.getItem(DB_KEY);
    if (stored) {
      const parsed = JSON.parse(stored);
      state = { ...state, ...parsed };
    }

    // Migration from old versions
    if (!stored) {
      const oldKeys = ['nhc-care-v1', 'nhc-care-v2', 'nhc-care-v3'];
      for (const key of oldKeys) {
        const oldData = localStorage.getItem(key);
        if (oldData) {
          const parsed = JSON.parse(oldData);
          state = { ...state, ...parsed };
          saveDB();
          showToast(`Migration depuis ${key} réussie`, 'success');
          break;
        }
      }
    }

    // Ensure history array exists for all patients (backward compatibility)
    let historyFixed = 0;
    state.patients.forEach(patient => {
      if (!patient.history) {
        patient.history = [{
          date: patient.createdAt || Date.now(),
          type: 'created',
          field: 'Création',
          oldValue: '',
          newValue: 'Patient importé (historique initialisé)'
        }];
        historyFixed++;
      }
    });

    // Ensure history array exists for all appointments (backward compatibility)
    state.appointments.forEach(apt => {
      if (!apt.history) {
        apt.history = [];
      }
    });

    // Save if any fixes were made
    if (historyFixed > 0) {
      console.log(`✅ Historique initialisé pour ${historyFixed} patient(s)`);
      saveDB();
    }

    // Initialize demo data if empty
    if (state.patients.length === 0 && state.docs.length === 0) {
      initDemoData();
    }

    // Log data integrity check
    const patientHistoryCount = state.patients.reduce((total, p) => total + (p.history?.length || 0), 0);
    const appointmentHistoryCount = state.appointments.reduce((total, a) => total + (a.history?.length || 0), 0);
    console.log('📊 Data loaded:', {
      patients: state.patients.length,
      docs: state.docs.length,
      centers: state.centers.length,
      protos: state.protos.length,
      switches: state.switches.length,
      appointments: state.appointments.length,
      tasks: state.tasks?.length || 0,
      prescriptionTemplates: state.prescriptionTemplates?.length || 0,
      shortcuts: state.shortcuts?.length || 0,
      patientHistoryEvents: patientHistoryCount,
      appointmentHistoryEvents: appointmentHistoryCount,
      totalHistoryEvents: patientHistoryCount + appointmentHistoryCount
    });

  } catch (error) {
    console.error('Erreur chargement DB:', error);
    showToast('Erreur de chargement des données', 'error');
  }
}

function saveDB() {
  try {
    const dataStr = JSON.stringify(state);
    const dataSize = new Blob([dataStr]).size;
    const dataSizeMB = (dataSize / (1024 * 1024)).toFixed(2);

    // Check approximate localStorage usage (typical limit is 5-10MB)
    if (dataSize > 4 * 1024 * 1024) { // 4MB warning threshold
      console.warn(`Taille des données importante: ${dataSizeMB}MB`);
    }

    localStorage.setItem(DB_KEY, dataStr);

    // Trigger auto-save if enabled (function defined later)
    if (typeof triggerAutoSave === 'function') {
      triggerAutoSave();
    }
  } catch (error) {
    console.error('Erreur sauvegarde DB:', error);

    // Check if it's a quota exceeded error
    if (error.name === 'QuotaExceededError' || error.code === 22) {
      showToast('⚠️ Espace de stockage insuffisant ! Exportez vos données et supprimez les anciens patients archivés.', 'error');
    } else {
      showToast('Erreur de sauvegarde: ' + (error.message || 'Erreur inconnue'), 'error');
    }
  }
}

function initDemoData() {
  state.docs = [
    { id: generateId(), name: 'Dr. Martin' },
    { id: generateId(), name: 'Dr. Dubois' },
    { id: generateId(), name: 'Dr. Bernard' }
  ];
  
  state.centers = [
    { id: generateId(), name: 'Centre Paris Nord' },
    { id: generateId(), name: 'Centre Lyon Sud' },
    { id: generateId(), name: 'Centre Marseille Est' }
  ];
  
  state.protos = [
    { id: generateId(), name: 'Protocole Standard' },
    { id: generateId(), name: 'Protocole Intensif' },
    { id: generateId(), name: 'Protocole Allégé' }
  ];
  
  saveDB();
}

// ===== Utility Functions =====
function generateId() {
  return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

function byId(id) {
  return document.getElementById(id);
}

function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Auto-format date inputs (JJ/MM/AAAA) with automatic progression
function setupAutoFormatDateInput(input) {
  if (!input) return;

  input.addEventListener('input', function(e) {
    // Remove all non-digit characters
    let value = e.target.value.replace(/\D/g, '');
    let formattedValue = '';

    if (value.length > 0) {
      // Day (max 2 digits)
      formattedValue = value.substring(0, 2);

      if (value.length >= 3) {
        // Add slash and month
        formattedValue += '/' + value.substring(2, 4);

        if (value.length >= 5) {
          // Add slash and year
          formattedValue += '/' + value.substring(4, 8);
        }
      }
    }

    e.target.value = formattedValue;
  });

  // Prevent non-numeric input (except control keys)
  input.addEventListener('keydown', function(e) {
    const allowedKeys = ['Backspace', 'Delete', 'Tab', 'ArrowLeft', 'ArrowRight', 'Home', 'End'];
    if (!allowedKeys.includes(e.key) && !/\d/.test(e.key)) {
      e.preventDefault();
    }
  });

  // Add placeholder with instruction
  if (!input.placeholder || input.placeholder === 'JJ/MM/AAAA') {
    input.placeholder = 'JJMMAAAA (saisie auto)';
  }

  // Add a title for better UX
  input.title = 'Saisissez les chiffres sans "/" - Format automatique JJ/MM/AAAA';
}

// Initialize all date inputs with auto-formatting
function initAutoFormatDateInputs() {
  // Find all inputs with JJ/MM/AAAA pattern
  const dateInputs = document.querySelectorAll('input[pattern="\\d{2}/\\d{2}/\\d{4}"]');
  dateInputs.forEach(input => setupAutoFormatDateInput(input));
}

// Add an event to patient's event history
function addPatientEvent(patientId, eventType, description, metadata = {}) {
  const patient = state.patients.find(p => p.id === patientId);
  if (!patient) return;

  // Initialize events array if it doesn't exist
  if (!patient.events) {
    patient.events = [];
  }

  const event = {
    id: generateId(),
    type: eventType,
    description: description,
    date: Date.now(),
    metadata: metadata
  };

  patient.events.push(event);
  patient.updatedAt = Date.now();
}

// Transform a select into a searchable dropdown
function makeSelectSearchable(selectId, getOptions, getLabelFn, placeholderText = 'Rechercher...') {
  const originalSelect = byId(selectId);
  if (!originalSelect) {
    console.warn(`makeSelectSearchable: select #${selectId} not found`);
    return;
  }

  // If already searchable, check if the setup is still valid
  if (originalSelect.dataset.searchable === 'true') {
    const container = originalSelect.parentNode;
    const hasSearchInput = container && container.querySelector('input[type="text"]');

    // If setup is valid, don't reinitialize
    if (hasSearchInput) return;

    // Otherwise, clean up the corrupted state
    console.warn(`makeSelectSearchable: cleaning corrupted state for #${selectId}`);
    originalSelect.dataset.searchable = 'false';
    originalSelect.style.display = '';
  }

  try {
    // Check if parent exists
    if (!originalSelect.parentNode) {
      console.error(`makeSelectSearchable: select #${selectId} has no parent`);
      return;
    }

    const container = document.createElement('div');
    container.className = 'searchable-select-container';

    const searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.placeholder = placeholderText;
    searchInput.className = originalSelect.className;
    searchInput.autocomplete = 'off';

    const dropdown = document.createElement('div');
    dropdown.className = 'searchable-select-dropdown';

    originalSelect.parentNode.insertBefore(container, originalSelect);
    container.appendChild(searchInput);
    container.appendChild(originalSelect);
    container.appendChild(dropdown);

    function updateDropdown(searchTerm = '') {
      const options = getOptions();
      const filtered = options.filter(opt => {
        const label = getLabelFn(opt);
        return label.toLowerCase().includes(searchTerm.toLowerCase());
      });

      if (filtered.length === 0) {
        dropdown.innerHTML = '<div style="padding: 0.75rem; color: var(--text-muted); text-align: center;">Aucun résultat</div>';
      } else {
        dropdown.innerHTML = filtered.map(opt => {
          const label = getLabelFn(opt);
          return `<div class="searchable-select-option" data-value="${opt.id}">${escapeHtml(label)}</div>`;
        }).join('');
      }

      dropdown.style.display = 'block';
    }

    searchInput.addEventListener('focus', () => {
      updateDropdown(searchInput.value);
    });

    searchInput.addEventListener('input', (e) => {
      updateDropdown(e.target.value);
    });

    dropdown.addEventListener('click', (e) => {
      const option = e.target.closest('.searchable-select-option');
      if (option) {
        const value = option.dataset.value;
        originalSelect.value = value;

        const options = getOptions();
        const selected = options.find(opt => String(opt.id) === String(value));
        if (selected) {
          searchInput.value = getLabelFn(selected);
        }

        dropdown.style.display = 'none';

        // Trigger change event on original select
        originalSelect.dispatchEvent(new Event('change', { bubbles: true }));
      }
    });

    document.addEventListener('click', (e) => {
      if (!container.contains(e.target)) {
        dropdown.style.display = 'none';
      }
    });

    // Set initial value if select has one
    if (originalSelect.value) {
      const options = getOptions();
      const selected = options.find(opt => String(opt.id) === String(originalSelect.value));
      if (selected) {
        searchInput.value = getLabelFn(selected);
      }
    }

    // Watch for programmatic changes to the original select
    const observer = new MutationObserver(() => {
      if (originalSelect.value) {
        const options = getOptions();
        const selected = options.find(opt => String(opt.id) === String(originalSelect.value));
        if (selected) {
          searchInput.value = getLabelFn(selected);
        }
      } else {
        searchInput.value = '';
      }
    });

    observer.observe(originalSelect, { attributes: true, attributeFilter: ['value'] });

    // Only hide and mark as searchable if everything succeeded
    originalSelect.style.display = 'none';
    originalSelect.dataset.searchable = 'true';

  } catch (error) {
    console.error(`makeSelectSearchable: error for #${selectId}:`, error);
  }
}

function syncSearchableSelect(selectId, getOptions, getLabelFn) {
  const originalSelect = byId(selectId);
  if (!originalSelect || originalSelect.dataset.searchable !== 'true') {
    return;
  }

  const container = originalSelect.parentNode;
  if (!container) return;

  const searchInput = container.querySelector('input[type="text"]');
  if (!searchInput) return;

  // Synchronize the search input with the current select value
  if (originalSelect.value) {
    const options = getOptions();
    const selected = options.find(opt => String(opt.id) === String(originalSelect.value));
    if (selected) {
      searchInput.value = getLabelFn(selected);
    } else {
      searchInput.value = '';
    }
  } else {
    searchInput.value = '';
  }
}

function qsEl(selector) {
  return document.querySelector(selector);
}

function showToast(message, type = 'info') {
  const container = byId('toastContainer');
  const toast = document.createElement('div');
  toast.className = `toast ${type} fade-in`;
  toast.innerHTML = `
    ${type === 'success' ? '<svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>' : ''}
    ${type === 'error' ? '<svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>' : ''}
    <span>${message}</span>
  `;
  
  container.appendChild(toast);
  
  setTimeout(() => {
    toast.style.opacity = '0';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

function showModal(show, modalId = 'patientModal') {
  console.log('showModal called', { show, modalId });
  const modal = byId(modalId);
  if (!modal) {
    console.error('Modal not found:', modalId);
    return;
  }
  if (show) {
    modal.classList.add('active');
    // Re-initialize date inputs in this modal when it opens
    const dateInputs = modal.querySelectorAll('input[pattern="\\d{2}/\\d{2}/\\d{4}"]');
    dateInputs.forEach(input => setupAutoFormatDateInput(input));
  } else {
    modal.classList.remove('active');
  }
}

// ===== Patient Functions =====
function fullName(patient) {
  return `${patient.lastName || ''} ${patient.firstName || ''}`.trim();
}

function docName(docId) {
  const doc = state.docs.find(d => d.id === docId);
  return doc ? doc.name : '';
}

function centerName(centerId) {
  const center = state.centers.find(c => c.id === centerId);
  return center ? center.name : '';
}

function protoName(protoId) {
  const proto = state.protos.find(p => p.id === protoId);
  return proto ? proto.name : '';
}

function qScore(patient) {
  let score = 0;
  if (patient.lastName && patient.firstName) score += 30;
  if (patient.dob) score += 15;
  if (patient.email || patient.phone) score += 10;
  if (patient.address) score += 5;
  if (patient.docId) score += 15;
  if (patient.centerId) score += 10;
  if (patient.protoId) score += 10;
  if (patient.ordo) score += 5;
  return Math.min(100, score);
}

// ===== Cycle Management System =====
const CYCLES = {
  1: { name: 'Cycle 1', months: [1, 2, 3, 4], label: 'Janvier - Avril', color: 'var(--info)' },
  2: { name: 'Cycle 2', months: [5, 6, 7, 8], label: 'Mai - Août', color: 'var(--success)' },
  3: { name: 'Cycle 3', months: [9, 10, 11, 12], label: 'Septembre - Décembre', color: 'var(--warning)' }
};

function getCurrentCycle() {
  const month = new Date().getMonth() + 1;
  const year = new Date().getFullYear();
  
  for (const [cycleNum, cycleInfo] of Object.entries(CYCLES)) {
    if (cycleInfo.months.includes(month)) {
      return { cycle: parseInt(cycleNum), year, ...cycleInfo };
    }
  }
  return null;
}

function getCycleFromDate(dateStr) {
  if (!dateStr) return null;
  
  let date;
  // Support multiple date formats
  if (dateStr.includes('/')) {
    const parts = dateStr.split('/');
    if (parts.length === 3) {
      date = new Date(parts[2], parts[1] - 1, parts[0]);
    }
  } else if (dateStr.includes('-')) {
    date = new Date(dateStr);
  } else {
    return null;
  }
  
  if (isNaN(date)) return null;
  
  const month = date.getMonth() + 1;
  const year = date.getFullYear();
  
  for (const [cycleNum, cycleInfo] of Object.entries(CYCLES)) {
    if (cycleInfo.months.includes(month)) {
      const cycle = parseInt(cycleNum);
      return { 
        id: `C${cycle}-${year}`,
        cycle: cycle, 
        year: year, 
        ...cycleInfo, 
        date: date 
      };
    }
  }
  return null;
}

function getCycleInfo(cycleNum, year) {
  const cycle = CYCLES[cycleNum];
  if (!cycle) return null;
  
  const startMonth = cycle.months[0] - 1;
  const endMonth = cycle.months[cycle.months.length - 1] - 1;
  const startDate = new Date(year, startMonth, 1);
  const endDate = new Date(year, endMonth + 1, 0);
  
  return {
    cycle: cycleNum,
    year,
    ...cycle,
    startDate,
    endDate,
    label: `${cycle.label} ${year}`
  };
}

function formatDateFR(date) {
  if (!date) return '';
  const d = new Date(date);
  if (isNaN(d)) return '';
  const day = String(d.getDate()).padStart(2, '0');
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const year = d.getFullYear();
  return `${day}/${month}/${year}`;
}

function parseDateFR(dateStr) {
  if (!dateStr) return null;
  const parts = dateStr.split('/');
  if (parts.length !== 3) return null;
  const date = new Date(parts[2], parts[1] - 1, parts[0]);
  return isNaN(date) ? null : date;
}

function daysUntilRenewal(renewalDate) {
  if (!renewalDate) return null;
  
  const endDate = parseDateFR(renewalDate) || new Date(renewalDate);
  if (isNaN(endDate)) return null;
  
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  endDate.setHours(0, 0, 0, 0);
  
  const diffTime = endDate - today;
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  
  return diffDays;
}

function getOrdonnanceStatus(renewalDate) {
  const days = daysUntilRenewal(renewalDate);
  if (days === null) return { status: 'invalide', label: 'Date invalide', color: 'var(--danger)' };
  if (days < 0) return { status: 'expiree', label: 'Expirée', color: 'var(--danger)', days: Math.abs(days) };
  if (days === 0) return { status: 'aujourdhui', label: "Expire aujourd'hui", color: 'var(--danger)', days: 0 };
  if (days <= 7) return { status: 'urgent', label: `${days} jour${days > 1 ? 's' : ''}`, color: 'var(--danger)', days };
  if (days <= 30) return { status: 'proche', label: `${days} jours`, color: 'var(--warning)', days };
  if (days <= 60) return { status: 'moyen', label: `${days} jours`, color: 'var(--info)', days };
  return { status: 'ok', label: `${days} jours`, color: 'var(--success)', days };
}

function formatCycleLabel(renewalDate) {
  const cycleInfo = getCycleFromDate(renewalDate);
  if (!cycleInfo) return renewalDate || '—';
  
  return `${cycleInfo.name} ${cycleInfo.year} (${cycleInfo.label})`;
}

function getPatientsByCycle(cycle, year) {
  return state.patients.filter(p => {
    const cycleInfo = getCycleFromDate(p.renewalDate);
    if (!cycleInfo || cycleInfo.cycle !== cycle || cycleInfo.year !== year) return false;

    // Exclure les patients archivés dont la date de renouvellement est ultérieure à la date d'archivage
    if ((p.status === 'temporary_pause' || p.status === 'permanent_pause') && p.pausedAt) {
      const renewalDate = parseDate(p.renewalDate);
      const pausedDate = new Date(p.pausedAt);
      if (renewalDate && renewalDate > pausedDate) {
        return false;
      }
    }

    return true;
  });
}

function getUpcomingRenewals(daysAhead = 30) {
  return state.patients.filter(p => {
    const days = daysUntilRenewal(p.renewalDate);
    if (days === null || days < 0 || days > daysAhead) return false;

    // Exclure les patients archivés dont la date de renouvellement est ultérieure à la date d'archivage
    if ((p.status === 'temporary_pause' || p.status === 'permanent_pause') && p.pausedAt) {
      const renewalDate = parseDate(p.renewalDate);
      const pausedDate = new Date(p.pausedAt);
      if (renewalDate && renewalDate > pausedDate) {
        return false;
      }
    }

    return true;
  }).sort((a, b) => {
    const daysA = daysUntilRenewal(a.renewalDate);
    const daysB = daysUntilRenewal(b.renewalDate);
    return daysA - daysB;
  });
}

function getExpiredOrdonnances() {
  return state.patients.filter(p => {
    const days = daysUntilRenewal(p.renewalDate);
    if (days === null || days >= 0) return false;

    // Exclure les patients archivés dont la date de renouvellement est ultérieure à la date d'archivage
    if ((p.status === 'temporary_pause' || p.status === 'permanent_pause') && p.pausedAt) {
      const renewalDate = parseDate(p.renewalDate);
      const pausedDate = new Date(p.pausedAt);
      if (renewalDate && renewalDate > pausedDate) {
        return false;
      }
    }

    return true;
  }).sort((a, b) => {
    const daysA = daysUntilRenewal(a.renewalDate);
    const daysB = daysUntilRenewal(b.renewalDate);
    return daysB - daysA;
  });
}

function suggestNextRenewalDate(currentDate) {
  const cycleInfo = currentDate ? getCycleFromDate(currentDate) : getCurrentCycle();
  if (!cycleInfo) return formatDateFR(new Date());
  
  // Add 4 months to get next cycle
  const current = parseDateFR(currentDate) || new Date();
  const next = new Date(current);
  next.setMonth(next.getMonth() + 4);
  
  return formatDateFR(next);
}

// ===== View Management =====
function switchView(viewName) {
  // Hide all views
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  
  // Show selected view
  const view = byId(viewName);
  if (view) {
    view.classList.add('active', 'slide-up');
  }
  
  // Update nav
  document.querySelectorAll('.nav-item').forEach(btn => {
    btn.classList.remove('active');
    if (btn.dataset.view === viewName) {
      btn.classList.add('active');
    }
  });
  
  // Render view content
  if (viewName === 'dashboard') renderDashboard();
  if (viewName === 'patients') renderPatients();
  if (viewName === 'ordos') renderOrdos();
  if (viewName === 'switches') renderSwitches();
  if (viewName === 'appointments') {
    renderAppointments();
    updateAppointmentStats();
  }
  if (viewName === 'tasks') renderTasks();
  if (viewName === 'catalogs') renderCatalogs();
  if (viewName === 'report') renderStats();
}

// ===== Render Functions =====
function render() {
  renderDashboard();
  renderPatients();
  renderArchivedPatients();
  renderCatalogs();
  updateAppointmentStats();
  updateCounters();
}

function renderDashboard() {
  const now = new Date();
  const currentMonth = now.getMonth();
  const currentYear = now.getFullYear();

  // Filter active patients only
  const activePatients = state.patients.filter(p => !p.status || p.status === 'active');

  // ===== KPIs Principaux =====
  // Utiliser getUpcomingRenewals qui gère déjà le filtrage des patients archivés
  const renews30 = getUpcomingRenewals(30);
  
  const avgScore = activePatients.length > 0 
    ? Math.round(activePatients.reduce((sum, p) => sum + qScore(p), 0) / activePatients.length)
    : 0;
  
  byId('kpiPatients').textContent = activePatients.length;
  byId('kpiRenews').textContent = renews30.length;
  byId('kpiScore').textContent = avgScore + '%';
  byId('kpiProtos').textContent = state.protos.length;
  
  // ===== Message de bienvenue dynamique =====
  const hour = now.getHours();
  let greeting = 'Bonne journée';
  if (hour < 12) greeting = 'Bonjour';
  else if (hour < 18) greeting = 'Bon après-midi';
  else greeting = 'Bonsoir';
  
  const monthNames = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 
                      'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
  const welcomeEl = byId('dashboardWelcome');
  if (welcomeEl) {
    welcomeEl.textContent = `${greeting} ! ${monthNames[currentMonth]} ${currentYear} - Voici votre vue d'ensemble`;
  }
  
  // ===== Alertes urgentes =====
  renderDashboardAlerts(renews30);

  // ===== Calendrier mensuel =====
  renderDashboardCalendar();
  setupCalendarNavigation();
  renderCalendarToCall();
  setupCalendarEventClicks();

  // ===== Switchs à venir (60 jours) =====
  renderDashboardSwitches();
  
  // ===== Ordonnances à renouveler =====
  renderDashboardRenewals(renews30);
  
  // ===== Graphique des protocoles =====
  renderDashboardProtocolsChart();
}

// Toggle notification panel
function toggleNotifications() {
  const panel = byId('notificationPanel');
  if (!panel) return;

  if (panel.style.display === 'none') {
    panel.style.display = 'block';
    renderNotifications();
  } else {
    panel.style.display = 'none';
  }
}

// Render notifications
function renderNotifications() {
  const notificationList = byId('notificationList');
  if (!notificationList) return;

  const now = new Date();

  // Calculer les renouvellements dans les 30 jours
  const renews30 = state.patients.filter(p => {
    const days = daysUntilRenewal(p.renewalDate);
    return days !== null && days <= 30;
  });

  // Organiser par catégories
  const categories = {
    urgent: [],
    important: [],
    aVenir: []
  };

  // 1. Ordonnances critiques (≤7 jours) - URGENT
  const criticalRenewals = renews30.filter(p => {
    const days = daysUntilRenewal(p.renewalDate);
    return days !== null && days <= 7;
  });

  criticalRenewals.forEach(p => {
    const days = daysUntilRenewal(p.renewalDate);
    categories.urgent.push({
      icon: '🚨',
      patient: fullName(p),
      info: `${days}j`,
      action: () => { toggleNotifications(); viewPatientDetails(p.id); }
    });
  });

  // 2. Switchs en retard - URGENT
  const lateSwitches = (state.switches || []).filter(sw => {
    if (sw.status !== 'planned') return false;
    const swDate = parseDate(sw.switchDate);
    return swDate && swDate < now;
  });

  lateSwitches.forEach(sw => {
    const patient = state.patients.find(p => p.id === sw.patientId);
    if (patient) {
      categories.urgent.push({
        icon: '⚠️',
        patient: fullName(patient),
        info: sw.switchDate,
        action: () => { toggleNotifications(); switchView('switches'); }
      });
    }
  });

  // 3. Rendez-vous aujourd'hui - IMPORTANT
  const todayAppointments = (state.appointments || []).filter(a => {
    if (a.status !== 'active' || !a.exactDate) return false;
    const parts = a.exactDate.split('/');
    if (parts.length !== 3) return false;
    const aptDate = new Date(parseInt(parts[2], 10), parseInt(parts[1], 10) - 1, parseInt(parts[0], 10));
    return aptDate.toDateString() === now.toDateString();
  });

  todayAppointments.forEach(a => {
    const patient = state.patients.find(p => p.id === a.patientId);
    if (patient) {
      const timeStr = a.time ? a.time : '?';
      categories.important.push({
        icon: '📅',
        patient: fullName(patient),
        info: timeStr,
        action: () => { toggleNotifications(); switchView('appointments'); }
      });
    }
  });

  // 4. Switchs planifiés (à venir dans les 30 jours) - À VENIR
  const upcomingSwitches = (state.switches || []).filter(sw => {
    if (sw.status !== 'planned') return false;
    const swDate = parseDate(sw.switchDate);
    if (!swDate) return false;
    const diffTime = swDate - now;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    return diffDays >= 0 && diffDays <= 30;
  });

  upcomingSwitches.forEach(sw => {
    const patient = state.patients.find(p => p.id === sw.patientId);
    if (patient) {
      const swDate = parseDate(sw.switchDate);
      const diffDays = Math.ceil((swDate - now) / (1000 * 60 * 60 * 24));
      categories.aVenir.push({
        icon: '🔄',
        patient: fullName(patient),
        info: `${diffDays}j`,
        action: () => { toggleNotifications(); switchView('switches'); }
      });
    }
  });

  // 5. Ordonnances à renouveler (8-30 jours) - À VENIR
  const upcomingRenewals = renews30.filter(p => {
    const days = daysUntilRenewal(p.renewalDate);
    return days !== null && days > 7 && days <= 30;
  });

  upcomingRenewals.forEach(p => {
    const days = daysUntilRenewal(p.renewalDate);
    categories.aVenir.push({
      icon: '📋',
      patient: fullName(p),
      info: `${days}j`,
      action: () => { toggleNotifications(); viewPatientDetails(p.id); }
    });
  });

  // Compter le total
  const totalCount = categories.urgent.length + categories.important.length + categories.aVenir.length;

  // Update badge
  updateNotificationBadge(totalCount);

  // Affichage des notifications
  if (totalCount === 0) {
    notificationList.innerHTML = `
      <div style="padding: 2rem; text-align: center; color: var(--text-muted);">
        <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">✨</div>
        <div style="font-size: 1rem; font-weight: 600;">Aucune notification</div>
        <div style="font-size: 0.85rem; margin-top: 0.25rem;">Vous êtes à jour !</div>
      </div>
    `;
    return;
  }

  let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; padding: 1rem;">';

  // Fonction pour créer une colonne de catégorie
  const createCategory = (title, items, color, bgColor) => {
    if (items.length === 0) return '';

    return `
      <div style="background: ${bgColor}; border-radius: var(--radius-md); overflow: hidden; border: 1px solid ${color};">
        <div style="background: ${color}; color: white; padding: 0.5rem 0.75rem; font-weight: 700; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center;">
          <span>${title}</span>
          <span style="background: rgba(255,255,255,0.3); padding: 0.125rem 0.5rem; border-radius: 10px; font-size: 0.8rem;">${items.length}</span>
        </div>
        <div style="padding: 0.5rem;">
          ${items.map(item => `
            <div onclick="(${item.action.toString()})()"
                 style="background: white; padding: 0.5rem; margin-bottom: 0.5rem; border-radius: var(--radius-sm); cursor: pointer; transition: all 0.2s; border-left: 3px solid ${color}; display: flex; align-items: center; gap: 0.5rem;"
                 onmouseover="this.style.transform='translateX(3px)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'"
                 onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='none'">
              <span style="font-size: 1.25rem; flex-shrink: 0;">${item.icon}</span>
              <div style="flex: 1; min-width: 0;">
                <div style="font-weight: 600; font-size: 0.85rem; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(item.patient)}</div>
                <div style="font-size: 0.75rem; color: var(--text-secondary);">${escapeHtml(item.info)}</div>
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  };

  // Ajouter les catégories
  html += createCategory('🚨 Urgent', categories.urgent, '#ef4444', '#fee2e2');
  html += createCategory('📌 Aujourd\'hui', categories.important, '#3b82f6', '#dbeafe');
  html += createCategory('📅 À venir', categories.aVenir, '#10b981', '#d1fae5');

  html += '</div>';
  notificationList.innerHTML = html;
}

// Update notification badge
function updateNotificationBadge(count) {
  const badge = byId('notificationBadge');
  if (!badge) return;

  if (count > 0) {
    badge.textContent = count > 99 ? '99+' : count;
    badge.style.display = 'flex';
  } else {
    badge.style.display = 'none';
  }
}

// Deprecated function - kept for compatibility, now handled by notifications
function renderDashboardAlerts(renews30) {
  // This function is no longer used as alerts are now in the notification panel
  // Update notification badge instead
  const now = new Date();
  let alertCount = 0;

  // Count critical items
  const criticalRenewals = renews30.filter(p => {
    const days = daysUntilRenewal(p.renewalDate);
    return days !== null && days <= 7;
  });
  alertCount += criticalRenewals.length;

  const lateSwitches = (state.switches || []).filter(sw => {
    if (sw.status !== 'planned') return false;
    const swDate = parseDate(sw.switchDate);
    return swDate && swDate < now;
  });
  alertCount += lateSwitches.length;

  const todayAppointments = (state.appointments || []).filter(a => {
    if (a.status !== 'active' || !a.exactDate) return false;
    const parts = a.exactDate.split('/');
    if (parts.length !== 3) return false;
    const aptDate = new Date(parseInt(parts[2], 10), parseInt(parts[1], 10) - 1, parseInt(parts[0], 10));
    return aptDate.toDateString() === now.toDateString();
  });
  alertCount += todayAppointments.length;

  // Add upcoming items
  const upcomingSwitches = (state.switches || []).filter(sw => {
    if (sw.status !== 'planned') return false;
    const swDate = parseDate(sw.switchDate);
    if (!swDate) return false;
    const diffDays = Math.ceil((swDate - now) / (1000 * 60 * 60 * 24));
    return diffDays >= 0 && diffDays <= 30;
  });
  alertCount += upcomingSwitches.length;

  const upcomingRenewals = renews30.filter(p => {
    const days = daysUntilRenewal(p.renewalDate);
    return days !== null && days > 7 && days <= 30;
  });
  alertCount += upcomingRenewals.length;

  updateNotificationBadge(alertCount);
}

// ===== Shortcuts Management =====

// Toggle shortcuts panel
function toggleShortcuts() {
  const panel = byId('shortcutsPanel');
  if (!panel) return;

  if (panel.style.display === 'none') {
    panel.style.display = 'block';
    renderShortcuts();
  } else {
    panel.style.display = 'none';
  }
}

// Render shortcuts list
function renderShortcuts() {
  const shortcutsList = byId('shortcutsList');
  if (!shortcutsList) return;

  if (!state.shortcuts || state.shortcuts.length === 0) {
    shortcutsList.innerHTML = `
      <div style="padding: 2rem; text-align: center; color: var(--text-muted);">
        <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">📌</div>
        <div style="font-size: 1rem; font-weight: 600;">Aucun raccourci</div>
        <div style="font-size: 0.85rem; margin-top: 0.25rem;">Cliquez sur "Gérer" pour ajouter vos liens favoris</div>
      </div>
    `;
    return;
  }

  shortcutsList.innerHTML = `
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.75rem;">
      ${state.shortcuts.map(shortcut => `
        <a href="${escapeHtml(shortcut.url)}" target="_blank" rel="noopener noreferrer"
           style="background: white; padding: 1rem; border-radius: var(--radius-md); border: 2px solid var(--border); text-decoration: none; color: var(--text-primary); transition: all 0.2s; display: flex; align-items: center; gap: 0.75rem; cursor: pointer;"
           onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'; this.style.borderColor='var(--primary)'"
           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'; this.style.borderColor='var(--border)'">
          <span style="font-size: 1.75rem; flex-shrink: 0;">${shortcut.icon || '🔗'}</span>
          <div style="flex: 1; min-width: 0;">
            <div style="font-weight: 600; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(shortcut.name)}</div>
            <div style="font-size: 0.75rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(new URL(shortcut.url).hostname)}</div>
          </div>
          <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20" style="flex-shrink: 0; opacity: 0.5;">
            <path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z"></path>
            <path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z"></path>
          </svg>
        </a>
      `).join('')}
    </div>
  `;
}

// Open shortcut manager modal
function openShortcutManager() {
  showModal(true, 'shortcutManagerModal');
  renderShortcutsManager();
}

// Render shortcuts in manager modal
function renderShortcutsManager() {
  const list = byId('shortcutsManagerList');
  if (!list) return;

  if (!state.shortcuts || state.shortcuts.length === 0) {
    list.innerHTML = `
      <div style="padding: 2rem; text-align: center; color: var(--text-muted); background: var(--bg-tertiary); border-radius: var(--radius-md);">
        <div style="font-size: 2rem; margin-bottom: 0.5rem;">📌</div>
        <div style="font-size: 0.9rem;">Aucun raccourci pour le moment</div>
      </div>
    `;
    return;
  }

  list.innerHTML = state.shortcuts.map(shortcut => `
    <div style="background: white; border: 1px solid var(--border); border-radius: var(--radius-md); padding: 1rem; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 1rem;">
      <span style="font-size: 1.5rem; flex-shrink: 0;">${shortcut.icon || '🔗'}</span>
      <div style="flex: 1; min-width: 0;">
        <div style="font-weight: 600; font-size: 0.95rem; margin-bottom: 0.25rem;">${escapeHtml(shortcut.name)}</div>
        <div style="font-size: 0.8rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(shortcut.url)}</div>
      </div>
      <button onclick="deleteShortcut('${shortcut.id}')" class="btn" style="background: #fee2e2; color: #dc2626; padding: 0.5rem; flex-shrink: 0;" title="Supprimer">
        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
        </svg>
      </button>
    </div>
  `).join('');
}

// Add new shortcut
function addShortcut() {
  const name = byId('shortcutName').value.trim();
  const url = byId('shortcutUrl').value.trim();
  const icon = byId('shortcutIcon').value.trim();

  // Validation
  if (!name) {
    showToast('Veuillez entrer un nom pour le raccourci', 'error');
    return;
  }

  if (!url) {
    showToast('Veuillez entrer une URL', 'error');
    return;
  }

  // Validate URL format
  try {
    new URL(url);
  } catch (e) {
    showToast('URL invalide. Assurez-vous qu\'elle commence par http:// ou https://', 'error');
    return;
  }

  // Initialize shortcuts array if needed
  if (!state.shortcuts) {
    state.shortcuts = [];
  }

  // Create shortcut
  const shortcut = {
    id: generateId(),
    name: name,
    url: url,
    icon: icon || '🔗',
    createdAt: Date.now()
  };

  state.shortcuts.push(shortcut);
  saveDB();

  // Clear form
  byId('shortcutName').value = '';
  byId('shortcutUrl').value = '';
  byId('shortcutIcon').value = '';

  // Refresh list
  renderShortcutsManager();
  renderShortcuts();

  showToast('Raccourci ajouté avec succès !', 'success');
}

// Delete shortcut
function deleteShortcut(shortcutId) {
  if (!confirm('Êtes-vous sûr de vouloir supprimer ce raccourci ?')) {
    return;
  }

  state.shortcuts = state.shortcuts.filter(s => s.id !== shortcutId);
  saveDB();

  renderShortcutsManager();
  renderShortcuts();

  showToast('Raccourci supprimé', 'success');
}

function renderDashboardAppointments() {
  const dashboardList = byId('dashboardAppointmentsList');
  const dashboardCount = byId('dashboardAppointmentsCount');
  
  if (!dashboardList) return;
  
  if (!state.appointments || state.appointments.length === 0) {
    dashboardList.innerHTML = '<p class="text-muted text-center" style="padding: 2rem;">Aucun suivi prévu ce mois</p>';
    if (dashboardCount) dashboardCount.textContent = '0';
    return;
  }
  
  const now = new Date();
  const currentYear = now.getFullYear();
  const currentMonth = now.getMonth();
  
  // Get appointments for this month
  const thisMonthAppointments = state.appointments.filter(a => {
    if (a.status !== 'active') return false;
    
    if (a.exactDate) {
      const parts = a.exactDate.split('/');
      if (parts.length === 3) {
        const month = parseInt(parts[1], 10) - 1;
        const year = parseInt(parts[2], 10);
        return month === currentMonth && year === currentYear;
      }
    } else if (a.month) {
      const parts = a.month.split('/');
      if (parts.length === 2) {
        const aptMonth = parseInt(parts[0], 10) - 1;
        const aptYear = parseInt(parts[1], 10);
        return aptMonth === currentMonth && aptYear === currentYear;
      }
    }
    return false;
  });
  
  // Sort by date
  thisMonthAppointments.sort((a, b) => {
    if (a.exactDate && b.exactDate) {
      const partsA = a.exactDate.split('/');
      const partsB = b.exactDate.split('/');
      const dateA = new Date(parseInt(partsA[2], 10), parseInt(partsA[1], 10) - 1, parseInt(partsA[0], 10));
      const dateB = new Date(parseInt(partsB[2], 10), parseInt(partsB[1], 10) - 1, parseInt(partsB[0], 10));
      return dateA - dateB;
    }
    if (a.exactDate && !b.exactDate) return -1;
    if (!a.exactDate && b.exactDate) return 1;
    return 0;
  });
  
  if (dashboardCount) dashboardCount.textContent = thisMonthAppointments.length;
  
  if (thisMonthAppointments.length > 0) {
    dashboardList.innerHTML = thisMonthAppointments.map(apt => {
      const patient = state.patients.find(p => p.id === apt.patientId);
      if (!patient) return '';
      
      let dateDisplay, diffDays = null, bgColor, borderColor;
      
      if (apt.exactDate) {
        const parts = apt.exactDate.split('/');
        const aptDate = new Date(parseInt(parts[2], 10), parseInt(parts[1], 10) - 1, parseInt(parts[0], 10));
        diffDays = Math.ceil((aptDate - now) / (1000 * 60 * 60 * 24));
        dateDisplay = apt.exactDate + (apt.time ? ` à ${apt.time}` : '');

        if (diffDays < 0) {
          bgColor = '#fee2e2';
          borderColor = '#ef4444';
        } else if (diffDays === 0) {
          bgColor = '#fef3c7';
          borderColor = '#f59e0b';
        } else if (diffDays <= 7) {
          bgColor = '#dbeafe';
          borderColor = '#3b82f6';
        } else {
          bgColor = '#f0fdf4';
          borderColor = '#10b981';
        }
      } else {
        dateDisplay = apt.month;
        bgColor = '#fef3c7';
        borderColor = '#f59e0b';
      }
      
      return `
        <div style="padding: 1rem; border-bottom: 1px solid var(--border-light); border-left: 3px solid ${borderColor}; background: ${bgColor}; transition: var(--transition);" 
             onmouseover="this.style.transform='translateX(5px)'"
             onmouseout="this.style.transform='translateX(0)'">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
            <div style="font-weight: 700; font-size: 1rem;">${fullName(patient)}</div>
            ${diffDays !== null && diffDays === 0 ? '<span style="background: #f59e0b; color: white; padding: 0.25rem 0.5rem; border-radius: var(--radius); font-size: 0.75rem; font-weight: 700;">AUJOURD\'HUI</span>' : 
              diffDays !== null && diffDays < 0 ? '<span style="background: #ef4444; color: white; padding: 0.25rem 0.5rem; border-radius: var(--radius); font-size: 0.75rem; font-weight: 700;">EN RETARD</span>' : 
              diffDays !== null && diffDays <= 7 ? '<span style="background: #3b82f6; color: white; padding: 0.25rem 0.5rem; border-radius: var(--radius); font-size: 0.75rem; font-weight: 700;">CETTE SEMAINE</span>' : ''}
          </div>
          <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.75rem;">
            <span>${apt.exactDate ? '📅' : '📞'}</span>
            <span>${dateDisplay}</span>
            ${apt.type ? `<span>•</span><span>${apt.type}</span>` : ''}
            ${apt.notes ? `<span>•</span><span style="font-style: italic;">${apt.notes}</span>` : ''}
          </div>
          <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
            <button class="btn btn-sm btn-success" data-action="validateAppointment" data-appointment-id="${apt.id}" style="flex: 1; padding: 0.4rem 0.75rem; font-size: 0.85rem;" title="Valider ce rendez-vous">
              <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20" style="margin-right: 0.25rem;"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
              Valider
            </button>
            <button class="btn btn-sm btn-primary" data-action="scheduleNext" data-patient-id="${patient.id}" data-current-apt-id="${apt.id}" style="flex: 1; padding: 0.4rem 0.75rem; font-size: 0.85rem;" title="Programmer le suivant">
              <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20" style="margin-right: 0.25rem;"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd"></path></svg>
              Programmer
            </button>
          </div>
        </div>
      `;
    }).join('');
  } else {
    dashboardList.innerHTML = '<p class="text-muted text-center" style="padding: 2rem;">Aucun suivi prévu ce mois</p>';
  }
}

function validateAppointment(appointmentId) {
  const appointment = state.appointments.find(a => a.id === appointmentId);
  if (!appointment) {
    showToast('Rendez-vous introuvable', 'error');
    return;
  }
  
  const patient = state.patients.find(p => p.id === appointment.patientId);
  if (!patient) {
    showToast('Patient introuvable', 'error');
    return;
  }
  
  // Ajouter à l'historique si disponible
  if (!appointment.history) {
    appointment.history = [];
  }
  
  appointment.history.push({
    date: new Date().toISOString(),
    action: 'completed',
    note: `Rendez-vous validé le ${new Date().toLocaleDateString('fr-FR')}`
  });
  
  // Marquer comme terminé
  appointment.status = 'completed';
  appointment.completedAt = Date.now();

  // Add event to patient history
  const dateStr = appointment.exactDate || appointment.month || 'date inconnue';
  const timeStr = appointment.time ? ` à ${appointment.time}` : '';
  addPatientEvent(appointment.patientId, 'appointment_completed', `Rendez-vous effectué (${dateStr}${timeStr})`, {
    appointmentId: appointmentId,
    date: appointment.exactDate || appointment.month,
    time: appointment.time || null,
    completedAt: Date.now()
  });

  saveDB();
  render();

  showToast(`✅ Rendez-vous validé pour ${fullName(patient)}`, 'success');
}

function scheduleNextAppointment(patientId, currentAptId) {
  const patient = state.patients.find(p => p.id === patientId);
  if (!patient) {
    showToast('Patient introuvable', 'error');
    return;
  }
  
  const currentApt = state.appointments.find(a => a.id === currentAptId);
  
  // Create modal for scheduling next appointment
  const existingModal = byId('scheduleNextModal');
  if (existingModal) existingModal.remove();
  
  const modal = document.createElement('div');
  modal.id = 'scheduleNextModal';
  modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 99999;';
  
  // Calculate suggested date (1 month from current apt date or today)
  let suggestedDate = new Date();
  if (currentApt && currentApt.exactDate) {
    const parts = currentApt.exactDate.split('/');
    if (parts.length === 3) {
      const aptDate = new Date(parseInt(parts[2], 10), parseInt(parts[1], 10) - 1, parseInt(parts[0], 10));
      suggestedDate = new Date(aptDate);
      suggestedDate.setMonth(suggestedDate.getMonth() + 1); // Add 1 month
    }
  } else {
    suggestedDate.setMonth(suggestedDate.getMonth() + 1); // Add 1 month from today
  }
  
  const suggestedDateStr = suggestedDate.toISOString().split('T')[0];
  
  modal.innerHTML = `
    <div style="background: var(--bg-primary); border-radius: var(--radius-lg); max-width: 550px; width: 90%; box-shadow: var(--shadow-xl);">
      <div style="padding: 1.5rem;">
        <h3 style="margin-bottom: 1rem; color: var(--primary); display: flex; align-items: center; gap: 0.5rem;">
          <span style="font-size: 1.5rem;">📅</span>
          Programmer le prochain rendez-vous
        </h3>
        <p style="margin-bottom: 1.5rem; color: var(--text-secondary);">
          <strong>${fullName(patient)}</strong>
        </p>
        
        <div style="display: flex; flex-direction: column; gap: 1rem;">
          <div>
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">
              Type de rendez-vous
            </label>
            <select id="nextAptType" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-primary); color: var(--text-primary);">
              <option value="Suivi">Suivi</option>
              <option value="Consultation">Consultation</option>
              <option value="Renouvellement">Renouvellement</option>
              <option value="Bilan">Bilan</option>
              <option value="Autre">Autre</option>
            </select>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div>
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">
                <input type="radio" name="dateType" value="exact" checked style="margin-right: 0.5rem;">
                Date exacte
              </label>
              <input type="date" id="nextAptExactDate" value="${suggestedDateStr}" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-primary); color: var(--text-primary);">
            </div>

            <div>
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">
                <input type="radio" name="dateType" value="month" style="margin-right: 0.5rem;">
                Mois uniquement
              </label>
              <input type="month" id="nextAptMonth" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-primary); color: var(--text-primary);">
            </div>
          </div>

          <div>
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">
              Heure (optionnel)
            </label>
            <input type="time" id="nextAptTime" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-primary); color: var(--text-primary);">
          </div>

          <div>
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">
              Notes (optionnel)
            </label>
            <textarea id="nextAptNotes" rows="2" placeholder="Ex: À jeun, Apporter les résultats..." style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-primary); color: var(--text-primary); resize: vertical;"></textarea>
          </div>
        </div>
      </div>
      
      <div style="padding: 0 1.5rem 1.5rem; display: flex; gap: 0.5rem; justify-content: flex-end;">
        <button class="btn btn-secondary" id="btnCancelNextApt">Annuler</button>
        <button class="btn btn-primary" id="btnConfirmNextApt">
          📅 Programmer
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Enable/disable inputs based on radio selection
  const exactRadio = modal.querySelector('input[name="dateType"][value="exact"]');
  const monthRadio = modal.querySelector('input[name="dateType"][value="month"]');
  const exactDateInput = byId('nextAptExactDate');
  const monthInput = byId('nextAptMonth');
  
  function updateInputs() {
    if (exactRadio.checked) {
      exactDateInput.disabled = false;
      monthInput.disabled = true;
      exactDateInput.style.opacity = '1';
      monthInput.style.opacity = '0.5';
    } else {
      exactDateInput.disabled = true;
      monthInput.disabled = false;
      exactDateInput.style.opacity = '0.5';
      monthInput.style.opacity = '1';
    }
  }
  
  exactRadio.addEventListener('change', updateInputs);
  monthRadio.addEventListener('change', updateInputs);
  updateInputs();
  
  // Event listeners
  byId('btnCancelNextApt').addEventListener('click', () => modal.remove());
  
  byId('btnConfirmNextApt').addEventListener('click', () => {
    const type = byId('nextAptType').value;
    const notes = byId('nextAptNotes').value.trim();
    const time = byId('nextAptTime').value.trim() || null;

    let exactDate = null;
    let month = null;

    if (exactRadio.checked) {
      const dateValue = exactDateInput.value;
      if (!dateValue) {
        showToast('Veuillez sélectionner une date', 'warning');
        exactDateInput.focus();
        return;
      }
      // Convert to DD/MM/YYYY
      const date = new Date(dateValue);
      exactDate = `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}/${date.getFullYear()}`;
    } else {
      const monthValue = monthInput.value;
      if (!monthValue) {
        showToast('Veuillez sélectionner un mois', 'warning');
        monthInput.focus();
        return;
      }
      // Convert YYYY-MM to MM/YYYY
      const parts = monthValue.split('-');
      month = `${parts[1]}/${parts[0]}`;
    }

    // Create new appointment
    const newApt = {
      id: `id_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      patientId: patientId,
      exactDate: exactDate,
      month: month,
      time: time,
      type: type,
      notes: notes,
      status: 'active',
      history: [],
      createdAt: Date.now(),
      updatedAt: Date.now()
    };
    
    state.appointments.push(newApt);

    // Add event to patient history
    const dateStr = exactDate || month;
    const timeStr = time ? ` à ${time}` : '';
    addPatientEvent(patientId, 'appointment_created', `Rendez-vous planifié pour le ${dateStr}${timeStr}`, {
      appointmentId: newApt.id,
      date: exactDate || month,
      time: time,
      notes: notes
    });

    saveDB();
    render();
    modal.remove();

    showToast(`✅ Rendez-vous programmé pour ${fullName(patient)}`, 'success');
  });
  
  // Close on background click
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.remove();
    }
  });
  
  // Close on Escape
  const escHandler = (e) => {
    if (e.key === 'Escape') {
      modal.remove();
      document.removeEventListener('keydown', escHandler);
    }
  };
  document.addEventListener('keydown', escHandler);
}

function renderDashboardSwitches() {
  const container = byId('dashboardSwitchesList');
  const countEl = byId('dashboardSwitchesCount');
  
  if (!container) return;
  
  if (!state.switches || state.switches.length === 0) {
    container.innerHTML = '<p class="text-muted text-center" style="padding: 2rem;">Aucun switch planifié</p>';
    if (countEl) countEl.textContent = '0';
    return;
  }
  
  const now = new Date();
  const in60Days = new Date(now.getTime() + 60 * 24 * 60 * 60 * 1000);
  
  // Get upcoming switches (60 days)
  const upcomingSwitches = state.switches.filter(sw => {
    if (sw.status !== 'planned') return false;
    const swDate = parseDate(sw.switchDate);
    return swDate && swDate >= now && swDate <= in60Days;
  }).sort((a, b) => {
    const dateA = parseDate(a.switchDate);
    const dateB = parseDate(b.switchDate);
    return dateA - dateB;
  });
  
  if (countEl) countEl.textContent = upcomingSwitches.length;
  
  if (upcomingSwitches.length > 0) {
    container.innerHTML = upcomingSwitches.map(sw => {
      const patient = state.patients.find(p => p.id === sw.patientId);
      if (!patient) return '';
      
      const swDate = parseDate(sw.switchDate);
      const diffDays = Math.ceil((swDate - now) / (1000 * 60 * 60 * 24));
      
      let bgColor, borderColor;
      if (diffDays <= 7) {
        bgColor = '#fef3c7';
        borderColor = '#f59e0b';
      } else if (diffDays <= 30) {
        bgColor = '#dbeafe';
        borderColor = '#3b82f6';
      } else {
        bgColor = '#f0fdf4';
        borderColor = '#10b981';
      }
      
      return `
        <div style="padding: 1rem; border-bottom: 1px solid var(--border-light); border-left: 3px solid ${borderColor}; background: ${bgColor}; transition: var(--transition); cursor: pointer;" 
             onclick="openSwitchModal('${sw.id}')"
             onmouseover="this.style.transform='translateX(5px)'"
             onmouseout="this.style.transform='translateX(0)'">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
            <div style="font-weight: 700;">${fullName(patient)}</div>
            <span style="background: ${borderColor}; color: white; padding: 0.25rem 0.5rem; border-radius: var(--radius); font-size: 0.75rem; font-weight: 700;">J-${diffDays}</span>
          </div>
          <div style="font-size: 0.9rem; color: var(--text-secondary);">
            ${sw.switchDate}${sw.time ? ` à ${sw.time}` : ''} • ${protoName(sw.oldProtoId) || '?'} → ${protoName(sw.newProtoId)}
          </div>
        </div>
      `;
    }).join('');
  } else {
    container.innerHTML = '<p class="text-muted text-center" style="padding: 2rem;">Aucun switch dans les 60 prochains jours</p>';
  }
}

function renderDashboardRenewals(renews30) {
  const container = byId('dashboardRenewalsList');
  if (!container) return;
  
  if (renews30.length === 0) {
    container.innerHTML = '<p class="text-muted text-center" style="padding: 2rem;">Aucune ordonnance à renouveler</p>';
    return;
  }
  
  // Sort by urgency
  renews30.sort((a, b) => {
    const daysA = daysUntilRenewal(a.renewalDate);
    const daysB = daysUntilRenewal(b.renewalDate);
    return daysA - daysB;
  });
  
  container.innerHTML = renews30.map(p => {
    const days = daysUntilRenewal(p.renewalDate);
    
    let bgColor, borderColor, barColor, urgencyText;
    if (days <= 7) {
      bgColor = '#fee2e2';
      borderColor = '#ef4444';
      barColor = '#ef4444';
      urgencyText = 'URGENT';
    } else if (days <= 15) {
      bgColor = '#fef3c7';
      borderColor = '#f59e0b';
      barColor = '#f59e0b';
      urgencyText = 'ATTENTION';
    } else {
      bgColor = '#f0fdf4';
      borderColor = '#10b981';
      barColor = '#10b981';
      urgencyText = 'À PRÉVOIR';
    }
    
    const progress = Math.max(0, Math.min(100, ((30 - days) / 30) * 100));
    
    return `
      <div style="padding: 1rem; border-bottom: 1px solid var(--border-light); border-left: 3px solid ${borderColor}; background: ${bgColor}; transition: var(--transition); cursor: pointer;" 
           onclick="openPatient('${p.id}')"
           onmouseover="this.style.transform='translateX(5px)'"
           onmouseout="this.style.transform='translateX(0)'">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
          <div>
            <div style="font-weight: 700; margin-bottom: 0.25rem;">${fullName(p)}</div>
            <div style="font-size: 0.85rem; color: var(--text-secondary);">
              ${docName(p.docId) || 'Médecin non défini'} • ${centerName(p.centerId) || 'Centre non défini'}
            </div>
          </div>
          <span style="background: ${borderColor}; color: white; padding: 0.25rem 0.5rem; border-radius: var(--radius); font-size: 0.75rem; font-weight: 700;">J-${days}</span>
        </div>
        <div style="margin-bottom: 0.5rem;">
          <div style="display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 0.25rem;">
            <span style="color: var(--text-secondary);">Échéance : ${formatCycleLabel(p.renewalDate)}</span>
            <span style="color: ${borderColor}; font-weight: 700;">${urgencyText}</span>
          </div>
          <div style="background: rgba(0,0,0,0.1); height: 6px; border-radius: 3px; overflow: hidden;">
            <div style="background: ${barColor}; height: 100%; width: ${progress}%; transition: width 0.3s ease; border-radius: 3px;"></div>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function renderDashboardProtocolsChart() {
  const container = byId('dashboardProtocolsChart');
  if (!container) return;
  
  if (state.patients.length === 0) {
    container.innerHTML = '<p class="text-muted text-center">Aucune donnée à afficher</p>';
    return;
  }
  
  // Count patients by protocol
  const protocolCounts = {};
  state.patients.forEach(p => {
    const protoId = p.protoId || 'unknown';
    protocolCounts[protoId] = (protocolCounts[protoId] || 0) + 1;
  });
  
  const colors = ['#667eea', '#f093fb', '#4facfe', '#fa709a', '#ffd200', '#54a0ff', '#48dbfb', '#ff6348'];
  const total = state.patients.length;
  
  let html = '<div style="display: flex; flex-direction: column; gap: 0.75rem;">';
  
  Object.entries(protocolCounts)
    .sort((a, b) => b[1] - a[1])
    .forEach(([protoId, count], index) => {
      const percentage = Math.round((count / total) * 100);
      const color = colors[index % colors.length];
      const name = protoName(protoId) || 'Non défini';
      
      html += `
        <div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
            <span style="font-weight: 600; font-size: 0.9rem;">${name}</span>
            <span style="font-weight: 700; color: ${color};">${count} (${percentage}%)</span>
          </div>
          <div style="background: var(--bg-tertiary); height: 8px; border-radius: 4px; overflow: hidden;">
            <div style="background: ${color}; height: 100%; width: ${percentage}%; transition: width 0.5s ease; border-radius: 4px;"></div>
          </div>
        </div>
      `;
    });
  
  html += '</div>';
  container.innerHTML = html;
}

// ===== Calendar Functions =====
let calendarCurrentDate = new Date();

function renderDashboardCalendar() {
  const container = byId('dashboardCalendar');
  const monthYearEl = byId('calendarMonthYear');

  if (!container) return;

  const year = calendarCurrentDate.getFullYear();
  const month = calendarCurrentDate.getMonth();

  // Update month/year display
  const monthNames = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
  if (monthYearEl) {
    monthYearEl.textContent = `${monthNames[month]} ${year}`;
  }

  // Get first day of month and number of days
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const daysInMonth = lastDay.getDate();
  const startingDayOfWeek = firstDay.getDay();

  // Adjust for Monday start (0 = Monday, 6 = Sunday)
  const adjustedStartDay = startingDayOfWeek === 0 ? 6 : startingDayOfWeek - 1;

  // Get days from previous month
  const prevMonthLastDay = new Date(year, month, 0).getDate();

  // Today's date for comparison
  const today = new Date();
  const isCurrentMonth = today.getMonth() === month && today.getFullYear() === year;
  const todayDate = today.getDate();

  // Collect all events for this month
  const monthEvents = getMonthEvents(year, month);

  // Build calendar HTML
  let html = '<div class="calendar-grid">';

  // Day headers
  const dayNames = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
  dayNames.forEach(day => {
    html += `<div class="calendar-day-header">${day}</div>`;
  });

  // Previous month days
  for (let i = adjustedStartDay - 1; i >= 0; i--) {
    const day = prevMonthLastDay - i;
    html += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
  }

  // Current month days
  for (let day = 1; day <= daysInMonth; day++) {
    const isToday = isCurrentMonth && day === todayDate;
    const dayEvents = monthEvents.filter(e => e.day === day);

    // Sort events by time: events with time first (sorted chronologically), then events without time
    dayEvents.sort((a, b) => {
      // If both have time, sort by time
      if (a.time && b.time) {
        return a.time.localeCompare(b.time);
      }
      // Events with time come before events without time
      if (a.time && !b.time) return -1;
      if (!a.time && b.time) return 1;
      // If neither has time, maintain original order
      return 0;
    });

    let dayClass = 'calendar-day';
    if (isToday) dayClass += ' today';

    html += `<div class="${dayClass}">`;
    html += `<div class="calendar-day-number">${day}</div>`;

    if (dayEvents.length > 0) {
      html += '<div class="calendar-events">';

      // Show max 3 events, then "X more"
      const maxVisible = 3;
      const visibleEvents = dayEvents.slice(0, maxVisible);

      visibleEvents.forEach(event => {
        const icon = event.type === 'appointment' ? '📅' : '🔄';
        const eventClass = event.type === 'appointment' ? 'appointment' : 'switch';
        const completedClass = event.isCompleted ? ' completed' : '';
        const displayText = event.time ? `${event.time} ${event.patientName}` : event.patientName;

        html += `
          <div class="calendar-event ${eventClass}${completedClass}"
               data-event-id="${event.eventId}"
               data-event-type="${event.eventType}"
               title="${escapeHtml(event.title)}"
               style="cursor: pointer;">
            <span class="calendar-event-icon">${icon}</span>
            <span style="overflow: hidden; text-overflow: ellipsis;">${escapeHtml(displayText)}</span>
          </div>
        `;
      });

      if (dayEvents.length > maxVisible) {
        html += `<div class="calendar-more-events">+${dayEvents.length - maxVisible} autre${dayEvents.length - maxVisible > 1 ? 's' : ''}</div>`;
      }

      html += '</div>';
    }

    html += '</div>';
  }

  // Next month days to fill the grid
  const totalCells = adjustedStartDay + daysInMonth;
  const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
  for (let day = 1; day <= remainingCells; day++) {
    html += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
  }

  html += '</div>';
  container.innerHTML = html;
}

function getMonthEvents(year, month) {
  const events = [];

  // Get appointments for this month (only those with exact dates)
  if (state.appointments && state.appointments.length > 0) {
    state.appointments.forEach(apt => {
      if (apt.status !== 'active') return;

      // Only include appointments with exact dates in the calendar
      if (apt.exactDate) {
        const parts = apt.exactDate.split('/');
        if (parts.length === 3) {
          const day = parseInt(parts[0], 10);
          const aptMonth = parseInt(parts[1], 10) - 1;
          const aptYear = parseInt(parts[2], 10);

          if (aptMonth === month && aptYear === year) {
            const patient = state.patients.find(p => p.id === apt.patientId);
            if (patient) {
              const timeStr = apt.time ? ` à ${apt.time}` : '';
              events.push({
                day: day,
                type: 'appointment',
                title: `RDV: ${fullName(patient)} - ${apt.type || 'Suivi'}${timeStr}`,
                patientName: fullName(patient),
                time: apt.time,
                data: apt,
                eventId: apt.id,
                eventType: 'appointment'
              });
            }
          }
        }
      }
      // Patients with only month (no exact date) are handled separately in renderCalendarToCall()
    });
  }

  // Get switches for this month (both planned and completed)
  if (state.switches && state.switches.length > 0) {
    state.switches.forEach(sw => {
      // Include both 'planned' and 'completed' switches
      if (sw.status !== 'planned' && sw.status !== 'completed') return;

      if (sw.switchDate) {
        const parts = sw.switchDate.split('/');
        if (parts.length === 3) {
          const day = parseInt(parts[0], 10);
          const swMonth = parseInt(parts[1], 10) - 1;
          const swYear = parseInt(parts[2], 10);

          if (swMonth === month && swYear === year) {
            const patient = state.patients.find(p => p.id === sw.patientId);
            if (patient) {
              const timeStr = sw.time ? ` à ${sw.time}` : '';
              const isCompleted = sw.status === 'completed';
              events.push({
                day: day,
                type: 'switch',
                title: `Switch: ${fullName(patient)} - ${protoName(sw.oldProtoId)} → ${protoName(sw.newProtoId)}${timeStr}${isCompleted ? ' (Effectué)' : ''}`,
                patientName: fullName(patient),
                time: sw.time,
                data: sw,
                eventId: sw.id,
                eventType: 'switch',
                isCompleted: isCompleted
              });
            }
          }
        }
      }
    });
  }

  return events;
}

function renderCalendarToCall() {
  const year = calendarCurrentDate.getFullYear();
  const month = calendarCurrentDate.getMonth();

  const section = byId('calendarToCallSection');
  const list = byId('calendarToCallList');
  const count = byId('calendarToCallCount');

  if (!section || !list) return;

  const toCallList = [];

  // Get appointments with only month (no exact date)
  if (state.appointments && state.appointments.length > 0) {
    state.appointments.forEach(apt => {
      if (apt.status !== 'active') return;

      // Only include appointments without exact date (month only)
      if (!apt.exactDate && apt.month) {
        const parts = apt.month.split('/');
        if (parts.length === 2) {
          const aptMonth = parseInt(parts[0], 10) - 1;
          const aptYear = parseInt(parts[1], 10);

          if (aptMonth === month && aptYear === year) {
            const patient = state.patients.find(p => p.id === apt.patientId);
            if (patient) {
              toCallList.push({
                appointment: apt,
                patient: patient
              });
            }
          }
        }
      }
    });
  }

  if (toCallList.length === 0) {
    section.style.display = 'none';
    return;
  }

  section.style.display = 'block';
  count.textContent = toCallList.length;

  list.innerHTML = toCallList.map(item => {
    const apt = item.appointment;
    const patient = item.patient;

    return `
      <div style="padding: 1rem; border-bottom: 1px solid var(--border); transition: var(--transition); cursor: pointer; display: flex; align-items: center; gap: 1rem;"
           onclick="openAppointmentModal('${apt.id}')"
           onmouseover="this.style.background='var(--bg-secondary)'"
           onmouseout="this.style.background='var(--bg-primary)'">
        <div style="flex-shrink: 0; width: 48px; height: 48px; background: linear-gradient(135deg, rgba(251, 191, 36, 0.15) 0%, rgba(245, 158, 11, 0.15) 100%); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; border: 2px dashed #f59e0b;">
          📞
        </div>
        <div style="flex: 1;">
          <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem;">
            ${fullName(patient)}
          </div>
          <div style="font-size: 0.875rem; color: var(--text-secondary);">
            ${apt.type || 'Suivi'} • À planifier dans le mois
          </div>
        </div>
        <div style="flex-shrink: 0;">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20" style="color: var(--text-muted);">
            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
          </svg>
        </div>
      </div>
    `;
  }).join('');
}

function setupCalendarNavigation() {
  const prevBtn = byId('calendarPrevMonth');
  const nextBtn = byId('calendarNextMonth');
  const todayBtn = byId('calendarToday');

  if (prevBtn) {
    prevBtn.onclick = () => {
      calendarCurrentDate.setMonth(calendarCurrentDate.getMonth() - 1);
      renderDashboardCalendar();
      renderCalendarToCall();
      setupCalendarEventClicks();
    };
  }

  if (nextBtn) {
    nextBtn.onclick = () => {
      calendarCurrentDate.setMonth(calendarCurrentDate.getMonth() + 1);
      renderDashboardCalendar();
      renderCalendarToCall();
      setupCalendarEventClicks();
    };
  }

  if (todayBtn) {
    todayBtn.onclick = () => {
      calendarCurrentDate = new Date();
      renderDashboardCalendar();
      renderCalendarToCall();
      setupCalendarEventClicks();
    };
  }
}

function setupCalendarEventClicks() {
  // Attach click events to calendar events
  const events = document.querySelectorAll('.calendar-event');
  events.forEach(eventEl => {
    eventEl.onclick = (e) => {
      e.stopPropagation();
      const eventId = eventEl.getAttribute('data-event-id');
      const eventType = eventEl.getAttribute('data-event-type');

      if (eventType === 'appointment') {
        openAppointmentModal(eventId);
      } else if (eventType === 'switch') {
        openSwitchModal(eventId);
      }
    };
  });
}

function renderPatients() {
  const tbody = qsEl('#tblPatients tbody');
  if (!tbody) return;

  const sortBy = byId('sortPatients')?.value || 'name';
  // Filter only active patients (status is undefined or 'active')
  let sorted = state.patients.filter(p => !p.status || p.status === 'active');

  // Tri multicritère avec tri secondaire par nom alphabétique
  if (sortBy === 'name') {
    sorted.sort((a, b) => fullName(a).localeCompare(fullName(b)));
  } else if (sortBy === 'recent') {
    sorted.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
  } else if (sortBy === 'renewal') {
    sorted.sort((a, b) => {
      const dateA = parseDate(a.renewalDate);
      const dateB = parseDate(b.renewalDate);
      if (!dateA && !dateB) return fullName(a).localeCompare(fullName(b)); // Tri secondaire par nom
      if (!dateA) return 1;
      if (!dateB) return -1;
      const dateCompare = dateA - dateB;
      // Si même date, tri par nom
      return dateCompare !== 0 ? dateCompare : fullName(a).localeCompare(fullName(b));
    });
  } else if (sortBy === 'doctor') {
    sorted.sort((a, b) => {
      const docCompare = (docName(a.docId) || 'ZZZ').localeCompare(docName(b.docId) || 'ZZZ');
      // Si même médecin, tri par nom
      return docCompare !== 0 ? docCompare : fullName(a).localeCompare(fullName(b));
    });
  } else if (sortBy === 'center') {
    sorted.sort((a, b) => {
      const centerCompare = (centerName(a.centerId) || 'ZZZ').localeCompare(centerName(b.centerId) || 'ZZZ');
      // Si même centre, tri par nom
      return centerCompare !== 0 ? centerCompare : fullName(a).localeCompare(fullName(b));
    });
  } else if (sortBy === 'protocol') {
    sorted.sort((a, b) => {
      const protoCompare = (protoName(a.protoId) || 'ZZZ').localeCompare(protoName(b.protoId) || 'ZZZ');
      // Si même protocole, tri par nom
      return protoCompare !== 0 ? protoCompare : fullName(a).localeCompare(fullName(b));
    });
  }
  
  if (sorted.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted" style="padding: 2rem;">Aucun patient actif</td></tr>';
    return;
  }

  tbody.innerHTML = sorted.map(p => {
    const cycleInfo = getCycleFromDate(p.renewalDate);
    const cycleLabel = cycleInfo ? `${cycleInfo.name} ${cycleInfo.year}` : '—';

    return `
      <tr style="cursor: pointer;" onclick="viewPatientDetails('${p.id}')" title="Cliquer pour voir les détails">
        <td style="font-weight: 600;">${fullName(p)}</td>
        <td>${protoName(p.protoId) || '—'}</td>
        <td>${docName(p.docId) || '—'}</td>
        <td>${centerName(p.centerId) || '—'}</td>
        <td>${p.renewalDate ? `<div>${p.renewalDate}</div><div class="text-small text-muted">${cycleLabel}</div>` : '—'}</td>
      </tr>
    `;
  }).join('');
}

function renderArchivedPatients() {
  const tbody = qsEl('#tblArchived tbody');
  if (!tbody) return;
  
  const filterStatus = byId('filterArchivedStatus')?.value || 'all';
  const sortBy = byId('sortArchived')?.value || 'name';
  
  // Filter archived patients
  let filtered = state.patients.filter(p => p.status && p.status !== 'active');
  
  // Apply status filter
  if (filterStatus !== 'all') {
    filtered = filtered.filter(p => p.status === filterStatus);
  }
  
  // Sort avec tri secondaire par nom alphabétique
  if (sortBy === 'name') {
    filtered.sort((a, b) => fullName(a).localeCompare(fullName(b)));
  } else if (sortBy === 'recent') {
    filtered.sort((a, b) => (b.pausedAt || 0) - (a.pausedAt || 0));
  } else if (sortBy === 'pauseDate') {
    filtered.sort((a, b) => {
      const dateCompare = (b.pausedAt || 0) - (a.pausedAt || 0);
      // Si même date d'arrêt, tri par nom
      return dateCompare !== 0 ? dateCompare : fullName(a).localeCompare(fullName(b));
    });
  }
  
  // Update statistics
  const tempPause = state.patients.filter(p => p.status === 'temporary_pause').length;
  const permPause = state.patients.filter(p => p.status === 'permanent_pause').length;
  const total = tempPause + permPause;
  
  byId('countTemporaryPause').textContent = tempPause;
  byId('countPermanentPause').textContent = permPause;
  byId('countTotalArchived').textContent = total;
  
  if (filtered.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted" style="padding: 2rem;">Aucun patient archivé</td></tr>';
    return;
  }
  
  tbody.innerHTML = filtered.map(p => {
    const statusBadge = p.status === 'temporary_pause' 
      ? '<span style="background: #f59e0b; color: white; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600;">⏸️ Temporaire</span>'
      : '<span style="background: #ef4444; color: white; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600;">⛔ Définitif</span>';
    
    const pauseDate = p.pausedAt ? new Date(p.pausedAt).toLocaleDateString('fr-FR') : '—';
    
    return `
      <tr>
        <td style="font-weight: 600;">${fullName(p)}</td>
        <td>${statusBadge}</td>
        <td>${pauseDate}</td>
        <td>${protoName(p.protoId) || '—'}</td>
        <td>${docName(p.docId) || '—'}</td>
        <td>
          <div style="display: flex; gap: 0.5rem;">
            <button class="btn btn-sm btn-success" data-action="reactivate" data-patient-id="${p.id}" title="Réactiver le patient">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd"></path></svg>
            </button>
            <button class="btn btn-sm btn-secondary" data-action="viewDetails" data-patient-id="${p.id}" title="Voir les détails">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path></svg>
            </button>
          </div>
        </td>
      </tr>
    `;
  }).join('');
}

// Helper function to parse DD/MM/YYYY dates
function parseDate(dateStr) {
  if (!dateStr) return null;
  const parts = dateStr.split('/');
  if (parts.length !== 3) return null;
  return new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
}

function renderOrdos() {
  // Current cycle info
  const currentCycle = getCurrentCycle();
  byId('currentCycleLabel').textContent = `${currentCycle.name} ${currentCycle.year}`;
  byId('currentCycleRange').textContent = currentCycle.label;
  
  // Statistics
  const currentCyclePatients = getPatientsByCycle(currentCycle.cycle, currentCycle.year);
  const expired = getExpiredOrdonnances();
  const upcoming = getUpcomingRenewals(30);
  const validOrdos = state.patients.filter(p => {
    const days = daysUntilRenewal(p.renewalDate);
    if (days === null || days <= 30) return false;

    // Exclure les patients archivés dont la date de renouvellement est ultérieure à la date d'archivage
    if ((p.status === 'temporary_pause' || p.status === 'permanent_pause') && p.pausedAt) {
      const renewalDate = parseDate(p.renewalDate);
      const pausedDate = new Date(p.pausedAt);
      if (renewalDate && renewalDate > pausedDate) {
        return false;
      }
    }

    return true;
  });
  
  byId('currentCycleRenewals').textContent = currentCyclePatients.length;
  byId('expiredCount').textContent = expired.length;
  byId('validCount').textContent = validOrdos.length;
  
  // Update cycle counts
  const year = parseInt(byId('ordoYearFilter')?.value || currentCycle.year);
  for (let i = 1; i <= 3; i++) {
    const patients = getPatientsByCycle(i, year);
    const countEl = byId(`cycle${i}Count`);
    if (countEl) countEl.textContent = patients.length;
  }
  
  // Render cycle patients list (default to cycle 1)
  renderCyclePatients(1, year);
  
  // Upcoming renewals
  const upcomingList = byId('upcomingRenewalsList');
  if (upcomingList) {
    if (upcoming.length === 0) {
      upcomingList.innerHTML = '<p class="text-center text-muted">Aucun renouvellement prévu dans les 30 prochains jours</p>';
    } else {
      upcomingList.innerHTML = upcoming.map(p => {
        const status = getOrdonnanceStatus(p.renewalDate);
        const cycleInfo = getCycleFromDate(p.renewalDate);
        const statusClass = status.days <= 7 ? 'urgent' : 'warning';
        
        return `
          <div class="ordo-card ${statusClass}">
            <div class="ordo-info">
              <div class="ordo-patient">${fullName(p)}</div>
              <div class="ordo-details">
                <span class="ordo-detail">
                  <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20"><path d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"></path></svg>
                  ${formatCycleLabel(p.renewalDate)}
                </span>
                <span class="ordo-detail">
                  <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>
                  ${docName(p.docId) || 'Sans médecin'}
                </span>
                <span class="ordo-detail">
                  <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm3 1h6v4H7V5zm6 6H7v2h6v-2z" clip-rule="evenodd"></path></svg>
                  ${centerName(p.centerId) || 'Sans centre'}
                </span>
              </div>
            </div>
            <div class="ordo-actions">
              <div class="ordo-status ${statusClass}">
                ${status.label}
              </div>
              <button class="btn btn-primary" onclick="renewOrdonnance('${p.id}')">
                Renouveler
              </button>
            </div>
          </div>
        `;
      }).join('');
    }
  }
  
  // Expired prescriptions
  const expiredList = byId('expiredList');
  if (expiredList) {
    if (expired.length === 0) {
      expiredList.innerHTML = '<p class="text-center text-muted">✅ Aucune ordonnance expirée</p>';
    } else {
      expiredList.innerHTML = expired.map(p => {
        const status = getOrdonnanceStatus(p.renewalDate);
        const cycleInfo = getCycleFromDate(p.renewalDate);
        
        return `
          <div class="ordo-card expired">
            <div class="ordo-info">
              <div class="ordo-patient">${fullName(p)}</div>
              <div class="ordo-details">
                <span class="ordo-detail">
                  <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20"><path d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"></path></svg>
                  ${formatCycleLabel(p.renewalDate)}
                </span>
                <span class="ordo-detail" style="color: var(--danger);">
                  <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                  Expirée depuis ${status.days} jour${status.days > 1 ? 's' : ''}
                </span>
              </div>
            </div>
            <div class="ordo-actions">
              <div class="ordo-status expired">
                Expirée
              </div>
              <button class="btn btn-danger" onclick="renewOrdonnance('${p.id}')">
                Renouveler urgent
              </button>
            </div>
          </div>
        `;
      }).join('');
    }
  }
}

function renderCyclePatients(cycleNum, year) {
  const patients = getPatientsByCycle(cycleNum, year);
  const list = byId('cyclePatientsList');
  
  if (!list) return;
  
  if (patients.length === 0) {
    list.innerHTML = `<p class="text-center text-muted">Aucun patient dans le Cycle ${cycleNum} ${year}</p>`;
    return;
  }
  
  const cycleInfo = getCycleInfo(cycleNum, year);
  const today = new Date();
  const isCurrentCycle = today >= cycleInfo.startDate && today <= cycleInfo.endDate;
  
  // Group patients by doctor
  const patientsByDoctor = {};
  patients.forEach(p => {
    const docId = p.docId || 'no-doctor';
    if (!patientsByDoctor[docId]) {
      patientsByDoctor[docId] = [];
    }
    patientsByDoctor[docId].push(p);
  });
  
  // Sort doctors - "no-doctor" at the end
  const doctorIds = Object.keys(patientsByDoctor).sort((a, b) => {
    if (a === 'no-doctor') return 1;
    if (b === 'no-doctor') return -1;
    const nameA = docName(a) || '';
    const nameB = docName(b) || '';
    return nameA.localeCompare(nameB);
  });
  
  list.innerHTML = `
    <div class="mb-3">
      <div class="flex-between mb-2">
        <h4>Patients du ${cycleInfo.name} ${year}</h4>
        <span class="badge ${isCurrentCycle ? 'badge-success' : 'badge-info'}">
          ${isCurrentCycle ? 'Cycle en cours' : `${cycleInfo.label}`}
        </span>
      </div>
      <div class="text-small text-muted mb-3">
        Période : ${cycleInfo.startDate.toLocaleDateString('fr-FR')} - ${cycleInfo.endDate.toLocaleDateString('fr-FR')}
      </div>
      <div class="text-small text-muted mb-3" style="font-weight: 600;">
        📋 ${Object.keys(patientsByDoctor).length} médecin${Object.keys(patientsByDoctor).length > 1 ? 's' : ''} • 
        ${patients.length} patient${patients.length > 1 ? 's' : ''}
      </div>
    </div>
    
    ${doctorIds.map(docId => {
      const doctorPatients = patientsByDoctor[docId];
      const doctorDisplayName = docId === 'no-doctor' ? '⚠️ Sans médecin attribué' : docName(docId);
      
      // Count urgencies for this doctor
      const urgentCount = doctorPatients.filter(p => {
        const status = getOrdonnanceStatus(p.renewalDate);
        return status.status === 'expiree' || status.status === 'urgent';
      }).length;
      
      return `
        <div class="card mb-3" style="border-left: 4px solid ${docId === 'no-doctor' ? 'var(--danger)' : 'var(--primary)'};">
          <div class="card-header" style="background: var(--bg-tertiary); padding: 1rem;">
            <div class="flex-between" style="align-items: center;">
              <div>
                <h5 style="margin: 0; color: var(--primary); font-size: 1.1rem;">
                  <svg width="18" height="18" fill="currentColor" viewBox="0 0 20 20" style="vertical-align: middle; margin-right: 0.5rem;">
                    <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                  </svg>
                  ${doctorDisplayName}
                </h5>
              </div>
              <div style="display: flex; gap: 0.5rem; align-items: center;">
                <span class="badge badge-info">${doctorPatients.length} patient${doctorPatients.length > 1 ? 's' : ''}</span>
                ${urgentCount > 0 ? `<span class="badge badge-danger">⚠️ ${urgentCount} urgent${urgentCount > 1 ? 's' : ''}</span>` : ''}
              </div>
            </div>
          </div>
          <div class="card-body" style="padding: 0.5rem;">
            ${doctorPatients.map(p => {
              const status = getOrdonnanceStatus(p.renewalDate);
              const statusClass = status.status === 'expiree' ? 'expired' : 
                                 status.status === 'urgent' ? 'warning' : 'valid';
              
              return `
                <div class="ordo-card ${statusClass}" style="margin: 0.5rem;">
                  <div class="ordo-info">
                    <div class="ordo-patient">${fullName(p)}</div>
                    <div class="ordo-details">
                      <span class="ordo-detail">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20"><path d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"></path></svg>
                        ${p.renewalDate || 'Pas de date'}
                      </span>
                      <span class="ordo-detail">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm3 1h6v4H7V5zm6 6H7v2h6v-2z" clip-rule="evenodd"></path></svg>
                        ${centerName(p.centerId) || 'Sans centre'}
                      </span>
                      <span class="ordo-detail">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 1 1 0 000 2H6a2 2 0 00-2 2v6h16V7a2 2 0 00-2-2h-1a1 1 0 100-2 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path></svg>
                        ${protoName(p.protoId) || 'Sans protocole'}
                      </span>
                      ${status.days !== undefined ? `
                        <span class="ordo-detail" style="color: ${status.color}; font-weight: 600;">
                          <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path></svg>
                          ${status.label}
                        </span>
                      ` : ''}
                    </div>
                  </div>
                  <div class="ordo-actions">
                    <button class="btn btn-secondary" onclick="openPatient('${p.id}')">
                      Voir détails
                    </button>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }).join('')}
  `;
}

function renewOrdonnance(patientId) {
  const patient = state.patients.find(p => p.id === patientId);
  if (!patient) return;
  
  const suggestedDate = suggestNextRenewalDate(patient.renewalDate);
  
  // Demander la nouvelle date via prompt
  const newDate = prompt(
    `Renouvellement de l'ordonnance pour ${fullName(patient)}\n\n` +
    `Date actuelle: ${patient.renewalDate || 'Non définie'}\n` +
    `Date suggérée: ${suggestedDate}\n\n` +
    `Entrez la nouvelle date de renouvellement (JJ/MM/AAAA):`,
    suggestedDate
  );
  
  // Si l'utilisateur annule ou laisse vide
  if (!newDate) return;
  
  // Valider le format de la date
  if (!newDate.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
    showToast('Format de date invalide (JJ/MM/AAAA)', 'error');
    return;
  }
  
  // Mettre à jour la date
  patient.renewalDate = newDate;
  patient.updatedAt = Date.now();
  saveDB();
  render();
  showToast(`Ordonnance renouvelée au ${newDate}`, 'success');
}

function startBatchRenewal() {
  const upcoming = getUpcomingRenewals(30);
  if (upcoming.length === 0) {
    showToast('Aucune ordonnance à renouveler', 'info');
    return;
  }
  
  if (confirm(`Renouveler ${upcoming.length} ordonnance(s) en lot ?`)) {
    fcState.list = upcoming;
    fcState.index = 0;
    fcOpen();
  }
}

function refreshOrdonnances() {
  renderOrdos();
  showToast('Vue rafraîchie', 'success');
}

function renderCatalogs() {
  // Doctors
  const docsList = byId('docsList');
  if (docsList) {
    docsList.innerHTML = state.docs.length > 0 
      ? state.docs.map(d => `
          <div style="padding: 0.75rem; border-bottom: 1px solid var(--border-light);">
            <div class="flex-between" style="gap: 1rem;">
              <span style="flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${d.name}">${d.name}</span>
              <button class="btn btn-icon btn-secondary" data-action="delDoc" data-id="${d.id}" style="flex-shrink: 0;" title="Supprimer">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
              </button>
            </div>
          </div>
        `).join('')
      : '<p class="text-center text-muted">Aucun médecin</p>';
  }
  
  // Centers
  const centersList = byId('centersList');
  if (centersList) {
    centersList.innerHTML = state.centers.length > 0
      ? state.centers.map(c => `
          <div style="padding: 0.75rem; border-bottom: 1px solid var(--border-light);">
            <div class="flex-between" style="gap: 1rem;">
              <span style="flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${c.name}">${c.name}</span>
              <button class="btn btn-icon btn-secondary" data-action="delCenter" data-id="${c.id}" style="flex-shrink: 0;" title="Supprimer">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
              </button>
            </div>
          </div>
        `).join('')
      : '<p class="text-center text-muted">Aucun centre</p>';
  }
  
  // Protocols
  const protosList = byId('protosList');
  if (protosList) {
    protosList.innerHTML = state.protos.length > 0
      ? state.protos.map(p => `
          <div style="padding: 0.75rem; border-bottom: 1px solid var(--border-light);">
            <div class="flex-between" style="gap: 1rem;">
              <span style="flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${p.name}">${p.name}</span>
              <button class="btn btn-icon btn-secondary" data-action="delProto" data-id="${p.id}" style="flex-shrink: 0;" title="Supprimer">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
              </button>
            </div>
          </div>
        `).join('')
      : '<p class="text-center text-muted">Aucun protocole</p>';
  }

  // Templates
  renderTemplates();

  updateCounters();
}

// ===== Référentiels Management =====
function addDoc() {
  const input = byId('newDocInput');
  const name = input.value.trim();
  
  if (!name) {
    showToast('Veuillez saisir un nom de médecin', 'warning');
    return;
  }
  
  // Vérifier si le médecin existe déjà
  if (state.docs.some(d => d.name.toLowerCase() === name.toLowerCase())) {
    showToast('Ce médecin existe déjà', 'warning');
    return;
  }
  
  state.docs.push({
    id: generateId(),
    name: name
  });
  
  saveDB();
  renderCatalogs();
  input.value = '';
  showToast('Médecin ajouté', 'success');
}

function addCenter() {
  const input = byId('newCenterInput');
  const name = input.value.trim();
  
  if (!name) {
    showToast('Veuillez saisir un nom de centre', 'warning');
    return;
  }
  
  // Vérifier si le centre existe déjà
  if (state.centers.some(c => c.name.toLowerCase() === name.toLowerCase())) {
    showToast('Ce centre existe déjà', 'warning');
    return;
  }
  
  state.centers.push({
    id: generateId(),
    name: name
  });
  
  saveDB();
  renderCatalogs();
  input.value = '';
  showToast('Centre ajouté', 'success');
}

function addProto() {
  const input = byId('newProtoInput');
  const name = input.value.trim();
  
  if (!name) {
    showToast('Veuillez saisir un nom de protocole', 'warning');
    return;
  }
  
  // Vérifier si le protocole existe déjà
  if (state.protos.some(p => p.name.toLowerCase() === name.toLowerCase())) {
    showToast('Ce protocole existe déjà', 'warning');
    return;
  }
  
  state.protos.push({
    id: generateId(),
    name: name
  });
  
  saveDB();
  renderCatalogs();
  input.value = '';
  showToast('Protocole ajouté', 'success');
}

// ===== Prescription Templates Functions =====

// Global variable to store uploaded file data
let uploadedTemplateData = null;

function renderTemplates() {
  const list = byId('templatesList');
  const count = byId('countTemplates');

  if (!list || !count) return;

  const templates = state.prescriptionTemplates || [];
  count.textContent = templates.length;

  if (templates.length === 0) {
    list.innerHTML = '<div class="text-muted" style="text-align: center; padding: 2rem;">Aucun template d\'ordonnance. Créez-en un pour commencer.</div>';
    return;
  }

  list.innerHTML = templates.map(t => {
    const proto = state.protos.find(p => p.id === t.protoId);
    const protoName = proto ? proto.name : 'Aucun protocole associé';
    const typeLabel = t.type === 'default' ? '📄 Template par défaut' : '📎 Document uploadé';

    return `
      <div class="template-item">
        <div class="template-item-info">
          <div class="template-item-name">${escapeHtml(t.name)}</div>
          <div class="template-item-proto">
            ${typeLabel} • Protocole: ${escapeHtml(protoName)}
          </div>
        </div>
        <div class="template-item-actions">
          <button class="btn btn-sm btn-secondary" onclick="editTemplate('${t.id}')" title="Modifier">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
              <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"></path>
              <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"></path>
            </svg>
          </button>
          <button class="btn btn-sm btn-danger" onclick="deleteTemplate('${t.id}')" title="Supprimer">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
            </svg>
          </button>
        </div>
      </div>
    `;
  }).join('');
}

function openTemplateUploadModal() {
  // Reset form
  const templateName = byId('templateName');
  const templateProto = byId('templateProto');
  const templateFile = byId('templateFile');
  const filePreview = byId('filePreview');

  if (templateName) templateName.value = '';
  if (templateProto) templateProto.value = '';
  if (templateFile) templateFile.value = '';
  if (filePreview) filePreview.style.display = 'none';
  uploadedTemplateData = null;

  // Reset radio buttons
  const defaultRadio = document.querySelector('input[name="templateType"][value="default"]');
  if (defaultRadio) {
    defaultRadio.checked = true;
    toggleTemplateUpload();
  }

  // Populate protocol select
  if (templateProto) {
    templateProto.innerHTML = '<option value="">Sélectionner un protocole...</option>' +
      state.protos.map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`).join('');
  }

  showModal(true, 'templateUploadModal');
}

function toggleTemplateUpload() {
  const checkedRadio = document.querySelector('input[name="templateType"]:checked');
  const uploadSection = byId('uploadSection');

  if (!checkedRadio || !uploadSection) return;

  const type = checkedRadio.value;
  uploadSection.style.display = type === 'upload' ? 'block' : 'none';
}

async function handleTemplateFileUpload(event) {
  const file = event.target.files[0];
  if (!file) return;

  const preview = byId('filePreview');
  const previewContent = byId('filePreviewContent');

  try {
    // Read file as ArrayBuffer
    const arrayBuffer = await file.arrayBuffer();

    // Convert to base64 for storage
    const base64 = arrayBufferToBase64(arrayBuffer);

    // Try to extract text preview using mammoth
    if (file.name.endsWith('.docx')) {
      const result = await mammoth.extractRawText({arrayBuffer: arrayBuffer});
      const textPreview = result.value.substring(0, 200) + (result.value.length > 200 ? '...' : '');

      previewContent.innerHTML = `
        <strong>Fichier:</strong> ${escapeHtml(file.name)} (${formatFileSize(file.size)})<br>
        <strong>Aperçu:</strong><br>
        <div style="margin-top: 0.5rem; padding: 0.5rem; background: white; border-radius: 4px; font-size: 12px; max-height: 100px; overflow-y: auto;">
          ${escapeHtml(textPreview)}
        </div>
      `;
    } else {
      previewContent.innerHTML = `
        <strong>Fichier:</strong> ${escapeHtml(file.name)} (${formatFileSize(file.size)})
      `;
    }

    // Store file data
    uploadedTemplateData = {
      name: file.name,
      size: file.size,
      type: file.type,
      data: base64
    };

    preview.style.display = 'block';
  } catch (error) {
    console.error('Error reading file:', error);
    showToast('Erreur lors de la lecture du fichier', 'error');
  }
}

function arrayBufferToBase64(buffer) {
  let binary = '';
  const bytes = new Uint8Array(buffer);
  const len = bytes.byteLength;
  for (let i = 0; i < len; i++) {
    binary += String.fromCharCode(bytes[i]);
  }
  return btoa(binary);
}

function base64ToArrayBuffer(base64) {
  const binary = atob(base64);
  const len = binary.length;
  const bytes = new Uint8Array(len);
  for (let i = 0; i < len; i++) {
    bytes[i] = binary.charCodeAt(i);
  }
  return bytes.buffer;
}

function formatFileSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

function saveTemplate() {
  const name = byId('templateName').value.trim();
  const protoId = byId('templateProto').value;
  const type = document.querySelector('input[name="templateType"]:checked').value;

  if (!name) {
    showToast('Veuillez entrer un nom pour le template', 'warning');
    return;
  }

  if (!protoId) {
    showToast('Veuillez sélectionner un protocole', 'warning');
    return;
  }

  if (type === 'upload' && !uploadedTemplateData) {
    showToast('Veuillez uploader un document', 'warning');
    return;
  }

  const template = {
    id: generateId(),
    name: name,
    protoId: protoId,
    type: type,
    fileData: type === 'upload' ? uploadedTemplateData : null,
    createdAt: new Date().toISOString()
  };

  if (!state.prescriptionTemplates) {
    state.prescriptionTemplates = [];
  }

  state.prescriptionTemplates.push(template);
  saveDB();
  renderTemplates();
  showModal(false, 'templateUploadModal');
  showToast('Template créé avec succès', 'success');
}

function editTemplate(id) {
  // For now, just show a message
  showToast('Modification de template disponible prochainement', 'info');
}

function deleteTemplate(id) {
  if (!confirm('Êtes-vous sûr de vouloir supprimer ce template ?')) {
    return;
  }

  state.prescriptionTemplates = state.prescriptionTemplates.filter(t => t.id !== id);
  saveDB();
  renderTemplates();
  showToast('Template supprimé', 'success');
}

// ===== Generate Prescription Functions =====

let currentPrescriptionPatientId = null;

function openGeneratePrescriptionModal() {
  console.log('openGeneratePrescriptionModal called', { currentPatientId });

  if (!currentPatientId) {
    console.error('No currentPatientId');
    showToast('Aucun patient sélectionné', 'error');
    return;
  }

  const patient = state.patients.find(p => p.id === currentPatientId);
  if (!patient) {
    console.error('Patient not found', currentPatientId);
    showToast('Patient introuvable', 'error');
    return;
  }

  console.log('Patient found:', patient);
  currentPrescriptionPatientId = currentPatientId;

  // Fill patient info
  byId('prescPatientName').textContent = fullName(patient);
  byId('prescPatientDob').textContent = 'Né(e) le ' + formatDateFR(patient.dob);
  byId('prescDoctor').textContent = docName(patient.docId) || '-';
  byId('prescProtocol').textContent = protoName(patient.protoId) || '-';

  // Populate template select
  const templates = state.prescriptionTemplates || [];
  const select = byId('prescTemplateSelect');

  // Filter templates for this patient's protocol
  const patientTemplates = templates.filter(t => t.protoId === patient.protoId);
  const otherTemplates = templates.filter(t => t.protoId !== patient.protoId);

  let html = '<option value="">Sélectionner un template...</option>';

  if (patientTemplates.length > 0) {
    html += '<optgroup label="Templates pour ce protocole">';
    html += patientTemplates.map(t => `<option value="${t.id}">${escapeHtml(t.name)}</option>`).join('');
    html += '</optgroup>';
  }

  if (otherTemplates.length > 0) {
    html += '<optgroup label="Autres templates">';
    html += otherTemplates.map(t => `<option value="${t.id}">${escapeHtml(t.name)}</option>`).join('');
    html += '</optgroup>';
  }

  html += '<option value="default">Template par défaut (professionnel)</option>';

  select.innerHTML = html;

  // Auto-select first matching template or default
  if (patientTemplates.length > 0) {
    select.value = patientTemplates[0].id;
  } else {
    select.value = 'default';
  }

  // Set default start date using patient's renewal date if available, otherwise use today
  let startDate;
  if (patient.renewalDate) {
    // Parse the renewal date from JJ/MM/AAAA format
    startDate = parseDateFR(patient.renewalDate);
  }

  // If no renewal date or parsing failed, use today
  if (!startDate) {
    startDate = new Date();
  }

  byId('prescStartDate').value = startDate.toISOString().split('T')[0];
  updatePrescEndDate();

  showModal(true, 'generatePrescriptionModal');
}

function updatePrescEndDate() {
  const startDateInput = byId('prescStartDate');
  const endDateInput = byId('prescEndDate');
  const durationRadio = document.querySelector('input[name="prescDuration"]:checked');

  if (!startDateInput || !endDateInput || !durationRadio) return;
  if (!startDateInput.value) return;

  const duration = parseInt(durationRadio.value);
  const startDate = new Date(startDateInput.value);
  const endDate = new Date(startDate);
  endDate.setMonth(endDate.getMonth() + duration);

  endDateInput.value = endDate.toISOString().split('T')[0];
}

async function generatePrescriptionPDF() {
  const patient = state.patients.find(p => p.id === currentPrescriptionPatientId);
  if (!patient) {
    showToast('Patient introuvable', 'error');
    return;
  }

  const templateId = byId('prescTemplateSelect').value;
  const startDate = byId('prescStartDate').value;
  const endDate = byId('prescEndDate').value;
  const duration = parseInt(document.querySelector('input[name="prescDuration"]:checked').value);
  const formationInitiale = byId('prescFormationInitiale').checked;

  if (!templateId) {
    showToast('Veuillez sélectionner un template', 'warning');
    return;
  }

  if (!startDate || !endDate) {
    showToast('Veuillez sélectionner les dates', 'warning');
    return;
  }

  try {
    // Ensure jsPDF is loaded
    showToast('Génération de l\'ordonnance en cours...', 'info');

    if (typeof window.jspdf === 'undefined') {
      await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
      // Verify jsPDF loaded successfully
      if (typeof window.jspdf === 'undefined') {
        throw new Error('jsPDF n\'a pas pu être chargé');
      }
    }

    // Generate PDF based on template type
    if (templateId === 'default') {
      await generateDefaultPrescriptionPDF(patient, startDate, endDate, duration, formationInitiale);
    } else {
      const template = state.prescriptionTemplates.find(t => t.id === templateId);
      if (template && template.type === 'upload' && template.fileData) {
        await generateFromUploadedTemplate(patient, template, startDate, endDate, duration, formationInitiale);
      } else {
        await generateDefaultPrescriptionPDF(patient, startDate, endDate, duration, formationInitiale);
      }
    }

    showModal(false, 'generatePrescriptionModal');
  } catch (error) {
    console.error('Error generating prescription:', error);
    showToast('Erreur lors de la génération de l\'ordonnance: ' + error.message, 'error');
  }
}

async function generateDefaultPrescriptionPDF(patient, startDate, endDate, duration, formationInitiale = false) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p', 'mm', 'a4');

  const pageWidth = 210;
  const pageHeight = 297;
  const margin = 20;
  let y = margin;

  // Header - Medical letterhead
  doc.setFillColor(59, 130, 246);
  doc.rect(0, 0, pageWidth, 40, 'F');

  doc.setTextColor(255, 255, 255);
  doc.setFontSize(24);
  doc.setFont('helvetica', 'bold');
  doc.text('ORDONNANCE MÉDICALE', pageWidth / 2, 20, { align: 'center' });

  doc.setFontSize(12);
  doc.setFont('helvetica', 'normal');
  const doctor = state.docs.find(d => d.id === patient.docId);
  const doctorName = doctor ? doctor.name : 'Dr. [Nom du médecin]';
  doc.text(doctorName, pageWidth / 2, 30, { align: 'center' });

  y = 50;
  doc.setTextColor(0, 0, 0);

  // Date
  doc.setFontSize(10);
  doc.text('Date: ' + formatDateForDisplay(new Date()), pageWidth - margin, y, { align: 'right' });
  y += 15;

  // Patient Information Box
  doc.setFillColor(248, 250, 252);
  doc.roundedRect(margin, y, pageWidth - 2 * margin, 35, 3, 3, 'F');
  doc.setDrawColor(226, 232, 240);
  doc.roundedRect(margin, y, pageWidth - 2 * margin, 35, 3, 3, 'S');

  y += 8;
  doc.setFontSize(11);
  doc.setFont('helvetica', 'bold');
  doc.text('PATIENT', margin + 5, y);

  y += 7;
  doc.setFont('helvetica', 'normal');
  doc.text(`Nom: ${fullName(patient)}`, margin + 5, y);

  y += 6;
  doc.text(`Date de naissance: ${formatDateFR(patient.dob)}  (${calculateAge(patient.dob)} ans)`, margin + 5, y);

  y += 6;
  doc.text(`Code patient: ${patient.patientCode || 'Non renseigné'}`, margin + 5, y);

  y += 15;

  // Prescription content
  doc.setDrawColor(59, 130, 246);
  doc.setLineWidth(0.5);
  doc.line(margin, y, pageWidth - margin, y);
  y += 10;

  doc.setFontSize(14);
  doc.setFont('helvetica', 'bold');
  doc.text('PRESCRIPTION', margin, y);
  y += 10;

  doc.setFontSize(11);
  doc.setFont('helvetica', 'normal');

  const protocol = state.protos.find(p => p.id === patient.protoId);
  const protocolName = protocol ? protocol.name : '[Protocole]';

  doc.text(`Je soussigné ${doctorName}, prescris à ${fullName(patient)} :`, margin, y);
  y += 10;

  doc.setFont('helvetica', 'bold');
  doc.setFontSize(12);
  doc.text(`• ${protocolName}`, margin + 10, y);
  y += 10;

  doc.setFont('helvetica', 'normal');
  doc.setFontSize(11);
  doc.text(`Durée de validité: ${duration} mois`, margin + 10, y);
  y += 7;
  doc.text(`Du ${formatDateForDisplay(new Date(startDate))} au ${formatDateForDisplay(new Date(endDate))}`, margin + 10, y);
  y += 15;

  // Additional notes
  if (patient.notes) {
    doc.setFontSize(10);
    doc.setFont('helvetica', 'italic');
    const notes = doc.splitTextToSize(`Observations: ${patient.notes}`, pageWidth - 2 * margin - 20);
    doc.text(notes, margin + 10, y);
    y += notes.length * 5 + 10;
  }

  y += 20;

  // Center information
  const center = state.centers.find(c => c.id === patient.centerId);
  if (center) {
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(`Centre de soins: ${center.name}`, margin, y);
    y += 7;
  }

  // Signature section
  y = pageHeight - 60;
  doc.setDrawColor(226, 232, 240);
  doc.line(margin, y, pageWidth - margin, y);
  y += 10;

  doc.setFontSize(10);
  doc.text('Signature et cachet du médecin:', pageWidth - margin - 60, y);

  // Footer
  y = pageHeight - 20;
  doc.setFontSize(8);
  doc.setTextColor(100, 100, 100);
  doc.text('Document généré par NHC Patients Manager', pageWidth / 2, y, { align: 'center' });
  doc.text(`Le ${new Date().toLocaleDateString('fr-FR')} à ${new Date().toLocaleTimeString('fr-FR')}`, pageWidth / 2, y + 4, { align: 'center' });

  // Save PDF
  const filename = `Ordonnance_${patient.lastName}_${patient.firstName}_${new Date().toISOString().split('T')[0]}.pdf`;
  doc.save(filename);

  showToast('Ordonnance générée avec succès!', 'success');
}

async function generateFromUploadedTemplate(patient, template, startDate, endDate, duration, formationInitiale = false) {
  try {
    showToast('Chargement du template Word...', 'info');
    console.log('Starting template generation for patient:', patient);

    // Load required libraries if not already loaded with better error handling
    try {
      if (typeof window.PizZip === 'undefined') {
        console.log('Loading PizZip...');
        await loadScript('https://unpkg.com/pizzip@3.1.6/dist/pizzip.min.js');
        if (typeof window.PizZip === 'undefined') {
          throw new Error('PizZip failed to load');
        }
        console.log('PizZip loaded successfully');
      }
    } catch (err) {
      console.error('Error loading PizZip:', err);
      throw new Error('Impossible de charger la bibliothèque PizZip. Vérifiez votre connexion internet.');
    }

    try {
      if (typeof window.docxtemplater === 'undefined' && typeof window.Docxtemplater === 'undefined') {
        console.log('Loading docxtemplater...');
        await loadScript('https://unpkg.com/docxtemplater@3.45.0/build/docxtemplater.min.js');

        // Check both possible namespaces
        if (typeof window.docxtemplater !== 'undefined') {
          console.log('docxtemplater loaded as window.docxtemplater');
        } else if (typeof window.Docxtemplater !== 'undefined') {
          console.log('Docxtemplater loaded as window.Docxtemplater');
          window.docxtemplater = window.Docxtemplater; // Normalize
        } else {
          throw new Error('docxtemplater failed to load');
        }
        console.log('docxtemplater loaded successfully');
      }
    } catch (err) {
      console.error('Error loading docxtemplater:', err);
      throw new Error('Impossible de charger la bibliothèque docxtemplater. Vérifiez votre connexion internet.');
    }

    try {
      if (typeof window.saveAs === 'undefined') {
        console.log('Loading FileSaver...');
        await loadScript('https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js');
        if (typeof window.saveAs === 'undefined') {
          throw new Error('FileSaver failed to load');
        }
        console.log('FileSaver loaded successfully');
      }
    } catch (err) {
      console.error('Error loading FileSaver:', err);
      throw new Error('Impossible de charger la bibliothèque FileSaver. Vérifiez votre connexion internet.');
    }

    // Get doctor information
    const doctor = state.docs.find(d => d.id === patient.docId);
    const doctorName = doctor ? doctor.name : 'Dr. [Nom du médecin]';

    // Format dates
    const startDateFormatted = formatDateForDisplay(new Date(startDate));
    const endDateFormatted = formatDateForDisplay(new Date(endDate));
    const birthDateFormatted = patient.dob ? formatDateForDisplay(new Date(patient.dob)) : '';
    const currentDateFormatted = formatDateForDisplay(new Date());

    // Prepare data for template replacement
    const templateData = {
      // Médecin
      medecin_nom: doctorName,
      nom_medecin: doctorName,
      medecin: doctorName,
      doctor_name: doctorName,

      // Patient - nom complet
      patient_nom: patient.lastName || '',
      patient_prenom: patient.firstName || '',
      nom_patient: patient.lastName || '',
      prenom_patient: patient.firstName || '',
      patient_nom_complet: `${patient.firstName || ''} ${patient.lastName || ''}`.trim(),
      nom_complet: `${patient.firstName || ''} ${patient.lastName || ''}`.trim(),

      // Date de naissance
      patient_date_naissance: birthDateFormatted,
      date_naissance: birthDateFormatted,
      dob: birthDateFormatted,

      // Dates ordonnance
      date_debut: startDateFormatted,
      date_debut_ordonnance: startDateFormatted,
      start_date: startDateFormatted,

      date_fin: endDateFormatted,
      date_fin_ordonnance: endDateFormatted,
      end_date: endDateFormatted,

      // Date du jour
      date_jour: currentDateFormatted,
      date: currentDateFormatted,
      current_date: currentDateFormatted,

      // Autres informations utiles
      duree: duration + ' mois',
      duration: duration + ' months',
      patient_id: patient.nhcId || patient.id || '',
      cycle: patient.cycle || '',

      // Formation technique Initiale
      formation_initiale: formationInitiale ? 'X' : '',
      formation_technique_initiale: formationInitiale ? 'X' : '',
      fti: formationInitiale ? 'X' : ''
    };

    console.log('Template data prepared:', templateData);
    console.log('Template file data structure:', template.fileData);

    // Convert base64 to ArrayBuffer
    try {
      console.log('Converting base64 to binary...');

      // Handle different fileData formats
      let base64Data;
      if (typeof template.fileData === 'string') {
        // If it's a string, it might be a data URL or plain base64
        base64Data = template.fileData.includes(',')
          ? template.fileData.split(',')[1]
          : template.fileData;
      } else if (template.fileData && template.fileData.data) {
        // If it's an object with a data property (current format)
        base64Data = template.fileData.data;
      } else {
        throw new Error('Format de fichier invalide');
      }

      console.log('Base64 data extracted, length:', base64Data.length);

      const binaryString = atob(base64Data);
      const bytes = new Uint8Array(binaryString.length);
      for (let i = 0; i < binaryString.length; i++) {
        bytes[i] = binaryString.charCodeAt(i);
      }
      console.log('Binary conversion complete, size:', bytes.length, 'bytes');

      // Load the docx file
      console.log('Loading docx file with PizZip...');
      const zip = new window.PizZip(bytes);
      console.log('PizZip loaded successfully');

      console.log('Creating docxtemplater instance...');
      const doc = new window.docxtemplater(zip, {
        paragraphLoop: true,
        linebreaks: true,
        delimiters: {
          start: '{',
          end: '}'
        }
      });
      console.log('docxtemplater instance created');

      // Replace placeholders with data
      console.log('Rendering template with data...');
      doc.render(templateData);
      console.log('Template rendered successfully');

      // Generate the modified document
      console.log('Generating output file...');
      const output = doc.getZip().generate({
        type: 'blob',
        mimeType: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
      });
      console.log('Output file generated');

      // Save the file
      const fileName = `Ordonnance_${patient.firstName}_${patient.lastName}_${new Date().getTime()}.docx`;
      console.log('Saving file as:', fileName);
      window.saveAs(output, fileName);

      showToast('Ordonnance générée avec succès !', 'success');
    } catch (docError) {
      console.error('Error processing document:', docError);

      // Check for specific docxtemplater errors
      if (docError.properties && docError.properties.errors) {
        const errorMessages = docError.properties.errors.map(e =>
          `${e.name}: ${e.message} (tag: ${e.properties.id})`
        ).join('\n');
        throw new Error('Erreurs dans le template:\n' + errorMessages);
      }

      throw docError;
    }
  } catch (error) {
    console.error('Error generating from template:', error);
    showToast('Erreur lors de la génération: ' + error.message, 'error');

    // Si erreur, afficher un message d'aide
    if (error.message && error.message.includes('multi_error')) {
      showToast('Vérifiez que les placeholders dans votre template Word utilisent la syntaxe {nom_du_champ}', 'warning');
    }
  }
}

function formatDateForDisplay(date) {
  if (!date) return '';
  if (typeof date === 'string') date = new Date(date);
  return date.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
}

function renderStats() {
  // Populate cycle selects
  const cycles = getAllCycles();
  const currentSelect = byId('currentCycleSelect');
  const previousSelect = byId('previousCycleSelect');
  
  if (currentSelect && previousSelect) {
    // Populate both selects
    const options = cycles.map(c => `<option value="${c.id}">${c.name} ${c.year}</option>`).join('');
    currentSelect.innerHTML = '<option value="">Sélectionner un cycle...</option>' + options;
    previousSelect.innerHTML = '<option value="">Sélectionner un cycle...</option>' + options;
    
    // Auto-select current and previous cycle if available
    if (cycles.length >= 2) {
      currentSelect.value = cycles[0].id; // Most recent cycle
      previousSelect.value = cycles[1].id; // Second most recent cycle
    } else if (cycles.length === 1) {
      currentSelect.value = cycles[0].id;
    }
    
    // Add event listeners to prevent selecting the same cycle in both
    const validateSelection = () => {
      const currentValue = currentSelect.value;
      const previousValue = previousSelect.value;
      
      if (currentValue && previousValue && currentValue === previousValue) {
        showToast('Vous ne pouvez pas sélectionner le même cycle deux fois', 'warning');
        // Reset the last changed select
        if (document.activeElement === currentSelect) {
          currentSelect.value = '';
        } else {
          previousSelect.value = '';
        }
      }
    };
    
    // Remove old listeners if any
    currentSelect.removeEventListener('change', validateSelection);
    previousSelect.removeEventListener('change', validateSelection);
    
    // Add new listeners
    currentSelect.addEventListener('change', validateSelection);
    previousSelect.addEventListener('change', validateSelection);
  }
}

function getAllCycles() {
  // Get current year and previous year
  const currentYear = new Date().getFullYear();
  const previousYear = currentYear - 1;
  
  // Generate all possible cycles for the last 2 years
  const allCycles = [];
  
  [currentYear, previousYear].forEach(year => {
    [1, 2, 3].forEach(cycleNum => {
      const cycleInfo = CYCLES[cycleNum];
      if (cycleInfo) {
        allCycles.push({
          id: `C${cycleNum}-${year}`,
          cycle: cycleNum,
          year: year,
          name: cycleInfo.name,
          label: cycleInfo.label,
          months: cycleInfo.months,
          color: cycleInfo.color,
          month: cycleInfo.months[0] // First month of the cycle for sorting
        });
      }
    });
  });
  
  // Sort by year (desc) then by cycle number (desc) - most recent first
  return allCycles.sort((a, b) => {
    if (a.year !== b.year) return b.year - a.year;
    return b.cycle - a.cycle;
  });
}

function compareStatistics() {
  console.log('=== compareStatistics called ===');
  
  const currentCycleId = byId('currentCycleSelect').value;
  const previousCycleId = byId('previousCycleSelect').value;
  
  console.log('currentCycleId:', currentCycleId);
  console.log('previousCycleId:', previousCycleId);
  
  if (!currentCycleId || !previousCycleId) {
    showToast('Veuillez sélectionner deux cycles à comparer', 'warning');
    return;
  }
  
  if (currentCycleId === previousCycleId) {
    showToast('Veuillez sélectionner deux cycles différents', 'warning');
    // Reset one of the selects
    byId('previousCycleSelect').value = '';
    return;
  }
  
  const cycles = getAllCycles();
  console.log('All cycles:', cycles);
  
  const currentCycle = cycles.find(c => c.id === currentCycleId);
  const previousCycle = cycles.find(c => c.id === previousCycleId);
  
  console.log('currentCycle found:', currentCycle);
  console.log('previousCycle found:', previousCycle);
  
  if (!currentCycle || !previousCycle) {
    showToast('Erreur : cycles non trouvés', 'error');
    console.error('Cycles not found in list');
    return;
  }
  
  // Get patients for each cycle
  console.log('Filtering patients...');
  console.log('Total patients:', state.patients.length);
  
  const currentPatients = state.patients.filter(p => {
    if (!p.renewalDate) return false;
    const cycleInfo = getCycleFromDate(p.renewalDate);
    const matches = cycleInfo && cycleInfo.id === currentCycleId;
    if (matches) {
      console.log('Patient', p.lastName, 'matches current cycle:', cycleInfo);
    }
    return matches;
  });
  
  const previousPatients = state.patients.filter(p => {
    if (!p.renewalDate) return false;
    const cycleInfo = getCycleFromDate(p.renewalDate);
    const matches = cycleInfo && cycleInfo.id === previousCycleId;
    if (matches) {
      console.log('Patient', p.lastName, 'matches previous cycle:', cycleInfo);
    }
    return matches;
  });
  
  console.log('currentPatients count:', currentPatients.length);
  console.log('previousPatients count:', previousPatients.length);
  
  // Calculate KPIs
  const kpis = {
    current: calculateKPIs(currentPatients, currentCycle),
    previous: calculateKPIs(previousPatients, previousCycle)
  };
  
  console.log('KPIs calculated:', kpis);
  
  // Display KPIs
  displayKPIComparison(kpis);
  
  // Show comparison section
  byId('statsComparison').style.display = 'block';
  byId('statsWaiting').style.display = 'none';
  
  // Create comparison chart
  createComparisonChart(kpis, currentCycle, previousCycle);
  
  // Success message
  showToast(`📊 Comparaison entre ${currentCycle.name} ${currentCycle.year} et ${previousCycle.name} ${previousCycle.year}`, 'success');
  
  console.log('=== compareStatistics completed ===');
}

function calculateKPIs(patients, cycle) {
  console.log(`Calculating KPIs for ${cycle.name} ${cycle.year}...`);
  console.log(`Total patients in database: ${state.patients.length}`);
  
  // Get cycle date range
  const cycleStartMonth = cycle.months[0];
  const cycleEndMonth = cycle.months[cycle.months.length - 1];
  const cycleStartDate = new Date(cycle.year, cycleStartMonth - 1, 1);
  const cycleEndDate = new Date(cycle.year, cycleEndMonth, 0); // Last day of last month
  
  console.log(`Cycle range: ${cycleStartDate.toLocaleDateString()} to ${cycleEndDate.toLocaleDateString()}`);
  
  // 1. PATIENTS ACTIFS = tous les patients qui ne sont PAS en arrêt
  // On compte tous les patients actifs à la fin du cycle
  const activePatients = state.patients.filter(p => {
    return !p.status || p.status === 'active';
  });
  console.log(`Active patients (no pause): ${activePatients.length}`);
  
  // 2. TAUX DE COMPLÉTION DES ORDONNANCES
  // Calculer le % d'ordonnances renouvelées par rapport à l'avancement du cycle
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  
  // Déterminer l'avancement du cycle (0 à 100%)
  let cycleProgress = 0;
  if (today < cycleStartDate) {
    cycleProgress = 0; // Cycle pas encore commencé
  } else if (today > cycleEndDate) {
    cycleProgress = 100; // Cycle terminé
  } else {
    const totalDays = (cycleEndDate - cycleStartDate) / (1000 * 60 * 60 * 24);
    const elapsedDays = (today - cycleStartDate) / (1000 * 60 * 60 * 24);
    cycleProgress = Math.round((elapsedDays / totalDays) * 100);
  }
  
  // Compter les ordonnances du cycle (dates dans la période du cycle)
  const ordosDuCycle = activePatients.filter(p => {
    if (!p.renewalDate) return false;
    const renewalDate = parseDateFR(p.renewalDate);
    if (!renewalDate) return false;
    return renewalDate >= cycleStartDate && renewalDate <= cycleEndDate;
  });
  
  // Compter celles qui sont "bien gérées" (encore >30j ou déjà passées si cycle terminé)
  const ordosWellManaged = ordosDuCycle.filter(p => {
    const daysLeft = daysUntilRenewal(p.renewalDate);
    if (cycleProgress === 100) {
      // Cycle terminé : les ordos doivent avoir été renouvelées (date passée ou proche)
      return daysLeft === null || daysLeft < 60;
    } else {
      // Cycle en cours : efficacité = ordos à venir sont encore loin OU déjà traitées
      return daysLeft === null || daysLeft > 30 || daysLeft < 0;
    }
  });
  
  const ordoCompletionRate = ordosDuCycle.length > 0 
    ? Math.round((ordosWellManaged.length / ordosDuCycle.length) * 100)
    : 100; // Si pas d'ordos, considérer comme 100%
  
  console.log(`Ordonnances du cycle: ${ordosDuCycle.length}, bien gérées: ${ordosWellManaged.length}, taux: ${ordoCompletionRate}%`);
  
  // 3. SUIVIS EFFECTUÉS dans ce cycle
  const suivisDuCycle = (state.appointments || []).filter(a => {
    if (a.status !== 'completed') return false;
    if (!a.completedAt) return false;
    
    const completedDate = new Date(a.completedAt);
    return completedDate >= cycleStartDate && completedDate <= cycleEndDate;
  });
  console.log(`Suivis completed in cycle: ${suivisDuCycle.length}`);
  
  // 4. SWITCHS EFFECTUÉS dans ce cycle
  const switchsDuCycle = (state.switches || []).filter(s => {
    if (s.status !== 'done') return false;
    if (!s.switchDate) return false;
    
    const switchDate = parseDateFR(s.switchDate);
    if (!switchDate) return false;
    
    return switchDate >= cycleStartDate && switchDate <= cycleEndDate;
  });
  console.log(`Switchs in cycle: ${switchsDuCycle.length}`);
  
  // 5. ARRÊTS TEMPORAIRES survenus pendant ce cycle
  const arretsTemporaires = state.patients.filter(p => {
    if (p.status !== 'temporary_pause') return false;
    if (!p.pausedAt) return false;
    
    const pauseDate = new Date(p.pausedAt);
    return pauseDate >= cycleStartDate && pauseDate <= cycleEndDate;
  });
  console.log(`Temporary pauses in cycle: ${arretsTemporaires.length}`);
  
  // 6. ARRÊTS DÉFINITIFS survenus pendant ce cycle
  const arretsDefinitifs = state.patients.filter(p => {
    if (p.status !== 'permanent_pause') return false;
    if (!p.pausedAt) return false;
    
    const pauseDate = new Date(p.pausedAt);
    return pauseDate >= cycleStartDate && pauseDate <= cycleEndDate;
  });
  console.log(`Permanent pauses in cycle: ${arretsDefinitifs.length}`);
  
  // 7. SCORE QUALITÉ MOYEN des patients actifs
  const scores = activePatients.map(p => qScore(p)).filter(s => s !== null && s !== undefined);
  const avgScore = scores.length > 0 
    ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) 
    : 0;
  console.log(`Quality score: ${avgScore}% (based on ${scores.length} active patients)`);
  
  const kpis = {
    patients: activePatients.length,
    ordoCompletionRate: ordoCompletionRate,
    suivis: suivisDuCycle.length,
    switchs: switchsDuCycle.length,
    tempPauses: arretsTemporaires.length,
    permPauses: arretsDefinitifs.length,
    avgScore: avgScore
  };
  
  console.log('Final KPIs:', kpis);
  
  return kpis;
}

function displayKPIComparison(kpis) {
  console.log('Displaying KPI comparison...');
  
  try {
    const { current, previous } = kpis;
    
    // 1. PATIENTS ACTIFS
    const kpiPatients1 = byId('kpiPatients1');
    const kpiPatients2 = byId('kpiPatients2');
    const kpiPatientsEvol = byId('kpiPatientsEvol');
    
    if (kpiPatients1 && kpiPatients2 && kpiPatientsEvol) {
      kpiPatients1.textContent = previous.patients;
      kpiPatients2.textContent = current.patients;
      const patientsEvol = calculateEvolution(previous.patients, current.patients);
      kpiPatientsEvol.textContent = patientsEvol.text;
      kpiPatientsEvol.className = `badge ${patientsEvol.class}`;
    }
    
    // 2. EFFICACITÉ ORDONNANCES (taux de complétion en %)
    const kpiOrdos1 = byId('kpiOrdos1');
    const kpiOrdos2 = byId('kpiOrdos2');
    const kpiOrdosEvol = byId('kpiOrdosEvol');
    
    if (kpiOrdos1 && kpiOrdos2 && kpiOrdosEvol) {
      kpiOrdos1.textContent = previous.ordoCompletionRate + '%';
      kpiOrdos2.textContent = current.ordoCompletionRate + '%';
      const ordosEvol = calculateEvolution(previous.ordoCompletionRate, current.ordoCompletionRate);
      kpiOrdosEvol.textContent = ordosEvol.text;
      kpiOrdosEvol.className = `badge ${ordosEvol.class}`;
    }
    
    // 3. SUIVIS EFFECTUÉS
    const kpiSuivis1 = byId('kpiSuivis1');
    const kpiSuivis2 = byId('kpiSuivis2');
    const kpiSuivisEvol = byId('kpiSuivisEvol');
    
    if (kpiSuivis1 && kpiSuivis2 && kpiSuivisEvol) {
      kpiSuivis1.textContent = previous.suivis;
      kpiSuivis2.textContent = current.suivis;
      const suivisEvol = calculateEvolution(previous.suivis, current.suivis);
      kpiSuivisEvol.textContent = suivisEvol.text;
      kpiSuivisEvol.className = `badge ${suivisEvol.class}`;
    }
    
    // 4. SWITCHS
    const kpiSwitchs1 = byId('kpiSwitchs1');
    const kpiSwitchs2 = byId('kpiSwitchs2');
    const kpiSwitchsEvol = byId('kpiSwitchsEvol');
    
    if (kpiSwitchs1 && kpiSwitchs2 && kpiSwitchsEvol) {
      kpiSwitchs1.textContent = previous.switchs;
      kpiSwitchs2.textContent = current.switchs;
      const switchsEvol = calculateEvolution(previous.switchs, current.switchs);
      kpiSwitchsEvol.textContent = switchsEvol.text;
      kpiSwitchsEvol.className = `badge ${switchsEvol.class}`;
    }
    
    // 5. ARRÊTS TEMPORAIRES
    const kpiTempPause1 = byId('kpiTempPause1');
    const kpiTempPause2 = byId('kpiTempPause2');
    const kpiTempPauseEvol = byId('kpiTempPauseEvol');
    
    if (kpiTempPause1 && kpiTempPause2 && kpiTempPauseEvol) {
      kpiTempPause1.textContent = previous.tempPauses;
      kpiTempPause2.textContent = current.tempPauses;
      // Pour les arrêts, une augmentation est négative
      const tempPauseEvol = calculateEvolution(previous.tempPauses, current.tempPauses, true);
      kpiTempPauseEvol.textContent = tempPauseEvol.text;
      kpiTempPauseEvol.className = `badge ${tempPauseEvol.class}`;
    }
    
    // 6. ARRÊTS DÉFINITIFS
    const kpiPermPause1 = byId('kpiPermPause1');
    const kpiPermPause2 = byId('kpiPermPause2');
    const kpiPermPauseEvol = byId('kpiPermPauseEvol');
    
    if (kpiPermPause1 && kpiPermPause2 && kpiPermPauseEvol) {
      kpiPermPause1.textContent = previous.permPauses;
      kpiPermPause2.textContent = current.permPauses;
      // Pour les arrêts, une augmentation est négative
      const permPauseEvol = calculateEvolution(previous.permPauses, current.permPauses, true);
      kpiPermPauseEvol.textContent = permPauseEvol.text;
      kpiPermPauseEvol.className = `badge ${permPauseEvol.class}`;
    }
    
    // 7. SCORE QUALITÉ
    const kpiScore1 = byId('kpiScore1');
    const kpiScore2 = byId('kpiScore2');
    const kpiScoreEvol = byId('kpiScoreEvol');
    
    if (kpiScore1 && kpiScore2 && kpiScoreEvol) {
      kpiScore1.textContent = previous.avgScore + '%';
      kpiScore2.textContent = current.avgScore + '%';
      const scoreEvol = calculateEvolution(previous.avgScore, current.avgScore);
      kpiScoreEvol.textContent = scoreEvol.text;
      kpiScoreEvol.className = `badge ${scoreEvol.class}`;
    }
    
    console.log('KPI comparison displayed successfully');
    
  } catch (error) {
    console.error('Error displaying KPI comparison:', error);
  }
}

function calculateEvolution(oldValue, newValue, inverseLogic = false) {
  if (oldValue === 0) {
    if (newValue > 0) {
      // Si inverseLogic=true (arrêts), une augmentation depuis 0 est mauvaise
      const badgeClass = inverseLogic ? 'badge-danger' : 'badge-success';
      return { text: `+${newValue} (nouveau)`, class: badgeClass };
    }
    return { text: 'Aucun changement', class: 'badge-secondary' };
  }
  
  const diff = newValue - oldValue;
  const percent = Math.round((diff / oldValue) * 100);
  
  if (diff > 0) {
    // Augmentation
    const badgeClass = inverseLogic ? 'badge-danger' : 'badge-success';
    return { text: `+${diff} (+${percent}%)`, class: badgeClass };
  } else if (diff < 0) {
    // Diminution
    const badgeClass = inverseLogic ? 'badge-success' : 'badge-danger';
    return { text: `${diff} (${percent}%)`, class: badgeClass };
  } else {
    return { text: 'Identique', class: 'badge-secondary' };
  }
}

function createComparisonChart(kpis, currentCycle, previousCycle) {
  console.log('Creating comparison chart...');
  
  const canvas = byId('comparisonChart');
  if (!canvas) {
    console.warn('Canvas element not found');
    return;
  }
  
  // Check if Chart.js is available
  if (typeof Chart === 'undefined') {
    console.error('Chart.js is not loaded');
    canvas.parentElement.innerHTML = `
      <div style="padding: 2rem; text-align: center; background: var(--bg-tertiary); border-radius: var(--radius-lg); border: 2px dashed var(--border);">
        <div style="font-size: 2rem; margin-bottom: 1rem;">📊</div>
        <p style="color: var(--text-secondary); margin-bottom: 0.5rem;">Impossible de charger les graphiques</p>
        <p style="color: var(--text-muted); font-size: 0.9rem;">La bibliothèque Chart.js n'a pas pu être chargée. Vérifiez votre connexion internet.</p>
      </div>
    `;
    return;
  }
  
  try {
    const ctx = canvas.getContext('2d');
    
    // Destroy existing chart if any
    if (window.statsChart) {
      window.statsChart.destroy();
    }
    
    const data = {
      labels: [
        'Patients actifs', 
        'Efficacité ordos (%)', 
        'Suivis', 
        'Switchs', 
        'Arrêts temp.', 
        'Arrêts déf.',
        'Score qualité (%)'
      ],
      datasets: [
        {
          label: `${previousCycle.name} ${previousCycle.year}`,
          data: [
            kpis.previous.patients, 
            kpis.previous.ordoCompletionRate, 
            kpis.previous.suivis, 
            kpis.previous.switchs,
            kpis.previous.tempPauses,
            kpis.previous.permPauses,
            kpis.previous.avgScore
          ],
          backgroundColor: 'rgba(102, 126, 234, 0.5)',
          borderColor: 'rgba(102, 126, 234, 1)',
          borderWidth: 2
        },
        {
          label: `${currentCycle.name} ${currentCycle.year}`,
          data: [
            kpis.current.patients, 
            kpis.current.ordoCompletionRate, 
            kpis.current.suivis, 
            kpis.current.switchs,
            kpis.current.tempPauses,
            kpis.current.permPauses,
            kpis.current.avgScore
          ],
          backgroundColor: 'rgba(118, 75, 162, 0.5)',
          borderColor: 'rgba(118, 75, 162, 1)',
          borderWidth: 2
        }
      ]
    };
    
    window.statsChart = new Chart(ctx, {
      type: 'bar',
      data: data,
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            position: 'top',
          },
          title: {
            display: false
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                let label = context.dataset.label || '';
                if (label) {
                  label += ': ';
                }
                // Ajouter le % pour efficacité ordos et score qualité
                if (context.dataIndex === 1 || context.dataIndex === 6) {
                  label += context.parsed.y + '%';
                } else {
                  label += context.parsed.y;
                }
                return label;
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Valeurs'
            }
          }
        }
      }
    });
    
    console.log('Chart created successfully');
    
  } catch (error) {
    console.error('Error creating comparison chart:', error);
    canvas.parentElement.innerHTML = `
      <div style="padding: 2rem; text-align: center; background: var(--bg-tertiary); border-radius: var(--radius-lg); border: 2px dashed var(--danger);">
        <div style="font-size: 2rem; margin-bottom: 1rem;">⚠️</div>
        <p style="color: var(--danger); margin-bottom: 0.5rem;">Erreur lors de la création du graphique</p>
        <p style="color: var(--text-muted); font-size: 0.9rem;">${error.message || 'Une erreur inattendue s\'est produite'}</p>
      </div>
    `;
  }
}

function updateCounters() {
  const activePatients = state.patients.filter(p => !p.status || p.status === 'active');
  const archivedPatients = state.patients.filter(p => p.status && p.status !== 'active');

  byId('countPatients').textContent = activePatients.length;
  byId('countArchived').textContent = archivedPatients.length;
  byId('countDocs').textContent = state.docs.length;
  byId('countCenters').textContent = state.centers.length;
  byId('countProtos').textContent = state.protos.length;

  // Update tasks counter if tasks exist
  if (state.tasks) {
    updateTasksKPIs();
  }
}

// ===== Patient CRUD =====
function newPatient() {
  currentPatientId = null;
  byId('modalTitle').textContent = 'Nouveau patient';
  byId('btnDeletePatient').classList.add('hidden');
  byId('btnChangeStatus').classList.add('hidden');
  byId('btnGeneratePrescription').classList.add('hidden');

  // Reset form
  ['lastName', 'firstName', 'dob', 'email', 'phone', 'address', 'patientCode', 'notes'].forEach(id => {
    const el = byId(id);
    if (el) el.value = '';
  });

  // Suggest current date + 4 months for new patient
  const today = new Date();
  today.setMonth(today.getMonth() + 4);
  byId('renewalDate').value = formatDateFR(today);
  updateCycleInfo();

  ['docId', 'centerId', 'protoId'].forEach(id => {
    const el = byId(id);
    if (el) el.value = '';
  });

  populateSelects();

  // Make selects searchable
  setTimeout(() => {
    makeSelectSearchable('docId', () => state.docs, (d) => d.name, 'Rechercher un médecin...');
    makeSelectSearchable('centerId', () => state.centers, (c) => c.name, 'Rechercher un centre...');
    makeSelectSearchable('protoId', () => state.protos, (p) => p.name, 'Rechercher un protocole...');
  }, 0);

  showModal(true);
}



function viewPatientDetails(id) {
  const patient = state.patients.find(p => p.id === id);
  if (!patient) return;

  // Stocker l'ID du patient pour les boutons d'ordonnance
  currentPatientId = id;

  const score = qScore(patient);
  const scoreColor = score >= 80 ? 'var(--success)' : score >= 50 ? 'var(--warning)' : 'var(--danger)';
  const cycleInfo = getCycleFromDate(patient.renewalDate);
  const cycleLabel = cycleInfo ? `${cycleInfo.name} ${cycleInfo.year}` : 'Non défini';
  
  const detailsContent = byId('patientDetailsContent');
  detailsContent.innerHTML = `
    <div style="display: grid; gap: 1.5rem;">
      ${patient.status && patient.status !== 'active' ? `
      <!-- Status Alert -->
      <div style="background: ${patient.status === 'temporary_pause' ? 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)' : 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)'}; color: white; padding: 1rem; border-radius: var(--radius); display: flex; align-items: center; gap: 1rem;">
        <div style="font-size: 2rem;">${patient.status === 'temporary_pause' ? '⏸️' : '⛔'}</div>
        <div style="flex: 1;">
          <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.25rem;">
            ${patient.status === 'temporary_pause' ? 'Arrêt temporaire' : 'Arrêt définitif'}
          </div>
          <div style="opacity: 0.9; font-size: 0.9rem;">
            ${patient.pausedAt ? 'Depuis le ' + new Date(patient.pausedAt).toLocaleDateString('fr-FR') : ''}
            ${patient.pauseReason ? ' - ' + patient.pauseReason : ''}
          </div>
        </div>
        <button class="btn" data-action="reactivate" data-patient-id="${patient.id}" style="background: white; color: var(--primary); font-weight: 600; white-space: nowrap;">
          Réactiver
        </button>
      </div>
      ` : ''}
      <!-- Informations principales -->
      <div class="info-section">
        <h3 style="color: var(--primary); margin-bottom: 1rem; font-size: 1.25rem;">
          👤 Informations personnelles
        </h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
          <div class="info-item">
            <div class="info-label">Nom complet</div>
            <div class="info-value">${fullName(patient)}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Date de naissance</div>
            <div class="info-value">${patient.dob || '—'}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Email</div>
            <div class="info-value">${patient.email || '—'}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Téléphone</div>
            <div class="info-value">${patient.phone || '—'}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Adresse</div>
            <div class="info-value">${patient.address || '—'}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Code Patient</div>
            <div class="info-value" style="color: var(--primary); font-weight: 600;">${patient.patientCode || '—'}</div>
          </div>
        </div>
      </div>
      
      <!-- Informations médicales -->
      <div class="info-section">
        <h3 style="color: var(--primary); margin-bottom: 1rem; font-size: 1.25rem;">
          🏥 Informations médicales
        </h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
          <div class="info-item">
            <div class="info-label">Médecin</div>
            <div class="info-value">${docName(patient.docId) || '—'}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Centre</div>
            <div class="info-value">${centerName(patient.centerId) || '—'}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Protocole / Matériel</div>
            <div class="info-value">${protoName(patient.protoId) || '—'}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Date de renouvellement</div>
            <div class="info-value">${patient.renewalDate || '—'}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Cycle</div>
            <div class="info-value">${cycleLabel}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Score de qualité</div>
            <div class="info-value">
              <div style="display: flex; align-items: center; gap: 0.75rem;">
                <div class="progress" style="width: 120px; height: 8px;">
                  <div class="progress-bar" style="background: ${scoreColor}; width: ${score}%;"></div>
                </div>
                <span style="font-weight: 600; color: ${scoreColor};">${score}%</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Notes -->
      ${patient.notes ? `
      <div class="info-section">
        <h3 style="color: var(--primary); margin-bottom: 1rem; font-size: 1.25rem;">
          📝 Notes
        </h3>
        <div style="padding: 1rem; background: var(--bg-secondary); border-radius: var(--radius); border-left: 3px solid var(--primary);">
          ${patient.notes}
        </div>
      </div>
      ` : ''}
      
      <!-- Historique des événements -->
      ${patient.events && patient.events.length > 0 ? `
      <div class="info-section">
        <h3 style="color: var(--primary); margin-bottom: 1rem; font-size: 1.25rem;">
          📋 Historique des événements
        </h3>
        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
          ${patient.events.slice().reverse().map(e => {
            const date = new Date(e.date).toLocaleDateString('fr-FR', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });

            let icon = '📝';
            let color = 'var(--primary)';

            if (e.type === 'appointment_created') {
              icon = '📅';
              color = '#3b82f6';
            } else if (e.type === 'appointment_updated') {
              icon = '📝';
              color = '#8b5cf6';
            } else if (e.type === 'appointment_completed') {
              icon = '✅';
              color = 'var(--success)';
            } else if (e.type === 'switch_created') {
              icon = '🔄';
              color = '#f59e0b';
            } else if (e.type === 'switch_updated') {
              icon = '📝';
              color = '#f59e0b';
            } else if (e.type === 'switch_completed') {
              icon = '✅';
              color = 'var(--success)';
            } else if (e.type === 'temporary_pause') {
              icon = '⏸️';
              color = '#f59e0b';
            } else if (e.type === 'permanent_pause') {
              icon = '⛔';
              color = '#ef4444';
            } else if (e.type === 'patient_reactivated') {
              icon = '▶️';
              color = 'var(--success)';
            }

            return `
              <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: var(--radius); border-left: 3px solid ${color}; display: flex; gap: 1rem; align-items: start;">
                <span style="font-size: 1.5rem; flex-shrink: 0;">${icon}</span>
                <div style="flex: 1;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                    <strong style="color: ${color};">${escapeHtml(e.description)}</strong>
                    <span style="font-size: 0.85rem; color: var(--text-muted);">${date}</span>
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
      ` : ''}

      <!-- Historique des modifications -->
      ${patient.history && patient.history.length > 0 ? `
      <div class="info-section">
        <h3 style="color: var(--primary); margin-bottom: 1rem; font-size: 1.25rem;">
          📜 Historique des modifications
        </h3>
        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
          ${patient.history.slice().reverse().map(h => {
            const date = new Date(h.date).toLocaleDateString('fr-FR', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });

            let icon = '📝';
            let color = 'var(--primary)';

            if (h.type === 'created') {
              icon = '✨';
              color = 'var(--success)';
            } else if (h.type === 'switch') {
              icon = '🔄';
              color = 'var(--warning)';
            } else if (h.type === 'protocol') {
              icon = '💊';
              color = 'var(--info)';
            } else if (h.type === 'doctor') {
              icon = '👨‍⚕️';
              color = 'var(--primary)';
            } else if (h.type === 'center') {
              icon = '🏥';
              color = 'var(--primary)';
            } else if (h.type === 'renewal') {
              icon = '📅';
              color = 'var(--secondary)';
            }

            return `
              <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: var(--radius); border-left: 3px solid ${color}; display: flex; gap: 1rem; align-items: start;">
                <span style="font-size: 1.5rem; flex-shrink: 0;">${icon}</span>
                <div style="flex: 1;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                    <strong style="color: ${color};">${h.field}</strong>
                    <span style="font-size: 0.85rem; color: var(--text-muted);">${date}</span>
                  </div>
                  ${h.type === 'created' ? `
                    <div style="font-size: 0.9rem; color: var(--text-secondary);">${h.newValue}</div>
                  ` : `
                    <div style="font-size: 0.9rem; color: var(--text-secondary);">
                      <span style="text-decoration: line-through; opacity: 0.7;">${h.oldValue}</span>
                      <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20" style="vertical-align: middle; margin: 0 0.5rem;">
                        <path fill-rule="evenodd" d="M10.293 15.707a1 1 0 010-1.414L14.586 10l-4.293-4.293a1 1 0 111.414-1.414l5 5a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                      </svg>
                      <span style="font-weight: 600;">${h.newValue}</span>
                    </div>
                  `}
                  ${h.notes ? `<div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.25rem;"><em>${h.notes}</em></div>` : ''}
                </div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
      ` : ''}
      
      <!-- Dates de gestion -->
      <div class="info-section">
        <h3 style="color: var(--text-muted); margin-bottom: 0.5rem; font-size: 0.9rem;">
          ℹ️ Informations système
        </h3>
        <div style="display: flex; gap: 2rem; color: var(--text-muted); font-size: 0.85rem;">
          <div>Créé le : ${patient.createdAt ? new Date(patient.createdAt).toLocaleDateString('fr-FR') : '—'}</div>
          <div>Modifié le : ${patient.updatedAt ? new Date(patient.updatedAt).toLocaleDateString('fr-FR') : '—'}</div>
        </div>
      </div>
    </div>
  `;
  
  // Store patient ID for edit button
  byId('btnEditFromDetails').onclick = () => {
    showModal(false, 'patientDetailsModal');
    openPatient(id);
  };

  // Attacher les événements pour les boutons d'ordonnance
  const btnViewOrdonnance = byId('btnViewOrdonnance');
  const btnGenerateFromDetails = byId('btnGenerateFromDetails');

  // Bouton "Ordonnance" - ouvrir l'ordonnance externe
  btnViewOrdonnance.onclick = () => {
    if (!patient.patientCode) {
      showToast('Code patient non défini', 'warning');
      return;
    }
    const url = `https://documentsnhc.proginov.fr/fiche-patient/xpatient${patient.patientCode}.html`;
    window.open(url, '_blank');
    showToast('Ordonnance ouverte dans un nouvel onglet', 'success');
  };

  // Bouton "Générer Ordonnance" - ouvrir le modal de génération
  btnGenerateFromDetails.onclick = () => {
    showModal(false, 'patientDetailsModal');
    openGeneratePrescriptionModal();
  };

  // Gérer l'état du bouton Ordonnance
  if (patient.patientCode) {
    btnViewOrdonnance.disabled = false;
  } else {
    btnViewOrdonnance.disabled = true;
  }

  showModal(true, 'patientDetailsModal');
}

function openPatient(id) {
  const patient = state.patients.find(p => p.id === id);
  if (!patient) return;

  currentPatientId = id;
  byId('modalTitle').textContent = 'Modifier le patient';
  byId('btnDeletePatient').classList.remove('hidden');
  byId('btnChangeStatus').classList.remove('hidden');
  byId('btnGeneratePrescription').classList.remove('hidden');

  // Populate selects FIRST so options are available
  populateSelects();

  // Make selects searchable
  setTimeout(() => {
    makeSelectSearchable('docId', () => state.docs, (d) => d.name, 'Rechercher un médecin...');
    makeSelectSearchable('centerId', () => state.centers, (c) => c.name, 'Rechercher un centre...');
    makeSelectSearchable('protoId', () => state.protos, (p) => p.name, 'Rechercher un protocole...');
  }, 0);

  // Fill form with patient data
  Object.keys(patient).forEach(key => {
    const el = byId(key);
    if (el) el.value = patient[key] || '';
  });

  // IMPORTANT: Synchronize searchable select inputs after filling form data
  // This ensures that the visible search inputs display the correct values
  // The MutationObserver only watches attribute changes, not property changes
  setTimeout(() => {
    syncSearchableSelect('docId', () => state.docs, (d) => d.name);
    syncSearchableSelect('centerId', () => state.centers, (c) => c.name);
    syncSearchableSelect('protoId', () => state.protos, (p) => p.name);
  }, 0);

  updateCycleInfo();
  showModal(true);
}

function suggestRenewalDate() {
  const currentDate = byId('renewalDate').value;
  const suggestion = suggestNextRenewalDate(currentDate);
  byId('renewalDate').value = suggestion;
  updateCycleInfo();
  showToast(`Date suggérée: ${suggestion}`, 'info');
}

function updateCycleInfo() {
  const dateStr = byId('renewalDate').value;
  const cycleInfo = getCycleFromDate(dateStr);
  const infoEl = byId('cycleInfo');
  
  if (cycleInfo && infoEl) {
    infoEl.innerHTML = `
      <strong style="color: var(--primary);">${cycleInfo.name} ${cycleInfo.year}</strong> - ${cycleInfo.label}<br>
      Date de fin: ${formatDateFR(new Date(cycleInfo.year, cycleInfo.months[cycleInfo.months.length - 1], 0))}
    `;
  } else if (infoEl) {
    infoEl.textContent = 'Le cycle sera calculé automatiquement selon la date';
  }
}

function savePatient() {
  const formData = {
    lastName: byId('lastName').value.trim(),
    firstName: byId('firstName').value.trim(),
    dob: byId('dob').value,
    email: byId('email').value.trim(),
    phone: byId('phone').value.trim(),
    address: byId('address').value.trim(),
    patientCode: byId('patientCode').value.trim(),
    docId: byId('docId').value,
    centerId: byId('centerId').value,
    protoId: byId('protoId').value,
    renewalDate: byId('renewalDate').value.trim(),
    notes: byId('notes').value.trim()
  };
  
  if (!formData.lastName || !formData.firstName) {
    showToast('Nom et prénom requis', 'error');
    return;
  }
  
  // Validate renewal date format
  if (formData.renewalDate && !formData.renewalDate.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
    showToast('Format de date invalide (JJ/MM/AAAA)', 'error');
    return;
  }
  
  if (currentPatientId) {
    // Update
    const index = state.patients.findIndex(p => p.id === currentPatientId);
    if (index !== -1) {
      const oldPatient = state.patients[index];
      
      // Initialize history array if it doesn't exist
      if (!oldPatient.history) {
        oldPatient.history = [];
      }
      
      // Track changes
      const changes = [];
      const now = Date.now();
      
      if (oldPatient.protoId !== formData.protoId) {
        changes.push({
          date: now,
          type: 'protocol',
          field: 'Protocole/Matériel',
          oldValue: protoName(oldPatient.protoId) || 'Non défini',
          newValue: protoName(formData.protoId) || 'Non défini'
        });
      }
      
      if (oldPatient.docId !== formData.docId) {
        changes.push({
          date: now,
          type: 'doctor',
          field: 'Médecin',
          oldValue: docName(oldPatient.docId) || 'Non défini',
          newValue: docName(formData.docId) || 'Non défini'
        });
      }
      
      if (oldPatient.centerId !== formData.centerId) {
        changes.push({
          date: now,
          type: 'center',
          field: 'Centre',
          oldValue: centerName(oldPatient.centerId) || 'Non défini',
          newValue: centerName(formData.centerId) || 'Non défini'
        });
      }
      
      if (oldPatient.renewalDate !== formData.renewalDate) {
        changes.push({
          date: now,
          type: 'renewal',
          field: 'Date de renouvellement',
          oldValue: oldPatient.renewalDate || 'Non définie',
          newValue: formData.renewalDate || 'Non définie'
        });
      }
      
      // Add changes to history
      if (changes.length > 0) {
        state.patients[index].history = [...(oldPatient.history || []), ...changes];
      }
      
      state.patients[index] = { 
        ...state.patients[index], 
        ...formData, 
        updatedAt: now
      };
      showToast('Patient modifié', 'success');
    }
  } else {
    // Create
    const newPatient = {
      id: generateId(),
      ...formData,
      createdAt: Date.now(),
      updatedAt: Date.now(),
      history: [{
        date: Date.now(),
        type: 'created',
        field: 'Création',
        oldValue: '',
        newValue: 'Patient créé'
      }]
    };
    state.patients.push(newPatient);
    showToast('Patient créé', 'success');
  }
  
  saveDB();
  render();
  showModal(false);
}

function deletePatient() {
  if (!currentPatientId) return;
  
  if (confirm('Supprimer ce patient ?')) {
    state.patients = state.patients.filter(p => p.id !== currentPatientId);
    saveDB();
    render();
    showModal(false);
    showToast('Patient supprimé', 'success');
  }
}

function pausePatient(patientId, pauseType) {
  const patient = state.patients.find(p => p.id === patientId);
  if (!patient) return;
  
  const typeLabel = pauseType === 'temporary_pause' ? 'temporaire' : 'définitif';
  const icon = pauseType === 'temporary_pause' ? '⏸️' : '⛔';
  const color = pauseType === 'temporary_pause' ? '#f59e0b' : '#ef4444';
  
  // Close modals
  showModal(false);
  closeStatusModal();
  
  // Create pause modal
  const existingModal = byId('pauseModal');
  if (existingModal) existingModal.remove();
  
  const modal = document.createElement('div');
  modal.id = 'pauseModal';
  modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 99999;';
  
  const today = new Date().toISOString().split('T')[0];
  
  modal.innerHTML = `
    <div style="background: var(--bg-primary); border-radius: var(--radius-lg); max-width: 500px; width: 90%; box-shadow: var(--shadow-xl);">
      <div style="padding: 1.5rem;">
        <h3 style="margin-bottom: 1rem; color: ${color}; display: flex; align-items: center; gap: 0.5rem;">
          <span style="font-size: 1.5rem;">${icon}</span>
          Arrêt ${typeLabel}
        </h3>
        <p style="margin-bottom: 1.5rem; color: var(--text-secondary);">
          <strong>${fullName(patient)}</strong>
        </p>
        
        <div style="display: flex; flex-direction: column; gap: 1rem;">
          <div>
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">
              Date d'arrêt <span style="color: #ef4444;">*</span>
            </label>
            <input type="date" id="pauseDate" value="${today}" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-primary); color: var(--text-primary);" required>
          </div>
          
          <div>
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">
              Raison (optionnel)
            </label>
            <textarea id="pauseReason" rows="3" placeholder="Ex: Hospitalisation, Vacances, Déménagement..." style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-primary); color: var(--text-primary); resize: vertical;"></textarea>
          </div>
        </div>
      </div>
      
      <div style="padding: 0 1.5rem 1.5rem; display: flex; gap: 0.5rem; justify-content: flex-end;">
        <button class="btn btn-secondary" id="btnCancelPause">Annuler</button>
        <button class="btn" id="btnConfirmPause" style="background: ${color}; color: white;">
          ${icon} Confirmer l'arrêt
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Focus on reason field
  setTimeout(() => byId('pauseReason')?.focus(), 100);
  
  // Event listeners
  byId('btnCancelPause').addEventListener('click', () => modal.remove());
  
  byId('btnConfirmPause').addEventListener('click', () => {
    const dateInput = byId('pauseDate');
    const reasonInput = byId('pauseReason');
    
    if (!dateInput.value) {
      showToast('Veuillez sélectionner une date', 'warning');
      dateInput.focus();
      return;
    }
    
    const selectedDate = new Date(dateInput.value + 'T12:00:00');

    patient.status = pauseType;
    patient.pausedAt = selectedDate.getTime();
    patient.pauseReason = reasonInput.value.trim() || '';
    patient.updatedAt = Date.now();

    // Add event to patient history
    const pauseLabel = pauseType === 'temporary_pause' ? 'Arrêt temporaire' : 'Arrêt définitif';
    const reasonText = reasonInput.value.trim() ? ` - Raison : ${reasonInput.value.trim()}` : '';
    addPatientEvent(patientId, pauseType, `${pauseLabel} du patient${reasonText}`, {
      pauseType: pauseType,
      pausedAt: selectedDate.getTime(),
      pauseReason: reasonInput.value.trim() || ''
    });

    saveDB();
    render();
    modal.remove();

    showToast(`${icon} Patient mis en arrêt ${typeLabel}`, 'success');
  });
  
  // Close on background click
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.remove();
    }
  });
  
  // Close on Escape
  const escHandler = (e) => {
    if (e.key === 'Escape') {
      modal.remove();
      document.removeEventListener('keydown', escHandler);
    }
  };
  document.addEventListener('keydown', escHandler);
}

function reactivatePatient(patientId) {
  const patient = state.patients.find(p => p.id === patientId);
  if (!patient) return;
  
  // Create reactivation modal
  const existingModal = byId('reactivateModal');
  if (existingModal) existingModal.remove();
  
  const modal = document.createElement('div');
  modal.id = 'reactivateModal';
  modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 99999;';
  
  const today = new Date().toISOString().split('T')[0];
  const pauseDate = patient.pausedAt ? new Date(patient.pausedAt).toLocaleDateString('fr-FR') : 'N/A';
  const statusLabel = patient.status === 'temporary_pause' ? '⏸️ Arrêt temporaire' : '⛔ Arrêt définitif';
  
  modal.innerHTML = `
    <div style="background: var(--bg-primary); border-radius: var(--radius-lg); max-width: 500px; width: 90%; box-shadow: var(--shadow-xl);">
      <div style="padding: 1.5rem;">
        <h3 style="margin-bottom: 1rem; color: var(--success); display: flex; align-items: center; gap: 0.5rem;">
          <span style="font-size: 1.5rem;">✅</span>
          Réactiver le patient
        </h3>
        <p style="margin-bottom: 1rem; color: var(--text-secondary);">
          <strong>${fullName(patient)}</strong>
        </p>
        
        <div style="background: var(--bg-secondary); padding: 1rem; border-radius: var(--radius); margin-bottom: 1rem;">
          <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Statut actuel</div>
          <div style="font-weight: 600;">${statusLabel}</div>
          <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.25rem;">Depuis le ${pauseDate}</div>
          ${patient.pauseReason ? `<div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.25rem; font-style: italic;">Raison : ${patient.pauseReason}</div>` : ''}
        </div>
        
        <div style="display: flex; flex-direction: column; gap: 1rem;">
          <div>
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">
              Date de réactivation <span style="color: #ef4444;">*</span>
            </label>
            <input type="date" id="reactivateDate" value="${today}" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-primary); color: var(--text-primary);" required>
          </div>
          
          <div>
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">
              Notes (optionnel)
            </label>
            <textarea id="reactivateNotes" rows="2" placeholder="Ex: Retour après hospitalisation, fin des vacances..." style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-primary); color: var(--text-primary); resize: vertical;"></textarea>
          </div>
        </div>
      </div>
      
      <div style="padding: 0 1.5rem 1.5rem; display: flex; gap: 0.5rem; justify-content: flex-end;">
        <button class="btn btn-secondary" id="btnCancelReactivate">Annuler</button>
        <button class="btn btn-success" id="btnConfirmReactivate">
          ✅ Confirmer la réactivation
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Focus on notes field
  setTimeout(() => byId('reactivateNotes')?.focus(), 100);
  
  // Event listeners
  byId('btnCancelReactivate').addEventListener('click', () => modal.remove());
  
  byId('btnConfirmReactivate').addEventListener('click', () => {
    const dateInput = byId('reactivateDate');
    const notesInput = byId('reactivateNotes');
    
    if (!dateInput.value) {
      showToast('Veuillez sélectionner une date', 'warning');
      dateInput.focus();
      return;
    }
    
    const selectedDate = new Date(dateInput.value + 'T12:00:00');

    const previousStatus = patient.status;
    patient.status = 'active';
    patient.reactivatedAt = selectedDate.getTime();
    patient.reactivateNotes = notesInput.value.trim() || '';
    patient.updatedAt = Date.now();

    // Add event to patient history
    const wasTemporary = previousStatus === 'temporary_pause';
    const statusLabel = wasTemporary ? 'arrêt temporaire' : 'arrêt définitif';
    const notesText = notesInput.value.trim() ? ` - ${notesInput.value.trim()}` : '';
    addPatientEvent(patientId, 'patient_reactivated', `Réactivation du patient (après ${statusLabel})${notesText}`, {
      previousStatus: previousStatus,
      reactivatedAt: selectedDate.getTime(),
      notes: notesInput.value.trim() || ''
    });

    saveDB();
    render();
    modal.remove();

    // Close status modal if open
    closeStatusModal();

    showToast('✅ Patient réactivé', 'success');
  });
  
  // Close on background click
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.remove();
    }
  });
  
  // Close on Escape
  const escHandler = (e) => {
    if (e.key === 'Escape') {
      modal.remove();
      document.removeEventListener('keydown', escHandler);
    }
  };
  document.addEventListener('keydown', escHandler);
}

function changePatientStatus() {
  console.log('changePatientStatus called, currentPatientId:', currentPatientId);
  
  if (!currentPatientId) {
    console.error('No currentPatientId');
    showToast('Erreur: Aucun patient sélectionné', 'error');
    return;
  }
  
  const patient = state.patients.find(p => p.id === currentPatientId);
  if (!patient) {
    console.error('Patient not found:', currentPatientId);
    showToast('Erreur: Patient non trouvé', 'error');
    return;
  }
  
  console.log('Patient found:', patient.lastName, patient.firstName);
  
  // Close the patient modal first
  const patientModal = byId('patientModal');
  if (patientModal) {
    patientModal.classList.remove('active');
  }
  
  const currentStatus = patient.status || 'active';
  const statusLabel = currentStatus === 'active' ? '✅ Actif' : 
                      currentStatus === 'temporary_pause' ? '⏸️ Arrêt temporaire' : 
                      '⛔ Arrêt définitif';
  
  // Remove existing modal if any
  const existingModal = byId('statusChangeModal');
  if (existingModal) existingModal.remove();
  
  // Create modal
  const modal = document.createElement('div');
  modal.id = 'statusChangeModal';
  modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 99999;';
  
  const modalContent = document.createElement('div');
  modalContent.style.cssText = 'background: var(--bg-primary); border-radius: var(--radius-lg); max-width: 500px; width: 90%; box-shadow: var(--shadow-xl);';
  modalContent.innerHTML = `
    <div style="padding: 1.5rem;">
      <h3 style="margin-bottom: 1rem; color: var(--primary);">Changer le statut du patient</h3>
      <p style="margin-bottom: 1rem; color: var(--text-secondary);">
        <strong>${fullName(patient)}</strong><br>
        Statut actuel : <strong>${statusLabel}</strong>
      </p>
      <div style="display: flex; flex-direction: column; gap: 0.75rem;">
        <button class="btn btn-success" id="btnStatusActive" style="justify-content: flex-start; width: 100%;">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
          Actif
        </button>
        <button class="btn btn-warning" id="btnStatusTemporary" style="justify-content: flex-start; width: 100%; background: #f59e0b;">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
          Arrêt temporaire
        </button>
        <button class="btn btn-danger" id="btnStatusPermanent" style="justify-content: flex-start; width: 100%;">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>
          Arrêt définitif
        </button>
      </div>
    </div>
    <div style="padding: 0 1.5rem 1.5rem; text-align: right;">
      <button class="btn btn-secondary" id="btnStatusCancel">Annuler</button>
    </div>
  `;
  
  modal.appendChild(modalContent);
  document.body.appendChild(modal);
  
  // Attach event listeners to buttons AFTER adding to DOM
  const btnActive = byId('btnStatusActive');
  const btnTemporary = byId('btnStatusTemporary');
  const btnPermanent = byId('btnStatusPermanent');
  const btnCancel = byId('btnStatusCancel');
  
  if (btnActive) {
    btnActive.addEventListener('click', () => {
      console.log('Active button clicked');
      handleStatusChange(currentPatientId, 'active');
    });
  }
  
  if (btnTemporary) {
    btnTemporary.addEventListener('click', () => {
      console.log('Temporary button clicked');
      handleStatusChange(currentPatientId, 'temporary_pause');
    });
  }
  
  if (btnPermanent) {
    btnPermanent.addEventListener('click', () => {
      console.log('Permanent button clicked');
      handleStatusChange(currentPatientId, 'permanent_pause');
    });
  }
  
  if (btnCancel) {
    btnCancel.addEventListener('click', () => {
      console.log('Cancel button clicked');
      closeStatusModal();
    });
  }
  
  // Close on background click
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.remove();
    }
  });
  
  console.log('Status modal created and displayed with event listeners');
}

function closeStatusModal() {
  const modal = byId('statusChangeModal');
  if (modal) modal.remove();
}

function handleStatusChange(patientId, newStatus) {
  console.log('handleStatusChange called:', patientId, newStatus);
  
  const patient = state.patients.find(p => p.id === patientId);
  if (!patient) {
    console.error('Patient not found in handleStatusChange');
    return;
  }
  
  const currentStatus = patient.status || 'active';
  
  // Close the status modal
  closeStatusModal();
  
  // If already in this status, just show message
  if (currentStatus === newStatus) {
    showToast('Le patient est déjà dans ce statut', 'info');
    return;
  }
  
  // If setting to active, call reactivate
  if (newStatus === 'active') {
    reactivatePatient(patientId);
  } else {
    // Ask for pause reason
    pausePatient(patientId, newStatus);
  }
}

function populateSelects() {
  // Doctors
  const docSelect = byId('docId');
  if (docSelect) {
    const current = docSelect.value;
    docSelect.innerHTML = '<option value="">-- Sélectionner --</option>' +
      state.docs.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
    docSelect.value = current;
  }
  
  // Centers
  const centerSelect = byId('centerId');
  if (centerSelect) {
    const current = centerSelect.value;
    centerSelect.innerHTML = '<option value="">-- Sélectionner --</option>' +
      state.centers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    centerSelect.value = current;
  }
  
  // Protocols
  const protoSelect = byId('protoId');
  if (protoSelect) {
    const current = protoSelect.value;
    protoSelect.innerHTML = '<option value="">-- Sélectionner --</option>' +
      state.protos.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
    protoSelect.value = current;
  }
}

// ===== Fast Check Functions =====
function fcOpen() {
  console.log('fcOpen called');
  console.log('state.patients:', state.patients);
  
  try {
    fcState.list = [...state.patients];
    fcState.index = 0;
    
    console.log('fcState.list:', fcState.list);
    
    if (fcState.list.length === 0) {
      showToast('Aucun patient à vérifier', 'warning');
      return;
    }
    
    fcDisplay();
    console.log('About to show fastModal');
    showModal(true, 'fastModal');
    console.log('fastModal should be shown');
  } catch (error) {
    console.error('Error in fcOpen:', error);
    showToast('Erreur lors de l\'ouverture du Fast Check', 'error');
  }
}

function fcDisplay() {
  if (fcState.index >= fcState.list.length) {
    fcClose();
    showToast('Vérification terminée !', 'success');
    return;
  }
  
  const patient = fcState.list[fcState.index];
  byId('fcPatient').textContent = fullName(patient);
  byId('fcOrdo').value = patient.renewalDate || '';
  byId('fcCycle').textContent = formatCycleLabel(patient.renewalDate || '') || '—';
  byId('fcIndex').textContent = fcState.index + 1;
  byId('fcTotal').textContent = fcState.list.length;
  
  // Afficher le code patient
  const codeDisplay = byId('fcCodeDisplay');
  const codeInput = byId('fcCodeInput');
  const btnOrdonnance = byId('fcOrdonnance');
  const btnEditCode = byId('fcEditCode');
  const btnSaveCode = byId('fcSaveCode');
  const codeInputContainer = byId('fcCodeInputContainer');
  
  if (patient.patientCode) {
    codeDisplay.textContent = patient.patientCode;
    codeInput.value = patient.patientCode;
    btnOrdonnance.disabled = false;
  } else {
    codeDisplay.textContent = 'Non défini';
    codeInput.value = '';
    btnOrdonnance.disabled = true;
  }
  
  // Réinitialiser l'affichage du formulaire de code
  codeInputContainer.style.display = 'none';
  btnEditCode.classList.remove('hidden');
  btnSaveCode.classList.add('hidden');
  
  const progress = ((fcState.index + 1) / fcState.list.length) * 100;
  byId('fcProgress').style.width = progress + '%';
  
  byId('fcCorrect').classList.remove('hidden');
  byId('fcUpdate').classList.add('hidden');
}

function fcPrev() {
  if (fcState.index > 0) {
    fcState.index--;
    fcDisplay();
  }
}

function fcNext() {
  fcState.index++;
  fcDisplay();
}

function fcCorrect() {
  const patient = fcState.list[fcState.index];
  // Vider le champ pour permettre une nouvelle saisie
  byId('fcOrdo').value = '';
  byId('fcOrdo').focus();
  byId('fcCorrect').classList.add('hidden');
  byId('fcUpdate').classList.remove('hidden');
}

function fcUpdate() {
  const patient = fcState.list[fcState.index];
  const newDate = byId('fcOrdo').value.trim();
  
  const realIndex = state.patients.findIndex(p => p.id === patient.id);
  if (realIndex !== -1) {
    state.patients[realIndex].renewalDate = newDate;
    saveDB();
  }
  
  fcNext();
}

function fcClose() {
  showModal(false, 'fastModal');
  render();
}

function fcCopy() {
  const patient = fcState.list[fcState.index];
  const name = fullName(patient);
  
  // Copier dans le presse-papier
  navigator.clipboard.writeText(name).then(() => {
    showToast(`"${name}" copié dans le presse-papier`, 'success');
  }).catch(() => {
    // Fallback pour les navigateurs qui ne supportent pas l'API clipboard
    const textarea = document.createElement('textarea');
    textarea.value = name;
    textarea.style.position = 'fixed';
    textarea.style.opacity = '0';
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
    showToast(`"${name}" copié dans le presse-papier`, 'success');
  });
}

function fcEditCode() {
  const codeInputContainer = byId('fcCodeInputContainer');
  const btnEditCode = byId('fcEditCode');
  const btnSaveCode = byId('fcSaveCode');
  
  codeInputContainer.style.display = 'block';
  btnEditCode.classList.add('hidden');
  btnSaveCode.classList.remove('hidden');
  byId('fcCodeInput').focus();
}

function fcSaveCode() {
  const patient = fcState.list[fcState.index];
  const newCode = byId('fcCodeInput').value.trim();
  
  // Trouver le patient dans la liste principale et mettre à jour
  const realIndex = state.patients.findIndex(p => p.id === patient.id);
  if (realIndex !== -1) {
    state.patients[realIndex].patientCode = newCode;
    patient.patientCode = newCode;
    saveDB();
  }
  
  // Mettre à jour l'affichage
  byId('fcCodeDisplay').textContent = newCode || 'Non défini';
  byId('fcOrdonnance').disabled = !newCode;
  
  // Cacher le formulaire d'édition
  byId('fcCodeInputContainer').style.display = 'none';
  byId('fcEditCode').classList.remove('hidden');
  byId('fcSaveCode').classList.add('hidden');
  
  showToast(newCode ? 'Code patient enregistré' : 'Code patient supprimé', 'success');
}

function fcOpenOrdonnance() {
  const patient = fcState.list[fcState.index];
  
  if (!patient.patientCode) {
    showToast('Code patient non défini', 'warning');
    return;
  }
  
  const url = `https://documentsnhc.proginov.fr/fiche-patient/xpatient${patient.patientCode}.html`;
  window.open(url, '_blank');
  showToast('Ordonnance ouverte dans un nouvel onglet', 'success');
}

// ===== Fast Create Ordo Functions =====
let fcoState = {
  list: [], // Liste des patients du cycle
  index: 0, // Index du patient actuel
  prescriptions: [], // Stockage des configurations d'ordonnance pour chaque patient
  selectedCycle: null // Cycle sélectionné
};

function getNextCycles(count = 3) {
  const cycles = [];
  const currentDate = new Date();
  const currentMonth = currentDate.getMonth() + 1; // 1-12
  const currentYear = currentDate.getFullYear();

  // Find current cycle
  let currentCycle = null;
  for (const [cycleNum, cycleInfo] of Object.entries(CYCLES)) {
    if (cycleInfo.months.includes(currentMonth)) {
      currentCycle = parseInt(cycleNum);
      break;
    }
  }

  if (!currentCycle) return cycles;

  // Generate the next 'count' cycles
  for (let i = 0; i < count; i++) {
    const cycleOffset = currentCycle - 1 + i; // 0-based for calculation
    const cycle = (cycleOffset % 3) + 1; // 1, 2, or 3
    const yearOffset = Math.floor(cycleOffset / 3);
    const year = currentYear + yearOffset;

    const cycleInfo = CYCLES[cycle];
    cycles.push({
      cycle: cycle,
      year: year,
      name: cycleInfo.name,
      label: cycleInfo.label,
      months: cycleInfo.months,
      color: cycleInfo.color,
      id: `C${cycle}-${year}`,
      displayLabel: `${cycleInfo.name} ${year} (${cycleInfo.label})`
    });
  }

  return cycles;
}

function fcoOpen() {
  console.log('fcoOpen called');

  try {
    // Show cycle selection modal
    fcoShowCycleSelection();
  } catch (error) {
    console.error('Error in fcoOpen:', error);
    showToast('Erreur lors de l\'ouverture du Fast Create Ordo', 'error');
  }
}

function fcoShowCycleSelection() {
  const cyclesContainer = byId('fcoCycleOptions');
  if (!cyclesContainer) return;

  // Get next 3 cycles
  const cycles = getNextCycles(3);
  console.log('Available cycles:', cycles);

  // Clear existing options
  cyclesContainer.innerHTML = '';

  // Create buttons for each cycle
  cycles.forEach((cycle, index) => {
    // Count patients in this cycle
    const patientsInCycle = state.patients.filter(p => {
      const renewalDate = p.renewalDate;
      if (!renewalDate) return false;
      const cycleInfo = getCycleFromDate(renewalDate);
      if (!cycleInfo) return false;
      return cycleInfo.cycle === cycle.cycle && cycleInfo.year === cycle.year;
    });

    const button = document.createElement('button');
    button.className = 'btn btn-lg';
    button.style.cssText = `
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      padding: 1.5rem;
      gap: 0.5rem;
      background: ${index === 0 ? 'var(--primary)' : 'var(--bg-secondary)'};
      color: ${index === 0 ? 'white' : 'var(--text)'};
      border: 2px solid ${index === 0 ? 'var(--primary)' : 'var(--border)'};
      transition: all 0.2s;
    `;

    button.innerHTML = `
      <div style="display: flex; align-items: center; gap: 0.75rem; width: 100%;">
        <span style="font-size: 2rem;">${index === 0 ? '🎯' : index === 1 ? '📅' : '🔮'}</span>
        <div style="flex: 1; text-align: left;">
          <div style="font-weight: 600; font-size: 1.1rem;">${cycle.displayLabel}</div>
          <div style="font-size: 0.9rem; opacity: 0.8; margin-top: 0.25rem;">
            ${patientsInCycle.length} patient${patientsInCycle.length > 1 ? 's' : ''}
            ${index === 0 ? '· Cycle actuel' : index === 1 ? '· Cycle suivant' : ''}
          </div>
        </div>
        <svg width="24" height="24" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
        </svg>
      </div>
    `;

    button.onmouseover = () => {
      if (index !== 0) {
        button.style.background = 'var(--bg-hover)';
        button.style.borderColor = 'var(--primary)';
      }
    };

    button.onmouseout = () => {
      if (index !== 0) {
        button.style.background = 'var(--bg-secondary)';
        button.style.borderColor = 'var(--border)';
      }
    };

    button.onclick = () => fcoSelectCycle(cycle);

    cyclesContainer.appendChild(button);
  });

  showModal(true, 'fcoCycleSelectionModal');
}

function fcoSelectCycle(cycle) {
  console.log('Cycle selected:', cycle);
  fcoState.selectedCycle = cycle;

  // Filter patients for this cycle
  const patientsInCycle = state.patients.filter(p => {
    const renewalDate = p.renewalDate;
    if (!renewalDate) return false;
    const cycleInfo = getCycleFromDate(renewalDate);
    if (!cycleInfo) return false;
    return cycleInfo.cycle === cycle.cycle && cycleInfo.year === cycle.year;
  });

  console.log('Patients in cycle:', patientsInCycle.length);

  if (patientsInCycle.length === 0) {
    showToast(`Aucun patient dans le ${cycle.displayLabel}`, 'warning');
    showModal(false, 'fcoCycleSelectionModal');
    return;
  }

  fcoState.list = patientsInCycle;
  fcoState.index = 0;
  fcoState.prescriptions = [];

  // Close cycle selection modal
  showModal(false, 'fcoCycleSelectionModal');

  // Populate template select
  fcoPopulateTemplates();

  // Show Fast Create Ordo modal
  fcoDisplay();
  showModal(true, 'fastCreateOrdoModal');
}

function fcoPopulateTemplates() {
  const select = byId('fcoTemplate');
  if (!select) return;

  // Clear existing options except the first one
  select.innerHTML = '<option value="">Sélectionner un template...</option>';

  // Only add uploaded Word templates (not default PDF template)
  if (state.prescriptionTemplates && state.prescriptionTemplates.length > 0) {
    state.prescriptionTemplates.forEach(template => {
      const option = document.createElement('option');
      option.value = template.id;
      option.textContent = template.name;
      select.appendChild(option);
    });

    // Select first available template
    if (select.options.length > 1) {
      select.selectedIndex = 1;
    }
  } else {
    // Show message if no templates available
    const noTemplateOption = document.createElement('option');
    noTemplateOption.value = '';
    noTemplateOption.textContent = 'Aucun template disponible - Veuillez en créer un';
    noTemplateOption.disabled = true;
    select.appendChild(noTemplateOption);
  }
}

function fcoDisplay() {
  if (fcoState.index >= fcoState.list.length) {
    // Tous les patients ont été traités, générer le document
    fcoGenerateAll();
    return;
  }

  const patient = fcoState.list[fcoState.index];

  // Update patient name
  byId('fcoPatient').textContent = fullName(patient);

  // Set default dates
  const startDateInput = byId('fcoStartDate');
  const endDateInput = byId('fcoEndDate');

  // Use patient's renewal date as start date if available, otherwise use today
  let startDate;
  if (patient.renewalDate) {
    // Parse the renewal date from JJ/MM/AAAA format
    startDate = parseDateFR(patient.renewalDate);
  }

  // If no renewal date or parsing failed, use today
  if (!startDate) {
    startDate = new Date();
  }

  startDateInput.value = startDate.toISOString().split('T')[0];

  // Calculate end date based on duration (3 months by default)
  const duration = parseInt(document.querySelector('input[name="fcoDuration"]:checked')?.value || 3);
  const endDate = new Date(startDate);
  endDate.setMonth(endDate.getMonth() + duration);
  endDateInput.value = endDate.toISOString().split('T')[0];

  // Update progress
  byId('fcoIndex').textContent = fcoState.index + 1;
  byId('fcoTotal').textContent = fcoState.list.length;
  const progress = ((fcoState.index + 1) / fcoState.list.length) * 100;
  byId('fcoProgress').style.width = progress + '%';

  // Enable/disable prev button
  byId('fcoPrev').disabled = fcoState.index === 0;
}

function fcoUpdateEndDate() {
  const startDate = byId('fcoStartDate').value;
  if (!startDate) return;

  const duration = parseInt(document.querySelector('input[name="fcoDuration"]:checked')?.value || 3);
  const start = new Date(startDate);
  const end = new Date(start);
  end.setMonth(end.getMonth() + duration);

  byId('fcoEndDate').value = end.toISOString().split('T')[0];
}

function fcoNext() {
  fcoState.index++;
  fcoDisplay();
}

function fcoPrev() {
  if (fcoState.index > 0) {
    fcoState.index--;
    fcoDisplay();
  }
}

function fcoSkip() {
  // Skip this patient without adding prescription
  console.log('Skipping patient:', fullName(fcoState.list[fcoState.index]));
  fcoNext();
}

function fcoValidate() {
  const patient = fcoState.list[fcoState.index];
  const templateId = byId('fcoTemplate').value;
  const startDate = byId('fcoStartDate').value;
  const endDate = byId('fcoEndDate').value;
  const duration = parseInt(document.querySelector('input[name="fcoDuration"]:checked')?.value || 3);
  const formationInitiale = byId('fcoFormationInitiale').checked;

  // Validation
  if (!templateId) {
    showToast('Veuillez sélectionner un template', 'warning');
    return;
  }

  if (!startDate || !endDate) {
    showToast('Veuillez sélectionner les dates', 'warning');
    return;
  }

  // Store prescription configuration
  fcoState.prescriptions.push({
    patient: patient,
    templateId: templateId,
    startDate: startDate,
    endDate: endDate,
    duration: duration,
    formationInitiale: formationInitiale
  });

  console.log('Prescription validated for:', fullName(patient));

  // Move to next patient
  fcoNext();
}

function fcoClose() {
  showModal(false, 'fastCreateOrdoModal');
  fcoState = { list: [], index: 0, prescriptions: [], selectedCycle: null };
}

async function fcoGenerateAll() {
  console.log('Generating all prescriptions...');
  console.log('Total prescriptions to generate:', fcoState.prescriptions.length);

  if (fcoState.prescriptions.length === 0) {
    showToast('Aucune ordonnance à générer', 'warning');
    fcoClose();
    return;
  }

  try {
    showModal(false, 'fastCreateOrdoModal');
    showToast('Génération des ordonnances en cours...', 'info');

    // Load required libraries with proper error handling
    try {
      if (typeof window.PizZip === 'undefined') {
        console.log('Loading PizZip...');
        await loadScript('https://unpkg.com/pizzip@3.1.6/dist/pizzip.min.js');
        if (typeof window.PizZip === 'undefined') {
          throw new Error('PizZip failed to load');
        }
        console.log('PizZip loaded successfully');
      }
    } catch (err) {
      console.error('Error loading PizZip:', err);
      throw new Error('Impossible de charger la bibliothèque PizZip. Vérifiez votre connexion internet.');
    }

    try {
      if (typeof window.docxtemplater === 'undefined' && typeof window.Docxtemplater === 'undefined') {
        console.log('Loading docxtemplater...');
        await loadScript('https://unpkg.com/docxtemplater@3.45.0/build/docxtemplater.min.js');

        // Check both possible namespaces
        if (typeof window.docxtemplater !== 'undefined') {
          console.log('docxtemplater loaded as window.docxtemplater');
        } else if (typeof window.Docxtemplater !== 'undefined') {
          console.log('Docxtemplater loaded as window.Docxtemplater');
          window.docxtemplater = window.Docxtemplater; // Normalize
        } else {
          throw new Error('docxtemplater failed to load');
        }
        console.log('docxtemplater loaded successfully');
      }
    } catch (err) {
      console.error('Error loading docxtemplater:', err);
      throw new Error('Impossible de charger la bibliothèque docxtemplater. Vérifiez votre connexion internet.');
    }

    try {
      if (typeof window.saveAs === 'undefined') {
        console.log('Loading FileSaver...');
        await loadScript('https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js');
        if (typeof window.saveAs === 'undefined') {
          throw new Error('FileSaver failed to load');
        }
        console.log('FileSaver loaded successfully');
      }
    } catch (err) {
      console.error('Error loading FileSaver:', err);
      throw new Error('Impossible de charger la bibliothèque FileSaver. Vérifiez votre connexion internet.');
    }

    // Generate each prescription and combine them
    const prescriptionPages = [];

    for (let i = 0; i < fcoState.prescriptions.length; i++) {
      const config = fcoState.prescriptions[i];
      const patient = config.patient;

      console.log(`Generating prescription ${i + 1}/${fcoState.prescriptions.length} for ${fullName(patient)}`);

      // Get template
      let template = null;
      if (config.templateId !== 'default') {
        template = state.prescriptionTemplates.find(t => t.id === config.templateId);
      }

      if (template && template.fileData) {
        // Use uploaded template
        const pageData = await fcoGenerateSingleOrdonnance(patient, template, config);
        prescriptionPages.push({
          type: 'word',
          data: pageData,
          patient: fullName(patient)
        });
      }
    }

    // Combine all prescriptions into one document
    if (prescriptionPages.length > 0) {
      await fcoCombineWordDocuments(prescriptionPages);
      showToast(`${prescriptionPages.length} ordonnances générées avec succès !`, 'success');
    } else {
      showToast('Aucune ordonnance Word n\'a pu être générée', 'warning');
    }

    // Clean up
    fcoState = { list: [], index: 0, prescriptions: [], selectedCycle: null };

  } catch (error) {
    console.error('Error generating prescriptions:', error);
    showToast('Erreur lors de la génération des ordonnances: ' + error.message, 'error');
  }
}

async function fcoGenerateSingleOrdonnance(patient, template, config) {
  // Get doctor information
  const doctor = state.docs.find(d => d.id === patient.docId);
  const doctorName = doctor ? doctor.name : 'Dr. [Nom du médecin]';

  // Format dates
  const startDateFormatted = formatDateForDisplay(new Date(config.startDate));
  const endDateFormatted = formatDateForDisplay(new Date(config.endDate));
  const birthDateFormatted = patient.dob ? formatDateForDisplay(new Date(patient.dob)) : '';
  const currentDateFormatted = formatDateForDisplay(new Date());

  // Prepare data for template replacement
  const templateData = {
    // Médecin
    medecin_nom: doctorName,
    nom_medecin: doctorName,
    medecin: doctorName,
    doctor_name: doctorName,

    // Patient - nom complet
    patient_nom: patient.lastName || '',
    patient_prenom: patient.firstName || '',
    nom_patient: patient.lastName || '',
    prenom_patient: patient.firstName || '',
    patient_nom_complet: `${patient.firstName || ''} ${patient.lastName || ''}`.trim(),
    nom_complet: `${patient.firstName || ''} ${patient.lastName || ''}`.trim(),

    // Date de naissance
    patient_date_naissance: birthDateFormatted,
    date_naissance: birthDateFormatted,
    dob: birthDateFormatted,

    // Dates ordonnance
    date_debut: startDateFormatted,
    date_debut_ordonnance: startDateFormatted,
    start_date: startDateFormatted,

    date_fin: endDateFormatted,
    date_fin_ordonnance: endDateFormatted,
    end_date: endDateFormatted,

    // Date du jour
    date_jour: currentDateFormatted,
    date: currentDateFormatted,
    current_date: currentDateFormatted,

    // Autres informations utiles
    duree: config.duration + ' mois',
    duration: config.duration + ' months',
    patient_id: patient.nhcId || patient.id || '',
    cycle: patient.cycle || '',

    // Formation technique Initiale
    formation_initiale: config.formationInitiale ? 'X' : '',
    formation_technique_initiale: config.formationInitiale ? 'X' : '',
    fti: config.formationInitiale ? 'X' : ''
  };

  // Handle different fileData formats
  let base64Data;
  if (typeof template.fileData === 'string') {
    base64Data = template.fileData.includes(',')
      ? template.fileData.split(',')[1]
      : template.fileData;
  } else if (template.fileData && template.fileData.data) {
    base64Data = template.fileData.data;
  } else {
    throw new Error('Format de fichier invalide');
  }

  const binaryString = atob(base64Data);
  const bytes = new Uint8Array(binaryString.length);
  for (let i = 0; i < binaryString.length; i++) {
    bytes[i] = binaryString.charCodeAt(i);
  }

  // Load the docx file
  const zip = new window.PizZip(bytes);
  const doc = new window.docxtemplater(zip, {
    paragraphLoop: true,
    linebreaks: true,
    delimiters: {
      start: '{',
      end: '}'
    }
  });

  // Replace placeholders with data
  doc.render(templateData);

  // Return the zip data (not the blob yet)
  return doc.getZip();
}

async function fcoCombineWordDocuments(prescriptionPages) {
  // For now, we'll create individual files
  // Combining Word documents is complex and requires merging XML content

  console.log('Creating combined Word document with', prescriptionPages.length, 'pages');

  // Simple approach: Download each prescription separately
  for (let i = 0; i < prescriptionPages.length; i++) {
    const page = prescriptionPages[i];

    const output = page.data.generate({
      type: 'blob',
      mimeType: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
    });

    const fileName = `Ordonnance_${i + 1}_${page.patient.replace(/\s+/g, '_')}.docx`;
    window.saveAs(output, fileName);

    // Small delay between downloads to avoid browser blocking
    await new Promise(resolve => setTimeout(resolve, 500));
  }
}

// ===== Advanced Prescription Creation Functions =====
let apcState = {
  selectedCycle: null,
  allPatients: [],
  filteredPatients: [],
  selectedPatients: new Set(),
  selectedPatientsList: [],
  currentIndex: 0,
  prescriptions: [] // Store config for each patient
};

function openAdvancedPrescriptionCreation() {
  console.log('Opening Advanced Prescription Creation');

  // Reset state
  apcState = {
    selectedCycle: null,
    allPatients: [],
    filteredPatients: [],
    selectedPatients: new Set(),
    selectedPatientsList: [],
    currentIndex: 0,
    prescriptions: []
  };

  // Populate cycles
  apcPopulateCycles();

  // Populate filters
  apcPopulateFilters();

  // Populate templates
  apcPopulateTemplates();

  // Show selection view
  apcShowSelectionView();

  // Show modal
  showModal(true, 'advancedPrescriptionModal');
}

function apcShowSelectionView() {
  byId('apcSelectionView').style.display = 'block';
  byId('apcConfigView').style.display = 'none';
  byId('apcSelectionFooter').style.display = 'flex';
  byId('apcConfigFooter').style.display = 'none';
}

function apcShowConfigView() {
  byId('apcSelectionView').style.display = 'none';
  byId('apcConfigView').style.display = 'block';
  byId('apcSelectionFooter').style.display = 'none';
  byId('apcConfigFooter').style.display = 'flex';
}

function apcClose() {
  showModal(false, 'advancedPrescriptionModal');
}

function apcPopulateCycles() {
  const container = byId('apcCycleOptions');
  if (!container) return;

  container.innerHTML = '';

  const cycles = getNextCycles(3);

  cycles.forEach((cycle, index) => {
    const button = document.createElement('button');
    button.className = 'btn btn-sm';
    button.type = 'button';
    button.style.cssText = `
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.85rem;
      border: 2px solid var(--border);
      background: var(--bg-primary);
      transition: all 0.2s;
    `;

    button.innerHTML = `
      <div style="font-size: 1.5rem;">${index === 0 ? '❄️' : index === 1 ? '☀️' : '🍂'}</div>
      <div style="font-weight: 600;">${cycle.name}</div>
      <div style="font-size: 0.75rem; opacity: 0.7;">${cycle.year}</div>
    `;

    button.onclick = () => apcSelectCycle(cycle, button);

    container.appendChild(button);
  });
}

function apcSelectCycle(cycle, buttonElement) {
  console.log('Cycle selected:', cycle);

  apcState.selectedCycle = cycle;

  // Update button styles
  const allButtons = byId('apcCycleOptions').querySelectorAll('button');
  allButtons.forEach(btn => {
    btn.style.background = 'var(--bg-primary)';
    btn.style.borderColor = 'var(--border)';
    btn.style.color = 'var(--text-primary)';
  });

  buttonElement.style.background = 'var(--primary)';
  buttonElement.style.borderColor = 'var(--primary)';
  buttonElement.style.color = 'white';

  // Load patients for this cycle
  apcLoadPatients();
}

function apcLoadPatients() {
  if (!apcState.selectedCycle) {
    return;
  }

  const cycle = apcState.selectedCycle;

  // Filter patients for this cycle
  const patientsInCycle = state.patients.filter(p => {
    if (p.status === 'archived') return false;
    const renewalDate = p.renewalDate;
    if (!renewalDate) return false;
    const cycleInfo = getCycleFromDate(renewalDate);
    if (!cycleInfo) return false;
    return cycleInfo.cycle === cycle.cycle && cycleInfo.year === cycle.year;
  });

  apcState.allPatients = patientsInCycle;
  apcState.filteredPatients = patientsInCycle;

  console.log('Patients in cycle:', patientsInCycle.length);

  // Apply filters
  apcApplyFilters();
}

function apcPopulateFilters() {
  // Populate doctors
  const doctorSelect = byId('apcDoctorFilter');
  if (doctorSelect) {
    doctorSelect.innerHTML = '<option value="">Tous les médecins</option>';
    const doctors = [...new Set(state.patients.map(p => docName(p.docId)).filter(d => d))];
    doctors.sort().forEach(doc => {
      const option = document.createElement('option');
      option.value = doc;
      option.textContent = doc;
      doctorSelect.appendChild(option);
    });
  }

  // Populate centers
  const centerSelect = byId('apcCenterFilter');
  if (centerSelect) {
    centerSelect.innerHTML = '<option value="">Tous les centres</option>';
    state.centers.forEach(center => {
      const option = document.createElement('option');
      option.value = center.name;
      option.textContent = center.name;
      centerSelect.appendChild(option);
    });
  }

  // Populate protocols
  const protocolSelect = byId('apcProtocolFilter');
  if (protocolSelect) {
    protocolSelect.innerHTML = '<option value="">Tous les matériels</option>';
    state.protos.forEach(proto => {
      const option = document.createElement('option');
      option.value = proto.name;
      option.textContent = proto.name;
      protocolSelect.appendChild(option);
    });
  }
}

function apcApplyFilters() {
  if (!apcState.selectedCycle) {
    return;
  }

  const doctorFilter = byId('apcDoctorFilter').value;
  const centerFilter = byId('apcCenterFilter').value;
  const protocolFilter = byId('apcProtocolFilter').value;

  // Apply filters
  apcState.filteredPatients = apcState.allPatients.filter(p => {
    if (doctorFilter && docName(p.docId) !== doctorFilter) return false;
    if (centerFilter && centerName(p.centerId) !== centerFilter) return false;
    if (protocolFilter && protoName(p.protoId) !== protocolFilter) return false;
    return true;
  });

  console.log('Filtered patients:', apcState.filteredPatients.length);

  // Display patients
  apcDisplayPatients();
}

function apcDisplayPatients() {
  const container = byId('apcPatientsList');
  const countSpan = byId('apcPatientCount');

  if (!container || !countSpan) return;

  countSpan.textContent = apcState.filteredPatients.length;

  if (apcState.filteredPatients.length === 0) {
    container.innerHTML = '<p class="text-muted text-center" style="padding: 2rem;">Aucun patient ne correspond aux filtres</p>';
    return;
  }

  container.innerHTML = '';

  apcState.filteredPatients.forEach(patient => {
    const div = document.createElement('div');
    div.style.cssText = `
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.2s;
    `;

    div.onmouseover = () => div.style.background = 'var(--bg-tertiary)';
    div.onmouseout = () => div.style.background = 'transparent';

    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.id = `apc-patient-${patient.id}`;
    checkbox.checked = apcState.selectedPatients.has(patient.id);
    checkbox.onchange = () => {
      if (checkbox.checked) {
        apcState.selectedPatients.add(patient.id);
      } else {
        apcState.selectedPatients.delete(patient.id);
      }
    };

    const label = document.createElement('label');
    label.htmlFor = `apc-patient-${patient.id}`;
    label.style.cssText = 'flex: 1; cursor: pointer; display: flex; flex-direction: column; gap: 0.25rem;';
    label.innerHTML = `
      <div style="font-weight: 600;">${fullName(patient)}</div>
      <div style="font-size: 0.85rem; opacity: 0.7;">
        ${docName(patient.docId) || 'Sans médecin'} • ${protoName(patient.protoId) || 'Sans matériel'} • ${centerName(patient.centerId) || 'Sans centre'}
      </div>
    `;

    div.appendChild(checkbox);
    div.appendChild(label);
    container.appendChild(div);
  });
}

function apcSelectAll() {
  apcState.filteredPatients.forEach(p => apcState.selectedPatients.add(p.id));
  apcDisplayPatients();
}

function apcDeselectAll() {
  apcState.selectedPatients.clear();
  apcDisplayPatients();
}

function apcPopulateTemplates() {
  const select = byId('apcTemplate');
  if (!select) return;

  select.innerHTML = '<option value="">Sélectionner un template...</option>';

  // Add default template
  const defaultOption = document.createElement('option');
  defaultOption.value = 'default';
  defaultOption.textContent = 'Template par défaut';
  select.appendChild(defaultOption);

  // Add uploaded templates
  if (state.prescriptionTemplates && state.prescriptionTemplates.length > 0) {
    state.prescriptionTemplates.forEach(template => {
      const option = document.createElement('option');
      option.value = template.id;
      option.textContent = template.name;
      select.appendChild(option);
    });
  }

  // Select first available template
  if (select.options.length > 1) {
    select.selectedIndex = 1;
  }
}

function apcUpdateCurrentEndDate() {
  const startDate = byId('apcCurrentStartDate').value;
  if (!startDate) return;

  const duration = parseInt(document.querySelector('input[name="apcCurrentDuration"]:checked')?.value || '3');

  const start = new Date(startDate);
  const end = new Date(start);
  end.setMonth(end.getMonth() + duration);

  byId('apcCurrentEndDate').value = end.toISOString().split('T')[0];
}

function apcStartConfiguration() {
  if (!apcState.selectedCycle) {
    showToast('Veuillez sélectionner un cycle', 'warning');
    return;
  }

  if (apcState.selectedPatients.size === 0) {
    showToast('Veuillez sélectionner au moins un patient', 'warning');
    return;
  }

  // Get selected patients list
  apcState.selectedPatientsList = apcState.filteredPatients.filter(p =>
    apcState.selectedPatients.has(p.id)
  );

  apcState.currentIndex = 0;
  apcState.prescriptions = [];

  console.log('Starting configuration for', apcState.selectedPatientsList.length, 'patients');

  // Populate templates for config view
  const select = byId('apcCurrentTemplate');
  if (select) {
    select.innerHTML = '<option value="">Sélectionner un template...</option>';

    // Only add uploaded Word templates (not default PDF template)
    if (state.prescriptionTemplates && state.prescriptionTemplates.length > 0) {
      state.prescriptionTemplates.forEach(template => {
        const option = document.createElement('option');
        option.value = template.id;
        option.textContent = template.name;
        select.appendChild(option);
      });

      // Auto-select first template
      if (select.options.length > 1) {
        select.selectedIndex = 1;
      }
    } else {
      // Show message if no templates available
      const noTemplateOption = document.createElement('option');
      noTemplateOption.value = '';
      noTemplateOption.textContent = 'Aucun template disponible - Veuillez en créer un';
      noTemplateOption.disabled = true;
      select.appendChild(noTemplateOption);
    }
  }

  // Set up event listeners for config buttons
  byId('apcPrev').onclick = apcPrevious;
  byId('apcSkip').onclick = apcSkip;
  byId('apcValidate').onclick = apcValidate;

  // Switch to config view
  apcShowConfigView();

  // Display first patient
  apcDisplayCurrentPatient();
}

function apcDisplayCurrentPatient() {
  if (apcState.currentIndex >= apcState.selectedPatientsList.length) {
    // All patients configured, generate prescriptions
    apcGenerateAll();
    return;
  }

  const patient = apcState.selectedPatientsList[apcState.currentIndex];

  // Update patient name
  byId('apcCurrentPatient').textContent = fullName(patient);

  // Set default start date using patient's renewal date if available, otherwise use today
  let startDate;
  if (patient.renewalDate) {
    // Parse the renewal date from JJ/MM/AAAA format
    startDate = parseDateFR(patient.renewalDate);
  }

  // If no renewal date or parsing failed, use today
  if (!startDate) {
    startDate = new Date();
  }

  byId('apcCurrentStartDate').value = startDate.toISOString().split('T')[0];

  // Update end date
  apcUpdateCurrentEndDate();

  // Update progress
  byId('apcCurrentIndex').textContent = apcState.currentIndex + 1;
  byId('apcTotalCount').textContent = apcState.selectedPatientsList.length;

  const progress = ((apcState.currentIndex) / apcState.selectedPatientsList.length) * 100;
  byId('apcProgressBar').style.width = `${progress}%`;

  // Enable/disable prev button
  byId('apcPrev').disabled = apcState.currentIndex === 0;
}

function apcPrevious() {
  if (apcState.currentIndex > 0) {
    apcState.currentIndex--;
    apcDisplayCurrentPatient();
  }
}

function apcSkip() {
  apcState.currentIndex++;
  apcDisplayCurrentPatient();
}

function apcValidate() {
  const patient = apcState.selectedPatientsList[apcState.currentIndex];
  const templateId = byId('apcCurrentTemplate').value;
  const startDate = byId('apcCurrentStartDate').value;
  const endDate = byId('apcCurrentEndDate').value;
  const duration = parseInt(document.querySelector('input[name="apcCurrentDuration"]:checked')?.value || 3);
  const formationInitiale = byId('apcCurrentFormationInitiale').checked;

  if (!templateId) {
    showToast('Veuillez sélectionner un template', 'warning');
    return;
  }

  if (!startDate || !endDate) {
    showToast('Veuillez renseigner les dates', 'warning');
    return;
  }

  // Store configuration for this patient
  apcState.prescriptions.push({
    patient: patient,
    templateId: templateId,
    startDate: startDate,
    endDate: endDate,
    duration: duration,
    formationInitiale: formationInitiale
  });

  console.log('Stored config for', fullName(patient));

  // Move to next patient
  apcState.currentIndex++;
  apcDisplayCurrentPatient();
}

async function apcGenerateAll() {
  console.log('Generating', apcState.prescriptions.length, 'prescriptions');

  // Close modal
  showModal(false, 'advancedPrescriptionModal');

  if (apcState.prescriptions.length === 0) {
    showToast('Aucune ordonnance à générer', 'warning');
    return;
  }

  // Load required libraries with proper error handling
  try {
    if (typeof window.PizZip === 'undefined') {
      console.log('Loading PizZip...');
      await loadScript('https://unpkg.com/pizzip@3.1.6/dist/pizzip.min.js');
      if (typeof window.PizZip === 'undefined') {
        throw new Error('PizZip failed to load');
      }
      console.log('PizZip loaded successfully');
    }
  } catch (err) {
    console.error('Error loading PizZip:', err);
    showToast('Impossible de charger la bibliothèque PizZip. Vérifiez votre connexion internet.', 'error');
    return;
  }

  try {
    if (typeof window.docxtemplater === 'undefined' && typeof window.Docxtemplater === 'undefined') {
      console.log('Loading docxtemplater...');
      await loadScript('https://unpkg.com/docxtemplater@3.45.0/build/docxtemplater.min.js');

      // Check both possible namespaces
      if (typeof window.docxtemplater !== 'undefined') {
        console.log('docxtemplater loaded as window.docxtemplater');
      } else if (typeof window.Docxtemplater !== 'undefined') {
        console.log('Docxtemplater loaded as window.Docxtemplater');
        window.docxtemplater = window.Docxtemplater; // Normalize
      } else {
        throw new Error('docxtemplater failed to load');
      }
      console.log('docxtemplater loaded successfully');
    }
  } catch (err) {
    console.error('Error loading docxtemplater:', err);
    showToast('Impossible de charger la bibliothèque docxtemplater. Vérifiez votre connexion internet.', 'error');
    return;
  }

  try {
    if (typeof window.saveAs === 'undefined') {
      console.log('Loading FileSaver...');
      await loadScript('https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js');
      if (typeof window.saveAs === 'undefined') {
        throw new Error('FileSaver failed to load');
      }
      console.log('FileSaver loaded successfully');
    }
  } catch (err) {
    console.error('Error loading FileSaver:', err);
    showToast('Impossible de charger la bibliothèque FileSaver. Vérifiez votre connexion internet.', 'error');
    return;
  }

  const prescriptionPages = [];
  let successCount = 0;

  for (const config of apcState.prescriptions) {
    try {
      // Find template
      let template = null;
      if (config.templateId !== 'default') {
        template = state.prescriptionTemplates.find(t => t.id === config.templateId);
        if (!template) {
          console.error('Template not found for', fullName(config.patient));
          continue;
        }
      }

      const prescConfig = {
        startDate: config.startDate,
        endDate: config.endDate,
        duration: config.duration || 3,
        formationInitiale: config.formationInitiale || false
      };

      // Only generate if template has fileData (Word template)
      if (template && template.fileData) {
        const result = await fcoGenerateSingleOrdonnance(config.patient, template, prescConfig);

        if (result) {
          prescriptionPages.push({
            data: result,
            patient: fullName(config.patient)
          });

          successCount++;
        }
      }
    } catch (error) {
      console.error('Error generating prescription for', fullName(config.patient), error);
    }
  }

  // Download prescriptions
  if (prescriptionPages.length > 0) {
    showToast(`${successCount} ordonnance${successCount > 1 ? 's' : ''} générée${successCount > 1 ? 's' : ''}`, 'success');

    // Download combined document
    await fcoCombineWordDocuments(prescriptionPages);
  } else {
    showToast('Aucune ordonnance Word n\'a pu être générée', 'warning');
  }
}

// ===== Import/Export Functions =====
function exportJson() {
  const backup = {
    version: '4.0',
    exportDate: new Date().toISOString(),
    data: state  // Include ALL state data (patients, docs, centers, protos, switches, appointments)
  };

  // Count history events for verification
  const patientHistoryCount = state.patients.reduce((total, p) => total + (p.history?.length || 0), 0);
  const patientEventsCount = state.patients.reduce((total, p) => total + (p.events?.length || 0), 0);
  const appointmentHistoryCount = state.appointments.reduce((total, a) => total + (a.history?.length || 0), 0);
  const totalHistoryEvents = patientHistoryCount + patientEventsCount + appointmentHistoryCount;

  console.log('📦 Exporting backup with:', {
    version: backup.version,
    exportDate: backup.exportDate,
    patients: state.patients?.length || 0,
    docs: state.docs?.length || 0,
    centers: state.centers?.length || 0,
    protos: state.protos?.length || 0,
    switches: state.switches?.length || 0,
    appointments: state.appointments?.length || 0,
    tasks: state.tasks?.length || 0,
    prescriptionTemplates: state.prescriptionTemplates?.length || 0,
    shortcuts: state.shortcuts?.length || 0,
    patientHistoryEvents: patientHistoryCount,
    patientEvents: patientEventsCount,
    appointmentHistoryEvents: appointmentHistoryCount,
    totalHistoryEvents: totalHistoryEvents
  });

  const data = JSON.stringify(backup, null, 2);
  const blob = new Blob([data], { type: 'application/json' });
  const url = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.download = `nhc-care-backup-${new Date().toISOString().split('T')[0]}.json`;
  a.click();

  URL.revokeObjectURL(url);

  // Detailed success message
  const tasksCount = state.tasks?.length || 0;
  const shortcutsCount = state.shortcuts?.length || 0;
  const templatesCount = state.prescriptionTemplates?.length || 0;
  const message = `✅ Export réussi !\n${state.patients.length} patients (${patientHistoryCount} modif. + ${patientEventsCount} événements)\n${state.appointments.length} rendez-vous (${appointmentHistoryCount} événements)\n${tasksCount} tâches, ${shortcutsCount} raccourcis, ${templatesCount} modèles\nTotal: ${totalHistoryEvents} événements sauvegardés`;
  showToast(message, 'success');
}

function exportRefs() {
  const refs = {
    docs: state.docs,
    centers: state.centers,
    protos: state.protos
  };
  
  const data = JSON.stringify(refs, null, 2);
  const blob = new Blob([data], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  
  const a = document.createElement('a');
  a.href = url;
  a.download = `nhc-care-refs-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  
  URL.revokeObjectURL(url);
  showToast('Référentiels exportés', 'success');
}

// Utility function to sort patients array with secondary sorting by name
function sortPatients(patientsArray, sortBy) {
  if (sortBy === 'name') {
    patientsArray.sort((a, b) => fullName(a).localeCompare(fullName(b)));
  } else if (sortBy === 'recent') {
    patientsArray.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
  } else if (sortBy === 'renewal') {
    patientsArray.sort((a, b) => {
      const dateA = parseDate(a.renewalDate);
      const dateB = parseDate(b.renewalDate);
      if (!dateA && !dateB) return fullName(a).localeCompare(fullName(b));
      if (!dateA) return 1;
      if (!dateB) return -1;
      const dateCompare = dateA - dateB;
      return dateCompare !== 0 ? dateCompare : fullName(a).localeCompare(fullName(b));
    });
  } else if (sortBy === 'doctor') {
    patientsArray.sort((a, b) => {
      const docCompare = (docName(a.docId) || 'ZZZ').localeCompare(docName(b.docId) || 'ZZZ');
      return docCompare !== 0 ? docCompare : fullName(a).localeCompare(fullName(b));
    });
  } else if (sortBy === 'center') {
    patientsArray.sort((a, b) => {
      const centerCompare = (centerName(a.centerId) || 'ZZZ').localeCompare(centerName(b.centerId) || 'ZZZ');
      return centerCompare !== 0 ? centerCompare : fullName(a).localeCompare(fullName(b));
    });
  } else if (sortBy === 'protocol') {
    patientsArray.sort((a, b) => {
      const protoCompare = (protoName(a.protoId) || 'ZZZ').localeCompare(protoName(b.protoId) || 'ZZZ');
      return protoCompare !== 0 ? protoCompare : fullName(a).localeCompare(fullName(b));
    });
  }
}

function exportToExcel() {
  try {
    // Check if patients exist
    if (!state.patients || state.patients.length === 0) {
      showToast('Aucun patient à exporter', 'warning');
      return;
    }

    // Préparer les données des patients
    const sortBy = byId('sortPatients')?.value || 'name';
    let sorted = [...state.patients];

    // Appliquer le tri actuel avec tri secondaire par nom
    sortPatients(sorted, sortBy);

    // Helper function to format date as DD/MM/YYYY
    const formatDateForExcel = (dateStr) => {
      if (!dateStr) return '';
      const parts = dateStr.split('-');
      if (parts.length === 3) {
        return `${parts[2]}/${parts[1]}/${parts[0]}`;
      }
      return dateStr;
    };

    // Helper function to calculate age
    const calculateAge = (dobStr) => {
      if (!dobStr) return '';
      const dob = parseDate(dobStr);
      if (!dob) return '';
      const today = new Date();
      let age = today.getFullYear() - dob.getFullYear();
      const monthDiff = today.getMonth() - dob.getMonth();
      if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
        age--;
      }
      return age;
    };

    // Créer le CSV avec BOM pour Excel et en-têtes améliorés
    const BOM = '\uFEFF';
    let csv = BOM + '═══ IDENTITÉ ═══;;;;═══ CONTACT ═══;;═══ MÉDICAL ═══;;;;═══ RENOUVELLEMENT ═══;;;;;\n';
    csv += 'Nom;Prénom;Date de naissance;Âge;Email;Téléphone;Adresse;Médecin traitant;Centre de soins;Matériel / Protocole;Date de renouvellement;Jours restants;Cycle;Statut;Indicateur;Notes\n';

    sorted.forEach(p => {
      const cycleInfo = getCycleFromDate(p.renewalDate);
      const cycleLabel = cycleInfo ? `${cycleInfo.name} ${cycleInfo.year}` : '';

      // Get status and days remaining
      const renewalDate = parseDate(p.renewalDate);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      let status = 'N/A';
      let indicator = '—';
      let daysRemaining = '';

      if (renewalDate) {
        const diffDays = Math.ceil((renewalDate - today) / (1000 * 60 * 60 * 24));
        daysRemaining = diffDays;

        if (diffDays < 0) {
          status = 'Expiré';
          indicator = '⚫ EXPIRÉ';
        } else if (diffDays <= 7) {
          status = 'Urgent';
          indicator = '🔴 URGENT';
        } else if (diffDays <= 30) {
          status = 'Bientôt à renouveler';
          indicator = '🟠 BIENTÔT';
        } else {
          status = 'Valide';
          indicator = '🟢 VALIDE';
        }
      }

      const age = calculateAge(p.dob);

      const row = [
        // IDENTITÉ
        p.lastName || '',
        p.firstName || '',
        formatDateForExcel(p.dob) || '',
        age,
        // CONTACT
        p.email || '',
        p.phone || '',
        p.address || '',
        // MÉDICAL
        docName(p.docId) || '',
        centerName(p.centerId) || '',
        protoName(p.protoId) || '',
        // RENOUVELLEMENT
        formatDateForExcel(p.renewalDate) || '',
        daysRemaining,
        cycleLabel,
        status,
        indicator,
        // NOTES
        (p.notes || '').replace(/"/g, '""').replace(/\n/g, ' ')
      ];

      csv += row.map(field => `"${field}"`).join(';') + '\n';
    });

    // Créer le fichier et le télécharger
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = `patients-nhc-care-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();

    URL.revokeObjectURL(url);
    showToast(`✅ ${sorted.length} patient(s) exporté(s) vers Excel`, 'success');
  } catch (error) {
    console.error('Error exporting to Excel:', error);
    showToast('❌ Erreur lors de l\'export Excel: ' + error.message, 'error');
  }
}

// ===== ADVANCED EXPORT SYSTEM =====

function openAdvancedExportModal() {
  // Populate filter lists (this will also add listeners)
  populateAdvancedFilters();

  // Show modal
  showModal(true, 'advancedExportModal');

  // Update summary
  updateFilterSummary();
}

function populateAdvancedFilters() {
  // Save current state of checkboxes before repopulating
  const savedDoctorState = {};
  const savedProtocolState = {};
  const savedCenterState = {};

  document.querySelectorAll('.filter-doctor').forEach(cb => {
    savedDoctorState[cb.value] = cb.checked;
  });

  document.querySelectorAll('.filter-protocol').forEach(cb => {
    savedProtocolState[cb.value] = cb.checked;
  });

  document.querySelectorAll('.filter-center').forEach(cb => {
    savedCenterState[cb.value] = cb.checked;
  });

  // Populate doctors
  const doctorsContainer = byId('filterDoctors');
  doctorsContainer.innerHTML = state.docs.map(doc => {
    const isChecked = savedDoctorState.hasOwnProperty(doc.id) ? savedDoctorState[doc.id] : true;
    return `
      <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: var(--bg-tertiary); border-radius: var(--radius); cursor: pointer;">
        <input type="checkbox" class="filter-doctor" value="${doc.id}" ${isChecked ? 'checked' : ''} style="cursor: pointer;">
        <span>${doc.name}</span>
      </label>
    `;
  }).join('');

  // Populate protocols
  const protocolsContainer = byId('filterProtocols');
  protocolsContainer.innerHTML = state.protos.map(proto => {
    const isChecked = savedProtocolState.hasOwnProperty(proto.id) ? savedProtocolState[proto.id] : true;
    return `
      <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: var(--bg-tertiary); border-radius: var(--radius); cursor: pointer;">
        <input type="checkbox" class="filter-protocol" value="${proto.id}" ${isChecked ? 'checked' : ''} style="cursor: pointer;">
        <span>${proto.name}</span>
      </label>
    `;
  }).join('');

  // Populate centers
  const centersContainer = byId('filterCenters');
  centersContainer.innerHTML = state.centers.map(center => {
    const isChecked = savedCenterState.hasOwnProperty(center.id) ? savedCenterState[center.id] : true;
    return `
      <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: var(--bg-tertiary); border-radius: var(--radius); cursor: pointer;">
        <input type="checkbox" class="filter-center" value="${center.id}" ${isChecked ? 'checked' : ''} style="cursor: pointer;">
        <span>${center.name}</span>
      </label>
    `;
  }).join('');

  // Re-attach event listeners after repopulating
  addFilterListeners();
}

function addFilterListeners() {
  // Add change listeners to all checkboxes
  const allCheckboxes = document.querySelectorAll('#advancedExportModal input[type="checkbox"]');
  allCheckboxes.forEach(cb => {
    cb.addEventListener('change', updateFilterSummary);
  });

  // Add change listeners to date inputs
  byId('filterDateFrom')?.addEventListener('change', updateFilterSummary);
  byId('filterDateTo')?.addEventListener('change', updateFilterSummary);
}

function selectAllFilterDoctors(select) {
  const checkboxes = document.querySelectorAll('.filter-doctor');
  checkboxes.forEach(cb => cb.checked = select);
  updateFilterSummary();
}

function selectAllFilterProtocols(select) {
  const checkboxes = document.querySelectorAll('.filter-protocol');
  checkboxes.forEach(cb => cb.checked = select);
  updateFilterSummary();
}

function selectAllFilterCenters(select) {
  const checkboxes = document.querySelectorAll('.filter-center');
  checkboxes.forEach(cb => cb.checked = select);
  updateFilterSummary();
}

function updateFilterSummary() {
  // Count selected filters
  const selectedDoctors = document.querySelectorAll('.filter-doctor:checked').length;
  const selectedProtocols = document.querySelectorAll('.filter-protocol:checked').length;
  const selectedCenters = document.querySelectorAll('.filter-center:checked').length;

  const totalDoctors = state.docs.length;
  const totalProtocols = state.protos.length;
  const totalCenters = state.centers.length;

  const statusValid = byId('filterStatusValid')?.checked;
  const statusSoon = byId('filterStatusSoon')?.checked;
  const statusUrgent = byId('filterStatusUrgent')?.checked;
  const statusExpired = byId('filterStatusExpired')?.checked;

  const dateFrom = byId('filterDateFrom')?.value;
  const dateTo = byId('filterDateTo')?.value;

  // Count matching patients
  const filtered = getFilteredPatients();

  // Build summary
  let parts = [];

  if (selectedDoctors < totalDoctors) {
    parts.push(`${selectedDoctors}/${totalDoctors} médecins`);
  } else {
    parts.push('Tous les médecins');
  }

  if (selectedProtocols < totalProtocols) {
    parts.push(`${selectedProtocols}/${totalProtocols} protocoles`);
  } else {
    parts.push('Tous les protocoles');
  }

  if (selectedCenters < totalCenters) {
    parts.push(`${selectedCenters}/${totalCenters} centres`);
  } else {
    parts.push('Tous les centres');
  }

  const statusCount = [statusValid, statusSoon, statusUrgent, statusExpired].filter(Boolean).length;
  if (statusCount < 4) {
    const statuses = [];
    if (statusValid) statuses.push('Valide');
    if (statusSoon) statuses.push('Bientôt');
    if (statusUrgent) statuses.push('Urgent');
    if (statusExpired) statuses.push('Expiré');
    parts.push(`Statuts: ${statuses.join(', ')}`);
  }

  if (dateFrom || dateTo) {
    if (dateFrom && dateTo) {
      parts.push(`Période: ${dateFrom} → ${dateTo}`);
    } else if (dateFrom) {
      parts.push(`Depuis: ${dateFrom}`);
    } else {
      parts.push(`Jusqu'à: ${dateTo}`);
    }
  }

  const summary = byId('filterSummary');
  if (summary) {
    summary.innerHTML = `
      <div style="margin-bottom: 0.5rem;">${parts.join(' • ')}</div>
      <div style="font-weight: 600; color: var(--primary); font-size: 1.1rem;">
        📊 ${filtered.length} patient(s) correspondant aux critères
      </div>
    `;
  }
}

function getFilteredPatients() {
  // Get selected filters
  const selectedDoctorIds = Array.from(document.querySelectorAll('.filter-doctor:checked')).map(cb => cb.value);
  const selectedProtocolIds = Array.from(document.querySelectorAll('.filter-protocol:checked')).map(cb => cb.value);
  const selectedCenterIds = Array.from(document.querySelectorAll('.filter-center:checked')).map(cb => cb.value);

  const statusValid = byId('filterStatusValid')?.checked;
  const statusSoon = byId('filterStatusSoon')?.checked;
  const statusUrgent = byId('filterStatusUrgent')?.checked;
  const statusExpired = byId('filterStatusExpired')?.checked;

  const dateFrom = byId('filterDateFrom')?.value ? parseDate(byId('filterDateFrom').value) : null;
  const dateTo = byId('filterDateTo')?.value ? parseDate(byId('filterDateTo').value) : null;

  // Filter patients
  return state.patients.filter(p => {
    // Filter by doctor
    if (selectedDoctorIds.length > 0 && !selectedDoctorIds.includes(p.docId)) {
      return false;
    }

    // Filter by protocol
    if (selectedProtocolIds.length > 0 && !selectedProtocolIds.includes(p.protoId)) {
      return false;
    }

    // Filter by center
    if (selectedCenterIds.length > 0 && !selectedCenterIds.includes(p.centerId)) {
      return false;
    }

    // Filter by status
    const renewalDate = parseDate(p.renewalDate);
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    let matchesStatus = false;

    if (!renewalDate) {
      matchesStatus = statusExpired;
    } else {
      const diffDays = Math.ceil((renewalDate - today) / (1000 * 60 * 60 * 24));

      if (diffDays < 0) {
        matchesStatus = statusExpired;
      } else if (diffDays <= 7) {
        matchesStatus = statusUrgent;
      } else if (diffDays <= 30) {
        matchesStatus = statusSoon;
      } else {
        matchesStatus = statusValid;
      }
    }

    if (!matchesStatus) {
      return false;
    }

    // Filter by date range
    if (dateFrom || dateTo) {
      if (!renewalDate) return false;

      if (dateFrom && renewalDate < dateFrom) return false;
      if (dateTo && renewalDate > dateTo) return false;
    }

    return true;
  });
}

// Global variables for patient review workflow
let reviewPatients = [];
let reviewCurrentIndex = 0;
let reviewComments = {}; // Store comments: { patientId: comment }

function executeAdvancedExport() {
  try {
    const filtered = getFilteredPatients();

    if (filtered.length === 0) {
      showToast('❌ Aucun patient ne correspond aux critères sélectionnés', 'warning');
      return;
    }

    // Get selected sort option
    const sortBy = byId('exportSortBy')?.value || 'name';

    // Store filtered patients for review workflow with selected sort
    reviewPatients = [...filtered];
    sortPatients(reviewPatients, sortBy);
    reviewComments = {}; // Reset comments
    reviewCurrentIndex = 0;

    // Update summary
    const summaryDiv = byId('exportConfirmSummary');
    summaryDiv.innerHTML = `<strong>${reviewPatients.length}</strong> patient(s) sélectionné(s) avec les filtres appliqués`;

    // Close advanced export modal and show confirmation modal
    showModal(false, 'advancedExportModal');
    showModal(true, 'exportConfirmModal');
  } catch (error) {
    console.error('Error in advanced export:', error);
    showToast('❌ Erreur lors de l\'export avancé: ' + error.message, 'error');
  }
}

function proceedToExport(format) {
  if (format === 'csv') {
    exportToCSV(reviewPatients);
    showModal(false, 'exportConfirmModal');
  }
}

function startPatientReview() {
  if (reviewPatients.length === 0) return;

  reviewCurrentIndex = 0;
  reviewComments = {};

  showModal(false, 'exportConfirmModal');
  showModal(true, 'patientReviewModal');

  displayCurrentPatient();
}

function displayCurrentPatient() {
  if (reviewCurrentIndex < 0 || reviewCurrentIndex >= reviewPatients.length) return;

  const patient = reviewPatients[reviewCurrentIndex];
  const progress = ((reviewCurrentIndex + 1) / reviewPatients.length) * 100;

  // Update progress
  byId('reviewProgressText').textContent = `Revue des patients (${reviewCurrentIndex + 1} / ${reviewPatients.length})`;
  byId('reviewProgressBar').style.width = `${progress}%`;

  // Update patient info
  byId('reviewPatientName').textContent = fullName(patient);
  byId('reviewPatientDob').textContent = patient.dob ? formatDateForExcel(patient.dob) : 'Date non renseignée';
  byId('reviewPatientEmail').textContent = patient.email || '—';
  byId('reviewPatientPhone').textContent = patient.phone || '—';
  byId('reviewPatientDoctor').textContent = docName(patient.docId) || '—';
  byId('reviewPatientCenter').textContent = centerName(patient.centerId) || '—';
  byId('reviewPatientProtocol').textContent = protoName(patient.protoId) || '—';
  byId('reviewPatientRenewal').textContent = patient.renewalDate ? formatDateForExcel(patient.renewalDate) : '—';

  // Get and display status
  const statusInfo = getPatientStatus(patient);
  byId('reviewPatientStatus').textContent = statusInfo.label;
  byId('reviewPatientStatus').style.background = statusInfo.background;

  // Show existing notes if any
  const existingNotesDiv = byId('reviewExistingNotes');
  if (patient.notes && patient.notes.trim()) {
    existingNotesDiv.style.display = 'block';
    byId('reviewExistingNotesContent').textContent = patient.notes;
  } else {
    existingNotesDiv.style.display = 'none';
  }

  // Restore comment if already entered
  byId('reviewCommentInput').value = reviewComments[patient.id] || '';

  // Update navigation buttons
  byId('reviewPrevBtn').disabled = reviewCurrentIndex === 0;

  const nextBtn = byId('reviewNextBtn');
  const nextBtnText = byId('reviewNextBtnText');
  if (reviewCurrentIndex === reviewPatients.length - 1) {
    nextBtnText.textContent = 'Terminer et générer PDF';
  } else {
    nextBtnText.textContent = 'Suivant';
  }
}

function previousPatientReview() {
  // Save current comment
  const currentPatient = reviewPatients[reviewCurrentIndex];
  const comment = byId('reviewCommentInput').value.trim();
  if (comment) {
    reviewComments[currentPatient.id] = comment;
  } else {
    delete reviewComments[currentPatient.id];
  }

  reviewCurrentIndex--;
  displayCurrentPatient();
}

function nextPatientReview() {
  // Save current comment
  const currentPatient = reviewPatients[reviewCurrentIndex];
  const comment = byId('reviewCommentInput').value.trim();
  if (comment) {
    reviewComments[currentPatient.id] = comment;
  } else {
    delete reviewComments[currentPatient.id];
  }

  if (reviewCurrentIndex === reviewPatients.length - 1) {
    // Last patient - generate PDF
    finishReviewAndGeneratePDF();
  } else {
    reviewCurrentIndex++;
    displayCurrentPatient();
  }
}

function skipAllReview() {
  // Generate PDF with current comments only
  finishReviewAndGeneratePDF();
}

function cancelPatientReview() {
  showModal(false, 'patientReviewModal');
  reviewPatients = [];
  reviewComments = {};
  reviewCurrentIndex = 0;
}

function getPatientStatus(patient) {
  const renewalDate = parseDate(patient.renewalDate);
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  if (!renewalDate) {
    return { label: 'N/A', background: 'rgba(255,255,255,0.2)' };
  }

  const diffDays = Math.ceil((renewalDate - today) / (1000 * 60 * 60 * 24));

  if (diffDays < 0) {
    return { label: '⚫ EXPIRÉ', background: 'rgba(0,0,0,0.4)' };
  } else if (diffDays <= 7) {
    return { label: '🔴 URGENT', background: 'rgba(239,68,68,0.8)' };
  } else if (diffDays <= 30) {
    return { label: '🟠 BIENTÔT', background: 'rgba(249,115,22,0.8)' };
  } else {
    return { label: '🟢 VALIDE', background: 'rgba(34,197,94,0.8)' };
  }
}

function formatDateForExcel(dateStr) {
  if (!dateStr) return '';
  const parts = dateStr.split('-');
  if (parts.length === 3) {
    return `${parts[2]}/${parts[1]}/${parts[0]}`;
  }
  return dateStr;
}

function calculateAge(dobStr) {
  if (!dobStr) return '';
  const dob = parseDate(dobStr);
  if (!dob) return '';
  const today = new Date();
  let age = today.getFullYear() - dob.getFullYear();
  const monthDiff = today.getMonth() - dob.getMonth();
  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
    age--;
  }
  return age;
}

function exportToCSV(patients) {
  try {
    // Helper function to format date as DD/MM/YYYY
    const formatDate = (dateStr) => {
      if (!dateStr) return '';
      const parts = dateStr.split('-');
      if (parts.length === 3) {
        return `${parts[2]}/${parts[1]}/${parts[0]}`;
      }
      return dateStr;
    };

    // Créer le CSV avec BOM pour Excel et en-têtes améliorés
    const BOM = '\uFEFF';
    let csv = BOM + '═══ IDENTITÉ ═══;;;;═══ CONTACT ═══;;═══ MÉDICAL ═══;;;;═══ RENOUVELLEMENT ═══;;;;;\n';
    csv += 'Nom;Prénom;Date de naissance;Âge;Email;Téléphone;Adresse;Médecin traitant;Centre de soins;Matériel / Protocole;Date de renouvellement;Jours restants;Cycle;Statut;Indicateur;Notes\n';

    patients.forEach(p => {
      const cycleInfo = getCycleFromDate(p.renewalDate);
      const cycleLabel = cycleInfo ? `${cycleInfo.name} ${cycleInfo.year}` : '';

      // Get status and days remaining
      const renewalDate = parseDate(p.renewalDate);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      let status = 'N/A';
      let indicator = '—';
      let daysRemaining = '';

      if (renewalDate) {
        const diffDays = Math.ceil((renewalDate - today) / (1000 * 60 * 60 * 24));
        daysRemaining = diffDays;

        if (diffDays < 0) {
          status = 'Expiré';
          indicator = '⚫ EXPIRÉ';
        } else if (diffDays <= 7) {
          status = 'Urgent';
          indicator = '🔴 URGENT';
        } else if (diffDays <= 30) {
          status = 'Bientôt à renouveler';
          indicator = '🟠 BIENTÔT';
        } else {
          status = 'Valide';
          indicator = '🟢 VALIDE';
        }
      }

      const age = calculateAge(p.dob);

      const row = [
        // IDENTITÉ
        p.lastName || '',
        p.firstName || '',
        formatDate(p.dob) || '',
        age,
        // CONTACT
        p.email || '',
        p.phone || '',
        p.address || '',
        // MÉDICAL
        docName(p.docId) || '',
        centerName(p.centerId) || '',
        protoName(p.protoId) || '',
        // RENOUVELLEMENT
        formatDate(p.renewalDate) || '',
        daysRemaining,
        cycleLabel,
        status,
        indicator,
        // NOTES
        (p.notes || '').replace(/"/g, '""').replace(/\n/g, ' ')
      ];

      csv += row.map(field => `"${field}"`).join(';') + '\n';
    });

    // Créer le fichier et le télécharger
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = `patients-nhc-care-filtré-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();

    URL.revokeObjectURL(url);

    showToast(`✅ ${patients.length} patient(s) exporté(s) vers CSV`, 'success');
  } catch (error) {
    console.error('Error exporting to CSV:', error);
    showToast('❌ Erreur lors de l\'export CSV: ' + error.message, 'error');
  }
}

function exportTasksToCSV() {
  try {
    if (!state.tasks || state.tasks.length === 0) {
      showToast('Aucune tâche à exporter', 'warning');
      return;
    }

    // Créer le CSV avec BOM pour Excel
    const BOM = '\uFEFF';
    let csv = BOM + 'Titre;Description;Statut;Priorité;Date échéance;Heure échéance;Type de liaison;Élément lié;Tags;Date de création;Date de modification;Date de complétion\n';

    const statusLabels = {
      todo: 'À faire',
      in_progress: 'En cours',
      completed: 'Terminée'
    };

    const priorityLabels = {
      low: 'Basse',
      normal: 'Normale',
      high: 'Haute',
      urgent: 'Urgente'
    };

    const relationTypeLabels = {
      patient: 'Patient',
      doctor: 'Médecin',
      center: 'Centre',
      protocol: 'Protocole'
    };

    state.tasks.forEach(task => {
      let relationLabel = '';
      if (task.relationType && task.relationId) {
        let relationName = '';
        switch (task.relationType) {
          case 'patient':
            const patient = state.patients.find(p => p.id === task.relationId);
            relationName = patient ? fullName(patient) : '';
            break;
          case 'doctor':
            relationName = docName(task.relationId);
            break;
          case 'center':
            relationName = centerName(task.relationId);
            break;
          case 'protocol':
            relationName = protoName(task.relationId);
            break;
        }
        relationLabel = relationName;
      }

      const row = [
        task.title || '',
        (task.description || '').replace(/"/g, '""').replace(/\n/g, ' '),
        statusLabels[task.status] || task.status,
        priorityLabels[task.priority] || task.priority,
        task.dueDate || '',
        task.dueTime || '',
        task.relationType ? relationTypeLabels[task.relationType] : '',
        relationLabel,
        task.tags ? task.tags.join(', ') : '',
        task.createdAt ? new Date(task.createdAt).toLocaleString('fr-FR') : '',
        task.updatedAt ? new Date(task.updatedAt).toLocaleString('fr-FR') : '',
        task.completedAt ? new Date(task.completedAt).toLocaleString('fr-FR') : ''
      ];

      csv += row.map(field => `"${field}"`).join(';') + '\n';
    });

    // Créer le fichier et le télécharger
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = `taches-nhc-care-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();

    URL.revokeObjectURL(url);

    showToast(`✅ ${state.tasks.length} tâche(s) exportée(s) vers CSV`, 'success');
  } catch (error) {
    console.error('Error exporting tasks to CSV:', error);
    showToast('❌ Erreur lors de l\'export CSV: ' + error.message, 'error');
  }
}

function finishReviewAndGeneratePDF() {
  showModal(false, 'patientReviewModal');

  showToast('⏳ Génération du PDF en cours...', 'info');

  setTimeout(() => {
    try {
      generatePDF(reviewPatients, reviewComments);
      showToast(`✅ PDF généré avec succès pour ${reviewPatients.length} patient(s)`, 'success');
    } catch (error) {
      console.error('Error generating PDF:', error);
      showToast('❌ Erreur lors de la génération du PDF: ' + error.message, 'error');
    }
  }, 300);
}

function generatePDF(patients, comments) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('l', 'mm', 'a4'); // Landscape mode for more width

  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();
  const margin = 10;
  const contentWidth = pageWidth - (2 * margin);
  let yPosition = margin;

  // Compact title header
  doc.setFontSize(14);
  doc.setTextColor(59, 130, 246);
  doc.text('NHC Patients Manager - Rapport Export', margin, yPosition);

  const today = new Date();
  doc.setFontSize(8);
  doc.setTextColor(100, 116, 139);
  doc.text(`${today.toLocaleDateString('fr-FR')} ${today.toLocaleTimeString('fr-FR')} - ${patients.length} patients`,
    pageWidth - margin, yPosition, { align: 'right' });

  yPosition += 8;

  // Draw header line
  doc.setDrawColor(200, 200, 200);
  doc.line(margin, yPosition, pageWidth - margin, yPosition);
  yPosition += 3;

  patients.forEach((patient, index) => {
    const commentText = comments[patient.id] || '';
    const hasComment = commentText.length > 0;

    // Calculate comment height dynamically based on text length
    let commentHeight = 0;
    let commentLines = [];
    if (hasComment) {
      doc.setFontSize(6);
      // Calculate available width for comment (contentWidth - left margin - padding)
      const commentWidth = contentWidth - 32;
      commentLines = doc.splitTextToSize(`Note: ${commentText}`, commentWidth);
      // Height: 3mm top padding + (number of lines * 2.5mm line height) + 3mm bottom padding
      commentHeight = 3 + (commentLines.length * 2.5) + 3;
    }

    // Compact patient height: 9mm per patient + dynamic comment height
    const patientHeight = 9 + commentHeight;

    // Check if we need a new page (leave 10mm margin at bottom)
    if (yPosition + patientHeight > pageHeight - margin) {
      doc.addPage();
      yPosition = margin;
    }

    // Alternate row background for readability
    if (index % 2 === 0) {
      doc.setFillColor(248, 250, 252);
      doc.rect(margin, yPosition, contentWidth, patientHeight, 'F');
    }

    // Patient number and status
    doc.setFontSize(7);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(100, 116, 139);
    doc.text(`#${index + 1}`, margin + 2, yPosition + 4);

    const statusInfo = getPatientStatus(patient);
    const statusText = statusInfo.label.replace(/[🟢🟠🔴⚫]/g, '').trim();
    doc.setFontSize(6);
    doc.text(statusText, margin + 10, yPosition + 4);

    // Patient name (bold and larger)
    doc.setFontSize(8);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(30, 41, 59);
    doc.text(fullName(patient), margin + 30, yPosition + 4);

    // Compact info on same line
    doc.setFontSize(6.5);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(71, 85, 105);

    let xPos = margin + 95;
    const spacing = 45;

    // Age
    if (patient.dob) {
      doc.text(`Age: ${calculateAge(patient.dob)} ans`, xPos, yPosition + 4);
    }
    xPos += spacing;

    // Phone
    if (patient.phone) {
      const phoneShort = patient.phone.length > 14 ? patient.phone.substring(0, 14) + '...' : patient.phone;
      doc.text(`Tel: ${phoneShort}`, xPos, yPosition + 4);
    }
    xPos += spacing;

    // Center
    const center = centerName(patient.centerId);
    if (center) {
      const centerShort = center.length > 12 ? center.substring(0, 12) + '...' : center;
      doc.text(`Centre: ${centerShort}`, xPos, yPosition + 4);
    }
    xPos += spacing;

    // Protocol
    const proto = protoName(patient.protoId);
    if (proto) {
      const protoShort = proto.length > 15 ? proto.substring(0, 15) + '...' : proto;
      doc.text(`Proto: ${protoShort}`, xPos, yPosition + 4);
    }

    // Second line with additional details
    yPosition += 4.5;
    xPos = margin + 30;

    // Email
    if (patient.email) {
      const emailShort = patient.email.length > 25 ? patient.email.substring(0, 25) + '...' : patient.email;
      doc.text(`Email: ${emailShort}`, xPos, yPosition + 4);
    }
    xPos += 70;

    // Doctor
    const doctor = docName(patient.docId);
    if (doctor) {
      const doctorShort = doctor.length > 20 ? doctor.substring(0, 20) + '...' : doctor;
      doc.text(`Medecin: ${doctorShort}`, xPos, yPosition + 4);
    }
    xPos += 55;

    // Renewal date and days remaining
    if (patient.renewalDate) {
      const renewalDate = parseDate(patient.renewalDate);
      if (renewalDate) {
        const todayDate = new Date();
        todayDate.setHours(0, 0, 0, 0);
        const diffDays = Math.ceil((renewalDate - todayDate) / (1000 * 60 * 60 * 24));

        doc.text(`Renouvellement: ${formatDateForExcel(patient.renewalDate)}`, xPos, yPosition + 4);
        xPos += 45;

        if (diffDays <= 0) {
          doc.setTextColor(220, 38, 38); // Red for expired
          doc.text(`(Expire depuis ${Math.abs(diffDays)}j)`, xPos, yPosition + 4);
        } else if (diffDays <= 30) {
          doc.setTextColor(234, 88, 12); // Orange for soon
          doc.text(`(${diffDays}j restants)`, xPos, yPosition + 4);
        } else {
          doc.setTextColor(22, 163, 74); // Green
          doc.text(`(${diffDays}j restants)`, xPos, yPosition + 4);
        }
        doc.setTextColor(71, 85, 105); // Reset color
      }
    }

    yPosition += 4;

    // Comment if exists (on separate line, full text with multiple lines if needed)
    if (hasComment) {
      // Light background for better separation (dynamic height)
      doc.setFillColor(252, 252, 253);
      doc.rect(margin + 28, yPosition, contentWidth - 28, commentHeight, 'F');

      doc.setFontSize(6);
      doc.setTextColor(100, 116, 139);
      doc.setFont('helvetica', 'italic');
      // Display full comment with line wrapping
      doc.text(commentLines, margin + 30, yPosition + 3);
      yPosition += commentHeight;
    }

    // Subtle separator line
    doc.setDrawColor(226, 232, 240);
    doc.line(margin, yPosition, pageWidth - margin, yPosition);
    yPosition += 0.5;
  });

  // Save PDF
  doc.save(`patients-nhc-care-rapport-${new Date().toISOString().split('T')[0]}.pdf`);
}

// ===== Switch Management System =====
function openSwitchModal(switchId = null) {
  currentSwitchId = switchId;

  // Populate patient select
  const patientSelect = byId('switchPatientId');
  patientSelect.innerHTML = '<option value="">-- Sélectionner un patient --</option>' +
    state.patients.map(p => `<option value="${p.id}">${fullName(p)}</option>`).join('');

  // Populate protocol select
  const protoSelect = byId('switchNewProtoId');
  protoSelect.innerHTML = '<option value="">-- Sélectionner --</option>' +
    state.protos.map(pr => `<option value="${pr.id}">${pr.name}</option>`).join('');

  // Make selects searchable
  setTimeout(() => {
    makeSelectSearchable(
      'switchPatientId',
      () => state.patients,
      (p) => fullName(p),
      'Rechercher un patient...'
    );
    makeSelectSearchable(
      'switchNewProtoId',
      () => state.protos,
      (p) => p.name,
      'Rechercher un protocole...'
    );
  }, 0);

  if (switchId) {
    // Edit mode
    const sw = state.switches.find(s => s.id === switchId);
    if (!sw) return;
    
    byId('switchModalTitle').textContent = 'Modifier le Switch';
    byId('btnDeleteSwitch').classList.remove('hidden');
    
    byId('switchPatientId').value = sw.patientId;
    updateSwitchOldProto();
    byId('switchNewProtoId').value = sw.newProtoId;
    byId('switchDate').value = sw.switchDate;
    byId('switchTime').value = sw.time || '';
    byId('switchStatus').value = sw.status;
    byId('switchNotes').value = sw.notes || '';
  } else {
    // New mode
    byId('switchModalTitle').textContent = 'Nouveau Switch de Pompe';
    byId('btnDeleteSwitch').classList.add('hidden');

    byId('switchPatientId').value = '';
    byId('switchOldProto').value = '';
    byId('switchNewProtoId').value = '';
    byId('switchDate').value = '';
    byId('switchTime').value = '';
    byId('switchStatus').value = 'planned';
    byId('switchNotes').value = '';
  }

  // Add event listener for patient selection
  patientSelect.onchange = function() {
    updateSwitchOldProto();
    checkExistingSwitches(this.value);
    displaySwitchPatientInfo(this.value);
  };

  // Check existing switches and display patient info if editing with a patient already selected
  if (switchId && patientSelect.value) {
    checkExistingSwitches(patientSelect.value);
    displaySwitchPatientInfo(patientSelect.value);
  }

  showModal(true, 'switchModal');
}

function updateSwitchOldProto() {
  const patientId = byId('switchPatientId').value;
  const patient = state.patients.find(p => p.id === patientId);
  
  if (patient && patient.protoId) {
    byId('switchOldProto').value = protoName(patient.protoId);
  } else {
    byId('switchOldProto').value = 'Aucun protocole défini';
  }
}

function saveSwitch() {
  const formData = {
    patientId: byId('switchPatientId').value,
    newProtoId: byId('switchNewProtoId').value,
    switchDate: byId('switchDate').value.trim(),
    time: byId('switchTime').value.trim() || null,
    status: byId('switchStatus').value,
    notes: byId('switchNotes').value.trim()
  };
  
  if (!formData.patientId || !formData.newProtoId || !formData.switchDate) {
    showToast('Patient, nouveau protocole et date requis', 'error');
    return;
  }
  
  // Validate date format
  if (!formData.switchDate.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
    showToast('Format de date invalide (JJ/MM/AAAA)', 'error');
    return;
  }

  // Validate date is a real date
  const dateParts = formData.switchDate.split('/');
  const day = parseInt(dateParts[0], 10);
  const month = parseInt(dateParts[1], 10);
  const year = parseInt(dateParts[2], 10);
  const switchDate = new Date(year, month - 1, day);

  if (isNaN(switchDate.getTime()) ||
      switchDate.getDate() !== day ||
      switchDate.getMonth() !== (month - 1) ||
      switchDate.getFullYear() !== year) {
    showToast('Date invalide. Vérifiez le jour, mois et année.', 'error');
    return;
  }

  // Warn if date is more than 2 years in the past (except for completed switches)
  if (formData.status !== 'completed') {
    const twoYearsAgo = new Date();
    twoYearsAgo.setFullYear(twoYearsAgo.getFullYear() - 2);
    if (switchDate < twoYearsAgo) {
      if (!confirm('⚠️ La date du switch est ancienne (> 2 ans). Êtes-vous sûr de vouloir continuer ?')) {
        return;
      }
    }
  }

  const patient = state.patients.find(p => p.id === formData.patientId);
  
  // Vérifier que le patient existe
  if (!patient) {
    showToast('Patient introuvable. Veuillez sélectionner un patient valide.', 'error');
    return;
  }
  
  if (currentSwitchId) {
    // Update existing switch
    const index = state.switches.findIndex(s => s.id === currentSwitchId);
    if (index !== -1) {
      const oldStatus = state.switches[index].status;
      state.switches[index] = {
        ...state.switches[index],
        ...formData,
        oldProtoId: patient.protoId,
        updatedAt: Date.now()
      };

      // Add event to patient history
      const timeStr = formData.time ? ` à ${formData.time}` : '';
      addPatientEvent(formData.patientId, 'switch_updated', `Modification du switch prévu le ${formData.switchDate}${timeStr}`, {
        switchId: currentSwitchId,
        date: formData.switchDate,
        time: formData.time || null,
        newProtoId: formData.newProtoId,
        oldProtoId: patient.protoId,
        status: formData.status
      });

      // If status changed to completed, update patient
      if (oldStatus !== 'completed' && formData.status === 'completed') {
        applySwitch(currentSwitchId);
      }

      showToast('Switch modifié', 'success');
    }
  } else {
    // Create new switch
    const newSwitch = {
      id: generateId(),
      ...formData,
      oldProtoId: patient.protoId,
      createdAt: Date.now(),
      updatedAt: Date.now()
    };

    state.switches.push(newSwitch);

    // Add event to patient history
    const timeStr = formData.time ? ` à ${formData.time}` : '';
    addPatientEvent(formData.patientId, 'switch_created', `Switch planifié pour le ${formData.switchDate}${timeStr} (${protoName(patient.protoId)} → ${protoName(formData.newProtoId)})`, {
      switchId: newSwitch.id,
      date: formData.switchDate,
      time: formData.time || null,
      newProtoId: formData.newProtoId,
      oldProtoId: patient.protoId,
      status: formData.status
    });

    // If status is completed, apply immediately
    if (formData.status === 'completed') {
      applySwitch(newSwitch.id);
    }

    showToast('Switch créé', 'success');
  }
  
  saveDB();
  renderSwitches();
  updateCounters();
  showModal(false, 'switchModal');
}

function applySwitch(switchId) {
  const sw = state.switches.find(s => s.id === switchId);
  if (!sw) return;
  
  const patientIndex = state.patients.findIndex(p => p.id === sw.patientId);
  if (patientIndex === -1) return;
  
  const patient = state.patients[patientIndex];
  const now = Date.now();
  
  // Initialize history if doesn't exist
  if (!patient.history) {
    patient.history = [];
  }
  
  // Add switch to history
  patient.history.push({
    date: now,
    type: 'switch',
    field: 'Switch de pompe',
    oldValue: protoName(sw.oldProtoId) || 'Non défini',
    newValue: protoName(sw.newProtoId),
    notes: sw.notes
  });
  
  // Update patient protocol and renewal date
  state.patients[patientIndex].protoId = sw.newProtoId;
  state.patients[patientIndex].renewalDate = sw.switchDate;
  state.patients[patientIndex].updatedAt = now;
  
  // Mark switch as completed
  sw.status = 'completed';
  sw.completedAt = now;
  
  saveDB();
}

function validateSwitch(switchId) {
  const sw = state.switches.find(s => s.id === switchId);
  if (!sw) return;
  
  const patient = state.patients.find(p => p.id === sw.patientId);
  if (!patient) return;
  
  // Store current switch ID for validation
  window.currentValidatingSwitchId = switchId;
  
  // Display switch info
  const info = `
    <strong>Patient :</strong> ${patient.firstName} ${patient.lastName}<br>
    <strong>Switch :</strong> ${protoName(sw.oldProtoId) || 'Non défini'} → ${protoName(sw.newProtoId)}<br>
    <strong>Date prévue :</strong> ${sw.switchDate}${sw.time ? ` à ${sw.time}` : ''}
  `;
  byId('validateSwitchInfo').innerHTML = info;
  
  // Reset modal state
  byId('prescriptionDateInput').style.display = 'none';
  byId('prescriptionNoInfo').style.display = 'none';
  byId('prescriptionRenewalDate').value = '';
  byId('btnPrescYes').classList.remove('btn-primary');
  byId('btnPrescYes').classList.add('btn-secondary');
  byId('btnPrescNo').classList.remove('btn-primary');
  byId('btnPrescNo').classList.add('btn-secondary');
  byId('btnConfirmValidateSwitch').disabled = true;
  
  // Show modal
  showModal(true, 'validateSwitchModal');
}

function selectPrescriptionOption(option) {
  // Update button states
  if (option === 'yes') {
    byId('btnPrescYes').classList.remove('btn-secondary');
    byId('btnPrescYes').classList.add('btn-primary');
    byId('btnPrescNo').classList.remove('btn-primary');
    byId('btnPrescNo').classList.add('btn-secondary');
    
    // Show date input
    byId('prescriptionDateInput').style.display = 'block';
    byId('prescriptionNoInfo').style.display = 'none';
    
    // Disable confirm button until date is entered
    byId('btnConfirmValidateSwitch').disabled = true;
    
    // Add event listener for date input
    byId('prescriptionRenewalDate').addEventListener('input', function() {
      const dateValue = this.value.trim();
      const isValidDate = /^\d{2}\/\d{2}\/\d{4}$/.test(dateValue);
      byId('btnConfirmValidateSwitch').disabled = !isValidDate;
    });
    
  } else if (option === 'no') {
    byId('btnPrescNo').classList.remove('btn-secondary');
    byId('btnPrescNo').classList.add('btn-primary');
    byId('btnPrescYes').classList.remove('btn-primary');
    byId('btnPrescYes').classList.add('btn-secondary');
    
    // Hide date input, show info
    byId('prescriptionDateInput').style.display = 'none';
    byId('prescriptionNoInfo').style.display = 'block';
    
    // Enable confirm button
    byId('btnConfirmValidateSwitch').disabled = false;
  }
}

function confirmValidateSwitch() {
  const switchId = window.currentValidatingSwitchId;
  if (!switchId) return;
  
  const sw = state.switches.find(s => s.id === switchId);
  if (!sw) return;
  
  // Determine renewal date based on prescription option
  let renewalDate;
  const hasPrescription = byId('btnPrescYes').classList.contains('btn-primary');
  
  if (hasPrescription) {
    // Use the date entered by user
    renewalDate = byId('prescriptionRenewalDate').value.trim();
    
    // Validate date format
    if (!renewalDate || !/^\d{2}\/\d{2}\/\d{4}$/.test(renewalDate)) {
      showToast('Veuillez entrer une date valide au format JJ/MM/AAAA', 'error');
      return;
    }
  } else {
    // Use switch date
    renewalDate = sw.switchDate;
  }
  
  // Apply switch with custom renewal date
  applySwitchWithRenewalDate(switchId, renewalDate, hasPrescription);
  
  // Close modal
  showModal(false, 'validateSwitchModal');
  
  // Refresh views
  renderSwitches();
  updateCounters();
  render();
  
  // Show success message
  const message = hasPrescription 
    ? `Switch validé avec ordonnance initiale. Date de renouvellement : ${renewalDate}` 
    : `Switch validé. Date de renouvellement définie à la date du switch : ${renewalDate}`;
  showToast(message, 'success');
}

function applySwitchWithRenewalDate(switchId, renewalDate, hasPrescription) {
  const sw = state.switches.find(s => s.id === switchId);
  if (!sw) return;
  
  const patientIndex = state.patients.findIndex(p => p.id === sw.patientId);
  if (patientIndex === -1) return;
  
  const patient = state.patients[patientIndex];
  const now = Date.now();
  
  // Initialize history if doesn't exist
  if (!patient.history) {
    patient.history = [];
  }
  
  // Add switch to history with prescription info
  const historyNotes = hasPrescription 
    ? `${sw.notes || ''}\n✅ Ordonnance initiale effectuée - Renouvellement : ${renewalDate}`.trim()
    : `${sw.notes || ''}\n⚠️ Pas d'ordonnance initiale - Renouvellement à la date du switch`.trim();
  
  patient.history.push({
    date: now,
    type: 'switch',
    field: 'Switch de pompe',
    oldValue: protoName(sw.oldProtoId) || 'Non défini',
    newValue: protoName(sw.newProtoId),
    notes: historyNotes
  });
  
  // Update patient protocol and renewal date
  state.patients[patientIndex].protoId = sw.newProtoId;
  state.patients[patientIndex].renewalDate = renewalDate;
  state.patients[patientIndex].updatedAt = now;
  
  // Calculate cycle from renewal date
  if (renewalDate) {
    const cycleInfo = getCycleFromDate(renewalDate);
    if (cycleInfo) {
      state.patients[patientIndex].currentCycle = `C${cycleInfo.cycle}-${cycleInfo.year}`;
    }
  }

  // Mark switch as completed
  sw.status = 'completed';
  sw.completedAt = now;

  // Add event to patient history
  const timeStr = sw.time ? ` à ${sw.time}` : '';
  const prescriptionInfo = hasPrescription ? ' (avec ordonnance initiale)' : ' (sans ordonnance initiale)';
  addPatientEvent(sw.patientId, 'switch_completed', `Switch effectué${prescriptionInfo} : ${protoName(sw.oldProtoId)} → ${protoName(sw.newProtoId)}`, {
    switchId: switchId,
    date: sw.switchDate,
    time: sw.time || null,
    oldProtoId: sw.oldProtoId,
    newProtoId: sw.newProtoId,
    renewalDate: renewalDate,
    hasPrescription: hasPrescription,
    completedAt: now
  });

  saveDB();
}


function deleteSwitch() {
  if (!currentSwitchId) return;
  
  if (!confirm('Supprimer ce switch ?')) return;
  
  state.switches = state.switches.filter(s => s.id !== currentSwitchId);
  saveDB();
  renderSwitches();
  updateCounters();
  showModal(false, 'switchModal');
  showToast('Switch supprimé', 'success');
}

// ===== Timeline View Functions =====
let currentSwitchView = 'list'; // 'list' or 'timeline'

function toggleSwitchView(view) {
  currentSwitchView = view;
  
  const listView = byId('listViewContainer');
  const timelineView = byId('timelineViewContainer');
  const btnList = byId('btnListView');
  const btnTimeline = byId('btnTimelineView');
  
  if (view === 'timeline') {
    listView.style.display = 'none';
    timelineView.style.display = 'block';
    btnList.classList.remove('btn-primary');
    btnList.classList.add('btn-secondary');
    btnTimeline.classList.remove('btn-secondary');
    btnTimeline.classList.add('btn-primary');
    renderTimeline();
  } else {
    listView.style.display = 'block';
    timelineView.style.display = 'none';
    btnTimeline.classList.remove('btn-primary');
    btnTimeline.classList.add('btn-secondary');
    btnList.classList.remove('btn-secondary');
    btnList.classList.add('btn-primary');
  }
}

function renderTimeline() {
  const now = new Date();
  const currentMonth = now.getMonth();
  const currentYear = now.getFullYear();
  
  // Get month name
  const monthNames = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 
                      'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
  
  // Calculate 3-month sliding window: 1 month before and 2 months after current date
  const startDate = new Date(currentYear, currentMonth - 1, 1); // 1 mois avant
  const endDate = new Date(currentYear, currentMonth + 3, 0); // 2 mois après (fin du dernier jour)
  
  // Format period display
  const startMonthName = monthNames[startDate.getMonth()];
  const startYear = startDate.getFullYear();
  const endMonthName = monthNames[endDate.getMonth()];
  const endYear = endDate.getFullYear();
  
  const periodName = startYear === endYear 
    ? `${startMonthName} - ${endMonthName} ${endYear}`
    : `${startMonthName} ${startYear} - ${endMonthName} ${endYear}`;
  
  byId('timelineMonth').textContent = periodName;
  byId('timelineMonthDisplay').textContent = `Période affichée : ${periodName} (3 mois glissants)`;
  
  // Get all switches for the 3-month period
  const periodSwitches = state.switches.filter(sw => {
    const swDate = parseDate(sw.switchDate);
    return swDate && swDate >= startDate && swDate <= endDate;
  });
  
  // Sort by date
  periodSwitches.sort((a, b) => {
    const dateA = parseDate(a.switchDate);
    const dateB = parseDate(b.switchDate);
    return dateA - dateB;
  });
  
  const container = byId('timelineContent');
  
  if (periodSwitches.length === 0) {
    container.innerHTML = `
      <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
        <svg width="64" height="64" fill="currentColor" viewBox="0 0 20 20" style="opacity: 0.3; margin-bottom: 1rem;">
          <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
        </svg>
        <p style="font-size: 18px; margin-bottom: 0.5rem;">Aucun switch prévu sur cette période</p>
        <p style="font-size: 14px;">Les switches planifiés apparaîtront ici</p>
      </div>
    `;
    return;
  }
  
  // Group switches by month for better organization
  const switchesByMonth = {};
  periodSwitches.forEach(sw => {
    const swDate = parseDate(sw.switchDate);
    const monthKey = `${swDate.getFullYear()}-${String(swDate.getMonth()).padStart(2, '0')}`;
    if (!switchesByMonth[monthKey]) {
      switchesByMonth[monthKey] = {
        month: swDate.getMonth(),
        year: swDate.getFullYear(),
        switches: []
      };
    }
    switchesByMonth[monthKey].switches.push(sw);
  });
  
  // Build timeline HTML
  let html = '<div style="position: relative; padding-left: 100px;">';
  
  // Timeline line
  html += '<div style="position: absolute; left: 60px; top: 0; bottom: 0; width: 4px; background: linear-gradient(180deg, var(--border) 0%, var(--primary) 50%, var(--border) 100%);"></div>';
  
  // Render switches grouped by month
  Object.keys(switchesByMonth).sort().forEach((monthKey, groupIndex) => {
    const group = switchesByMonth[monthKey];
    const groupMonthName = `${monthNames[group.month]} ${group.year}`;
    const isCurrentMonth = group.month === currentMonth && group.year === currentYear;
    
    // Sort switches within the month by date
    group.switches.sort((a, b) => {
      const dateA = parseDate(a.switchDate);
      const dateB = parseDate(b.switchDate);
      return dateA - dateB;
    });
    
    // Month separator
    html += `
      <div style="position: relative; margin: ${groupIndex > 0 ? '2.5rem' : '0'} 0 1.5rem 0;">
        <div style="display: inline-block; background: ${isCurrentMonth ? 'var(--primary)' : 'var(--bg-tertiary)'}; color: ${isCurrentMonth ? 'white' : 'var(--text-primary)'}; padding: 0.5rem 1.25rem; border-radius: var(--radius-full); font-weight: 700; font-size: 14px; box-shadow: var(--shadow); border: 2px solid ${isCurrentMonth ? 'var(--primary-dark)' : 'var(--border)'};">
          ${isCurrentMonth ? '📍 ' : '📅 '}${groupMonthName}
        </div>
      </div>
    `;
    
    // Timeline items for this month
    group.switches.forEach((sw, index) => {
      const patient = state.patients.find(p => p.id === sw.patientId);
      if (!patient) return;
      
      const swDate = parseDate(sw.switchDate);
      const isToday = swDate.toDateString() === now.toDateString();
      const isPast = swDate < now && !isToday;
      const isThisWeek = swDate >= now && swDate <= new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
      const isCompleted = sw.status === 'completed';
      
      // Determine color
      let color, bgColor, borderColor;
      if (isCompleted) {
        color = '#6b7280';
        bgColor = '#f3f4f6';
        borderColor = '#6b7280';
      } else if (isPast) {
        color = '#ef4444';
        bgColor = '#fee2e2';
        borderColor = '#ef4444';
      } else if (isToday) {
        color = '#f59e0b';
        bgColor = '#fef3c7';
        borderColor = '#f59e0b';
      } else if (isThisWeek) {
        color = '#3b82f6';
        bgColor = '#dbeafe';
        borderColor = '#3b82f6';
      } else {
        color = '#10b981';
        bgColor = '#d1fae5';
        borderColor = '#10b981';
      }
      
      // Format date display
      const dayNum = swDate.getDate();
      const dayName = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'][swDate.getDay()];
      
      html += `
        <div style="position: relative; margin-bottom: 2rem;">
          <!-- Date bubble -->
          <div style="position: absolute; left: -100px; top: 0; width: 80px; text-align: center;">
            <div style="background: ${color}; color: white; border-radius: var(--radius-md); padding: 0.5rem; box-shadow: var(--shadow);">
              <div style="font-size: 24px; font-weight: 700; line-height: 1;">${dayNum}</div>
              <div style="font-size: 11px; text-transform: uppercase; margin-top: 2px;">${dayName}</div>
            </div>
          </div>
          
          <!-- Content card -->
          <div style="background: ${bgColor}; border: 2px solid ${borderColor}; border-radius: var(--radius-md); padding: 1.25rem; box-shadow: var(--shadow-sm); cursor: pointer; transition: all 0.2s;" 
               onclick="openSwitchModal('${sw.id}')"
               onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='var(--shadow-md)';"
               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='var(--shadow-sm)';">
            
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
              <div>
                <h4 style="margin: 0 0 0.25rem 0; color: ${color}; font-size: 16px; font-weight: 600;">
                  ${patient.firstName} ${patient.lastName}
                </h4>
                <div style="font-size: 13px; color: var(--text-secondary);">
                  ${patient.patientCode || 'Code non défini'}${sw.time ? ` • ${sw.time}` : ''}
                </div>
              </div>
              ${isCompleted ? '<span class="badge badge-success">✅ Effectué</span>' : 
                isPast ? '<span class="badge badge-danger">⚠️ En retard</span>' :
                isToday ? '<span class="badge badge-warning">🔥 Aujourd\'hui</span>' :
                isThisWeek ? '<span class="badge badge-info">📅 Cette semaine</span>' :
                '<span class="badge badge-success">📆 À venir</span>'}
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; margin-bottom: 0.75rem;">
              <div>
                <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.25rem;">Ancien protocole</div>
                <div style="font-size: 13px; font-weight: 500;">${protoName(sw.oldProtoId) || 'Non défini'}</div>
              </div>
              <div>
                <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.25rem;">Nouveau protocole</div>
                <div style="font-size: 13px; font-weight: 600; color: ${color};">${protoName(sw.newProtoId)}</div>
              </div>
            </div>
            
            ${sw.notes ? `
              <div style="padding: 0.75rem; background: white; border-radius: var(--radius); border-left: 3px solid ${color}; font-size: 13px; color: var(--text-secondary);">
                💬 ${sw.notes}
              </div>
            ` : ''}
            
            ${!isCompleted && !isPast ? `
              <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid ${borderColor}40;">
                <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); validateSwitch('${sw.id}');" style="font-size: 12px;">
                  ✓ Valider le switch
                </button>
              </div>
            ` : ''}
          </div>
        </div>
      `;
    });
  });
  
  html += '</div>';
  
  container.innerHTML = html;
}

function renderSwitches() {
  const filter = document.querySelector('input[name="switchFilter"]:checked')?.value || 'all';
  
  // Get current date info
  const now = new Date();
  const currentMonth = now.getMonth();
  const currentYear = now.getFullYear();
  const endOfMonth = new Date(currentYear, currentMonth + 1, 0);
  
  // Filter switches
  let filtered = state.switches;
  if (filter === 'planned') {
    filtered = state.switches.filter(s => s.status === 'planned');
  } else if (filter === 'completed') {
    filtered = state.switches.filter(s => s.status === 'completed');
  }
  
  // Categorize switches
  const switchesMonth = [];
  const switchesFuture = [];
  const switchesPast = [];
  
  filtered.forEach(sw => {
    const swDate = parseDate(sw.switchDate);
    if (!swDate) return;
    
    if (sw.status === 'completed') {
      switchesPast.push(sw);
    } else {
      if (swDate <= endOfMonth && swDate >= now) {
        switchesMonth.push(sw);
      } else if (swDate > endOfMonth) {
        switchesFuture.push(sw);
      } else {
        switchesPast.push(sw);
      }
    }
  });
  
  // Render each category
  renderSwitchList('switchesMonth', switchesMonth, 'month');
  renderSwitchList('switchesFuture', switchesFuture, 'future');
  renderSwitchList('switchesPast', switchesPast, 'past');
  
  // Update counters
  byId('countSwitchesMonth').textContent = switchesMonth.length;
  byId('countSwitchesFuture').textContent = switchesFuture.length;
  byId('countSwitchesPast').textContent = switchesPast.length;
  byId('countSwitches').textContent = state.switches.filter(s => s.status === 'planned').length;
  
  // Update timeline if in timeline view
  if (currentSwitchView === 'timeline') {
    renderTimeline();
  }
}

function renderSwitchList(containerId, switches, type) {
  const container = byId(containerId);
  if (!container) return;
  
  if (switches.length === 0) {
    container.innerHTML = '<p class="text-center text-muted">Aucun switch dans cette catégorie</p>';
    return;
  }
  
  // Sort by date
  switches.sort((a, b) => {
    const dateA = parseDate(a.switchDate);
    const dateB = parseDate(b.switchDate);
    return type === 'past' ? dateB - dateA : dateA - dateB;
  });
  
  container.innerHTML = switches.map(sw => {
    const patient = state.patients.find(p => p.id === sw.patientId);
    if (!patient) return '';
    
    const statusGradient = sw.status === 'completed'
      ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)'
      : 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
    const statusColor = sw.status === 'completed' ? '#10b981' : '#f59e0b';
    const statusBadge = sw.status === 'completed' ? '✅ Effectué' : '📅 Prévu';

    return `
      <div style="position: relative; padding: 1.25rem; background: var(--bg-secondary); border-radius: var(--radius-lg); margin-bottom: 1rem; box-shadow: var(--shadow-sm); transition: var(--transition); overflow: hidden; border: 1px solid var(--border);"
           onmouseover="this.style.boxShadow='var(--shadow-md)'; this.style.transform='translateY(-2px)'"
           onmouseout="this.style.boxShadow='var(--shadow-sm)'; this.style.transform='translateY(0)'">

        <!-- Status indicator bar -->
        <div style="position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: ${statusGradient};"></div>

        <div style="display: flex; gap: 1rem;">
          <!-- Switch icon -->
          <div style="flex-shrink: 0;">
            <div style="width: 48px; height: 48px; border-radius: var(--radius); background: ${statusGradient}; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; box-shadow: var(--shadow-sm);">
              🔄
            </div>
          </div>

          <!-- Main content -->
          <div style="flex: 1; min-width: 0;">
            <!-- Header with patient name and badge -->
            <div style="display: flex; align-items: start; justify-content: space-between; gap: 1rem; margin-bottom: 0.625rem;">
              <h4 style="margin: 0; font-weight: 700; font-size: 1.125rem; color: var(--text);">${fullName(patient)}</h4>
              <span style="flex-shrink: 0; padding: 0.375rem 0.875rem; background: ${statusColor}; color: white; border-radius: var(--radius-sm); font-size: 0.8125rem; font-weight: 700; white-space: nowrap; box-shadow: var(--shadow-sm);">${statusBadge}</span>
            </div>

            <!-- Protocol change info -->
            <div style="display: flex; align-items: center; gap: 0.625rem; margin-bottom: 0.5rem; padding: 0.75rem; background: linear-gradient(135deg, rgba(139, 92, 246, 0.08) 0%, rgba(99, 102, 241, 0.08) 100%); border-radius: var(--radius); border: 1px solid rgba(139, 92, 246, 0.2);">
              <div style="display: inline-flex; align-items: center; gap: 0.375rem; padding: 0.375rem 0.75rem; background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(220, 38, 38, 0.15) 100%); border-radius: var(--radius-sm); font-size: 0.875rem;">
                <span style="font-weight: 600; color: #ef4444;">Ancien:</span>
                <span style="color: var(--text);">${protoName(sw.oldProtoId) || '—'}</span>
              </div>
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20" style="color: var(--primary); flex-shrink: 0;">
                <path fill-rule="evenodd" d="M10.293 15.707a1 1 0 010-1.414L14.586 10l-4.293-4.293a1 1 0 111.414-1.414l5 5a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                <path fill-rule="evenodd" d="M4.293 15.707a1 1 0 010-1.414L8.586 10 4.293 5.707a1 1 0 011.414-1.414l5 5a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
              </svg>
              <div style="display: inline-flex; align-items: center; gap: 0.375rem; padding: 0.375rem 0.75rem; background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(5, 150, 105, 0.15) 100%); border-radius: var(--radius-sm); font-size: 0.875rem;">
                <span style="font-weight: 600; color: #10b981;">Nouveau:</span>
                <span style="color: var(--text);">${protoName(sw.newProtoId)}</span>
              </div>
            </div>

            <!-- Date info -->
            <div style="display: inline-flex; align-items: center; gap: 0.375rem; padding: 0.375rem 0.75rem; background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%); border-radius: var(--radius-sm); font-size: 0.875rem; color: var(--text-secondary);">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
              </svg>
              <span style="font-weight: 500;">${sw.switchDate}${sw.time ? ` à ${sw.time}` : ''}</span>
            </div>

            <!-- Notes -->
            ${sw.notes ? `<div style="color: var(--text-secondary); font-size: 0.9375rem; line-height: 1.5; margin-top: 0.75rem; font-style: italic;">${sw.notes}</div>` : ''}
          </div>

          <!-- Action buttons -->
          <div style="flex-shrink: 0; display: flex; gap: 0.5rem;">
            ${sw.status === 'planned' ? `
              <button class="btn btn-sm" onclick="validateSwitch('${sw.id}')" title="Valider le switch"
                      style="padding: 0.625rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: var(--radius); box-shadow: var(--shadow-sm); transition: var(--transition);"
                      onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='var(--shadow-md)'"
                      onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='var(--shadow-sm)'">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                </svg>
              </button>
            ` : ''}
            <button class="btn btn-sm" onclick="openSwitchModal('${sw.id}')" title="Modifier"
                    style="padding: 0.625rem; background: linear-gradient(135deg, var(--primary) 0%, #5b21b6 100%); color: white; border: none; border-radius: var(--radius); box-shadow: var(--shadow-sm); transition: var(--transition);"
                    onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='var(--shadow-md)'"
                    onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='var(--shadow-sm)'">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

// ===== Helper Functions for Existing Events Display =====
// ===== Patient Info Sidebar Display Functions =====
function displayAppointmentPatientInfo(patientId) {
  const sidebar = byId('appointmentPatientInfo');
  const modalBody = sidebar?.closest('.modal-body-split');

  if (!sidebar) return;

  if (!patientId) {
    sidebar.style.display = 'none';
    if (modalBody) modalBody.classList.remove('has-sidebar');
    return;
  }

  const patient = state.patients.find(p => p.id === patientId);

  if (!patient) {
    sidebar.style.display = 'none';
    if (modalBody) modalBody.classList.remove('has-sidebar');
    return;
  }

  // Populate patient info
  byId('appointmentPatientName').textContent = fullName(patient) || '-';
  byId('appointmentPatientDob').textContent = patient.dob ? `Né(e) le ${patient.dob}` : '-';
  byId('appointmentPatientPhone').textContent = patient.phone || '-';
  byId('appointmentPatientEmail').textContent = patient.email || '-';
  byId('appointmentPatientDoctor').textContent = docName(patient.docId) || '-';
  byId('appointmentPatientCenter').textContent = centerName(patient.centerId) || '-';
  byId('appointmentPatientProtocol').textContent = protoName(patient.protoId) || '-';
  byId('appointmentPatientRenewal').textContent = patient.renewalDate || '-';

  // Display quality score with progress bar
  const score = qScore(patient);
  const scoreEl = byId('appointmentPatientScore');
  scoreEl.innerHTML = `
    <div style="display: flex; align-items: center; gap: 0.5rem;">
      <div style="flex: 1; background: rgba(0,0,0,0.1); border-radius: 999px; height: 8px; overflow: hidden;">
        <div style="width: ${score}%; height: 100%; background: linear-gradient(90deg, ${score < 50 ? '#ef4444' : score < 80 ? '#f59e0b' : '#10b981'}, ${score < 50 ? '#dc2626' : score < 80 ? '#d97706' : '#059669'}); transition: width 0.3s ease;"></div>
      </div>
      <span style="font-weight: 700; color: ${score < 50 ? '#ef4444' : score < 80 ? '#f59e0b' : '#10b981'};">${score}%</span>
    </div>
  `;

  // Display notes if present
  const notesContainer = byId('appointmentPatientNotesContainer');
  const notesEl = byId('appointmentPatientNotes');
  if (patient.notes && patient.notes.trim()) {
    notesEl.textContent = patient.notes;
    notesContainer.style.display = 'block';
  } else {
    notesContainer.style.display = 'none';
  }

  sidebar.style.display = 'block';
  if (modalBody) modalBody.classList.add('has-sidebar');
}

function displaySwitchPatientInfo(patientId) {
  const sidebar = byId('switchPatientInfo');
  const modalBody = sidebar?.closest('.modal-body-split');

  if (!sidebar) return;

  if (!patientId) {
    sidebar.style.display = 'none';
    if (modalBody) modalBody.classList.remove('has-sidebar');
    return;
  }

  const patient = state.patients.find(p => p.id === patientId);

  if (!patient) {
    sidebar.style.display = 'none';
    if (modalBody) modalBody.classList.remove('has-sidebar');
    return;
  }

  // Populate patient info
  byId('switchPatientName').textContent = fullName(patient) || '-';
  byId('switchPatientDob').textContent = patient.dob ? `Né(e) le ${patient.dob}` : '-';
  byId('switchPatientPhone').textContent = patient.phone || '-';
  byId('switchPatientEmail').textContent = patient.email || '-';
  byId('switchPatientDoctor').textContent = docName(patient.docId) || '-';
  byId('switchPatientCenter').textContent = centerName(patient.centerId) || '-';
  byId('switchPatientProtocol').textContent = protoName(patient.protoId) || '-';
  byId('switchPatientRenewal').textContent = patient.renewalDate || '-';

  // Display quality score with progress bar
  const score = qScore(patient);
  const scoreEl = byId('switchPatientScore');
  scoreEl.innerHTML = `
    <div style="display: flex; align-items: center; gap: 0.5rem;">
      <div style="flex: 1; background: rgba(0,0,0,0.1); border-radius: 999px; height: 8px; overflow: hidden;">
        <div style="width: ${score}%; height: 100%; background: linear-gradient(90deg, ${score < 50 ? '#ef4444' : score < 80 ? '#f59e0b' : '#10b981'}, ${score < 50 ? '#dc2626' : score < 80 ? '#d97706' : '#059669'}); transition: width 0.3s ease;"></div>
      </div>
      <span style="font-weight: 700; color: ${score < 50 ? '#ef4444' : score < 80 ? '#f59e0b' : '#10b981'};">${score}%</span>
    </div>
  `;

  // Display notes if present
  const notesContainer = byId('switchPatientNotesContainer');
  const notesEl = byId('switchPatientNotes');
  if (patient.notes && patient.notes.trim()) {
    notesEl.textContent = patient.notes;
    notesContainer.style.display = 'block';
  } else {
    notesContainer.style.display = 'none';
  }

  sidebar.style.display = 'block';
  if (modalBody) modalBody.classList.add('has-sidebar');
}

function checkExistingAppointments(patientId) {
  const alert = byId('existingAppointmentsAlert');
  const list = byId('existingAppointmentsList');

  if (!alert || !list || !patientId) {
    if (alert) alert.style.display = 'none';
    return;
  }

  // Find existing appointments for this patient (excluding current one if editing)
  const existingAppointments = state.appointments.filter(apt =>
    apt.patientId === patientId &&
    apt.status === 'active' &&
    apt.id !== currentAppointmentId
  );

  if (existingAppointments.length === 0) {
    alert.style.display = 'none';
    return;
  }

  // Sort by date
  existingAppointments.sort((a, b) => {
    const dateA = a.exactDate ? parseDateFR(a.exactDate) : (a.month ? new Date(parseInt(a.month.split('/')[1]), parseInt(a.month.split('/')[0]) - 1, 1) : null);
    const dateB = b.exactDate ? parseDateFR(b.exactDate) : (b.month ? new Date(parseInt(b.month.split('/')[1]), parseInt(b.month.split('/')[0]) - 1, 1) : null);
    if (!dateA) return 1;
    if (!dateB) return -1;
    return dateA - dateB;
  });

  // Display appointments
  list.innerHTML = existingAppointments.map(apt => {
    let dateDisplay;
    if (apt.exactDate) {
      dateDisplay = `📅 ${apt.exactDate}${apt.time ? ` à ${apt.time}` : ''}`;
    } else if (apt.month) {
      const parts = apt.month.split('/');
      const monthNames = ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Aoû', 'Sep', 'Oct', 'Nov', 'Déc'];
      dateDisplay = `📞 ${monthNames[parseInt(parts[0]) - 1]} ${parts[1]} (à préciser)`;
    } else {
      dateDisplay = '❓ Date non définie';
    }

    return `
      <div style="padding: 0.5rem; background: rgba(255,255,255,0.5); border-radius: var(--radius-sm); margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
        <span style="font-weight: 600;">${dateDisplay}</span>
        <span style="font-size: 0.875rem; color: var(--text-secondary);">${apt.type || 'Suivi'}</span>
      </div>
    `;
  }).join('');

  alert.style.display = 'block';
}

function checkExistingSwitches(patientId) {
  const alert = byId('existingSwitchesAlert');
  const list = byId('existingSwitchesList');

  if (!alert || !list || !patientId) {
    if (alert) alert.style.display = 'none';
    return;
  }

  // Find existing switches for this patient (excluding current one if editing)
  const existingSwitches = state.switches.filter(sw =>
    sw.patientId === patientId &&
    sw.status === 'planned' &&
    sw.id !== currentSwitchId
  );

  if (existingSwitches.length === 0) {
    alert.style.display = 'none';
    return;
  }

  // Sort by date
  existingSwitches.sort((a, b) => {
    const dateA = parseDateFR(a.switchDate);
    const dateB = parseDateFR(b.switchDate);
    if (!dateA) return 1;
    if (!dateB) return -1;
    return dateA - dateB;
  });

  // Display switches
  list.innerHTML = existingSwitches.map(sw => {
    return `
      <div style="padding: 0.5rem; background: rgba(255,255,255,0.5); border-radius: var(--radius-sm); margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
        <span style="font-weight: 600;">🔄 ${sw.switchDate}${sw.time ? ` à ${sw.time}` : ''}</span>
        <span style="font-size: 0.875rem; color: var(--text-secondary);">${protoName(sw.oldProtoId)} → ${protoName(sw.newProtoId)}</span>
      </div>
    `;
  }).join('');

  alert.style.display = 'block';
}

// ===== Appointments Management System =====
function openAppointmentModal(appointmentId = null) {
  currentAppointmentId = appointmentId;

  // Populate patient select
  const patientSelect = byId('appointmentPatientId');
  patientSelect.innerHTML = '<option value="">-- Sélectionner un patient --</option>' +
    state.patients.map(p => `<option value="${p.id}">${fullName(p)}</option>`).join('');

  // Make patient select searchable
  setTimeout(() => {
    makeSelectSearchable(
      'appointmentPatientId',
      () => state.patients,
      (p) => fullName(p),
      'Rechercher un patient...'
    );
  }, 0);

  if (appointmentId) {
    // Edit mode
    const apt = state.appointments.find(a => a.id === appointmentId);
    if (!apt) return;
    
    byId('appointmentModalTitle').textContent = 'Modifier le suivi';
    byId('btnDeleteAppointment').classList.remove('hidden');
    
    byId('appointmentPatientId').value = apt.patientId;
    
    if (apt.exactDate) {
      document.querySelector('input[name="appointmentType"][value="date"]').checked = true;
      byId('appointmentDate').value = apt.exactDate;
    } else {
      document.querySelector('input[name="appointmentType"][value="month"]').checked = true;
      byId('appointmentMonth').value = apt.month;
    }

    toggleAppointmentType();
    byId('appointmentTime').value = apt.time || '';
    byId('appointmentNotes').value = apt.notes || '';
  } else {
    // New mode
    byId('appointmentModalTitle').textContent = 'Planifier un suivi';
    byId('btnDeleteAppointment').classList.add('hidden');

    byId('appointmentPatientId').value = '';
    byId('appointmentDate').value = '';
    byId('appointmentTime').value = '';
    byId('appointmentMonth').value = '';
    byId('appointmentNotes').value = '';

    document.querySelector('input[name="appointmentType"][value="date"]').checked = true;
    toggleAppointmentType();
  }

  // Add event listener for patient selection
  patientSelect.onchange = function() {
    checkExistingAppointments(this.value);
    displayAppointmentPatientInfo(this.value);
  };

  // Check existing appointments and display patient info if editing with a patient already selected
  if (appointmentId && patientSelect.value) {
    checkExistingAppointments(patientSelect.value);
    displayAppointmentPatientInfo(patientSelect.value);
  }

  showModal(true, 'appointmentModal');
}

function toggleAppointmentType() {
  const type = document.querySelector('input[name="appointmentType"]:checked').value;

  if (type === 'date') {
    byId('appointmentDateGroup').classList.remove('hidden');
    byId('appointmentTimeGroup').classList.remove('hidden');
    byId('appointmentMonthGroup').classList.add('hidden');
    byId('appointmentDate').required = true;
    byId('appointmentMonth').required = false;
  } else {
    byId('appointmentDateGroup').classList.add('hidden');
    byId('appointmentTimeGroup').classList.add('hidden');
    byId('appointmentMonthGroup').classList.remove('hidden');
    byId('appointmentDate').required = false;
    byId('appointmentMonth').required = true;
  }
}

function saveAppointment() {
  const patientId = byId('appointmentPatientId').value;
  const type = document.querySelector('input[name="appointmentType"]:checked').value;
  const notes = byId('appointmentNotes').value.trim();
  const time = byId('appointmentTime').value.trim();

  if (!patientId) {
    showToast('Veuillez sélectionner un patient', 'error');
    return;
  }

  let exactDate = null;
  let month = null;

  if (type === 'date') {
    exactDate = byId('appointmentDate').value.trim();
    if (!exactDate) {
      showToast('Veuillez saisir une date', 'error');
      return;
    }
    // Validate DD/MM/YYYY format
    if (!exactDate.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
      showToast('Format de date invalide (JJ/MM/AAAA)', 'error');
      return;
    }
  } else {
    month = byId('appointmentMonth').value.trim();
    if (!month) {
      showToast('Veuillez saisir un mois', 'error');
      return;
    }
    // Validate MM/YYYY format
    if (!month.match(/^\d{2}\/\d{4}$/)) {
      showToast('Format de mois invalide (MM/AAAA)', 'error');
      return;
    }
  }
  
  // Check if patient already has an active appointment
  const existingActive = state.appointments.find(a => 
    a.patientId === patientId && 
    a.status === 'active' && 
    (!currentAppointmentId || a.id !== currentAppointmentId)
  );
  
  if (existingActive) {
    showToast('Ce patient a déjà un suivi actif', 'warning');
    return;
  }
  
  if (currentAppointmentId) {
    // Update
    const index = state.appointments.findIndex(a => a.id === currentAppointmentId);
    if (index !== -1) {
      state.appointments[index] = {
        ...state.appointments[index],
        patientId,
        exactDate,
        month,
        time: time || null,
        notes,
        updatedAt: Date.now()
      };

      // Add event to patient history
      const patient = state.patients.find(p => p.id === patientId);
      if (patient) {
        const dateStr = exactDate || month;
        const timeStr = time ? ` à ${time}` : '';
        addPatientEvent(patientId, 'appointment_updated', `Modification du rendez-vous du ${dateStr}${timeStr}`, {
          appointmentId: currentAppointmentId,
          date: exactDate || month,
          time: time || null,
          notes: notes
        });
      }

      showToast('Suivi modifié', 'success');
    }
  } else {
    // Create
    const newAppointment = {
      id: generateId(),
      patientId,
      exactDate,
      month,
      time: time || null,
      notes,
      status: 'active',
      history: [],
      createdAt: Date.now(),
      updatedAt: Date.now()
    };
    state.appointments.push(newAppointment);

    // Add event to patient history
    const patient = state.patients.find(p => p.id === patientId);
    if (patient) {
      const dateStr = exactDate || month;
      const timeStr = time ? ` à ${time}` : '';
      addPatientEvent(patientId, 'appointment_created', `Rendez-vous planifié pour le ${dateStr}${timeStr}`, {
        appointmentId: newAppointment.id,
        date: exactDate || month,
        time: time || null,
        notes: notes
      });
    }

    showToast('Suivi planifié', 'success');
  }
  
  saveDB();
  renderAppointments();
  updateAppointmentStats();
  renderDashboard();
  showModal(false, 'appointmentModal');
}

function deleteAppointment() {
  if (!currentAppointmentId) return;
  
  if (!confirm('Supprimer ce suivi ?')) return;
  
  state.appointments = state.appointments.filter(a => a.id !== currentAppointmentId);
  saveDB();
  renderAppointments();
  updateAppointmentStats();
  renderDashboard();
  showModal(false, 'appointmentModal');
  showToast('Suivi supprimé', 'success');
}

function completeAppointment(appointmentId) {
  const apt = state.appointments.find(a => a.id === appointmentId);
  if (!apt) return;
  
  const patient = state.patients.find(p => p.id === apt.patientId);
  if (!patient) return;
  
  currentAppointmentId = appointmentId;
  
  // Fill modal
  byId('completePatientName').textContent = fullName(patient);
  
  if (apt.exactDate) {
    // Parse DD/MM/YYYY
    const parts = apt.exactDate.split('/');
    if (parts.length === 3) {
      const day = parseInt(parts[0], 10);
      const month = parseInt(parts[1], 10) - 1;
      const year = parseInt(parts[2], 10);
      const date = new Date(year, month, day);
      let dateText = date.toLocaleDateString('fr-FR', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      if (apt.time) {
        dateText += ` à ${apt.time}`;
      }
      byId('completeAppointmentInfo').textContent = dateText;
    } else {
      byId('completeAppointmentInfo').textContent = apt.exactDate + (apt.time ? ` à ${apt.time}` : '');
    }
  } else {
    // Parse MM/YYYY
    const parts = apt.month.split('/');
    if (parts.length === 2) {
      const monthNames = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin',
                          'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
      byId('completeAppointmentInfo').textContent = `${monthNames[parseInt(parts[0], 10) - 1]} ${parts[1]}`;
    } else {
      byId('completeAppointmentInfo').textContent = apt.month;
    }
  }
  
  byId('completeNotes').value = '';
  byId('nextAppointmentDate').value = '';
  byId('nextAppointmentTime').value = '';
  byId('nextAppointmentMonth').value = '';
  byId('nextAppointmentNotes').value = '';

  document.querySelector('input[name="nextAppointmentType"][value="date"]').checked = true;
  toggleNextAppointmentType();
  
  showModal(true, 'completeAppointmentModal');
}

function toggleNextAppointmentType() {
  const type = document.querySelector('input[name="nextAppointmentType"]:checked').value;

  if (type === 'date') {
    byId('nextAppointmentDateGroup').classList.remove('hidden');
    byId('nextAppointmentTimeGroup').classList.remove('hidden');
    byId('nextAppointmentMonthGroup').classList.add('hidden');
  } else {
    byId('nextAppointmentDateGroup').classList.add('hidden');
    byId('nextAppointmentTimeGroup').classList.add('hidden');
    byId('nextAppointmentMonthGroup').classList.remove('hidden');
  }
}

function confirmCompleteAppointment() {
  const type = document.querySelector('input[name="nextAppointmentType"]:checked').value;
  const completeNotes = byId('completeNotes').value.trim();
  const nextNotes = byId('nextAppointmentNotes').value.trim();
  const nextTime = byId('nextAppointmentTime').value.trim();

  let nextExactDate = null;
  let nextMonth = null;

  if (type === 'date') {
    nextExactDate = byId('nextAppointmentDate').value.trim();
    if (!nextExactDate) {
      showToast('Veuillez saisir la date du prochain suivi', 'error');
      return;
    }
    // Validate DD/MM/YYYY format
    if (!nextExactDate.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
      showToast('Format de date invalide (JJ/MM/AAAA)', 'error');
      return;
    }
  } else {
    nextMonth = byId('nextAppointmentMonth').value.trim();
    if (!nextMonth) {
      showToast('Veuillez saisir le mois du prochain suivi', 'error');
      return;
    }
    // Validate MM/YYYY format
    if (!nextMonth.match(/^\d{2}\/\d{4}$/)) {
      showToast('Format de mois invalide (MM/AAAA)', 'error');
      return;
    }
  }

  const apt = state.appointments.find(a => a.id === currentAppointmentId);
  if (!apt) return;

  const now = Date.now();

  // Add to history
  if (!apt.history) apt.history = [];
  apt.history.push({
    completedAt: now,
    scheduledDate: apt.exactDate || apt.month,
    notes: completeNotes,
    type: apt.exactDate ? 'date' : 'month'
  });

  // Update appointment with next occurrence
  apt.exactDate = nextExactDate;
  apt.month = nextMonth;
  apt.time = nextTime || null;
  apt.notes = nextNotes;
  apt.updatedAt = now;

  saveDB();
  renderAppointments();
  updateAppointmentStats();
  renderDashboard();
  showModal(false, 'completeAppointmentModal');
  showToast('Suivi validé et prochain RDV planifié', 'success');
}

function renderAppointments() {
  const filter = document.querySelector('input[name="appointmentFilter"]:checked')?.value || 'all';
  const search = byId('appointmentSearch')?.value.toLowerCase() || '';
  
  // Get current date info
  const now = new Date();
  const currentYear = now.getFullYear();
  const currentMonth = now.getMonth();
  const currentMonthStr = `${String(currentMonth + 1).padStart(2, '0')}/${currentYear}`;
  const next30Days = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);
  
  console.log('=== renderAppointments Debug ===');
  console.log('Filter:', filter);
  console.log('Current month (0-based):', currentMonth, '(display:', currentMonth + 1, ')');
  console.log('Current year:', currentYear);
  console.log('Current month string:', currentMonthStr);
  console.log('Total appointments:', state.appointments.length);
  
  // Filter active appointments
  let filtered = state.appointments.filter(a => a.status === 'active');
  console.log('Active appointments:', filtered.length);
  
  // Apply filters
  if (filter === 'thisMonth') {
    filtered = filtered.filter(a => {
      console.log('Checking appointment:', a);
      
      if (a.exactDate) {
        // Parse DD/MM/YYYY
        const parts = a.exactDate.split('/');
        console.log('  Exact date parts:', parts);
        if (parts.length === 3) {
          const day = parseInt(parts[0], 10);
          const month = parseInt(parts[1], 10) - 1; // 0-based
          const year = parseInt(parts[2], 10);
          const aptDate = new Date(year, month, day);
          console.log(`  Parsed: day=${day}, month=${month} (display: ${month+1}), year=${year}`);
          console.log('  Date object:', aptDate);
          console.log('  aptDate.getMonth():', aptDate.getMonth(), 'currentMonth:', currentMonth);
          const matches = aptDate.getMonth() === currentMonth && aptDate.getFullYear() === currentYear;
          console.log('  Matches this month:', matches);
          return matches;
        }
      } else if (a.month) {
        console.log('  Month format:', a.month);
        const matches = a.month === currentMonthStr;
        console.log('  Matches this month:', matches);
        return matches;
      }
      console.log('  No date info');
      return false;
    });
  } else if (filter === 'next30') {
    filtered = filtered.filter(a => {
      if (a.exactDate) {
        // Parse DD/MM/YYYY
        const parts = a.exactDate.split('/');
        if (parts.length === 3) {
          const day = parseInt(parts[0], 10);
          const month = parseInt(parts[1], 10) - 1;
          const year = parseInt(parts[2], 10);
          const aptDate = new Date(year, month, day);
          return aptDate <= next30Days && aptDate >= now;
        }
      }
      return false;
    });
  } else if (filter === 'toCall') {
    filtered = filtered.filter(a => !a.exactDate && a.month === currentMonthStr);
  }
  
  console.log('Filtered appointments:', filtered.length);
  
  // Apply search
  if (search) {
    filtered = filtered.filter(a => {
      const patient = state.patients.find(p => p.id === a.patientId);
      return patient && fullName(patient).toLowerCase().includes(search);
    });
  }
  
  // Sort
  filtered.sort((a, b) => {
    // Exact dates first, sorted by date
    if (a.exactDate && b.exactDate) {
      const partsA = a.exactDate.split('/');
      const partsB = b.exactDate.split('/');
      const dateA = new Date(parseInt(partsA[2], 10), parseInt(partsA[1], 10) - 1, parseInt(partsA[0], 10));
      const dateB = new Date(parseInt(partsB[2], 10), parseInt(partsB[1], 10) - 1, parseInt(partsB[0], 10));
      return dateA - dateB;
    }
    if (a.exactDate && !b.exactDate) return -1;
    if (!a.exactDate && b.exactDate) return 1;
    
    // Then months
    if (a.month && b.month) {
      return a.month.localeCompare(b.month);
    }
    return 0;
  });
  
  // Render
  const container = byId('appointmentsList');
  if (!container) return;
  
  if (filtered.length === 0) {
    container.innerHTML = '<p class="text-center text-muted">Aucun suivi trouvé</p>';
    return;
  }
  
  container.innerHTML = filtered.map(apt => {
    const patient = state.patients.find(p => p.id === apt.patientId);
    if (!patient) return '';
    
    let dateDisplay, badgeClass, badgeText, isUrgent;
    
    if (apt.exactDate) {
      // Parse DD/MM/YYYY
      const parts = apt.exactDate.split('/');
      const day = parseInt(parts[0], 10);
      const month = parseInt(parts[1], 10) - 1;
      const year = parseInt(parts[2], 10);
      const aptDate = new Date(year, month, day);
      const diffDays = Math.ceil((aptDate - now) / (1000 * 60 * 60 * 24));
      
      dateDisplay = aptDate.toLocaleDateString('fr-FR', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });

      // Add time if specified
      if (apt.time) {
        dateDisplay += ` à ${apt.time}`;
      }
      
      if (diffDays < 0) {
        badgeClass = 'badge-danger';
        badgeText = `Retard: ${Math.abs(diffDays)}j`;
        isUrgent = true;
      } else if (diffDays === 0) {
        badgeClass = 'badge-danger';
        badgeText = 'Aujourd\'hui !';
        isUrgent = true;
      } else if (diffDays <= 7) {
        badgeClass = 'badge-warning';
        badgeText = `Dans ${diffDays}j`;
        isUrgent = true;
      } else {
        badgeClass = 'badge-info';
        badgeText = `Dans ${diffDays}j`;
        isUrgent = false;
      }
    } else {
      // Parse MM/YYYY
      const parts = apt.month.split('/');
      const monthNames = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 
                          'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
      dateDisplay = `${monthNames[parseInt(parts[0], 10) - 1]} ${parts[1]}`;
      
      if (apt.month === currentMonthStr) {
        badgeClass = 'badge-warning';
        badgeText = '📞 À rappeler';
        isUrgent = true;
      } else {
        badgeClass = 'badge-info';
        badgeText = 'Mois prévu';
        isUrgent = false;
      }
    }
    
    // Gradient colors based on urgency
    const urgentGradient = isUrgent ?
      'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)' :
      'linear-gradient(135deg, #06b6d4 0%, #0891b2 100%)';
    const urgentIconBg = isUrgent ? '#f59e0b' : '#06b6d4';

    return `
      <div style="position: relative; padding: 1.25rem; background: var(--bg-secondary); border-radius: var(--radius-lg); margin-bottom: 1rem; box-shadow: var(--shadow-sm); transition: var(--transition); overflow: hidden; border: 1px solid var(--border);"
           onmouseover="this.style.boxShadow='var(--shadow-md)'; this.style.transform='translateY(-2px)'"
           onmouseout="this.style.boxShadow='var(--shadow-sm)'; this.style.transform='translateY(0)'">

        <!-- Urgency indicator bar -->
        <div style="position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: ${urgentGradient};"></div>

        <div style="display: flex; gap: 1rem;">
          <!-- Patient icon -->
          <div style="flex-shrink: 0;">
            <div style="width: 48px; height: 48px; border-radius: var(--radius); background: ${urgentGradient}; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; box-shadow: var(--shadow-sm);">
              👤
            </div>
          </div>

          <!-- Main content -->
          <div style="flex: 1; min-width: 0;">
            <!-- Header with patient name and badge -->
            <div style="display: flex; align-items: start; justify-content: space-between; gap: 1rem; margin-bottom: 0.625rem;">
              <h4 style="margin: 0; font-weight: 700; font-size: 1.125rem; color: var(--text);">${fullName(patient)}</h4>
              <span style="flex-shrink: 0; padding: 0.375rem 0.875rem; background: ${urgentIconBg}; color: white; border-radius: var(--radius-sm); font-size: 0.8125rem; font-weight: 700; white-space: nowrap; box-shadow: var(--shadow-sm);">${badgeText}</span>
            </div>

            <!-- Date and type info -->
            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: ${apt.history && apt.history.length > 0 ? '0.5rem' : '0'};">
              <div style="display: inline-flex; align-items: center; gap: 0.375rem; padding: 0.375rem 0.75rem; background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%); border-radius: var(--radius-sm); font-size: 0.875rem; color: var(--text-secondary);">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
                </svg>
                <span style="font-weight: 500;">${dateDisplay}</span>
              </div>

              ${apt.history && apt.history.length > 0 ? `
                <div style="display: inline-flex; align-items: center; gap: 0.375rem; padding: 0.375rem 0.75rem; background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%); border-radius: var(--radius-sm); font-size: 0.875rem; color: var(--text-secondary);">
                  <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                  </svg>
                  <span style="font-weight: 500;">${apt.history.length} suivi${apt.history.length > 1 ? 's' : ''}</span>
                </div>
              ` : ''}
            </div>

            <!-- Notes -->
            ${apt.notes ? `<div style="color: var(--text-secondary); font-size: 0.9375rem; line-height: 1.5; margin-top: 0.5rem; font-style: italic;">${apt.notes}</div>` : ''}
          </div>

          <!-- Action buttons -->
          <div style="flex-shrink: 0; display: flex; gap: 0.5rem;">
            <button class="btn btn-sm" onclick="completeAppointment('${apt.id}')" title="Marquer comme réalisé"
                    style="padding: 0.625rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: var(--radius); box-shadow: var(--shadow-sm); transition: var(--transition);"
                    onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='var(--shadow-md)'"
                    onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='var(--shadow-sm)'">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
              </svg>
            </button>
            <button class="btn btn-sm" onclick="openAppointmentModal('${apt.id}')" title="Modifier"
                    style="padding: 0.625rem; background: linear-gradient(135deg, var(--primary) 0%, #5b21b6 100%); color: white; border: none; border-radius: var(--radius); box-shadow: var(--shadow-sm); transition: var(--transition);"
                    onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='var(--shadow-md)'"
                    onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='var(--shadow-sm)'">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function updateAppointmentStats() {
  const now = new Date();
  const currentYear = now.getFullYear();
  const currentMonth = now.getMonth();
  const currentMonthStr = `${String(currentMonth + 1).padStart(2, '0')}/${currentYear}`;
  const next30Days = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);
  
  const activeAppointments = state.appointments.filter(a => a.status === 'active');
  
  // This month
  const thisMonth = activeAppointments.filter(a => {
    if (a.exactDate) {
      // Parse DD/MM/YYYY
      const parts = a.exactDate.split('/');
      if (parts.length === 3) {
        const day = parseInt(parts[0], 10);
        const month = parseInt(parts[1], 10) - 1;
        const year = parseInt(parts[2], 10);
        const aptDate = new Date(year, month, day);
        return aptDate.getMonth() === currentMonth && aptDate.getFullYear() === currentYear;
      }
    } else if (a.month) {
      return a.month === currentMonthStr;
    }
    return false;
  }).length;
  
  // To call (month = current month, no exact date)
  const toCall = activeAppointments.filter(a => 
    !a.exactDate && a.month === currentMonthStr
  ).length;
  
  // Next 30 days (exact dates only)
  const next30 = activeAppointments.filter(a => {
    if (a.exactDate) {
      // Parse DD/MM/YYYY
      const parts = a.exactDate.split('/');
      if (parts.length === 3) {
        const day = parseInt(parts[0], 10);
        const month = parseInt(parts[1], 10) - 1;
        const year = parseInt(parts[2], 10);
        const aptDate = new Date(year, month, day);
        return aptDate <= next30Days && aptDate >= now;
      }
    }
    return false;
  }).length;
  
  // Total completed
  const totalCompleted = state.appointments.reduce((sum, a) => 
    sum + (a.history ? a.history.length : 0), 0
  );
  
  byId('kpiAppointmentsThisMonth').textContent = thisMonth;
  byId('kpiAppointmentsToCall').textContent = toCall;
  byId('kpiAppointmentsNext30').textContent = next30;
  byId('kpiAppointmentsDone').textContent = totalCompleted;
  byId('countAppointments').textContent = toCall;
}

// ===== Tasks Management System =====
function openTaskModal(taskId = null) {
  currentTaskId = taskId;

  if (taskId) {
    // Edit mode
    const task = state.tasks.find(t => t.id === taskId);
    if (!task) return;

    byId('taskModalTitle').textContent = 'Modifier la tâche';
    byId('btnDeleteTask').classList.remove('hidden');

    byId('taskTitle').value = task.title;
    byId('taskDescription').value = task.description || '';
    byId('taskStatus').value = task.status;
    byId('taskPriority').value = task.priority;
    byId('taskDueDate').value = task.dueDate || '';
    byId('taskDueTime').value = task.dueTime || '';
    byId('taskRelationType').value = task.relationType || 'none';
    byId('taskTags').value = task.tags ? task.tags.join(', ') : '';

    updateTaskRelationOptions();
    if (task.relationId) {
      byId('taskRelationId').value = task.relationId;
    }
  } else {
    // New mode
    byId('taskModalTitle').textContent = 'Nouvelle tâche';
    byId('btnDeleteTask').classList.add('hidden');

    byId('taskTitle').value = '';
    byId('taskDescription').value = '';
    byId('taskStatus').value = 'todo';
    byId('taskPriority').value = 'normal';
    byId('taskDueDate').value = '';
    byId('taskDueTime').value = '';
    byId('taskRelationType').value = 'none';
    byId('taskRelationId').value = '';
    byId('taskTags').value = '';

    updateTaskRelationOptions();
  }

  showModal(true, 'taskModal');
}

function updateTaskRelationOptions() {
  const relationType = byId('taskRelationType').value;
  const relationGroup = byId('taskRelationGroup');
  const relationLabel = byId('taskRelationLabel');
  const relationSelect = byId('taskRelationId');

  if (relationType === 'none') {
    relationGroup.style.display = 'none';
    return;
  }

  relationGroup.style.display = 'block';

  let options = '<option value="">-- Sélectionner --</option>';
  let label = '';

  switch (relationType) {
    case 'patient':
      label = 'Patient';
      options += state.patients.map(p =>
        `<option value="${p.id}">${fullName(p)}</option>`
      ).join('');
      break;
    case 'doctor':
      label = 'Médecin';
      options += state.docs.map(d =>
        `<option value="${d.id}">${d.name}</option>`
      ).join('');
      break;
    case 'center':
      label = 'Centre';
      options += state.centers.map(c =>
        `<option value="${c.id}">${c.name}</option>`
      ).join('');
      break;
    case 'protocol':
      label = 'Protocole';
      options += state.protos.map(p =>
        `<option value="${p.id}">${p.name}</option>`
      ).join('');
      break;
  }

  relationLabel.textContent = label;
  relationSelect.innerHTML = options;
}

function saveTask() {
  const title = byId('taskTitle').value.trim();
  const description = byId('taskDescription').value.trim();
  const status = byId('taskStatus').value;
  const priority = byId('taskPriority').value;
  const dueDate = byId('taskDueDate').value.trim();
  const dueTime = byId('taskDueTime').value.trim();
  const relationType = byId('taskRelationType').value;
  const relationId = byId('taskRelationId').value;
  const tagsStr = byId('taskTags').value.trim();

  if (!title) {
    showToast('Le titre est requis', 'error');
    return;
  }

  // Validate date format if provided
  if (dueDate && !dueDate.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
    showToast('Format de date invalide (JJ/MM/AAAA)', 'error');
    return;
  }

  const tags = tagsStr ? tagsStr.split(',').map(t => t.trim()).filter(t => t) : [];

  const taskData = {
    title,
    description,
    status,
    priority,
    dueDate: dueDate || null,
    dueTime: dueTime || null,
    relationType: relationType !== 'none' ? relationType : null,
    relationId: relationId || null,
    tags,
    updatedAt: Date.now()
  };

  if (currentTaskId) {
    // Update existing task
    const index = state.tasks.findIndex(t => t.id === currentTaskId);
    if (index !== -1) {
      state.tasks[index] = {
        ...state.tasks[index],
        ...taskData
      };
      showToast('Tâche modifiée', 'success');
    }
  } else {
    // Create new task
    state.tasks.push({
      id: generateId(),
      ...taskData,
      createdAt: Date.now()
    });
    showToast('Tâche créée', 'success');
  }

  saveDB();
  renderTasks();
  updateCounters();
  showModal(false, 'taskModal');
}

function deleteTask() {
  if (!currentTaskId) return;

  if (!confirm('Êtes-vous sûr de vouloir supprimer cette tâche ?')) {
    return;
  }

  state.tasks = state.tasks.filter(t => t.id !== currentTaskId);
  saveDB();
  renderTasks();
  updateCounters();
  showModal(false, 'taskModal');
  showToast('Tâche supprimée', 'success');
}

function toggleTaskStatus(taskId) {
  const task = state.tasks.find(t => t.id === taskId);
  if (!task) return;

  // Cycle through statuses: todo -> in_progress -> completed -> todo
  const statusCycle = {
    'todo': 'in_progress',
    'in_progress': 'completed',
    'completed': 'todo'
  };

  task.status = statusCycle[task.status] || 'todo';
  task.updatedAt = Date.now();

  if (task.status === 'completed') {
    task.completedAt = Date.now();
  } else {
    delete task.completedAt;
  }

  saveDB();
  renderTasks();
  updateCounters();
}

function renderTasks() {
  const container = byId('tasksList');
  if (!container) return;

  const statusFilter = document.querySelector('input[name="taskStatusFilter"]:checked')?.value || 'all';
  const priorityFilter = document.querySelector('input[name="taskPriorityFilter"]:checked')?.value || 'all';
  const searchQuery = byId('taskSearch')?.value.toLowerCase().trim() || '';

  let filteredTasks = state.tasks;

  // Filter by status
  if (statusFilter !== 'all') {
    filteredTasks = filteredTasks.filter(t => t.status === statusFilter);
  }

  // Filter by priority
  if (priorityFilter !== 'all') {
    filteredTasks = filteredTasks.filter(t => t.priority === priorityFilter);
  }

  // Filter by search
  if (searchQuery) {
    filteredTasks = filteredTasks.filter(t =>
      t.title.toLowerCase().includes(searchQuery) ||
      (t.description && t.description.toLowerCase().includes(searchQuery)) ||
      (t.tags && t.tags.some(tag => tag.toLowerCase().includes(searchQuery)))
    );
  }

  // Sort: urgent first, then by due date, then by creation date
  filteredTasks.sort((a, b) => {
    // Priority order
    const priorityOrder = { urgent: 0, high: 1, normal: 2, low: 3 };
    const priorityDiff = priorityOrder[a.priority] - priorityOrder[b.priority];
    if (priorityDiff !== 0) return priorityDiff;

    // Due date order (tasks with due dates come first)
    if (a.dueDate && !b.dueDate) return -1;
    if (!a.dueDate && b.dueDate) return 1;
    if (a.dueDate && b.dueDate) {
      const dateA = parseDateFR(a.dueDate);
      const dateB = parseDateFR(b.dueDate);
      if (dateA && dateB) {
        const diff = dateA - dateB;
        if (diff !== 0) return diff;
      }
    }

    // Creation date (newest first)
    return b.createdAt - a.createdAt;
  });

  if (filteredTasks.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">📋</div><div class="empty-state-title">Aucune tâche</div><div class="empty-state-description">Créez votre première tâche pour commencer</div></div>';
    return;
  }

  const priorityIcons = {
    low: '🟢',
    normal: '🟡',
    high: '🟠',
    urgent: '🔴'
  };

  const statusLabels = {
    todo: 'À faire',
    in_progress: 'En cours',
    completed: 'Terminée'
  };

  const statusColors = {
    todo: 'var(--primary)',
    in_progress: 'var(--warning)',
    completed: 'var(--success)'
  };

  // Priority gradient backgrounds
  const priorityGradients = {
    low: 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
    normal: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)',
    high: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)',
    urgent: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)'
  };

  container.innerHTML = filteredTasks.map(task => {
    let relationInfo = '';
    if (task.relationType && task.relationId) {
      let relationName = '';
      switch (task.relationType) {
        case 'patient':
          const patient = state.patients.find(p => p.id === task.relationId);
          relationName = patient ? fullName(patient) : '';
          break;
        case 'doctor':
          relationName = docName(task.relationId);
          break;
        case 'center':
          relationName = centerName(task.relationId);
          break;
        case 'protocol':
          relationName = protoName(task.relationId);
          break;
      }
      if (relationName) {
        const icons = { patient: '👤', doctor: '👨‍⚕️', center: '🏥', protocol: '💊' };
        relationInfo = `<div style="display: inline-flex; align-items: center; gap: 0.375rem; padding: 0.375rem 0.75rem; background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(99, 102, 241, 0.1) 100%); border-radius: var(--radius-sm); font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem;"><span style="font-size: 1rem;">${icons[task.relationType]}</span> ${relationName}</div>`;
      }
    }

    const dueDateInfo = task.dueDate ? `
      <div style="display: inline-flex; align-items: center; gap: 0.375rem; padding: 0.375rem 0.75rem; background: linear-gradient(135deg, rgba(236, 72, 153, 0.1) 0%, rgba(219, 39, 119, 0.1) 100%); border-radius: var(--radius-sm); font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem;">
        <span style="font-size: 1rem;">📅</span> ${task.dueDate}${task.dueTime ? ' à ' + task.dueTime : ''}
      </div>
    ` : '';

    const tagsHtml = task.tags && task.tags.length > 0 ? `
      <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem;">
        ${task.tags.map(tag => `<span style="padding: 0.375rem 0.625rem; background: linear-gradient(135deg, rgba(14, 165, 233, 0.15) 0%, rgba(6, 182, 212, 0.15) 100%); border: 1px solid rgba(14, 165, 233, 0.3); border-radius: var(--radius-sm); font-size: 0.8125rem; color: var(--text); font-weight: 500;">#${tag}</span>`).join('')}
      </div>
    ` : '';

    return `
      <div style="position: relative; padding: 1.25rem; background: var(--bg-secondary); border-radius: var(--radius-lg); margin-bottom: 1rem; box-shadow: var(--shadow-sm); transition: var(--transition); overflow: hidden; border: 1px solid var(--border);"
           onmouseover="this.style.boxShadow='var(--shadow-md)'; this.style.transform='translateY(-2px)'"
           onmouseout="this.style.boxShadow='var(--shadow-sm)'; this.style.transform='translateY(0)'">

        <!-- Priority indicator bar -->
        <div style="position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: ${priorityGradients[task.priority]};"></div>

        <div style="display: flex; gap: 1rem;">
          <!-- Status toggle button -->
          <div style="flex-shrink: 0;">
            <button onclick="toggleTaskStatus('${task.id}')"
                    style="width: 40px; height: 40px; border-radius: var(--radius); border: none; background: ${task.status === 'completed' ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)' : 'linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%)'}; color: ${task.status === 'completed' ? 'white' : 'var(--text-secondary)'}; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.125rem; box-shadow: var(--shadow-sm); transition: var(--transition);"
                    onmouseover="this.style.transform='scale(1.05)'"
                    onmouseout="this.style.transform='scale(1)'">
              ${task.status === 'completed' ? '✓' : task.status === 'in_progress' ? '⏳' : '○'}
            </button>
          </div>

          <!-- Main content -->
          <div style="flex: 1; min-width: 0;">
            <!-- Header with priority and status -->
            <div style="display: flex; align-items: start; justify-content: space-between; gap: 1rem; margin-bottom: 0.625rem;">
              <div style="display: flex; align-items: center; gap: 0.625rem;">
                <!-- Priority badge -->
                <div style="display: flex; align-items: center; justify-content: center; width: 36px; height: 36px; background: ${priorityGradients[task.priority]}; border-radius: var(--radius); box-shadow: var(--shadow-sm);">
                  <span style="font-size: 1.25rem;">${priorityIcons[task.priority]}</span>
                </div>
                <!-- Title -->
                <div style="font-weight: 700; font-size: 1.0625rem; color: var(--text); ${task.status === 'completed' ? 'text-decoration: line-through; opacity: 0.6;' : ''}">${task.title}</div>
              </div>
              <!-- Status badge -->
              <span style="flex-shrink: 0; padding: 0.375rem 0.875rem; background: ${statusColors[task.status]}; color: white; border-radius: var(--radius-sm); font-size: 0.8125rem; font-weight: 700; white-space: nowrap; box-shadow: var(--shadow-sm); text-transform: uppercase; letter-spacing: 0.025em;">${statusLabels[task.status]}</span>
            </div>

            <!-- Description -->
            ${task.description ? `<div style="color: var(--text-secondary); margin-top: 0.5rem; font-size: 0.9375rem; line-height: 1.5; ${task.status === 'completed' ? 'opacity: 0.6;' : ''}">${task.description}</div>` : ''}

            <!-- Meta information -->
            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: ${task.description ? '0.75rem' : '0.5rem'};">
              ${relationInfo}
              ${dueDateInfo}
            </div>

            <!-- Tags -->
            ${tagsHtml}
          </div>

          <!-- Edit button -->
          <div style="flex-shrink: 0;">
            <button class="btn btn-sm" onclick="openTaskModal('${task.id}')"
                    style="padding: 0.625rem; background: linear-gradient(135deg, var(--primary) 0%, #5b21b6 100%); color: white; border: none; border-radius: var(--radius); box-shadow: var(--shadow-sm); transition: var(--transition);"
                    onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='var(--shadow-md)'"
                    onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='var(--shadow-sm)'">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"></path><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"></path></svg>
            </button>
          </div>
        </div>
      </div>
    `;
  }).join('');

  updateTasksKPIs();
}

function updateTasksKPIs() {
  const todo = state.tasks.filter(t => t.status === 'todo').length;
  const inProgress = state.tasks.filter(t => t.status === 'in_progress').length;
  const completed = state.tasks.filter(t => t.status === 'completed').length;
  const urgent = state.tasks.filter(t => t.priority === 'urgent' && t.status !== 'completed').length;

  byId('kpiTasksTodo').textContent = todo;
  byId('kpiTasksInProgress').textContent = inProgress;
  byId('kpiTasksCompleted').textContent = completed;
  byId('kpiTasksUrgent').textContent = urgent;

  // Update badge in sidebar
  const activeTasks = todo + inProgress;
  byId('countTasks').textContent = activeTasks;
}

// ===== Auto-Save System =====
let autoSaveConfig = {
  enabled: false,
  fileHandle: null,
  fileName: null,
  lastSave: null,
  saveTimeout: null,
  supportsFileSystem: false
};

// Check if File System Access API is supported
function checkFileSystemSupport() {
  autoSaveConfig.supportsFileSystem = 'showSaveFilePicker' in window;
  
  if (!autoSaveConfig.supportsFileSystem) {
    const notice = byId('autoSaveFallbackNotice');
    if (notice) notice.style.display = 'block';
  }
  
  // Load saved config
  const savedConfig = localStorage.getItem('autoSaveConfig');
  if (savedConfig) {
    try {
      const config = JSON.parse(savedConfig);
      autoSaveConfig.enabled = config.enabled || false;
      autoSaveConfig.fileName = config.fileName || null;
      autoSaveConfig.lastSave = config.lastSave || null;
      updateAutoSaveUI();
    } catch (e) {
      console.error('Error loading auto-save config:', e);
    }
  }
}

async function configureAutoSave() {
  if (!autoSaveConfig.supportsFileSystem) {
    showToast('Votre navigateur ne supporte pas cette fonctionnalité. Utilisez Chrome ou Edge.', 'error');
    return;
  }
  
  try {
    // Ask user where to save
    const handle = await window.showSaveFilePicker({
      suggestedName: 'nhc-patients-backup.json',
      types: [{
        description: 'Fichier JSON',
        accept: { 'application/json': ['.json'] }
      }]
    });
    
    autoSaveConfig.fileHandle = handle;
    autoSaveConfig.fileName = handle.name;
    autoSaveConfig.enabled = true;
    
    // Save config (but not the file handle as it's not serializable)
    saveAutoSaveConfig();
    
    // Perform initial save
    await performAutoSave();
    
    showToast('Sauvegarde automatique configurée avec succès ! 🎉', 'success');
    updateAutoSaveUI();
    
  } catch (err) {
    if (err.name !== 'AbortError') {
      console.error('Error configuring auto-save:', err);
      showToast('Erreur lors de la configuration: ' + err.message, 'error');
    }
  }
}

async function performAutoSave() {
  if (!autoSaveConfig.enabled || !autoSaveConfig.fileHandle) {
    return;
  }

  try {
    // Prepare data - Include EVERYTHING from state
    const data = {
      version: '4.0',
      exportDate: new Date().toISOString(),
      data: state  // Include ALL state data (patients, docs, centers, protos, switches, appointments, and any future additions)
    };

    // Count history events for verification
    const patientHistoryCount = state.patients.reduce((total, p) => total + (p.history?.length || 0), 0);
    const appointmentHistoryCount = state.appointments.reduce((total, a) => total + (a.history?.length || 0), 0);
    const totalHistoryEvents = patientHistoryCount + appointmentHistoryCount;

    // Write to file
    const writable = await autoSaveConfig.fileHandle.createWritable();
    await writable.write(JSON.stringify(data, null, 2));
    await writable.close();

    // Update last save time
    autoSaveConfig.lastSave = Date.now();
    saveAutoSaveConfig();
    updateAutoSaveUI();

    console.log('✅ Auto-save completed:', new Date().toLocaleString());
    console.log('📊 Saved data:', {
      patients: state.patients?.length || 0,
      docs: state.docs?.length || 0,
      centers: state.centers?.length || 0,
      protos: state.protos?.length || 0,
      switches: state.switches?.length || 0,
      appointments: state.appointments?.length || 0,
      tasks: state.tasks?.length || 0,
      prescriptionTemplates: state.prescriptionTemplates?.length || 0,
      shortcuts: state.shortcuts?.length || 0,
      patientHistoryEvents: patientHistoryCount,
      appointmentHistoryEvents: appointmentHistoryCount,
      totalHistoryEvents: totalHistoryEvents
    });

  } catch (err) {
    console.error('❌ Auto-save failed:', err);

    // If permission denied, ask to reconfigure
    if (err.name === 'NotAllowedError') {
      showToast('Permission refusée. Veuillez reconfigurer la sauvegarde automatique.', 'warning');
      autoSaveConfig.fileHandle = null;
      autoSaveConfig.enabled = false;
      saveAutoSaveConfig();
      updateAutoSaveUI();
    }
  }
}

function scheduleAutoSave() {
  if (!autoSaveConfig.enabled) return;
  
  // Debounce: wait 2 seconds after last change
  if (autoSaveConfig.saveTimeout) {
    clearTimeout(autoSaveConfig.saveTimeout);
  }
  
  autoSaveConfig.saveTimeout = setTimeout(() => {
    performAutoSave();
  }, 2000);
}

function toggleAutoSave(enable) {
  if (enable && !autoSaveConfig.fileHandle) {
    showToast('Veuillez d\'abord configurer la sauvegarde', 'warning');
    configureAutoSave();
    return;
  }
  
  autoSaveConfig.enabled = enable;
  saveAutoSaveConfig();
  updateAutoSaveUI();
  
  if (enable) {
    showToast('Sauvegarde automatique activée ✅', 'success');
    performAutoSave();
  } else {
    showToast('Sauvegarde automatique désactivée', 'info');
  }
}

function saveNow() {
  if (!autoSaveConfig.fileHandle) {
    showToast('Veuillez d\'abord configurer la sauvegarde', 'warning');
    return;
  }
  
  performAutoSave();
  showToast('Sauvegarde manuelle en cours...', 'info');
}

async function restoreFromAutoSave() {
  if (!autoSaveConfig.supportsFileSystem) {
    showToast('Utilisez l\'import JSON classique', 'info');
    return;
  }

  if (!confirm('⚠️ Cette action va remplacer toutes vos données actuelles par celles de la sauvegarde automatique. Continuer ?')) {
    return;
  }

  try {
    if (!autoSaveConfig.fileHandle) {
      showToast('Aucun fichier de sauvegarde configuré', 'warning');
      return;
    }

    const file = await autoSaveConfig.fileHandle.getFile();
    const content = await file.text();
    const parsed = JSON.parse(content);

    // Support both old and new backup formats
    let data;
    if (parsed.version && parsed.data) {
      // New format with version wrapper (v4.0+)
      data = parsed.data;
      console.log(`Restoring from backup version ${parsed.version} dated ${parsed.exportDate}`);
    } else {
      // Old format (direct data)
      data = parsed;
    }

    // Count history events for verification
    const patientHistoryCount = (data.patients || []).reduce((total, p) => total + (p.history?.length || 0), 0);
    const appointmentHistoryCount = (data.appointments || []).reduce((total, a) => total + (a.history?.length || 0), 0);
    const totalHistoryEvents = patientHistoryCount + appointmentHistoryCount;

    // Restore ALL state data
    state = {
      patients: data.patients || [],
      docs: data.docs || [],
      centers: data.centers || [],
      protos: data.protos || [],
      switches: data.switches || [],
      appointments: data.appointments || [],
      tasks: data.tasks || [],
      prescriptionTemplates: data.prescriptionTemplates || [],
      shortcuts: data.shortcuts || []
    };

    console.log('📊 Restored data:', {
      patients: state.patients.length,
      docs: state.docs.length,
      centers: state.centers.length,
      protos: state.protos.length,
      switches: state.switches.length,
      appointments: state.appointments.length,
      tasks: state.tasks.length,
      prescriptionTemplates: state.prescriptionTemplates.length,
      shortcuts: state.shortcuts.length,
      patientHistoryEvents: patientHistoryCount,
      appointmentHistoryEvents: appointmentHistoryCount,
      totalHistoryEvents: totalHistoryEvents
    });

    saveDB();
    render();

    // Detailed success message
    const message = `✅ Restauration réussie !\n${state.patients.length} patients (${patientHistoryCount} événements historique)\n${state.appointments.length} rendez-vous (${appointmentHistoryCount} événements)\n${state.tasks.length} tâches, ${state.shortcuts.length} raccourcis, ${state.prescriptionTemplates.length} modèles\nTotal: ${totalHistoryEvents} événements restaurés`;
    showToast(message, 'success');

  } catch (err) {
    console.error('Error restoring from auto-save:', err);
    showToast('Erreur lors de la restauration: ' + err.message, 'error');
  }
}

function saveAutoSaveConfig() {
  const config = {
    enabled: autoSaveConfig.enabled,
    fileName: autoSaveConfig.fileName,
    lastSave: autoSaveConfig.lastSave
  };
  localStorage.setItem('autoSaveConfig', JSON.stringify(config));
}

function updateAutoSaveUI() {
  const status = byId('autoSaveStatus');
  const info = byId('autoSaveInfo');
  const fileName = byId('autoSaveFileName');
  const lastTime = byId('autoSaveLastTime');
  const count = byId('autoSaveCount');
  
  const btnConfigure = byId('btnConfigureAutoSave');
  const btnEnable = byId('btnEnableAutoSave');
  const btnDisable = byId('btnDisableAutoSave');
  const btnSaveNow = byId('btnSaveNow');
  const btnRestore = byId('btnRestoreFromAutoSave');
  
  if (!status) return;
  
  if (autoSaveConfig.fileHandle && autoSaveConfig.enabled) {
    // Active
    status.innerHTML = '<span class="badge badge-success">✅ Activée</span>';
    info.style.display = 'block';
    
    if (fileName) fileName.textContent = autoSaveConfig.fileName || 'Non défini';
    if (lastTime) {
      if (autoSaveConfig.lastSave) {
        const date = new Date(autoSaveConfig.lastSave);
        lastTime.textContent = date.toLocaleString('fr-FR');
      } else {
        lastTime.textContent = 'Jamais';
      }
    }
    if (count) {
      const total = state.patients.length + state.docs.length + state.centers.length + 
                    state.protos.length + state.switches.length + state.appointments.length;
      count.textContent = `${total} éléments`;
    }
    
    if (btnConfigure) btnConfigure.textContent = '⚙️ Reconfigurer';
    if (btnEnable) btnEnable.classList.add('hidden');
    if (btnDisable) btnDisable.classList.remove('hidden');
    if (btnSaveNow) btnSaveNow.classList.remove('hidden');
    if (btnRestore) btnRestore.classList.remove('hidden');
    
  } else if (autoSaveConfig.fileHandle && !autoSaveConfig.enabled) {
    // Configured but disabled
    status.innerHTML = '<span class="badge badge-warning">⏸️ Désactivée</span>';
    info.style.display = 'block';
    
    if (fileName) fileName.textContent = autoSaveConfig.fileName || 'Non défini';
    if (lastTime) {
      if (autoSaveConfig.lastSave) {
        const date = new Date(autoSaveConfig.lastSave);
        lastTime.textContent = date.toLocaleString('fr-FR') + ' (désactivée)';
      } else {
        lastTime.textContent = 'Jamais';
      }
    }
    if (count) count.textContent = '-';
    
    if (btnConfigure) btnConfigure.textContent = '⚙️ Reconfigurer';
    if (btnEnable) btnEnable.classList.remove('hidden');
    if (btnDisable) btnDisable.classList.add('hidden');
    if (btnSaveNow) btnSaveNow.classList.add('hidden');
    if (btnRestore) btnRestore.classList.remove('hidden');
    
  } else {
    // Not configured
    status.innerHTML = '<span class="badge badge-secondary">❌ Non configurée</span>';
    info.style.display = 'none';
    
    if (btnConfigure) btnConfigure.textContent = '🔧 Configurer la sauvegarde';
    if (btnEnable) btnEnable.classList.add('hidden');
    if (btnDisable) btnDisable.classList.add('hidden');
    if (btnSaveNow) btnSaveNow.classList.add('hidden');
    if (btnRestore) btnRestore.classList.add('hidden');
  }
}

// Trigger auto-save on data changes
function triggerAutoSave() {
  if (autoSaveConfig.enabled && autoSaveConfig.fileHandle) {
    scheduleAutoSave();
  }
}

// ===== CSV Import System =====
let csvImportState = {
  rawData: null,
  parsedData: [],
  headers: [],
  separator: null,
  mapping: {}
};

const CSV_FIELD_MAPPING = {
  lastName: 'Nom',
  firstName: 'Prénom',
  dob: 'Date de naissance',
  email: 'Email',
  phone: 'Téléphone',
  address: 'Adresse',
  renewalDate: 'Date de renouvellement',
  docName: 'Médecin',
  centerName: 'Centre',
  protoName: 'Protocole',
  notes: 'Notes'
};

// Fonction pour nettoyer les noms de colonnes
function cleanHeaderName(header) {
  if (!header) return '';
  
  return String(header)
    .replace(/\r?\n/g, ' ')           // Remplacer les retours à la ligne par des espaces
    .replace(/\s+/g, ' ')             // Normaliser les espaces multiples
    .replace(/^[<>]+$/g, 'PRENOM')    // Remplacer "<<<<<<<<<" par PRENOM
    .replace(/unnamed:\s*\d+/i, '')   // Supprimer "Unnamed: X"
    .trim()                           // Enlever espaces début/fin
    .toUpperCase();                   // Mettre en majuscules pour la comparaison
}

function detectSeparator(text) {
  const lines = text.split('\n').slice(0, 10).filter(l => l.trim()); // Analyser plus de lignes
  const separators = [',', ';', '\t', '|'];
  let bestSeparator = ',';
  let maxScore = 0;
  
  for (const sep of separators) {
    // Compter les occurrences dans chaque ligne
    const counts = lines.map(line => {
      // Ne pas compter les séparateurs dans les guillemets
      let count = 0;
      let inQuotes = false;
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"' || char === "'") {
          inQuotes = !inQuotes;
        } else if (char === sep && !inQuotes) {
          count++;
        }
      }
      return count;
    });
    
    // Vérifier la consistance
    if (counts.length === 0) continue;
    
    const avgCount = counts.reduce((a, b) => a + b, 0) / counts.length;
    const isConsistent = counts.every(c => Math.abs(c - avgCount) <= 1); // Tolérance de 1
    
    if (isConsistent && avgCount > maxScore) {
      maxScore = avgCount;
      bestSeparator = sep;
    }
  }
  
  return bestSeparator;
}

function parseCSVAdvanced(text, separator = null) {
  if (!text) return { headers: [], rows: [], separator: ',' };
  
  const detectedSep = separator || detectSeparator(text);
  
  // Parse CSV avec gestion des guillemets
  const parseCSVLine = (line, sep) => {
    const result = [];
    let current = '';
    let inQuotes = false;
    
    for (let i = 0; i < line.length; i++) {
      const char = line[i];
      const nextChar = line[i + 1];
      
      if (char === '"' || char === "'") {
        if (inQuotes && nextChar === char) {
          // Double quote - c'est un échappement
          current += char;
          i++; // Skip le prochain
        } else {
          // Toggle quote mode
          inQuotes = !inQuotes;
        }
      } else if (char === sep && !inQuotes) {
        // Séparateur hors guillemets - fin de cellule
        result.push(current.trim());
        current = '';
      } else {
        current += char;
      }
    }
    
    // Ajouter la dernière cellule
    result.push(current.trim());
    
    return result;
  };
  
  const lines = text.split(/\r?\n/);
  
  if (lines.length === 0) return { headers: [], rows: [], separator: detectedSep };
  
  // Parse header
  const rawHeaders = parseCSVLine(lines[0], detectedSep);
  const headers = rawHeaders.map(h => cleanHeaderName(h));
  const numColumns = headers.length;
  const rows = [];
  
  // Parse data rows
  for (let i = 1; i < lines.length; i++) {
    const line = lines[i].trim();
    if (!line) continue; // Skip empty lines
    
    const values = parseCSVLine(line, detectedSep);
    
    // Ajuster le nombre de colonnes si nécessaire
    while (values.length < numColumns) {
      values.push(''); // Ajouter des cellules vides
    }
    
    // Tronquer si trop de colonnes
    if (values.length > numColumns) {
      values.length = numColumns;
    }
    
    // Accepter toutes les lignes, même celles avec peu de données
    rows.push(values);
  }
  
  return { headers, rows, separator: detectedSep };
}

function openCSVImport() {
  showModal(true, 'csvImportModal');
  // Reset state
  csvReset();
  
  // Initialize CSV Import if not already done
  if (!byId('dropZone').hasAttribute('data-csv-init')) {
    initCSVImport();
    byId('dropZone').setAttribute('data-csv-init', 'true');
  }
}

function loadCSVFile() {
  const file = byId('csvFileInput').files[0];
  if (!file) {
    showToast('Sélectionnez un fichier CSV', 'warning');
    return;
  }
  
  const reader = new FileReader();
  const encoding = byId('csvEncoding').value;
  
  reader.onload = (e) => {
    csvImportState.rawData = e.target.result;
    const separator = byId('csvSeparator').value === 'auto' ? null : byId('csvSeparator').value;
    const parsed = parseCSVAdvanced(csvImportState.rawData, separator);
    
    csvImportState.headers = parsed.headers;
    csvImportState.parsedData = parsed.rows;
    csvImportState.separator = parsed.separator;
    
    // Display preview
    displayCSVPreview();
    
    // Move to step 2
    byId('csvStep1').style.display = 'none';
    byId('csvStep2').style.display = 'block';
  };
  
  reader.readAsText(file, encoding);
}

function displayCSVPreview() {
  const table = byId('csvPreviewTable');
  const maxRows = Math.min(10, csvImportState.parsedData.length);

  // Helper function to try converting any value that might be a date
  const tryConvertDate = (val) => {
    if (!val && val !== 0) return val;

    // Convert to string if it's a number
    const valStr = String(val).trim();
    if (!valStr) return val;

    // Test 1: Try to parse as number (Excel date format)
    const asNumber = parseFloat(valStr);

    // Debug: log values that might be dates
    if (!isNaN(asNumber) && asNumber > 100 && asNumber < 100000) {
      console.log('CSV Preview - Potential date value:', valStr, 'as number:', asNumber);
    }

    if (!isNaN(asNumber) && asNumber > 1000 && asNumber < 100000) {
      // Likely an Excel date number - convert directly here
      try {
        const excelEpoch = new Date(1899, 11, 30);
        const date = new Date(excelEpoch.getTime() + asNumber * 24 * 60 * 60 * 1000);
        if (!isNaN(date.getTime())) {
          const year = date.getFullYear();
          if (year >= 1900 && year <= 2100) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const converted = `${day}/${month}/${year}`;
            console.log('CSV Preview - Converted date:', valStr, '->', converted);
            return converted;
          }
        }
      } catch (e) {
        console.error('CSV Preview - Date conversion error:', e);
      }
    }

    // Test 2: Check if it looks like a date pattern and try to convert
    const datePatterns = [
      /^\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{2,4}$/,  // DD/MM/YYYY variants
      /^\d{4}[\/\-\.]\d{1,2}[\/\-\.]\d{1,2}$/,    // YYYY-MM-DD variants
    ];

    const looksLikeDate = datePatterns.some(pattern => pattern.test(valStr));
    if (looksLikeDate) {
      const converted = convertDateFormat(valStr);
      if (converted) return converted;
    }

    // Not a date, return original value
    return val;
  };

  let html = '<div style="overflow-x: auto;"><table class="table"><thead><tr>';

  // Headers with column numbers
  csvImportState.headers.forEach((header, idx) => {
    html += `<th style="min-width: 100px;">Col ${idx + 1}<br><span class="text-small text-muted">${header}</span></th>`;
  });
  html += '</tr></thead><tbody>';

  // Preview rows
  for (let i = 0; i < maxRows; i++) {
    html += '<tr>';
    const row = csvImportState.parsedData[i];
    for (let j = 0; j < csvImportState.headers.length; j++) {
      const val = row[j] || '';

      // Try to convert to date format for display
      const displayVal = tryConvertDate(val);

      // Truncate if too long
      const truncatedVal = String(displayVal).length > 50 ? String(displayVal).substring(0, 47) + '...' : displayVal;
      html += `<td title="${String(val).replace(/"/g, '&quot;')}">${truncatedVal || '—'}</td>`;
    }
    html += '</tr>';
  }

  html += '</tbody></table></div>';

  if (csvImportState.parsedData.length > maxRows) {
    html += `<p class="text-muted text-center mt-2">... et ${csvImportState.parsedData.length - maxRows} lignes supplémentaires</p>`;
  }

  table.innerHTML = html;

  const sepDisplay = csvImportState.separator === '\t' ? 'Tabulation' :
                     csvImportState.separator === ',' ? 'Virgule (,)' :
                     csvImportState.separator === ';' ? 'Point-virgule (;)' :
                     csvImportState.separator;

  byId('csvRowCount').textContent = `${csvImportState.parsedData.length} lignes détectées (${csvImportState.headers.length} colonnes)`;
  byId('csvSeparatorInfo').textContent = `Séparateur: ${sepDisplay}`;
}

function goToMapping() {
  // Create mapping interface
  const mappingDiv = byId('csvMappingFields');
  let html = '<div class="form-grid">';
  
  for (const [field, label] of Object.entries(CSV_FIELD_MAPPING)) {
    html += `
      <div class="form-group">
        <label class="form-label">${label}</label>
        <select class="form-select" id="map_${field}">
          <option value="">-- Ne pas importer --</option>
          ${csvImportState.headers.map((h, idx) => 
            `<option value="${idx}">${h} (Col ${idx + 1})</option>`
          ).join('')}
        </select>
      </div>
    `;
  }
  
  html += '</div>';
  mappingDiv.innerHTML = html;
  
  // Try auto-mapping based on header names
  autoMapFields();
  
  // Move to step 3
  byId('csvStep2').style.display = 'none';
  byId('csvStep3').style.display = 'block';
}

function autoMapFields() {
  const mappings = {
    lastName: ['nom', 'last_name', 'lastname', 'surname', 'family', 'nom de famille', 'nom_famille'],
    firstName: ['prenom', 'prénom', 'first_name', 'firstname', 'givenname', 'given', 'first', 'prénom_usuel'],
    dob: ['date_naissance', 'naissance', 'birth', 'dob', 'date_of_birth', 'ddn', 'date de naissance', 'né', 'née', 'date naissance', 'birthdate', 'datedenaissance'],
    email: ['email', 'mail', 'courriel', 'e-mail', 'e_mail', 'courrier', 'adresse_mail', 'adresse_email'],
    phone: ['telephone', 'téléphone', 'phone', 'tel', 'mobile', 'portable', 'gsm', 'cellulaire', 'tel_portable', 'tel_mobile', 'numero_tel', 'numero_telephone', 'téléphone_portable'],
    address: ['adresse', 'address', 'rue', 'street', 'domicile', 'adresse_postale', 'adresse_complete', 'voie'],
    patientCode: ['code', 'id_patient', 'identifiant', 'patient_code', 'patient_id', 'numero', 'numéro', 'n°', 'noota', 'numero_patient', 'code_patient', 'ref', 'reference', 'référence'],
    renewalDate: ['renouvellement', 'renewal', 'date_renouvellement', 'ordonnance', 'prochaine', 'ordo', 'date ordo', 'date_ordonnance', 'date_renew', 'renew_date', 'prochaine_visite'],
    docName: ['medecin', 'médecin', 'doctor', 'doc', 'prescripteur', 'diabetologue', 'diabétologue', 'nom_medecin', 'nom_docteur', 'praticien', 'dr'],
    centerName: ['centre', 'center', 'site', 'hopital', 'hôpital', 'hospital', 'etablissement', 'établissement', 'clinique', 'nom_centre'],
    protoName: ['protocole', 'protocol', 'proto', 'matériel', 'materiel', 'pompe', 'dispositif', 'traitement', 'nom_protocole', 'type_materiel'],
    notes: ['notes', 'note', 'commentaire', 'comment', 'remarque', 'observation', 'info', 'remarques', 'observations', 'commentaires']
  };

  // Détecter si on a des colonnes séparées pour l'adresse (ADRESSE + CP + VILLE)
  let hasAddressColumns = false;
  let addressColIndex = -1;
  let cpColIndex = -1;
  let villeColIndex = -1;

  for (let i = 0; i < csvImportState.headers.length; i++) {
    const header = csvImportState.headers[i].toLowerCase().replace(/[\s_\-]/g, '');
    if (header.includes('adresse') || header.includes('address') || header.includes('rue') || header === 'voie') {
      addressColIndex = i;
    } else if (header.includes('cp') || header.includes('codepostal') || header.includes('postal') || header === 'zip') {
      cpColIndex = i;
    } else if (header.includes('ville') || header.includes('city') || header.includes('commune') || header === 'localite' || header === 'town') {
      villeColIndex = i;
    }
  }

  hasAddressColumns = (addressColIndex >= 0 && cpColIndex >= 0 && villeColIndex >= 0);

  // Track which columns have been mapped to avoid duplicates
  const mappedColumns = new Set();

  for (const [field, keywords] of Object.entries(mappings)) {
    const select = byId(`map_${field}`);
    if (!select) continue;

    // Pour le champ adresse, si on a des colonnes séparées, prendre la première
    if (field === 'address' && hasAddressColumns) {
      select.value = String(addressColIndex);
      mappedColumns.add(addressColIndex);
      continue;
    }

    // Try to find best match
    let bestMatch = -1;
    let bestMatchScore = 0;

    for (let i = 0; i < csvImportState.headers.length; i++) {
      if (mappedColumns.has(i)) continue; // Skip already mapped columns

      const header = csvImportState.headers[i].toLowerCase().replace(/[\s_\-]/g, '');

      // Calculate match score
      for (const keyword of keywords) {
        const normalizedKeyword = keyword.toLowerCase().replace(/[\s_\-]/g, '');

        // Exact match = 100 points
        if (header === normalizedKeyword) {
          bestMatch = i;
          bestMatchScore = 100;
          break;
        }

        // Contains keyword = 50 points
        if (header.includes(normalizedKeyword)) {
          if (50 > bestMatchScore) {
            bestMatch = i;
            bestMatchScore = 50;
          }
        }

        // Keyword contains header = 30 points (for short headers)
        if (normalizedKeyword.includes(header) && header.length >= 3) {
          if (30 > bestMatchScore) {
            bestMatch = i;
            bestMatchScore = 30;
          }
        }
      }

      if (bestMatchScore === 100) break; // Perfect match found
    }

    if (bestMatch >= 0 && bestMatchScore >= 30) {
      select.value = String(bestMatch);
      mappedColumns.add(bestMatch);
    }
  }
}

function executeCSVImport() {
  // Get mapping
  csvImportState.mapping = {};

  for (const field of Object.keys(CSV_FIELD_MAPPING)) {
    const select = document.getElementById(`map_${field}`);

    if (select && select.value !== '') {
      csvImportState.mapping[field] = parseInt(select.value);
    }
  }

  // Check if at least name is mapped - vérifier avec 'in' pour éviter le problème avec la valeur 0
  if (!('lastName' in csvImportState.mapping) && !('firstName' in csvImportState.mapping)) {
    showToast('Mappez au moins le nom ou le prénom', 'error');
    return;
  }

  // Import data
  let imported = 0;
  let errors = [];
  let skipped = 0;
  let warnings = [];

  // Helper functions for validation
  const validateEmail = (email) => {
    if (!email) return true; // Email is optional
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(String(email).toLowerCase());
  };

  const validatePhone = (phone) => {
    if (!phone) return true; // Phone is optional
    // Accept various phone formats
    const cleaned = String(phone).replace(/[\s\.\-\(\)]/g, '');
    return /^[\+]?[\d]{8,15}$/.test(cleaned);
  };

  const normalizePhone = (phone) => {
    if (!phone) return '';
    let cleaned = String(phone).trim().replace(/[\s\.\-]/g, '');
    // Format french phone numbers
    if (cleaned.length === 10 && cleaned.startsWith('0')) {
      return cleaned.replace(/(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/, '$1 $2 $3 $4 $5');
    }
    return phone;
  };

  const cleanString = (str) => {
    if (!str) return '';
    return String(str).trim().replace(/\s+/g, ' ');
  };

  const isDuplicate = (patient) => {
    // Check for duplicate by name + dob or patientCode
    return state.patients.some(p => {
      // Check by patient code if both have it
      if (patient.patientCode && p.patientCode &&
          patient.patientCode.toLowerCase() === p.patientCode.toLowerCase()) {
        return true;
      }
      // Check by name and date of birth
      if (patient.lastName && p.lastName && patient.firstName && p.firstName && patient.dob && p.dob) {
        return patient.lastName.toLowerCase() === p.lastName.toLowerCase() &&
               patient.firstName.toLowerCase() === p.firstName.toLowerCase() &&
               patient.dob === p.dob;
      }
      return false;
    });
  };

  for (let i = 0; i < csvImportState.parsedData.length; i++) {
    const row = csvImportState.parsedData[i];

    try {
      // Extract values based on mapping
      const getValue = (field) => {
        const idx = csvImportState.mapping[field];
        if (idx === undefined) return '';
        const value = row[idx];
        return value !== null && value !== undefined ? String(value).trim() : '';
      };

      // Get basic info
      const lastName = cleanString(getValue('lastName'));
      const firstName = cleanString(getValue('firstName'));

      // Skip empty rows
      if (!lastName && !firstName) {
        skipped++;
        continue;
      }

      // Détecter et combiner les colonnes d'adresse si elles sont séparées
      let fullAddress = getValue('address');

      // Chercher des colonnes CP et VILLE non mappées qui pourraient compléter l'adresse
      if (fullAddress) {
        for (let j = 0; j < csvImportState.headers.length; j++) {
          const header = csvImportState.headers[j].toLowerCase();
          const value = row[j] ? String(row[j]).trim() : '';

          // Skip if this column is already mapped
          if (Object.values(csvImportState.mapping).includes(j)) {
            continue;
          }

          // Si on trouve un code postal non encore inclus
          if ((header.includes('cp') || header.includes('code postal') || header === 'postal') && value && !fullAddress.includes(value)) {
            fullAddress += ', ' + value;
          }
          // Si on trouve une ville non encore incluse
          else if ((header.includes('ville') || header.includes('city') || header.includes('commune')) && value && !fullAddress.toLowerCase().includes(value.toLowerCase())) {
            fullAddress += ' ' + value;
          }
        }
      }

      // Get and validate email
      const email = cleanString(getValue('email'));
      if (email && !validateEmail(email)) {
        warnings.push(`Ligne ${i + 2}: Email invalide "${email}" - ignoré`);
      }

      // Get and normalize phone
      let phone = cleanString(getValue('phone'));
      if (phone && !validatePhone(phone)) {
        warnings.push(`Ligne ${i + 2}: Téléphone invalide "${phone}" - conservé tel quel`);
      } else if (phone) {
        phone = normalizePhone(phone);
      }

      const patient = {
        id: generateId(),
        lastName: lastName,
        firstName: firstName,
        dob: convertDateFormat(getValue('dob')),
        email: email && validateEmail(email) ? email : '',
        phone: phone,
        address: cleanString(fullAddress),
        patientCode: cleanString(getValue('patientCode')),
        renewalDate: convertDateFormat(getValue('renewalDate')),
        notes: cleanString(getValue('notes')),
        createdAt: Date.now(),
        updatedAt: Date.now()
      };

      // Check for duplicates
      if (isDuplicate(patient)) {
        warnings.push(`Ligne ${i + 2}: Patient "${firstName} ${lastName}" existe déjà - ignoré`);
        skipped++;
        continue;
      }

      // Handle doctor
      const docName = cleanString(getValue('docName'));
      if (docName) {
        let doc = state.docs.find(d => d.name.toLowerCase() === docName.toLowerCase());
        if (!doc) {
          doc = { id: generateId(), name: docName };
          state.docs.push(doc);
        }
        patient.docId = doc.id;
      }

      // Handle center
      const centerName = cleanString(getValue('centerName'));
      if (centerName) {
        let center = state.centers.find(c => c.name.toLowerCase() === centerName.toLowerCase());
        if (!center) {
          center = { id: generateId(), name: centerName };
          state.centers.push(center);
        }
        patient.centerId = center.id;
      }

      // Handle protocol
      const protoName = cleanString(getValue('protoName'));
      if (protoName) {
        let proto = state.protos.find(p => p.name.toLowerCase() === protoName.toLowerCase());
        if (!proto) {
          proto = { id: generateId(), name: protoName };
          state.protos.push(proto);
        }
        patient.protoId = proto.id;
      }

      // Calculate cycle from renewal date
      if (patient.renewalDate) {
        const cycleInfo = getCycleFromDate(patient.renewalDate);
        if (cycleInfo) {
          patient.currentCycle = `C${cycleInfo.cycle}-${cycleInfo.year}`;
        }
      }

      // Add patient if valid
      if (patient.lastName || patient.firstName) {
        state.patients.push(patient);
        imported++;
      }
    } catch (err) {
      errors.push(`Ligne ${i + 2}: ${err.message}`);
    }
  }

  // Save and refresh
  saveDB();
  render();

  // Show results
  showModal(false, 'csvImportModal');

  let message = `✅ ${imported} patient(s) importé(s)`;
  if (skipped > 0) {
    message += ` | ⏭️ ${skipped} ignoré(s)`;
  }
  if (errors.length > 0) {
    message += ` | ❌ ${errors.length} erreur(s)`;
    console.error('Erreurs d\'import:', errors);
  }
  if (warnings.length > 0) {
    message += ` | ⚠️ ${warnings.length} avertissement(s)`;
    console.warn('Avertissements d\'import:', warnings);
  }

  showToast(message, imported > 0 ? 'success' : (errors.length > 0 ? 'error' : 'warning'));

  // Show detailed results if there are errors or warnings
  if (errors.length > 0 || warnings.length > 0) {
    setTimeout(() => {
      let detailMessage = '';
      if (errors.length > 0) {
        detailMessage += 'ERREURS:\n' + errors.slice(0, 5).join('\n');
        if (errors.length > 5) detailMessage += `\n... et ${errors.length - 5} autre(s) erreur(s)`;
      }
      if (warnings.length > 0) {
        if (detailMessage) detailMessage += '\n\n';
        detailMessage += 'AVERTISSEMENTS:\n' + warnings.slice(0, 5).join('\n');
        if (warnings.length > 5) detailMessage += `\n... et ${warnings.length - 5} autre(s) avertissement(s)`;
      }
      if (confirm(detailMessage + '\n\nVoir la console pour plus de détails ?')) {
        console.log('=== RAPPORT D\'IMPORT DÉTAILLÉ ===');
        if (errors.length > 0) {
          console.error('Erreurs:', errors);
        }
        if (warnings.length > 0) {
          console.warn('Avertissements:', warnings);
        }
      }
    }, 500);
  }
}

function convertDateFormat(dateStr) {
  if (!dateStr) return '';

  // Nettoyer la chaîne
  dateStr = String(dateStr).trim();
  if (!dateStr) return '';

  // Gérer les dates au format ISO avec heures (ex: "2025-11-01 00:00:00")
  if (dateStr.includes(' ')) {
    dateStr = dateStr.split(' ')[0]; // Prendre seulement la partie date
  }

  // Gérer les nombres (format Excel : nombre de jours depuis 1900-01-01)
  const asNumber = parseFloat(dateStr);
  if (!isNaN(asNumber) && asNumber > 1000 && asNumber < 100000) {
    // C'est probablement un nombre de jours Excel
    const excelEpoch = new Date(1899, 11, 30); // Excel compte à partir du 30/12/1899
    const date = new Date(excelEpoch.getTime() + asNumber * 24 * 60 * 60 * 1000);
    if (!isNaN(date.getTime()) && isValidDate(date)) {
      return formatDateFR(date);
    }
  }

  // Try different date formats
  const formats = [
    /^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})$/, // DD/MM/YYYY or DD-MM-YYYY or DD.MM.YYYY
    /^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})$/,   // YYYY-MM-DD or YYYY.MM.DD
    /^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2})$/    // DD/MM/YY
  ];

  for (const format of formats) {
    const match = dateStr.match(format);
    if (match) {
      let day, month, year;

      if (format === formats[0]) {
        day = parseInt(match[1]);
        month = parseInt(match[2]);
        year = match[3].length === 2 ? parseInt('20' + match[3]) : parseInt(match[3]);
      } else if (format === formats[1]) {
        year = parseInt(match[1]);
        month = parseInt(match[2]);
        day = parseInt(match[3]);
      } else {
        day = parseInt(match[1]);
        month = parseInt(match[2]);
        year = parseInt('20' + match[3]);
      }

      // Validate the date components
      if (month < 1 || month > 12) {
        continue; // Invalid month, try next format
      }

      if (day < 1 || day > 31) {
        continue; // Invalid day, try next format
      }

      // Check if it's a valid date (e.g., not 31/02/2025)
      const testDate = new Date(year, month - 1, day);
      if (testDate.getDate() !== day || testDate.getMonth() !== month - 1 || testDate.getFullYear() !== year) {
        continue; // Invalid date
      }

      // Check year is reasonable (between 1900 and 2100)
      if (year < 1900 || year > 2100) {
        continue;
      }

      return `${String(day).padStart(2, '0')}/${String(month).padStart(2, '0')}/${year}`;
    }
  }

  // Try parsing as a Date object
  const date = new Date(dateStr);
  if (!isNaN(date.getTime()) && isValidDate(date)) {
    return formatDateFR(date);
  }

  return ''; // Return empty string if no valid format matches
}

// Helper function to validate dates
function isValidDate(date) {
  if (!(date instanceof Date) || isNaN(date.getTime())) {
    return false;
  }

  const year = date.getFullYear();
  // Accept dates between 1900 and 2100
  return year >= 1900 && year <= 2100;
}

// ===== CSV Import Advanced Functions =====
let csvCurrentData = null;
let csvCurrentMapping = {};

// Field configuration for mapping
const CSV_FIELD_CONFIG = {
  '': { label: '-- Ignorer cette colonne --', required: false },
  lastName: { label: 'Nom de famille', required: true },
  firstName: { label: 'Prénom', required: true },
  dob: { label: 'Date de naissance', required: false },
  email: { label: 'Email', required: false },
  phone: { label: 'Téléphone', required: false },
  address: { label: 'Adresse', required: false },
  patientCode: { label: 'Code patient', required: false },
  docName: { label: 'Médecin (nom)', required: false },
  centerName: { label: 'Centre (nom)', required: false },
  protoName: { label: 'Protocole/Matériel (nom)', required: false },
  renewalDate: { label: 'Date renouvellement', required: false },
  notes: { label: 'Notes/Remarques', required: false }
};

// Helper function for validating dates in CSV import
function csvIsValidDate(val) {
  if (!val || typeof val !== 'string') return false;

  val = val.trim();

  // Check if it looks like a date format at all
  // DD/MM/YYYY, DD-MM-YYYY, YYYY/MM/DD, YYYY-MM-DD
  const formatDDMMYYYY = /^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/;
  const formatYYYYMMDD = /^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/;

  let day, month, year;
  let match;

  // Try DD/MM/YYYY format
  match = val.match(formatDDMMYYYY);
  if (match) {
    day = parseInt(match[1], 10);
    month = parseInt(match[2], 10);
    year = parseInt(match[3], 10);
  }
  // Try YYYY/MM/DD format
  else {
    match = val.match(formatYYYYMMDD);
    if (match) {
      year = parseInt(match[1], 10);
      month = parseInt(match[2], 10);
      day = parseInt(match[3], 10);
    } else {
      return false; // No valid format
    }
  }

  // Validate ranges
  if (month < 1 || month > 12) return false;
  if (day < 1 || day > 31) return false;

  // Year should be reasonable (between 1900 and 2100)
  if (year < 1900 || year > 2100) return false;

  // Check days in month
  const daysInMonth = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];

  // Handle leap years
  const isLeapYear = (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);
  if (isLeapYear) {
    daysInMonth[1] = 29;
  }

  if (day > daysInMonth[month - 1]) return false;

  // Additional check: reject if it looks like other data types
  // Reject pure numbers without separators
  if (/^\d+$/.test(val)) return false;

  // Reject if too many digits (like phone numbers)
  const digitCount = (val.match(/\d/g) || []).length;
  if (digitCount > 8) return false;

  return true;
}

// Content patterns for auto-detection
const CSV_CONTENT_PATTERNS = {
  lastName: {
    keywords: ['nom', 'last_name', 'lastname', 'surname', 'name'],
    validator: (val) => /^[a-zàâäéèêëïîôùûüÿçœæ\s\-']+$/i.test(val) && val.length >= 2
  },
  firstName: {
    keywords: ['prenom', 'prénom', 'first_name', 'firstname', 'givenname'],
    validator: (val) => /^[a-zàâäéèêëïîôùûüÿçœæ\s\-']+$/i.test(val) && val.length >= 2
  },
  email: {
    keywords: ['email', 'mail', 'courriel', 'e-mail'],
    validator: (val) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val)
  },
  phone: {
    keywords: ['telephone', 'téléphone', 'phone', 'tel', 'mobile', 'portable'],
    validator: (val) => /^[\d\s\.\-\+\(\)]{8,}$/.test(val)
  },
  address: {
    keywords: ['adresse', 'address', 'rue', 'street', 'domicile'],
    validator: (val) => val.length >= 5
  },
  dob: {
    keywords: ['naissance', 'birth', 'dob', 'date_naissance', 'date_of_birth', 'né'],
    validator: (val) => csvIsValidDate(val)
  },
  renewalDate: {
    keywords: ['renouvellement', 'renewal', 'ordonnance', 'date_renouvellement', 'renew'],
    validator: (val) => csvIsValidDate(val)
  },
  docName: {
    keywords: ['medecin', 'médecin', 'doctor', 'doc', 'docteur', 'dr'],
    validator: (val) => /^[a-zàâäéèêëïîôùûüÿçœæ\s\.\-']+$/i.test(val) && val.length >= 3
  },
  centerName: {
    keywords: ['centre', 'center', 'site', 'établissement'],
    validator: (val) => val.length >= 3
  },
  protoName: {
    keywords: ['protocole', 'protocol', 'proto', 'matériel', 'materiel'],
    validator: (val) => val.length >= 3
  },
  patientCode: {
    keywords: ['code', 'id', 'identifiant', 'patient_code', 'patient_id'],
    validator: (val) => /^[a-z0-9\-]+$/i.test(val)
  },
  notes: {
    keywords: ['notes', 'note', 'commentaire', 'comment', 'remarque', 'observation'],
    validator: (val) => true
  }
};

// Initialize CSV Import
function initCSVImport() {
  const dropZone = byId('dropZone');
  const fileInput = byId('csvFileInputAdv');
  
  // Click to select
  dropZone.addEventListener('click', () => fileInput.click());
  
  // File selection
  fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
      csvHandleFile(e.target.files[0]);
    }
  });
  
  // Drag and drop
  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.style.background = 'var(--primary)';
    dropZone.style.color = 'white';
  });
  
  dropZone.addEventListener('dragleave', () => {
    dropZone.style.background = 'var(--bg-tertiary)';
    dropZone.style.color = '';
  });
  
  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.style.background = 'var(--bg-tertiary)';
    dropZone.style.color = '';
    
    if (e.dataTransfer.files.length > 0) {
      csvHandleFile(e.dataTransfer.files[0]);
    }
  });
  
  // Checkbox handlers
  byId('csvHasHeaders')?.addEventListener('change', () => {
    if (csvCurrentData) {
      csvDisplayMappingTable();
      if (byId('csvAutoDetect').checked) {
        setTimeout(() => csvAutoDetectMapping(), 300);
      }
    }
  });
}

// Handle file
function csvHandleFile(file) {
  const fileName = file.name.toLowerCase();
  const isExcel = fileName.endsWith('.xlsx') || fileName.endsWith('.xls');
  
  if (isExcel) {
    // Handle Excel files with SheetJS
    const reader = new FileReader();
    
    reader.onload = (e) => {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        
        // Get first sheet
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        
        // Convert to array of arrays
        const rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
        
        if (rawData.length === 0) {
          csvShowAlert('Fichier Excel vide', 'error');
          return;
        }
        
        const hasHeaders = byId('csvHasHeaders').checked;
        let headers = [];
        let rows = [];
        
        if (hasHeaders && rawData.length > 0) {
          headers = rawData[0].map((h, i) => String(h).trim() || `Colonne ${i + 1}`);
          rows = rawData.slice(1).filter(row => row.some(cell => cell));
        } else {
          headers = rawData[0].map((_, i) => `Colonne ${i + 1}`);
          rows = rawData.filter(row => row.some(cell => cell));
        }
        
        // Normalize rows to have same length as headers
        rows = rows.map(row => {
          const normalized = [...row];
          while (normalized.length < headers.length) {
            normalized.push('');
          }
          return normalized.slice(0, headers.length).map(v => String(v).trim());
        });
        
        const result = {
          headers,
          rows,
          separator: 'Excel',
          fileName: file.name,
          format: fileName.endsWith('.xlsx') ? 'XLSX' : 'XLS'
        };
        
        csvProcessParsedData(result);
        
      } catch (error) {
        csvShowAlert('Erreur de lecture du fichier Excel: ' + error.message, 'error');
        console.error('Excel parsing error:', error);
      }
    };
    
    reader.readAsArrayBuffer(file);
    
  } else {
    // Handle text files (CSV, TSV, TXT)
    const reader = new FileReader();
    
    reader.onload = (e) => {
      const text = e.target.result;
      const result = csvParseFile(text, file.name);
      
      if (!result) return;
      
      csvProcessParsedData(result);
    };
    
    reader.readAsText(file, 'UTF-8');
  }
}

// Process parsed data (common for both Excel and CSV)
function csvProcessParsedData(result) {
  const numCols = result.headers.length;
  const numRows = result.rows.length;
  
  // Store data
  csvCurrentData = {
    headers: result.headers,
    rows: result.rows
  };
  csvCurrentMapping = {};
  
  // Display info
  csvDisplayFileInfo(result, numCols, numRows);
  csvDisplayMappingTable();
  
  // Auto-detect if enabled
  if (byId('csvAutoDetect').checked) {
    setTimeout(() => csvAutoDetectMapping(), 300);
  }
  
  // Show containers
  byId('csvFileInfo').style.display = 'block';
  byId('csvOptionsPanel').style.display = 'block';
  byId('csvPreviewContainer').style.display = 'block';
  
  csvUpdateStats();
}

// Parse CSV file
function csvParseFile(text, fileName) {
  try {
    // Auto-detect separator
    const separators = [';', ',', '\t', '|'];
    let bestSep = ',';
    let maxCols = 0;
    
    for (const sep of separators) {
      const firstLine = text.split('\n')[0];
      const cols = firstLine.split(sep).length;
      if (cols > maxCols) {
        maxCols = cols;
        bestSep = sep;
      }
    }
    
    const lines = text.split('\n').filter(line => line.trim());
    if (lines.length === 0) {
      csvShowAlert('Fichier vide', 'error');
      return null;
    }
    
    const hasHeaders = byId('csvHasHeaders').checked;
    let headers = [];
    let startRow = 0;
    
    if (hasHeaders && lines.length > 0) {
      headers = lines[0].split(bestSep).map((h, i) => h.trim() || `Colonne ${i + 1}`);
      startRow = 1;
    } else {
      const firstRow = lines[0].split(bestSep);
      headers = firstRow.map((_, i) => `Colonne ${i + 1}`);
      startRow = 0;
    }
    
    const rows = [];
    for (let i = startRow; i < lines.length; i++) {
      const values = lines[i].split(bestSep).map(v => v.trim());
      if (values.some(v => v)) {
        rows.push(values);
      }
    }
    
    const format = fileName.endsWith('.tsv') ? 'TSV' : 
                   fileName.endsWith('.txt') ? 'TXT' : 'CSV';
    
    return {
      headers,
      rows,
      separator: bestSep,
      fileName,
      format
    };
  } catch (error) {
    csvShowAlert('Erreur de lecture du fichier: ' + error.message, 'error');
    return null;
  }
}

// Display file info
function csvDisplayFileInfo(result, numCols, numRows) {
  const content = byId('csvFileInfoContent');
  const sepInfo = result.separator ? 
    `<div style="background: white; padding: 10px; border-radius: 6px;">
      <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px;">Séparateur</div>
      <div style="font-size: 16px; font-weight: 600; color: #27ae60;">${result.separator === '\t' ? 'Tabulation' : result.separator}</div>
    </div>` : '';
  
  content.innerHTML = `
    <div style="background: white; padding: 10px; border-radius: 6px;">
      <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px;">Fichier</div>
      <div style="font-size: 16px; font-weight: 600; color: #27ae60;">${result.fileName}</div>
    </div>
    <div style="background: white; padding: 10px; border-radius: 6px;">
      <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px;">Format</div>
      <div style="font-size: 16px; font-weight: 600; color: #27ae60;">${result.format}</div>
    </div>
    ${sepInfo}
    <div style="background: white; padding: 10px; border-radius: 6px;">
      <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px;">Colonnes</div>
      <div style="font-size: 16px; font-weight: 600; color: #27ae60;">${numCols}</div>
    </div>
    <div style="background: white; padding: 10px; border-radius: 6px;">
      <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px;">Lignes</div>
      <div style="font-size: 16px; font-weight: 600; color: #27ae60;">${numRows}</div>
    </div>
  `;
}

// Display mapping table
function csvDisplayMappingTable() {
  const table = byId('csvMappingTable');
  const hasHeaders = byId('csvHasHeaders').checked;
  const headers = csvCurrentData.headers;
  const rows = csvCurrentData.rows;
  const maxPreviewRows = Math.min(10, rows.length);
  
  let html = '<thead><tr><th style="background: #34495e; padding: 15px; color: white; text-align: center; position: sticky; top: 0; z-index: 10;">#</th>';
  
  // Column headers with mapping selects
  headers.forEach((header, colIndex) => {
    html += `
      <th style="background: #34495e; padding: 15px 10px; text-align: center; border-right: 1px solid #2c3e50; position: sticky; top: 0; z-index: 10;">
        <div style="color: #95a5a6; font-size: 11px; font-weight: 600; margin-bottom: 8px; text-transform: uppercase;">Colonne ${colIndex + 1}</div>
        <div style="color: #ecf0f1; font-size: 12px; font-style: italic; margin-bottom: 10px; min-height: 20px; word-break: break-word;">
          ${header && header !== 'Colonne ${colIndex + 1}' ? header : '<span style="color: #95a5a6;">(sans titre)</span>'}
        </div>
        <div>
          <select class="mapping-select" data-col-index="${colIndex}" onchange="csvOnMappingChange(${colIndex})" style="width: 100%; padding: 8px 10px; border: 2px solid #95a5a6; border-radius: 6px; background: white; font-size: 13px; cursor: pointer; transition: all 0.2s; appearance: none; background-image: url('data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'12\\' height=\\'12\\' viewBox=\\'0 0 12 12\\'%3E%3Cpath fill=\\'%23666\\' d=\\'M6 9L1 4h10z\\'/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 8px center; padding-right: 30px;">
            ${Object.entries(CSV_FIELD_CONFIG).map(([key, config]) => 
              `<option value="${key}">${config.label}</option>`
            ).join('')}
          </select>
          <div class="confidence-badge" id="csv-confidence-${colIndex}" style="display: none; margin-top: 5px; padding: 3px 8px; border-radius: 12px; font-size: 10px; font-weight: 600;"></div>
        </div>
      </th>
    `;
  });
  
  html += '</tr></thead><tbody>';
  
  // Data rows
  for (let i = 0; i < maxPreviewRows; i++) {
    html += `<tr style="border-bottom: 1px solid #ecf0f1;"><td style="background: #f8f9fa; color: #7f8c8d; font-weight: 600; text-align: center; font-size: 12px; padding: 12px 10px; border-right: 2px solid #e0e0e0;">${i + 1}</td>`;
    
    headers.forEach((_, colIndex) => {
      const value = rows[i]?.[colIndex] || '';
      const displayValue = String(value).length > 30 ? String(value).substring(0, 27) + '...' : value;
      html += `
        <td style="padding: 12px 10px; border-right: 1px solid #ecf0f1; font-size: 13px; color: var(--text-primary); max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${String(value).replace(/"/g, '&quot;')}">
          ${displayValue || '<span style="color: #95a5a6; font-style: italic;">—</span>'}
        </td>
      `;
    });
    
    html += '</tr>';
  }
  
  html += '</tbody>';
  
  if (rows.length > maxPreviewRows) {
    html += `<tfoot><tr><td colspan="${headers.length + 1}" style="text-align: center; padding: 15px; color: #7f8c8d; font-style: italic;">
      ... et ${rows.length - maxPreviewRows} autres lignes
    </td></tr></tfoot>`;
  }
  
  table.innerHTML = html;
}

// On mapping change
function csvOnMappingChange(colIndex) {
  const select = document.querySelector(`.mapping-select[data-col-index="${colIndex}"]`);
  const value = select.value;
  
  if (value) {
    csvCurrentMapping[colIndex] = value;
    select.style.borderColor = '#27ae60';
    select.style.backgroundColor = '#e8f5e9';
    select.style.fontWeight = '600';
    
    // Hide confidence badge when manually set
    const badge = byId(`csv-confidence-${colIndex}`);
    if (badge) badge.style.display = 'none';
  } else {
    delete csvCurrentMapping[colIndex];
    select.style.borderColor = '#95a5a6';
    select.style.backgroundColor = 'white';
    select.style.fontWeight = 'normal';
  }
  
  csvUpdateStats();
  csvValidateMapping();
}

// Auto-detect mapping
function csvAutoDetectMapping() {
  if (!csvCurrentData) return;
  
  csvShowAlert('🎯 Détection automatique en cours...', 'info');
  
  csvCurrentMapping = {};
  const headers = csvCurrentData.headers;
  const rows = csvCurrentData.rows;
  const hasHeaders = byId('csvHasHeaders').checked;
  
  headers.forEach((header, colIndex) => {
    const select = document.querySelector(`.mapping-select[data-col-index="${colIndex}"]`);
    const badge = byId(`csv-confidence-${colIndex}`);
    
    // Analyze column content
    const columnData = rows.slice(0, 20).map(row => row[colIndex]).filter(v => v);
    
    let bestMatch = { field: '', confidence: 0 };
    
    // Method 1: Header analysis (if present)
    if (hasHeaders && header && header !== `Colonne ${colIndex + 1}`) {
      for (const [field, pattern] of Object.entries(CSV_CONTENT_PATTERNS)) {
        if (!pattern.keywords) continue;
        const headerLower = header.toLowerCase();
        for (const keyword of pattern.keywords) {
          if (headerLower.includes(keyword)) {
            const score = 85 + (headerLower === keyword ? 15 : 0);
            if (score > bestMatch.confidence) {
              bestMatch = { field, confidence: score };
            }
          }
        }
      }
    }
    
    // Method 2: Content analysis
    if (columnData.length > 0 && bestMatch.confidence < 90) {
      for (const [field, pattern] of Object.entries(CSV_CONTENT_PATTERNS)) {
        if (!pattern.validator) continue;
        
        const validCount = columnData.filter(val => pattern.validator(val)).length;
        const validRatio = validCount / columnData.length;
        
        if (validRatio > 0.6) {
          const contentScore = Math.round(validRatio * 100);
          if (contentScore > bestMatch.confidence) {
            bestMatch = { field, confidence: contentScore };
          }
        }
      }
    }
    
    // Apply mapping if confidence sufficient
    if (bestMatch.field && bestMatch.confidence >= 60) {
      csvCurrentMapping[colIndex] = bestMatch.field;
      select.value = bestMatch.field;
      select.style.borderColor = '#f39c12';
      select.style.backgroundColor = '#fff3cd';
      
      // Show confidence badge
      const confidenceClass = bestMatch.confidence >= 85 ? 'confidence-high' : 
                             bestMatch.confidence >= 70 ? 'confidence-medium' : 'confidence-low';
      const badgeColors = {
        'confidence-high': { bg: '#d4edda', color: '#155724' },
        'confidence-medium': { bg: '#fff3cd', color: '#856404' },
        'confidence-low': { bg: '#f8d7da', color: '#721c24' }
      };
      const colors = badgeColors[confidenceClass];
      badge.style.background = colors.bg;
      badge.style.color = colors.color;
      badge.textContent = `${bestMatch.confidence}%`;
      badge.style.display = 'inline-block';
    } else {
      select.value = '';
      select.style.borderColor = '#95a5a6';
      select.style.backgroundColor = 'white';
      if (badge) badge.style.display = 'none';
    }
  });
  
  csvUpdateStats();
  csvValidateMapping();
  
  const mappedCount = Object.keys(csvCurrentMapping).length;
  if (mappedCount > 0) {
    csvShowAlert(`✅ ${mappedCount} colonne(s) détectée(s) automatiquement. Vérifiez et ajustez si nécessaire.`, 'success');
  } else {
    csvShowAlert('⚠️ Aucune colonne détectée automatiquement. Veuillez faire le mapping manuellement.', 'warning');
  }
}

// Clear mapping
function csvClearMapping() {
  csvCurrentMapping = {};
  document.querySelectorAll('.mapping-select').forEach(select => {
    select.value = '';
    select.style.borderColor = '#95a5a6';
    select.style.backgroundColor = 'white';
    select.style.fontWeight = 'normal';
  });
  document.querySelectorAll('.confidence-badge').forEach(badge => {
    badge.style.display = 'none';
  });
  csvUpdateStats();
  csvValidateMapping();
  csvShowAlert('Mapping effacé', 'info');
}

// Redetect
function csvRedetect() {
  csvClearMapping();
  setTimeout(() => csvAutoDetectMapping(), 100);
}

// Update stats
function csvUpdateStats() {
  if (!csvCurrentData) return;
  
  byId('csvColCount').textContent = csvCurrentData.headers.length;
  byId('csvRowCountStat').textContent = csvCurrentData.rows.length;
  byId('csvMappedCount').textContent = Object.keys(csvCurrentMapping).length;
}

// Validate mapping
function csvValidateMapping() {
  const requiredFields = Object.entries(CSV_FIELD_CONFIG)
    .filter(([_, config]) => config.required)
    .map(([key, _]) => key);
  
  const mappedFields = Object.values(csvCurrentMapping);
  const missingRequired = requiredFields.filter(f => !mappedFields.includes(f));
  
  const btnImport = byId('csvBtnImport');
  
  if (missingRequired.length > 0) {
    btnImport.disabled = true;
    const fieldLabels = missingRequired.map(f => CSV_FIELD_CONFIG[f].label).join(', ');
    csvShowAlert(`⚠️ Champs obligatoires manquants: ${fieldLabels}`, 'warning');
  } else {
    btnImport.disabled = false;
    csvHideAlert();
  }
}

// Execute import
function csvExecuteImport() {
  if (!csvCurrentData || Object.keys(csvCurrentMapping).length === 0) {
    showToast('Veuillez mapper au moins une colonne', 'error');
    return;
  }
  
  // Build mapped data
  const mappedData = csvCurrentData.rows.map((row, rowIndex) => {
    const patient = {};
    
    Object.entries(csvCurrentMapping).forEach(([colIndex, fieldName]) => {
      patient[fieldName] = row[colIndex] || '';
    });
    
    return patient;
  });
  
  // Import data
  let imported = 0;
  let errors = [];
  
  for (let i = 0; i < mappedData.length; i++) {
    try {
      const data = mappedData[i];
      
      const patient = {
        id: generateId(),
        lastName: data.lastName || '',
        firstName: data.firstName || '',
        dob: convertDateFormat(data.dob || ''),
        email: data.email || '',
        phone: data.phone || '',
        address: data.address || '',
        patientCode: data.patientCode || '',
        renewalDate: convertDateFormat(data.renewalDate || ''),
        notes: data.notes || '',
        createdAt: Date.now(),
        updatedAt: Date.now(),
        history: [{
          date: Date.now(),
          type: 'created',
          field: 'Création',
          oldValue: '',
          newValue: 'Patient créé via import CSV'
        }]
      };
      
      // Handle doctor
      if (data.docName) {
        let doc = state.docs.find(d => d.name === data.docName);
        if (!doc) {
          doc = { id: generateId(), name: data.docName };
          state.docs.push(doc);
        }
        patient.docId = doc.id;
      }
      
      // Handle center
      if (data.centerName) {
        let center = state.centers.find(c => c.name === data.centerName);
        if (!center) {
          center = { id: generateId(), name: data.centerName };
          state.centers.push(center);
        }
        patient.centerId = center.id;
      }
      
      // Handle protocol
      if (data.protoName) {
        let proto = state.protos.find(p => p.name === data.protoName);
        if (!proto) {
          proto = { id: generateId(), name: data.protoName };
          state.protos.push(proto);
        }
        patient.protoId = proto.id;
      }
      
      // Calculate cycle from renewal date
      if (patient.renewalDate) {
        const cycleInfo = getCycleFromDate(patient.renewalDate);
        if (cycleInfo) {
          patient.currentCycle = `C${cycleInfo.cycle}-${cycleInfo.year}`;
        }
      }
      
      // Add patient if valid
      if (patient.lastName || patient.firstName) {
        state.patients.push(patient);
        imported++;
      }
    } catch (err) {
      errors.push(`Ligne ${i + 2}: ${err.message}`);
    }
  }
  
  // Save and refresh
  saveDB();
  render();
  
  // Close modal
  csvReset();
  showModal(false, 'csvImportModal');
  
  // Show results
  let message = `✅ ${imported} patient(s) importé(s)`;
  if (errors.length > 0) {
    message += ` | ⚠️ ${errors.length} erreur(s)`;
    console.log('Erreurs d\'import:', errors);
  }
  showToast(message, imported > 0 ? 'success' : 'warning');
}

// Reset
function csvReset() {
  csvCurrentData = null;
  csvCurrentMapping = {};
  byId('csvFileInfo').style.display = 'none';
  byId('csvOptionsPanel').style.display = 'none';
  byId('csvPreviewContainer').style.display = 'none';
  byId('csvFileInputAdv').value = '';
  csvHideAlert();
}

// Show alert
function csvShowAlert(message, type) {
  const alertBox = byId('csvAlertBox');
  const colors = {
    'info': { bg: 'rgba(59, 130, 246, 0.1)', border: 'var(--primary)', color: 'var(--primary)' },
    'success': { bg: '#e8f5e9', border: '#27ae60', color: '#27ae60' },
    'warning': { bg: '#fff3cd', border: '#f39c12', color: '#856404' },
    'error': { bg: '#f8d7da', border: '#ef4444', color: '#721c24' }
  };
  const style = colors[type] || colors.info;
  alertBox.style.background = style.bg;
  alertBox.style.borderLeft = `4px solid ${style.border}`;
  alertBox.style.color = style.color;
  alertBox.style.display = 'block';
  alertBox.textContent = message;
}

// Hide alert
function csvHideAlert() {
  const alertBox = byId('csvAlertBox');
  alertBox.style.display = 'none';
}

// ===== Theme Toggle =====
function toggleTheme() {
  const html = document.documentElement;
  const current = html.getAttribute('data-theme');
  const newTheme = current === 'dark' ? 'light' : 'dark';
  
  html.setAttribute('data-theme', newTheme);
  localStorage.setItem('nhc-theme', newTheme);
  
  const icon = byId('themeIcon');
  const text = byId('themeText');
  
  if (newTheme === 'dark') {
    icon.textContent = '☀️';
    text.textContent = 'Mode clair';
  } else {
    icon.textContent = '🌙';
    text.textContent = 'Mode sombre';
  }
}

// ===== Search Function =====
function performSearch(query) {
  query = query.trim().toLowerCase();
  if (!query) {
    render();
    return;
  }
  
  switchView('patients');
  const tbody = qsEl('#tblPatients tbody');
  if (!tbody) return;
  
  const filtered = state.patients.filter(p => {
    const searchText = [
      fullName(p),
      p.email || '',
      p.phone || '',
      p.address || '',
      docName(p.docId) || '',
      centerName(p.centerId) || '',
      protoName(p.protoId) || '',
      p.renewalDate || ''
    ].join(' ').toLowerCase();
    
    return searchText.includes(query);
  });
  
  tbody.innerHTML = filtered.map(p => {
    const cycleInfo = getCycleFromDate(p.renewalDate);
    const cycleLabel = cycleInfo ? `${cycleInfo.name} ${cycleInfo.year}` : '—';

    return `
      <tr style="cursor: pointer;" onclick="viewPatientDetails('${p.id}')" title="Cliquer pour voir les détails">
        <td style="font-weight: 600;">${fullName(p)}</td>
        <td>${protoName(p.protoId) || '—'}</td>
        <td>${docName(p.docId) || '—'}</td>
        <td>${centerName(p.centerId) || '—'}</td>
        <td>${p.renewalDate ? `<div>${p.renewalDate}</div><div class="text-small text-muted">${cycleLabel}</div>` : '—'}</td>
      </tr>
    `;
  }).join('');
  
  showToast(`${filtered.length} résultat(s)`, 'info');
}

// ===== Purge Totale Functions =====
function openPurgeTotaleModal() {
  console.log('🔓 Ouverture du modal de purge totale...');

  // Update counts
  byId('purgePatientCount').textContent = state.patients?.length || 0;
  byId('purgeAppointmentCount').textContent = state.appointments?.length || 0;
  byId('purgeSwitchCount').textContent = state.switches?.length || 0;
  byId('purgeDoctorCount').textContent = state.docs?.length || 0;
  byId('purgeCenterCount').textContent = state.centers?.length || 0;
  byId('purgeProtocolCount').textContent = state.protos?.length || 0;

  console.log('📊 Compteurs mis à jour:', {
    patients: state.patients?.length || 0,
    appointments: state.appointments?.length || 0,
    switches: state.switches?.length || 0,
    doctors: state.docs?.length || 0,
    centers: state.centers?.length || 0,
    protocols: state.protos?.length || 0
  });

  // Reset confirmations
  byId('purgeConfirm1').checked = false;
  byId('purgeConfirm2').checked = false;
  byId('purgeConfirm3').checked = false;
  byId('purgeConfirmText').value = '';
  byId('btnConfirmPurge').disabled = true;

  console.log('🔄 Réinitialisaton des confirmations effectuée');

  // Open modal
  showModal(true, 'purgeTotaleModal');
  console.log('✅ Modal de purge ouvert');
}

function exportBeforePurge() {
  // Export all data to JSON
  const exportData = {
    version: '4.0',
    exportDate: new Date().toISOString(),
    data: {
      patients: state.patients || [],
      appointments: state.appointments || [],
      switches: state.switches || [],
      docs: state.docs || [],
      centers: state.centers || [],
      protos: state.protos || [],
      prescriptionTemplates: state.prescriptionTemplates || [],
      tasks: state.tasks || [],
      shortcuts: state.shortcuts || []
    },
    metadata: {
      totalPatients: state.patients?.length || 0,
      totalAppointments: state.appointments?.length || 0,
      totalSwitches: state.switches?.length || 0,
      totalDoctors: state.docs?.length || 0,
      totalCenters: state.centers?.length || 0,
      totalProtocols: state.protos?.length || 0,
      totalPrescriptionTemplates: state.prescriptionTemplates?.length || 0,
      totalTasks: state.tasks?.length || 0,
      totalShortcuts: state.shortcuts?.length || 0
    }
  };

  const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `nhc-backup-${new Date().toISOString().split('T')[0]}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);

  showToast('✅ Export réussi ! Fichier téléchargé', 'success');
}

function executePurgeTotale() {
  console.log('🚨 executePurgeTotale appelée!');

  // Final confirmation
  if (!confirm('⚠️ DERNIÈRE CONFIRMATION\n\nVous êtes sur le point de supprimer TOUTES les données.\nCette action est IRRÉVERSIBLE.\n\nContinuer ?')) {
    console.log('❌ Purge annulée par l\'utilisateur');
    return;
  }

  console.log('✅ Confirmation reçue, début de la purge...');

  try {
    // Clear all localStorage keys related to the app
    const keysToRemove = [
      DB_KEY,
      DB_KEY + '-backup',
      LEGACY_KEY,
      'nhc_update_url',
      'nhc_last_update_check'
    ];

    keysToRemove.forEach(key => {
      localStorage.removeItem(key);
    });

    // Reset state to empty
    state = {
      patients: [],
      appointments: [],
      switches: [],
      docs: [],
      centers: [],
      protos: [],
      prescriptionTemplates: [],
      tasks: [],
      shortcuts: []
    };

    // Save empty state
    console.log('💾 Sauvegarde de l\'état vide...');
    saveDB();

    // Close modal
    console.log('🚪 Fermeture du modal...');
    showModal(false, 'purgeTotaleModal');

    // Show success message
    console.log('🎉 Affichage du message de succès...');
    showToast('🗑️ PURGE TOTALE EFFECTUÉE - Toutes les données ont été supprimées', 'success');

    // Refresh all views
    console.log('🔄 Rafraîchissement des vues...');
    render();
    renderSwitches();
    renderAppointments();
    renderDashboard();
    renderCatalogs();
    renderTasks();

    // Switch to dashboard
    console.log('📊 Basculement vers le dashboard...');
    setTimeout(() => {
      switchView('dashboard');
    }, 1000);

    console.log('✅ Purge totale terminée avec succès!');

  } catch (error) {
    console.error('❌ Erreur lors de la purge:', error);
    showToast('❌ Erreur lors de la purge : ' + error.message, 'error');
  }
}

// ===== Event Bindings =====
function bindEvents() {
  // Navigation
  byId('nav')?.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-view]');
    if (btn) switchView(btn.dataset.view);
  });
  
  // Quick Actions Menu
  const qaBtn = byId('btnQuickActions');
  const qaMenu = byId('qaMenu');
  
  qaBtn?.addEventListener('click', () => {
    qaMenu.classList.toggle('show');
  });
  
  document.addEventListener('click', (e) => {
    if (!e.target.closest('#qaMenu') && !e.target.closest('#btnQuickActions')) {
      qaMenu?.classList.remove('show');
    }
  });
  
  qaMenu?.addEventListener('click', (e) => {
    const item = e.target.closest('.dropdown-item');
    if (!item) return;
    
    const action = item.dataset.qa;
    qaMenu.classList.remove('show');
    
    switch(action) {
      case 'fastCheck':
        fcOpen();
        break;
      case 'scanLegacy':
        scanLegacyBases();
        break;
      case 'restoreRefs':
        restoreRefs();
        break;
      case 'safeReset':
        if (confirm('Réinitialiser la base de données ?')) {
          localStorage.removeItem(DB_KEY);
          state = { patients: [], docs: [], centers: [], protos: [], switches: [], appointments: [], prescriptionTemplates: [], tasks: [], shortcuts: [] };
          initDemoData();
          render();
          showToast('Base réinitialisée', 'success');
        }
        break;
      case 'purgeAll':
        if (confirm('⚠️ PURGE TOTALE - Cette action est irréversible. Continuer ?')) {
          if (confirm('Êtes-vous vraiment sûr ?')) {
            localStorage.clear();
            state = { patients: [], docs: [], centers: [], protos: [], switches: [], appointments: [], prescriptionTemplates: [], tasks: [], shortcuts: [] };
            saveDB();
            render();
            showToast('Purge totale effectuée', 'success');
          }
        }
        break;
    }
  });
  
  // Search
  byId('globalSearch')?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      performSearch(e.target.value);
    }
  });
  
  document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
      e.preventDefault();
      byId('globalSearch')?.focus();
    }
  });
  
  // Patient Modal
  byId('btnSavePatient')?.addEventListener('click', savePatient);
  byId('btnDeletePatient')?.addEventListener('click', deletePatient);
  byId('btnChangeStatus')?.addEventListener('click', changePatientStatus);
  byId('closePatient')?.addEventListener('click', () => showModal(false));
  byId('btnAddPatient')?.addEventListener('click', newPatient);
  byId('btnImportCSV')?.addEventListener('click', openCSVImport);
  
  // Renewal date input
  byId('renewalDate')?.addEventListener('input', updateCycleInfo);
  
  // Sort
  byId('sortPatients')?.addEventListener('change', render);
  byId('filterArchivedStatus')?.addEventListener('change', renderArchivedPatients);
  byId('sortArchived')?.addEventListener('change', renderArchivedPatients);
  
  // Table Actions
  document.body.addEventListener('click', (e) => {
    const action = e.target.closest('[data-action]');
    if (!action) return;
    
    const id = action.dataset.id || action.dataset.patientId;
    
    switch(action.dataset.action) {
      case 'reactivate':
        reactivatePatient(id);
        break;
      case 'viewDetails':
        viewPatientDetails(id);
        break;
      case 'open':
        openPatient(id);
        break;
      case 'delDoc':
        if (confirm('Supprimer ce médecin ?')) {
          state.docs = state.docs.filter(d => d.id !== id);
          saveDB();
          renderCatalogs();
          showToast('Médecin supprimé', 'success');
        }
        break;
      case 'delCenter':
        if (confirm('Supprimer ce centre ?')) {
          state.centers = state.centers.filter(c => c.id !== id);
          saveDB();
          renderCatalogs();
          showToast('Centre supprimé', 'success');
        }
        break;
      case 'delProto':
        if (confirm('Supprimer ce protocole ?')) {
          state.protos = state.protos.filter(p => p.id !== id);
          saveDB();
          renderCatalogs();
          showToast('Protocole supprimé', 'success');
        }
        break;
      case 'validateAppointment':
        const appointmentId = action.dataset.appointmentId;
        if (appointmentId) {
          validateAppointment(appointmentId);
        }
        break;
      case 'scheduleNext':
        const patientId = action.dataset.patientId;
        const currentAptId = action.dataset.currentAptId;
        if (patientId) {
          scheduleNextAppointment(patientId, currentAptId);
        }
        break;
    }
  });
  
  // Export/Import
  byId('btnExportJson')?.addEventListener('click', exportJson);
  byId('btnExportRefs')?.addEventListener('click', exportRefs);
  
  byId('fileImport')?.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
      try {
        const parsed = JSON.parse(reader.result);

        // Support both old and new backup formats
        let data;
        if (parsed.version && parsed.data) {
          // New format with version wrapper (v4.0+)
          data = parsed.data;
          console.log(`Importing backup version ${parsed.version} from ${parsed.exportDate}`);
        } else {
          // Old format (direct data)
          data = parsed;
        }

        // Validate data structure
        if (typeof data !== 'object' || data === null) {
          throw new Error('Format de données invalide');
        }

        // Validate that arrays are actually arrays
        const requiredFields = ['patients', 'docs', 'centers', 'protos', 'switches', 'appointments', 'tasks', 'prescriptionTemplates', 'shortcuts'];
        for (const field of requiredFields) {
          if (data[field] && !Array.isArray(data[field])) {
            throw new Error(`Le champ '${field}' doit être un tableau`);
          }
        }

        // Validate that at least one of the expected fields exists
        const hasValidData = requiredFields.some(field => data[field] && Array.isArray(data[field]));
        if (!hasValidData) {
          throw new Error('Aucune donnée valide trouvée dans le fichier');
        }

        // Count history events in the backup for verification
        const patientHistoryCount = (data.patients || []).reduce((total, p) => total + (p.history?.length || 0), 0);
        const patientEventsCount = (data.patients || []).reduce((total, p) => total + (p.events?.length || 0), 0);
        const appointmentHistoryCount = (data.appointments || []).reduce((total, a) => total + (a.history?.length || 0), 0);
        const totalHistoryEvents = patientHistoryCount + patientEventsCount + appointmentHistoryCount;

        console.log('📊 Data to import:', {
          patients: data.patients?.length || 0,
          docs: data.docs?.length || 0,
          centers: data.centers?.length || 0,
          protos: data.protos?.length || 0,
          switches: data.switches?.length || 0,
          appointments: data.appointments?.length || 0,
          tasks: data.tasks?.length || 0,
          prescriptionTemplates: data.prescriptionTemplates?.length || 0,
          shortcuts: data.shortcuts?.length || 0,
          patientHistoryEvents: patientHistoryCount,
          patientEvents: patientEventsCount,
          appointmentHistoryEvents: appointmentHistoryCount,
          totalHistoryEvents: totalHistoryEvents
        });

        if (confirm('Remplacer toutes les données ?')) {
          state = {
            patients: data.patients || [],
            docs: data.docs || [],
            centers: data.centers || [],
            protos: data.protos || [],
            switches: data.switches || [],
            appointments: data.appointments || [],
            prescriptionTemplates: data.prescriptionTemplates || [],
            tasks: data.tasks || [],
            shortcuts: data.shortcuts || []
          };
          saveDB();
          render();

          // Detailed success message
          const tasksCount = state.tasks?.length || 0;
          const shortcutsCount = state.shortcuts?.length || 0;
          const templatesCount = state.prescriptionTemplates?.length || 0;
          const message = `✅ Import réussi !\n${state.patients.length} patients (${patientHistoryCount} modif. + ${patientEventsCount} événements)\n${state.appointments.length} rendez-vous (${appointmentHistoryCount} événements)\n${tasksCount} tâches, ${shortcutsCount} raccourcis, ${templatesCount} modèles\nTotal: ${totalHistoryEvents} événements restaurés`;
          showToast(message, 'success');
        }
      } catch (error) {
        console.error('Import error:', error);
        if (error instanceof SyntaxError) {
          showToast('❌ Fichier JSON invalide. Vérifiez le format du fichier.', 'error');
        } else {
          showToast('❌ ' + error.message, 'error');
        }
      }
    };
    reader.readAsText(file);
  });
  
  // Fast Check Controls
  byId('fcClose')?.addEventListener('click', fcClose);
  byId('fcPrev')?.addEventListener('click', fcPrev);
  byId('fcSkip')?.addEventListener('click', fcNext);
  byId('fcCorrect')?.addEventListener('click', fcCorrect);
  byId('fcUpdate')?.addEventListener('click', fcUpdate);
  byId('fcCopy')?.addEventListener('click', fcCopy);
  byId('fcEditCode')?.addEventListener('click', fcEditCode);
  byId('fcSaveCode')?.addEventListener('click', fcSaveCode);
  byId('fcOrdonnance')?.addEventListener('click', fcOpenOrdonnance);

  // Fast Create Ordo events
  byId('fcoClose')?.addEventListener('click', fcoClose);
  byId('fcoPrev')?.addEventListener('click', fcoPrev);
  byId('fcoSkip')?.addEventListener('click', fcoSkip);
  byId('fcoValidate')?.addEventListener('click', fcoValidate);
  byId('fcoStartDate')?.addEventListener('change', fcoUpdateEndDate);

  // Switch events
  byId('switchPatientId')?.addEventListener('change', updateSwitchOldProto);
  
  document.addEventListener('keydown', (e) => {
    if (byId('fastModal')?.classList.contains('active')) {
      switch(e.key) {
        case 'ArrowRight':
        case 'Enter':
          e.preventDefault();
          fcCorrect();
          break;
        case 'ArrowLeft':
          e.preventDefault();
          fcPrev();
          break;
        case 'Escape':
          e.preventDefault();
          fcClose();
          break;
      }
    }

    // Fast Create Ordo keyboard shortcuts
    if (byId('fastCreateOrdoModal')?.classList.contains('active')) {
      switch(e.key) {
        case 'ArrowRight':
        case 'Enter':
          e.preventDefault();
          fcoValidate();
          break;
        case 'ArrowLeft':
          e.preventDefault();
          fcoPrev();
          break;
        case 'Escape':
          e.preventDefault();
          fcoClose();
          break;
      }
    }
  });
  
  // Debug
  byId('btnListKeys')?.addEventListener('click', () => {
    const keys = Object.keys(localStorage);
    byId('dbgOut').textContent = `Clés localStorage (${keys.length}):\n${keys.join('\n')}`;
  });
  
  byId('btnSwitchKey')?.addEventListener('click', () => {
    const current = localStorage.getItem(DB_KEY);
    if (current) {
      localStorage.setItem(DB_KEY + '-backup', current);
      showToast('Clé dupliquée vers ' + DB_KEY + '-backup', 'success');
    }
  });
  
  byId('btnMigrateV1')?.addEventListener('click', () => {
    const legacy = localStorage.getItem(LEGACY_KEY);
    if (!legacy) {
      showToast('Aucune base v1 trouvée', 'warning');
      return;
    }
    
    try {
      const data = JSON.parse(legacy);
      state.patients = [...state.patients, ...(data.patients || [])];
      state.docs = [...state.docs, ...(data.docs || [])];
      state.centers = [...state.centers, ...(data.centers || [])];
      state.protos = [...state.protos, ...(data.protos || [])];
      saveDB();
      render();
      showToast('Migration depuis v1 réussie', 'success');
    } catch (error) {
      showToast('Erreur de migration', 'error');
    }
  });
  
  byId('btnPurgeV1')?.addEventListener('click', () => {
    if (confirm('Supprimer la base v1 ?')) {
      localStorage.removeItem(LEGACY_KEY);
      showToast('Base v1 supprimée', 'success');
    }
  });

  // Purge Totale
  byId('btnOpenPurgeModal')?.addEventListener('click', openPurgeTotaleModal);

  // Validation des confirmations de purge
  const purgeValidation = () => {
    const confirm1 = byId('purgeConfirm1')?.checked || false;
    const confirm2 = byId('purgeConfirm2')?.checked || false;
    const confirm3 = byId('purgeConfirm3')?.checked || false;
    const confirmText = byId('purgeConfirmText')?.value.trim() || '';

    console.log('🔍 Purge validation:', {
      confirm1,
      confirm2,
      confirm3,
      confirmText,
      expected: 'PURGER TOUT'
    });

    const allConfirmed = confirm1 && confirm2 && confirm3 && confirmText === 'PURGER TOUT';
    const btnConfirm = byId('btnConfirmPurge');
    if (btnConfirm) {
      btnConfirm.disabled = !allConfirmed;
      console.log('✅ Bouton purge état:', allConfirmed ? 'ACTIVÉ' : 'DÉSACTIVÉ');
    } else {
      console.error('❌ Bouton btnConfirmPurge non trouvé!');
    }

    // Feedback visuel sur le champ texte
    const textInput = byId('purgeConfirmText');
    if (textInput) {
      if (confirmText && confirmText !== 'PURGER TOUT') {
        textInput.style.borderColor = '#ef4444';
        textInput.style.backgroundColor = 'rgba(239, 68, 68, 0.1)';
      } else if (confirmText === 'PURGER TOUT') {
        textInput.style.borderColor = '#10b981';
        textInput.style.backgroundColor = 'rgba(16, 185, 129, 0.1)';
      } else {
        textInput.style.borderColor = '#dc2626';
        textInput.style.backgroundColor = 'transparent';
      }
    }
  };

  const purgeCheckboxes = ['purgeConfirm1', 'purgeConfirm2', 'purgeConfirm3'];
  purgeCheckboxes.forEach(id => {
    const element = byId(id);
    if (element) {
      element.addEventListener('change', purgeValidation);
      console.log('✅ Event listener attaché à', id);
    } else {
      console.error('❌ Élément non trouvé:', id);
    }
  });

  const purgeTextInput = byId('purgeConfirmText');
  if (purgeTextInput) {
    purgeTextInput.addEventListener('input', purgeValidation);
    console.log('✅ Event listener attaché à purgeConfirmText');
  } else {
    console.error('❌ Élément purgeConfirmText non trouvé!');
  }
  
  // Cycle tabs
  document.addEventListener('click', (e) => {
    const cycleTab = e.target.closest('.cycle-tab');
    if (cycleTab) {
      const cycle = parseInt(cycleTab.dataset.cycle);
      const year = parseInt(byId('ordoYearFilter')?.value || getCurrentCycle().year);
      
      // Update active state
      document.querySelectorAll('.cycle-tab').forEach(tab => tab.classList.remove('active'));
      cycleTab.classList.add('active');
      
      // Render patients for this cycle
      renderCyclePatients(cycle, year);
    }
  });
  
  // Year filter
  byId('ordoYearFilter')?.addEventListener('change', () => {
    const activeTab = document.querySelector('.cycle-tab.active');
    const cycle = activeTab ? parseInt(activeTab.dataset.cycle) : 1;
    const year = parseInt(byId('ordoYearFilter').value);
    
    // Update cycle counts
    for (let i = 1; i <= 3; i++) {
      const patients = getPatientsByCycle(i, year);
      const countEl = byId(`cycle${i}Count`);
      if (countEl) countEl.textContent = patients.length;
    }
    
    renderCyclePatients(cycle, year);
  });
  
  // Update system events
  byId('btnSaveGithubConfig')?.addEventListener('click', saveGithubConfig);
  byId('btnCheckUpdate')?.addEventListener('click', checkGithubUpdates);
  byId('btnDownloadUpdate')?.addEventListener('click', downloadGithubUpdate);
  byId('btnInstallUpdate')?.addEventListener('click', installGithubUpdate);

  // Prescription duration change events
  const durationRadios = document.querySelectorAll('input[name="prescDuration"]');
  durationRadios.forEach(radio => {
    radio.addEventListener('change', updatePrescEndDate);
  });

  // Prescription start date change event
  byId('prescStartDate')?.addEventListener('change', updatePrescEndDate);

  console.log('🎉 Tous les event listeners ont été attachés avec succès!');
}

// ===== Legacy Functions =====
function scanLegacyBases() {
  const keys = Object.keys(localStorage);
  const legacyKeys = keys.filter(k => k.includes('nhc-care') && k !== DB_KEY);
  
  if (legacyKeys.length === 0) {
    showToast('Aucune base antérieure trouvée', 'info');
    return;
  }
  
  const bases = legacyKeys.map(key => {
    try {
      const data = JSON.parse(localStorage.getItem(key));
      return {
        key,
        patients: data.patients?.length || 0,
        docs: data.docs?.length || 0,
        centers: data.centers?.length || 0,
        protos: data.protos?.length || 0
      };
    } catch {
      return null;
    }
  }).filter(Boolean);
  
  if (bases.length === 0) {
    showToast('Aucune base valide trouvée', 'warning');
    return;
  }
  
  const msg = bases.map(b => 
    `${b.key}: ${b.patients} patients, ${b.docs} médecins, ${b.centers} centres, ${b.protos} protocoles`
  ).join('\n');
  
  if (confirm(`Bases trouvées:\n\n${msg}\n\nImporter la première ?`)) {
    const base = bases[0];
    const data = JSON.parse(localStorage.getItem(base.key));
    
    state.patients = [...state.patients, ...(data.patients || [])];
    state.docs = [...state.docs, ...(data.docs || [])];
    state.centers = [...state.centers, ...(data.centers || [])];
    state.protos = [...state.protos, ...(data.protos || [])];
    
    saveDB();
    render();
    showToast(`Import depuis ${base.key} réussi`, 'success');
  }
}

function restoreRefs() {
  const keys = Object.keys(localStorage);
  const legacyKeys = keys.filter(k => k.includes('nhc-care') && k !== DB_KEY);
  
  if (legacyKeys.length === 0) {
    showToast('Aucune base antérieure trouvée', 'info');
    return;
  }
  
  const base = legacyKeys[0];
  try {
    const data = JSON.parse(localStorage.getItem(base));
    
    if (confirm('Restaurer les référentiels depuis ' + base + ' ?')) {
      state.docs = data.docs || state.docs;
      state.centers = data.centers || state.centers;
      state.protos = data.protos || state.protos;
      
      saveDB();
      renderCatalogs();
      showToast('Référentiels restaurés', 'success');
    }
  } catch (error) {
    showToast('Erreur de restauration', 'error');
  }
}

// ===== PDF Export Function =====
async function exportCurrentCycleToPDF() {
  try {
    // Get active cycle from the active tab
    const activeTab = document.querySelector('.cycle-tab.active');
    if (!activeTab) {
      showToast('Aucun cycle sélectionné', 'error');
      return;
    }
    
    const cycleNum = parseInt(activeTab.dataset.cycle);
    const year = parseInt(byId('ordoYearFilter')?.value || getCurrentCycle().year);
    const cycleInfo = getCycleInfo(cycleNum, year);
    
    if (!cycleInfo) {
      showToast('Erreur de récupération du cycle', 'error');
      return;
    }
    
    // Get patients for this cycle
    const patients = getPatientsByCycle(cycleNum, year);
    
    if (patients.length === 0) {
      showToast('Aucun patient dans ce cycle', 'warning');
      return;
    }
    
    showToast('Génération du PDF en cours...', 'info');

    // Load jsPDF and autoTable if not already loaded
    try {
      if (typeof window.jspdf === 'undefined') {
        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
        // Verify jsPDF loaded successfully
        if (typeof window.jspdf === 'undefined') {
          throw new Error('jsPDF n\'a pas pu être chargé');
        }
      }
      if (typeof window.jspdf.jsPDF.API.autoTable === 'undefined') {
        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js');
        // Verify autoTable loaded successfully
        if (typeof window.jspdf.jsPDF.API.autoTable === 'undefined') {
          throw new Error('jsPDF autoTable n\'a pas pu être chargé');
        }
      }
    } catch (scriptError) {
      console.error('Error loading PDF libraries:', scriptError);
      showToast('Impossible de charger les bibliothèques PDF. Vérifiez votre connexion internet.', 'error');
      return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({
      orientation: 'l',
      unit: 'mm', 
      format: 'a4',
      putOnlyUsedFonts: true,
      compress: true
    });
    
    // Helper function to clean text for PDF
    const cleanText = (text) => {
      if (!text) return '';
      return text
        .replace(/[^\x00-\x7F]/g, function(char) {
          const accents = {
            'à': 'a', 'á': 'a', 'â': 'a', 'ã': 'a', 'ä': 'a', 'å': 'a',
            'è': 'e', 'é': 'e', 'ê': 'e', 'ë': 'e',
            'ì': 'i', 'í': 'i', 'î': 'i', 'ï': 'i',
            'ò': 'o', 'ó': 'o', 'ô': 'o', 'õ': 'o', 'ö': 'o',
            'ù': 'u', 'ú': 'u', 'û': 'u', 'ü': 'u',
            'ý': 'y', 'ÿ': 'y',
            'ñ': 'n', 'ç': 'c',
            'À': 'A', 'Á': 'A', 'Â': 'A', 'Ã': 'A', 'Ä': 'A', 'Å': 'A',
            'È': 'E', 'É': 'E', 'Ê': 'E', 'Ë': 'E',
            'Ì': 'I', 'Í': 'I', 'Î': 'I', 'Ï': 'I',
            'Ò': 'O', 'Ó': 'O', 'Ô': 'O', 'Õ': 'O', 'Ö': 'O',
            'Ù': 'U', 'Ú': 'U', 'Û': 'U', 'Ü': 'U',
            'Ý': 'Y', 'Ÿ': 'Y',
            'Ñ': 'N', 'Ç': 'C',
            '°': 'o', '€': 'EUR', '£': 'GBP', '¥': 'JPY',
            '–': '-', '—': '-', "'": "'", "'": "'", '"': '"', '"': '"',
            '…': '...', '•': '*', '→': '->', '←': '<-',
            '©': '(c)', '®': '(R)', '™': '(TM)'
          };
          return accents[char] || char;
        });
    };
    
    // Group patients by doctor
    const patientsByDoctor = {};
    patients.forEach(p => {
      const docId = p.docId || 'no-doctor';
      const doctorName = docId === 'no-doctor' ? 'Sans medecin attribue' : cleanText(docName(docId));
      
      if (!patientsByDoctor[doctorName]) {
        patientsByDoctor[doctorName] = [];
      }
      
      const status = getOrdonnanceStatus(p.renewalDate);
      
      patientsByDoctor[doctorName].push({
        lastName: cleanText(p.lastName || ''),
        firstName: cleanText(p.firstName || ''),
        dob: p.dob || '',
        renewalDate: p.renewalDate || 'Non defini',
        protocol: cleanText(protoName(p.protoId) || 'Non defini'),
        center: cleanText(centerName(p.centerId) || 'Non defini'),
        status: cleanText(status.label),
        statusType: status.status,
        daysRemaining: status.days !== undefined ? status.days : null
      });
    });
    
    // Compact header - Title
    doc.setFontSize(16);
    doc.setTextColor(59, 130, 246);
    doc.text(`Ordonnances - ${cycleInfo.name} ${year}`, 14, 12);
    
    doc.setFontSize(8);
    doc.setTextColor(100, 116, 139);
    const startDateStr = cycleInfo.startDate.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
    const endDateStr = cycleInfo.endDate.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
    
    const now = new Date();
    const generatedDateStr = `${now.toLocaleDateString('fr-FR')} a ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
    
    doc.text(`Periode: ${startDateStr} - ${endDateStr} | Genere: ${generatedDateStr}`, 14, 17);
    
    // Stats
    doc.setFontSize(9);
    doc.setTextColor(30, 41, 59);
    const doctorCount = Object.keys(patientsByDoctor).length;
    const doctorText = doctorCount > 1 ? 'medecins' : 'medecin';
    const patientText = patients.length > 1 ? 'patients' : 'patient';
    doc.text(`${doctorCount} ${doctorText} - ${patients.length} ${patientText}`, 14, 22);
    
    let yPosition = 26;
    
    // Sort doctors
    const doctorNames = Object.keys(patientsByDoctor).sort((a, b) => {
      if (a === 'Sans medecin attribue') return 1;
      if (b === 'Sans medecin attribue') return -1;
      return a.localeCompare(b);
    });
    
    // For each doctor
    doctorNames.forEach((doctorName, index) => {
      const doctorPatients = patientsByDoctor[doctorName];
      
      // Calculate approximate height needed for this section
      const rowHeight = 6; // Approximate height per row
      const headerHeight = 6;
      const sectionHeight = headerHeight + (doctorPatients.length * rowHeight);
      
      // Check if we need a new page (leave 15mm margin at bottom)
      if (yPosition + sectionHeight > 195) {
        doc.addPage();
        yPosition = 12;
      }
      
      // Compact doctor header
      doc.setFillColor(59, 130, 246);
      if (doctorName === 'Sans medecin attribue') {
        doc.setFillColor(239, 68, 68);
      }
      doc.rect(10, yPosition, 277, 6, 'F');
      
      doc.setFontSize(10);
      doc.setTextColor(255, 255, 255);
      doc.text(`Dr. ${doctorName}`, 12, yPosition + 4);
      
      // Count urgent cases
      const urgentCount = doctorPatients.filter(p => 
        p.statusType === 'expiree' || p.statusType === 'urgent'
      ).length;
      
      const patientCountText = doctorPatients.length > 1 ? 'patients' : 'patient';
      let countText = `${doctorPatients.length} ${patientCountText}`;
      if (urgentCount > 0) {
        const urgentText = urgentCount > 1 ? 'urgents' : 'urgent';
        countText += ` - ${urgentCount} ${urgentText}`;
      }
      doc.text(countText, 282, yPosition + 4, { align: 'right' });
      
      yPosition += 7;
      
      // Table data - abbreviated names for more compact display
      const tableData = doctorPatients.map(p => [
        `${p.lastName} ${p.firstName}`,
        p.dob,
        p.renewalDate,
        p.status,
        p.protocol,
        p.center
      ]);
      
      // Create compact table
      doc.autoTable({
        startY: yPosition,
        head: [['Patient', 'Naiss.', 'Renouvellement', 'Statut', 'Protocole', 'Centre']],
        body: tableData,
        margin: { left: 10, right: 10 },
        styles: {
          fontSize: 7.5,
          cellPadding: 1.5,
          overflow: 'linebreak',
          cellWidth: 'wrap',
          lineColor: [226, 232, 240],
          lineWidth: 0.1
        },
        headStyles: {
          fillColor: [241, 245, 249],
          textColor: [30, 41, 59],
          fontStyle: 'bold',
          halign: 'left',
          cellPadding: 2
        },
        columnStyles: {
          0: { cellWidth: 42, fontStyle: 'bold' },
          1: { cellWidth: 22 },
          2: { cellWidth: 28 },
          3: { cellWidth: 26 },
          4: { cellWidth: 48 },
          5: { cellWidth: 48 }
        },
        alternateRowStyles: {
          fillColor: [248, 250, 252]
        },
        didParseCell: function(data) {
          if (data.column.index === 3 && data.section === 'body') {
            const patient = doctorPatients[data.row.index];
            if (patient.statusType === 'expiree') {
              data.cell.styles.textColor = [239, 68, 68];
              data.cell.styles.fontStyle = 'bold';
            } else if (patient.statusType === 'urgent') {
              data.cell.styles.textColor = [245, 158, 11];
              data.cell.styles.fontStyle = 'bold';
            }
          }
        }
      });
      
      yPosition = doc.lastAutoTable.finalY + 2;
    });
    
    // Footer
    const pageCount = doc.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
      doc.setPage(i);
      doc.setFontSize(7);
      doc.setTextColor(148, 163, 184);
      doc.text(`NHC Patients Manager - Page ${i}/${pageCount}`, 10, 203);
      doc.text(`Document confidentiel`, 210, 203, { align: 'center' });
    }
    
    // Save
    doc.save(`Ordonnances_${cycleInfo.name}_${year}.pdf`);
    
    showToast('PDF genere avec succes !', 'success');
  } catch (error) {
    console.error('Error generating PDF:', error);
    showToast('Erreur lors de la generation du PDF: ' + error.message, 'error');
  }
}

// Helper function to load external scripts dynamically
function loadScript(src) {
  return new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = src;
    script.onload = resolve;
    script.onerror = reject;
    document.head.appendChild(script);
  });
}

// ===== NOUVEAU SYSTÈME DE MISE À JOUR - IndexedDB + SHA-256 =====
const APP_VERSION = '1.3.0';
const GITHUB_CONFIG_KEY = 'nhc-github-config';
const DB_NAME = 'NHC_UpdateManager';
const DB_VERSION = 1;
const STORE_NAME = 'updates';
const MAX_STORED_VERSIONS = 3;

let pendingUpdate = null;
let githubConfig = {
  rawUrl: '',
  autoCheck: false
};

// ===== Utilitaires IndexedDB =====

function openUpdateDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    request.onerror = () => reject(request.error);
    request.onsuccess = () => resolve(request.result);
    request.onupgradeneeded = (event) => {
      const db = event.target.result;
      if (!db.objectStoreNames.contains(STORE_NAME)) {
        const objectStore = db.createObjectStore(STORE_NAME, { keyPath: 'version' });
        objectStore.createIndex('installedAt', 'installedAt', { unique: false });
        objectStore.createIndex('active', 'active', { unique: false });
      }
    };
  });
}

async function saveUpdateToDB(updateData) {
  const db = await openUpdateDB();
  try {
    const transaction1 = db.transaction([STORE_NAME], 'readwrite');
    const objectStore1 = transaction1.objectStore(STORE_NAME);
    const allUpdates = await new Promise((resolve, reject) => {
      const request = objectStore1.getAll();
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });

    for (const update of allUpdates) {
      update.active = false;
      objectStore1.put(update);
    }

    await new Promise((resolve, reject) => {
      transaction1.oncomplete = () => resolve();
      transaction1.onerror = () => reject(transaction1.error);
    });

    const transaction2 = db.transaction([STORE_NAME], 'readwrite');
    const objectStore2 = transaction2.objectStore(STORE_NAME);
    updateData.active = true;
    updateData.installedAt = new Date().toISOString();
    objectStore2.put(updateData);

    await new Promise((resolve, reject) => {
      transaction2.oncomplete = () => resolve();
      transaction2.onerror = () => reject(transaction2.error);
    });

    await cleanOldVersions(db);
  } finally {
    db.close();
  }
}

async function cleanOldVersions(db) {
  const transaction = db.transaction([STORE_NAME], 'readwrite');
  const objectStore = transaction.objectStore(STORE_NAME);
  const index = objectStore.index('installedAt');

  const allUpdates = await new Promise((resolve, reject) => {
    const request = index.getAll();
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });

  allUpdates.sort((a, b) => new Date(b.installedAt) - new Date(a.installedAt));

  for (let i = MAX_STORED_VERSIONS; i < allUpdates.length; i++) {
    objectStore.delete(allUpdates[i].version);
    console.log(`🗑️ Version ${allUpdates[i].version} supprimée`);
  }
}

async function getAllUpdates() {
  const db = await openUpdateDB();
  try {
    const transaction = db.transaction([STORE_NAME], 'readonly');
    const objectStore = transaction.objectStore(STORE_NAME);
    return await new Promise((resolve, reject) => {
      const request = objectStore.getAll();
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
  } finally {
    db.close();
  }
}

async function deactivateAllUpdates() {
  const db = await openUpdateDB();
  try {
    const transaction = db.transaction([STORE_NAME], 'readwrite');
    const objectStore = transaction.objectStore(STORE_NAME);
    const allUpdates = await new Promise((resolve, reject) => {
      const request = objectStore.getAll();
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });

    for (const update of allUpdates) {
      update.active = false;
      objectStore.put(update);
    }

    await new Promise((resolve, reject) => {
      transaction.oncomplete = () => resolve();
      transaction.onerror = () => reject(transaction.error);
    });
  } finally {
    db.close();
  }
}

async function calculateSHA256(text) {
  const buffer = new TextEncoder().encode(text);
  const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

// ===== Configuration =====

function loadGithubConfig() {
  try {
    const stored = localStorage.getItem(GITHUB_CONFIG_KEY);
    if (stored) {
      githubConfig = JSON.parse(stored);
      const urlInput = byId('githubRawUrl');
      const autoCheckbox = byId('autoCheckUpdates');
      if (urlInput) urlInput.value = githubConfig.rawUrl || '';
      if (autoCheckbox) autoCheckbox.checked = githubConfig.autoCheck || false;
    }
  } catch (e) {
    console.error('❌ Erreur chargement config:', e);
  }
}

function saveGithubConfig() {
  const urlInput = byId('githubRawUrl');
  const autoCheckbox = byId('autoCheckUpdates');
  if (!urlInput) return;

  const url = urlInput.value.trim();
  if (url && !url.match(/^https?:\/\/raw\.githubusercontent\.com\/.+\.json$/)) {
    showToast('❌ URL invalide. Format: https://raw.githubusercontent.com/user/repo/main/version.json', 'error');
    return;
  }

  githubConfig = {
    rawUrl: url,
    autoCheck: autoCheckbox ? autoCheckbox.checked : false
  };

  localStorage.setItem(GITHUB_CONFIG_KEY, JSON.stringify(githubConfig));
  showToast('✅ Configuration enregistrée !', 'success');
}

function compareVersions(v1, v2) {
  const parts1 = v1.replace(/^v/, '').split('.').map(Number);
  const parts2 = v2.replace(/^v/, '').split('.').map(Number);
  for (let i = 0; i < 3; i++) {
    if ((parts1[i] || 0) > (parts2[i] || 0)) return 1;
    if ((parts1[i] || 0) < (parts2[i] || 0)) return -1;
  }
  return 0;
}

function extractVersionFromHTML(htmlContent) {
  const titleMatch = htmlContent.match(/<title>.*?v?(\d+\.\d+\.\d+).*?<\/title>/i);
  if (titleMatch) return titleMatch[1];
  const versionMatch = htmlContent.match(/const\s+APP_VERSION\s*=\s*['"](\d+\.\d+\.\d+)['"]/);
  if (versionMatch) return versionMatch[1];
  return null;
}

// ===== Vérification des mises à jour =====

async function checkGithubUpdates() {
  if (!githubConfig.rawUrl) {
    showToast('⚠️ Configurez d\'abord l\'URL du fichier version.json', 'warning');
    return;
  }

  try {
    showToast('🔍 Vérification des mises à jour...', 'info');

    if (!githubConfig.rawUrl.endsWith('.json')) {
      showToast('❌ Seuls les fichiers version.json sont supportés', 'error');
      return;
    }

    await checkUpdatesViaJson();
  } catch (error) {
    console.error('❌ Erreur vérification:', error);
    showToast('❌ Erreur: ' + error.message, 'error');
  }
}

async function checkUpdatesViaJson() {
  const response = await fetch(githubConfig.rawUrl + '?t=' + Date.now());

  if (!response.ok) {
    showToast('❌ Erreur lors de la récupération: ' + response.statusText, 'error');
    return;
  }

  const versionData = await response.json();

  if (!versionData.version || !versionData.downloadUrl) {
    showToast('❌ Fichier version.json invalide', 'error');
    return;
  }

  const remoteVersion = versionData.version;
  const lastCheckEl = byId('lastUpdateCheck');
  if (lastCheckEl) lastCheckEl.textContent = new Date().toLocaleString('fr-FR');

  console.log(`📊 Comparaison: Remote=${remoteVersion} vs Local=${APP_VERSION}`);

  const comparison = compareVersions(remoteVersion, APP_VERSION);

  if (comparison > 0) {
    showToast('📥 Téléchargement de la mise à jour...', 'info');

    const htmlResponse = await fetch(versionData.downloadUrl + '?t=' + Date.now());
    if (!htmlResponse.ok) {
      showToast('❌ Erreur téléchargement HTML', 'error');
      return;
    }

    const htmlContent = await htmlResponse.text();

    if (!htmlContent.includes('<!DOCTYPE html') && !htmlContent.includes('<html')) {
      showToast('❌ Fichier HTML invalide', 'error');
      return;
    }

    // Calculer le checksum
    const calculatedChecksum = await calculateSHA256(htmlContent);
    console.log(`🔐 Checksum calculé: ${calculatedChecksum.substring(0, 16)}...`);

    // Vérifier le checksum si disponible
    if (versionData.checksum && versionData.checksum !== '') {
      if (calculatedChecksum !== versionData.checksum) {
        showToast('❌ ERREUR: Checksum invalide ! Fichier corrompu ou modifié.', 'error');
        console.error(`Attendu: ${versionData.checksum}`);
        console.error(`Reçu:    ${calculatedChecksum}`);
        return;
      }
      console.log('✅ Checksum vérifié avec succès');
    } else {
      console.warn('⚠️ Aucun checksum fourni, vérification ignorée');
    }

    const availableVersionEl = byId('availableVersion');
    const updateAvailableNoticeEl = byId('updateAvailableNotice');
    const btnDownloadUpdateEl = byId('btnDownloadUpdate');

    if (availableVersionEl) availableVersionEl.textContent = 'v' + remoteVersion;
    if (updateAvailableNoticeEl) updateAvailableNoticeEl.style.display = 'block';
    if (btnDownloadUpdateEl) btnDownloadUpdateEl.style.display = 'inline-flex';

    let releaseNotes = '';
    if (versionData.releaseNotes && versionData.releaseNotes.fr) {
      releaseNotes = '\n\n📝 Nouveautés :\n' + versionData.releaseNotes.fr.join('\n');
    }

    pendingUpdate = {
      version: remoteVersion,
      downloadUrl: versionData.downloadUrl,
      fileName: versionData.fileName,
      htmlContent: htmlContent,
      fileSize: new Blob([htmlContent]).size,
      releaseDate: versionData.releaseDate,
      releaseNotes: versionData.releaseNotes,
      checksum: calculatedChecksum,
      previousVersion: APP_VERSION
    };

    const updateInfoEl = byId('updateInfo');
    const updateDetailsEl = byId('updateDetails');

    if (updateInfoEl) updateInfoEl.style.display = 'block';
    if (updateDetailsEl) {
      updateDetailsEl.textContent = `Version distante: ${remoteVersion}\nVersion actuelle: ${APP_VERSION}\nFichier: ${versionData.fileName}\nTaille: ${(pendingUpdate.fileSize / 1024).toFixed(2)} KB\nDate: ${versionData.releaseDate || 'N/A'}\nChecksum: ${calculatedChecksum.substring(0, 16)}...${releaseNotes}\n\n✨ Nouvelle version disponible !`;
    }

    showToast(`✨ Mise à jour v${remoteVersion} disponible !`, 'success');

  } else if (comparison === 0) {
    showToast('✅ Vous avez la dernière version', 'success');
    const updateNoticeEl = byId('updateAvailableNotice');
    const downloadBtnEl = byId('btnDownloadUpdate');
    if (updateNoticeEl) updateNoticeEl.style.display = 'none';
    if (downloadBtnEl) downloadBtnEl.style.display = 'none';

  } else {
    showToast('ℹ️ Votre version est plus récente', 'info');
    const noticeEl = byId('updateAvailableNotice');
    const dlBtnEl = byId('btnDownloadUpdate');
    if (noticeEl) noticeEl.style.display = 'none';
    if (dlBtnEl) dlBtnEl.style.display = 'none';
  }
}

async function downloadGithubUpdate() {
  if (!pendingUpdate || !pendingUpdate.htmlContent) {
    showToast('❌ Aucune mise à jour disponible', 'error');
    return;
  }

  showToast('✅ Mise à jour prête à être installée !', 'success');

  const installBtnEl = byId('btnInstallUpdate');
  const downloadBtnEl = byId('btnDownloadUpdate');
  if (installBtnEl) installBtnEl.style.display = 'inline-flex';
  if (downloadBtnEl) downloadBtnEl.style.display = 'none';
}

async function installGithubUpdate() {
  if (!pendingUpdate || !pendingUpdate.htmlContent) {
    showToast('❌ Aucune mise à jour téléchargée', 'error');
    return;
  }

  if (!confirm(`Installer la mise à jour v${pendingUpdate.version} ?\n\n✅ Vos données seront préservées\n✅ Intégrité vérifiée par SHA-256\n✅ ${MAX_STORED_VERSIONS} versions de backup automatiques\n⚠️ L'application sera rechargée`)) {
    return;
  }

  try {
    console.log(`📦 Installation de v${pendingUpdate.version}...`);

    await saveUpdateToDB(pendingUpdate);

    console.log('✅ Mise à jour sauvegardée dans IndexedDB');

    showToast('✅ Mise à jour installée ! Rechargement...', 'success');

    setTimeout(() => {
      window.location.reload();
    }, 1500);

  } catch (error) {
    console.error('❌ Erreur installation:', error);
    showToast('❌ Erreur: ' + error.message, 'error');
  }
}

// ===== Historique et Rollback =====

async function checkForUpdates() {
  try {
    const allUpdates = await getAllUpdates();
    const activeUpdate = allUpdates.find(u => u.active);

    if (activeUpdate && activeUpdate.version !== APP_VERSION) {
      const updateInfoEl = byId('updateInfo');
      if (updateInfoEl) {
        updateInfoEl.style.display = 'block';
        updateInfoEl.innerHTML = `
          <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius); border-left: 4px solid var(--success);">
            <h4 style="margin: 0 0 0.5rem 0; color: var(--success);">✅ Mise à jour active</h4>
            <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">Version ${activeUpdate.version} actuellement chargée</p>
          </div>
        `;
      }

      const rollbackBtn = byId('btnRollback');
      if (rollbackBtn) rollbackBtn.style.display = 'inline-flex';

      return true;
    }
  } catch (error) {
    console.error('❌ Erreur vérification updates:', error);
  }
  return false;
}

async function renderUpdateHistory() {
  try {
    const allUpdates = await getAllUpdates();
    const container = byId('updateHistory');

    if (!container) return;

    if (allUpdates.length === 0) {
      container.innerHTML = '<p class="text-muted">Aucune mise à jour installée</p>';
      return;
    }

    allUpdates.sort((a, b) => new Date(b.installedAt) - new Date(a.installedAt));

    container.innerHTML = allUpdates.map((update, index) => `
      <div style="padding: 0.75rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
        <div>
          <div style="font-weight: 600;">v${update.version}</div>
          <div class="text-small text-muted">${new Date(update.installedAt).toLocaleString('fr-FR')}</div>
          <div class="text-small text-muted">Checksum: ${update.checksum ? update.checksum.substring(0, 16) + '...' : 'N/A'}</div>
        </div>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
          ${update.active ? `
            <span class="badge badge-success">Active</span>
            <button class="btn btn-secondary btn-sm" onclick="rollbackUpdate()" title="Revenir au fichier original">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path>
              </svg>
              Rollback
            </button>
          ` : `
            <button class="btn btn-secondary btn-sm" onclick="activateVersion('${update.version}')" title="Activer cette version">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
              </svg>
              Activer
            </button>
          `}
        </div>
      </div>
    `).join('');

  } catch (error) {
    console.error('❌ Erreur affichage historique:', error);
  }
}

async function activateVersion(version) {
  if (!confirm(`Activer la version ${version} ?\n\nL'application sera rechargée.`)) {
    return;
  }

  try {
    const db = await openUpdateDB();
    const transaction = db.transaction([STORE_NAME], 'readwrite');
    const objectStore = transaction.objectStore(STORE_NAME);

    const allUpdates = await new Promise((resolve, reject) => {
      const request = objectStore.getAll();
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });

    for (const update of allUpdates) {
      update.active = (update.version === version);
      objectStore.put(update);
    }

    await new Promise((resolve, reject) => {
      transaction.oncomplete = () => resolve();
      transaction.onerror = () => reject(transaction.error);
    });

    db.close();

    showToast(`✅ Version ${version} activée ! Rechargement...`, 'success');

    setTimeout(() => {
      window.location.reload();
    }, 1000);

  } catch (error) {
    console.error('❌ Erreur activation version:', error);
    showToast('❌ Erreur: ' + error.message, 'error');
  }
}

async function rollbackUpdate() {
  if (!confirm('Revenir au fichier original ?\n\nToutes les mises à jour seront désactivées.\nL\'application utilisera le fichier HTML d\'origine.')) {
    return;
  }

  try {
    await deactivateAllUpdates();

    // Nettoyer aussi localStorage pour compatibilité
    localStorage.removeItem('nhc-care-update');
    localStorage.removeItem('nhc-apply-update-on-load');

    showToast('✅ Retour au fichier original...', 'success');

    setTimeout(() => {
      window.location.reload();
    }, 1000);

  } catch (error) {
    console.error('❌ Erreur rollback:', error);
    showToast('❌ Erreur: ' + error.message, 'error');
  }
}

// Compatibilité avec anciennes fonctions
function loadUpdateFile() {
  showToast('⚠️ Chargement manuel désactivé. Utilisez GitHub pour les mises à jour.', 'warning');
}

function handleUpdateFileSelect(event) {
  // Désactivé
}

function installUpdate() {
  return installGithubUpdate();
}

function applyUpdate() {
  // Compatibility stub - kept for backward compatibility
  console.log('applyUpdate() called - using new IndexedDB system');
}

// ===== Initialization =====
function init() {
  // Load theme
  const savedTheme = localStorage.getItem('nhc-theme') || 'light';
  document.documentElement.setAttribute('data-theme', savedTheme);
  
  if (savedTheme === 'dark') {
    byId('themeIcon').textContent = '☀️';
    byId('themeText').textContent = 'Mode clair';
  }
  
  // Load database
  loadDB();
  
  // Check auto-save support
  checkFileSystemSupport();
  
  // Bind events
  bindEvents();

  // Initialize auto-format date inputs
  initAutoFormatDateInputs();

  // Setup tutorial modal
  setupTutorialModal();

  // Initial render
  render();
  
  // Initialize update system
  loadGithubConfig();
  checkForUpdates();
  renderUpdateHistory();
  byId('currentVersion').textContent = 'v' + APP_VERSION;

  // Check for GitHub updates automatically if enabled
  if (githubConfig.autoCheck && githubConfig.rawUrl) {
    setTimeout(() => {
      checkGithubUpdates();
    }, 2000); // Delay 2 seconds to not slow down initial load
  }
  
  // Show welcome message if first time
  if (state.patients.length === 0 && !localStorage.getItem('nhc-welcome-shown')) {
    showToast('Bienvenue dans NHC Patients Manager ! 🎉', 'success');
    localStorage.setItem('nhc-welcome-shown', 'true');
  }
  
  // Show tutorial on first launch (unless disabled)
  if (!localStorage.getItem('nhc-tutorial-seen') && !localStorage.getItem('nhc-tutorial-disabled')) {
    setTimeout(() => {
      startTutorial();
      localStorage.setItem('nhc-tutorial-seen', 'true');
    }, 1000); // Delay for smooth UX
  }
}

// ===== Start Application =====
document.addEventListener('DOMContentLoaded', init);


// ===== Expose functions to global scope for onclick handlers =====
window.toggleTheme = toggleTheme;
window.toggleNotifications = toggleNotifications;
window.toggleShortcuts = toggleShortcuts;
window.openShortcutManager = openShortcutManager;
window.addShortcut = addShortcut;
window.deleteShortcut = deleteShortcut;
window.configureAutoSave = configureAutoSave;
window.toggleAutoSave = toggleAutoSave;
window.saveNow = saveNow;
window.restoreFromAutoSave = restoreFromAutoSave;
window.refreshOrdonnances = refreshOrdonnances;
window.startBatchRenewal = startBatchRenewal;
window.openCSVImport = openCSVImport;
window.suggestRenewalDate = suggestRenewalDate;
window.showModal = showModal;
window.loadCSVFile = loadCSVFile;
window.goToMapping = goToMapping;
window.executeCSVImport = executeCSVImport;
window.renewOrdonnance = renewOrdonnance;
window.openPatient = openPatient;
window.viewPatientDetails = viewPatientDetails;
window.byId = byId;
window.newPatient = newPatient;
window.savePatient = savePatient;
window.deletePatient = deletePatient;
window.populateSelects = populateSelects;
window.render = render;
window.updateCycleInfo = updateCycleInfo;
window.addDoc = addDoc;
window.addCenter = addCenter;
window.addProto = addProto;
window.fcOpen = fcOpen;
window.fcCopy = fcCopy;
window.fcEditCode = fcEditCode;
window.fcSaveCode = fcSaveCode;
window.fcOpenOrdonnance = fcOpenOrdonnance;
window.fcoOpen = fcoOpen;
window.fcoClose = fcoClose;
window.fcoUpdateEndDate = fcoUpdateEndDate;
window.exportToExcel = exportToExcel;
window.openAdvancedExportModal = openAdvancedExportModal;
window.selectAllFilterDoctors = selectAllFilterDoctors;
window.selectAllFilterProtocols = selectAllFilterProtocols;
window.selectAllFilterCenters = selectAllFilterCenters;
window.executeAdvancedExport = executeAdvancedExport;
window.proceedToExport = proceedToExport;
window.startPatientReview = startPatientReview;
window.previousPatientReview = previousPatientReview;
window.nextPatientReview = nextPatientReview;
window.skipAllReview = skipAllReview;
window.cancelPatientReview = cancelPatientReview;
window.openSwitchModal = openSwitchModal;
window.updateSwitchOldProto = updateSwitchOldProto;
window.saveSwitch = saveSwitch;
window.validateSwitch = validateSwitch;
window.selectPrescriptionOption = selectPrescriptionOption;
window.confirmValidateSwitch = confirmValidateSwitch;
window.deleteSwitch = deleteSwitch;
window.renderSwitches = renderSwitches;
window.toggleSwitchView = toggleSwitchView;
window.renderTimeline = renderTimeline;
window.openAppointmentModal = openAppointmentModal;
window.toggleAppointmentType = toggleAppointmentType;
window.saveAppointment = saveAppointment;
window.deleteAppointment = deleteAppointment;
window.completeAppointment = completeAppointment;
window.toggleNextAppointmentType = toggleNextAppointmentType;
window.confirmCompleteAppointment = confirmCompleteAppointment;
window.renderAppointments = renderAppointments;
window.updateAppointmentStats = updateAppointmentStats;
window.openTaskModal = openTaskModal;
window.saveTask = saveTask;
window.deleteTask = deleteTask;
window.toggleTaskStatus = toggleTaskStatus;
window.updateTaskRelationOptions = updateTaskRelationOptions;
window.renderTasks = renderTasks;
window.exportTasksToCSV = exportTasksToCSV;
window.exportCurrentCycleToPDF = exportCurrentCycleToPDF;
window.loadUpdateFile = loadUpdateFile;
window.installUpdate = installUpdate;
window.rollbackUpdate = rollbackUpdate;
window.checkForUpdates = checkForUpdates;
window.renderStats = renderStats;
window.compareStatistics = compareStatistics;

// Expose new CSV functions
window.csvOnMappingChange = csvOnMappingChange;
window.csvAutoDetectMapping = csvAutoDetectMapping;
window.csvClearMapping = csvClearMapping;
window.csvRedetect = csvRedetect;
window.csvExecuteImport = csvExecuteImport;
window.csvReset = csvReset;

// Expose prescription templates functions
window.openTemplateUploadModal = openTemplateUploadModal;
window.toggleTemplateUpload = toggleTemplateUpload;
window.handleTemplateFileUpload = handleTemplateFileUpload;
window.saveTemplate = saveTemplate;
window.editTemplate = editTemplate;
window.deleteTemplate = deleteTemplate;
window.openGeneratePrescriptionModal = openGeneratePrescriptionModal;
window.updatePrescEndDate = updatePrescEndDate;
window.generatePrescriptionPDF = generatePrescriptionPDF;

// Expose purge functions
window.openPurgeTotaleModal = openPurgeTotaleModal;
window.exportBeforePurge = exportBeforePurge;
window.executePurgeTotale = executePurgeTotale;

// Expose Advanced Prescription Creation functions
window.openAdvancedPrescriptionCreation = openAdvancedPrescriptionCreation;
window.apcSelectCycle = apcSelectCycle;
window.apcApplyFilters = apcApplyFilters;
window.apcSelectAll = apcSelectAll;
window.apcDeselectAll = apcDeselectAll;
window.apcClose = apcClose;
window.apcStartConfiguration = apcStartConfiguration;
window.apcUpdateCurrentEndDate = apcUpdateCurrentEndDate;
window.apcPrevious = apcPrevious;
window.apcSkip = apcSkip;
window.apcValidate = apcValidate;

// Expose state for debugging
window.state = state;

// ===== Tutorial System =====
let currentTutorialStep = 1;
const totalTutorialSteps = 11;

function startTutorial() {
  currentTutorialStep = 1;
  // Block body scroll
  document.body.style.overflow = 'hidden';
  showModal(true, 'tutorialModal');
  updateTutorialUI();
}

function closeTutorial() {
  // Save preference if user checked "don't show again"
  const dontShowAgain = document.getElementById('tutorialDontShowAgain');
  if (dontShowAgain && dontShowAgain.checked) {
    localStorage.setItem('nhc-tutorial-disabled', 'true');
  }
  
  // Restore body scroll
  document.body.style.overflow = '';
  showModal(false, 'tutorialModal');
}

function nextTutorialStep() {
  if (currentTutorialStep < totalTutorialSteps) {
    currentTutorialStep++;
    updateTutorialUI();
  } else {
    closeTutorial();
  }
}

function previousTutorialStep() {
  if (currentTutorialStep > 1) {
    currentTutorialStep--;
    updateTutorialUI();
  }
}

function updateTutorialUI() {
  // Update step indicator
  byId('currentStepNum').textContent = currentTutorialStep;
  byId('totalSteps').textContent = totalTutorialSteps;
  
  // Update progress dots
  const progressContainer = byId('tutorialProgress');
  progressContainer.innerHTML = '';
  for (let i = 1; i <= totalTutorialSteps; i++) {
    const dot = document.createElement('div');
    dot.className = 'tutorial-progress-dot';
    if (i < currentTutorialStep) {
      dot.classList.add('completed');
    } else if (i === currentTutorialStep) {
      dot.classList.add('active');
    }
    progressContainer.appendChild(dot);
  }
  
  // Show/hide steps
  document.querySelectorAll('.tutorial-step').forEach(step => {
    step.classList.remove('active');
  });
  const currentStep = document.querySelector(`.tutorial-step[data-step="${currentTutorialStep}"]`);
  if (currentStep) {
    currentStep.classList.add('active');
  }
  
  // Update navigation buttons
  const prevBtn = byId('tutorialPrevBtn');
  const nextBtn = byId('tutorialNextBtn');
  
  if (prevBtn) {
    prevBtn.disabled = currentTutorialStep === 1;
    prevBtn.style.opacity = currentTutorialStep === 1 ? '0.5' : '1';
  }
  
  if (nextBtn) {
    if (currentTutorialStep === totalTutorialSteps) {
      nextBtn.textContent = '🎉 Terminer';
    } else {
      nextBtn.textContent = 'Suivant →';
    }
  }
  
  // Scroll to top of modal content
  const tutorialContent = byId('tutorialContent');
  if (tutorialContent) {
    tutorialContent.scrollTop = 0;
  }
}

// Setup tutorial modal click handler
function setupTutorialModal() {
  const tutorialModal = byId('tutorialModal');
  const tutorialContent = byId('tutorialContent');
  
  if (tutorialModal) {
    tutorialModal.addEventListener('click', (e) => {
      // Close if clicking on the overlay (not the content)
      if (e.target === tutorialModal) {
        closeTutorial();
      }
    });
  }
  
  // Prevent scroll propagation
  if (tutorialContent) {
    tutorialContent.addEventListener('wheel', (e) => {
      e.stopPropagation();
    }, { passive: true });
  }
}

// Expose tutorial functions
window.startTutorial = startTutorial;
window.closeTutorial = closeTutorial;
window.nextTutorialStep = nextTutorialStep;
window.previousTutorialStep = previousTutorialStep;


// Expose variables needed by CSV import
window.csvImportState = csvImportState;
window.CSV_FIELD_MAPPING = CSV_FIELD_MAPPING;

// ===== UI/UX ENHANCEMENTS =====

// Command Palette
let commandPaletteActive = false;
let commandPaletteSelectedIndex = 0;
let commandPaletteItems = [];

function initCommandPalette() {
  const commandPalette = document.getElementById('commandPalette');
  const commandPaletteInput = document.getElementById('commandPaletteInput');
  const commandPaletteResults = document.getElementById('commandPaletteResults');

  // Define all available commands
  const commands = [
    { id: 'new-patient', title: 'Nouveau patient', description: 'Ajouter un nouveau patient', icon: '👤', action: () => newPatient(), category: 'Actions' },
    { id: 'new-switch', title: 'Planifier un switch', description: 'Planifier un changement de pompe', icon: '🔄', action: () => openSwitchModal(), category: 'Actions' },
    { id: 'new-appointment', title: 'Nouveau rendez-vous', description: 'Créer un nouveau RDV', icon: '📅', action: () => openAppointmentModal(), category: 'Actions' },
    { id: 'fast-check', title: 'Fast Check Ordonnances', description: 'Vérification rapide des ordonnances', icon: '🔍', action: () => fcOpen(), category: 'Actions' },
    { id: 'fast-create-ordo', title: 'Fast Create Ordo', description: 'Génération rapide des ordonnances du cycle', icon: '📝', action: () => fcoOpen(), category: 'Actions' },
    { id: 'export-excel', title: 'Exporter Excel', description: 'Exporter les données en Excel', icon: '📊', action: () => exportToExcel(), category: 'Export' },
    { id: 'import-csv', title: 'Importer CSV', description: 'Importer des patients depuis CSV', icon: '📥', action: () => document.getElementById('btnImportCSV').click(), category: 'Import' },
    { id: 'view-dashboard', title: 'Tableau de bord', description: 'Retour au tableau de bord', icon: '🏠', action: () => switchView('dashboard'), category: 'Navigation' },
    { id: 'view-patients', title: 'Liste des patients', description: 'Voir tous les patients actifs', icon: '👥', action: () => switchView('patients'), category: 'Navigation' },
    { id: 'view-archived', title: 'Patients archivés', description: 'Voir les patients archivés', icon: '📦', action: () => switchView('archived'), category: 'Navigation' },
    { id: 'view-ordos', title: 'Ordonnances', description: 'Gérer les ordonnances', icon: '📋', action: () => switchView('ordos'), category: 'Navigation' },
    { id: 'view-switches', title: 'Switch Pompes', description: 'Gérer les switchs de pompes', icon: '🔄', action: () => switchView('switches'), category: 'Navigation' },
    { id: 'view-appointments', title: 'Suivis / RDV', description: 'Gérer les rendez-vous', icon: '📅', action: () => switchView('appointments'), category: 'Navigation' },
    { id: 'view-catalogs', title: 'Référentiels', description: 'Gérer les référentiels', icon: '📚', action: () => switchView('catalogs'), category: 'Navigation' },
    { id: 'view-report', title: 'Statistiques', description: 'Voir les statistiques', icon: '📈', action: () => switchView('report'), category: 'Navigation' },
    { id: 'toggle-theme', title: 'Changer de thème', description: 'Mode clair / sombre', icon: '🌙', action: () => toggleTheme(), category: 'Paramètres' },
    { id: 'tutorial', title: 'Tutoriel', description: 'Afficher le tutoriel', icon: '🎓', action: () => startTutorial(), category: 'Aide' }
  ];

  // Keyboard shortcut: Ctrl+K or Cmd+K
  document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
      e.preventDefault();
      toggleCommandPalette();
    }

    if (e.key === 'Escape' && commandPaletteActive) {
      toggleCommandPalette();
    }

    if (commandPaletteActive) {
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        commandPaletteSelectedIndex = Math.min(commandPaletteSelectedIndex + 1, commandPaletteItems.length - 1);
        renderCommandPaletteResults(commandPaletteItems);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        commandPaletteSelectedIndex = Math.max(commandPaletteSelectedIndex - 1, 0);
        renderCommandPaletteResults(commandPaletteItems);
      } else if (e.key === 'Enter') {
        e.preventDefault();
        if (commandPaletteItems[commandPaletteSelectedIndex]) {
          commandPaletteItems[commandPaletteSelectedIndex].action();
          toggleCommandPalette();
        }
      }
    }
  });

  // Click outside to close
  commandPalette.addEventListener('click', (e) => {
    if (e.target === commandPalette) {
      toggleCommandPalette();
    }
  });

  // Search input
  commandPaletteInput.addEventListener('input', (e) => {
    const query = e.target.value.toLowerCase();
    commandPaletteSelectedIndex = 0;

    if (!query) {
      commandPaletteItems = commands;
    } else {
      // Search in commands and patients
      const filteredCommands = commands.filter(cmd =>
        cmd.title.toLowerCase().includes(query) ||
        cmd.description.toLowerCase().includes(query) ||
        cmd.category.toLowerCase().includes(query)
      );

      const filteredPatients = state.patients.filter(p =>
        p.name.toLowerCase().includes(query)
      ).map(p => ({
        id: `patient-${p.id}`,
        title: p.name,
        description: `${p.protocol || ''} - ${p.doctor || ''}`,
        icon: '👤',
        action: () => {
          switchView('patients');
          // Highlight patient in list
          setTimeout(() => {
            const patientRow = document.querySelector(`[data-patient-id="${p.id}"]`);
            if (patientRow) {
              patientRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
              patientRow.classList.add('animate-wiggle');
            }
          }, 300);
        },
        category: 'Patients'
      }));

      commandPaletteItems = [...filteredCommands, ...filteredPatients];
    }

    renderCommandPaletteResults(commandPaletteItems);
  });

  function renderCommandPaletteResults(items) {
    if (items.length === 0) {
      commandPaletteResults.innerHTML = `
        <div class="command-palette-empty">
          <svg width="64" height="64" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto 1rem;">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M12 12h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <p>Aucun résultat trouvé</p>
        </div>
      `;
      return;
    }

    let lastCategory = '';
    let html = '';

    items.forEach((item, index) => {
      if (item.category !== lastCategory) {
        html += `<div style="padding: 0.5rem 1rem; font-size: 0.75rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-top: ${lastCategory ? '0.5rem' : '0'};">${item.category}</div>`;
        lastCategory = item.category;
      }

      const isSelected = index === commandPaletteSelectedIndex;
      html += `
        <div class="command-palette-item ${isSelected ? 'selected' : ''}" data-index="${index}">
          <div class="command-palette-item-icon">${item.icon}</div>
          <div class="command-palette-item-content">
            <div class="command-palette-item-title">${item.title}</div>
            <div class="command-palette-item-description">${item.description}</div>
          </div>
        </div>
      `;
    });

    commandPaletteResults.innerHTML = html;

    // Add click handlers
    commandPaletteResults.querySelectorAll('.command-palette-item').forEach((el, index) => {
      el.addEventListener('click', () => {
        items[index].action();
        toggleCommandPalette();
      });
    });

    // Scroll selected item into view
    const selectedItem = commandPaletteResults.querySelector('.command-palette-item.selected');
    if (selectedItem) {
      selectedItem.scrollIntoView({ block: 'nearest' });
    }
  }

  // Initial render
  commandPaletteItems = commands;
  renderCommandPaletteResults(commands);
}

function toggleCommandPalette() {
  const commandPalette = document.getElementById('commandPalette');
  const commandPaletteInput = document.getElementById('commandPaletteInput');

  commandPaletteActive = !commandPaletteActive;

  if (commandPaletteActive) {
    commandPalette.classList.add('active');
    commandPaletteInput.value = '';
    commandPaletteInput.focus();
    commandPaletteSelectedIndex = 0;
  } else {
    commandPalette.classList.remove('active');
  }
}

// Count-up animation for KPI cards
function animateCountUp(element, target, duration = 1000) {
  const start = 0;
  const startTime = performance.now();

  function update(currentTime) {
    const elapsed = currentTime - startTime;
    const progress = Math.min(elapsed / duration, 1);

    // Easing function (easeOutExpo)
    const value = start + (target - start) * (1 - Math.pow(2, -10 * progress));

    element.textContent = Math.floor(value);
    element.classList.add('animate-count-up');

    if (progress < 1) {
      requestAnimationFrame(update);
    } else {
      element.textContent = target;
    }
  }

  requestAnimationFrame(update);
}

// Enhanced toast notifications
let toastQueue = [];
let toastTimeout = null;

function showToast(message, type = 'success', duration = 3000) {
  const container = document.querySelector('.toast-container') || createToastContainer();

  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = `
    <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
      ${type === 'success' ? '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>' :
       type === 'error' ? '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>' :
       '<path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>'}
    </svg>
    <span>${message}</span>
    <button class="toast-close" onclick="this.parentElement.remove()">✕</button>
    <div class="toast-progress"></div>
  `;

  container.appendChild(toast);

  // Auto remove after duration
  setTimeout(() => {
    toast.classList.add('removing');
    setTimeout(() => toast.remove(), 300);
  }, duration);
}

function createToastContainer() {
  const container = document.createElement('div');
  container.className = 'toast-container';
  document.body.appendChild(container);
  return container;
}

// Mobile navigation
function initMobileNav() {
  const mobileNavItems = document.querySelectorAll('.mobile-nav-item[data-view]');

  mobileNavItems.forEach(item => {
    item.addEventListener('click', () => {
      const view = item.dataset.view;
      switchView(view);

      // Update active state
      mobileNavItems.forEach(i => i.classList.remove('active'));
      item.classList.add('active');
    });
  });
}

// Update breadcrumbs
function updateBreadcrumbs(viewName) {
  const breadcrumbsContainer = document.querySelector('.breadcrumbs');
  if (!breadcrumbsContainer) return;

  const viewNames = {
    'dashboard': 'Tableau de bord',
    'patients': 'Patients',
    'archived': 'Archivés',
    'ordos': 'Ordonnances',
    'switches': 'Switch Pompes',
    'appointments': 'Suivis / RDV',
    'catalogs': 'Référentiels',
    'report': 'Statistiques',
    'backup': 'Import/Export',
    'debug': 'Debug',
    'update': 'Mise à jour',
    'about': 'À propos'
  };

  const viewIcon = {
    'dashboard': '🏠',
    'patients': '👥',
    'archived': '📦',
    'ordos': '📋',
    'switches': '🔄',
    'appointments': '📅',
    'catalogs': '📚',
    'report': '📈',
    'backup': '💾',
    'debug': '🐛',
    'update': '🔄',
    'about': 'ℹ️'
  };

  breadcrumbsContainer.innerHTML = `
    <button class="breadcrumb-item" onclick="switchView('dashboard')">
      <span>🏠</span>
      <span>Accueil</span>
    </button>
    ${viewName !== 'dashboard' ? `
      <span class="breadcrumb-separator">›</span>
      <span class="breadcrumb-item active">
        <span>${viewIcon[viewName] || ''}</span>
        <span>${viewNames[viewName] || viewName}</span>
      </span>
    ` : ''}
  `;
}

// Add breadcrumbs to main section
function addBreadcrumbsToMain() {
  const main = document.querySelector('.main');
  if (!main) return;

  const breadcrumbs = document.createElement('div');
  breadcrumbs.className = 'breadcrumbs';
  main.insertBefore(breadcrumbs, main.firstChild);

  updateBreadcrumbs('dashboard');
}

// Empty state generator
function createEmptyState(config) {
  const { icon, title, description, actionText, actionCallback } = config;

  return `
    <div class="empty-state">
      <svg class="empty-state-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        ${icon}
      </svg>
      <h3 class="empty-state-title">${title}</h3>
      <p class="empty-state-description">${description}</p>
      ${actionText ? `
        <button class="empty-state-action" onclick="${actionCallback}">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
          </svg>
          ${actionText}
        </button>
      ` : ''}
    </div>
  `;
}

// Add glassmorphism to modals
function enhanceModals() {
  const modals = document.querySelectorAll('.modal:not(.tutorial-modal)');
  modals.forEach(modal => {
    modal.classList.add('glass');
  });
}

// Form validation enhancement
function enhanceFormValidation() {
  const forms = document.querySelectorAll('form');

  forms.forEach(form => {
    const inputs = form.querySelectorAll('.form-input, .form-select, .form-textarea');

    inputs.forEach(input => {
      input.addEventListener('blur', () => {
        validateField(input);
      });

      input.addEventListener('input', () => {
        const formGroup = input.closest('.form-group');
        if (formGroup && formGroup.classList.contains('has-error')) {
          validateField(input);
        }
      });
    });
  });
}

function validateField(input) {
  const formGroup = input.closest('.form-group');
  if (!formGroup) return;

  // Remove previous validation
  formGroup.classList.remove('has-error', 'has-success');
  const existingError = formGroup.querySelector('.form-error, .form-success');
  if (existingError) existingError.remove();

  // Check if required and empty
  if (input.hasAttribute('required') && !input.value.trim()) {
    formGroup.classList.add('has-error');
    const error = document.createElement('div');
    error.className = 'form-error';
    error.innerHTML = `
      <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
      </svg>
      <span>Ce champ est requis</span>
    `;
    formGroup.appendChild(error);
    return false;
  }

  // If valid and has value
  if (input.value.trim()) {
    formGroup.classList.add('has-success');
  }

  return true;
}

// Add success animation to buttons
function addSuccessAnimationToButton(button) {
  button.classList.add('animate-success');
  setTimeout(() => {
    button.classList.remove('animate-success');
  }, 600);
}

// Override the original switchView to add breadcrumbs update
const originalSwitchView = switchView;
switchView = function(viewName) {
  originalSwitchView(viewName);
  updateBreadcrumbs(viewName);

  // Update mobile nav
  const mobileNavItems = document.querySelectorAll('.mobile-nav-item[data-view]');
  mobileNavItems.forEach(item => {
    item.classList.toggle('active', item.dataset.view === viewName);
  });
};

// Initialize all UI enhancements
function initUIEnhancements() {
  initCommandPalette();
  initMobileNav();
  addBreadcrumbsToMain();
  enhanceModals();
  enhanceFormValidation();

  // Override showNotification to use new toast
  window.originalShowNotification = window.showNotification;
  window.showNotification = function(message, type = 'success') {
    showToast(message, type);
  };

  console.log('✨ UI Enhancements loaded successfully!');
}

// Initialize when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initUIEnhancements);
} else {
  initUIEnhancements();
}

// Expose new functions
window.toggleCommandPalette = toggleCommandPalette;
window.showToast = showToast;
window.animateCountUp = animateCountUp;
window.createEmptyState = createEmptyState;
window.addSuccessAnimationToButton = addSuccessAnimationToButton;

})();
</script>

<!-- Tutorial Modal -->
<div class="modal tutorial-modal" id="tutorialModal">
  <div class="modal-content">
    <div class="tutorial-header">
      <h2>🎓 Bienvenue dans NHC Patients Manager</h2>
      <p>Découvrez toutes les fonctionnalités de l'application</p>
    </div>
    
    <div class="tutorial-progress" id="tutorialProgress"></div>
    
    <div class="tutorial-content" id="tutorialContent">
      <div class="tutorial-step active" data-step="1">
        <div class="tutorial-step-number">1</div>
        <h3>👋 Présentation de l'application</h3>
        <p>NHC Patients Manager est une application complète pour gérer vos patients sous pompe à insuline. Elle vous permet de suivre les ordonnances, planifier les switchs de pompes, gérer les rendez-vous et bien plus encore.</p>
        
        <div class="tutorial-feature">
          <h4>
            <span class="tutorial-feature-icon">📊</span>
            Tableau de bord complet
          </h4>
          <p>Vue d'ensemble de vos patients, ordonnances et rendez-vous à venir</p>
        </div>
        
        <div class="tutorial-feature">
          <h4>
            <span class="tutorial-feature-icon">💾</span>
            Sauvegarde automatique
          </h4>
          <p>Vos données sont automatiquement sauvegardées localement dans votre navigateur</p>
        </div>
        
        <div class="tutorial-tip">
          <strong>💡 Astuce</strong>
          <p>Utilisez ce tutoriel à tout moment en cliquant sur le bouton "🎓 Tutoriel" dans la barre latérale</p>
        </div>
      </div>
    </div>
    
    <div class="tutorial-navigation">
      <div class="tutorial-step" data-step="2">
        <div class="tutorial-step-number">2</div>
        <h3>👤 Ajouter un patient</h3>
        <p>La première étape est d'ajouter vos patients au système. Voici comment procéder :</p>
        
        <div class="tutorial-feature">
          <h4>
            <span class="tutorial-feature-icon">➕</span>
            Méthode 1 : Ajout manuel
          </h4>
          <p>Cliquez sur "Patients" dans le menu, puis sur le bouton "+ Nouveau patient"</p>
          <ul>
            <li>Remplissez les informations du patient (nom, prénom, date de naissance)</li>
            <li>Ajoutez le code patient et les informations médicales</li>
            <li>Définissez le protocole actuel et le centre de suivi</li>
          </ul>
        </div>
        
        <div class="tutorial-feature">
          <h4>
            <span class="tutorial-feature-icon">📄</span>
            Méthode 2 : Import CSV
          </h4>
          <p>Importez plusieurs patients en une seule fois depuis un fichier CSV (voir étape 7)</p>
        </div>
        
        <div class="tutorial-tip">
          <strong>💡 Astuce</strong>
          <p>Vous pouvez modifier un patient à tout moment en cliquant sur son nom dans la liste</p>
        </div>
      </div>
      
      <!-- Step 3: Gestion des ordonnances -->
      <div class="tutorial-step" data-step="3">
        <div class="tutorial-step-number">3</div>
        <h3>📋 Gérer les ordonnances</h3>
        <p>Suivez les cycles d'ordonnances de vos patients et anticipez les renouvellements.</p>
        
        <div class="tutorial-feature">
          <h4>
            <span class="tutorial-feature-icon">📝</span>
            Créer une ordonnance
          </h4>
          <p>Depuis la fiche patient, cliquez sur "Nouvelle ordonnance" :</p>
          <ul>
            <li>Sélectionnez le médecin prescripteur</li>
            <li>Définissez la date de début et la durée du cycle</li>
            <li>Le système calcule automatiquement la date de fin</li>
          </ul>
        </div>
        
        <div class="tutorial-feature">
          <h4>
            <span class="tutorial-feature-icon">🔔</span>
            Alertes de renouvellement
          </h4>
          <p>Les ordonnances qui arrivent à échéance sont signalées automatiquement dans le tableau de bord</p>
        </div>
        
        <div class="tutorial-tip">
          <strong>💡 Astuce</strong>
          <p>Utilisez la fonction "Renouvellement groupé" pour traiter plusieurs ordonnances en même temps</p>
        </div>
      </div>
      
      <!-- Step 4: Switch de pompes -->
      <div class="tutorial-step" data-step="4">
        <div class="tutorial-step-number">4</div>
        <h3>🔄 Planifier les switchs de pompes</h3>
        <p>Gérez les changements de pompe à insuline de vos patients avec la fonction Switch.</p>
        
        <div class="tutorial-feature">
          <h4>
            <span class="tutorial-feature-icon">📅</span>
            Créer un switch
          </h4>
          <p>Accédez à "Switch Pompes" dans le menu :</p>
          <ul>
            <li>Cliquez sur "+ Nouveau switch"</li>
            <li>Sélectionnez le patient et la date du switch</li>
            <li>Choisissez l'ancien et le nouveau protocole</li>
            <li>Ajoutez des notes si nécessaire</li>
          </ul>
        </div>
        
        <div class="tutorial-feature">
          <h4>
            <span class="tutorial-feature-icon">✅</span>
            Valider un switch
          </h4>
          <p>Une fois le switch effectué, validez-le pour :</p>
          <ul>
            <li>Mettre à jour automatiquement le protocole du patient</li>
            <li>Générer une ordonnance si nécessaire</li>
            <li>Marquer le switch comme "Effectué"</li>
          </ul>
        </div>
        
        <div class="tutorial-tip">
          <strong>💡 Astuce</strong>
          <p>Utilisez la vue "Timeline" pour visualiser tous vos switchs sur 3 mois glissants (1 mois avant, 2 mois après)</p>
        </div>
      </div>
      
      <!-- Step 5: Timeline -->
      <div class="tutorial-step" data-step="5">
        <div class="tutorial-step-number">5</div>
        <h3>📆 Timeline des switchs (3 mois glissants)</h3>
        <p>Visualisez tous vos switchs planifiés sur une période de 3 mois.</p>
        
        <div class="tutorial-feature">
          <h4>
            <span class="tutorial-feature-icon">🗓️</span>
            Vue chronologique
          </h4>
          <p>La timeline affiche automatiquement :</p>
          <ul>
            <li>1 mois avant la date actuelle</li>
            <li>Le mois en cours (mis en évidence)</li>
            <li>2 mois après la date actuelle</li>
          </ul>
        </div>
        
        <div class="tutorial-feature">
          <h4>
            <span class="tutorial-feature-icon">🎨</span>
            Codes couleur
          </h4>
          <p>Les switchs sont colorés selon leur statut :</p>
          <ul>
            <li><strong style="color: #ef4444;">Rouge</strong> : En retard</li>
            <li><strong style="color: #f59e0b;">Orange</strong> : Aujourd'hui</li>
            <li><strong style="color: #3b82f6;">Bleu</strong> : Cette semaine</li>
            <li><strong style="color: #10b981;">Vert</strong> : À venir</li>
            <li><strong style="color: #6b7280;">Gris</strong> : Effectué</li>
          </ul>
        </div>
        
        <div class="tutorial-tip">
          <strong>💡 Astuce</strong>
          <p>Cliquez sur un switch dans la timeline pour l'ouvrir et le modifier ou le valider directement</p>
        </div>
      </div>
      
      <!-- Step 6: Rendez-vous -->
      <div class="tutorial-step" data-step="6">
        <div class="tutorial-step-number">6</div>
        <h3>🗓️ Gérer les rendez-vous</h3>
        <p>Planifiez et suivez les rendez-vous de vos patients.</p>
        
        <div class="tutorial-feature">
          <h4>
            <span class="tutorial-feature-icon">➕</span>
            Créer un rendez-vous
          </h4>
          <p>Dans "Suivis / RDV" :</p>
          <ul>
            <li>Cliquez sur "+ Nouveau rendez-vous"</li>
            <li>Sélectionnez le patient et la date</li>
            <li>Choisissez le type (consultation, formation, suivi)</li>
            <li>Ajoutez des notes</li>
          </ul>
        </div>
        
        <div class="tutorial-feature">
          <h4>
            <span class="tutorial-feature-icon">✅</span>
            Compléter un rendez-vous
          </h4>
          <p>Après le rendez-vous, marquez-le comme "Effectué" et planifiez éventuellement le prochain</p>
        </div>
        
        <div class="tutorial-tip">
          <strong>💡 Astuce</strong>
          <p>Les rendez-vous à venir s'affichent dans le tableau de bord avec des alertes colorées</p>
        </div>
      </div>
      
      <!-- Step 7: Import CSV -->
      <div class="tutorial-step" data-step="7">
        <div class="tutorial-step-number">7</div>
        <h3>📥 Importer des données CSV</h3>
        <p>Importez plusieurs patients en une seule fois depuis un fichier CSV.</p>
        
        <div class="tutorial-feature">
          <h4>
            <span class="tutorial-feature-icon">📄</span>
            Préparer le fichier CSV
          </h4>
          <p>Votre fichier CSV peut contenir les colonnes suivantes :</p>
          <ul>
            <li>Nom, Prénom, Date de naissance</li>
            <li>Code patient, Téléphone, Email</li>
            <li>Protocole, Centre</li>
          </ul>
        </div>
        
        <div class="tutorial-feature">
          <h4>
            <span class="tutorial-feature-icon">🔄</span>
            Processus d'import
          </h4>
          <p>Dans "Import/Export" :</p>
          <ul>
            <li>Sélectionnez votre fichier CSV</li>
            <li>Mappez les colonnes automatiquement ou manuellement</li>
            <li>Prévisualisez les données avant l'import</li>
            <li>Validez l'import</li>
          </ul>
        </div>
        
        <div class="tutorial-tip">
          <strong>💡 Astuce</strong>
          <p>L'application détecte automatiquement le format et le séparateur de votre fichier CSV</p>
        </div>
      </div>
      
      <!-- Step 8: Sauvegarde automatique -->
      <div class="tutorial-step" data-step="8">
        <div class="tutorial-step-number">8</div>
        <h3>💾 Sauvegarde automatique</h3>
        <p>Vos données sont protégées grâce au système de sauvegarde automatique.</p>
        
        <div class="tutorial-feature">
          <h4>
            <span class="tutorial-feature-icon">⚡</span>
            Sauvegarde locale
          </h4>
          <p>Toutes vos données sont automatiquement enregistrées dans le navigateur :</p>
          <ul>
            <li>Aucune connexion Internet requise</li>
            <li>Données stockées localement sur votre appareil</li>
            <li>Sauvegarde après chaque modification</li>
          </ul>
        </div>
        
        <div class="tutorial-feature">
          <h4>
            <span class="tutorial-feature-icon">📤</span>
            Export de sauvegarde
          </h4>
          <p>Dans "Import/Export", vous pouvez :</p>
          <ul>
            <li>Exporter toute votre base de données en JSON</li>
            <li>Créer une sauvegarde manuelle à tout moment</li>
            <li>Importer une sauvegarde précédente</li>
          </ul>
        </div>
        
        <div class="tutorial-tip">
          <strong>💡 Astuce</strong>
          <p>Faites régulièrement des sauvegardes manuelles en exportant vos données pour plus de sécurité</p>
        </div>
      </div>
      
      <!-- Step 9: Export Excel/PDF -->
      <div class="tutorial-step" data-step="9">
        <div class="tutorial-step-number">9</div>
        <h3>📊 Exporter vers Excel et PDF</h3>
        <p>Créez des rapports professionnels en quelques clics.</p>
        
        <div class="tutorial-feature">
          <h4>
            <span class="tutorial-feature-icon">📗</span>
            Export Excel
          </h4>
          <p>Exportez vos données en format Excel :</p>
          <ul>
            <li>Liste complète des patients avec toutes leurs informations</li>
            <li>Ordonnances avec dates et cycles</li>
            <li>Switchs planifiés et historique</li>
            <li>Format compatible avec Microsoft Excel et LibreOffice</li>
          </ul>
        </div>
        
        <div class="tutorial-feature">
          <h4>
            <span class="tutorial-feature-icon">📕</span>
            Export PDF
          </h4>
          <p>Générez des PDF pour les cycles d'ordonnances :</p>
          <ul>
            <li>Fiche patient complète</li>
            <li>Détails du cycle en cours</li>
            <li>Historique des ordonnances</li>
            <li>Format professionnel prêt à imprimer</li>
          </ul>
        </div>
        
        <div class="tutorial-tip">
          <strong>💡 Astuce</strong>
          <p>Utilisez l'export Excel pour créer des analyses personnalisées dans votre tableur favori</p>
        </div>
      </div>
      
      <!-- Step 10: Référentiels -->
      <div class="tutorial-step" data-step="10">
        <div class="tutorial-step-number">10</div>
        <h3>📚 Gérer les référentiels</h3>
        <p>Configurez les protocoles, médecins et centres pour personnaliser l'application.</p>
        
        <div class="tutorial-feature">
          <h4>
            <span class="tutorial-feature-icon">💊</span>
            Protocoles
          </h4>
          <p>Ajoutez les différents types de pompes et protocoles que vous utilisez</p>
        </div>
        
        <div class="tutorial-feature">
          <h4>
            <span class="tutorial-feature-icon">👨‍⚕️</span>
            Médecins prescripteurs
          </h4>
          <p>Créez la liste des médecins qui prescrivent les ordonnances</p>
        </div>
        
        <div class="tutorial-feature">
          <h4>
            <span class="tutorial-feature-icon">🏥</span>
            Centres de suivi
          </h4>
          <p>Définissez les différents centres où vos patients sont suivis</p>
        </div>
        
        <div class="tutorial-tip">
          <strong>💡 Astuce</strong>
          <p>Configurez d'abord vos référentiels avant d'ajouter des patients pour une saisie plus rapide</p>
        </div>
      </div>
      
      <!-- Step 11: Fin -->
      <div class="tutorial-step" data-step="11">
        <div class="tutorial-step-number">✓</div>
        <h3>🎉 Vous êtes prêt !</h3>
        <p>Vous connaissez maintenant toutes les fonctionnalités principales de NHC Patients Manager.</p>
        
        <div class="tutorial-feature">
          <h4>
            <span class="tutorial-feature-icon">🚀</span>
            Prochaines étapes
          </h4>
          <ul>
            <li>Configurez vos référentiels (protocoles, médecins, centres)</li>
            <li>Ajoutez vos premiers patients</li>
            <li>Créez des ordonnances et planifiez des switchs</li>
            <li>Explorez les différentes vues et rapports</li>
          </ul>
        </div>
        
        <div class="tutorial-feature">
          <h4>
            <span class="tutorial-feature-icon">💡</span>
            Besoin d'aide ?
          </h4>
          <p>Vous pouvez relancer ce tutoriel à tout moment en cliquant sur le bouton "🎓 Tutoriel" dans la barre latérale</p>
        </div>
        
        <div style="text-align: center; padding: 2rem 0;">
          <div style="font-size: 4rem; margin-bottom: 1rem;">🎊</div>
          <p style="font-size: 1.25rem; font-weight: 600; color: var(--primary);">Bonne utilisation de l'application !</p>
        </div>
      </div>
    </div>
    
    <div class="tutorial-navigation">
      <div style="display: flex; align-items: center; gap: 0.5rem;">
        <input type="checkbox" id="tutorialDontShowAgain" style="cursor: pointer;">
        <label for="tutorialDontShowAgain" style="cursor: pointer; font-size: 0.9rem; color: var(--text-secondary); user-select: none;">
          Ne plus afficher automatiquement
        </label>
      </div>
      <div class="tutorial-step-indicator">
        <span id="currentStepNum">1</span> / <span id="totalSteps">11</span>
      </div>
      <div class="tutorial-nav-buttons">
        <button class="btn btn-secondary" id="tutorialPrevBtn" onclick="previousTutorialStep()">
          ← Précédent
        </button>
        <button class="btn btn-secondary" onclick="closeTutorial()">
          Fermer
        </button>
        <button class="btn btn-primary" id="tutorialNextBtn" onclick="nextTutorialStep()">
          Suivant →
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Command Palette -->
<div class="command-palette" id="commandPalette">
  <div class="command-palette-content">
    <div class="command-palette-search">
      <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
      </svg>
      <input type="text" class="command-palette-input" id="commandPaletteInput" placeholder="Rechercher des actions ou des patients...">
    </div>
    <div class="command-palette-results" id="commandPaletteResults"></div>
  </div>
</div>

<!-- Mobile Bottom Navigation -->
<nav class="mobile-nav">
  <div class="mobile-nav-items">
    <button class="mobile-nav-item active" data-view="dashboard">
      <svg fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>
      <span>Accueil</span>
    </button>
    <button class="mobile-nav-item" data-view="patients">
      <svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>
      <span>Patients</span>
    </button>
    <button class="mobile-nav-item" data-view="ordos">
      <svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"></path></svg>
      <span>Ordos</span>
    </button>
    <button class="mobile-nav-item" data-view="switches">
      <svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path></svg>
      <span>Switch</span>
    </button>
    <button class="mobile-nav-item" onclick="toggleCommandPalette()">
      <svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>
      <span>Plus</span>
    </button>
  </div>
</nav>

</body>
</html>

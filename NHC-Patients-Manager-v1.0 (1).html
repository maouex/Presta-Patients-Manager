<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>NHC Patients Manager â€” Gestion Patients v1.2.0</title>
<style>
/* ===== Design System Variables ===== */
:root {
  --primary: #3b82f6;
  --primary-dark: #2563eb;
  --primary-light: #60a5fa;
  --secondary: #8b5cf6;
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --info: #06b6d4;
  
  --bg-primary: #ffffff;
  --bg-secondary: #f8fafc;
  --bg-tertiary: #f1f5f9;
  --bg-dark: #0f172a;
  
  --text-primary: #1e293b;
  --text-secondary: #64748b;
  --text-muted: #94a3b8;
  --text-inverse: #ffffff;
  
  --border: #e2e8f0;
  --border-light: #f1f5f9;
  
  --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
  --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
  --shadow-md: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
  --shadow-lg: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
  --shadow-xl: 0 25px 50px -12px rgb(0 0 0 / 0.25);
  
  --radius-sm: 0.375rem;
  --radius: 0.5rem;
  --radius-md: 0.75rem;
  --radius-lg: 1rem;
  --radius-full: 9999px;
  
  --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  --transition-fast: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Dark Mode */
[data-theme="dark"] {
  --bg-primary: #0f172a;
  --bg-secondary: #1e293b;
  --bg-tertiary: #334155;
  --bg-dark: #020617;
  
  --text-primary: #f1f5f9;
  --text-secondary: #cbd5e1;
  --text-muted: #94a3b8;
  
  --border: #334155;
  --border-light: #475569;
}

/* ===== Base Styles ===== */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  font-size: 16px;
  scroll-behavior: smooth;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  color: var(--text-primary);
  background: var(--bg-secondary);
  line-height: 1.6;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* ===== Layout ===== */
.app {
  display: grid;
  grid-template-columns: 280px 1fr;
  min-height: 100vh;
  transition: var(--transition);
}

.app.sidebar-collapsed {
  grid-template-columns: 80px 1fr;
}

/* ===== Sidebar ===== */
.sidebar {
  background: linear-gradient(180deg, var(--bg-dark) 0%, #1e293b 100%);
  color: var(--text-inverse);
  padding: 1.5rem 1rem;
  position: sticky;
  top: 0;
  height: 100vh;
  overflow-y: auto;
  overflow-x: hidden;
  transition: var(--transition);
  box-shadow: var(--shadow-lg);
  z-index: 30;
}

.brand {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-bottom: 2rem;
  padding: 0 0.5rem;
}

.logo {
  width: 48px;
  height: 48px;
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  border-radius: var(--radius-md);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 900;
  color: white;
  font-size: 1.25rem;
  box-shadow: var(--shadow-md);
  flex-shrink: 0;
}

.brand-title {
  font-size: 1.25rem;
  font-weight: 800;
  background: linear-gradient(135deg, var(--primary-light) 0%, var(--secondary) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.nav-section {
  margin: 1.5rem 0 0.5rem;
  padding: 0 0.75rem;
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--text-muted);
  font-weight: 600;
}

.nav {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.75rem;
  border-radius: var(--radius-md);
  background: transparent;
  border: none;
  color: #cbd5e1;
  cursor: pointer;
  transition: var(--transition-fast);
  position: relative;
  text-align: left;
  width: 100%;
  font-size: 0.9rem;
}

.nav-item:hover {
  background: rgba(255, 255, 255, 0.1);
  color: var(--text-inverse);
  transform: translateX(2px);
}

.nav-item.active {
  background: linear-gradient(90deg, var(--primary) 0%, var(--primary-dark) 100%);
  color: var(--text-inverse);
  box-shadow: var(--shadow-md);
}

.nav-icon {
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.nav-badge {
  margin-left: auto;
  padding: 0.125rem 0.5rem;
  font-size: 0.75rem;
  background: var(--bg-tertiary);
  color: var(--text-primary);
  border-radius: var(--radius-full);
  font-weight: 600;
}

/* ===== Main Content ===== */
.main {
  padding: 1.5rem;
  background: var(--bg-secondary);
  min-height: 100vh;
}

.header {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-bottom: 1.5rem;
  flex-wrap: wrap;
}

.search-box {
  flex: 1;
  min-width: 300px;
  position: relative;
}

.search-input {
  width: 100%;
  padding: 0.75rem 1rem 0.75rem 2.75rem;
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  background: var(--bg-primary);
  font-size: 0.9rem;
  transition: var(--transition-fast);
  box-shadow: var(--shadow-sm);
}

.search-input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.search-icon {
  position: absolute;
  left: 1rem;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-muted);
  pointer-events: none;
}

/* ===== Buttons ===== */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1.25rem;
  border-radius: var(--radius-md);
  font-weight: 600;
  font-size: 0.9rem;
  cursor: pointer;
  transition: var(--transition-fast);
  border: none;
  white-space: nowrap;
}

.btn-primary {
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  color: white;
  box-shadow: var(--shadow);
}

.btn-primary:hover {
  transform: translateY(-1px);
  box-shadow: var(--shadow-md);
}

.btn-secondary {
  background: var(--bg-primary);
  color: var(--text-primary);
  border: 1px solid var(--border);
}

.btn-secondary:hover {
  background: var(--bg-tertiary);
  border-color: var(--primary);
}

.btn-danger {
  background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
  color: white;
}

.btn-success {
  background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
  color: white;
}

.btn-icon {
  padding: 0.5rem;
  border-radius: var(--radius-full);
}

/* ===== Cards ===== */
.card {
  background: var(--bg-primary);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow);
  overflow: hidden;
  transition: var(--transition);
}

.card:hover {
  box-shadow: var(--shadow-md);
}

.card-header {
  padding: 1.25rem;
  border-bottom: 1px solid var(--border-light);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.card-title {
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--text-primary);
}

.card-body {
  padding: 1.25rem;
}

/* ===== KPI Cards ===== */
.kpi-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.kpi-card {
  background: var(--bg-primary);
  padding: 1.5rem;
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow);
  position: relative;
  overflow: hidden;
  transition: var(--transition);
}

.kpi-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 4px;
  height: 100%;
  background: linear-gradient(180deg, var(--primary) 0%, var(--secondary) 100%);
}

.kpi-card:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.kpi-value {
  font-size: 2rem;
  font-weight: 800;
  margin: 0.5rem 0;
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.kpi-label {
  font-size: 0.875rem;
  color: var(--text-secondary);
  font-weight: 500;
}

.kpi-change {
  font-size: 0.75rem;
  margin-top: 0.5rem;
  display: flex;
  align-items: center;
  gap: 0.25rem;
}

.kpi-change.positive {
  color: var(--success);
}

.kpi-change.negative {
  color: var(--danger);
}

/* ===== Tables ===== */
.table-container {
  overflow-x: auto;
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow);
}

.table {
  width: 100%;
  background: var(--bg-primary);
  border-collapse: separate;
  border-spacing: 0;
  table-layout: fixed;
}

.table thead {
  background: var(--bg-tertiary);
}

.table th {
  padding: 1rem;
  text-align: left;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--text-secondary);
  border-bottom: 2px solid var(--border);
}

.table td {
  padding: 1rem;
  border-bottom: 1px solid var(--border-light);
  font-size: 0.9rem;
  overflow: hidden;
  text-overflow: ellipsis;
}

.table tbody tr {
  transition: var(--transition-fast);
}

.table tbody tr:hover {
  background: var(--bg-secondary);
}

/* ===== Badge ===== */
.badge {
  display: inline-flex;
  align-items: center;
  padding: 0.25rem 0.75rem;
  font-size: 0.75rem;
  font-weight: 600;
  border-radius: var(--radius-full);
  text-transform: uppercase;
  letter-spacing: 0.025em;
}

.badge-success {
  background: rgba(16, 185, 129, 0.1);
  color: var(--success);
}

.badge-warning {
  background: rgba(245, 158, 11, 0.1);
  color: var(--warning);
}

.badge-danger {
  background: rgba(239, 68, 68, 0.1);
  color: var(--danger);
}

.badge-info {
  background: rgba(6, 182, 212, 0.1);
  color: var(--info);
}

/* ===== Progress Bar ===== */
.progress {
  height: 8px;
  background: var(--bg-tertiary);
  border-radius: var(--radius-full);
  overflow: hidden;
  position: relative;
}

.progress-bar {
  height: 100%;
  border-radius: var(--radius-full);
  transition: width 0.3s ease;
  position: relative;
  overflow: hidden;
}

.progress-bar::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0;
  right: 0;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
  animation: shimmer 2s infinite;
}

@keyframes shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

/* ===== Modal ===== */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(4px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 100;
  opacity: 0;
  visibility: hidden;
  transition: var(--transition);
}

.modal.active {
  opacity: 1;
  visibility: visible;
}

.modal-content {
  background: var(--bg-primary);
  border-radius: var(--radius-lg);
  width: 90%;
  max-width: 800px;
  max-height: 90vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  box-shadow: var(--shadow-xl);
  transform: scale(0.9);
  transition: var(--transition);
}

.modal.active .modal-content {
  transform: scale(1);
}

.modal-header {
  padding: 1.5rem;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.modal-title {
  font-size: 1.25rem;
  font-weight: 700;
}

.modal-close {
  background: none;
  border: none;
  font-size: 1.5rem;
  color: var(--text-muted);
  cursor: pointer;
  padding: 0.25rem;
  border-radius: var(--radius);
  transition: var(--transition-fast);
}

.modal-close:hover {
  background: var(--bg-tertiary);
  color: var(--text-primary);
}

.modal-body {
  padding: 1.5rem;
  overflow-y: auto;
  flex: 1;
}

.modal-footer {
  padding: 1rem 1.5rem;
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: flex-end;
  gap: 0.5rem;
}

/* ===== Tutorial System ===== */
.tutorial-modal .modal-content {
  max-width: 900px;
  max-height: 90vh;
  display: flex;
  flex-direction: column;
}

.tutorial-step {
  display: none;
}

.tutorial-step.active {
  display: block;
  animation: fadeInUp 0.4s ease;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.tutorial-header {
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  color: white;
  padding: 2rem;
  text-align: center;
}

.tutorial-header h2 {
  font-size: 1.75rem;
  margin-bottom: 0.5rem;
}

.tutorial-header p {
  opacity: 0.9;
  font-size: 1rem;
}

.tutorial-progress {
  display: flex;
  gap: 0.5rem;
  padding: 1rem 1.5rem;
  background: var(--bg-tertiary);
  border-bottom: 1px solid var(--border);
}

.tutorial-progress-dot {
  flex: 1;
  height: 4px;
  background: var(--border);
  border-radius: var(--radius-full);
  transition: var(--transition);
}

.tutorial-progress-dot.completed {
  background: var(--primary);
}

.tutorial-progress-dot.active {
  background: var(--primary);
  box-shadow: 0 0 8px var(--primary);
}

.tutorial-content {
  padding: 2rem;
  overflow-y: auto;
  flex: 1;
}

.tutorial-step-number {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  color: white;
  border-radius: var(--radius-full);
  font-weight: 700;
  font-size: 1.25rem;
  margin-bottom: 1rem;
  box-shadow: var(--shadow);
}

.tutorial-content h3 {
  font-size: 1.5rem;
  color: var(--text-primary);
  margin-bottom: 1rem;
}

.tutorial-content p {
  color: var(--text-secondary);
  line-height: 1.8;
  margin-bottom: 1.5rem;
  font-size: 1rem;
}

.tutorial-feature {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  padding: 1.5rem;
  margin-bottom: 1.5rem;
}

.tutorial-feature h4 {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  font-size: 1.1rem;
  color: var(--text-primary);
  margin-bottom: 0.75rem;
}

.tutorial-feature-icon {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
  background: var(--primary);
  color: white;
  border-radius: var(--radius);
  flex-shrink: 0;
}

.tutorial-feature p {
  margin: 0;
  padding-left: 2.5rem;
  font-size: 0.95rem;
}

.tutorial-feature ul {
  margin: 0.75rem 0 0 0;
  padding-left: 4rem;
}

.tutorial-feature li {
  color: var(--text-secondary);
  margin-bottom: 0.5rem;
  font-size: 0.95rem;
}

.tutorial-tip {
  background: #fef3c7;
  border-left: 4px solid #f59e0b;
  padding: 1rem 1.25rem;
  border-radius: var(--radius);
  margin: 1.5rem 0;
}

[data-theme="dark"] .tutorial-tip {
  background: #78350f;
  border-left-color: #fbbf24;
}

.tutorial-tip strong {
  color: #f59e0b;
  display: block;
  margin-bottom: 0.5rem;
}

[data-theme="dark"] .tutorial-tip strong {
  color: #fbbf24;
}

.tutorial-tip p {
  margin: 0;
  color: #78350f;
  font-size: 0.95rem;
}

[data-theme="dark"] .tutorial-tip p {
  color: #fef3c7;
}

.tutorial-navigation {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 1rem;
  padding: 1.5rem;
  border-top: 1px solid var(--border);
  background: var(--bg-secondary);
}

.tutorial-step-indicator {
  color: var(--text-muted);
  font-size: 0.9rem;
  font-weight: 600;
}

.tutorial-nav-buttons {
  display: flex;
  gap: 0.75rem;
}

.tutorial-screenshot {
  background: var(--bg-tertiary);
  border: 2px solid var(--border);
  border-radius: var(--radius-md);
  padding: 1rem;
  margin: 1.5rem 0;
  text-align: center;
}

.tutorial-screenshot-placeholder {
  background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
  height: 200px;
  border-radius: var(--radius);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-muted);
  font-size: 3rem;
  margin-bottom: 0.75rem;
}

.tutorial-screenshot-caption {
  font-size: 0.85rem;
  color: var(--text-muted);
  font-style: italic;
}

/* ===== Patient Details Card ===== */
.patient-details-card {
  font-size: 0.95rem;
}

.info-section {
  padding: 1.5rem;
  background: var(--bg-secondary);
  border-radius: var(--radius-lg);
  border: 1px solid var(--border);
}

.info-item {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.info-label {
  font-size: 0.8rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  font-weight: 600;
}

.info-value {
  font-size: 1rem;
  color: var(--text-primary);
  font-weight: 500;
}

/* ===== Form Elements ===== */
.form-group {
  margin-bottom: 1.25rem;
}

.form-label {
  display: block;
  margin-bottom: 0.5rem;
  font-size: 0.875rem;
  font-weight: 500;
  color: var(--text-secondary);
}

.form-input,
.form-select,
.form-textarea {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  background: var(--bg-primary);
  font-size: 0.9rem;
  transition: var(--transition-fast);
}

.form-input:focus,
.form-select:focus,
.form-textarea:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.form-textarea {
  min-height: 100px;
  resize: vertical;
}

.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1rem;
}

/* ===== Toast Notifications ===== */
.toast-container {
  position: fixed;
  bottom: 1rem;
  right: 1rem;
  z-index: 99;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.toast {
  background: var(--bg-dark);
  color: white;
  padding: 1rem 1.5rem;
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-xl);
  display: flex;
  align-items: center;
  gap: 0.75rem;
  min-width: 300px;
  animation: slideIn 0.3s ease;
}

@keyframes slideIn {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

.toast.success {
  background: var(--success);
}

.toast.error {
  background: var(--danger);
}

.toast.warning {
  background: var(--warning);
}

/* ===== Dropdown Menu ===== */
.dropdown {
  position: relative;
}

.dropdown-menu {
  position: absolute;
  top: 100%;
  right: 0;
  margin-top: 0.5rem;
  background: var(--bg-primary);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-lg);
  min-width: 200px;
  opacity: 0;
  visibility: hidden;
  transform: translateY(-10px);
  transition: var(--transition-fast);
  z-index: 50;
}

.dropdown-menu.show {
  opacity: 1;
  visibility: visible;
  transform: translateY(0);
}

.dropdown-item {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.75rem 1rem;
  cursor: pointer;
  transition: var(--transition-fast);
  border: none;
  background: none;
  width: 100%;
  text-align: left;
  color: var(--text-primary);
}

.dropdown-item:hover {
  background: var(--bg-secondary);
}

.dropdown-divider {
  height: 1px;
  background: var(--border);
  margin: 0.25rem 0;
}

/* ===== Charts ===== */
.chart-container {
  position: relative;
  height: 300px;
  padding: 1rem;
}

.stat-bars {
  display: flex;
  align-items: flex-end;
  gap: 0.5rem;
  height: 150px;
  padding: 1rem 0;
}

.stat-bar {
  flex: 1;
  background: linear-gradient(180deg, var(--primary-light) 0%, var(--primary-dark) 100%);
  border-radius: var(--radius) var(--radius) 0 0;
  position: relative;
  min-width: 30px;
  transition: var(--transition);
}

.stat-bar:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-md);
}

.stat-bar.success {
  background: linear-gradient(180deg, #34d399 0%, var(--success) 100%);
}

.stat-bar.warning {
  background: linear-gradient(180deg, #fbbf24 0%, var(--warning) 100%);
}

.stat-bar.danger {
  background: linear-gradient(180deg, #f87171 0%, var(--danger) 100%);
}

/* ===== Loading States ===== */
.skeleton {
  background: linear-gradient(90deg, var(--bg-tertiary) 25%, var(--bg-secondary) 50%, var(--bg-tertiary) 75%);
  background-size: 200% 100%;
  animation: loading 1.5s infinite;
  border-radius: var(--radius);
}

@keyframes loading {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

.spinner {
  width: 40px;
  height: 40px;
  border: 3px solid var(--bg-tertiary);
  border-top-color: var(--primary);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* ===== Responsive Design ===== */
@media (max-width: 1024px) {
  .app {
    grid-template-columns: 1fr;
  }
  
  .sidebar {
    position: fixed;
    transform: translateX(-100%);
    transition: transform 0.3s ease;
  }
  
  .sidebar.open {
    transform: translateX(0);
  }
  
  .kpi-grid {
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  }
}

@media (max-width: 768px) {
  .header {
    flex-direction: column;
    align-items: stretch;
  }
  
  .search-box {
    min-width: 100%;
  }
  
  .form-grid {
    grid-template-columns: 1fr;
  }
  
  .table {
    font-size: 0.85rem;
  }
  
  .table th,
  .table td {
    padding: 0.75rem 0.5rem;
  }
}

/* ===== Utilities ===== */
.hidden { display: none !important; }
.view { display: none; }
.view.active { display: block; }

.text-center { text-align: center; }
.text-right { text-align: right; }
.text-muted { color: var(--text-muted); }
.text-small { font-size: 0.875rem; }

.mt-1 { margin-top: 0.5rem; }
.mt-2 { margin-top: 1rem; }
.mt-3 { margin-top: 1.5rem; }
.mb-1 { margin-bottom: 0.5rem; }
.mb-2 { margin-bottom: 1rem; }
.mb-3 { margin-bottom: 1.5rem; }

.flex { display: flex; }
.flex-center { display: flex; align-items: center; justify-content: center; }
.flex-between { display: flex; align-items: center; justify-content: space-between; }
.gap-1 { gap: 0.5rem; }
.gap-2 { gap: 1rem; }

/* ===== Print Styles ===== */
@media print {
  .sidebar,
  .header,
  .btn,
  .modal {
    display: none !important;
  }
  
  .app {
    grid-template-columns: 1fr;
  }
  
  .main {
    padding: 0;
  }
}

/* ===== Animations ===== */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.fade-in {
  animation: fadeIn 0.3s ease;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.slide-up {
  animation: slideUp 0.3s ease;
}

/* New Advanced Animations */
@keyframes successPulse {
  0%, 100% {
    transform: scale(1);
    box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
  }
  50% {
    transform: scale(1.05);
    box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
  }
}

@keyframes countUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-10px); }
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  75% { transform: translateX(5px); }
}

@keyframes slideInRight {
  from {
    opacity: 0;
    transform: translateX(100%);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

@keyframes slideOutRight {
  from {
    opacity: 1;
    transform: translateX(0);
  }
  to {
    opacity: 0;
    transform: translateX(100%);
  }
}

@keyframes bounceIn {
  0% {
    opacity: 0;
    transform: scale(0.3);
  }
  50% {
    opacity: 1;
    transform: scale(1.05);
  }
  70% {
    transform: scale(0.9);
  }
  100% {
    transform: scale(1);
  }
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

@keyframes wiggle {
  0%, 100% { transform: rotate(-3deg); }
  50% { transform: rotate(3deg); }
}

.animate-success {
  animation: successPulse 0.6s ease-out;
}

.animate-count-up {
  animation: countUp 0.5s ease-out;
}

.animate-float {
  animation: float 3s ease-in-out infinite;
}

.animate-bounce-in {
  animation: bounceIn 0.5s ease-out;
}

.animate-wiggle {
  animation: wiggle 0.3s ease-in-out 3;
}

/* ===== Cycle Tabs ===== */
.cycle-tabs {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
}

.cycle-tab {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem;
  background: var(--bg-secondary);
  border: 2px solid var(--border);
  border-radius: var(--radius-lg);
  cursor: pointer;
  transition: var(--transition);
  position: relative;
  overflow: hidden;
}

.cycle-tab:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
  border-color: var(--primary);
}

.cycle-tab.active {
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  color: white;
  border-color: var(--primary-dark);
}

.cycle-tab.active .cycle-tab-subtitle {
  color: rgba(255, 255, 255, 0.9);
}

.cycle-tab-icon {
  font-size: 1.5rem;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-primary);
  border-radius: var(--radius-md);
}

.cycle-tab.active .cycle-tab-icon {
  background: rgba(255, 255, 255, 0.2);
}

.cycle-tab-title {
  font-weight: 700;
  font-size: 1rem;
}

.cycle-tab-subtitle {
  font-size: 0.75rem;
  color: var(--text-muted);
  margin-top: 0.25rem;
}

.cycle-tab-count {
  margin-left: auto;
  padding: 0.25rem 0.75rem;
  background: var(--bg-primary);
  border-radius: var(--radius-full);
  font-weight: 700;
  font-size: 0.9rem;
}

.cycle-tab.active .cycle-tab-count {
  background: rgba(255, 255, 255, 0.2);
}

/* ===== Ordonnance Cards ===== */
.ordo-card {
  display: flex;
  align-items: center;
  padding: 1rem;
  background: var(--bg-primary);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  margin-bottom: 0.5rem;
  transition: var(--transition);
}

.ordo-card:hover {
  background: var(--bg-secondary);
  border-color: var(--primary);
}

.ordo-card.expired {
  border-left: 4px solid var(--danger);
  background: rgba(239, 68, 68, 0.05);
}

.ordo-card.warning {
  border-left: 4px solid var(--warning);
  background: rgba(245, 158, 11, 0.05);
}

.ordo-card.valid {
  border-left: 4px solid var(--success);
}

.ordo-info {
  flex: 1;
}

.ordo-patient {
  font-weight: 700;
  font-size: 1rem;
  margin-bottom: 0.25rem;
}

.ordo-details {
  display: flex;
  gap: 1rem;
  font-size: 0.875rem;
  color: var(--text-secondary);
}

.ordo-detail {
  display: flex;
  align-items: center;
  gap: 0.25rem;
}

.ordo-actions {
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

.ordo-status {
  padding: 0.5rem 1rem;
  border-radius: var(--radius-md);
  font-weight: 600;
  font-size: 0.875rem;
  text-align: center;
  min-width: 100px;
}

.ordo-status.expired {
  background: var(--danger);
  color: white;
}

.ordo-status.urgent {
  background: rgba(239, 68, 68, 0.1);
  color: var(--danger);
}

.ordo-status.warning {
  background: rgba(245, 158, 11, 0.1);
  color: var(--warning);
}

.ordo-status.valid {
  background: rgba(16, 185, 129, 0.1);
  color: var(--success);
}

/* ===== Calendar Grid ===== */
.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 0.25rem;
  margin-top: 1rem;
}

.calendar-header {
  padding: 0.5rem;
  text-align: center;
  font-weight: 600;
  font-size: 0.75rem;
  text-transform: uppercase;
  color: var(--text-secondary);
  background: var(--bg-tertiary);
  border-radius: var(--radius-sm);
}

.calendar-day {
  padding: 0.5rem;
  min-height: 60px;
  background: var(--bg-primary);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-sm);
  font-size: 0.75rem;
  position: relative;
}

.calendar-day.has-renewal {
  background: rgba(245, 158, 11, 0.1);
  border-color: var(--warning);
}

.calendar-day.has-expired {
  background: rgba(239, 68, 68, 0.1);
  border-color: var(--danger);
}

.calendar-day-number {
  font-weight: 600;
  margin-bottom: 0.25rem;
}

.calendar-event {
  font-size: 0.65rem;
  padding: 0.125rem 0.25rem;
  background: var(--primary);
  color: white;
  border-radius: var(--radius-sm);
  margin-top: 0.125rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* ===== Empty States ===== */
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 3rem 2rem;
  text-align: center;
  min-height: 300px;
}

.empty-state-icon {
  width: 120px;
  height: 120px;
  margin-bottom: 1.5rem;
  opacity: 0.6;
  animation: float 3s ease-in-out infinite;
}

.empty-state-title {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 0.5rem;
}

.empty-state-description {
  font-size: 1rem;
  color: var(--text-secondary);
  margin-bottom: 1.5rem;
  max-width: 400px;
}

.empty-state-action {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1.5rem;
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  color: white;
  border: none;
  border-radius: var(--radius-md);
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  box-shadow: var(--shadow);
}

.empty-state-action:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

/* ===== Glassmorphism Effects ===== */
.glass {
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px) saturate(180%);
  -webkit-backdrop-filter: blur(10px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

[data-theme="dark"] .glass {
  background: rgba(15, 23, 42, 0.6);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.modal.glass .modal-content {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
}

[data-theme="dark"] .modal.glass .modal-content {
  background: rgba(15, 23, 42, 0.95);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

/* ===== Command Palette ===== */
.command-palette {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(4px);
  display: flex;
  align-items: flex-start;
  justify-content: center;
  padding-top: 15vh;
  z-index: 200;
  opacity: 0;
  visibility: hidden;
  transition: var(--transition);
}

.command-palette.active {
  opacity: 1;
  visibility: visible;
}

.command-palette-content {
  background: var(--bg-primary);
  border-radius: var(--radius-lg);
  width: 90%;
  max-width: 640px;
  box-shadow: var(--shadow-xl);
  overflow: hidden;
  transform: scale(0.95) translateY(-20px);
  transition: var(--transition);
}

.command-palette.active .command-palette-content {
  transform: scale(1) translateY(0);
}

.command-palette-search {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 1.25rem;
  border-bottom: 1px solid var(--border);
}

.command-palette-search svg {
  color: var(--text-muted);
  flex-shrink: 0;
}

.command-palette-input {
  flex: 1;
  border: none;
  background: transparent;
  font-size: 1.1rem;
  color: var(--text-primary);
  outline: none;
}

.command-palette-input::placeholder {
  color: var(--text-muted);
}

.command-palette-results {
  max-height: 400px;
  overflow-y: auto;
  padding: 0.5rem;
}

.command-palette-item {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.75rem 1rem;
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: var(--transition-fast);
  border: 1px solid transparent;
}

.command-palette-item:hover,
.command-palette-item.selected {
  background: var(--bg-secondary);
  border-color: var(--primary);
}

.command-palette-item-icon {
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-tertiary);
  border-radius: var(--radius);
  flex-shrink: 0;
}

.command-palette-item.selected .command-palette-item-icon {
  background: var(--primary);
  color: white;
}

.command-palette-item-content {
  flex: 1;
}

.command-palette-item-title {
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 0.125rem;
}

.command-palette-item-description {
  font-size: 0.875rem;
  color: var(--text-secondary);
}

.command-palette-item-kbd {
  padding: 0.25rem 0.5rem;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  font-size: 0.75rem;
  font-family: monospace;
  color: var(--text-secondary);
}

.command-palette-empty {
  text-align: center;
  padding: 3rem 2rem;
  color: var(--text-muted);
}

/* ===== Breadcrumbs ===== */
.breadcrumbs {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 1rem;
  padding: 0.75rem 1rem;
  background: var(--bg-primary);
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-sm);
  flex-wrap: wrap;
}

.breadcrumb-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  color: var(--text-secondary);
  font-size: 0.9rem;
  transition: var(--transition-fast);
}

.breadcrumb-item:hover {
  color: var(--primary);
}

.breadcrumb-item.active {
  color: var(--text-primary);
  font-weight: 600;
}

.breadcrumb-separator {
  color: var(--text-muted);
  font-size: 0.75rem;
}

/* ===== Enhanced Loading Skeleton ===== */
.skeleton-card {
  background: var(--bg-primary);
  border-radius: var(--radius-lg);
  padding: 1.5rem;
  box-shadow: var(--shadow);
}

.skeleton-line {
  height: 16px;
  background: linear-gradient(
    90deg,
    var(--bg-secondary) 25%,
    var(--bg-tertiary) 50%,
    var(--bg-secondary) 75%
  );
  background-size: 200% 100%;
  animation: loading 1.5s ease-in-out infinite;
  border-radius: var(--radius-sm);
  margin-bottom: 0.75rem;
}

.skeleton-line.large {
  height: 32px;
}

.skeleton-line.small {
  height: 12px;
}

.skeleton-avatar {
  width: 48px;
  height: 48px;
  border-radius: var(--radius-full);
  background: linear-gradient(
    90deg,
    var(--bg-secondary) 25%,
    var(--bg-tertiary) 50%,
    var(--bg-secondary) 75%
  );
  background-size: 200% 100%;
  animation: loading 1.5s ease-in-out infinite;
}

/* ===== Enhanced Toast Notifications ===== */
.toast {
  position: relative;
  overflow: hidden;
  animation: slideInRight 0.3s ease-out;
}

.toast.removing {
  animation: slideOutRight 0.3s ease-in forwards;
}

.toast-progress {
  position: absolute;
  bottom: 0;
  left: 0;
  height: 3px;
  background: rgba(255, 255, 255, 0.5);
  animation: toastProgress 3s linear;
}

@keyframes toastProgress {
  from { width: 100%; }
  to { width: 0%; }
}

.toast-close {
  background: none;
  border: none;
  color: white;
  cursor: pointer;
  padding: 0.25rem;
  margin-left: auto;
  opacity: 0.8;
  transition: var(--transition-fast);
}

.toast-close:hover {
  opacity: 1;
}

/* ===== Form Validation ===== */
.form-group.has-error .form-input,
.form-group.has-error .form-select,
.form-group.has-error .form-textarea {
  border-color: var(--danger);
  animation: shake 0.3s ease-in-out;
}

.form-group.has-success .form-input,
.form-group.has-success .form-select,
.form-group.has-success .form-textarea {
  border-color: var(--success);
}

.form-error {
  display: flex;
  align-items: center;
  gap: 0.25rem;
  color: var(--danger);
  font-size: 0.875rem;
  margin-top: 0.5rem;
}

.form-success {
  display: flex;
  align-items: center;
  gap: 0.25rem;
  color: var(--success);
  font-size: 0.875rem;
  margin-top: 0.5rem;
}

/* ===== Mobile Bottom Navigation ===== */
.mobile-nav {
  display: none;
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--bg-primary);
  border-top: 1px solid var(--border);
  padding: 0.5rem;
  z-index: 40;
  box-shadow: 0 -4px 6px -1px rgb(0 0 0 / 0.1);
}

.mobile-nav-items {
  display: flex;
  justify-content: space-around;
  align-items: center;
}

.mobile-nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.25rem;
  padding: 0.5rem;
  border-radius: var(--radius);
  color: var(--text-secondary);
  font-size: 0.75rem;
  transition: var(--transition-fast);
  border: none;
  background: none;
  cursor: pointer;
}

.mobile-nav-item.active {
  color: var(--primary);
  background: rgba(59, 130, 246, 0.1);
}

.mobile-nav-item svg {
  width: 24px;
  height: 24px;
}

@media (max-width: 768px) {
  .mobile-nav {
    display: block;
  }

  .main {
    padding-bottom: 5rem;
  }
}

/* ===== Enhanced KPI Cards ===== */
.kpi-card {
  position: relative;
  overflow: hidden;
}

.kpi-card::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(
    135deg,
    rgba(255, 255, 255, 0) 0%,
    rgba(255, 255, 255, 0.1) 100%
  );
  pointer-events: none;
}

.kpi-sparkline {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 30px;
  opacity: 0.3;
}

/* ===== Notification Badge ===== */
.notification-badge {
  position: absolute;
  top: -4px;
  right: -4px;
  background: var(--danger);
  color: white;
  border-radius: var(--radius-full);
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.75rem;
  font-weight: 700;
  animation: pulse 2s infinite;
}

/* ===== Success Checkmark ===== */
.success-checkmark {
  width: 80px;
  height: 80px;
  margin: 0 auto;
}

.success-checkmark-circle {
  stroke-dasharray: 166;
  stroke-dashoffset: 166;
  stroke-width: 2;
  stroke-miterlimit: 10;
  stroke: var(--success);
  fill: none;
  animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
}

.success-checkmark-check {
  transform-origin: 50% 50%;
  stroke-dasharray: 48;
  stroke-dashoffset: 48;
  animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
}

@keyframes stroke {
  100% {
    stroke-dashoffset: 0;
  }
}

/* ===== Responsive Optimizations ===== */
@media (max-width: 768px) {
  .table td,
  .table th {
    padding: 0.75rem 0.5rem;
    font-size: 0.85rem;
  }
}

@media (max-width: 576px) {
  .table td,
  .table th {
    padding: 0.5rem 0.25rem;
    font-size: 0.8rem;
  }
}
</style>
<!-- SheetJS library for Excel file support -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- Chart.js library for statistics graphs -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
<div class="app">
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="brand">
      <div class="logo">NPM</div>
      <div class="brand-title">NHC Patients Manager</div>
    </div>
    
    <div class="nav-section">Navigation</div>
    <nav class="nav" id="nav">
      <button class="nav-item active" data-view="dashboard">
        <span class="nav-icon">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>
        </span>
        <span>Tableau de bord</span>
      </button>
      
      <button class="nav-item" data-view="patients">
        <span class="nav-icon">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>
        </span>
        <span>Patients</span>
        <span class="nav-badge" id="countPatients">0</span>
      </button>
      
      <button class="nav-item" data-view="archived">
        <span class="nav-icon">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path d="M4 3a2 2 0 100 4h12a2 2 0 100-4H4z"></path><path fill-rule="evenodd" d="M3 8h14v7a2 2 0 01-2 2H5a2 2 0 01-2-2V8zm5 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>
        </span>
        <span>ArchivÃ©s</span>
        <span class="nav-badge" id="countArchived">0</span>
      </button>
      
      <button class="nav-item" data-view="ordos">
        <span class="nav-icon">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"></path></svg>
        </span>
        <span>Ordonnances</span>
      </button>
      
      <button class="nav-item" data-view="switches">
        <span class="nav-icon">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path></svg>
        </span>
        <span>Switch Pompes</span>
        <span class="nav-badge" id="countSwitches">0</span>
      </button>
      
      <button class="nav-item" data-view="appointments">
        <span class="nav-icon">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path></svg>
        </span>
        <span>Suivis / RDV</span>
        <span class="nav-badge" id="countAppointments">0</span>
      </button>
      
      <button class="nav-item" data-view="catalogs">
        <span class="nav-icon">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z"></path></svg>
        </span>
        <span>RÃ©fÃ©rentiels</span>
      </button>
      
      <button class="nav-item" data-view="report">
        <span class="nav-icon">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"></path></svg>
        </span>
        <span>Statistiques</span>
      </button>
      
      <button class="nav-item" data-view="backup">
        <span class="nav-icon">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
        </span>
        <span>Import/Export</span>
      </button>
      
      <button class="nav-item" data-view="debug">
        <span class="nav-icon">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
        </span>
        <span>Debug</span>
      </button>
      
      <button class="nav-item" data-view="update">
        <span class="nav-icon">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path></svg>
        </span>
        <span>Mise Ã  jour</span>
      </button>
      
      <button class="nav-item" data-view="about">
        <span class="nav-icon">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"></path></svg>
        </span>
        <span>Ã€ propos</span>
      </button>
    </nav>
    
    <div class="nav-section" style="margin-top: 2rem;">Aide</div>
    <div style="padding: 0 0.75rem; margin-bottom: 1rem;">
      <button class="btn btn-primary" onclick="startTutorial()" style="width: 100%; background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
          <path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z"></path>
        </svg>
        <span>ðŸŽ“ Tutoriel</span>
      </button>
    </div>
    
    <div class="nav-section">ThÃ¨me</div>
    <div style="padding: 0 0.75rem;">
      <button class="btn btn-secondary" onclick="toggleTheme()" style="width: 100%;">
        <span id="themeIcon">ðŸŒ™</span>
        <span id="themeText">Mode sombre</span>
      </button>
    </div>
  </aside>
  
  <!-- Main Content -->
  <main class="main">
    <!-- Header -->
    <header class="header">
      <div class="search-box">
        <svg class="search-icon" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
        <input type="text" class="search-input" id="globalSearch" placeholder="Rechercher... (Ctrl+K)">
      </div>
      
      <button class="btn btn-secondary" id="btnAddPatient">
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path></svg>
        Nouveau patient
      </button>
      
      <button class="btn btn-info" id="btnImportCSV" style="background: var(--info); margin-left: 10px;">
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
        Importer CSV
      </button>
      
      <div class="dropdown">
        <button class="btn btn-primary" id="btnQuickActions">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z"></path></svg>
          Actions rapides
        </button>
        <div class="dropdown-menu" id="qaMenu">
          <button class="dropdown-item" onclick="newPatient()">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 7a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V7z"></path></svg>
            Nouveau patient
          </button>
          <button class="dropdown-item" onclick="openSwitchModal()">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path></svg>
            Planifier switch
          </button>
          <button class="dropdown-item" onclick="openAppointmentModal()">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path></svg>
            Nouveau RDV
          </button>
          <button class="dropdown-item" onclick="fcOpen()">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path></svg>
            Fast Check Ordonnances
          </button>
        </div>
      </div>
    </header>
    
    <!-- Views -->
    <!-- Dashboard View -->
    <section id="dashboard" class="view active">
      <!-- Welcome Header -->
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 2rem; border-radius: var(--radius-lg); margin-bottom: 1.5rem; box-shadow: var(--shadow-lg); position: relative; overflow: hidden;">
        <div style="position: absolute; top: 0; right: 0; width: 300px; height: 300px; background: rgba(255,255,255,0.1); border-radius: 50%; transform: translate(30%, -30%);"></div>
        <div style="position: absolute; bottom: 0; left: 0; width: 200px; height: 200px; background: rgba(255,255,255,0.1); border-radius: 50%; transform: translate(-30%, 30%);"></div>
        <div style="position: relative; z-index: 1;">
          <h1 style="color: white; font-size: 2rem; font-weight: 800; margin: 0 0 0.5rem 0;">
            Tableau de Bord ðŸ“Š
          </h1>
          <p style="color: rgba(255,255,255,0.9); font-size: 1.1rem; margin: 0;" id="dashboardWelcome">
            Bienvenue ! Voici votre vue d'ensemble
          </p>
        </div>
      </div>

      <!-- Actions rapides - EN HAUT -->
      <div class="card" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border: 2px dashed var(--primary); margin-bottom: 1.5rem;">
        <div class="card-body">
          <h3 style="margin: 0 0 1rem 0; color: var(--primary); font-weight: 700;">âš¡ Actions rapides</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <button class="btn btn-primary" onclick="newPatient()" style="justify-content: center; padding: 1rem;">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 7a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V7z"></path></svg>
              Nouveau patient
            </button>
            <button class="btn btn-secondary" onclick="openSwitchModal()" style="justify-content: center; padding: 1rem;">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path></svg>
              Planifier switch
            </button>
            <button class="btn btn-secondary" onclick="openAppointmentModal()" style="justify-content: center; padding: 1rem;">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path></svg>
              Nouveau RDV
            </button>
            <button class="btn btn-secondary" onclick="fcOpen()" style="justify-content: center; padding: 1rem;">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path></svg>
              Fast Check Ordonnances
            </button>
          </div>
        </div>
      </div>

      <!-- Statistiques principales - Grandes cartes -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
        <!-- Patients -->
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: var(--radius-lg); padding: 1.75rem; box-shadow: var(--shadow-md); color: white; transition: var(--transition); cursor: pointer; position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='var(--shadow-xl)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='var(--shadow-md)'">
          <div style="position: absolute; top: -20px; right: -20px; font-size: 6rem; opacity: 0.2;">ðŸ‘¥</div>
          <div style="position: relative; z-index: 1;">
            <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 0.5rem;">Patients actifs</div>
            <div style="font-size: 3rem; font-weight: 800; line-height: 1;" id="kpiPatients">0</div>
            <div style="font-size: 0.85rem; opacity: 0.8; margin-top: 0.5rem;">File active totale</div>
          </div>
        </div>

        <!-- Ordonnances -->
        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: var(--radius-lg); padding: 1.75rem; box-shadow: var(--shadow-md); color: white; transition: var(--transition); cursor: pointer; position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='var(--shadow-xl)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='var(--shadow-md)'">
          <div style="position: absolute; top: -20px; right: -20px; font-size: 6rem; opacity: 0.2;">ðŸ“‹</div>
          <div style="position: relative; z-index: 1;">
            <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 0.5rem;">Ordonnances â‰¤30j</div>
            <div style="font-size: 3rem; font-weight: 800; line-height: 1;" id="kpiRenews">0</div>
            <div style="font-size: 0.85rem; opacity: 0.8; margin-top: 0.5rem;">Ã€ renouveler bientÃ´t</div>
          </div>
        </div>

        <!-- Score qualitÃ© -->
        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border-radius: var(--radius-lg); padding: 1.75rem; box-shadow: var(--shadow-md); color: white; transition: var(--transition); cursor: pointer; position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='var(--shadow-xl)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='var(--shadow-md)'">
          <div style="position: absolute; top: -20px; right: -20px; font-size: 6rem; opacity: 0.2;">â­</div>
          <div style="position: relative; z-index: 1;">
            <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 0.5rem;">Score qualitÃ©</div>
            <div style="font-size: 3rem; font-weight: 800; line-height: 1;" id="kpiScore">0%</div>
            <div style="font-size: 0.85rem; opacity: 0.8; margin-top: 0.5rem;">ComplÃ©tude des donnÃ©es</div>
          </div>
        </div>

        <!-- Protocoles -->
        <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); border-radius: var(--radius-lg); padding: 1.75rem; box-shadow: var(--shadow-md); color: white; transition: var(--transition); cursor: pointer; position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='var(--shadow-xl)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='var(--shadow-md)'">
          <div style="position: absolute; top: -20px; right: -20px; font-size: 6rem; opacity: 0.2;">ðŸ’Š</div>
          <div style="position: relative; z-index: 1;">
            <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 0.5rem;">Protocoles actifs</div>
            <div style="font-size: 3rem; font-weight: 800; line-height: 1;" id="kpiProtos">0</div>
            <div style="font-size: 0.85rem; opacity: 0.8; margin-top: 0.5rem;">Types de pompes</div>
          </div>
        </div>
      </div>

      <!-- Alertes urgentes -->
      <div id="dashboardAlerts" style="margin-bottom: 1.5rem;"></div>

      <!-- Contenu principal en 2 colonnes -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem; align-items: start;">
        <!-- Colonne gauche -->
        <div style="display: flex; flex-direction: column; gap: 1.5rem; height: 100%;">
          <!-- Rendez-vous Ã  venir -->
          <div class="card" style="display: flex; flex-direction: column; min-height: 400px;">
            <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; flex-shrink: 0;">
              <h3 class="card-title" style="display: flex; align-items: center; gap: 0.5rem; margin: 0;">
                <span>ðŸ“…</span>
                Rendez-vous ce mois
              </h3>
              <span class="badge" id="dashboardAppointmentsCount" style="background: rgba(255,255,255,0.3); color: white; font-weight: 700;">0</span>
            </div>
            <div class="card-body" style="padding: 0; flex: 1; display: flex; flex-direction: column; overflow: hidden;">
              <div id="dashboardAppointmentsList" style="flex: 1; overflow-y: auto;">
                <p class="text-muted text-center" style="padding: 2rem;">Aucun suivi prÃ©vu ce mois</p>
              </div>
            </div>
          </div>

          <!-- Switchs Ã  venir -->
          <div class="card" style="display: flex; flex-direction: column;">
            <div class="card-header" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; flex-shrink: 0;">
              <h3 class="card-title" style="display: flex; align-items: center; gap: 0.5rem; margin: 0;">
                <span>ðŸ”„</span>
                Switchs planifiÃ©s
              </h3>
              <span class="badge" id="dashboardSwitchesCount" style="background: rgba(255,255,255,0.3); color: white; font-weight: 700;">0</span>
            </div>
            <div class="card-body" style="padding: 0; display: flex; flex-direction: column;">
              <div id="dashboardSwitchesList" style="max-height: 350px; overflow-y: auto;">
                <p class="text-muted text-center" style="padding: 2rem;">Aucun switch planifiÃ©</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Colonne droite -->
        <div style="display: flex; flex-direction: column; gap: 1.5rem;">
          <!-- Ordonnances Ã  renouveler -->
          <div class="card" style="display: flex; flex-direction: column; min-height: 400px;">
            <div class="card-header" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; flex-shrink: 0;">
              <h3 class="card-title" style="display: flex; align-items: center; gap: 0.5rem; margin: 0;">
                <span>ðŸ“‹</span>
                Ordonnances Ã  renouveler (30j)
              </h3>
            </div>
            <div class="card-body" style="padding: 0; flex: 1; display: flex; flex-direction: column; overflow: hidden;">
              <div style="flex: 1; overflow-y: auto;" id="dashboardRenewalsList">
                <p class="text-muted text-center" style="padding: 2rem;">Aucune ordonnance Ã  renouveler</p>
              </div>
            </div>
          </div>

          <!-- RÃ©partition des protocoles -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title" style="display: flex; align-items: center; gap: 0.5rem; margin: 0;">
                <span>ðŸ“Š</span>
                RÃ©partition des protocoles
              </h3>
            </div>
            <div class="card-body">
              <div id="dashboardProtocolsChart" style="min-height: 200px;">
                <p class="text-muted text-center">Chargement...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Patients View -->
    <section id="patients" class="view">
      <div class="card">
        <div class="card-header" style="flex-wrap: wrap;">
          <h3 class="card-title">Liste des patients</h3>
          <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <select class="form-select" id="sortPatients" style="width: auto;">
              <option value="name">Trier par nom</option>
              <option value="recent">Plus rÃ©cents</option>
              <option value="renewal">Date de renouvellement</option>
              <option value="doctor">MÃ©decin</option>
              <option value="center">Centre</option>
              <option value="protocol">MatÃ©riel</option>
            </select>
            <button class="btn btn-success" onclick="exportToExcel()">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
              </svg>
              Export Excel
            </button>
          </div>
        </div>
        <div class="card-body">
          <div class="table-container">
            <table class="table" id="tblPatients">
              <thead>
                <tr>
                  <th style="width: 25%;">Nom & PrÃ©nom</th>
                  <th style="width: 20%;">MatÃ©riel</th>
                  <th style="width: 20%;">MÃ©decin</th>
                  <th style="width: 15%;">Centre</th>
                  <th style="width: 20%;">Date de renouvellement</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Archived Patients View -->
    <section id="archived" class="view">
      <div class="card">
        <div class="card-header" style="flex-wrap: wrap;">
          <h3 class="card-title">Patients archivÃ©s</h3>
          <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <select class="form-select" id="filterArchivedStatus" style="width: auto;">
              <option value="all">Tous les archivÃ©s</option>
              <option value="temporary_pause">ArrÃªts temporaires</option>
              <option value="permanent_pause">ArrÃªts dÃ©finitifs</option>
            </select>
            <select class="form-select" id="sortArchived" style="width: auto;">
              <option value="name">Trier par nom</option>
              <option value="recent">Plus rÃ©cents</option>
              <option value="pauseDate">Date d'arrÃªt</option>
            </select>
          </div>
        </div>
        <div class="card-body">
          <!-- Statistics Row -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
            <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: var(--radius); padding: 1rem; color: white;">
              <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 0.25rem;">ArrÃªts temporaires</div>
              <div style="font-size: 2rem; font-weight: 700;" id="countTemporaryPause">0</div>
            </div>
            <div style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-radius: var(--radius); padding: 1rem; color: white;">
              <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 0.25rem;">ArrÃªts dÃ©finitifs</div>
              <div style="font-size: 2rem; font-weight: 700;" id="countPermanentPause">0</div>
            </div>
            <div style="background: linear-gradient(135deg, #64748b 0%, #475569 100%); border-radius: var(--radius); padding: 1rem; color: white;">
              <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 0.25rem;">Total archivÃ©s</div>
              <div style="font-size: 2rem; font-weight: 700;" id="countTotalArchived">0</div>
            </div>
          </div>
          
          <div class="table-container">
            <table class="table" id="tblArchived">
              <thead>
                <tr>
                  <th style="width: 25%;">Nom & PrÃ©nom</th>
                  <th style="width: 15%;">Statut</th>
                  <th style="width: 15%;">Date d'arrÃªt</th>
                  <th style="width: 15%;">MatÃ©riel</th>
                  <th style="width: 15%;">MÃ©decin</th>
                  <th style="width: 15%;">Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Prescriptions View -->
    <section id="ordos" class="view">
      <!-- Cycle Overview -->
      <div class="kpi-grid mb-3">
        <div class="kpi-card" style="border-left-color: var(--primary);">
          <div class="kpi-label">Cycle actuel</div>
          <div class="kpi-value" id="currentCycleLabel">-</div>
          <div class="text-small text-muted" id="currentCycleRange">-</div>
        </div>
        
        <div class="kpi-card" style="border-left-color: var(--warning);">
          <div class="kpi-label">Ã€ renouveler (cycle)</div>
          <div class="kpi-value" id="currentCycleRenewals">0</div>
          <div class="text-small text-muted">Dans le cycle actuel</div>
        </div>
        
        <div class="kpi-card" style="border-left-color: var(--danger);">
          <div class="kpi-label">ExpirÃ©es</div>
          <div class="kpi-value" id="expiredCount">0</div>
          <div class="text-small text-muted">Ã€ traiter en urgence</div>
        </div>
        
        <div class="kpi-card" style="border-left-color: var(--success);">
          <div class="kpi-label">En rÃ¨gle</div>
          <div class="kpi-value" id="validCount">0</div>
          <div class="text-small text-muted">Ordonnances valides</div>
        </div>
      </div>
      
      <!-- Cycle Tabs -->
      <div class="card mb-3">
        <div class="card-header">
          <h3 class="card-title">Vue par cycles</h3>
          <div class="flex gap-1">
            <select class="form-select" id="ordoYearFilter" style="width: auto;">
              <option value="2024">2024</option>
              <option value="2025" selected>2025</option>
              <option value="2026">2026</option>
            </select>
            <button class="btn btn-primary" onclick="exportCurrentCycleToPDF()" title="Exporter le cycle en cours en PDF">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v3.586l-1.293-1.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V8z" clip-rule="evenodd"></path></svg>
              Exporter PDF
            </button>
            <button class="btn btn-secondary" onclick="refreshOrdonnances()">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path></svg>
            </button>
          </div>
        </div>
        <div class="card-body">
          <div class="cycle-tabs mb-3">
            <button class="cycle-tab active" data-cycle="1">
              <span class="cycle-tab-icon">â„ï¸</span>
              <div>
                <div class="cycle-tab-title">Cycle 1</div>
                <div class="cycle-tab-subtitle">Janvier - Avril</div>
              </div>
              <span class="cycle-tab-count" id="cycle1Count">0</span>
            </button>
            <button class="cycle-tab" data-cycle="2">
              <span class="cycle-tab-icon">â˜€ï¸</span>
              <div>
                <div class="cycle-tab-title">Cycle 2</div>
                <div class="cycle-tab-subtitle">Mai - AoÃ»t</div>
              </div>
              <span class="cycle-tab-count" id="cycle2Count">0</span>
            </button>
            <button class="cycle-tab" data-cycle="3">
              <span class="cycle-tab-icon">ðŸ‚</span>
              <div>
                <div class="cycle-tab-title">Cycle 3</div>
                <div class="cycle-tab-subtitle">Septembre - DÃ©cembre</div>
              </div>
              <span class="cycle-tab-count" id="cycle3Count">0</span>
            </button>
          </div>
          
          <div id="cyclePatientsList"></div>
        </div>
      </div>
      
      <!-- Upcoming Renewals -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Renouvellements Ã  venir (30 prochains jours)</h3>
          <button class="btn btn-primary" onclick="startBatchRenewal()">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path></svg>
            Renouvellement groupÃ©
          </button>
        </div>
        <div class="card-body">
          <div id="upcomingRenewalsList"></div>
        </div>
      </div>
      
      <!-- Expired Prescriptions -->
      <div class="card mt-3">
        <div class="card-header" style="background: rgba(239, 68, 68, 0.1);">
          <h3 class="card-title" style="color: var(--danger);">âš ï¸ Ordonnances expirÃ©es</h3>
        </div>
        <div class="card-body">
          <div id="expiredList"></div>
        </div>
      </div>
    </section>
    
    <!-- Switches View -->
    <section id="switches" class="view">
      <div class="card mb-3">
        <div class="card-header">
          <h3 class="card-title">ðŸ”„ Gestion des Switches de Pompes</h3>
          <button class="btn btn-primary" onclick="openSwitchModal()">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"></path>
            </svg>
            Nouveau Switch
          </button>
        </div>
      </div>
      
      <!-- Filters -->
      <div class="card mb-3">
        <div class="card-body">
          <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
            <label style="display: flex; align-items: center; gap: 0.5rem;">
              <input type="radio" name="switchFilter" value="all" checked onchange="renderSwitches()">
              <span>Tous</span>
            </label>
            <label style="display: flex; align-items: center; gap: 0.5rem;">
              <input type="radio" name="switchFilter" value="planned" onchange="renderSwitches()">
              <span>ðŸ“… PrÃ©vus</span>
            </label>
            <label style="display: flex; align-items: center; gap: 0.5rem;">
              <input type="radio" name="switchFilter" value="completed" onchange="renderSwitches()">
              <span>âœ… EffectuÃ©s</span>
            </label>
          </div>
        </div>
      </div>
      
      <!-- Timeline View Toggle -->
      <div class="card mb-3">
        <div class="card-body">
          <div style="display: flex; gap: 1rem; align-items: center; justify-content: space-between;">
            <div style="display: flex; gap: 1rem;">
              <button class="btn btn-secondary" id="btnListView" onclick="toggleSwitchView('list')">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>
                Vue Liste
              </button>
              <button class="btn btn-primary" id="btnTimelineView" onclick="toggleSwitchView('timeline')">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path></svg>
                Vue Timeline
              </button>
            </div>
            <div style="color: var(--text-muted); font-size: 14px;">
              <span id="timelineMonthDisplay"></span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Timeline View Container -->
      <div id="timelineViewContainer" style="display: none;">
        <div class="card mb-3">
          <div class="card-header" style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white;">
            <h3 class="card-title">ðŸ“… Timeline des Switches - <span id="timelineMonth"></span></h3>
          </div>
          <div class="card-body" style="padding: 2rem; background: var(--bg-secondary);">
            <div id="timelineContent" style="position: relative; min-height: 400px;"></div>
          </div>
        </div>
        
        <!-- LÃ©gende -->
        <div class="card mb-3">
          <div class="card-body">
            <div style="display: flex; gap: 2rem; flex-wrap: wrap; justify-content: center; align-items: center;">
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <div style="width: 16px; height: 16px; border-radius: 50%; background: #ef4444;"></div>
                <span style="font-size: 14px;">En retard</span>
              </div>
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <div style="width: 16px; height: 16px; border-radius: 50%; background: #f59e0b;"></div>
                <span style="font-size: 14px;">Aujourd'hui</span>
              </div>
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <div style="width: 16px; height: 16px; border-radius: 50%; background: #3b82f6;"></div>
                <span style="font-size: 14px;">Cette semaine</span>
              </div>
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <div style="width: 16px; height: 16px; border-radius: 50%; background: #10b981;"></div>
                <span style="font-size: 14px;">Ce mois</span>
              </div>
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <div style="width: 16px; height: 16px; border-radius: 50%; background: #6b7280;"></div>
                <span style="font-size: 14px;">EffectuÃ©</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- List View Container (existing cards) -->
      <div id="listViewContainer">
      
      <!-- Switches Ã  venir ce mois -->
      <div class="card mb-3">
        <div class="card-header" style="background: linear-gradient(135deg, var(--warning) 0%, #f59e0b 100%); color: white;">
          <h3 class="card-title">ðŸ“… Switches prÃ©vus ce mois</h3>
          <span class="badge" id="countSwitchesMonth" style="background: white; color: var(--warning);">0</span>
        </div>
        <div class="card-body">
          <div id="switchesMonth"></div>
        </div>
      </div>
      
      <!-- Switches futurs -->
      <div class="card mb-3">
        <div class="card-header" style="background: linear-gradient(135deg, var(--info) 0%, #0891b2 100%); color: white;">
          <h3 class="card-title">â³ Switches futurs</h3>
          <span class="badge" id="countSwitchesFuture" style="background: white; color: var(--info);">0</span>
        </div>
        <div class="card-body">
          <div id="switchesFuture"></div>
        </div>
      </div>
      
      <!-- Switches passÃ©s -->
      <div class="card">
        <div class="card-header" style="background: linear-gradient(135deg, var(--success) 0%, #059669 100%); color: white;">
          <h3 class="card-title">ðŸ”„ Switches effectuÃ©s</h3>
          <span class="badge" id="countSwitchesPast" style="background: white; color: var(--success);">0</span>
        </div>
        <div class="card-body">
          <div id="switchesPast"></div>
        </div>
      </div>
      </div><!-- End List View Container -->
    </section>
    
    <!-- Appointments/Follow-ups View -->
    <section id="appointments" class="view">
      <!-- Dashboard RDV -->
      <div class="kpi-grid mb-3">
        <div class="kpi-card" style="border-left-color: var(--danger);">
          <div class="kpi-icon" style="background: linear-gradient(135deg, var(--danger), #dc2626);">
            <svg width="24" height="24" fill="white" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path></svg>
          </div>
          <div class="kpi-content">
            <div class="kpi-value" id="kpiAppointmentsThisMonth">0</div>
            <div class="kpi-label">RDV ce mois</div>
          </div>
        </div>
        
        <div class="kpi-card" style="border-left-color: var(--warning);">
          <div class="kpi-icon" style="background: linear-gradient(135deg, var(--warning), #f59e0b);">
            <svg width="24" height="24" fill="white" viewBox="0 0 20 20"><path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"></path></svg>
          </div>
          <div class="kpi-content">
            <div class="kpi-value" id="kpiAppointmentsToCall">0</div>
            <div class="kpi-label">Ã€ rappeler</div>
          </div>
        </div>
        
        <div class="kpi-card" style="border-left-color: var(--info);">
          <div class="kpi-icon" style="background: linear-gradient(135deg, var(--info), #0891b2);">
            <svg width="24" height="24" fill="white" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path></svg>
          </div>
          <div class="kpi-content">
            <div class="kpi-value" id="kpiAppointmentsNext30">0</div>
            <div class="kpi-label">30 prochains jours</div>
          </div>
        </div>
        
        <div class="kpi-card" style="border-left-color: var(--success);">
          <div class="kpi-icon" style="background: linear-gradient(135deg, var(--success), #059669);">
            <svg width="24" height="24" fill="white" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
          </div>
          <div class="kpi-content">
            <div class="kpi-value" id="kpiAppointmentsDone">0</div>
            <div class="kpi-label">RÃ©alisÃ©s (total)</div>
          </div>
        </div>
      </div>
      
      <!-- ContrÃ´les -->
      <div class="card mb-3">
        <div class="card-body">
          <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center; justify-content: space-between;">
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
              <button class="btn btn-primary" onclick="openAppointmentModal()">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"></path>
                </svg>
                Planifier un suivi
              </button>
              
              <div style="display: flex; gap: 0.5rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--bg-secondary); border-radius: var(--radius); cursor: pointer;">
                  <input type="radio" name="appointmentFilter" value="all" checked onchange="renderAppointments()">
                  <span>Tous</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--bg-secondary); border-radius: var(--radius); cursor: pointer;">
                  <input type="radio" name="appointmentFilter" value="thisMonth" onchange="renderAppointments()">
                  <span>Ce mois</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--bg-secondary); border-radius: var(--radius); cursor: pointer;">
                  <input type="radio" name="appointmentFilter" value="next30" onchange="renderAppointments()">
                  <span>30 jours</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--bg-secondary); border-radius: var(--radius); cursor: pointer;">
                  <input type="radio" name="appointmentFilter" value="toCall" onchange="renderAppointments()">
                  <span>Ã€ rappeler</span>
                </label>
              </div>
            </div>
            
            <input type="text" class="form-input" id="appointmentSearch" placeholder="ðŸ” Rechercher un patient..." style="max-width: 300px;" oninput="renderAppointments()">
          </div>
        </div>
      </div>
      
      <!-- Liste des RDV -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">ðŸ“… Suivis planifiÃ©s</h3>
        </div>
        <div class="card-body">
          <div id="appointmentsList"></div>
        </div>
      </div>
    </section>
    
    <!-- Catalogs View -->
    <section id="catalogs" class="view">
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1rem;">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">MÃ©decins</h3>
            <span class="badge badge-info" id="countDocs">0</span>
          </div>
          <div class="card-body">
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
              <input type="text" class="form-input" id="newDocInput" placeholder="Nom du mÃ©decin" style="flex: 1;">
              <button class="btn btn-primary" onclick="addDoc()">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"></path>
                </svg>
                Ajouter
              </button>
            </div>
            <div id="docsList"></div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Centres</h3>
            <span class="badge badge-info" id="countCenters">0</span>
          </div>
          <div class="card-body">
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
              <input type="text" class="form-input" id="newCenterInput" placeholder="Nom du centre" style="flex: 1;">
              <button class="btn btn-primary" onclick="addCenter()">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"></path>
                </svg>
                Ajouter
              </button>
            </div>
            <div id="centersList"></div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Protocoles / MatÃ©riels</h3>
            <span class="badge badge-info" id="countProtos">0</span>
          </div>
          <div class="card-body">
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
              <input type="text" class="form-input" id="newProtoInput" placeholder="Nom du protocole" style="flex: 1;">
              <button class="btn btn-primary" onclick="addProto()">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"></path>
                </svg>
                Ajouter
              </button>
            </div>
            <div id="protosList"></div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Report View -->
    <section id="report" class="view">
      <div style="margin-bottom: 1.5rem;">
        <h2 style="color: var(--primary); font-weight: 700; margin-bottom: 0.5rem;">ðŸ“Š Statistiques comparatives</h2>
        <p class="text-muted">Comparaison des indicateurs entre le cycle en cours et le cycle prÃ©cÃ©dent</p>
      </div>

      <!-- SÃ©lecteur de cycles -->
      <div class="card mb-3">
        <div class="card-body">
          <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px;">
              <label class="form-label">Cycle en cours</label>
              <select class="form-input" id="currentCycleSelect">
                <option value="">SÃ©lectionner un cycle...</option>
              </select>
            </div>
            <div style="flex: 1; min-width: 200px;">
              <label class="form-label">Cycle Ã  comparer</label>
              <select class="form-input" id="previousCycleSelect">
                <option value="">SÃ©lectionner un cycle...</option>
              </select>
            </div>
            <button class="btn btn-primary" onclick="compareStatistics()" style="align-self: flex-end;">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11 4a1 1 0 10-2 0v4a1 1 0 102 0V7zm-3 1a1 1 0 10-2 0v3a1 1 0 102 0V8zM8 9a1 1 0 00-2 0v2a1 1 0 102 0V9z" clip-rule="evenodd"></path></svg>
              Comparer
            </button>
          </div>
        </div>
      </div>

      <!-- KPIs comparatifs -->
      <div id="statsComparison" style="display: none;">
        <!-- KPIs Grid -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
          <!-- Patients actifs -->
          <div class="card">
            <div class="card-body">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="color: var(--text-secondary); font-size: 0.9rem;">Patients actifs</span>
                <svg width="24" height="24" fill="currentColor" style="color: var(--primary);" viewBox="0 0 20 20"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"></path></svg>
              </div>
              <div style="display: flex; align-items: baseline; gap: 0.5rem; margin-bottom: 0.5rem;">
                <span id="kpiPatients1" style="font-size: 2rem; font-weight: 700; color: var(--primary);">-</span>
                <span style="color: var(--text-secondary);">â†’</span>
                <span id="kpiPatients2" style="font-size: 2rem; font-weight: 700;">-</span>
              </div>
              <div id="kpiPatientsEvol" class="badge">-</div>
            </div>
          </div>

          <!-- Taux complÃ©tion ordonnances -->
          <div class="card">
            <div class="card-body">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="color: var(--text-secondary); font-size: 0.9rem;">EfficacitÃ© ordonnances</span>
                <svg width="24" height="24" fill="currentColor" style="color: var(--warning);" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"></path></svg>
              </div>
              <div style="display: flex; align-items: baseline; gap: 0.5rem; margin-bottom: 0.5rem;">
                <span id="kpiOrdos1" style="font-size: 2rem; font-weight: 700; color: var(--warning);">-</span>
                <span style="color: var(--text-secondary);">â†’</span>
                <span id="kpiOrdos2" style="font-size: 2rem; font-weight: 700;">-</span>
              </div>
              <div id="kpiOrdosEvol" class="badge">-</div>
            </div>
          </div>

          <!-- Suivis effectuÃ©s -->
          <div class="card">
            <div class="card-body">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="color: var(--text-secondary); font-size: 0.9rem;">Suivis effectuÃ©s</span>
                <svg width="24" height="24" fill="currentColor" style="color: var(--info);" viewBox="0 0 20 20"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path></svg>
              </div>
              <div style="display: flex; align-items: baseline; gap: 0.5rem; margin-bottom: 0.5rem;">
                <span id="kpiSuivis1" style="font-size: 2rem; font-weight: 700; color: var(--info);">-</span>
                <span style="color: var(--text-secondary);">â†’</span>
                <span id="kpiSuivis2" style="font-size: 2rem; font-weight: 700;">-</span>
              </div>
              <div id="kpiSuivisEvol" class="badge">-</div>
            </div>
          </div>

          <!-- Switchs effectuÃ©s -->
          <div class="card">
            <div class="card-body">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="color: var(--text-secondary); font-size: 0.9rem;">Switchs effectuÃ©s</span>
                <svg width="24" height="24" fill="currentColor" style="color: #8b5cf6;" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path></svg>
              </div>
              <div style="display: flex; align-items: baseline; gap: 0.5rem; margin-bottom: 0.5rem;">
                <span id="kpiSwitchs1" style="font-size: 2rem; font-weight: 700; color: #8b5cf6;">-</span>
                <span style="color: var(--text-secondary);">â†’</span>
                <span id="kpiSwitchs2" style="font-size: 2rem; font-weight: 700;">-</span>
              </div>
              <div id="kpiSwitchsEvol" class="badge">-</div>
            </div>
          </div>

          <!-- ArrÃªts temporaires -->
          <div class="card">
            <div class="card-body">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="color: var(--text-secondary); font-size: 0.9rem;">ArrÃªts temporaires</span>
                <svg width="24" height="24" fill="currentColor" style="color: #f59e0b;" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
              </div>
              <div style="display: flex; align-items: baseline; gap: 0.5rem; margin-bottom: 0.5rem;">
                <span id="kpiTempPause1" style="font-size: 2rem; font-weight: 700; color: #f59e0b;">-</span>
                <span style="color: var(--text-secondary);">â†’</span>
                <span id="kpiTempPause2" style="font-size: 2rem; font-weight: 700;">-</span>
              </div>
              <div id="kpiTempPauseEvol" class="badge">-</div>
            </div>
          </div>

          <!-- ArrÃªts dÃ©finitifs -->
          <div class="card">
            <div class="card-body">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="color: var(--text-secondary); font-size: 0.9rem;">ArrÃªts dÃ©finitifs</span>
                <svg width="24" height="24" fill="currentColor" style="color: #ef4444;" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>
              </div>
              <div style="display: flex; align-items: baseline; gap: 0.5rem; margin-bottom: 0.5rem;">
                <span id="kpiPermPause1" style="font-size: 2rem; font-weight: 700; color: #ef4444;">-</span>
                <span style="color: var(--text-secondary);">â†’</span>
                <span id="kpiPermPause2" style="font-size: 2rem; font-weight: 700;">-</span>
              </div>
              <div id="kpiPermPauseEvol" class="badge">-</div>
            </div>
          </div>

          <!-- Score qualitÃ© moyen -->
          <div class="card">
            <div class="card-body">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="color: var(--text-secondary); font-size: 0.9rem;">Score qualitÃ© moyen</span>
                <svg width="24" height="24" fill="currentColor" style="color: var(--success);" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
              </div>
              <div style="display: flex; align-items: baseline; gap: 0.5rem; margin-bottom: 0.5rem;">
                <span id="kpiScore1" style="font-size: 2rem; font-weight: 700; color: var(--success);">-</span>
                <span style="color: var(--text-secondary);">â†’</span>
                <span id="kpiScore2" style="font-size: 2rem; font-weight: 700;">-</span>
              </div>
              <div id="kpiScoreEvol" class="badge">-</div>
            </div>
          </div>
        </div>

        <!-- Graphique comparatif -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">ðŸ“ˆ Ã‰volution des indicateurs</h3>
          </div>
          <div class="card-body">
            <canvas id="comparisonChart" style="max-height: 400px;"></canvas>
          </div>
        </div>
      </div>

      <!-- Message d'attente -->
      <div id="statsWaiting" class="alert alert-info">
        <strong>SÃ©lectionnez deux cycles Ã  comparer</strong><br>
        Choisissez le cycle en cours et un cycle prÃ©cÃ©dent dans les menus dÃ©roulants ci-dessus, puis cliquez sur "Comparer" pour afficher les statistiques.
      </div>
    </section>
    
    <!-- Backup View -->
    <section id="backup" class="view">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Import / Export</h3>
        </div>
        <div class="card-body">
          <div class="form-grid">
            <div>
              <h4 class="mb-2">Export des donnÃ©es</h4>
              <button class="btn btn-primary mb-2" id="btnExportJson">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
                Exporter tout (JSON)
              </button>
              <button class="btn btn-secondary" id="btnExportRefs">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 1 1 0 000 2H6a2 2 0 00-2 2v6h16V7a2 2 0 00-2-2h-1a1 1 0 100-2 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path></svg>
                Exporter rÃ©fÃ©rentiels
              </button>
            </div>
            
            <div>
              <h4 class="mb-2">Import JSON</h4>
              <input type="file" class="form-input" id="fileImport" accept=".json">
              <div class="text-small text-muted mt-1">Remplace toutes les donnÃ©es actuelles</div>
            </div>
            
            <div>
              <h4 class="mb-2">Import CSV Intelligent</h4>
              <button class="btn btn-success" onclick="openCSVImport()">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                Import CSV avancÃ©
              </button>
              <div class="text-small text-muted mt-1">
                â€¢ DÃ©tection automatique du format<br>
                â€¢ AperÃ§u des donnÃ©es<br>
                â€¢ Mapping manuel des colonnes<br>
                â€¢ Support multi-encodage
              </div>
            </div>
          </div>
          
          <!-- Auto-Save System -->
          <hr style="margin: 2rem 0; border: none; border-top: 2px solid var(--border);">
          
          <div>
            <h3 style="margin-bottom: 1rem; color: var(--primary);">
              ðŸ’¾ Sauvegarde automatique
            </h3>
            
            <div class="alert alert-info" style="margin-bottom: 1.5rem;">
              <strong>Protection automatique de vos donnÃ©es</strong><br>
              Configurez une sauvegarde automatique qui met Ã  jour un fichier JSON Ã  chaque modification, sans intervention manuelle.
            </div>
            
            <div class="card" style="background: var(--bg-secondary); margin-bottom: 1rem;">
              <div class="card-body">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                  <div>
                    <strong style="font-size: 1.1rem;">Ã‰tat de la sauvegarde automatique</strong>
                  </div>
                  <div id="autoSaveStatus" style="display: flex; align-items: center; gap: 0.5rem;">
                    <span class="badge badge-secondary">Non configurÃ©e</span>
                  </div>
                </div>
                
                <div id="autoSaveInfo" style="display: none; padding: 1rem; background: var(--bg-primary); border-radius: var(--radius); margin-bottom: 1rem;">
                  <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem 1rem; font-size: 0.9rem;">
                    <strong>ðŸ“ Fichier :</strong>
                    <span id="autoSaveFileName">-</span>
                    
                    <strong>ðŸ• DerniÃ¨re sauvegarde :</strong>
                    <span id="autoSaveLastTime">Jamais</span>
                    
                    <strong>ðŸ“Š Ã‰lÃ©ments sauvegardÃ©s :</strong>
                    <span id="autoSaveCount">-</span>
                  </div>
                </div>
                
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                  <button class="btn btn-primary" id="btnConfigureAutoSave" onclick="configureAutoSave()">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path>
                    </svg>
                    Configurer la sauvegarde
                  </button>
                  
                  <button class="btn btn-success hidden" id="btnEnableAutoSave" onclick="toggleAutoSave(true)">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    Activer
                  </button>
                  
                  <button class="btn btn-warning hidden" id="btnDisableAutoSave" onclick="toggleAutoSave(false)">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M13.477 14.89A6 6 0 015.11 6.524l8.367 8.368zm1.414-1.414L6.524 5.11a6 6 0 018.367 8.367zM18 10a8 8 0 11-16 0 8 8 0 0116 0z" clip-rule="evenodd"></path>
                    </svg>
                    DÃ©sactiver
                  </button>
                  
                  <button class="btn btn-secondary hidden" id="btnSaveNow" onclick="saveNow()">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h5a2 2 0 012 2v7a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2h5v5.586l-1.293-1.293zM9 4a1 1 0 012 0v2H9V4z"></path>
                    </svg>
                    Sauvegarder maintenant
                  </button>
                  
                  <button class="btn btn-info hidden" id="btnRestoreFromAutoSave" onclick="restoreFromAutoSave()">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path>
                    </svg>
                    Restaurer depuis la sauvegarde
                  </button>
                </div>
                
                <div class="alert alert-warning" id="autoSaveFallbackNotice" style="margin-top: 1rem; display: none;">
                  <strong>âš ï¸ Navigateur non supportÃ©</strong><br>
                  Votre navigateur ne supporte pas la sauvegarde automatique dans un fichier unique. Utilisez Chrome ou Edge pour cette fonctionnalitÃ©.
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Debug View -->
    <section id="debug" class="view">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Debug & Maintenance</h3>
        </div>
        <div class="card-body">
          <div class="form-grid">
            <button class="btn btn-secondary" id="btnListKeys">ðŸ“‹ Lister les clÃ©s</button>
            <button class="btn btn-secondary" id="btnSwitchKey">ðŸ”„ Dupliquer la clÃ©</button>
            <button class="btn btn-warning" id="btnMigrateV1">ðŸ“¦ Migrer depuis v1</button>
            <button class="btn btn-danger" id="btnPurgeV1">ðŸ—‘ï¸ Purger v1</button>
          </div>
          <pre id="dbgOut" class="mt-3" style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius-md); font-family: monospace; font-size: 0.875rem;"></pre>
        </div>
      </div>
    </section>
    
    <!-- Update System View -->
    <section id="update" class="view">
      <div class="card mb-3">
        <div class="card-header">
          <h3 class="card-title">ðŸ”„ SystÃ¨me de mise Ã  jour</h3>
        </div>
        <div class="card-body">
          <div class="alert alert-info mb-3">
            <strong>â„¹ï¸ Mise Ã  jour automatique via GitHub</strong><br>
            <strong>MÃ©thode recommandÃ©e :</strong> Configurez l'URL RAW du fichier <code>version.json</code> sur GitHub.<br>
            Exemple : <code>https://raw.githubusercontent.com/username/repo/main/version.json</code><br><br>
            âœ… Avantages : DÃ©tection automatique mÃªme si le nom du fichier change (v1.0 â†’ v2.0)<br>
            âœ… Notes de version incluses<br><br>
            <em>MÃ©thode alternative :</em> URL directe du fichier HTML (nÃ©cessite de reconfigurer si le nom change)
          </div>

          <!-- GitHub Configuration -->
          <div class="mb-4">
            <h4>âš™ï¸ Configuration de mise Ã  jour</h4>
            <div class="form-group">
              <label for="githubRawUrl">URL RAW sur GitHub (version.json recommandÃ©)</label>
              <input type="text" id="githubRawUrl" class="form-control" placeholder="https://raw.githubusercontent.com/..." value="">
              <small class="text-muted">
                Ex: https://raw.githubusercontent.com/maouex/NHC-Patients-Manager/main/version.json<br>
                ðŸ’¡ Pour obtenir l'URL RAW : Ouvrez votre fichier sur GitHub â†’ Cliquez sur "Raw" â†’ Copiez l'URL
              </small>
            </div>
            <div class="form-group mt-2">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" id="autoCheckUpdates" style="cursor: pointer;">
                <span>VÃ©rifier automatiquement les mises Ã  jour au dÃ©marrage</span>
              </label>
            </div>
            <button class="btn btn-primary mt-2" id="btnSaveGithubConfig">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
              </svg>
              Enregistrer la configuration
            </button>
          </div>

          <div class="mb-3">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--bg-tertiary); border-radius: var(--radius-md);">
              <div>
                <div style="font-weight: 600; font-size: 1.1rem;">Version actuelle</div>
                <div class="text-muted" style="font-size: 0.9rem;" id="currentVersion">v1.0</div>
              </div>
              <div style="text-align: right;">
                <div class="text-muted" style="font-size: 0.85rem;">DerniÃ¨re vÃ©rification</div>
                <div id="lastUpdateCheck" style="font-size: 0.9rem;">Jamais</div>
              </div>
            </div>
          </div>
          
          <div class="mb-3" id="updateAvailableNotice" style="display: none;">
            <div class="alert alert-success">
              <strong>âœ¨ Mise Ã  jour disponible !</strong><br>
              Version <span id="availableVersion"></span> prÃªte Ã  Ãªtre installÃ©e.
            </div>
          </div>
          
          <div class="form-grid">
            <button class="btn btn-primary" id="btnCheckUpdate">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path>
              </svg>
              VÃ©rifier les mises Ã  jour
            </button>

            <button class="btn btn-success" id="btnDownloadUpdate" style="display: none;">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
              </svg>
              TÃ©lÃ©charger la mise Ã  jour
            </button>

            <button class="btn btn-primary" id="btnInstallUpdate" style="display: none;">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
              </svg>
              Installer et remplacer le fichier
            </button>
          </div>
          
          <div class="mt-4" id="updateInfo" style="display: none;">
            <h4>ðŸ“‹ Informations sur la mise Ã  jour</h4>
            <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius-md); font-family: monospace; font-size: 0.875rem;" id="updateDetails"></div>
          </div>
          
          <div class="mt-4">
            <h4>ðŸ“œ Historique des mises Ã  jour</h4>
            <div id="updateHistory" style="max-height: 300px; overflow-y: auto;">
              <p class="text-muted">Aucune mise Ã  jour installÃ©e</p>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- About View -->
    <section id="about" class="view">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Ã€ propos de NHC Patients Manager</h3>
        </div>
        <div class="card-body">
          <h4>Version 1.1.0</h4>
          <p class="text-muted mt-2"><strong>ðŸ†• NouveautÃ©s de la version 1.1.0 :</strong></p>
          <ul class="mt-2" style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
            <li>ðŸš€ <strong>SystÃ¨me de mise Ã  jour amÃ©liorÃ©</strong> : Support changement de nom de fichier via version.json</li>
            <li>âœ… DÃ©tection automatique des nouvelles versions mÃªme si le fichier change de nom (v1.0 â†’ v2.0)</li>
            <li>ðŸ“ Affichage des notes de version lors des mises Ã  jour</li>
            <li>ðŸ”§ Filtrage complet des patients archivÃ©s dans toutes les vues (ordonnances, cycles, statistiques)</li>
            <li>ðŸ› Correction : les patients archivÃ©s n'apparaissent plus dans les ordonnances manquantes si archivÃ©s avant la date de renouvellement</li>
          </ul>

          <p class="text-muted mt-3"><strong>FonctionnalitÃ©s principales :</strong></p>
          <ul class="mt-2">
            <li>ðŸ‘¥ Gestion complÃ¨te des patients (actifs, arrÃªts temporaires/dÃ©finitifs)</li>
            <li>ðŸ“‹ Gestion des ordonnances et cycles de renouvellement</li>
            <li>ðŸ”„ Planification et suivi des switchs de pompes</li>
            <li>ðŸ“… Gestion des rendez-vous avec rappels</li>
            <li>ðŸ“Š Tableau de bord avec statistiques en temps rÃ©el</li>
            <li>ðŸ“¥ Import/Export CSV intelligent avec dÃ©tection automatique</li>
            <li>ðŸ“„ Export Excel et PDF groupÃ© par mÃ©decin</li>
            <li>ðŸ“š RÃ©fÃ©rentiels (Protocoles, MÃ©decins, Centres)</li>
            <li>ðŸ” Recherche et filtres avancÃ©s</li>
            <li>ðŸ“œ Historique des modifications patients</li>
            <li>ðŸ”„ SystÃ¨me de mise Ã  jour automatique via GitHub</li>
            <li>ðŸŒ™ Mode sombre/clair</li>
            <li>ðŸ’¾ Sauvegarde automatique locale avec backup</li>
            <li>ðŸ“± Compatible mobile/tablette/desktop</li>
          </ul>
          <p class="text-muted mt-3">Â© 2024 NHC Patients Manager - Tous droits rÃ©servÃ©s</p>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Patient Modal -->
<div class="modal" id="patientModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="modalTitle">Nouveau patient</h2>
      <button class="modal-close" id="closePatient">&times;</button>
    </div>
    
    <div class="modal-body">
      <form id="patientForm" class="form-grid">
        <div class="form-group">
          <label class="form-label">Nom *</label>
          <input type="text" class="form-input" id="lastName" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">PrÃ©nom *</label>
          <input type="text" class="form-input" id="firstName" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">Date de naissance</label>
          <input type="date" class="form-input" id="dob">
        </div>
        
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" class="form-input" id="email">
        </div>
        
        <div class="form-group">
          <label class="form-label">TÃ©lÃ©phone</label>
          <input type="tel" class="form-input" id="phone">
        </div>
        
        <div class="form-group">
          <label class="form-label">Adresse</label>
          <input type="text" class="form-input" id="address" placeholder="Ex: 123 Rue de la Paix, 75001 Paris">
        </div>
        
        <div class="form-group">
          <label class="form-label">Code Patient</label>
          <input type="text" class="form-input" id="patientCode" placeholder="Ex: 12345">
          <div class="text-small text-muted mt-1">Code utilisÃ© pour les ordonnances en ligne</div>
        </div>
        
        <div class="form-group">
          <label class="form-label">MÃ©decin</label>
          <select class="form-select" id="docId">
            <option value="">-- SÃ©lectionner --</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Centre</label>
          <select class="form-select" id="centerId">
            <option value="">-- SÃ©lectionner --</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Protocole</label>
          <select class="form-select" id="protoId">
            <option value="">-- SÃ©lectionner --</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Date de renouvellement d'ordonnance</label>
          <div style="display: flex; gap: 0.5rem;">
            <input type="text" class="form-input" id="renewalDate" placeholder="JJ/MM/AAAA" pattern="\d{2}/\d{2}/\d{4}">
            <button type="button" class="btn btn-secondary" onclick="suggestRenewalDate()" title="SuggÃ©rer la prochaine date">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path></svg>
            </button>
          </div>
          <div class="text-small text-muted mt-1" id="cycleInfo">
            Le cycle sera calculÃ© automatiquement selon la date
          </div>
        </div>
        
        <div class="form-group" style="grid-column: span 2;">
          <label class="form-label">Notes</label>
          <textarea class="form-textarea" id="notes"></textarea>
        </div>
      </form>
    </div>
    
    <div class="modal-footer">
      <button class="btn btn-warning hidden" id="btnChangeStatus" style="background: #f59e0b; margin-right: auto;">
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path></svg>
        Changer statut
      </button>
      <button class="btn btn-danger hidden" id="btnDeletePatient">Supprimer</button>
      <button class="btn btn-secondary" onclick="document.getElementById('patientModal').classList.remove('active')">Annuler</button>
      <button class="btn btn-primary" id="btnSavePatient">Enregistrer</button>
    </div>
  </div>
</div>

<!-- Fast Check Modal -->
<div class="modal" id="fastModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">âš¡ Fast Check - VÃ©rification rapide</h2>
      <button class="modal-close" id="fcClose">&times;</button>
    </div>
    
    <div class="modal-body">
      <div class="text-center">
        <div style="display: flex; align-items: center; justify-content: center; gap: 0.75rem; margin-bottom: 1rem;">
          <h3 id="fcPatient" style="color: var(--primary); margin: 0;">-</h3>
          <button class="btn btn-secondary btn-sm" id="fcCopy" title="Copier le nom dans le presse-papier">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
              <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"></path>
              <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"></path>
            </svg>
            Copier
          </button>
        </div>
        
        <!-- Code Patient Section -->
        <div style="margin-bottom: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: var(--radius); border: 1px solid var(--border);">
          <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-bottom: 0.5rem;">
            <span class="text-muted" style="font-size: 0.9rem;">Code Patient:</span>
            <span id="fcCodeDisplay" style="font-weight: 600; color: var(--primary); font-size: 1.1rem;">-</span>
          </div>
          <div id="fcCodeInputContainer" style="display: none; margin-top: 0.5rem;">
            <input type="text" class="form-input" id="fcCodeInput" placeholder="Saisir le code patient" style="text-align: center; max-width: 200px; margin: 0 auto;">
          </div>
          <div style="display: flex; gap: 0.5rem; justify-content: center; margin-top: 0.75rem;">
            <button class="btn btn-primary btn-sm" id="fcOrdonnance" disabled>
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
              </svg>
              Ordonnance
            </button>
            <button class="btn btn-secondary btn-sm" id="fcEditCode" title="Modifier le code patient">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path>
              </svg>
              Modifier code
            </button>
            <button class="btn btn-success btn-sm hidden" id="fcSaveCode">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
              </svg>
              Enregistrer
            </button>
          </div>
        </div>
        
        <p class="text-muted mb-2">Ordonnance actuelle :</p>
        <div style="display: flex; justify-content: center; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
          <input type="text" class="form-input" id="fcOrdo" style="width: 200px; text-align: center; font-size: 1.1rem;">
          <span id="fcCycle" class="badge badge-info" style="padding: 0.5rem 1rem;">-</span>
        </div>
        <p class="text-small text-muted">Patient <span id="fcIndex">0</span> sur <span id="fcTotal">0</span></p>
        <div class="progress mt-2" style="height: 10px;">
          <div class="progress-bar" id="fcProgress" style="background: linear-gradient(90deg, var(--primary), var(--secondary)); width: 0%;"></div>
        </div>
      </div>
    </div>
    
    <div class="modal-footer" style="justify-content: space-between;">
      <button class="btn btn-secondary" id="fcPrev">â† PrÃ©cÃ©dent</button>
      <div class="flex gap-1">
        <button class="btn btn-secondary" id="fcSkip">Passer â†’</button>
        <button class="btn btn-warning" id="fcCorrect">Corriger</button>
        <button class="btn btn-success hidden" id="fcUpdate">Valider</button>
      </div>
    </div>
  </div>
</div>

<!-- Patient Details Modal -->
<div class="modal" id="patientDetailsModal">
  <div class="modal-content" style="max-width: 800px;">
    <div class="modal-header">
      <h2 class="modal-title">ðŸ‘¤ DÃ©tails du patient</h2>
      <button class="modal-close" onclick="showModal(false, 'patientDetailsModal')">&times;</button>
    </div>
    
    <div class="modal-body">
      <div id="patientDetailsContent" class="patient-details-card">
        <!-- Contenu gÃ©nÃ©rÃ© dynamiquement -->
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="showModal(false, 'patientDetailsModal')">Fermer</button>
      <button class="btn btn-primary" id="btnEditFromDetails">
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
          <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path>
        </svg>
        Modifier
      </button>
    </div>
  </div>
</div>

<!-- Appointment Modal -->
<div class="modal" id="appointmentModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="appointmentModalTitle">Planifier un suivi</h2>
      <button class="modal-close" onclick="showModal(false, 'appointmentModal')">&times;</button>
    </div>
    
    <div class="modal-body">
      <form id="appointmentForm" class="form-grid">
        <div class="form-group" style="grid-column: span 2;">
          <label class="form-label">Patient *</label>
          <select class="form-select" id="appointmentPatientId" required>
            <option value="">-- SÃ©lectionner un patient --</option>
          </select>
        </div>
        
        <div class="form-group" style="grid-column: span 2;">
          <label class="form-label">Type d'Ã©chÃ©ance *</label>
          <div style="display: flex; gap: 1rem;">
            <label style="display: flex; align-items: center; gap: 0.5rem;">
              <input type="radio" name="appointmentType" value="date" checked onchange="toggleAppointmentType()">
              <span>ðŸ“… Date exacte</span>
            </label>
            <label style="display: flex; align-items: center; gap: 0.5rem;">
              <input type="radio" name="appointmentType" value="month" onchange="toggleAppointmentType()">
              <span>ðŸ“† Mois (Ã  prÃ©ciser)</span>
            </label>
          </div>
        </div>
        
        <div class="form-group" id="appointmentDateGroup">
          <label class="form-label">Date du RDV *</label>
          <input type="text" class="form-input" id="appointmentDate" placeholder="JJ/MM/AAAA" pattern="\d{2}/\d{2}/\d{4}">
        </div>
        
        <div class="form-group hidden" id="appointmentMonthGroup">
          <label class="form-label">Mois *</label>
          <input type="text" class="form-input" id="appointmentMonth" placeholder="MM/AAAA" pattern="\d{2}/\d{4}">
        </div>
        
        <div class="form-group" style="grid-column: span 2;">
          <label class="form-label">Notes</label>
          <textarea class="form-input" id="appointmentNotes" rows="3" placeholder="Motif du suivi, remarques..."></textarea>
        </div>
      </form>
    </div>
    
    <div class="modal-footer">
      <button class="btn btn-danger hidden" id="btnDeleteAppointment" onclick="deleteAppointment()">Supprimer</button>
      <button class="btn btn-secondary" onclick="showModal(false, 'appointmentModal')">Annuler</button>
      <button class="btn btn-primary" onclick="saveAppointment()">Enregistrer</button>
    </div>
  </div>
</div>

<!-- Complete Appointment Modal -->
<div class="modal" id="completeAppointmentModal">
  <div class="modal-content">
    <div class="modal-header" style="background: linear-gradient(135deg, var(--success), #059669); color: white;">
      <h2 class="modal-title">âœ… Marquer comme rÃ©alisÃ©</h2>
      <button class="modal-close" onclick="showModal(false, 'completeAppointmentModal')" style="color: white;">&times;</button>
    </div>
    
    <div class="modal-body">
      <div class="alert alert-success" style="margin-bottom: 1.5rem;">
        <strong id="completePatientName"></strong><br>
        RDV prÃ©vu : <span id="completeAppointmentInfo"></span>
      </div>
      
      <form class="form-grid">
        <div class="form-group" style="grid-column: span 2;">
          <label class="form-label">Notes sur ce suivi</label>
          <textarea class="form-input" id="completeNotes" rows="2" placeholder="Compte-rendu, observations..."></textarea>
        </div>
        
        <div class="form-group" style="grid-column: span 2;">
          <hr style="margin: 1rem 0;">
          <h4 style="margin-bottom: 1rem; color: var(--primary);">ðŸ“… Planifier le prochain suivi</h4>
        </div>
        
        <div class="form-group" style="grid-column: span 2;">
          <label class="form-label">Type d'Ã©chÃ©ance *</label>
          <div style="display: flex; gap: 1rem;">
            <label style="display: flex; align-items: center; gap: 0.5rem;">
              <input type="radio" name="nextAppointmentType" value="date" checked onchange="toggleNextAppointmentType()">
              <span>ðŸ“… Date exacte</span>
            </label>
            <label style="display: flex; align-items: center; gap: 0.5rem;">
              <input type="radio" name="nextAppointmentType" value="month" onchange="toggleNextAppointmentType()">
              <span>ðŸ“† Mois</span>
            </label>
          </div>
        </div>
        
        <div class="form-group" id="nextAppointmentDateGroup">
          <label class="form-label">Date du prochain RDV *</label>
          <input type="text" class="form-input" id="nextAppointmentDate" placeholder="JJ/MM/AAAA" pattern="\d{2}/\d{2}/\d{4}">
        </div>
        
        <div class="form-group hidden" id="nextAppointmentMonthGroup">
          <label class="form-label">Mois *</label>
          <input type="text" class="form-input" id="nextAppointmentMonth" placeholder="MM/AAAA" pattern="\d{2}/\d{4}">
        </div>
        
        <div class="form-group" style="grid-column: span 2;">
          <label class="form-label">Notes pour le prochain suivi</label>
          <textarea class="form-input" id="nextAppointmentNotes" rows="2"></textarea>
        </div>
      </form>
    </div>
    
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="showModal(false, 'completeAppointmentModal')">Annuler</button>
      <button class="btn btn-success" onclick="confirmCompleteAppointment()">
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
        </svg>
        Valider et planifier le suivant
      </button>
    </div>
  </div>
</div>

<!-- Switch Modal -->
<div class="modal" id="switchModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="switchModalTitle">Nouveau Switch de Pompe</h2>
      <button class="modal-close" onclick="showModal(false, 'switchModal')">&times;</button>
    </div>
    
    <div class="modal-body">
      <form id="switchForm" class="form-grid">
        <div class="form-group" style="grid-column: span 2;">
          <label class="form-label">Patient *</label>
          <select class="form-select" id="switchPatientId" required>
            <option value="">-- SÃ©lectionner un patient --</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Ancien protocole</label>
          <input type="text" class="form-input" id="switchOldProto" readonly style="background: var(--bg-tertiary);">
        </div>
        
        <div class="form-group">
          <label class="form-label">Nouveau protocole *</label>
          <select class="form-select" id="switchNewProtoId" required>
            <option value="">-- SÃ©lectionner --</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Date prÃ©vue du switch *</label>
          <input type="text" class="form-input" id="switchDate" placeholder="JJ/MM/AAAA" pattern="\d{2}/\d{2}/\d{4}" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">Statut</label>
          <select class="form-select" id="switchStatus">
            <option value="planned">ðŸ“… PrÃ©vu</option>
            <option value="completed">âœ… EffectuÃ©</option>
          </select>
        </div>
        
        <div class="form-group" style="grid-column: span 2;">
          <label class="form-label">Notes</label>
          <textarea class="form-input" id="switchNotes" rows="3"></textarea>
        </div>
      </form>
    </div>
    
    <div class="modal-footer">
      <button class="btn btn-danger hidden" id="btnDeleteSwitch" onclick="deleteSwitch()">Supprimer</button>
      <button class="btn btn-secondary" onclick="showModal(false, 'switchModal')">Annuler</button>
      <button class="btn btn-primary" onclick="saveSwitch()">Enregistrer</button>
    </div>
  </div>
</div>

<!-- Validate Switch Modal (with prescription question) -->
<div class="modal" id="validateSwitchModal">
  <div class="modal-content" style="max-width: 600px;">
    <div class="modal-header">
      <h2 class="modal-title">âœ… Valider le Switch</h2>
      <button class="modal-close" onclick="showModal(false, 'validateSwitchModal')">&times;</button>
    </div>
    
    <div class="modal-body">
      <div style="margin-bottom: 20px; padding: 15px; background: var(--bg-tertiary); border-radius: var(--radius-md); border-left: 4px solid var(--info);">
        <p style="margin-bottom: 10px; font-weight: 600;">ðŸ“‹ Informations du switch</p>
        <p id="validateSwitchInfo" style="color: var(--text-secondary);"></p>
      </div>
      
      <div style="margin-bottom: 20px; padding: 20px; background: var(--bg-secondary); border-radius: var(--radius-md); border: 2px solid var(--border);">
        <p style="margin-bottom: 15px; font-weight: 600; font-size: 16px;">ðŸ“ Ordonnance initiale</p>
        <p style="margin-bottom: 15px; color: var(--text-secondary);">Une ordonnance initiale a-t-elle Ã©tÃ© effectuÃ©e pour ce switch ?</p>
        
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
          <button class="btn btn-secondary" onclick="selectPrescriptionOption('yes')" id="btnPrescYes" style="flex: 1;">
            âœ… Oui
          </button>
          <button class="btn btn-secondary" onclick="selectPrescriptionOption('no')" id="btnPrescNo" style="flex: 1;">
            âŒ Non
          </button>
        </div>
        
        <div id="prescriptionDateInput" style="display: none;">
          <label class="form-label">Date de renouvellement de l'ordonnance *</label>
          <input type="text" class="form-input" id="prescriptionRenewalDate" placeholder="JJ/MM/AAAA" pattern="\d{2}/\d{2}/\d{4}">
          <div class="text-small text-muted mt-1">ðŸ“… Date de la prochaine ordonnance de renouvellement</div>
        </div>
        
        <div id="prescriptionNoInfo" style="display: none; padding: 10px; background: rgba(245, 158, 11, 0.1); border-radius: var(--radius); border-left: 3px solid var(--warning); margin-top: 10px;">
          <p style="color: var(--warning); font-size: 14px; margin: 0;">
            â„¹ï¸ La date de renouvellement sera dÃ©finie Ã  la date du switch.
          </p>
        </div>
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="showModal(false, 'validateSwitchModal')">Annuler</button>
      <button class="btn btn-success" id="btnConfirmValidateSwitch" onclick="confirmValidateSwitch()" disabled>
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
        Valider le Switch
      </button>
    </div>
  </div>
</div>

<!-- CSV Import Modal -->
<div class="modal" id="csvImportModal">
  <div class="modal-content" style="max-width: 1400px;">
    <div class="modal-header">
      <h2 class="modal-title">ðŸ“Š Import CSV AvancÃ© - Mapping Intelligent</h2>
      <button class="modal-close" onclick="showModal(false, 'csvImportModal')">&times;</button>
    </div>
    
    <div class="modal-body" style="max-height: 80vh; overflow-y: auto;">
      <!-- Drop Zone -->
      <div class="drop-zone" id="dropZone" style="border: 3px dashed var(--primary); border-radius: 12px; padding: 60px; text-align: center; background: var(--bg-tertiary); cursor: pointer; transition: all 0.3s; margin-bottom: 30px;">
        <div class="drop-zone-icon" style="font-size: 48px; margin-bottom: 15px;">ðŸ“</div>
        <div class="drop-zone-text" style="font-size: 18px; margin-bottom: 10px;">Glissez-dÃ©posez votre fichier ici</div>
        <div class="drop-zone-hint" style="color: var(--text-muted); font-size: 14px;">ou cliquez pour sÃ©lectionner (CSV, Excel, TSV, TXT)</div>
        <input type="file" id="csvFileInputAdv" accept=".csv,.tsv,.txt,.xlsx,.xls" style="display: none;">
      </div>
      
      <!-- File Info -->
      <div class="file-info" id="csvFileInfo" style="display: none; background: #e8f5e9; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #27ae60;">
        <h3 style="margin-bottom: 15px; color: #27ae60;">ðŸ“„ Informations du fichier</h3>
        <div id="csvFileInfoContent" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;"></div>
      </div>
      
      <!-- Options Panel -->
      <div class="options-panel" id="csvOptionsPanel" style="display: none; background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #f39c12;">
        <div style="margin: 10px 0; display: flex; align-items: center; gap: 10px;">
          <input type="checkbox" id="csvHasHeaders" checked style="width: 18px; height: 18px; cursor: pointer;">
          <label for="csvHasHeaders" style="cursor: pointer;">La premiÃ¨re ligne contient les en-tÃªtes</label>
        </div>
        <div style="margin: 10px 0; display: flex; align-items: center; gap: 10px;">
          <input type="checkbox" id="csvAutoDetect" checked style="width: 18px; height: 18px; cursor: pointer;">
          <label for="csvAutoDetect" style="cursor: pointer;">DÃ©tection automatique des colonnes</label>
        </div>
      </div>
      
      <!-- Alert Box -->
      <div id="csvAlertBox" style="display: none; padding: 15px; border-radius: 8px; margin-bottom: 20px;"></div>
      
      <!-- Preview Container -->
      <div class="preview-container" id="csvPreviewContainer" style="display: none;">
        <div class="preview-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2>ðŸ“‹ Mapping des colonnes</h2>
          <div class="stats" style="display: flex; gap: 20px;">
            <div style="text-align: center;">
              <div id="csvColCount" style="font-size: 24px; font-weight: 700; color: var(--primary);">0</div>
              <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase;">Colonnes</div>
            </div>
            <div style="text-align: center;">
              <div id="csvRowCountStat" style="font-size: 24px; font-weight: 700; color: var(--primary);">0</div>
              <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase;">Lignes</div>
            </div>
            <div style="text-align: center;">
              <div id="csvMappedCount" style="font-size: 24px; font-weight: 700; color: var(--success);">0</div>
              <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase;">MappÃ©es</div>
            </div>
          </div>
        </div>
        
        <!-- Mapping Table -->
        <div style="overflow-x: auto; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 20px;">
          <table id="csvMappingTable" style="width: 100%; border-collapse: separate; border-spacing: 0; min-width: 800px;"></table>
        </div>
        
        <!-- Actions -->
        <div class="modal-footer" style="display: flex; gap: 15px; justify-content: space-between; align-items: center;">
          <div style="display: flex; gap: 10px;">
            <button class="btn btn-secondary" onclick="csvRedetect()">ðŸ”„ Re-dÃ©tecter</button>
            <button class="btn btn-secondary" onclick="csvClearMapping()">ðŸ—‘ï¸ Effacer mapping</button>
          </div>
          <div style="display: flex; gap: 10px;">
            <button class="btn btn-secondary" onclick="csvReset()">Annuler</button>
            <button class="btn btn-success" id="csvBtnImport" onclick="csvExecuteImport()" disabled>
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
              Importer les donnÃ©es
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<script>
// ===== NOUVEAU SYSTÃˆME AUTO-UPDATE - IndexedDB + IntÃ©gritÃ© =====
(async function() {
  'use strict';

  const DB_NAME = 'NHC_UpdateManager';
  const DB_VERSION = 1;
  const STORE_NAME = 'updates';
  const UPDATE_MARKER_KEY = 'nhc-active-update-version';

  console.log('ðŸš€ AUTO-UPDATE: DÃ©marrage du systÃ¨me de mise Ã  jour...');

  // Fonction pour ouvrir IndexedDB
  function openUpdateDB() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open(DB_NAME, DB_VERSION);

      request.onerror = () => {
        console.error('âŒ Erreur ouverture IndexedDB:', request.error);
        reject(request.error);
      };

      request.onsuccess = () => {
        console.log('âœ… IndexedDB ouvert avec succÃ¨s');
        resolve(request.result);
      };

      request.onupgradeneeded = (event) => {
        console.log('ðŸ”§ CrÃ©ation/mise Ã  jour du schÃ©ma IndexedDB...');
        const db = event.target.result;

        // CrÃ©er le store si nÃ©cessaire
        if (!db.objectStoreNames.contains(STORE_NAME)) {
          const objectStore = db.createObjectStore(STORE_NAME, { keyPath: 'version' });
          objectStore.createIndex('installedAt', 'installedAt', { unique: false });
          objectStore.createIndex('active', 'active', { unique: false });
          console.log('âœ… Object store crÃ©Ã©');
        }
      };
    });
  }

  // Fonction pour rÃ©cupÃ©rer la mise Ã  jour active
  function getActiveUpdate(db) {
    return new Promise((resolve, reject) => {
      const transaction = db.transaction([STORE_NAME], 'readonly');
      const objectStore = transaction.objectStore(STORE_NAME);
      const index = objectStore.index('active');
      const request = index.get(true);

      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
  }

  // Extraire la version du fichier actuel
  const currentVersion = document.title.match(/v?(\d+\.\d+\.\d+)/);
  const fileVersion = currentVersion ? currentVersion[1] : '0.0.0';

  console.log(`ðŸ“„ Version du fichier actuel: ${fileVersion}`);

  try {
    // Ouvrir IndexedDB
    const db = await openUpdateDB();

    // VÃ©rifier s'il y a une mise Ã  jour active
    const activeUpdate = await getActiveUpdate(db);

    if (activeUpdate && activeUpdate.htmlContent) {
      console.log(`ðŸ” Mise Ã  jour active trouvÃ©e: v${activeUpdate.version}`);

      // VÃ©rifier si la version de la mise Ã  jour est diffÃ©rente du fichier
      if (activeUpdate.version !== fileVersion) {
        console.log(`ðŸ”„ Application de la mise Ã  jour v${activeUpdate.version} (fichier: v${fileVersion})`);

        // VÃ©rifier l'intÃ©gritÃ© si un checksum est disponible
        if (activeUpdate.checksum) {
          console.log('ðŸ” VÃ©rification de l\'intÃ©gritÃ©...');
          const hash = await crypto.subtle.digest(
            'SHA-256',
            new TextEncoder().encode(activeUpdate.htmlContent)
          );
          const hashHex = Array.from(new Uint8Array(hash))
            .map(b => b.toString(16).padStart(2, '0'))
            .join('');

          if (hashHex !== activeUpdate.checksum) {
            console.error('âŒ CORRUPTION DÃ‰TECTÃ‰E ! Checksum invalide.');
            console.error(`   Attendu: ${activeUpdate.checksum}`);
            console.error(`   ReÃ§u:    ${hashHex}`);

            // DÃ©sactiver cette mise Ã  jour corrompue
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const objectStore = transaction.objectStore(STORE_NAME);
            activeUpdate.active = false;
            activeUpdate.corruptedAt = new Date().toISOString();
            objectStore.put(activeUpdate);

            showCriticalError('Mise Ã  jour corrompue dÃ©tectÃ©e et dÃ©sactivÃ©e. Le fichier original sera utilisÃ©.');
            db.close();
            return;
          }

          console.log('âœ… IntÃ©gritÃ© vÃ©rifiÃ©e');
        }

        // Appliquer la mise Ã  jour en remplaÃ§ant le document
        console.log('âœ… Application de la mise Ã  jour...');

        // Utiliser document.write pour remplacer complÃ¨tement le contenu
        // C'est la SEULE mÃ©thode qui fonctionne de maniÃ¨re persistante
        document.open();
        document.write(activeUpdate.htmlContent);
        document.close();

        db.close();
        return; // Stop execution
      } else {
        console.log('â„¹ï¸ Version de la mise Ã  jour identique au fichier, pas de remplacement nÃ©cessaire');
      }
    } else {
      console.log('â„¹ï¸ Aucune mise Ã  jour active, chargement du fichier original');
    }

    db.close();

  } catch (error) {
    console.error('âŒ Erreur dans le systÃ¨me AUTO-UPDATE:', error);
    console.log('âš ï¸ Chargement du fichier original...');
    // Continue avec le fichier original en cas d'erreur
  }

  function showCriticalError(message) {
    // Afficher une alerte critique au dÃ©marrage
    setTimeout(() => {
      if (window.showToast) {
        showToast('âš ï¸ ' + message, 'error');
      } else {
        alert('âš ï¸ ' + message);
      }
    }, 1000);
  }

})();

// ===== MAIN APPLICATION CODE =====
(function() {
'use strict';

// ===== Configuration =====
const DB_KEY = 'nhc-care-v4';
const LEGACY_KEY = 'nhc-care-v1';

// ===== State Management =====
let state = {
  patients: [],
  docs: [],
  centers: [],
  protos: [],
  switches: [],
  appointments: []
};

let currentPatientId = null;
let currentSwitchId = null;
let currentAppointmentId = null;
let fcState = { list: [], index: 0 };

// ===== Database Functions =====
function loadDB() {
  try {
    const stored = localStorage.getItem(DB_KEY);
    if (stored) {
      const parsed = JSON.parse(stored);
      state = { ...state, ...parsed };
    }

    // Migration from old versions
    if (!stored) {
      const oldKeys = ['nhc-care-v1', 'nhc-care-v2', 'nhc-care-v3'];
      for (const key of oldKeys) {
        const oldData = localStorage.getItem(key);
        if (oldData) {
          const parsed = JSON.parse(oldData);
          state = { ...state, ...parsed };
          saveDB();
          showToast(`Migration depuis ${key} rÃ©ussie`, 'success');
          break;
        }
      }
    }

    // Ensure history array exists for all patients (backward compatibility)
    let historyFixed = 0;
    state.patients.forEach(patient => {
      if (!patient.history) {
        patient.history = [{
          date: patient.createdAt || Date.now(),
          type: 'created',
          field: 'CrÃ©ation',
          oldValue: '',
          newValue: 'Patient importÃ© (historique initialisÃ©)'
        }];
        historyFixed++;
      }
    });

    // Ensure history array exists for all appointments (backward compatibility)
    state.appointments.forEach(apt => {
      if (!apt.history) {
        apt.history = [];
      }
    });

    // Save if any fixes were made
    if (historyFixed > 0) {
      console.log(`âœ… Historique initialisÃ© pour ${historyFixed} patient(s)`);
      saveDB();
    }

    // Initialize demo data if empty
    if (state.patients.length === 0 && state.docs.length === 0) {
      initDemoData();
    }

    // Log data integrity check
    const patientHistoryCount = state.patients.reduce((total, p) => total + (p.history?.length || 0), 0);
    const appointmentHistoryCount = state.appointments.reduce((total, a) => total + (a.history?.length || 0), 0);
    console.log('ðŸ“Š Data loaded:', {
      patients: state.patients.length,
      docs: state.docs.length,
      centers: state.centers.length,
      protos: state.protos.length,
      switches: state.switches.length,
      appointments: state.appointments.length,
      patientHistoryEvents: patientHistoryCount,
      appointmentHistoryEvents: appointmentHistoryCount,
      totalHistoryEvents: patientHistoryCount + appointmentHistoryCount
    });

  } catch (error) {
    console.error('Erreur chargement DB:', error);
    showToast('Erreur de chargement des donnÃ©es', 'error');
  }
}

function saveDB() {
  try {
    const dataStr = JSON.stringify(state);
    const dataSize = new Blob([dataStr]).size;
    const dataSizeMB = (dataSize / (1024 * 1024)).toFixed(2);

    // Check approximate localStorage usage (typical limit is 5-10MB)
    if (dataSize > 4 * 1024 * 1024) { // 4MB warning threshold
      console.warn(`Taille des donnÃ©es importante: ${dataSizeMB}MB`);
    }

    localStorage.setItem(DB_KEY, dataStr);

    // Trigger auto-save if enabled (function defined later)
    if (typeof triggerAutoSave === 'function') {
      triggerAutoSave();
    }
  } catch (error) {
    console.error('Erreur sauvegarde DB:', error);

    // Check if it's a quota exceeded error
    if (error.name === 'QuotaExceededError' || error.code === 22) {
      showToast('âš ï¸ Espace de stockage insuffisant ! Exportez vos donnÃ©es et supprimez les anciens patients archivÃ©s.', 'error');
    } else {
      showToast('Erreur de sauvegarde: ' + (error.message || 'Erreur inconnue'), 'error');
    }
  }
}

function initDemoData() {
  state.docs = [
    { id: generateId(), name: 'Dr. Martin' },
    { id: generateId(), name: 'Dr. Dubois' },
    { id: generateId(), name: 'Dr. Bernard' }
  ];
  
  state.centers = [
    { id: generateId(), name: 'Centre Paris Nord' },
    { id: generateId(), name: 'Centre Lyon Sud' },
    { id: generateId(), name: 'Centre Marseille Est' }
  ];
  
  state.protos = [
    { id: generateId(), name: 'Protocole Standard' },
    { id: generateId(), name: 'Protocole Intensif' },
    { id: generateId(), name: 'Protocole AllÃ©gÃ©' }
  ];
  
  saveDB();
}

// ===== Utility Functions =====
function generateId() {
  return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

function byId(id) {
  return document.getElementById(id);
}

function qsEl(selector) {
  return document.querySelector(selector);
}

function showToast(message, type = 'info') {
  const container = byId('toastContainer');
  const toast = document.createElement('div');
  toast.className = `toast ${type} fade-in`;
  toast.innerHTML = `
    ${type === 'success' ? '<svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>' : ''}
    ${type === 'error' ? '<svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>' : ''}
    <span>${message}</span>
  `;
  
  container.appendChild(toast);
  
  setTimeout(() => {
    toast.style.opacity = '0';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

function showModal(show, modalId = 'patientModal') {
  const modal = byId(modalId);
  if (show) {
    modal.classList.add('active');
  } else {
    modal.classList.remove('active');
  }
}

// ===== Patient Functions =====
function fullName(patient) {
  return `${patient.lastName || ''} ${patient.firstName || ''}`.trim();
}

function docName(docId) {
  const doc = state.docs.find(d => d.id === docId);
  return doc ? doc.name : '';
}

function centerName(centerId) {
  const center = state.centers.find(c => c.id === centerId);
  return center ? center.name : '';
}

function protoName(protoId) {
  const proto = state.protos.find(p => p.id === protoId);
  return proto ? proto.name : '';
}

function qScore(patient) {
  let score = 0;
  if (patient.lastName && patient.firstName) score += 30;
  if (patient.dob) score += 15;
  if (patient.email || patient.phone) score += 10;
  if (patient.address) score += 5;
  if (patient.docId) score += 15;
  if (patient.centerId) score += 10;
  if (patient.protoId) score += 10;
  if (patient.ordo) score += 5;
  return Math.min(100, score);
}

// ===== Cycle Management System =====
const CYCLES = {
  1: { name: 'Cycle 1', months: [1, 2, 3, 4], label: 'Janvier - Avril', color: 'var(--info)' },
  2: { name: 'Cycle 2', months: [5, 6, 7, 8], label: 'Mai - AoÃ»t', color: 'var(--success)' },
  3: { name: 'Cycle 3', months: [9, 10, 11, 12], label: 'Septembre - DÃ©cembre', color: 'var(--warning)' }
};

function getCurrentCycle() {
  const month = new Date().getMonth() + 1;
  const year = new Date().getFullYear();
  
  for (const [cycleNum, cycleInfo] of Object.entries(CYCLES)) {
    if (cycleInfo.months.includes(month)) {
      return { cycle: parseInt(cycleNum), year, ...cycleInfo };
    }
  }
  return null;
}

function getCycleFromDate(dateStr) {
  if (!dateStr) return null;
  
  let date;
  // Support multiple date formats
  if (dateStr.includes('/')) {
    const parts = dateStr.split('/');
    if (parts.length === 3) {
      date = new Date(parts[2], parts[1] - 1, parts[0]);
    }
  } else if (dateStr.includes('-')) {
    date = new Date(dateStr);
  } else {
    return null;
  }
  
  if (isNaN(date)) return null;
  
  const month = date.getMonth() + 1;
  const year = date.getFullYear();
  
  for (const [cycleNum, cycleInfo] of Object.entries(CYCLES)) {
    if (cycleInfo.months.includes(month)) {
      const cycle = parseInt(cycleNum);
      return { 
        id: `C${cycle}-${year}`,
        cycle: cycle, 
        year: year, 
        ...cycleInfo, 
        date: date 
      };
    }
  }
  return null;
}

function getCycleInfo(cycleNum, year) {
  const cycle = CYCLES[cycleNum];
  if (!cycle) return null;
  
  const startMonth = cycle.months[0] - 1;
  const endMonth = cycle.months[cycle.months.length - 1] - 1;
  const startDate = new Date(year, startMonth, 1);
  const endDate = new Date(year, endMonth + 1, 0);
  
  return {
    cycle: cycleNum,
    year,
    ...cycle,
    startDate,
    endDate,
    label: `${cycle.label} ${year}`
  };
}

function formatDateFR(date) {
  if (!date) return '';
  const d = new Date(date);
  if (isNaN(d)) return '';
  const day = String(d.getDate()).padStart(2, '0');
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const year = d.getFullYear();
  return `${day}/${month}/${year}`;
}

function parseDateFR(dateStr) {
  if (!dateStr) return null;
  const parts = dateStr.split('/');
  if (parts.length !== 3) return null;
  const date = new Date(parts[2], parts[1] - 1, parts[0]);
  return isNaN(date) ? null : date;
}

function daysUntilRenewal(renewalDate) {
  if (!renewalDate) return null;
  
  const endDate = parseDateFR(renewalDate) || new Date(renewalDate);
  if (isNaN(endDate)) return null;
  
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  endDate.setHours(0, 0, 0, 0);
  
  const diffTime = endDate - today;
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  
  return diffDays;
}

function getOrdonnanceStatus(renewalDate) {
  const days = daysUntilRenewal(renewalDate);
  if (days === null) return { status: 'invalide', label: 'Date invalide', color: 'var(--danger)' };
  if (days < 0) return { status: 'expiree', label: 'ExpirÃ©e', color: 'var(--danger)', days: Math.abs(days) };
  if (days === 0) return { status: 'aujourdhui', label: "Expire aujourd'hui", color: 'var(--danger)', days: 0 };
  if (days <= 7) return { status: 'urgent', label: `${days} jour${days > 1 ? 's' : ''}`, color: 'var(--danger)', days };
  if (days <= 30) return { status: 'proche', label: `${days} jours`, color: 'var(--warning)', days };
  if (days <= 60) return { status: 'moyen', label: `${days} jours`, color: 'var(--info)', days };
  return { status: 'ok', label: `${days} jours`, color: 'var(--success)', days };
}

function formatCycleLabel(renewalDate) {
  const cycleInfo = getCycleFromDate(renewalDate);
  if (!cycleInfo) return renewalDate || 'â€”';
  
  return `${cycleInfo.name} ${cycleInfo.year} (${cycleInfo.label})`;
}

function getPatientsByCycle(cycle, year) {
  return state.patients.filter(p => {
    const cycleInfo = getCycleFromDate(p.renewalDate);
    if (!cycleInfo || cycleInfo.cycle !== cycle || cycleInfo.year !== year) return false;

    // Exclure les patients archivÃ©s dont la date de renouvellement est ultÃ©rieure Ã  la date d'archivage
    if ((p.status === 'temporary_pause' || p.status === 'permanent_pause') && p.pausedAt) {
      const renewalDate = parseDate(p.renewalDate);
      const pausedDate = new Date(p.pausedAt);
      if (renewalDate && renewalDate > pausedDate) {
        return false;
      }
    }

    return true;
  });
}

function getUpcomingRenewals(daysAhead = 30) {
  return state.patients.filter(p => {
    const days = daysUntilRenewal(p.renewalDate);
    if (days === null || days < 0 || days > daysAhead) return false;

    // Exclure les patients archivÃ©s dont la date de renouvellement est ultÃ©rieure Ã  la date d'archivage
    if ((p.status === 'temporary_pause' || p.status === 'permanent_pause') && p.pausedAt) {
      const renewalDate = parseDate(p.renewalDate);
      const pausedDate = new Date(p.pausedAt);
      if (renewalDate && renewalDate > pausedDate) {
        return false;
      }
    }

    return true;
  }).sort((a, b) => {
    const daysA = daysUntilRenewal(a.renewalDate);
    const daysB = daysUntilRenewal(b.renewalDate);
    return daysA - daysB;
  });
}

function getExpiredOrdonnances() {
  return state.patients.filter(p => {
    const days = daysUntilRenewal(p.renewalDate);
    if (days === null || days >= 0) return false;

    // Exclure les patients archivÃ©s dont la date de renouvellement est ultÃ©rieure Ã  la date d'archivage
    if ((p.status === 'temporary_pause' || p.status === 'permanent_pause') && p.pausedAt) {
      const renewalDate = parseDate(p.renewalDate);
      const pausedDate = new Date(p.pausedAt);
      if (renewalDate && renewalDate > pausedDate) {
        return false;
      }
    }

    return true;
  }).sort((a, b) => {
    const daysA = daysUntilRenewal(a.renewalDate);
    const daysB = daysUntilRenewal(b.renewalDate);
    return daysB - daysA;
  });
}

function suggestNextRenewalDate(currentDate) {
  const cycleInfo = currentDate ? getCycleFromDate(currentDate) : getCurrentCycle();
  if (!cycleInfo) return formatDateFR(new Date());
  
  // Add 4 months to get next cycle
  const current = parseDateFR(currentDate) || new Date();
  const next = new Date(current);
  next.setMonth(next.getMonth() + 4);
  
  return formatDateFR(next);
}

// ===== View Management =====
function switchView(viewName) {
  // Hide all views
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  
  // Show selected view
  const view = byId(viewName);
  if (view) {
    view.classList.add('active', 'slide-up');
  }
  
  // Update nav
  document.querySelectorAll('.nav-item').forEach(btn => {
    btn.classList.remove('active');
    if (btn.dataset.view === viewName) {
      btn.classList.add('active');
    }
  });
  
  // Render view content
  if (viewName === 'dashboard') renderDashboard();
  if (viewName === 'patients') renderPatients();
  if (viewName === 'ordos') renderOrdos();
  if (viewName === 'switches') renderSwitches();
  if (viewName === 'appointments') {
    renderAppointments();
    updateAppointmentStats();
  }
  if (viewName === 'catalogs') renderCatalogs();
  if (viewName === 'report') renderStats();
}

// ===== Render Functions =====
function render() {
  renderDashboard();
  renderPatients();
  renderArchivedPatients();
  renderCatalogs();
  updateAppointmentStats();
  updateCounters();
}

function renderDashboard() {
  const now = new Date();
  const currentMonth = now.getMonth();
  const currentYear = now.getFullYear();

  // Filter active patients only
  const activePatients = state.patients.filter(p => !p.status || p.status === 'active');

  // ===== KPIs Principaux =====
  // Utiliser getUpcomingRenewals qui gÃ¨re dÃ©jÃ  le filtrage des patients archivÃ©s
  const renews30 = getUpcomingRenewals(30);
  
  const avgScore = activePatients.length > 0 
    ? Math.round(activePatients.reduce((sum, p) => sum + qScore(p), 0) / activePatients.length)
    : 0;
  
  byId('kpiPatients').textContent = activePatients.length;
  byId('kpiRenews').textContent = renews30.length;
  byId('kpiScore').textContent = avgScore + '%';
  byId('kpiProtos').textContent = state.protos.length;
  
  // ===== Message de bienvenue dynamique =====
  const hour = now.getHours();
  let greeting = 'Bonne journÃ©e';
  if (hour < 12) greeting = 'Bonjour';
  else if (hour < 18) greeting = 'Bon aprÃ¨s-midi';
  else greeting = 'Bonsoir';
  
  const monthNames = ['Janvier', 'FÃ©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 
                      'Juillet', 'AoÃ»t', 'Septembre', 'Octobre', 'Novembre', 'DÃ©cembre'];
  const welcomeEl = byId('dashboardWelcome');
  if (welcomeEl) {
    welcomeEl.textContent = `${greeting} ! ${monthNames[currentMonth]} ${currentYear} - Voici votre vue d'ensemble`;
  }
  
  // ===== Alertes urgentes =====
  renderDashboardAlerts(renews30);
  
  // ===== Rendez-vous ce mois =====
  renderDashboardAppointments();
  
  // ===== Switchs Ã  venir (60 jours) =====
  renderDashboardSwitches();
  
  // ===== Ordonnances Ã  renouveler =====
  renderDashboardRenewals(renews30);
  
  // ===== Graphique des protocoles =====
  renderDashboardProtocolsChart();
}

function renderDashboardAlerts(renews30) {
  const container = byId('dashboardAlerts');
  if (!container) return;
  
  const now = new Date();
  let alerts = [];
  
  // Ordonnances critiques (â‰¤7 jours)
  const criticalRenewals = renews30.filter(p => {
    const days = daysUntilRenewal(p.renewalDate);
    return days !== null && days <= 7;
  });
  
  if (criticalRenewals.length > 0) {
    alerts.push({
      type: 'danger',
      icon: 'ðŸš¨',
      title: `${criticalRenewals.length} ordonnance(s) critique(s)`,
      message: `Ã€ renouveler dans les 7 prochains jours`,
      action: () => switchView('ordos')
    });
  }
  
  // Switchs en retard
  const lateSwitches = (state.switches || []).filter(sw => {
    if (sw.status !== 'planned') return false;
    const swDate = parseDate(sw.switchDate);
    return swDate && swDate < now;
  });
  
  if (lateSwitches.length > 0) {
    alerts.push({
      type: 'warning',
      icon: 'âš ï¸',
      title: `${lateSwitches.length} switch(s) en retard`,
      message: 'NÃ©cessitent votre attention',
      action: () => switchView('switches')
    });
  }
  
  // Rendez-vous aujourd'hui
  const todayAppointments = (state.appointments || []).filter(a => {
    if (a.status !== 'active' || !a.exactDate) return false;
    const parts = a.exactDate.split('/');
    if (parts.length !== 3) return false;
    const aptDate = new Date(parseInt(parts[2], 10), parseInt(parts[1], 10) - 1, parseInt(parts[0], 10));
    return aptDate.toDateString() === now.toDateString();
  });
  
  if (todayAppointments.length > 0) {
    alerts.push({
      type: 'info',
      icon: 'ðŸ“…',
      title: `${todayAppointments.length} rendez-vous aujourd'hui`,
      message: 'Consultez votre planning',
      action: () => switchView('appointments')
    });
  }
  
  // Affichage des alertes
  if (alerts.length === 0) {
    container.innerHTML = '';
    return;
  }
  
  const colorMap = {
    danger: { bg: '#fee2e2', border: '#ef4444', text: '#991b1b' },
    warning: { bg: '#fef3c7', border: '#f59e0b', text: '#78350f' },
    info: { bg: '#dbeafe', border: '#3b82f6', text: '#1e3a8a' }
  };
  
  container.innerHTML = alerts.map(alert => {
    const colors = colorMap[alert.type];
    return `
      <div style="background: ${colors.bg}; border-left: 4px solid ${colors.border}; padding: 1.25rem; border-radius: var(--radius-md); margin-bottom: 1rem; cursor: pointer; transition: var(--transition);" 
           onclick="(${alert.action.toString()})()"
           onmouseover="this.style.transform='translateX(5px)'; this.style.boxShadow='var(--shadow)'"
           onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='none'">
        <div style="display: flex; align-items: center; gap: 1rem;">
          <div style="font-size: 2rem; flex-shrink: 0;">${alert.icon}</div>
          <div style="flex: 1;">
            <div style="font-weight: 700; color: ${colors.text}; margin-bottom: 0.25rem;">${alert.title}</div>
            <div style="color: ${colors.text}; opacity: 0.8; font-size: 0.9rem;">${alert.message}</div>
          </div>
          <svg width="24" height="24" fill="${colors.border}" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
          </svg>
        </div>
      </div>
    `;
  }).join('');
}

function renderDashboardAppointments() {
  const dashboardList = byId('dashboardAppointmentsList');
  const dashboardCount = byId('dashboardAppointmentsCount');
  
  if (!dashboardList) return;
  
  if (!state.appointments || state.appointments.length === 0) {
    dashboardList.innerHTML = '<p class="text-muted text-center" style="padding: 2rem;">Aucun suivi prÃ©vu ce mois</p>';
    if (dashboardCount) dashboardCount.textContent = '0';
    return;
  }
  
  const now = new Date();
  const currentYear = now.getFullYear();
  const currentMonth = now.getMonth();
  
  // Get appointments for this month
  const thisMonthAppointments = state.appointments.filter(a => {
    if (a.status !== 'active') return false;
    
    if (a.exactDate) {
      const parts = a.exactDate.split('/');
      if (parts.length === 3) {
        const month = parseInt(parts[1], 10) - 1;
        const year = parseInt(parts[2], 10);
        return month === currentMonth && year === currentYear;
      }
    } else if (a.month) {
      const parts = a.month.split('/');
      if (parts.length === 2) {
        const aptMonth = parseInt(parts[0], 10) - 1;
        const aptYear = parseInt(parts[1], 10);
        return aptMonth === currentMonth && aptYear === currentYear;
      }
    }
    return false;
  });
  
  // Sort by date
  thisMonthAppointments.sort((a, b) => {
    if (a.exactDate && b.exactDate) {
      const partsA = a.exactDate.split('/');
      const partsB = b.exactDate.split('/');
      const dateA = new Date(parseInt(partsA[2], 10), parseInt(partsA[1], 10) - 1, parseInt(partsA[0], 10));
      const dateB = new Date(parseInt(partsB[2], 10), parseInt(partsB[1], 10) - 1, parseInt(partsB[0], 10));
      return dateA - dateB;
    }
    if (a.exactDate && !b.exactDate) return -1;
    if (!a.exactDate && b.exactDate) return 1;
    return 0;
  });
  
  if (dashboardCount) dashboardCount.textContent = thisMonthAppointments.length;
  
  if (thisMonthAppointments.length > 0) {
    dashboardList.innerHTML = thisMonthAppointments.map(apt => {
      const patient = state.patients.find(p => p.id === apt.patientId);
      if (!patient) return '';
      
      let dateDisplay, diffDays = null, bgColor, borderColor;
      
      if (apt.exactDate) {
        const parts = apt.exactDate.split('/');
        const aptDate = new Date(parseInt(parts[2], 10), parseInt(parts[1], 10) - 1, parseInt(parts[0], 10));
        diffDays = Math.ceil((aptDate - now) / (1000 * 60 * 60 * 24));
        dateDisplay = apt.exactDate;
        
        if (diffDays < 0) {
          bgColor = '#fee2e2';
          borderColor = '#ef4444';
        } else if (diffDays === 0) {
          bgColor = '#fef3c7';
          borderColor = '#f59e0b';
        } else if (diffDays <= 7) {
          bgColor = '#dbeafe';
          borderColor = '#3b82f6';
        } else {
          bgColor = '#f0fdf4';
          borderColor = '#10b981';
        }
      } else {
        dateDisplay = apt.month;
        bgColor = '#fef3c7';
        borderColor = '#f59e0b';
      }
      
      return `
        <div style="padding: 1rem; border-bottom: 1px solid var(--border-light); border-left: 3px solid ${borderColor}; background: ${bgColor}; transition: var(--transition);" 
             onmouseover="this.style.transform='translateX(5px)'"
             onmouseout="this.style.transform='translateX(0)'">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
            <div style="font-weight: 700; font-size: 1rem;">${fullName(patient)}</div>
            ${diffDays !== null && diffDays === 0 ? '<span style="background: #f59e0b; color: white; padding: 0.25rem 0.5rem; border-radius: var(--radius); font-size: 0.75rem; font-weight: 700;">AUJOURD\'HUI</span>' : 
              diffDays !== null && diffDays < 0 ? '<span style="background: #ef4444; color: white; padding: 0.25rem 0.5rem; border-radius: var(--radius); font-size: 0.75rem; font-weight: 700;">EN RETARD</span>' : 
              diffDays !== null && diffDays <= 7 ? '<span style="background: #3b82f6; color: white; padding: 0.25rem 0.5rem; border-radius: var(--radius); font-size: 0.75rem; font-weight: 700;">CETTE SEMAINE</span>' : ''}
          </div>
          <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.75rem;">
            <span>${apt.exactDate ? 'ðŸ“…' : 'ðŸ“ž'}</span>
            <span>${dateDisplay}</span>
            ${apt.type ? `<span>â€¢</span><span>${apt.type}</span>` : ''}
            ${apt.notes ? `<span>â€¢</span><span style="font-style: italic;">${apt.notes}</span>` : ''}
          </div>
          <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
            <button class="btn btn-sm btn-success" data-action="validateAppointment" data-appointment-id="${apt.id}" style="flex: 1; padding: 0.4rem 0.75rem; font-size: 0.85rem;" title="Valider ce rendez-vous">
              <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20" style="margin-right: 0.25rem;"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
              Valider
            </button>
            <button class="btn btn-sm btn-primary" data-action="scheduleNext" data-patient-id="${patient.id}" data-current-apt-id="${apt.id}" style="flex: 1; padding: 0.4rem 0.75rem; font-size: 0.85rem;" title="Programmer le suivant">
              <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20" style="margin-right: 0.25rem;"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd"></path></svg>
              Programmer
            </button>
          </div>
        </div>
      `;
    }).join('');
  } else {
    dashboardList.innerHTML = '<p class="text-muted text-center" style="padding: 2rem;">Aucun suivi prÃ©vu ce mois</p>';
  }
}

function validateAppointment(appointmentId) {
  const appointment = state.appointments.find(a => a.id === appointmentId);
  if (!appointment) {
    showToast('Rendez-vous introuvable', 'error');
    return;
  }
  
  const patient = state.patients.find(p => p.id === appointment.patientId);
  if (!patient) {
    showToast('Patient introuvable', 'error');
    return;
  }
  
  // Ajouter Ã  l'historique si disponible
  if (!appointment.history) {
    appointment.history = [];
  }
  
  appointment.history.push({
    date: new Date().toISOString(),
    action: 'completed',
    note: `Rendez-vous validÃ© le ${new Date().toLocaleDateString('fr-FR')}`
  });
  
  // Marquer comme terminÃ©
  appointment.status = 'completed';
  appointment.completedAt = Date.now();
  
  saveDB();
  render();
  
  showToast(`âœ… Rendez-vous validÃ© pour ${fullName(patient)}`, 'success');
}

function scheduleNextAppointment(patientId, currentAptId) {
  const patient = state.patients.find(p => p.id === patientId);
  if (!patient) {
    showToast('Patient introuvable', 'error');
    return;
  }
  
  const currentApt = state.appointments.find(a => a.id === currentAptId);
  
  // Create modal for scheduling next appointment
  const existingModal = byId('scheduleNextModal');
  if (existingModal) existingModal.remove();
  
  const modal = document.createElement('div');
  modal.id = 'scheduleNextModal';
  modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 99999;';
  
  // Calculate suggested date (1 month from current apt date or today)
  let suggestedDate = new Date();
  if (currentApt && currentApt.exactDate) {
    const parts = currentApt.exactDate.split('/');
    if (parts.length === 3) {
      const aptDate = new Date(parseInt(parts[2], 10), parseInt(parts[1], 10) - 1, parseInt(parts[0], 10));
      suggestedDate = new Date(aptDate);
      suggestedDate.setMonth(suggestedDate.getMonth() + 1); // Add 1 month
    }
  } else {
    suggestedDate.setMonth(suggestedDate.getMonth() + 1); // Add 1 month from today
  }
  
  const suggestedDateStr = suggestedDate.toISOString().split('T')[0];
  
  modal.innerHTML = `
    <div style="background: var(--bg-primary); border-radius: var(--radius-lg); max-width: 550px; width: 90%; box-shadow: var(--shadow-xl);">
      <div style="padding: 1.5rem;">
        <h3 style="margin-bottom: 1rem; color: var(--primary); display: flex; align-items: center; gap: 0.5rem;">
          <span style="font-size: 1.5rem;">ðŸ“…</span>
          Programmer le prochain rendez-vous
        </h3>
        <p style="margin-bottom: 1.5rem; color: var(--text-secondary);">
          <strong>${fullName(patient)}</strong>
        </p>
        
        <div style="display: flex; flex-direction: column; gap: 1rem;">
          <div>
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">
              Type de rendez-vous
            </label>
            <select id="nextAptType" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-primary); color: var(--text-primary);">
              <option value="Suivi">Suivi</option>
              <option value="Consultation">Consultation</option>
              <option value="Renouvellement">Renouvellement</option>
              <option value="Bilan">Bilan</option>
              <option value="Autre">Autre</option>
            </select>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div>
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">
                <input type="radio" name="dateType" value="exact" checked style="margin-right: 0.5rem;">
                Date exacte
              </label>
              <input type="date" id="nextAptExactDate" value="${suggestedDateStr}" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-primary); color: var(--text-primary);">
            </div>
            
            <div>
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">
                <input type="radio" name="dateType" value="month" style="margin-right: 0.5rem;">
                Mois uniquement
              </label>
              <input type="month" id="nextAptMonth" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-primary); color: var(--text-primary);">
            </div>
          </div>
          
          <div>
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">
              Notes (optionnel)
            </label>
            <textarea id="nextAptNotes" rows="2" placeholder="Ex: Ã€ jeun, Apporter les rÃ©sultats..." style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-primary); color: var(--text-primary); resize: vertical;"></textarea>
          </div>
        </div>
      </div>
      
      <div style="padding: 0 1.5rem 1.5rem; display: flex; gap: 0.5rem; justify-content: flex-end;">
        <button class="btn btn-secondary" id="btnCancelNextApt">Annuler</button>
        <button class="btn btn-primary" id="btnConfirmNextApt">
          ðŸ“… Programmer
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Enable/disable inputs based on radio selection
  const exactRadio = modal.querySelector('input[name="dateType"][value="exact"]');
  const monthRadio = modal.querySelector('input[name="dateType"][value="month"]');
  const exactDateInput = byId('nextAptExactDate');
  const monthInput = byId('nextAptMonth');
  
  function updateInputs() {
    if (exactRadio.checked) {
      exactDateInput.disabled = false;
      monthInput.disabled = true;
      exactDateInput.style.opacity = '1';
      monthInput.style.opacity = '0.5';
    } else {
      exactDateInput.disabled = true;
      monthInput.disabled = false;
      exactDateInput.style.opacity = '0.5';
      monthInput.style.opacity = '1';
    }
  }
  
  exactRadio.addEventListener('change', updateInputs);
  monthRadio.addEventListener('change', updateInputs);
  updateInputs();
  
  // Event listeners
  byId('btnCancelNextApt').addEventListener('click', () => modal.remove());
  
  byId('btnConfirmNextApt').addEventListener('click', () => {
    const type = byId('nextAptType').value;
    const notes = byId('nextAptNotes').value.trim();
    
    let exactDate = null;
    let month = null;
    
    if (exactRadio.checked) {
      const dateValue = exactDateInput.value;
      if (!dateValue) {
        showToast('Veuillez sÃ©lectionner une date', 'warning');
        exactDateInput.focus();
        return;
      }
      // Convert to DD/MM/YYYY
      const date = new Date(dateValue);
      exactDate = `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}/${date.getFullYear()}`;
    } else {
      const monthValue = monthInput.value;
      if (!monthValue) {
        showToast('Veuillez sÃ©lectionner un mois', 'warning');
        monthInput.focus();
        return;
      }
      // Convert YYYY-MM to MM/YYYY
      const parts = monthValue.split('-');
      month = `${parts[1]}/${parts[0]}`;
    }
    
    // Create new appointment
    const newApt = {
      id: `id_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      patientId: patientId,
      exactDate: exactDate,
      month: month,
      type: type,
      notes: notes,
      status: 'active',
      history: [],
      createdAt: Date.now(),
      updatedAt: Date.now()
    };
    
    state.appointments.push(newApt);
    saveDB();
    render();
    modal.remove();
    
    showToast(`âœ… Rendez-vous programmÃ© pour ${fullName(patient)}`, 'success');
  });
  
  // Close on background click
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.remove();
    }
  });
  
  // Close on Escape
  const escHandler = (e) => {
    if (e.key === 'Escape') {
      modal.remove();
      document.removeEventListener('keydown', escHandler);
    }
  };
  document.addEventListener('keydown', escHandler);
}

function renderDashboardSwitches() {
  const container = byId('dashboardSwitchesList');
  const countEl = byId('dashboardSwitchesCount');
  
  if (!container) return;
  
  if (!state.switches || state.switches.length === 0) {
    container.innerHTML = '<p class="text-muted text-center" style="padding: 2rem;">Aucun switch planifiÃ©</p>';
    if (countEl) countEl.textContent = '0';
    return;
  }
  
  const now = new Date();
  const in60Days = new Date(now.getTime() + 60 * 24 * 60 * 60 * 1000);
  
  // Get upcoming switches (60 days)
  const upcomingSwitches = state.switches.filter(sw => {
    if (sw.status !== 'planned') return false;
    const swDate = parseDate(sw.switchDate);
    return swDate && swDate >= now && swDate <= in60Days;
  }).sort((a, b) => {
    const dateA = parseDate(a.switchDate);
    const dateB = parseDate(b.switchDate);
    return dateA - dateB;
  });
  
  if (countEl) countEl.textContent = upcomingSwitches.length;
  
  if (upcomingSwitches.length > 0) {
    container.innerHTML = upcomingSwitches.map(sw => {
      const patient = state.patients.find(p => p.id === sw.patientId);
      if (!patient) return '';
      
      const swDate = parseDate(sw.switchDate);
      const diffDays = Math.ceil((swDate - now) / (1000 * 60 * 60 * 24));
      
      let bgColor, borderColor;
      if (diffDays <= 7) {
        bgColor = '#fef3c7';
        borderColor = '#f59e0b';
      } else if (diffDays <= 30) {
        bgColor = '#dbeafe';
        borderColor = '#3b82f6';
      } else {
        bgColor = '#f0fdf4';
        borderColor = '#10b981';
      }
      
      return `
        <div style="padding: 1rem; border-bottom: 1px solid var(--border-light); border-left: 3px solid ${borderColor}; background: ${bgColor}; transition: var(--transition); cursor: pointer;" 
             onclick="openSwitchModal('${sw.id}')"
             onmouseover="this.style.transform='translateX(5px)'"
             onmouseout="this.style.transform='translateX(0)'">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
            <div style="font-weight: 700;">${fullName(patient)}</div>
            <span style="background: ${borderColor}; color: white; padding: 0.25rem 0.5rem; border-radius: var(--radius); font-size: 0.75rem; font-weight: 700;">J-${diffDays}</span>
          </div>
          <div style="font-size: 0.9rem; color: var(--text-secondary);">
            ${sw.switchDate} â€¢ ${protoName(sw.oldProtoId) || '?'} â†’ ${protoName(sw.newProtoId)}
          </div>
        </div>
      `;
    }).join('');
  } else {
    container.innerHTML = '<p class="text-muted text-center" style="padding: 2rem;">Aucun switch dans les 60 prochains jours</p>';
  }
}

function renderDashboardRenewals(renews30) {
  const container = byId('dashboardRenewalsList');
  if (!container) return;
  
  if (renews30.length === 0) {
    container.innerHTML = '<p class="text-muted text-center" style="padding: 2rem;">Aucune ordonnance Ã  renouveler</p>';
    return;
  }
  
  // Sort by urgency
  renews30.sort((a, b) => {
    const daysA = daysUntilRenewal(a.renewalDate);
    const daysB = daysUntilRenewal(b.renewalDate);
    return daysA - daysB;
  });
  
  container.innerHTML = renews30.map(p => {
    const days = daysUntilRenewal(p.renewalDate);
    
    let bgColor, borderColor, barColor, urgencyText;
    if (days <= 7) {
      bgColor = '#fee2e2';
      borderColor = '#ef4444';
      barColor = '#ef4444';
      urgencyText = 'URGENT';
    } else if (days <= 15) {
      bgColor = '#fef3c7';
      borderColor = '#f59e0b';
      barColor = '#f59e0b';
      urgencyText = 'ATTENTION';
    } else {
      bgColor = '#f0fdf4';
      borderColor = '#10b981';
      barColor = '#10b981';
      urgencyText = 'Ã€ PRÃ‰VOIR';
    }
    
    const progress = Math.max(0, Math.min(100, ((30 - days) / 30) * 100));
    
    return `
      <div style="padding: 1rem; border-bottom: 1px solid var(--border-light); border-left: 3px solid ${borderColor}; background: ${bgColor}; transition: var(--transition); cursor: pointer;" 
           onclick="openPatient('${p.id}')"
           onmouseover="this.style.transform='translateX(5px)'"
           onmouseout="this.style.transform='translateX(0)'">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
          <div>
            <div style="font-weight: 700; margin-bottom: 0.25rem;">${fullName(p)}</div>
            <div style="font-size: 0.85rem; color: var(--text-secondary);">
              ${docName(p.docId) || 'MÃ©decin non dÃ©fini'} â€¢ ${centerName(p.centerId) || 'Centre non dÃ©fini'}
            </div>
          </div>
          <span style="background: ${borderColor}; color: white; padding: 0.25rem 0.5rem; border-radius: var(--radius); font-size: 0.75rem; font-weight: 700;">J-${days}</span>
        </div>
        <div style="margin-bottom: 0.5rem;">
          <div style="display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 0.25rem;">
            <span style="color: var(--text-secondary);">Ã‰chÃ©ance : ${formatCycleLabel(p.renewalDate)}</span>
            <span style="color: ${borderColor}; font-weight: 700;">${urgencyText}</span>
          </div>
          <div style="background: rgba(0,0,0,0.1); height: 6px; border-radius: 3px; overflow: hidden;">
            <div style="background: ${barColor}; height: 100%; width: ${progress}%; transition: width 0.3s ease; border-radius: 3px;"></div>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function renderDashboardProtocolsChart() {
  const container = byId('dashboardProtocolsChart');
  if (!container) return;
  
  if (state.patients.length === 0) {
    container.innerHTML = '<p class="text-muted text-center">Aucune donnÃ©e Ã  afficher</p>';
    return;
  }
  
  // Count patients by protocol
  const protocolCounts = {};
  state.patients.forEach(p => {
    const protoId = p.protoId || 'unknown';
    protocolCounts[protoId] = (protocolCounts[protoId] || 0) + 1;
  });
  
  const colors = ['#667eea', '#f093fb', '#4facfe', '#fa709a', '#ffd200', '#54a0ff', '#48dbfb', '#ff6348'];
  const total = state.patients.length;
  
  let html = '<div style="display: flex; flex-direction: column; gap: 0.75rem;">';
  
  Object.entries(protocolCounts)
    .sort((a, b) => b[1] - a[1])
    .forEach(([protoId, count], index) => {
      const percentage = Math.round((count / total) * 100);
      const color = colors[index % colors.length];
      const name = protoName(protoId) || 'Non dÃ©fini';
      
      html += `
        <div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
            <span style="font-weight: 600; font-size: 0.9rem;">${name}</span>
            <span style="font-weight: 700; color: ${color};">${count} (${percentage}%)</span>
          </div>
          <div style="background: var(--bg-tertiary); height: 8px; border-radius: 4px; overflow: hidden;">
            <div style="background: ${color}; height: 100%; width: ${percentage}%; transition: width 0.5s ease; border-radius: 4px;"></div>
          </div>
        </div>
      `;
    });
  
  html += '</div>';
  container.innerHTML = html;
}

function renderPatients() {
  const tbody = qsEl('#tblPatients tbody');
  if (!tbody) return;
  
  const sortBy = byId('sortPatients')?.value || 'name';
  // Filter only active patients (status is undefined or 'active')
  let sorted = state.patients.filter(p => !p.status || p.status === 'active');
  
  // Tri multicritÃ¨re
  if (sortBy === 'name') {
    sorted.sort((a, b) => fullName(a).localeCompare(fullName(b)));
  } else if (sortBy === 'recent') {
    sorted.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
  } else if (sortBy === 'renewal') {
    sorted.sort((a, b) => {
      const dateA = parseDate(a.renewalDate);
      const dateB = parseDate(b.renewalDate);
      if (!dateA && !dateB) return 0;
      if (!dateA) return 1;
      if (!dateB) return -1;
      return dateA - dateB;
    });
  } else if (sortBy === 'doctor') {
    sorted.sort((a, b) => (docName(a.docId) || 'ZZZ').localeCompare(docName(b.docId) || 'ZZZ'));
  } else if (sortBy === 'center') {
    sorted.sort((a, b) => (centerName(a.centerId) || 'ZZZ').localeCompare(centerName(b.centerId) || 'ZZZ'));
  } else if (sortBy === 'protocol') {
    sorted.sort((a, b) => (protoName(a.protoId) || 'ZZZ').localeCompare(protoName(b.protoId) || 'ZZZ'));
  }
  
  if (sorted.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted" style="padding: 2rem;">Aucun patient actif</td></tr>';
    return;
  }

  tbody.innerHTML = sorted.map(p => {
    const cycleInfo = getCycleFromDate(p.renewalDate);
    const cycleLabel = cycleInfo ? `${cycleInfo.name} ${cycleInfo.year}` : 'â€”';

    return `
      <tr style="cursor: pointer;" onclick="viewPatientDetails('${p.id}')" title="Cliquer pour voir les dÃ©tails">
        <td style="font-weight: 600;">${fullName(p)}</td>
        <td>${protoName(p.protoId) || 'â€”'}</td>
        <td>${docName(p.docId) || 'â€”'}</td>
        <td>${centerName(p.centerId) || 'â€”'}</td>
        <td>${p.renewalDate ? `<div>${p.renewalDate}</div><div class="text-small text-muted">${cycleLabel}</div>` : 'â€”'}</td>
      </tr>
    `;
  }).join('');
}

function renderArchivedPatients() {
  const tbody = qsEl('#tblArchived tbody');
  if (!tbody) return;
  
  const filterStatus = byId('filterArchivedStatus')?.value || 'all';
  const sortBy = byId('sortArchived')?.value || 'name';
  
  // Filter archived patients
  let filtered = state.patients.filter(p => p.status && p.status !== 'active');
  
  // Apply status filter
  if (filterStatus !== 'all') {
    filtered = filtered.filter(p => p.status === filterStatus);
  }
  
  // Sort
  if (sortBy === 'name') {
    filtered.sort((a, b) => fullName(a).localeCompare(fullName(b)));
  } else if (sortBy === 'recent') {
    filtered.sort((a, b) => (b.pausedAt || 0) - (a.pausedAt || 0));
  } else if (sortBy === 'pauseDate') {
    filtered.sort((a, b) => (b.pausedAt || 0) - (a.pausedAt || 0));
  }
  
  // Update statistics
  const tempPause = state.patients.filter(p => p.status === 'temporary_pause').length;
  const permPause = state.patients.filter(p => p.status === 'permanent_pause').length;
  const total = tempPause + permPause;
  
  byId('countTemporaryPause').textContent = tempPause;
  byId('countPermanentPause').textContent = permPause;
  byId('countTotalArchived').textContent = total;
  
  if (filtered.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted" style="padding: 2rem;">Aucun patient archivÃ©</td></tr>';
    return;
  }
  
  tbody.innerHTML = filtered.map(p => {
    const statusBadge = p.status === 'temporary_pause' 
      ? '<span style="background: #f59e0b; color: white; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600;">â¸ï¸ Temporaire</span>'
      : '<span style="background: #ef4444; color: white; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600;">â›” DÃ©finitif</span>';
    
    const pauseDate = p.pausedAt ? new Date(p.pausedAt).toLocaleDateString('fr-FR') : 'â€”';
    
    return `
      <tr>
        <td style="font-weight: 600;">${fullName(p)}</td>
        <td>${statusBadge}</td>
        <td>${pauseDate}</td>
        <td>${protoName(p.protoId) || 'â€”'}</td>
        <td>${docName(p.docId) || 'â€”'}</td>
        <td>
          <div style="display: flex; gap: 0.5rem;">
            <button class="btn btn-sm btn-success" data-action="reactivate" data-patient-id="${p.id}" title="RÃ©activer le patient">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd"></path></svg>
            </button>
            <button class="btn btn-sm btn-secondary" data-action="viewDetails" data-patient-id="${p.id}" title="Voir les dÃ©tails">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path></svg>
            </button>
          </div>
        </td>
      </tr>
    `;
  }).join('');
}

// Helper function to parse DD/MM/YYYY dates
function parseDate(dateStr) {
  if (!dateStr) return null;
  const parts = dateStr.split('/');
  if (parts.length !== 3) return null;
  return new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
}

function renderOrdos() {
  // Current cycle info
  const currentCycle = getCurrentCycle();
  byId('currentCycleLabel').textContent = `${currentCycle.name} ${currentCycle.year}`;
  byId('currentCycleRange').textContent = currentCycle.label;
  
  // Statistics
  const currentCyclePatients = getPatientsByCycle(currentCycle.cycle, currentCycle.year);
  const expired = getExpiredOrdonnances();
  const upcoming = getUpcomingRenewals(30);
  const validOrdos = state.patients.filter(p => {
    const days = daysUntilRenewal(p.renewalDate);
    if (days === null || days <= 30) return false;

    // Exclure les patients archivÃ©s dont la date de renouvellement est ultÃ©rieure Ã  la date d'archivage
    if ((p.status === 'temporary_pause' || p.status === 'permanent_pause') && p.pausedAt) {
      const renewalDate = parseDate(p.renewalDate);
      const pausedDate = new Date(p.pausedAt);
      if (renewalDate && renewalDate > pausedDate) {
        return false;
      }
    }

    return true;
  });
  
  byId('currentCycleRenewals').textContent = currentCyclePatients.length;
  byId('expiredCount').textContent = expired.length;
  byId('validCount').textContent = validOrdos.length;
  
  // Update cycle counts
  const year = parseInt(byId('ordoYearFilter')?.value || currentCycle.year);
  for (let i = 1; i <= 3; i++) {
    const patients = getPatientsByCycle(i, year);
    const countEl = byId(`cycle${i}Count`);
    if (countEl) countEl.textContent = patients.length;
  }
  
  // Render cycle patients list (default to cycle 1)
  renderCyclePatients(1, year);
  
  // Upcoming renewals
  const upcomingList = byId('upcomingRenewalsList');
  if (upcomingList) {
    if (upcoming.length === 0) {
      upcomingList.innerHTML = '<p class="text-center text-muted">Aucun renouvellement prÃ©vu dans les 30 prochains jours</p>';
    } else {
      upcomingList.innerHTML = upcoming.map(p => {
        const status = getOrdonnanceStatus(p.renewalDate);
        const cycleInfo = getCycleFromDate(p.renewalDate);
        const statusClass = status.days <= 7 ? 'urgent' : 'warning';
        
        return `
          <div class="ordo-card ${statusClass}">
            <div class="ordo-info">
              <div class="ordo-patient">${fullName(p)}</div>
              <div class="ordo-details">
                <span class="ordo-detail">
                  <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20"><path d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"></path></svg>
                  ${formatCycleLabel(p.renewalDate)}
                </span>
                <span class="ordo-detail">
                  <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>
                  ${docName(p.docId) || 'Sans mÃ©decin'}
                </span>
                <span class="ordo-detail">
                  <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm3 1h6v4H7V5zm6 6H7v2h6v-2z" clip-rule="evenodd"></path></svg>
                  ${centerName(p.centerId) || 'Sans centre'}
                </span>
              </div>
            </div>
            <div class="ordo-actions">
              <div class="ordo-status ${statusClass}">
                ${status.label}
              </div>
              <button class="btn btn-primary" onclick="renewOrdonnance('${p.id}')">
                Renouveler
              </button>
            </div>
          </div>
        `;
      }).join('');
    }
  }
  
  // Expired prescriptions
  const expiredList = byId('expiredList');
  if (expiredList) {
    if (expired.length === 0) {
      expiredList.innerHTML = '<p class="text-center text-muted">âœ… Aucune ordonnance expirÃ©e</p>';
    } else {
      expiredList.innerHTML = expired.map(p => {
        const status = getOrdonnanceStatus(p.renewalDate);
        const cycleInfo = getCycleFromDate(p.renewalDate);
        
        return `
          <div class="ordo-card expired">
            <div class="ordo-info">
              <div class="ordo-patient">${fullName(p)}</div>
              <div class="ordo-details">
                <span class="ordo-detail">
                  <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20"><path d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"></path></svg>
                  ${formatCycleLabel(p.renewalDate)}
                </span>
                <span class="ordo-detail" style="color: var(--danger);">
                  <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                  ExpirÃ©e depuis ${status.days} jour${status.days > 1 ? 's' : ''}
                </span>
              </div>
            </div>
            <div class="ordo-actions">
              <div class="ordo-status expired">
                ExpirÃ©e
              </div>
              <button class="btn btn-danger" onclick="renewOrdonnance('${p.id}')">
                Renouveler urgent
              </button>
            </div>
          </div>
        `;
      }).join('');
    }
  }
}

function renderCyclePatients(cycleNum, year) {
  const patients = getPatientsByCycle(cycleNum, year);
  const list = byId('cyclePatientsList');
  
  if (!list) return;
  
  if (patients.length === 0) {
    list.innerHTML = `<p class="text-center text-muted">Aucun patient dans le Cycle ${cycleNum} ${year}</p>`;
    return;
  }
  
  const cycleInfo = getCycleInfo(cycleNum, year);
  const today = new Date();
  const isCurrentCycle = today >= cycleInfo.startDate && today <= cycleInfo.endDate;
  
  // Group patients by doctor
  const patientsByDoctor = {};
  patients.forEach(p => {
    const docId = p.docId || 'no-doctor';
    if (!patientsByDoctor[docId]) {
      patientsByDoctor[docId] = [];
    }
    patientsByDoctor[docId].push(p);
  });
  
  // Sort doctors - "no-doctor" at the end
  const doctorIds = Object.keys(patientsByDoctor).sort((a, b) => {
    if (a === 'no-doctor') return 1;
    if (b === 'no-doctor') return -1;
    const nameA = docName(a) || '';
    const nameB = docName(b) || '';
    return nameA.localeCompare(nameB);
  });
  
  list.innerHTML = `
    <div class="mb-3">
      <div class="flex-between mb-2">
        <h4>Patients du ${cycleInfo.name} ${year}</h4>
        <span class="badge ${isCurrentCycle ? 'badge-success' : 'badge-info'}">
          ${isCurrentCycle ? 'Cycle en cours' : `${cycleInfo.label}`}
        </span>
      </div>
      <div class="text-small text-muted mb-3">
        PÃ©riode : ${cycleInfo.startDate.toLocaleDateString('fr-FR')} - ${cycleInfo.endDate.toLocaleDateString('fr-FR')}
      </div>
      <div class="text-small text-muted mb-3" style="font-weight: 600;">
        ðŸ“‹ ${Object.keys(patientsByDoctor).length} mÃ©decin${Object.keys(patientsByDoctor).length > 1 ? 's' : ''} â€¢ 
        ${patients.length} patient${patients.length > 1 ? 's' : ''}
      </div>
    </div>
    
    ${doctorIds.map(docId => {
      const doctorPatients = patientsByDoctor[docId];
      const doctorDisplayName = docId === 'no-doctor' ? 'âš ï¸ Sans mÃ©decin attribuÃ©' : docName(docId);
      
      // Count urgencies for this doctor
      const urgentCount = doctorPatients.filter(p => {
        const status = getOrdonnanceStatus(p.renewalDate);
        return status.status === 'expiree' || status.status === 'urgent';
      }).length;
      
      return `
        <div class="card mb-3" style="border-left: 4px solid ${docId === 'no-doctor' ? 'var(--danger)' : 'var(--primary)'};">
          <div class="card-header" style="background: var(--bg-tertiary); padding: 1rem;">
            <div class="flex-between" style="align-items: center;">
              <div>
                <h5 style="margin: 0; color: var(--primary); font-size: 1.1rem;">
                  <svg width="18" height="18" fill="currentColor" viewBox="0 0 20 20" style="vertical-align: middle; margin-right: 0.5rem;">
                    <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                  </svg>
                  ${doctorDisplayName}
                </h5>
              </div>
              <div style="display: flex; gap: 0.5rem; align-items: center;">
                <span class="badge badge-info">${doctorPatients.length} patient${doctorPatients.length > 1 ? 's' : ''}</span>
                ${urgentCount > 0 ? `<span class="badge badge-danger">âš ï¸ ${urgentCount} urgent${urgentCount > 1 ? 's' : ''}</span>` : ''}
              </div>
            </div>
          </div>
          <div class="card-body" style="padding: 0.5rem;">
            ${doctorPatients.map(p => {
              const status = getOrdonnanceStatus(p.renewalDate);
              const statusClass = status.status === 'expiree' ? 'expired' : 
                                 status.status === 'urgent' ? 'warning' : 'valid';
              
              return `
                <div class="ordo-card ${statusClass}" style="margin: 0.5rem;">
                  <div class="ordo-info">
                    <div class="ordo-patient">${fullName(p)}</div>
                    <div class="ordo-details">
                      <span class="ordo-detail">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20"><path d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"></path></svg>
                        ${p.renewalDate || 'Pas de date'}
                      </span>
                      <span class="ordo-detail">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm3 1h6v4H7V5zm6 6H7v2h6v-2z" clip-rule="evenodd"></path></svg>
                        ${centerName(p.centerId) || 'Sans centre'}
                      </span>
                      <span class="ordo-detail">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 1 1 0 000 2H6a2 2 0 00-2 2v6h16V7a2 2 0 00-2-2h-1a1 1 0 100-2 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path></svg>
                        ${protoName(p.protoId) || 'Sans protocole'}
                      </span>
                      ${status.days !== undefined ? `
                        <span class="ordo-detail" style="color: ${status.color}; font-weight: 600;">
                          <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path></svg>
                          ${status.label}
                        </span>
                      ` : ''}
                    </div>
                  </div>
                  <div class="ordo-actions">
                    <button class="btn btn-secondary" onclick="openPatient('${p.id}')">
                      Voir dÃ©tails
                    </button>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }).join('')}
  `;
}

function renewOrdonnance(patientId) {
  const patient = state.patients.find(p => p.id === patientId);
  if (!patient) return;
  
  const suggestedDate = suggestNextRenewalDate(patient.renewalDate);
  
  // Demander la nouvelle date via prompt
  const newDate = prompt(
    `Renouvellement de l'ordonnance pour ${fullName(patient)}\n\n` +
    `Date actuelle: ${patient.renewalDate || 'Non dÃ©finie'}\n` +
    `Date suggÃ©rÃ©e: ${suggestedDate}\n\n` +
    `Entrez la nouvelle date de renouvellement (JJ/MM/AAAA):`,
    suggestedDate
  );
  
  // Si l'utilisateur annule ou laisse vide
  if (!newDate) return;
  
  // Valider le format de la date
  if (!newDate.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
    showToast('Format de date invalide (JJ/MM/AAAA)', 'error');
    return;
  }
  
  // Mettre Ã  jour la date
  patient.renewalDate = newDate;
  patient.updatedAt = Date.now();
  saveDB();
  render();
  showToast(`Ordonnance renouvelÃ©e au ${newDate}`, 'success');
}

function startBatchRenewal() {
  const upcoming = getUpcomingRenewals(30);
  if (upcoming.length === 0) {
    showToast('Aucune ordonnance Ã  renouveler', 'info');
    return;
  }
  
  if (confirm(`Renouveler ${upcoming.length} ordonnance(s) en lot ?`)) {
    fcState.list = upcoming;
    fcState.index = 0;
    fcOpen();
  }
}

function refreshOrdonnances() {
  renderOrdos();
  showToast('Vue rafraÃ®chie', 'success');
}

function renderCatalogs() {
  // Doctors
  const docsList = byId('docsList');
  if (docsList) {
    docsList.innerHTML = state.docs.length > 0 
      ? state.docs.map(d => `
          <div style="padding: 0.75rem; border-bottom: 1px solid var(--border-light);">
            <div class="flex-between" style="gap: 1rem;">
              <span style="flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${d.name}">${d.name}</span>
              <button class="btn btn-icon btn-secondary" data-action="delDoc" data-id="${d.id}" style="flex-shrink: 0;" title="Supprimer">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
              </button>
            </div>
          </div>
        `).join('')
      : '<p class="text-center text-muted">Aucun mÃ©decin</p>';
  }
  
  // Centers
  const centersList = byId('centersList');
  if (centersList) {
    centersList.innerHTML = state.centers.length > 0
      ? state.centers.map(c => `
          <div style="padding: 0.75rem; border-bottom: 1px solid var(--border-light);">
            <div class="flex-between" style="gap: 1rem;">
              <span style="flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${c.name}">${c.name}</span>
              <button class="btn btn-icon btn-secondary" data-action="delCenter" data-id="${c.id}" style="flex-shrink: 0;" title="Supprimer">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
              </button>
            </div>
          </div>
        `).join('')
      : '<p class="text-center text-muted">Aucun centre</p>';
  }
  
  // Protocols
  const protosList = byId('protosList');
  if (protosList) {
    protosList.innerHTML = state.protos.length > 0
      ? state.protos.map(p => `
          <div style="padding: 0.75rem; border-bottom: 1px solid var(--border-light);">
            <div class="flex-between" style="gap: 1rem;">
              <span style="flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${p.name}">${p.name}</span>
              <button class="btn btn-icon btn-secondary" data-action="delProto" data-id="${p.id}" style="flex-shrink: 0;" title="Supprimer">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
              </button>
            </div>
          </div>
        `).join('')
      : '<p class="text-center text-muted">Aucun protocole</p>';
  }
  
  updateCounters();
}

// ===== RÃ©fÃ©rentiels Management =====
function addDoc() {
  const input = byId('newDocInput');
  const name = input.value.trim();
  
  if (!name) {
    showToast('Veuillez saisir un nom de mÃ©decin', 'warning');
    return;
  }
  
  // VÃ©rifier si le mÃ©decin existe dÃ©jÃ 
  if (state.docs.some(d => d.name.toLowerCase() === name.toLowerCase())) {
    showToast('Ce mÃ©decin existe dÃ©jÃ ', 'warning');
    return;
  }
  
  state.docs.push({
    id: generateId(),
    name: name
  });
  
  saveDB();
  renderCatalogs();
  input.value = '';
  showToast('MÃ©decin ajoutÃ©', 'success');
}

function addCenter() {
  const input = byId('newCenterInput');
  const name = input.value.trim();
  
  if (!name) {
    showToast('Veuillez saisir un nom de centre', 'warning');
    return;
  }
  
  // VÃ©rifier si le centre existe dÃ©jÃ 
  if (state.centers.some(c => c.name.toLowerCase() === name.toLowerCase())) {
    showToast('Ce centre existe dÃ©jÃ ', 'warning');
    return;
  }
  
  state.centers.push({
    id: generateId(),
    name: name
  });
  
  saveDB();
  renderCatalogs();
  input.value = '';
  showToast('Centre ajoutÃ©', 'success');
}

function addProto() {
  const input = byId('newProtoInput');
  const name = input.value.trim();
  
  if (!name) {
    showToast('Veuillez saisir un nom de protocole', 'warning');
    return;
  }
  
  // VÃ©rifier si le protocole existe dÃ©jÃ 
  if (state.protos.some(p => p.name.toLowerCase() === name.toLowerCase())) {
    showToast('Ce protocole existe dÃ©jÃ ', 'warning');
    return;
  }
  
  state.protos.push({
    id: generateId(),
    name: name
  });
  
  saveDB();
  renderCatalogs();
  input.value = '';
  showToast('Protocole ajoutÃ©', 'success');
}

function renderStats() {
  // Populate cycle selects
  const cycles = getAllCycles();
  const currentSelect = byId('currentCycleSelect');
  const previousSelect = byId('previousCycleSelect');
  
  if (currentSelect && previousSelect) {
    // Populate both selects
    const options = cycles.map(c => `<option value="${c.id}">${c.name} ${c.year}</option>`).join('');
    currentSelect.innerHTML = '<option value="">SÃ©lectionner un cycle...</option>' + options;
    previousSelect.innerHTML = '<option value="">SÃ©lectionner un cycle...</option>' + options;
    
    // Auto-select current and previous cycle if available
    if (cycles.length >= 2) {
      currentSelect.value = cycles[0].id; // Most recent cycle
      previousSelect.value = cycles[1].id; // Second most recent cycle
    } else if (cycles.length === 1) {
      currentSelect.value = cycles[0].id;
    }
    
    // Add event listeners to prevent selecting the same cycle in both
    const validateSelection = () => {
      const currentValue = currentSelect.value;
      const previousValue = previousSelect.value;
      
      if (currentValue && previousValue && currentValue === previousValue) {
        showToast('Vous ne pouvez pas sÃ©lectionner le mÃªme cycle deux fois', 'warning');
        // Reset the last changed select
        if (document.activeElement === currentSelect) {
          currentSelect.value = '';
        } else {
          previousSelect.value = '';
        }
      }
    };
    
    // Remove old listeners if any
    currentSelect.removeEventListener('change', validateSelection);
    previousSelect.removeEventListener('change', validateSelection);
    
    // Add new listeners
    currentSelect.addEventListener('change', validateSelection);
    previousSelect.addEventListener('change', validateSelection);
  }
}

function getAllCycles() {
  // Get current year and previous year
  const currentYear = new Date().getFullYear();
  const previousYear = currentYear - 1;
  
  // Generate all possible cycles for the last 2 years
  const allCycles = [];
  
  [currentYear, previousYear].forEach(year => {
    [1, 2, 3].forEach(cycleNum => {
      const cycleInfo = CYCLES[cycleNum];
      if (cycleInfo) {
        allCycles.push({
          id: `C${cycleNum}-${year}`,
          cycle: cycleNum,
          year: year,
          name: cycleInfo.name,
          label: cycleInfo.label,
          months: cycleInfo.months,
          color: cycleInfo.color,
          month: cycleInfo.months[0] // First month of the cycle for sorting
        });
      }
    });
  });
  
  // Sort by year (desc) then by cycle number (desc) - most recent first
  return allCycles.sort((a, b) => {
    if (a.year !== b.year) return b.year - a.year;
    return b.cycle - a.cycle;
  });
}

function compareStatistics() {
  console.log('=== compareStatistics called ===');
  
  const currentCycleId = byId('currentCycleSelect').value;
  const previousCycleId = byId('previousCycleSelect').value;
  
  console.log('currentCycleId:', currentCycleId);
  console.log('previousCycleId:', previousCycleId);
  
  if (!currentCycleId || !previousCycleId) {
    showToast('Veuillez sÃ©lectionner deux cycles Ã  comparer', 'warning');
    return;
  }
  
  if (currentCycleId === previousCycleId) {
    showToast('Veuillez sÃ©lectionner deux cycles diffÃ©rents', 'warning');
    // Reset one of the selects
    byId('previousCycleSelect').value = '';
    return;
  }
  
  const cycles = getAllCycles();
  console.log('All cycles:', cycles);
  
  const currentCycle = cycles.find(c => c.id === currentCycleId);
  const previousCycle = cycles.find(c => c.id === previousCycleId);
  
  console.log('currentCycle found:', currentCycle);
  console.log('previousCycle found:', previousCycle);
  
  if (!currentCycle || !previousCycle) {
    showToast('Erreur : cycles non trouvÃ©s', 'error');
    console.error('Cycles not found in list');
    return;
  }
  
  // Get patients for each cycle
  console.log('Filtering patients...');
  console.log('Total patients:', state.patients.length);
  
  const currentPatients = state.patients.filter(p => {
    if (!p.renewalDate) return false;
    const cycleInfo = getCycleFromDate(p.renewalDate);
    const matches = cycleInfo && cycleInfo.id === currentCycleId;
    if (matches) {
      console.log('Patient', p.lastName, 'matches current cycle:', cycleInfo);
    }
    return matches;
  });
  
  const previousPatients = state.patients.filter(p => {
    if (!p.renewalDate) return false;
    const cycleInfo = getCycleFromDate(p.renewalDate);
    const matches = cycleInfo && cycleInfo.id === previousCycleId;
    if (matches) {
      console.log('Patient', p.lastName, 'matches previous cycle:', cycleInfo);
    }
    return matches;
  });
  
  console.log('currentPatients count:', currentPatients.length);
  console.log('previousPatients count:', previousPatients.length);
  
  // Calculate KPIs
  const kpis = {
    current: calculateKPIs(currentPatients, currentCycle),
    previous: calculateKPIs(previousPatients, previousCycle)
  };
  
  console.log('KPIs calculated:', kpis);
  
  // Display KPIs
  displayKPIComparison(kpis);
  
  // Show comparison section
  byId('statsComparison').style.display = 'block';
  byId('statsWaiting').style.display = 'none';
  
  // Create comparison chart
  createComparisonChart(kpis, currentCycle, previousCycle);
  
  // Success message
  showToast(`ðŸ“Š Comparaison entre ${currentCycle.name} ${currentCycle.year} et ${previousCycle.name} ${previousCycle.year}`, 'success');
  
  console.log('=== compareStatistics completed ===');
}

function calculateKPIs(patients, cycle) {
  console.log(`Calculating KPIs for ${cycle.name} ${cycle.year}...`);
  console.log(`Total patients in database: ${state.patients.length}`);
  
  // Get cycle date range
  const cycleStartMonth = cycle.months[0];
  const cycleEndMonth = cycle.months[cycle.months.length - 1];
  const cycleStartDate = new Date(cycle.year, cycleStartMonth - 1, 1);
  const cycleEndDate = new Date(cycle.year, cycleEndMonth, 0); // Last day of last month
  
  console.log(`Cycle range: ${cycleStartDate.toLocaleDateString()} to ${cycleEndDate.toLocaleDateString()}`);
  
  // 1. PATIENTS ACTIFS = tous les patients qui ne sont PAS en arrÃªt
  // On compte tous les patients actifs Ã  la fin du cycle
  const activePatients = state.patients.filter(p => {
    return !p.status || p.status === 'active';
  });
  console.log(`Active patients (no pause): ${activePatients.length}`);
  
  // 2. TAUX DE COMPLÃ‰TION DES ORDONNANCES
  // Calculer le % d'ordonnances renouvelÃ©es par rapport Ã  l'avancement du cycle
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  
  // DÃ©terminer l'avancement du cycle (0 Ã  100%)
  let cycleProgress = 0;
  if (today < cycleStartDate) {
    cycleProgress = 0; // Cycle pas encore commencÃ©
  } else if (today > cycleEndDate) {
    cycleProgress = 100; // Cycle terminÃ©
  } else {
    const totalDays = (cycleEndDate - cycleStartDate) / (1000 * 60 * 60 * 24);
    const elapsedDays = (today - cycleStartDate) / (1000 * 60 * 60 * 24);
    cycleProgress = Math.round((elapsedDays / totalDays) * 100);
  }
  
  // Compter les ordonnances du cycle (dates dans la pÃ©riode du cycle)
  const ordosDuCycle = activePatients.filter(p => {
    if (!p.renewalDate) return false;
    const renewalDate = parseDateFR(p.renewalDate);
    if (!renewalDate) return false;
    return renewalDate >= cycleStartDate && renewalDate <= cycleEndDate;
  });
  
  // Compter celles qui sont "bien gÃ©rÃ©es" (encore >30j ou dÃ©jÃ  passÃ©es si cycle terminÃ©)
  const ordosWellManaged = ordosDuCycle.filter(p => {
    const daysLeft = daysUntilRenewal(p.renewalDate);
    if (cycleProgress === 100) {
      // Cycle terminÃ© : les ordos doivent avoir Ã©tÃ© renouvelÃ©es (date passÃ©e ou proche)
      return daysLeft === null || daysLeft < 60;
    } else {
      // Cycle en cours : efficacitÃ© = ordos Ã  venir sont encore loin OU dÃ©jÃ  traitÃ©es
      return daysLeft === null || daysLeft > 30 || daysLeft < 0;
    }
  });
  
  const ordoCompletionRate = ordosDuCycle.length > 0 
    ? Math.round((ordosWellManaged.length / ordosDuCycle.length) * 100)
    : 100; // Si pas d'ordos, considÃ©rer comme 100%
  
  console.log(`Ordonnances du cycle: ${ordosDuCycle.length}, bien gÃ©rÃ©es: ${ordosWellManaged.length}, taux: ${ordoCompletionRate}%`);
  
  // 3. SUIVIS EFFECTUÃ‰S dans ce cycle
  const suivisDuCycle = (state.appointments || []).filter(a => {
    if (a.status !== 'completed') return false;
    if (!a.completedAt) return false;
    
    const completedDate = new Date(a.completedAt);
    return completedDate >= cycleStartDate && completedDate <= cycleEndDate;
  });
  console.log(`Suivis completed in cycle: ${suivisDuCycle.length}`);
  
  // 4. SWITCHS EFFECTUÃ‰S dans ce cycle
  const switchsDuCycle = (state.switches || []).filter(s => {
    if (s.status !== 'done') return false;
    if (!s.switchDate) return false;
    
    const switchDate = parseDateFR(s.switchDate);
    if (!switchDate) return false;
    
    return switchDate >= cycleStartDate && switchDate <= cycleEndDate;
  });
  console.log(`Switchs in cycle: ${switchsDuCycle.length}`);
  
  // 5. ARRÃŠTS TEMPORAIRES survenus pendant ce cycle
  const arretsTemporaires = state.patients.filter(p => {
    if (p.status !== 'temporary_pause') return false;
    if (!p.pausedAt) return false;
    
    const pauseDate = new Date(p.pausedAt);
    return pauseDate >= cycleStartDate && pauseDate <= cycleEndDate;
  });
  console.log(`Temporary pauses in cycle: ${arretsTemporaires.length}`);
  
  // 6. ARRÃŠTS DÃ‰FINITIFS survenus pendant ce cycle
  const arretsDefinitifs = state.patients.filter(p => {
    if (p.status !== 'permanent_pause') return false;
    if (!p.pausedAt) return false;
    
    const pauseDate = new Date(p.pausedAt);
    return pauseDate >= cycleStartDate && pauseDate <= cycleEndDate;
  });
  console.log(`Permanent pauses in cycle: ${arretsDefinitifs.length}`);
  
  // 7. SCORE QUALITÃ‰ MOYEN des patients actifs
  const scores = activePatients.map(p => qScore(p)).filter(s => s !== null && s !== undefined);
  const avgScore = scores.length > 0 
    ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) 
    : 0;
  console.log(`Quality score: ${avgScore}% (based on ${scores.length} active patients)`);
  
  const kpis = {
    patients: activePatients.length,
    ordoCompletionRate: ordoCompletionRate,
    suivis: suivisDuCycle.length,
    switchs: switchsDuCycle.length,
    tempPauses: arretsTemporaires.length,
    permPauses: arretsDefinitifs.length,
    avgScore: avgScore
  };
  
  console.log('Final KPIs:', kpis);
  
  return kpis;
}

function displayKPIComparison(kpis) {
  console.log('Displaying KPI comparison...');
  
  try {
    const { current, previous } = kpis;
    
    // 1. PATIENTS ACTIFS
    const kpiPatients1 = byId('kpiPatients1');
    const kpiPatients2 = byId('kpiPatients2');
    const kpiPatientsEvol = byId('kpiPatientsEvol');
    
    if (kpiPatients1 && kpiPatients2 && kpiPatientsEvol) {
      kpiPatients1.textContent = previous.patients;
      kpiPatients2.textContent = current.patients;
      const patientsEvol = calculateEvolution(previous.patients, current.patients);
      kpiPatientsEvol.textContent = patientsEvol.text;
      kpiPatientsEvol.className = `badge ${patientsEvol.class}`;
    }
    
    // 2. EFFICACITÃ‰ ORDONNANCES (taux de complÃ©tion en %)
    const kpiOrdos1 = byId('kpiOrdos1');
    const kpiOrdos2 = byId('kpiOrdos2');
    const kpiOrdosEvol = byId('kpiOrdosEvol');
    
    if (kpiOrdos1 && kpiOrdos2 && kpiOrdosEvol) {
      kpiOrdos1.textContent = previous.ordoCompletionRate + '%';
      kpiOrdos2.textContent = current.ordoCompletionRate + '%';
      const ordosEvol = calculateEvolution(previous.ordoCompletionRate, current.ordoCompletionRate);
      kpiOrdosEvol.textContent = ordosEvol.text;
      kpiOrdosEvol.className = `badge ${ordosEvol.class}`;
    }
    
    // 3. SUIVIS EFFECTUÃ‰S
    const kpiSuivis1 = byId('kpiSuivis1');
    const kpiSuivis2 = byId('kpiSuivis2');
    const kpiSuivisEvol = byId('kpiSuivisEvol');
    
    if (kpiSuivis1 && kpiSuivis2 && kpiSuivisEvol) {
      kpiSuivis1.textContent = previous.suivis;
      kpiSuivis2.textContent = current.suivis;
      const suivisEvol = calculateEvolution(previous.suivis, current.suivis);
      kpiSuivisEvol.textContent = suivisEvol.text;
      kpiSuivisEvol.className = `badge ${suivisEvol.class}`;
    }
    
    // 4. SWITCHS
    const kpiSwitchs1 = byId('kpiSwitchs1');
    const kpiSwitchs2 = byId('kpiSwitchs2');
    const kpiSwitchsEvol = byId('kpiSwitchsEvol');
    
    if (kpiSwitchs1 && kpiSwitchs2 && kpiSwitchsEvol) {
      kpiSwitchs1.textContent = previous.switchs;
      kpiSwitchs2.textContent = current.switchs;
      const switchsEvol = calculateEvolution(previous.switchs, current.switchs);
      kpiSwitchsEvol.textContent = switchsEvol.text;
      kpiSwitchsEvol.className = `badge ${switchsEvol.class}`;
    }
    
    // 5. ARRÃŠTS TEMPORAIRES
    const kpiTempPause1 = byId('kpiTempPause1');
    const kpiTempPause2 = byId('kpiTempPause2');
    const kpiTempPauseEvol = byId('kpiTempPauseEvol');
    
    if (kpiTempPause1 && kpiTempPause2 && kpiTempPauseEvol) {
      kpiTempPause1.textContent = previous.tempPauses;
      kpiTempPause2.textContent = current.tempPauses;
      // Pour les arrÃªts, une augmentation est nÃ©gative
      const tempPauseEvol = calculateEvolution(previous.tempPauses, current.tempPauses, true);
      kpiTempPauseEvol.textContent = tempPauseEvol.text;
      kpiTempPauseEvol.className = `badge ${tempPauseEvol.class}`;
    }
    
    // 6. ARRÃŠTS DÃ‰FINITIFS
    const kpiPermPause1 = byId('kpiPermPause1');
    const kpiPermPause2 = byId('kpiPermPause2');
    const kpiPermPauseEvol = byId('kpiPermPauseEvol');
    
    if (kpiPermPause1 && kpiPermPause2 && kpiPermPauseEvol) {
      kpiPermPause1.textContent = previous.permPauses;
      kpiPermPause2.textContent = current.permPauses;
      // Pour les arrÃªts, une augmentation est nÃ©gative
      const permPauseEvol = calculateEvolution(previous.permPauses, current.permPauses, true);
      kpiPermPauseEvol.textContent = permPauseEvol.text;
      kpiPermPauseEvol.className = `badge ${permPauseEvol.class}`;
    }
    
    // 7. SCORE QUALITÃ‰
    const kpiScore1 = byId('kpiScore1');
    const kpiScore2 = byId('kpiScore2');
    const kpiScoreEvol = byId('kpiScoreEvol');
    
    if (kpiScore1 && kpiScore2 && kpiScoreEvol) {
      kpiScore1.textContent = previous.avgScore + '%';
      kpiScore2.textContent = current.avgScore + '%';
      const scoreEvol = calculateEvolution(previous.avgScore, current.avgScore);
      kpiScoreEvol.textContent = scoreEvol.text;
      kpiScoreEvol.className = `badge ${scoreEvol.class}`;
    }
    
    console.log('KPI comparison displayed successfully');
    
  } catch (error) {
    console.error('Error displaying KPI comparison:', error);
  }
}

function calculateEvolution(oldValue, newValue, inverseLogic = false) {
  if (oldValue === 0) {
    if (newValue > 0) {
      // Si inverseLogic=true (arrÃªts), une augmentation depuis 0 est mauvaise
      const badgeClass = inverseLogic ? 'badge-danger' : 'badge-success';
      return { text: `+${newValue} (nouveau)`, class: badgeClass };
    }
    return { text: 'Aucun changement', class: 'badge-secondary' };
  }
  
  const diff = newValue - oldValue;
  const percent = Math.round((diff / oldValue) * 100);
  
  if (diff > 0) {
    // Augmentation
    const badgeClass = inverseLogic ? 'badge-danger' : 'badge-success';
    return { text: `+${diff} (+${percent}%)`, class: badgeClass };
  } else if (diff < 0) {
    // Diminution
    const badgeClass = inverseLogic ? 'badge-success' : 'badge-danger';
    return { text: `${diff} (${percent}%)`, class: badgeClass };
  } else {
    return { text: 'Identique', class: 'badge-secondary' };
  }
}

function createComparisonChart(kpis, currentCycle, previousCycle) {
  console.log('Creating comparison chart...');
  
  const canvas = byId('comparisonChart');
  if (!canvas) {
    console.warn('Canvas element not found');
    return;
  }
  
  // Check if Chart.js is available
  if (typeof Chart === 'undefined') {
    console.error('Chart.js is not loaded');
    canvas.parentElement.innerHTML = `
      <div style="padding: 2rem; text-align: center; background: var(--bg-tertiary); border-radius: var(--radius-lg); border: 2px dashed var(--border);">
        <div style="font-size: 2rem; margin-bottom: 1rem;">ðŸ“Š</div>
        <p style="color: var(--text-secondary); margin-bottom: 0.5rem;">Impossible de charger les graphiques</p>
        <p style="color: var(--text-muted); font-size: 0.9rem;">La bibliothÃ¨que Chart.js n'a pas pu Ãªtre chargÃ©e. VÃ©rifiez votre connexion internet.</p>
      </div>
    `;
    return;
  }
  
  try {
    const ctx = canvas.getContext('2d');
    
    // Destroy existing chart if any
    if (window.statsChart) {
      window.statsChart.destroy();
    }
    
    const data = {
      labels: [
        'Patients actifs', 
        'EfficacitÃ© ordos (%)', 
        'Suivis', 
        'Switchs', 
        'ArrÃªts temp.', 
        'ArrÃªts dÃ©f.',
        'Score qualitÃ© (%)'
      ],
      datasets: [
        {
          label: `${previousCycle.name} ${previousCycle.year}`,
          data: [
            kpis.previous.patients, 
            kpis.previous.ordoCompletionRate, 
            kpis.previous.suivis, 
            kpis.previous.switchs,
            kpis.previous.tempPauses,
            kpis.previous.permPauses,
            kpis.previous.avgScore
          ],
          backgroundColor: 'rgba(102, 126, 234, 0.5)',
          borderColor: 'rgba(102, 126, 234, 1)',
          borderWidth: 2
        },
        {
          label: `${currentCycle.name} ${currentCycle.year}`,
          data: [
            kpis.current.patients, 
            kpis.current.ordoCompletionRate, 
            kpis.current.suivis, 
            kpis.current.switchs,
            kpis.current.tempPauses,
            kpis.current.permPauses,
            kpis.current.avgScore
          ],
          backgroundColor: 'rgba(118, 75, 162, 0.5)',
          borderColor: 'rgba(118, 75, 162, 1)',
          borderWidth: 2
        }
      ]
    };
    
    window.statsChart = new Chart(ctx, {
      type: 'bar',
      data: data,
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            position: 'top',
          },
          title: {
            display: false
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                let label = context.dataset.label || '';
                if (label) {
                  label += ': ';
                }
                // Ajouter le % pour efficacitÃ© ordos et score qualitÃ©
                if (context.dataIndex === 1 || context.dataIndex === 6) {
                  label += context.parsed.y + '%';
                } else {
                  label += context.parsed.y;
                }
                return label;
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Valeurs'
            }
          }
        }
      }
    });
    
    console.log('Chart created successfully');
    
  } catch (error) {
    console.error('Error creating comparison chart:', error);
    canvas.parentElement.innerHTML = `
      <div style="padding: 2rem; text-align: center; background: var(--bg-tertiary); border-radius: var(--radius-lg); border: 2px dashed var(--danger);">
        <div style="font-size: 2rem; margin-bottom: 1rem;">âš ï¸</div>
        <p style="color: var(--danger); margin-bottom: 0.5rem;">Erreur lors de la crÃ©ation du graphique</p>
        <p style="color: var(--text-muted); font-size: 0.9rem;">${error.message || 'Une erreur inattendue s\'est produite'}</p>
      </div>
    `;
  }
}

function updateCounters() {
  const activePatients = state.patients.filter(p => !p.status || p.status === 'active');
  const archivedPatients = state.patients.filter(p => p.status && p.status !== 'active');
  
  byId('countPatients').textContent = activePatients.length;
  byId('countArchived').textContent = archivedPatients.length;
  byId('countDocs').textContent = state.docs.length;
  byId('countCenters').textContent = state.centers.length;
  byId('countProtos').textContent = state.protos.length;
}

// ===== Patient CRUD =====
function newPatient() {
  currentPatientId = null;
  byId('modalTitle').textContent = 'Nouveau patient';
  byId('btnDeletePatient').classList.add('hidden');
  byId('btnChangeStatus').classList.add('hidden');
  
  // Reset form
  ['lastName', 'firstName', 'dob', 'email', 'phone', 'address', 'patientCode', 'notes'].forEach(id => {
    const el = byId(id);
    if (el) el.value = '';
  });
  
  // Suggest current date + 4 months for new patient
  const today = new Date();
  today.setMonth(today.getMonth() + 4);
  byId('renewalDate').value = formatDateFR(today);
  updateCycleInfo();
  
  ['docId', 'centerId', 'protoId'].forEach(id => {
    const el = byId(id);
    if (el) el.value = '';
  });
  
  populateSelects();
  showModal(true);
}



function viewPatientDetails(id) {
  const patient = state.patients.find(p => p.id === id);
  if (!patient) return;
  
  const score = qScore(patient);
  const scoreColor = score >= 80 ? 'var(--success)' : score >= 50 ? 'var(--warning)' : 'var(--danger)';
  const cycleInfo = getCycleFromDate(patient.renewalDate);
  const cycleLabel = cycleInfo ? `${cycleInfo.name} ${cycleInfo.year}` : 'Non dÃ©fini';
  
  const detailsContent = byId('patientDetailsContent');
  detailsContent.innerHTML = `
    <div style="display: grid; gap: 1.5rem;">
      ${patient.status && patient.status !== 'active' ? `
      <!-- Status Alert -->
      <div style="background: ${patient.status === 'temporary_pause' ? 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)' : 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)'}; color: white; padding: 1rem; border-radius: var(--radius); display: flex; align-items: center; gap: 1rem;">
        <div style="font-size: 2rem;">${patient.status === 'temporary_pause' ? 'â¸ï¸' : 'â›”'}</div>
        <div style="flex: 1;">
          <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.25rem;">
            ${patient.status === 'temporary_pause' ? 'ArrÃªt temporaire' : 'ArrÃªt dÃ©finitif'}
          </div>
          <div style="opacity: 0.9; font-size: 0.9rem;">
            ${patient.pausedAt ? 'Depuis le ' + new Date(patient.pausedAt).toLocaleDateString('fr-FR') : ''}
            ${patient.pauseReason ? ' - ' + patient.pauseReason : ''}
          </div>
        </div>
        <button class="btn" data-action="reactivate" data-patient-id="${patient.id}" style="background: white; color: var(--primary); font-weight: 600; white-space: nowrap;">
          RÃ©activer
        </button>
      </div>
      ` : ''}
      <!-- Informations principales -->
      <div class="info-section">
        <h3 style="color: var(--primary); margin-bottom: 1rem; font-size: 1.25rem;">
          ðŸ‘¤ Informations personnelles
        </h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
          <div class="info-item">
            <div class="info-label">Nom complet</div>
            <div class="info-value">${fullName(patient)}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Date de naissance</div>
            <div class="info-value">${patient.dob || 'â€”'}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Email</div>
            <div class="info-value">${patient.email || 'â€”'}</div>
          </div>
          <div class="info-item">
            <div class="info-label">TÃ©lÃ©phone</div>
            <div class="info-value">${patient.phone || 'â€”'}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Adresse</div>
            <div class="info-value">${patient.address || 'â€”'}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Code Patient</div>
            <div class="info-value" style="color: var(--primary); font-weight: 600;">${patient.patientCode || 'â€”'}</div>
          </div>
        </div>
      </div>
      
      <!-- Informations mÃ©dicales -->
      <div class="info-section">
        <h3 style="color: var(--primary); margin-bottom: 1rem; font-size: 1.25rem;">
          ðŸ¥ Informations mÃ©dicales
        </h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
          <div class="info-item">
            <div class="info-label">MÃ©decin</div>
            <div class="info-value">${docName(patient.docId) || 'â€”'}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Centre</div>
            <div class="info-value">${centerName(patient.centerId) || 'â€”'}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Protocole / MatÃ©riel</div>
            <div class="info-value">${protoName(patient.protoId) || 'â€”'}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Date de renouvellement</div>
            <div class="info-value">${patient.renewalDate || 'â€”'}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Cycle</div>
            <div class="info-value">${cycleLabel}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Score de qualitÃ©</div>
            <div class="info-value">
              <div style="display: flex; align-items: center; gap: 0.75rem;">
                <div class="progress" style="width: 120px; height: 8px;">
                  <div class="progress-bar" style="background: ${scoreColor}; width: ${score}%;"></div>
                </div>
                <span style="font-weight: 600; color: ${scoreColor};">${score}%</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Notes -->
      ${patient.notes ? `
      <div class="info-section">
        <h3 style="color: var(--primary); margin-bottom: 1rem; font-size: 1.25rem;">
          ðŸ“ Notes
        </h3>
        <div style="padding: 1rem; background: var(--bg-secondary); border-radius: var(--radius); border-left: 3px solid var(--primary);">
          ${patient.notes}
        </div>
      </div>
      ` : ''}
      
      <!-- Historique des modifications -->
      ${patient.history && patient.history.length > 0 ? `
      <div class="info-section">
        <h3 style="color: var(--primary); margin-bottom: 1rem; font-size: 1.25rem;">
          ðŸ“œ Historique des modifications
        </h3>
        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
          ${patient.history.slice().reverse().map(h => {
            const date = new Date(h.date).toLocaleDateString('fr-FR', { 
              day: '2-digit', 
              month: '2-digit', 
              year: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });
            
            let icon = 'ðŸ“';
            let color = 'var(--primary)';
            
            if (h.type === 'created') {
              icon = 'âœ¨';
              color = 'var(--success)';
            } else if (h.type === 'switch') {
              icon = 'ðŸ”„';
              color = 'var(--warning)';
            } else if (h.type === 'protocol') {
              icon = 'ðŸ’Š';
              color = 'var(--info)';
            } else if (h.type === 'doctor') {
              icon = 'ðŸ‘¨â€âš•ï¸';
              color = 'var(--primary)';
            } else if (h.type === 'center') {
              icon = 'ðŸ¥';
              color = 'var(--primary)';
            } else if (h.type === 'renewal') {
              icon = 'ðŸ“…';
              color = 'var(--secondary)';
            }
            
            return `
              <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: var(--radius); border-left: 3px solid ${color}; display: flex; gap: 1rem; align-items: start;">
                <span style="font-size: 1.5rem; flex-shrink: 0;">${icon}</span>
                <div style="flex: 1;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                    <strong style="color: ${color};">${h.field}</strong>
                    <span style="font-size: 0.85rem; color: var(--text-muted);">${date}</span>
                  </div>
                  ${h.type === 'created' ? `
                    <div style="font-size: 0.9rem; color: var(--text-secondary);">${h.newValue}</div>
                  ` : `
                    <div style="font-size: 0.9rem; color: var(--text-secondary);">
                      <span style="text-decoration: line-through; opacity: 0.7;">${h.oldValue}</span>
                      <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20" style="vertical-align: middle; margin: 0 0.5rem;">
                        <path fill-rule="evenodd" d="M10.293 15.707a1 1 0 010-1.414L14.586 10l-4.293-4.293a1 1 0 111.414-1.414l5 5a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                      </svg>
                      <span style="font-weight: 600;">${h.newValue}</span>
                    </div>
                  `}
                  ${h.notes ? `<div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.25rem;"><em>${h.notes}</em></div>` : ''}
                </div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
      ` : ''}
      
      <!-- Dates de gestion -->
      <div class="info-section">
        <h3 style="color: var(--text-muted); margin-bottom: 0.5rem; font-size: 0.9rem;">
          â„¹ï¸ Informations systÃ¨me
        </h3>
        <div style="display: flex; gap: 2rem; color: var(--text-muted); font-size: 0.85rem;">
          <div>CrÃ©Ã© le : ${patient.createdAt ? new Date(patient.createdAt).toLocaleDateString('fr-FR') : 'â€”'}</div>
          <div>ModifiÃ© le : ${patient.updatedAt ? new Date(patient.updatedAt).toLocaleDateString('fr-FR') : 'â€”'}</div>
        </div>
      </div>
    </div>
  `;
  
  // Store patient ID for edit button
  byId('btnEditFromDetails').onclick = () => {
    showModal(false, 'patientDetailsModal');
    openPatient(id);
  };
  
  showModal(true, 'patientDetailsModal');
}

function openPatient(id) {
  const patient = state.patients.find(p => p.id === id);
  if (!patient) return;

  currentPatientId = id;
  byId('modalTitle').textContent = 'Modifier le patient';
  byId('btnDeletePatient').classList.remove('hidden');
  byId('btnChangeStatus').classList.remove('hidden');

  // Populate selects FIRST so options are available
  populateSelects();

  // Fill form with patient data
  Object.keys(patient).forEach(key => {
    const el = byId(key);
    if (el) el.value = patient[key] || '';
  });

  updateCycleInfo();
  showModal(true);
}

function suggestRenewalDate() {
  const currentDate = byId('renewalDate').value;
  const suggestion = suggestNextRenewalDate(currentDate);
  byId('renewalDate').value = suggestion;
  updateCycleInfo();
  showToast(`Date suggÃ©rÃ©e: ${suggestion}`, 'info');
}

function updateCycleInfo() {
  const dateStr = byId('renewalDate').value;
  const cycleInfo = getCycleFromDate(dateStr);
  const infoEl = byId('cycleInfo');
  
  if (cycleInfo && infoEl) {
    infoEl.innerHTML = `
      <strong style="color: var(--primary);">${cycleInfo.name} ${cycleInfo.year}</strong> - ${cycleInfo.label}<br>
      Date de fin: ${formatDateFR(new Date(cycleInfo.year, cycleInfo.months[cycleInfo.months.length - 1], 0))}
    `;
  } else if (infoEl) {
    infoEl.textContent = 'Le cycle sera calculÃ© automatiquement selon la date';
  }
}

function savePatient() {
  const formData = {
    lastName: byId('lastName').value.trim(),
    firstName: byId('firstName').value.trim(),
    dob: byId('dob').value,
    email: byId('email').value.trim(),
    phone: byId('phone').value.trim(),
    address: byId('address').value.trim(),
    patientCode: byId('patientCode').value.trim(),
    docId: byId('docId').value,
    centerId: byId('centerId').value,
    protoId: byId('protoId').value,
    renewalDate: byId('renewalDate').value.trim(),
    notes: byId('notes').value.trim()
  };
  
  if (!formData.lastName || !formData.firstName) {
    showToast('Nom et prÃ©nom requis', 'error');
    return;
  }
  
  // Validate renewal date format
  if (formData.renewalDate && !formData.renewalDate.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
    showToast('Format de date invalide (JJ/MM/AAAA)', 'error');
    return;
  }
  
  if (currentPatientId) {
    // Update
    const index = state.patients.findIndex(p => p.id === currentPatientId);
    if (index !== -1) {
      const oldPatient = state.patients[index];
      
      // Initialize history array if it doesn't exist
      if (!oldPatient.history) {
        oldPatient.history = [];
      }
      
      // Track changes
      const changes = [];
      const now = Date.now();
      
      if (oldPatient.protoId !== formData.protoId) {
        changes.push({
          date: now,
          type: 'protocol',
          field: 'Protocole/MatÃ©riel',
          oldValue: protoName(oldPatient.protoId) || 'Non dÃ©fini',
          newValue: protoName(formData.protoId) || 'Non dÃ©fini'
        });
      }
      
      if (oldPatient.docId !== formData.docId) {
        changes.push({
          date: now,
          type: 'doctor',
          field: 'MÃ©decin',
          oldValue: docName(oldPatient.docId) || 'Non dÃ©fini',
          newValue: docName(formData.docId) || 'Non dÃ©fini'
        });
      }
      
      if (oldPatient.centerId !== formData.centerId) {
        changes.push({
          date: now,
          type: 'center',
          field: 'Centre',
          oldValue: centerName(oldPatient.centerId) || 'Non dÃ©fini',
          newValue: centerName(formData.centerId) || 'Non dÃ©fini'
        });
      }
      
      if (oldPatient.renewalDate !== formData.renewalDate) {
        changes.push({
          date: now,
          type: 'renewal',
          field: 'Date de renouvellement',
          oldValue: oldPatient.renewalDate || 'Non dÃ©finie',
          newValue: formData.renewalDate || 'Non dÃ©finie'
        });
      }
      
      // Add changes to history
      if (changes.length > 0) {
        state.patients[index].history = [...(oldPatient.history || []), ...changes];
      }
      
      state.patients[index] = { 
        ...state.patients[index], 
        ...formData, 
        updatedAt: now
      };
      showToast('Patient modifiÃ©', 'success');
    }
  } else {
    // Create
    const newPatient = {
      id: generateId(),
      ...formData,
      createdAt: Date.now(),
      updatedAt: Date.now(),
      history: [{
        date: Date.now(),
        type: 'created',
        field: 'CrÃ©ation',
        oldValue: '',
        newValue: 'Patient crÃ©Ã©'
      }]
    };
    state.patients.push(newPatient);
    showToast('Patient crÃ©Ã©', 'success');
  }
  
  saveDB();
  render();
  showModal(false);
}

function deletePatient() {
  if (!currentPatientId) return;
  
  if (confirm('Supprimer ce patient ?')) {
    state.patients = state.patients.filter(p => p.id !== currentPatientId);
    saveDB();
    render();
    showModal(false);
    showToast('Patient supprimÃ©', 'success');
  }
}

function pausePatient(patientId, pauseType) {
  const patient = state.patients.find(p => p.id === patientId);
  if (!patient) return;
  
  const typeLabel = pauseType === 'temporary_pause' ? 'temporaire' : 'dÃ©finitif';
  const icon = pauseType === 'temporary_pause' ? 'â¸ï¸' : 'â›”';
  const color = pauseType === 'temporary_pause' ? '#f59e0b' : '#ef4444';
  
  // Close modals
  showModal(false);
  closeStatusModal();
  
  // Create pause modal
  const existingModal = byId('pauseModal');
  if (existingModal) existingModal.remove();
  
  const modal = document.createElement('div');
  modal.id = 'pauseModal';
  modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 99999;';
  
  const today = new Date().toISOString().split('T')[0];
  
  modal.innerHTML = `
    <div style="background: var(--bg-primary); border-radius: var(--radius-lg); max-width: 500px; width: 90%; box-shadow: var(--shadow-xl);">
      <div style="padding: 1.5rem;">
        <h3 style="margin-bottom: 1rem; color: ${color}; display: flex; align-items: center; gap: 0.5rem;">
          <span style="font-size: 1.5rem;">${icon}</span>
          ArrÃªt ${typeLabel}
        </h3>
        <p style="margin-bottom: 1.5rem; color: var(--text-secondary);">
          <strong>${fullName(patient)}</strong>
        </p>
        
        <div style="display: flex; flex-direction: column; gap: 1rem;">
          <div>
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">
              Date d'arrÃªt <span style="color: #ef4444;">*</span>
            </label>
            <input type="date" id="pauseDate" value="${today}" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-primary); color: var(--text-primary);" required>
          </div>
          
          <div>
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">
              Raison (optionnel)
            </label>
            <textarea id="pauseReason" rows="3" placeholder="Ex: Hospitalisation, Vacances, DÃ©mÃ©nagement..." style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-primary); color: var(--text-primary); resize: vertical;"></textarea>
          </div>
        </div>
      </div>
      
      <div style="padding: 0 1.5rem 1.5rem; display: flex; gap: 0.5rem; justify-content: flex-end;">
        <button class="btn btn-secondary" id="btnCancelPause">Annuler</button>
        <button class="btn" id="btnConfirmPause" style="background: ${color}; color: white;">
          ${icon} Confirmer l'arrÃªt
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Focus on reason field
  setTimeout(() => byId('pauseReason')?.focus(), 100);
  
  // Event listeners
  byId('btnCancelPause').addEventListener('click', () => modal.remove());
  
  byId('btnConfirmPause').addEventListener('click', () => {
    const dateInput = byId('pauseDate');
    const reasonInput = byId('pauseReason');
    
    if (!dateInput.value) {
      showToast('Veuillez sÃ©lectionner une date', 'warning');
      dateInput.focus();
      return;
    }
    
    const selectedDate = new Date(dateInput.value + 'T12:00:00');
    
    patient.status = pauseType;
    patient.pausedAt = selectedDate.getTime();
    patient.pauseReason = reasonInput.value.trim() || '';
    patient.updatedAt = Date.now();
    
    saveDB();
    render();
    modal.remove();
    
    showToast(`${icon} Patient mis en arrÃªt ${typeLabel}`, 'success');
  });
  
  // Close on background click
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.remove();
    }
  });
  
  // Close on Escape
  const escHandler = (e) => {
    if (e.key === 'Escape') {
      modal.remove();
      document.removeEventListener('keydown', escHandler);
    }
  };
  document.addEventListener('keydown', escHandler);
}

function reactivatePatient(patientId) {
  const patient = state.patients.find(p => p.id === patientId);
  if (!patient) return;
  
  // Create reactivation modal
  const existingModal = byId('reactivateModal');
  if (existingModal) existingModal.remove();
  
  const modal = document.createElement('div');
  modal.id = 'reactivateModal';
  modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 99999;';
  
  const today = new Date().toISOString().split('T')[0];
  const pauseDate = patient.pausedAt ? new Date(patient.pausedAt).toLocaleDateString('fr-FR') : 'N/A';
  const statusLabel = patient.status === 'temporary_pause' ? 'â¸ï¸ ArrÃªt temporaire' : 'â›” ArrÃªt dÃ©finitif';
  
  modal.innerHTML = `
    <div style="background: var(--bg-primary); border-radius: var(--radius-lg); max-width: 500px; width: 90%; box-shadow: var(--shadow-xl);">
      <div style="padding: 1.5rem;">
        <h3 style="margin-bottom: 1rem; color: var(--success); display: flex; align-items: center; gap: 0.5rem;">
          <span style="font-size: 1.5rem;">âœ…</span>
          RÃ©activer le patient
        </h3>
        <p style="margin-bottom: 1rem; color: var(--text-secondary);">
          <strong>${fullName(patient)}</strong>
        </p>
        
        <div style="background: var(--bg-secondary); padding: 1rem; border-radius: var(--radius); margin-bottom: 1rem;">
          <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Statut actuel</div>
          <div style="font-weight: 600;">${statusLabel}</div>
          <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.25rem;">Depuis le ${pauseDate}</div>
          ${patient.pauseReason ? `<div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.25rem; font-style: italic;">Raison : ${patient.pauseReason}</div>` : ''}
        </div>
        
        <div style="display: flex; flex-direction: column; gap: 1rem;">
          <div>
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">
              Date de rÃ©activation <span style="color: #ef4444;">*</span>
            </label>
            <input type="date" id="reactivateDate" value="${today}" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-primary); color: var(--text-primary);" required>
          </div>
          
          <div>
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">
              Notes (optionnel)
            </label>
            <textarea id="reactivateNotes" rows="2" placeholder="Ex: Retour aprÃ¨s hospitalisation, fin des vacances..." style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-primary); color: var(--text-primary); resize: vertical;"></textarea>
          </div>
        </div>
      </div>
      
      <div style="padding: 0 1.5rem 1.5rem; display: flex; gap: 0.5rem; justify-content: flex-end;">
        <button class="btn btn-secondary" id="btnCancelReactivate">Annuler</button>
        <button class="btn btn-success" id="btnConfirmReactivate">
          âœ… Confirmer la rÃ©activation
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Focus on notes field
  setTimeout(() => byId('reactivateNotes')?.focus(), 100);
  
  // Event listeners
  byId('btnCancelReactivate').addEventListener('click', () => modal.remove());
  
  byId('btnConfirmReactivate').addEventListener('click', () => {
    const dateInput = byId('reactivateDate');
    const notesInput = byId('reactivateNotes');
    
    if (!dateInput.value) {
      showToast('Veuillez sÃ©lectionner une date', 'warning');
      dateInput.focus();
      return;
    }
    
    const selectedDate = new Date(dateInput.value + 'T12:00:00');
    
    patient.status = 'active';
    patient.reactivatedAt = selectedDate.getTime();
    patient.reactivateNotes = notesInput.value.trim() || '';
    patient.updatedAt = Date.now();
    
    saveDB();
    render();
    modal.remove();
    
    // Close status modal if open
    closeStatusModal();
    
    showToast('âœ… Patient rÃ©activÃ©', 'success');
  });
  
  // Close on background click
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.remove();
    }
  });
  
  // Close on Escape
  const escHandler = (e) => {
    if (e.key === 'Escape') {
      modal.remove();
      document.removeEventListener('keydown', escHandler);
    }
  };
  document.addEventListener('keydown', escHandler);
}

function changePatientStatus() {
  console.log('changePatientStatus called, currentPatientId:', currentPatientId);
  
  if (!currentPatientId) {
    console.error('No currentPatientId');
    showToast('Erreur: Aucun patient sÃ©lectionnÃ©', 'error');
    return;
  }
  
  const patient = state.patients.find(p => p.id === currentPatientId);
  if (!patient) {
    console.error('Patient not found:', currentPatientId);
    showToast('Erreur: Patient non trouvÃ©', 'error');
    return;
  }
  
  console.log('Patient found:', patient.lastName, patient.firstName);
  
  // Close the patient modal first
  const patientModal = byId('patientModal');
  if (patientModal) {
    patientModal.classList.remove('active');
  }
  
  const currentStatus = patient.status || 'active';
  const statusLabel = currentStatus === 'active' ? 'âœ… Actif' : 
                      currentStatus === 'temporary_pause' ? 'â¸ï¸ ArrÃªt temporaire' : 
                      'â›” ArrÃªt dÃ©finitif';
  
  // Remove existing modal if any
  const existingModal = byId('statusChangeModal');
  if (existingModal) existingModal.remove();
  
  // Create modal
  const modal = document.createElement('div');
  modal.id = 'statusChangeModal';
  modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 99999;';
  
  const modalContent = document.createElement('div');
  modalContent.style.cssText = 'background: var(--bg-primary); border-radius: var(--radius-lg); max-width: 500px; width: 90%; box-shadow: var(--shadow-xl);';
  modalContent.innerHTML = `
    <div style="padding: 1.5rem;">
      <h3 style="margin-bottom: 1rem; color: var(--primary);">Changer le statut du patient</h3>
      <p style="margin-bottom: 1rem; color: var(--text-secondary);">
        <strong>${fullName(patient)}</strong><br>
        Statut actuel : <strong>${statusLabel}</strong>
      </p>
      <div style="display: flex; flex-direction: column; gap: 0.75rem;">
        <button class="btn btn-success" id="btnStatusActive" style="justify-content: flex-start; width: 100%;">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
          Actif
        </button>
        <button class="btn btn-warning" id="btnStatusTemporary" style="justify-content: flex-start; width: 100%; background: #f59e0b;">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
          ArrÃªt temporaire
        </button>
        <button class="btn btn-danger" id="btnStatusPermanent" style="justify-content: flex-start; width: 100%;">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>
          ArrÃªt dÃ©finitif
        </button>
      </div>
    </div>
    <div style="padding: 0 1.5rem 1.5rem; text-align: right;">
      <button class="btn btn-secondary" id="btnStatusCancel">Annuler</button>
    </div>
  `;
  
  modal.appendChild(modalContent);
  document.body.appendChild(modal);
  
  // Attach event listeners to buttons AFTER adding to DOM
  const btnActive = byId('btnStatusActive');
  const btnTemporary = byId('btnStatusTemporary');
  const btnPermanent = byId('btnStatusPermanent');
  const btnCancel = byId('btnStatusCancel');
  
  if (btnActive) {
    btnActive.addEventListener('click', () => {
      console.log('Active button clicked');
      handleStatusChange(currentPatientId, 'active');
    });
  }
  
  if (btnTemporary) {
    btnTemporary.addEventListener('click', () => {
      console.log('Temporary button clicked');
      handleStatusChange(currentPatientId, 'temporary_pause');
    });
  }
  
  if (btnPermanent) {
    btnPermanent.addEventListener('click', () => {
      console.log('Permanent button clicked');
      handleStatusChange(currentPatientId, 'permanent_pause');
    });
  }
  
  if (btnCancel) {
    btnCancel.addEventListener('click', () => {
      console.log('Cancel button clicked');
      closeStatusModal();
    });
  }
  
  // Close on background click
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.remove();
    }
  });
  
  console.log('Status modal created and displayed with event listeners');
}

function closeStatusModal() {
  const modal = byId('statusChangeModal');
  if (modal) modal.remove();
}

function handleStatusChange(patientId, newStatus) {
  console.log('handleStatusChange called:', patientId, newStatus);
  
  const patient = state.patients.find(p => p.id === patientId);
  if (!patient) {
    console.error('Patient not found in handleStatusChange');
    return;
  }
  
  const currentStatus = patient.status || 'active';
  
  // Close the status modal
  closeStatusModal();
  
  // If already in this status, just show message
  if (currentStatus === newStatus) {
    showToast('Le patient est dÃ©jÃ  dans ce statut', 'info');
    return;
  }
  
  // If setting to active, call reactivate
  if (newStatus === 'active') {
    reactivatePatient(patientId);
  } else {
    // Ask for pause reason
    pausePatient(patientId, newStatus);
  }
}

function populateSelects() {
  // Doctors
  const docSelect = byId('docId');
  if (docSelect) {
    const current = docSelect.value;
    docSelect.innerHTML = '<option value="">-- SÃ©lectionner --</option>' +
      state.docs.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
    docSelect.value = current;
  }
  
  // Centers
  const centerSelect = byId('centerId');
  if (centerSelect) {
    const current = centerSelect.value;
    centerSelect.innerHTML = '<option value="">-- SÃ©lectionner --</option>' +
      state.centers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    centerSelect.value = current;
  }
  
  // Protocols
  const protoSelect = byId('protoId');
  if (protoSelect) {
    const current = protoSelect.value;
    protoSelect.innerHTML = '<option value="">-- SÃ©lectionner --</option>' +
      state.protos.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
    protoSelect.value = current;
  }
}

// ===== Fast Check Functions =====
function fcOpen() {
  console.log('fcOpen called');
  console.log('state.patients:', state.patients);
  
  try {
    fcState.list = [...state.patients];
    fcState.index = 0;
    
    console.log('fcState.list:', fcState.list);
    
    if (fcState.list.length === 0) {
      showToast('Aucun patient Ã  vÃ©rifier', 'warning');
      return;
    }
    
    fcDisplay();
    console.log('About to show fastModal');
    showModal(true, 'fastModal');
    console.log('fastModal should be shown');
  } catch (error) {
    console.error('Error in fcOpen:', error);
    showToast('Erreur lors de l\'ouverture du Fast Check', 'error');
  }
}

function fcDisplay() {
  if (fcState.index >= fcState.list.length) {
    fcClose();
    showToast('VÃ©rification terminÃ©e !', 'success');
    return;
  }
  
  const patient = fcState.list[fcState.index];
  byId('fcPatient').textContent = fullName(patient);
  byId('fcOrdo').value = patient.renewalDate || '';
  byId('fcCycle').textContent = formatCycleLabel(patient.renewalDate || '') || 'â€”';
  byId('fcIndex').textContent = fcState.index + 1;
  byId('fcTotal').textContent = fcState.list.length;
  
  // Afficher le code patient
  const codeDisplay = byId('fcCodeDisplay');
  const codeInput = byId('fcCodeInput');
  const btnOrdonnance = byId('fcOrdonnance');
  const btnEditCode = byId('fcEditCode');
  const btnSaveCode = byId('fcSaveCode');
  const codeInputContainer = byId('fcCodeInputContainer');
  
  if (patient.patientCode) {
    codeDisplay.textContent = patient.patientCode;
    codeInput.value = patient.patientCode;
    btnOrdonnance.disabled = false;
  } else {
    codeDisplay.textContent = 'Non dÃ©fini';
    codeInput.value = '';
    btnOrdonnance.disabled = true;
  }
  
  // RÃ©initialiser l'affichage du formulaire de code
  codeInputContainer.style.display = 'none';
  btnEditCode.classList.remove('hidden');
  btnSaveCode.classList.add('hidden');
  
  const progress = ((fcState.index + 1) / fcState.list.length) * 100;
  byId('fcProgress').style.width = progress + '%';
  
  byId('fcCorrect').classList.remove('hidden');
  byId('fcUpdate').classList.add('hidden');
}

function fcPrev() {
  if (fcState.index > 0) {
    fcState.index--;
    fcDisplay();
  }
}

function fcNext() {
  fcState.index++;
  fcDisplay();
}

function fcCorrect() {
  const patient = fcState.list[fcState.index];
  // Vider le champ pour permettre une nouvelle saisie
  byId('fcOrdo').value = '';
  byId('fcOrdo').focus();
  byId('fcCorrect').classList.add('hidden');
  byId('fcUpdate').classList.remove('hidden');
}

function fcUpdate() {
  const patient = fcState.list[fcState.index];
  const newDate = byId('fcOrdo').value.trim();
  
  const realIndex = state.patients.findIndex(p => p.id === patient.id);
  if (realIndex !== -1) {
    state.patients[realIndex].renewalDate = newDate;
    saveDB();
  }
  
  fcNext();
}

function fcClose() {
  showModal(false, 'fastModal');
  render();
}

function fcCopy() {
  const patient = fcState.list[fcState.index];
  const name = fullName(patient);
  
  // Copier dans le presse-papier
  navigator.clipboard.writeText(name).then(() => {
    showToast(`"${name}" copiÃ© dans le presse-papier`, 'success');
  }).catch(() => {
    // Fallback pour les navigateurs qui ne supportent pas l'API clipboard
    const textarea = document.createElement('textarea');
    textarea.value = name;
    textarea.style.position = 'fixed';
    textarea.style.opacity = '0';
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
    showToast(`"${name}" copiÃ© dans le presse-papier`, 'success');
  });
}

function fcEditCode() {
  const codeInputContainer = byId('fcCodeInputContainer');
  const btnEditCode = byId('fcEditCode');
  const btnSaveCode = byId('fcSaveCode');
  
  codeInputContainer.style.display = 'block';
  btnEditCode.classList.add('hidden');
  btnSaveCode.classList.remove('hidden');
  byId('fcCodeInput').focus();
}

function fcSaveCode() {
  const patient = fcState.list[fcState.index];
  const newCode = byId('fcCodeInput').value.trim();
  
  // Trouver le patient dans la liste principale et mettre Ã  jour
  const realIndex = state.patients.findIndex(p => p.id === patient.id);
  if (realIndex !== -1) {
    state.patients[realIndex].patientCode = newCode;
    patient.patientCode = newCode;
    saveDB();
  }
  
  // Mettre Ã  jour l'affichage
  byId('fcCodeDisplay').textContent = newCode || 'Non dÃ©fini';
  byId('fcOrdonnance').disabled = !newCode;
  
  // Cacher le formulaire d'Ã©dition
  byId('fcCodeInputContainer').style.display = 'none';
  byId('fcEditCode').classList.remove('hidden');
  byId('fcSaveCode').classList.add('hidden');
  
  showToast(newCode ? 'Code patient enregistrÃ©' : 'Code patient supprimÃ©', 'success');
}

function fcOpenOrdonnance() {
  const patient = fcState.list[fcState.index];
  
  if (!patient.patientCode) {
    showToast('Code patient non dÃ©fini', 'warning');
    return;
  }
  
  const url = `https://documentsnhc.proginov.fr/fiche-patient/xpatient${patient.patientCode}.html`;
  window.open(url, '_blank');
  showToast('Ordonnance ouverte dans un nouvel onglet', 'success');
}

// ===== Import/Export Functions =====
function exportJson() {
  const backup = {
    version: '4.0',
    exportDate: new Date().toISOString(),
    data: state  // Include ALL state data (patients, docs, centers, protos, switches, appointments)
  };

  // Count history events for verification
  const patientHistoryCount = state.patients.reduce((total, p) => total + (p.history?.length || 0), 0);
  const appointmentHistoryCount = state.appointments.reduce((total, a) => total + (a.history?.length || 0), 0);
  const totalHistoryEvents = patientHistoryCount + appointmentHistoryCount;

  console.log('ðŸ“¦ Exporting backup with:', {
    version: backup.version,
    exportDate: backup.exportDate,
    patients: state.patients?.length || 0,
    docs: state.docs?.length || 0,
    centers: state.centers?.length || 0,
    protos: state.protos?.length || 0,
    switches: state.switches?.length || 0,
    appointments: state.appointments?.length || 0,
    patientHistoryEvents: patientHistoryCount,
    appointmentHistoryEvents: appointmentHistoryCount,
    totalHistoryEvents: totalHistoryEvents
  });

  const data = JSON.stringify(backup, null, 2);
  const blob = new Blob([data], { type: 'application/json' });
  const url = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.download = `nhc-care-backup-${new Date().toISOString().split('T')[0]}.json`;
  a.click();

  URL.revokeObjectURL(url);

  // Detailed success message
  const message = `âœ… Export rÃ©ussi !\n${state.patients.length} patients (${patientHistoryCount} Ã©vÃ©nements historique)\n${state.appointments.length} rendez-vous (${appointmentHistoryCount} Ã©vÃ©nements)\nTotal: ${totalHistoryEvents} Ã©vÃ©nements sauvegardÃ©s`;
  showToast(message, 'success');
}

function exportRefs() {
  const refs = {
    docs: state.docs,
    centers: state.centers,
    protos: state.protos
  };
  
  const data = JSON.stringify(refs, null, 2);
  const blob = new Blob([data], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  
  const a = document.createElement('a');
  a.href = url;
  a.download = `nhc-care-refs-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  
  URL.revokeObjectURL(url);
  showToast('RÃ©fÃ©rentiels exportÃ©s', 'success');
}

function exportToExcel() {
  try {
    // Check if patients exist
    if (!state.patients || state.patients.length === 0) {
      showToast('Aucun patient Ã  exporter', 'warning');
      return;
    }

    // PrÃ©parer les donnÃ©es des patients
    const sortBy = byId('sortPatients')?.value || 'name';
    let sorted = [...state.patients];

    // Appliquer le tri actuel
    if (sortBy === 'name') {
      sorted.sort((a, b) => fullName(a).localeCompare(fullName(b)));
    } else if (sortBy === 'recent') {
      sorted.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
    } else if (sortBy === 'renewal') {
      sorted.sort((a, b) => {
        const dateA = parseDate(a.renewalDate);
        const dateB = parseDate(b.renewalDate);
        if (!dateA && !dateB) return 0;
        if (!dateA) return 1;
        if (!dateB) return -1;
        return dateA - dateB;
      });
    } else if (sortBy === 'doctor') {
      sorted.sort((a, b) => (docName(a.docId) || 'ZZZ').localeCompare(docName(b.docId) || 'ZZZ'));
    } else if (sortBy === 'center') {
      sorted.sort((a, b) => (centerName(a.centerId) || 'ZZZ').localeCompare(centerName(b.centerId) || 'ZZZ'));
    } else if (sortBy === 'protocol') {
      sorted.sort((a, b) => (protoName(a.protoId) || 'ZZZ').localeCompare(protoName(b.protoId) || 'ZZZ'));
    }

    // CrÃ©er le CSV avec BOM pour Excel
    const BOM = '\uFEFF';
    let csv = BOM + 'Nom;PrÃ©nom;Date de naissance;Email;TÃ©lÃ©phone;Adresse;MÃ©decin;Centre;MatÃ©riel/Protocole;Date de renouvellement;Cycle;Notes\n';

    sorted.forEach(p => {
      const cycleInfo = getCycleFromDate(p.renewalDate);
      const cycleLabel = cycleInfo ? `${cycleInfo.name} ${cycleInfo.year}` : '';

      const row = [
        p.lastName || '',
        p.firstName || '',
        p.dob || '',
        p.email || '',
        p.phone || '',
        p.address || '',
        docName(p.docId) || '',
        centerName(p.centerId) || '',
        protoName(p.protoId) || '',
        p.renewalDate || '',
        cycleLabel,
        (p.notes || '').replace(/"/g, '""').replace(/\n/g, ' ')
      ];

      csv += row.map(field => `"${field}"`).join(';') + '\n';
    });

    // CrÃ©er le fichier et le tÃ©lÃ©charger
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = `patients-nhc-care-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();

    URL.revokeObjectURL(url);
    showToast(`âœ… ${sorted.length} patient(s) exportÃ©(s) vers Excel`, 'success');
  } catch (error) {
    console.error('Error exporting to Excel:', error);
    showToast('âŒ Erreur lors de l\'export Excel: ' + error.message, 'error');
  }
}

// ===== Switch Management System =====
function openSwitchModal(switchId = null) {
  currentSwitchId = switchId;
  
  // Populate patient select
  const patientSelect = byId('switchPatientId');
  patientSelect.innerHTML = '<option value="">-- SÃ©lectionner un patient --</option>' +
    state.patients.map(p => `<option value="${p.id}">${fullName(p)}</option>`).join('');
  
  // Populate protocol select
  const protoSelect = byId('switchNewProtoId');
  protoSelect.innerHTML = '<option value="">-- SÃ©lectionner --</option>' +
    state.protos.map(pr => `<option value="${pr.id}">${pr.name}</option>`).join('');
  
  if (switchId) {
    // Edit mode
    const sw = state.switches.find(s => s.id === switchId);
    if (!sw) return;
    
    byId('switchModalTitle').textContent = 'Modifier le Switch';
    byId('btnDeleteSwitch').classList.remove('hidden');
    
    byId('switchPatientId').value = sw.patientId;
    updateSwitchOldProto();
    byId('switchNewProtoId').value = sw.newProtoId;
    byId('switchDate').value = sw.switchDate;
    byId('switchStatus').value = sw.status;
    byId('switchNotes').value = sw.notes || '';
  } else {
    // New mode
    byId('switchModalTitle').textContent = 'Nouveau Switch de Pompe';
    byId('btnDeleteSwitch').classList.add('hidden');
    
    byId('switchPatientId').value = '';
    byId('switchOldProto').value = '';
    byId('switchNewProtoId').value = '';
    byId('switchDate').value = '';
    byId('switchStatus').value = 'planned';
    byId('switchNotes').value = '';
  }
  
  showModal(true, 'switchModal');
}

function updateSwitchOldProto() {
  const patientId = byId('switchPatientId').value;
  const patient = state.patients.find(p => p.id === patientId);
  
  if (patient && patient.protoId) {
    byId('switchOldProto').value = protoName(patient.protoId);
  } else {
    byId('switchOldProto').value = 'Aucun protocole dÃ©fini';
  }
}

function saveSwitch() {
  const formData = {
    patientId: byId('switchPatientId').value,
    newProtoId: byId('switchNewProtoId').value,
    switchDate: byId('switchDate').value.trim(),
    status: byId('switchStatus').value,
    notes: byId('switchNotes').value.trim()
  };
  
  if (!formData.patientId || !formData.newProtoId || !formData.switchDate) {
    showToast('Patient, nouveau protocole et date requis', 'error');
    return;
  }
  
  // Validate date format
  if (!formData.switchDate.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
    showToast('Format de date invalide (JJ/MM/AAAA)', 'error');
    return;
  }

  // Validate date is a real date
  const dateParts = formData.switchDate.split('/');
  const day = parseInt(dateParts[0], 10);
  const month = parseInt(dateParts[1], 10);
  const year = parseInt(dateParts[2], 10);
  const switchDate = new Date(year, month - 1, day);

  if (isNaN(switchDate.getTime()) ||
      switchDate.getDate() !== day ||
      switchDate.getMonth() !== (month - 1) ||
      switchDate.getFullYear() !== year) {
    showToast('Date invalide. VÃ©rifiez le jour, mois et annÃ©e.', 'error');
    return;
  }

  // Warn if date is more than 2 years in the past (except for completed switches)
  if (formData.status !== 'completed') {
    const twoYearsAgo = new Date();
    twoYearsAgo.setFullYear(twoYearsAgo.getFullYear() - 2);
    if (switchDate < twoYearsAgo) {
      if (!confirm('âš ï¸ La date du switch est ancienne (> 2 ans). ÃŠtes-vous sÃ»r de vouloir continuer ?')) {
        return;
      }
    }
  }

  const patient = state.patients.find(p => p.id === formData.patientId);
  
  // VÃ©rifier que le patient existe
  if (!patient) {
    showToast('Patient introuvable. Veuillez sÃ©lectionner un patient valide.', 'error');
    return;
  }
  
  if (currentSwitchId) {
    // Update existing switch
    const index = state.switches.findIndex(s => s.id === currentSwitchId);
    if (index !== -1) {
      const oldStatus = state.switches[index].status;
      state.switches[index] = {
        ...state.switches[index],
        ...formData,
        oldProtoId: patient.protoId,
        updatedAt: Date.now()
      };
      
      // If status changed to completed, update patient
      if (oldStatus !== 'completed' && formData.status === 'completed') {
        applySwitch(currentSwitchId);
      }
      
      showToast('Switch modifiÃ©', 'success');
    }
  } else {
    // Create new switch
    const newSwitch = {
      id: generateId(),
      ...formData,
      oldProtoId: patient.protoId,
      createdAt: Date.now(),
      updatedAt: Date.now()
    };
    
    state.switches.push(newSwitch);
    
    // If status is completed, apply immediately
    if (formData.status === 'completed') {
      applySwitch(newSwitch.id);
    }
    
    showToast('Switch crÃ©Ã©', 'success');
  }
  
  saveDB();
  renderSwitches();
  updateCounters();
  showModal(false, 'switchModal');
}

function applySwitch(switchId) {
  const sw = state.switches.find(s => s.id === switchId);
  if (!sw) return;
  
  const patientIndex = state.patients.findIndex(p => p.id === sw.patientId);
  if (patientIndex === -1) return;
  
  const patient = state.patients[patientIndex];
  const now = Date.now();
  
  // Initialize history if doesn't exist
  if (!patient.history) {
    patient.history = [];
  }
  
  // Add switch to history
  patient.history.push({
    date: now,
    type: 'switch',
    field: 'Switch de pompe',
    oldValue: protoName(sw.oldProtoId) || 'Non dÃ©fini',
    newValue: protoName(sw.newProtoId),
    notes: sw.notes
  });
  
  // Update patient protocol and renewal date
  state.patients[patientIndex].protoId = sw.newProtoId;
  state.patients[patientIndex].renewalDate = sw.switchDate;
  state.patients[patientIndex].updatedAt = now;
  
  // Mark switch as completed
  sw.status = 'completed';
  sw.completedAt = now;
  
  saveDB();
}

function validateSwitch(switchId) {
  const sw = state.switches.find(s => s.id === switchId);
  if (!sw) return;
  
  const patient = state.patients.find(p => p.id === sw.patientId);
  if (!patient) return;
  
  // Store current switch ID for validation
  window.currentValidatingSwitchId = switchId;
  
  // Display switch info
  const info = `
    <strong>Patient :</strong> ${patient.firstName} ${patient.lastName}<br>
    <strong>Switch :</strong> ${protoName(sw.oldProtoId) || 'Non dÃ©fini'} â†’ ${protoName(sw.newProtoId)}<br>
    <strong>Date prÃ©vue :</strong> ${sw.switchDate}
  `;
  byId('validateSwitchInfo').innerHTML = info;
  
  // Reset modal state
  byId('prescriptionDateInput').style.display = 'none';
  byId('prescriptionNoInfo').style.display = 'none';
  byId('prescriptionRenewalDate').value = '';
  byId('btnPrescYes').classList.remove('btn-primary');
  byId('btnPrescYes').classList.add('btn-secondary');
  byId('btnPrescNo').classList.remove('btn-primary');
  byId('btnPrescNo').classList.add('btn-secondary');
  byId('btnConfirmValidateSwitch').disabled = true;
  
  // Show modal
  showModal(true, 'validateSwitchModal');
}

function selectPrescriptionOption(option) {
  // Update button states
  if (option === 'yes') {
    byId('btnPrescYes').classList.remove('btn-secondary');
    byId('btnPrescYes').classList.add('btn-primary');
    byId('btnPrescNo').classList.remove('btn-primary');
    byId('btnPrescNo').classList.add('btn-secondary');
    
    // Show date input
    byId('prescriptionDateInput').style.display = 'block';
    byId('prescriptionNoInfo').style.display = 'none';
    
    // Disable confirm button until date is entered
    byId('btnConfirmValidateSwitch').disabled = true;
    
    // Add event listener for date input
    byId('prescriptionRenewalDate').addEventListener('input', function() {
      const dateValue = this.value.trim();
      const isValidDate = /^\d{2}\/\d{2}\/\d{4}$/.test(dateValue);
      byId('btnConfirmValidateSwitch').disabled = !isValidDate;
    });
    
  } else if (option === 'no') {
    byId('btnPrescNo').classList.remove('btn-secondary');
    byId('btnPrescNo').classList.add('btn-primary');
    byId('btnPrescYes').classList.remove('btn-primary');
    byId('btnPrescYes').classList.add('btn-secondary');
    
    // Hide date input, show info
    byId('prescriptionDateInput').style.display = 'none';
    byId('prescriptionNoInfo').style.display = 'block';
    
    // Enable confirm button
    byId('btnConfirmValidateSwitch').disabled = false;
  }
}

function confirmValidateSwitch() {
  const switchId = window.currentValidatingSwitchId;
  if (!switchId) return;
  
  const sw = state.switches.find(s => s.id === switchId);
  if (!sw) return;
  
  // Determine renewal date based on prescription option
  let renewalDate;
  const hasPrescription = byId('btnPrescYes').classList.contains('btn-primary');
  
  if (hasPrescription) {
    // Use the date entered by user
    renewalDate = byId('prescriptionRenewalDate').value.trim();
    
    // Validate date format
    if (!renewalDate || !/^\d{2}\/\d{2}\/\d{4}$/.test(renewalDate)) {
      showToast('Veuillez entrer une date valide au format JJ/MM/AAAA', 'error');
      return;
    }
  } else {
    // Use switch date
    renewalDate = sw.switchDate;
  }
  
  // Apply switch with custom renewal date
  applySwitchWithRenewalDate(switchId, renewalDate, hasPrescription);
  
  // Close modal
  showModal(false, 'validateSwitchModal');
  
  // Refresh views
  renderSwitches();
  updateCounters();
  render();
  
  // Show success message
  const message = hasPrescription 
    ? `Switch validÃ© avec ordonnance initiale. Date de renouvellement : ${renewalDate}` 
    : `Switch validÃ©. Date de renouvellement dÃ©finie Ã  la date du switch : ${renewalDate}`;
  showToast(message, 'success');
}

function applySwitchWithRenewalDate(switchId, renewalDate, hasPrescription) {
  const sw = state.switches.find(s => s.id === switchId);
  if (!sw) return;
  
  const patientIndex = state.patients.findIndex(p => p.id === sw.patientId);
  if (patientIndex === -1) return;
  
  const patient = state.patients[patientIndex];
  const now = Date.now();
  
  // Initialize history if doesn't exist
  if (!patient.history) {
    patient.history = [];
  }
  
  // Add switch to history with prescription info
  const historyNotes = hasPrescription 
    ? `${sw.notes || ''}\nâœ… Ordonnance initiale effectuÃ©e - Renouvellement : ${renewalDate}`.trim()
    : `${sw.notes || ''}\nâš ï¸ Pas d'ordonnance initiale - Renouvellement Ã  la date du switch`.trim();
  
  patient.history.push({
    date: now,
    type: 'switch',
    field: 'Switch de pompe',
    oldValue: protoName(sw.oldProtoId) || 'Non dÃ©fini',
    newValue: protoName(sw.newProtoId),
    notes: historyNotes
  });
  
  // Update patient protocol and renewal date
  state.patients[patientIndex].protoId = sw.newProtoId;
  state.patients[patientIndex].renewalDate = renewalDate;
  state.patients[patientIndex].updatedAt = now;
  
  // Calculate cycle from renewal date
  if (renewalDate) {
    const cycleInfo = getCycleFromDate(renewalDate);
    if (cycleInfo) {
      state.patients[patientIndex].currentCycle = `C${cycleInfo.cycle}-${cycleInfo.year}`;
    }
  }
  
  // Mark switch as completed
  sw.status = 'completed';
  sw.completedAt = now;
  
  saveDB();
}


function deleteSwitch() {
  if (!currentSwitchId) return;
  
  if (!confirm('Supprimer ce switch ?')) return;
  
  state.switches = state.switches.filter(s => s.id !== currentSwitchId);
  saveDB();
  renderSwitches();
  updateCounters();
  showModal(false, 'switchModal');
  showToast('Switch supprimÃ©', 'success');
}

// ===== Timeline View Functions =====
let currentSwitchView = 'list'; // 'list' or 'timeline'

function toggleSwitchView(view) {
  currentSwitchView = view;
  
  const listView = byId('listViewContainer');
  const timelineView = byId('timelineViewContainer');
  const btnList = byId('btnListView');
  const btnTimeline = byId('btnTimelineView');
  
  if (view === 'timeline') {
    listView.style.display = 'none';
    timelineView.style.display = 'block';
    btnList.classList.remove('btn-primary');
    btnList.classList.add('btn-secondary');
    btnTimeline.classList.remove('btn-secondary');
    btnTimeline.classList.add('btn-primary');
    renderTimeline();
  } else {
    listView.style.display = 'block';
    timelineView.style.display = 'none';
    btnTimeline.classList.remove('btn-primary');
    btnTimeline.classList.add('btn-secondary');
    btnList.classList.remove('btn-secondary');
    btnList.classList.add('btn-primary');
  }
}

function renderTimeline() {
  const now = new Date();
  const currentMonth = now.getMonth();
  const currentYear = now.getFullYear();
  
  // Get month name
  const monthNames = ['Janvier', 'FÃ©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 
                      'Juillet', 'AoÃ»t', 'Septembre', 'Octobre', 'Novembre', 'DÃ©cembre'];
  
  // Calculate 3-month sliding window: 1 month before and 2 months after current date
  const startDate = new Date(currentYear, currentMonth - 1, 1); // 1 mois avant
  const endDate = new Date(currentYear, currentMonth + 3, 0); // 2 mois aprÃ¨s (fin du dernier jour)
  
  // Format period display
  const startMonthName = monthNames[startDate.getMonth()];
  const startYear = startDate.getFullYear();
  const endMonthName = monthNames[endDate.getMonth()];
  const endYear = endDate.getFullYear();
  
  const periodName = startYear === endYear 
    ? `${startMonthName} - ${endMonthName} ${endYear}`
    : `${startMonthName} ${startYear} - ${endMonthName} ${endYear}`;
  
  byId('timelineMonth').textContent = periodName;
  byId('timelineMonthDisplay').textContent = `PÃ©riode affichÃ©e : ${periodName} (3 mois glissants)`;
  
  // Get all switches for the 3-month period
  const periodSwitches = state.switches.filter(sw => {
    const swDate = parseDate(sw.switchDate);
    return swDate && swDate >= startDate && swDate <= endDate;
  });
  
  // Sort by date
  periodSwitches.sort((a, b) => {
    const dateA = parseDate(a.switchDate);
    const dateB = parseDate(b.switchDate);
    return dateA - dateB;
  });
  
  const container = byId('timelineContent');
  
  if (periodSwitches.length === 0) {
    container.innerHTML = `
      <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
        <svg width="64" height="64" fill="currentColor" viewBox="0 0 20 20" style="opacity: 0.3; margin-bottom: 1rem;">
          <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
        </svg>
        <p style="font-size: 18px; margin-bottom: 0.5rem;">Aucun switch prÃ©vu sur cette pÃ©riode</p>
        <p style="font-size: 14px;">Les switches planifiÃ©s apparaÃ®tront ici</p>
      </div>
    `;
    return;
  }
  
  // Group switches by month for better organization
  const switchesByMonth = {};
  periodSwitches.forEach(sw => {
    const swDate = parseDate(sw.switchDate);
    const monthKey = `${swDate.getFullYear()}-${String(swDate.getMonth()).padStart(2, '0')}`;
    if (!switchesByMonth[monthKey]) {
      switchesByMonth[monthKey] = {
        month: swDate.getMonth(),
        year: swDate.getFullYear(),
        switches: []
      };
    }
    switchesByMonth[monthKey].switches.push(sw);
  });
  
  // Build timeline HTML
  let html = '<div style="position: relative; padding-left: 100px;">';
  
  // Timeline line
  html += '<div style="position: absolute; left: 60px; top: 0; bottom: 0; width: 4px; background: linear-gradient(180deg, var(--border) 0%, var(--primary) 50%, var(--border) 100%);"></div>';
  
  // Render switches grouped by month
  Object.keys(switchesByMonth).sort().forEach((monthKey, groupIndex) => {
    const group = switchesByMonth[monthKey];
    const groupMonthName = `${monthNames[group.month]} ${group.year}`;
    const isCurrentMonth = group.month === currentMonth && group.year === currentYear;
    
    // Sort switches within the month by date
    group.switches.sort((a, b) => {
      const dateA = parseDate(a.switchDate);
      const dateB = parseDate(b.switchDate);
      return dateA - dateB;
    });
    
    // Month separator
    html += `
      <div style="position: relative; margin: ${groupIndex > 0 ? '2.5rem' : '0'} 0 1.5rem 0;">
        <div style="display: inline-block; background: ${isCurrentMonth ? 'var(--primary)' : 'var(--bg-tertiary)'}; color: ${isCurrentMonth ? 'white' : 'var(--text-primary)'}; padding: 0.5rem 1.25rem; border-radius: var(--radius-full); font-weight: 700; font-size: 14px; box-shadow: var(--shadow); border: 2px solid ${isCurrentMonth ? 'var(--primary-dark)' : 'var(--border)'};">
          ${isCurrentMonth ? 'ðŸ“ ' : 'ðŸ“… '}${groupMonthName}
        </div>
      </div>
    `;
    
    // Timeline items for this month
    group.switches.forEach((sw, index) => {
      const patient = state.patients.find(p => p.id === sw.patientId);
      if (!patient) return;
      
      const swDate = parseDate(sw.switchDate);
      const isToday = swDate.toDateString() === now.toDateString();
      const isPast = swDate < now && !isToday;
      const isThisWeek = swDate >= now && swDate <= new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
      const isCompleted = sw.status === 'completed';
      
      // Determine color
      let color, bgColor, borderColor;
      if (isCompleted) {
        color = '#6b7280';
        bgColor = '#f3f4f6';
        borderColor = '#6b7280';
      } else if (isPast) {
        color = '#ef4444';
        bgColor = '#fee2e2';
        borderColor = '#ef4444';
      } else if (isToday) {
        color = '#f59e0b';
        bgColor = '#fef3c7';
        borderColor = '#f59e0b';
      } else if (isThisWeek) {
        color = '#3b82f6';
        bgColor = '#dbeafe';
        borderColor = '#3b82f6';
      } else {
        color = '#10b981';
        bgColor = '#d1fae5';
        borderColor = '#10b981';
      }
      
      // Format date display
      const dayNum = swDate.getDate();
      const dayName = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'][swDate.getDay()];
      
      html += `
        <div style="position: relative; margin-bottom: 2rem;">
          <!-- Date bubble -->
          <div style="position: absolute; left: -100px; top: 0; width: 80px; text-align: center;">
            <div style="background: ${color}; color: white; border-radius: var(--radius-md); padding: 0.5rem; box-shadow: var(--shadow);">
              <div style="font-size: 24px; font-weight: 700; line-height: 1;">${dayNum}</div>
              <div style="font-size: 11px; text-transform: uppercase; margin-top: 2px;">${dayName}</div>
            </div>
          </div>
          
          <!-- Content card -->
          <div style="background: ${bgColor}; border: 2px solid ${borderColor}; border-radius: var(--radius-md); padding: 1.25rem; box-shadow: var(--shadow-sm); cursor: pointer; transition: all 0.2s;" 
               onclick="openSwitchModal('${sw.id}')"
               onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='var(--shadow-md)';"
               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='var(--shadow-sm)';">
            
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
              <div>
                <h4 style="margin: 0 0 0.25rem 0; color: ${color}; font-size: 16px; font-weight: 600;">
                  ${patient.firstName} ${patient.lastName}
                </h4>
                <div style="font-size: 13px; color: var(--text-secondary);">
                  ${patient.patientCode || 'Code non dÃ©fini'}
                </div>
              </div>
              ${isCompleted ? '<span class="badge badge-success">âœ… EffectuÃ©</span>' : 
                isPast ? '<span class="badge badge-danger">âš ï¸ En retard</span>' :
                isToday ? '<span class="badge badge-warning">ðŸ”¥ Aujourd\'hui</span>' :
                isThisWeek ? '<span class="badge badge-info">ðŸ“… Cette semaine</span>' :
                '<span class="badge badge-success">ðŸ“† Ã€ venir</span>'}
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; margin-bottom: 0.75rem;">
              <div>
                <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.25rem;">Ancien protocole</div>
                <div style="font-size: 13px; font-weight: 500;">${protoName(sw.oldProtoId) || 'Non dÃ©fini'}</div>
              </div>
              <div>
                <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.25rem;">Nouveau protocole</div>
                <div style="font-size: 13px; font-weight: 600; color: ${color};">${protoName(sw.newProtoId)}</div>
              </div>
            </div>
            
            ${sw.notes ? `
              <div style="padding: 0.75rem; background: white; border-radius: var(--radius); border-left: 3px solid ${color}; font-size: 13px; color: var(--text-secondary);">
                ðŸ’¬ ${sw.notes}
              </div>
            ` : ''}
            
            ${!isCompleted && !isPast ? `
              <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid ${borderColor}40;">
                <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); validateSwitch('${sw.id}');" style="font-size: 12px;">
                  âœ“ Valider le switch
                </button>
              </div>
            ` : ''}
          </div>
        </div>
      `;
    });
  });
  
  html += '</div>';
  
  container.innerHTML = html;
}

function renderSwitches() {
  const filter = document.querySelector('input[name="switchFilter"]:checked')?.value || 'all';
  
  // Get current date info
  const now = new Date();
  const currentMonth = now.getMonth();
  const currentYear = now.getFullYear();
  const endOfMonth = new Date(currentYear, currentMonth + 1, 0);
  
  // Filter switches
  let filtered = state.switches;
  if (filter === 'planned') {
    filtered = state.switches.filter(s => s.status === 'planned');
  } else if (filter === 'completed') {
    filtered = state.switches.filter(s => s.status === 'completed');
  }
  
  // Categorize switches
  const switchesMonth = [];
  const switchesFuture = [];
  const switchesPast = [];
  
  filtered.forEach(sw => {
    const swDate = parseDate(sw.switchDate);
    if (!swDate) return;
    
    if (sw.status === 'completed') {
      switchesPast.push(sw);
    } else {
      if (swDate <= endOfMonth && swDate >= now) {
        switchesMonth.push(sw);
      } else if (swDate > endOfMonth) {
        switchesFuture.push(sw);
      } else {
        switchesPast.push(sw);
      }
    }
  });
  
  // Render each category
  renderSwitchList('switchesMonth', switchesMonth, 'month');
  renderSwitchList('switchesFuture', switchesFuture, 'future');
  renderSwitchList('switchesPast', switchesPast, 'past');
  
  // Update counters
  byId('countSwitchesMonth').textContent = switchesMonth.length;
  byId('countSwitchesFuture').textContent = switchesFuture.length;
  byId('countSwitchesPast').textContent = switchesPast.length;
  byId('countSwitches').textContent = state.switches.filter(s => s.status === 'planned').length;
  
  // Update timeline if in timeline view
  if (currentSwitchView === 'timeline') {
    renderTimeline();
  }
}

function renderSwitchList(containerId, switches, type) {
  const container = byId(containerId);
  if (!container) return;
  
  if (switches.length === 0) {
    container.innerHTML = '<p class="text-center text-muted">Aucun switch dans cette catÃ©gorie</p>';
    return;
  }
  
  // Sort by date
  switches.sort((a, b) => {
    const dateA = parseDate(a.switchDate);
    const dateB = parseDate(b.switchDate);
    return type === 'past' ? dateB - dateA : dateA - dateB;
  });
  
  container.innerHTML = switches.map(sw => {
    const patient = state.patients.find(p => p.id === sw.patientId);
    if (!patient) return '';
    
    const statusBadge = sw.status === 'completed' 
      ? '<span class="badge badge-success">âœ… EffectuÃ©</span>'
      : '<span class="badge badge-warning">ðŸ“… PrÃ©vu</span>';
    
    return `
      <div class="card mb-2" style="border-left: 4px solid ${sw.status === 'completed' ? 'var(--success)' : 'var(--warning)'};">
        <div class="card-body">
          <div style="display: flex; justify-content: space-between; align-items: start; gap: 1rem;">
            <div style="flex: 1;">
              <h4 style="margin: 0 0 0.5rem 0; color: var(--primary);">${fullName(patient)}</h4>
              <div style="display: grid; gap: 0.5rem; font-size: 0.9rem;">
                <div>
                  <strong>Ancien:</strong> ${protoName(sw.oldProtoId) || 'â€”'}
                  <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20" style="vertical-align: middle; margin: 0 0.5rem;">
                    <path fill-rule="evenodd" d="M10.293 15.707a1 1 0 010-1.414L14.586 10l-4.293-4.293a1 1 0 111.414-1.414l5 5a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    <path fill-rule="evenodd" d="M4.293 15.707a1 1 0 010-1.414L8.586 10 4.293 5.707a1 1 0 011.414-1.414l5 5a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                  </svg>
                  <strong>Nouveau:</strong> ${protoName(sw.newProtoId)}
                </div>
                <div><strong>Date:</strong> ${sw.switchDate}</div>
                ${sw.notes ? `<div class="text-muted" style="font-size: 0.85rem;"><em>${sw.notes}</em></div>` : ''}
              </div>
            </div>
            <div style="display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-end;">
              ${statusBadge}
              <div style="display: flex; gap: 0.5rem;">
                ${sw.status === 'planned' ? `
                  <button class="btn btn-success btn-sm" onclick="validateSwitch('${sw.id}')" title="Valider le switch">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                  </button>
                ` : ''}
                <button class="btn btn-secondary btn-sm" onclick="openSwitchModal('${sw.id}')" title="Modifier">
                  <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

// ===== Appointments Management System =====
function openAppointmentModal(appointmentId = null) {
  currentAppointmentId = appointmentId;
  
  // Populate patient select
  const patientSelect = byId('appointmentPatientId');
  patientSelect.innerHTML = '<option value="">-- SÃ©lectionner un patient --</option>' +
    state.patients.map(p => `<option value="${p.id}">${fullName(p)}</option>`).join('');
  
  if (appointmentId) {
    // Edit mode
    const apt = state.appointments.find(a => a.id === appointmentId);
    if (!apt) return;
    
    byId('appointmentModalTitle').textContent = 'Modifier le suivi';
    byId('btnDeleteAppointment').classList.remove('hidden');
    
    byId('appointmentPatientId').value = apt.patientId;
    
    if (apt.exactDate) {
      document.querySelector('input[name="appointmentType"][value="date"]').checked = true;
      byId('appointmentDate').value = apt.exactDate;
    } else {
      document.querySelector('input[name="appointmentType"][value="month"]').checked = true;
      byId('appointmentMonth').value = apt.month;
    }
    
    toggleAppointmentType();
    byId('appointmentNotes').value = apt.notes || '';
  } else {
    // New mode
    byId('appointmentModalTitle').textContent = 'Planifier un suivi';
    byId('btnDeleteAppointment').classList.add('hidden');
    
    byId('appointmentPatientId').value = '';
    byId('appointmentDate').value = '';
    byId('appointmentMonth').value = '';
    byId('appointmentNotes').value = '';
    
    document.querySelector('input[name="appointmentType"][value="date"]').checked = true;
    toggleAppointmentType();
  }
  
  showModal(true, 'appointmentModal');
}

function toggleAppointmentType() {
  const type = document.querySelector('input[name="appointmentType"]:checked').value;
  
  if (type === 'date') {
    byId('appointmentDateGroup').classList.remove('hidden');
    byId('appointmentMonthGroup').classList.add('hidden');
    byId('appointmentDate').required = true;
    byId('appointmentMonth').required = false;
  } else {
    byId('appointmentDateGroup').classList.add('hidden');
    byId('appointmentMonthGroup').classList.remove('hidden');
    byId('appointmentDate').required = false;
    byId('appointmentMonth').required = true;
  }
}

function saveAppointment() {
  const patientId = byId('appointmentPatientId').value;
  const type = document.querySelector('input[name="appointmentType"]:checked').value;
  const notes = byId('appointmentNotes').value.trim();
  
  if (!patientId) {
    showToast('Veuillez sÃ©lectionner un patient', 'error');
    return;
  }
  
  let exactDate = null;
  let month = null;
  
  if (type === 'date') {
    exactDate = byId('appointmentDate').value.trim();
    if (!exactDate) {
      showToast('Veuillez saisir une date', 'error');
      return;
    }
    // Validate DD/MM/YYYY format
    if (!exactDate.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
      showToast('Format de date invalide (JJ/MM/AAAA)', 'error');
      return;
    }
  } else {
    month = byId('appointmentMonth').value.trim();
    if (!month) {
      showToast('Veuillez saisir un mois', 'error');
      return;
    }
    // Validate MM/YYYY format
    if (!month.match(/^\d{2}\/\d{4}$/)) {
      showToast('Format de mois invalide (MM/AAAA)', 'error');
      return;
    }
  }
  
  // Check if patient already has an active appointment
  const existingActive = state.appointments.find(a => 
    a.patientId === patientId && 
    a.status === 'active' && 
    (!currentAppointmentId || a.id !== currentAppointmentId)
  );
  
  if (existingActive) {
    showToast('Ce patient a dÃ©jÃ  un suivi actif', 'warning');
    return;
  }
  
  if (currentAppointmentId) {
    // Update
    const index = state.appointments.findIndex(a => a.id === currentAppointmentId);
    if (index !== -1) {
      state.appointments[index] = {
        ...state.appointments[index],
        patientId,
        exactDate,
        month,
        notes,
        updatedAt: Date.now()
      };
      showToast('Suivi modifiÃ©', 'success');
    }
  } else {
    // Create
    state.appointments.push({
      id: generateId(),
      patientId,
      exactDate,
      month,
      notes,
      status: 'active',
      history: [],
      createdAt: Date.now(),
      updatedAt: Date.now()
    });
    showToast('Suivi planifiÃ©', 'success');
  }
  
  saveDB();
  renderAppointments();
  updateAppointmentStats();
  renderDashboard();
  showModal(false, 'appointmentModal');
}

function deleteAppointment() {
  if (!currentAppointmentId) return;
  
  if (!confirm('Supprimer ce suivi ?')) return;
  
  state.appointments = state.appointments.filter(a => a.id !== currentAppointmentId);
  saveDB();
  renderAppointments();
  updateAppointmentStats();
  renderDashboard();
  showModal(false, 'appointmentModal');
  showToast('Suivi supprimÃ©', 'success');
}

function completeAppointment(appointmentId) {
  const apt = state.appointments.find(a => a.id === appointmentId);
  if (!apt) return;
  
  const patient = state.patients.find(p => p.id === apt.patientId);
  if (!patient) return;
  
  currentAppointmentId = appointmentId;
  
  // Fill modal
  byId('completePatientName').textContent = fullName(patient);
  
  if (apt.exactDate) {
    // Parse DD/MM/YYYY
    const parts = apt.exactDate.split('/');
    if (parts.length === 3) {
      const day = parseInt(parts[0], 10);
      const month = parseInt(parts[1], 10) - 1;
      const year = parseInt(parts[2], 10);
      const date = new Date(year, month, day);
      byId('completeAppointmentInfo').textContent = date.toLocaleDateString('fr-FR', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    } else {
      byId('completeAppointmentInfo').textContent = apt.exactDate;
    }
  } else {
    // Parse MM/YYYY
    const parts = apt.month.split('/');
    if (parts.length === 2) {
      const monthNames = ['Janvier', 'FÃ©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 
                          'Juillet', 'AoÃ»t', 'Septembre', 'Octobre', 'Novembre', 'DÃ©cembre'];
      byId('completeAppointmentInfo').textContent = `${monthNames[parseInt(parts[0], 10) - 1]} ${parts[1]}`;
    } else {
      byId('completeAppointmentInfo').textContent = apt.month;
    }
  }
  
  byId('completeNotes').value = '';
  byId('nextAppointmentDate').value = '';
  byId('nextAppointmentMonth').value = '';
  byId('nextAppointmentNotes').value = '';
  
  document.querySelector('input[name="nextAppointmentType"][value="date"]').checked = true;
  toggleNextAppointmentType();
  
  showModal(true, 'completeAppointmentModal');
}

function toggleNextAppointmentType() {
  const type = document.querySelector('input[name="nextAppointmentType"]:checked').value;
  
  if (type === 'date') {
    byId('nextAppointmentDateGroup').classList.remove('hidden');
    byId('nextAppointmentMonthGroup').classList.add('hidden');
  } else {
    byId('nextAppointmentDateGroup').classList.add('hidden');
    byId('nextAppointmentMonthGroup').classList.remove('hidden');
  }
}

function confirmCompleteAppointment() {
  const type = document.querySelector('input[name="nextAppointmentType"]:checked').value;
  const completeNotes = byId('completeNotes').value.trim();
  const nextNotes = byId('nextAppointmentNotes').value.trim();
  
  let nextExactDate = null;
  let nextMonth = null;
  
  if (type === 'date') {
    nextExactDate = byId('nextAppointmentDate').value.trim();
    if (!nextExactDate) {
      showToast('Veuillez saisir la date du prochain suivi', 'error');
      return;
    }
    // Validate DD/MM/YYYY format
    if (!nextExactDate.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
      showToast('Format de date invalide (JJ/MM/AAAA)', 'error');
      return;
    }
  } else {
    nextMonth = byId('nextAppointmentMonth').value.trim();
    if (!nextMonth) {
      showToast('Veuillez saisir le mois du prochain suivi', 'error');
      return;
    }
    // Validate MM/YYYY format
    if (!nextMonth.match(/^\d{2}\/\d{4}$/)) {
      showToast('Format de mois invalide (MM/AAAA)', 'error');
      return;
    }
  }
  
  const apt = state.appointments.find(a => a.id === currentAppointmentId);
  if (!apt) return;
  
  const now = Date.now();
  
  // Add to history
  if (!apt.history) apt.history = [];
  apt.history.push({
    completedAt: now,
    scheduledDate: apt.exactDate || apt.month,
    notes: completeNotes,
    type: apt.exactDate ? 'date' : 'month'
  });
  
  // Update appointment with next occurrence
  apt.exactDate = nextExactDate;
  apt.month = nextMonth;
  apt.notes = nextNotes;
  apt.updatedAt = now;
  
  saveDB();
  renderAppointments();
  updateAppointmentStats();
  renderDashboard();
  showModal(false, 'completeAppointmentModal');
  showToast('Suivi validÃ© et prochain RDV planifiÃ©', 'success');
}

function renderAppointments() {
  const filter = document.querySelector('input[name="appointmentFilter"]:checked')?.value || 'all';
  const search = byId('appointmentSearch')?.value.toLowerCase() || '';
  
  // Get current date info
  const now = new Date();
  const currentYear = now.getFullYear();
  const currentMonth = now.getMonth();
  const currentMonthStr = `${String(currentMonth + 1).padStart(2, '0')}/${currentYear}`;
  const next30Days = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);
  
  console.log('=== renderAppointments Debug ===');
  console.log('Filter:', filter);
  console.log('Current month (0-based):', currentMonth, '(display:', currentMonth + 1, ')');
  console.log('Current year:', currentYear);
  console.log('Current month string:', currentMonthStr);
  console.log('Total appointments:', state.appointments.length);
  
  // Filter active appointments
  let filtered = state.appointments.filter(a => a.status === 'active');
  console.log('Active appointments:', filtered.length);
  
  // Apply filters
  if (filter === 'thisMonth') {
    filtered = filtered.filter(a => {
      console.log('Checking appointment:', a);
      
      if (a.exactDate) {
        // Parse DD/MM/YYYY
        const parts = a.exactDate.split('/');
        console.log('  Exact date parts:', parts);
        if (parts.length === 3) {
          const day = parseInt(parts[0], 10);
          const month = parseInt(parts[1], 10) - 1; // 0-based
          const year = parseInt(parts[2], 10);
          const aptDate = new Date(year, month, day);
          console.log(`  Parsed: day=${day}, month=${month} (display: ${month+1}), year=${year}`);
          console.log('  Date object:', aptDate);
          console.log('  aptDate.getMonth():', aptDate.getMonth(), 'currentMonth:', currentMonth);
          const matches = aptDate.getMonth() === currentMonth && aptDate.getFullYear() === currentYear;
          console.log('  Matches this month:', matches);
          return matches;
        }
      } else if (a.month) {
        console.log('  Month format:', a.month);
        const matches = a.month === currentMonthStr;
        console.log('  Matches this month:', matches);
        return matches;
      }
      console.log('  No date info');
      return false;
    });
  } else if (filter === 'next30') {
    filtered = filtered.filter(a => {
      if (a.exactDate) {
        // Parse DD/MM/YYYY
        const parts = a.exactDate.split('/');
        if (parts.length === 3) {
          const day = parseInt(parts[0], 10);
          const month = parseInt(parts[1], 10) - 1;
          const year = parseInt(parts[2], 10);
          const aptDate = new Date(year, month, day);
          return aptDate <= next30Days && aptDate >= now;
        }
      }
      return false;
    });
  } else if (filter === 'toCall') {
    filtered = filtered.filter(a => !a.exactDate && a.month === currentMonthStr);
  }
  
  console.log('Filtered appointments:', filtered.length);
  
  // Apply search
  if (search) {
    filtered = filtered.filter(a => {
      const patient = state.patients.find(p => p.id === a.patientId);
      return patient && fullName(patient).toLowerCase().includes(search);
    });
  }
  
  // Sort
  filtered.sort((a, b) => {
    // Exact dates first, sorted by date
    if (a.exactDate && b.exactDate) {
      const partsA = a.exactDate.split('/');
      const partsB = b.exactDate.split('/');
      const dateA = new Date(parseInt(partsA[2], 10), parseInt(partsA[1], 10) - 1, parseInt(partsA[0], 10));
      const dateB = new Date(parseInt(partsB[2], 10), parseInt(partsB[1], 10) - 1, parseInt(partsB[0], 10));
      return dateA - dateB;
    }
    if (a.exactDate && !b.exactDate) return -1;
    if (!a.exactDate && b.exactDate) return 1;
    
    // Then months
    if (a.month && b.month) {
      return a.month.localeCompare(b.month);
    }
    return 0;
  });
  
  // Render
  const container = byId('appointmentsList');
  if (!container) return;
  
  if (filtered.length === 0) {
    container.innerHTML = '<p class="text-center text-muted">Aucun suivi trouvÃ©</p>';
    return;
  }
  
  container.innerHTML = filtered.map(apt => {
    const patient = state.patients.find(p => p.id === apt.patientId);
    if (!patient) return '';
    
    let dateDisplay, badgeClass, badgeText, isUrgent;
    
    if (apt.exactDate) {
      // Parse DD/MM/YYYY
      const parts = apt.exactDate.split('/');
      const day = parseInt(parts[0], 10);
      const month = parseInt(parts[1], 10) - 1;
      const year = parseInt(parts[2], 10);
      const aptDate = new Date(year, month, day);
      const diffDays = Math.ceil((aptDate - now) / (1000 * 60 * 60 * 24));
      
      dateDisplay = aptDate.toLocaleDateString('fr-FR', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      
      if (diffDays < 0) {
        badgeClass = 'badge-danger';
        badgeText = `Retard: ${Math.abs(diffDays)}j`;
        isUrgent = true;
      } else if (diffDays === 0) {
        badgeClass = 'badge-danger';
        badgeText = 'Aujourd\'hui !';
        isUrgent = true;
      } else if (diffDays <= 7) {
        badgeClass = 'badge-warning';
        badgeText = `Dans ${diffDays}j`;
        isUrgent = true;
      } else {
        badgeClass = 'badge-info';
        badgeText = `Dans ${diffDays}j`;
        isUrgent = false;
      }
    } else {
      // Parse MM/YYYY
      const parts = apt.month.split('/');
      const monthNames = ['Janvier', 'FÃ©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 
                          'Juillet', 'AoÃ»t', 'Septembre', 'Octobre', 'Novembre', 'DÃ©cembre'];
      dateDisplay = `${monthNames[parseInt(parts[0], 10) - 1]} ${parts[1]}`;
      
      if (apt.month === currentMonthStr) {
        badgeClass = 'badge-warning';
        badgeText = 'ðŸ“ž Ã€ rappeler';
        isUrgent = true;
      } else {
        badgeClass = 'badge-info';
        badgeText = 'Mois prÃ©vu';
        isUrgent = false;
      }
    }
    
    return `
      <div class="card mb-2" style="border-left: 4px solid ${isUrgent ? 'var(--warning)' : 'var(--info)'};">
        <div class="card-body">
          <div style="display: flex; justify-content: space-between; align-items: start; gap: 1rem;">
            <div style="flex: 1;">
              <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                <h4 style="margin: 0; color: var(--primary);">${fullName(patient)}</h4>
                <span class="badge ${badgeClass}">${badgeText}</span>
              </div>
              <div style="display: flex; align-items: center; gap: 1rem; font-size: 0.9rem; color: var(--text-secondary);">
                <div>
                  <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20" style="vertical-align: middle; margin-right: 0.25rem;">
                    <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
                  </svg>
                  ${dateDisplay}
                </div>
                ${apt.history && apt.history.length > 0 ? `
                  <div class="text-muted">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20" style="vertical-align: middle; margin-right: 0.25rem;">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                    </svg>
                    ${apt.history.length} suivi${apt.history.length > 1 ? 's' : ''} rÃ©alisÃ©${apt.history.length > 1 ? 's' : ''}
                  </div>
                ` : ''}
              </div>
              ${apt.notes ? `<div class="text-muted" style="font-size: 0.85rem; margin-top: 0.5rem;"><em>${apt.notes}</em></div>` : ''}
            </div>
            <div style="display: flex; gap: 0.5rem;">
              <button class="btn btn-success btn-sm" onclick="completeAppointment('${apt.id}')" title="Marquer comme rÃ©alisÃ©">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                </svg>
              </button>
              <button class="btn btn-secondary btn-sm" onclick="openAppointmentModal('${apt.id}')" title="Modifier">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function updateAppointmentStats() {
  const now = new Date();
  const currentYear = now.getFullYear();
  const currentMonth = now.getMonth();
  const currentMonthStr = `${String(currentMonth + 1).padStart(2, '0')}/${currentYear}`;
  const next30Days = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);
  
  const activeAppointments = state.appointments.filter(a => a.status === 'active');
  
  // This month
  const thisMonth = activeAppointments.filter(a => {
    if (a.exactDate) {
      // Parse DD/MM/YYYY
      const parts = a.exactDate.split('/');
      if (parts.length === 3) {
        const day = parseInt(parts[0], 10);
        const month = parseInt(parts[1], 10) - 1;
        const year = parseInt(parts[2], 10);
        const aptDate = new Date(year, month, day);
        return aptDate.getMonth() === currentMonth && aptDate.getFullYear() === currentYear;
      }
    } else if (a.month) {
      return a.month === currentMonthStr;
    }
    return false;
  }).length;
  
  // To call (month = current month, no exact date)
  const toCall = activeAppointments.filter(a => 
    !a.exactDate && a.month === currentMonthStr
  ).length;
  
  // Next 30 days (exact dates only)
  const next30 = activeAppointments.filter(a => {
    if (a.exactDate) {
      // Parse DD/MM/YYYY
      const parts = a.exactDate.split('/');
      if (parts.length === 3) {
        const day = parseInt(parts[0], 10);
        const month = parseInt(parts[1], 10) - 1;
        const year = parseInt(parts[2], 10);
        const aptDate = new Date(year, month, day);
        return aptDate <= next30Days && aptDate >= now;
      }
    }
    return false;
  }).length;
  
  // Total completed
  const totalCompleted = state.appointments.reduce((sum, a) => 
    sum + (a.history ? a.history.length : 0), 0
  );
  
  byId('kpiAppointmentsThisMonth').textContent = thisMonth;
  byId('kpiAppointmentsToCall').textContent = toCall;
  byId('kpiAppointmentsNext30').textContent = next30;
  byId('kpiAppointmentsDone').textContent = totalCompleted;
  byId('countAppointments').textContent = toCall;
}

// ===== Auto-Save System =====
let autoSaveConfig = {
  enabled: false,
  fileHandle: null,
  fileName: null,
  lastSave: null,
  saveTimeout: null,
  supportsFileSystem: false
};

// Check if File System Access API is supported
function checkFileSystemSupport() {
  autoSaveConfig.supportsFileSystem = 'showSaveFilePicker' in window;
  
  if (!autoSaveConfig.supportsFileSystem) {
    const notice = byId('autoSaveFallbackNotice');
    if (notice) notice.style.display = 'block';
  }
  
  // Load saved config
  const savedConfig = localStorage.getItem('autoSaveConfig');
  if (savedConfig) {
    try {
      const config = JSON.parse(savedConfig);
      autoSaveConfig.enabled = config.enabled || false;
      autoSaveConfig.fileName = config.fileName || null;
      autoSaveConfig.lastSave = config.lastSave || null;
      updateAutoSaveUI();
    } catch (e) {
      console.error('Error loading auto-save config:', e);
    }
  }
}

async function configureAutoSave() {
  if (!autoSaveConfig.supportsFileSystem) {
    showToast('Votre navigateur ne supporte pas cette fonctionnalitÃ©. Utilisez Chrome ou Edge.', 'error');
    return;
  }
  
  try {
    // Ask user where to save
    const handle = await window.showSaveFilePicker({
      suggestedName: 'nhc-patients-backup.json',
      types: [{
        description: 'Fichier JSON',
        accept: { 'application/json': ['.json'] }
      }]
    });
    
    autoSaveConfig.fileHandle = handle;
    autoSaveConfig.fileName = handle.name;
    autoSaveConfig.enabled = true;
    
    // Save config (but not the file handle as it's not serializable)
    saveAutoSaveConfig();
    
    // Perform initial save
    await performAutoSave();
    
    showToast('Sauvegarde automatique configurÃ©e avec succÃ¨s ! ðŸŽ‰', 'success');
    updateAutoSaveUI();
    
  } catch (err) {
    if (err.name !== 'AbortError') {
      console.error('Error configuring auto-save:', err);
      showToast('Erreur lors de la configuration: ' + err.message, 'error');
    }
  }
}

async function performAutoSave() {
  if (!autoSaveConfig.enabled || !autoSaveConfig.fileHandle) {
    return;
  }

  try {
    // Prepare data - Include EVERYTHING from state
    const data = {
      version: '4.0',
      exportDate: new Date().toISOString(),
      data: state  // Include ALL state data (patients, docs, centers, protos, switches, appointments, and any future additions)
    };

    // Count history events for verification
    const patientHistoryCount = state.patients.reduce((total, p) => total + (p.history?.length || 0), 0);
    const appointmentHistoryCount = state.appointments.reduce((total, a) => total + (a.history?.length || 0), 0);
    const totalHistoryEvents = patientHistoryCount + appointmentHistoryCount;

    // Write to file
    const writable = await autoSaveConfig.fileHandle.createWritable();
    await writable.write(JSON.stringify(data, null, 2));
    await writable.close();

    // Update last save time
    autoSaveConfig.lastSave = Date.now();
    saveAutoSaveConfig();
    updateAutoSaveUI();

    console.log('âœ… Auto-save completed:', new Date().toLocaleString());
    console.log('ðŸ“Š Saved data:', {
      patients: state.patients?.length || 0,
      docs: state.docs?.length || 0,
      centers: state.centers?.length || 0,
      protos: state.protos?.length || 0,
      switches: state.switches?.length || 0,
      appointments: state.appointments?.length || 0,
      patientHistoryEvents: patientHistoryCount,
      appointmentHistoryEvents: appointmentHistoryCount,
      totalHistoryEvents: totalHistoryEvents
    });

  } catch (err) {
    console.error('âŒ Auto-save failed:', err);

    // If permission denied, ask to reconfigure
    if (err.name === 'NotAllowedError') {
      showToast('Permission refusÃ©e. Veuillez reconfigurer la sauvegarde automatique.', 'warning');
      autoSaveConfig.fileHandle = null;
      autoSaveConfig.enabled = false;
      saveAutoSaveConfig();
      updateAutoSaveUI();
    }
  }
}

function scheduleAutoSave() {
  if (!autoSaveConfig.enabled) return;
  
  // Debounce: wait 2 seconds after last change
  if (autoSaveConfig.saveTimeout) {
    clearTimeout(autoSaveConfig.saveTimeout);
  }
  
  autoSaveConfig.saveTimeout = setTimeout(() => {
    performAutoSave();
  }, 2000);
}

function toggleAutoSave(enable) {
  if (enable && !autoSaveConfig.fileHandle) {
    showToast('Veuillez d\'abord configurer la sauvegarde', 'warning');
    configureAutoSave();
    return;
  }
  
  autoSaveConfig.enabled = enable;
  saveAutoSaveConfig();
  updateAutoSaveUI();
  
  if (enable) {
    showToast('Sauvegarde automatique activÃ©e âœ…', 'success');
    performAutoSave();
  } else {
    showToast('Sauvegarde automatique dÃ©sactivÃ©e', 'info');
  }
}

function saveNow() {
  if (!autoSaveConfig.fileHandle) {
    showToast('Veuillez d\'abord configurer la sauvegarde', 'warning');
    return;
  }
  
  performAutoSave();
  showToast('Sauvegarde manuelle en cours...', 'info');
}

async function restoreFromAutoSave() {
  if (!autoSaveConfig.supportsFileSystem) {
    showToast('Utilisez l\'import JSON classique', 'info');
    return;
  }

  if (!confirm('âš ï¸ Cette action va remplacer toutes vos donnÃ©es actuelles par celles de la sauvegarde automatique. Continuer ?')) {
    return;
  }

  try {
    if (!autoSaveConfig.fileHandle) {
      showToast('Aucun fichier de sauvegarde configurÃ©', 'warning');
      return;
    }

    const file = await autoSaveConfig.fileHandle.getFile();
    const content = await file.text();
    const parsed = JSON.parse(content);

    // Support both old and new backup formats
    let data;
    if (parsed.version && parsed.data) {
      // New format with version wrapper (v4.0+)
      data = parsed.data;
      console.log(`Restoring from backup version ${parsed.version} dated ${parsed.exportDate}`);
    } else {
      // Old format (direct data)
      data = parsed;
    }

    // Count history events for verification
    const patientHistoryCount = (data.patients || []).reduce((total, p) => total + (p.history?.length || 0), 0);
    const appointmentHistoryCount = (data.appointments || []).reduce((total, a) => total + (a.history?.length || 0), 0);
    const totalHistoryEvents = patientHistoryCount + appointmentHistoryCount;

    // Restore ALL state data
    state = {
      patients: data.patients || [],
      docs: data.docs || [],
      centers: data.centers || [],
      protos: data.protos || [],
      switches: data.switches || [],
      appointments: data.appointments || []
    };

    console.log('ðŸ“Š Restored data:', {
      patients: state.patients.length,
      docs: state.docs.length,
      centers: state.centers.length,
      protos: state.protos.length,
      switches: state.switches.length,
      appointments: state.appointments.length,
      patientHistoryEvents: patientHistoryCount,
      appointmentHistoryEvents: appointmentHistoryCount,
      totalHistoryEvents: totalHistoryEvents
    });

    saveDB();
    render();

    // Detailed success message
    const message = `âœ… Restauration rÃ©ussie !\n${state.patients.length} patients (${patientHistoryCount} Ã©vÃ©nements historique)\n${state.appointments.length} rendez-vous (${appointmentHistoryCount} Ã©vÃ©nements)\nTotal: ${totalHistoryEvents} Ã©vÃ©nements restaurÃ©s`;
    showToast(message, 'success');

  } catch (err) {
    console.error('Error restoring from auto-save:', err);
    showToast('Erreur lors de la restauration: ' + err.message, 'error');
  }
}

function saveAutoSaveConfig() {
  const config = {
    enabled: autoSaveConfig.enabled,
    fileName: autoSaveConfig.fileName,
    lastSave: autoSaveConfig.lastSave
  };
  localStorage.setItem('autoSaveConfig', JSON.stringify(config));
}

function updateAutoSaveUI() {
  const status = byId('autoSaveStatus');
  const info = byId('autoSaveInfo');
  const fileName = byId('autoSaveFileName');
  const lastTime = byId('autoSaveLastTime');
  const count = byId('autoSaveCount');
  
  const btnConfigure = byId('btnConfigureAutoSave');
  const btnEnable = byId('btnEnableAutoSave');
  const btnDisable = byId('btnDisableAutoSave');
  const btnSaveNow = byId('btnSaveNow');
  const btnRestore = byId('btnRestoreFromAutoSave');
  
  if (!status) return;
  
  if (autoSaveConfig.fileHandle && autoSaveConfig.enabled) {
    // Active
    status.innerHTML = '<span class="badge badge-success">âœ… ActivÃ©e</span>';
    info.style.display = 'block';
    
    if (fileName) fileName.textContent = autoSaveConfig.fileName || 'Non dÃ©fini';
    if (lastTime) {
      if (autoSaveConfig.lastSave) {
        const date = new Date(autoSaveConfig.lastSave);
        lastTime.textContent = date.toLocaleString('fr-FR');
      } else {
        lastTime.textContent = 'Jamais';
      }
    }
    if (count) {
      const total = state.patients.length + state.docs.length + state.centers.length + 
                    state.protos.length + state.switches.length + state.appointments.length;
      count.textContent = `${total} Ã©lÃ©ments`;
    }
    
    if (btnConfigure) btnConfigure.textContent = 'âš™ï¸ Reconfigurer';
    if (btnEnable) btnEnable.classList.add('hidden');
    if (btnDisable) btnDisable.classList.remove('hidden');
    if (btnSaveNow) btnSaveNow.classList.remove('hidden');
    if (btnRestore) btnRestore.classList.remove('hidden');
    
  } else if (autoSaveConfig.fileHandle && !autoSaveConfig.enabled) {
    // Configured but disabled
    status.innerHTML = '<span class="badge badge-warning">â¸ï¸ DÃ©sactivÃ©e</span>';
    info.style.display = 'block';
    
    if (fileName) fileName.textContent = autoSaveConfig.fileName || 'Non dÃ©fini';
    if (lastTime) {
      if (autoSaveConfig.lastSave) {
        const date = new Date(autoSaveConfig.lastSave);
        lastTime.textContent = date.toLocaleString('fr-FR') + ' (dÃ©sactivÃ©e)';
      } else {
        lastTime.textContent = 'Jamais';
      }
    }
    if (count) count.textContent = '-';
    
    if (btnConfigure) btnConfigure.textContent = 'âš™ï¸ Reconfigurer';
    if (btnEnable) btnEnable.classList.remove('hidden');
    if (btnDisable) btnDisable.classList.add('hidden');
    if (btnSaveNow) btnSaveNow.classList.add('hidden');
    if (btnRestore) btnRestore.classList.remove('hidden');
    
  } else {
    // Not configured
    status.innerHTML = '<span class="badge badge-secondary">âŒ Non configurÃ©e</span>';
    info.style.display = 'none';
    
    if (btnConfigure) btnConfigure.textContent = 'ðŸ”§ Configurer la sauvegarde';
    if (btnEnable) btnEnable.classList.add('hidden');
    if (btnDisable) btnDisable.classList.add('hidden');
    if (btnSaveNow) btnSaveNow.classList.add('hidden');
    if (btnRestore) btnRestore.classList.add('hidden');
  }
}

// Trigger auto-save on data changes
function triggerAutoSave() {
  if (autoSaveConfig.enabled && autoSaveConfig.fileHandle) {
    scheduleAutoSave();
  }
}

// ===== CSV Import System =====
let csvImportState = {
  rawData: null,
  parsedData: [],
  headers: [],
  separator: null,
  mapping: {}
};

const CSV_FIELD_MAPPING = {
  lastName: 'Nom',
  firstName: 'PrÃ©nom',
  dob: 'Date de naissance',
  email: 'Email',
  phone: 'TÃ©lÃ©phone',
  address: 'Adresse',
  renewalDate: 'Date de renouvellement',
  docName: 'MÃ©decin',
  centerName: 'Centre',
  protoName: 'Protocole',
  notes: 'Notes'
};

// Fonction pour nettoyer les noms de colonnes
function cleanHeaderName(header) {
  if (!header) return '';
  
  return String(header)
    .replace(/\r?\n/g, ' ')           // Remplacer les retours Ã  la ligne par des espaces
    .replace(/\s+/g, ' ')             // Normaliser les espaces multiples
    .replace(/^[<>]+$/g, 'PRENOM')    // Remplacer "<<<<<<<<<" par PRENOM
    .replace(/unnamed:\s*\d+/i, '')   // Supprimer "Unnamed: X"
    .trim()                           // Enlever espaces dÃ©but/fin
    .toUpperCase();                   // Mettre en majuscules pour la comparaison
}

function detectSeparator(text) {
  const lines = text.split('\n').slice(0, 10).filter(l => l.trim()); // Analyser plus de lignes
  const separators = [',', ';', '\t', '|'];
  let bestSeparator = ',';
  let maxScore = 0;
  
  for (const sep of separators) {
    // Compter les occurrences dans chaque ligne
    const counts = lines.map(line => {
      // Ne pas compter les sÃ©parateurs dans les guillemets
      let count = 0;
      let inQuotes = false;
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"' || char === "'") {
          inQuotes = !inQuotes;
        } else if (char === sep && !inQuotes) {
          count++;
        }
      }
      return count;
    });
    
    // VÃ©rifier la consistance
    if (counts.length === 0) continue;
    
    const avgCount = counts.reduce((a, b) => a + b, 0) / counts.length;
    const isConsistent = counts.every(c => Math.abs(c - avgCount) <= 1); // TolÃ©rance de 1
    
    if (isConsistent && avgCount > maxScore) {
      maxScore = avgCount;
      bestSeparator = sep;
    }
  }
  
  return bestSeparator;
}

function parseCSVAdvanced(text, separator = null) {
  if (!text) return { headers: [], rows: [], separator: ',' };
  
  const detectedSep = separator || detectSeparator(text);
  
  // Parse CSV avec gestion des guillemets
  const parseCSVLine = (line, sep) => {
    const result = [];
    let current = '';
    let inQuotes = false;
    
    for (let i = 0; i < line.length; i++) {
      const char = line[i];
      const nextChar = line[i + 1];
      
      if (char === '"' || char === "'") {
        if (inQuotes && nextChar === char) {
          // Double quote - c'est un Ã©chappement
          current += char;
          i++; // Skip le prochain
        } else {
          // Toggle quote mode
          inQuotes = !inQuotes;
        }
      } else if (char === sep && !inQuotes) {
        // SÃ©parateur hors guillemets - fin de cellule
        result.push(current.trim());
        current = '';
      } else {
        current += char;
      }
    }
    
    // Ajouter la derniÃ¨re cellule
    result.push(current.trim());
    
    return result;
  };
  
  const lines = text.split(/\r?\n/);
  
  if (lines.length === 0) return { headers: [], rows: [], separator: detectedSep };
  
  // Parse header
  const rawHeaders = parseCSVLine(lines[0], detectedSep);
  const headers = rawHeaders.map(h => cleanHeaderName(h));
  const numColumns = headers.length;
  const rows = [];
  
  // Parse data rows
  for (let i = 1; i < lines.length; i++) {
    const line = lines[i].trim();
    if (!line) continue; // Skip empty lines
    
    const values = parseCSVLine(line, detectedSep);
    
    // Ajuster le nombre de colonnes si nÃ©cessaire
    while (values.length < numColumns) {
      values.push(''); // Ajouter des cellules vides
    }
    
    // Tronquer si trop de colonnes
    if (values.length > numColumns) {
      values.length = numColumns;
    }
    
    // Accepter toutes les lignes, mÃªme celles avec peu de donnÃ©es
    rows.push(values);
  }
  
  return { headers, rows, separator: detectedSep };
}

function openCSVImport() {
  showModal(true, 'csvImportModal');
  // Reset state
  csvReset();
  
  // Initialize CSV Import if not already done
  if (!byId('dropZone').hasAttribute('data-csv-init')) {
    initCSVImport();
    byId('dropZone').setAttribute('data-csv-init', 'true');
  }
}

function loadCSVFile() {
  const file = byId('csvFileInput').files[0];
  if (!file) {
    showToast('SÃ©lectionnez un fichier CSV', 'warning');
    return;
  }
  
  const reader = new FileReader();
  const encoding = byId('csvEncoding').value;
  
  reader.onload = (e) => {
    csvImportState.rawData = e.target.result;
    const separator = byId('csvSeparator').value === 'auto' ? null : byId('csvSeparator').value;
    const parsed = parseCSVAdvanced(csvImportState.rawData, separator);
    
    csvImportState.headers = parsed.headers;
    csvImportState.parsedData = parsed.rows;
    csvImportState.separator = parsed.separator;
    
    // Display preview
    displayCSVPreview();
    
    // Move to step 2
    byId('csvStep1').style.display = 'none';
    byId('csvStep2').style.display = 'block';
  };
  
  reader.readAsText(file, encoding);
}

function displayCSVPreview() {
  const table = byId('csvPreviewTable');
  const maxRows = Math.min(10, csvImportState.parsedData.length);
  
  let html = '<div style="overflow-x: auto;"><table class="table"><thead><tr>';
  
  // Headers with column numbers
  csvImportState.headers.forEach((header, idx) => {
    html += `<th style="min-width: 100px;">Col ${idx + 1}<br><span class="text-small text-muted">${header}</span></th>`;
  });
  html += '</tr></thead><tbody>';
  
  // Preview rows
  for (let i = 0; i < maxRows; i++) {
    html += '<tr>';
    const row = csvImportState.parsedData[i];
    for (let j = 0; j < csvImportState.headers.length; j++) {
      const val = row[j] || '';
      const displayVal = val.length > 50 ? val.substring(0, 47) + '...' : val;
      html += `<td title="${val.replace(/"/g, '&quot;')}">${displayVal || 'â€”'}</td>`;
    }
    html += '</tr>';
  }
  
  html += '</tbody></table></div>';
  
  if (csvImportState.parsedData.length > maxRows) {
    html += `<p class="text-muted text-center mt-2">... et ${csvImportState.parsedData.length - maxRows} lignes supplÃ©mentaires</p>`;
  }
  
  table.innerHTML = html;
  
  const sepDisplay = csvImportState.separator === '\t' ? 'Tabulation' : 
                     csvImportState.separator === ',' ? 'Virgule (,)' :
                     csvImportState.separator === ';' ? 'Point-virgule (;)' :
                     csvImportState.separator;
  
  byId('csvRowCount').textContent = `${csvImportState.parsedData.length} lignes dÃ©tectÃ©es (${csvImportState.headers.length} colonnes)`;
  byId('csvSeparatorInfo').textContent = `SÃ©parateur: ${sepDisplay}`;
}

function goToMapping() {
  // Create mapping interface
  const mappingDiv = byId('csvMappingFields');
  let html = '<div class="form-grid">';
  
  for (const [field, label] of Object.entries(CSV_FIELD_MAPPING)) {
    html += `
      <div class="form-group">
        <label class="form-label">${label}</label>
        <select class="form-select" id="map_${field}">
          <option value="">-- Ne pas importer --</option>
          ${csvImportState.headers.map((h, idx) => 
            `<option value="${idx}">${h} (Col ${idx + 1})</option>`
          ).join('')}
        </select>
      </div>
    `;
  }
  
  html += '</div>';
  mappingDiv.innerHTML = html;
  
  // Try auto-mapping based on header names
  autoMapFields();
  
  // Move to step 3
  byId('csvStep2').style.display = 'none';
  byId('csvStep3').style.display = 'block';
}

function autoMapFields() {
  const mappings = {
    lastName: ['nom', 'last_name', 'lastname', 'surname', 'family', 'nom de famille', 'nom_famille'],
    firstName: ['prenom', 'prÃ©nom', 'first_name', 'firstname', 'givenname', 'given', 'first', 'prÃ©nom_usuel'],
    dob: ['date_naissance', 'naissance', 'birth', 'dob', 'date_of_birth', 'ddn', 'date de naissance', 'nÃ©', 'nÃ©e', 'date naissance', 'birthdate', 'datedenaissance'],
    email: ['email', 'mail', 'courriel', 'e-mail', 'e_mail', 'courrier', 'adresse_mail', 'adresse_email'],
    phone: ['telephone', 'tÃ©lÃ©phone', 'phone', 'tel', 'mobile', 'portable', 'gsm', 'cellulaire', 'tel_portable', 'tel_mobile', 'numero_tel', 'numero_telephone', 'tÃ©lÃ©phone_portable'],
    address: ['adresse', 'address', 'rue', 'street', 'domicile', 'adresse_postale', 'adresse_complete', 'voie'],
    patientCode: ['code', 'id_patient', 'identifiant', 'patient_code', 'patient_id', 'numero', 'numÃ©ro', 'nÂ°', 'noota', 'numero_patient', 'code_patient', 'ref', 'reference', 'rÃ©fÃ©rence'],
    renewalDate: ['renouvellement', 'renewal', 'date_renouvellement', 'ordonnance', 'prochaine', 'ordo', 'date ordo', 'date_ordonnance', 'date_renew', 'renew_date', 'prochaine_visite'],
    docName: ['medecin', 'mÃ©decin', 'doctor', 'doc', 'prescripteur', 'diabetologue', 'diabÃ©tologue', 'nom_medecin', 'nom_docteur', 'praticien', 'dr'],
    centerName: ['centre', 'center', 'site', 'hopital', 'hÃ´pital', 'hospital', 'etablissement', 'Ã©tablissement', 'clinique', 'nom_centre'],
    protoName: ['protocole', 'protocol', 'proto', 'matÃ©riel', 'materiel', 'pompe', 'dispositif', 'traitement', 'nom_protocole', 'type_materiel'],
    notes: ['notes', 'note', 'commentaire', 'comment', 'remarque', 'observation', 'info', 'remarques', 'observations', 'commentaires']
  };

  // DÃ©tecter si on a des colonnes sÃ©parÃ©es pour l'adresse (ADRESSE + CP + VILLE)
  let hasAddressColumns = false;
  let addressColIndex = -1;
  let cpColIndex = -1;
  let villeColIndex = -1;

  for (let i = 0; i < csvImportState.headers.length; i++) {
    const header = csvImportState.headers[i].toLowerCase().replace(/[\s_\-]/g, '');
    if (header.includes('adresse') || header.includes('address') || header.includes('rue') || header === 'voie') {
      addressColIndex = i;
    } else if (header.includes('cp') || header.includes('codepostal') || header.includes('postal') || header === 'zip') {
      cpColIndex = i;
    } else if (header.includes('ville') || header.includes('city') || header.includes('commune') || header === 'localite' || header === 'town') {
      villeColIndex = i;
    }
  }

  hasAddressColumns = (addressColIndex >= 0 && cpColIndex >= 0 && villeColIndex >= 0);

  // Track which columns have been mapped to avoid duplicates
  const mappedColumns = new Set();

  for (const [field, keywords] of Object.entries(mappings)) {
    const select = byId(`map_${field}`);
    if (!select) continue;

    // Pour le champ adresse, si on a des colonnes sÃ©parÃ©es, prendre la premiÃ¨re
    if (field === 'address' && hasAddressColumns) {
      select.value = String(addressColIndex);
      mappedColumns.add(addressColIndex);
      continue;
    }

    // Try to find best match
    let bestMatch = -1;
    let bestMatchScore = 0;

    for (let i = 0; i < csvImportState.headers.length; i++) {
      if (mappedColumns.has(i)) continue; // Skip already mapped columns

      const header = csvImportState.headers[i].toLowerCase().replace(/[\s_\-]/g, '');

      // Calculate match score
      for (const keyword of keywords) {
        const normalizedKeyword = keyword.toLowerCase().replace(/[\s_\-]/g, '');

        // Exact match = 100 points
        if (header === normalizedKeyword) {
          bestMatch = i;
          bestMatchScore = 100;
          break;
        }

        // Contains keyword = 50 points
        if (header.includes(normalizedKeyword)) {
          if (50 > bestMatchScore) {
            bestMatch = i;
            bestMatchScore = 50;
          }
        }

        // Keyword contains header = 30 points (for short headers)
        if (normalizedKeyword.includes(header) && header.length >= 3) {
          if (30 > bestMatchScore) {
            bestMatch = i;
            bestMatchScore = 30;
          }
        }
      }

      if (bestMatchScore === 100) break; // Perfect match found
    }

    if (bestMatch >= 0 && bestMatchScore >= 30) {
      select.value = String(bestMatch);
      mappedColumns.add(bestMatch);
    }
  }
}

function executeCSVImport() {
  // Get mapping
  csvImportState.mapping = {};

  for (const field of Object.keys(CSV_FIELD_MAPPING)) {
    const select = document.getElementById(`map_${field}`);

    if (select && select.value !== '') {
      csvImportState.mapping[field] = parseInt(select.value);
    }
  }

  // Check if at least name is mapped - vÃ©rifier avec 'in' pour Ã©viter le problÃ¨me avec la valeur 0
  if (!('lastName' in csvImportState.mapping) && !('firstName' in csvImportState.mapping)) {
    showToast('Mappez au moins le nom ou le prÃ©nom', 'error');
    return;
  }

  // Import data
  let imported = 0;
  let errors = [];
  let skipped = 0;
  let warnings = [];

  // Helper functions for validation
  const validateEmail = (email) => {
    if (!email) return true; // Email is optional
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(String(email).toLowerCase());
  };

  const validatePhone = (phone) => {
    if (!phone) return true; // Phone is optional
    // Accept various phone formats
    const cleaned = String(phone).replace(/[\s\.\-\(\)]/g, '');
    return /^[\+]?[\d]{8,15}$/.test(cleaned);
  };

  const normalizePhone = (phone) => {
    if (!phone) return '';
    let cleaned = String(phone).trim().replace(/[\s\.\-]/g, '');
    // Format french phone numbers
    if (cleaned.length === 10 && cleaned.startsWith('0')) {
      return cleaned.replace(/(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/, '$1 $2 $3 $4 $5');
    }
    return phone;
  };

  const cleanString = (str) => {
    if (!str) return '';
    return String(str).trim().replace(/\s+/g, ' ');
  };

  const isDuplicate = (patient) => {
    // Check for duplicate by name + dob or patientCode
    return state.patients.some(p => {
      // Check by patient code if both have it
      if (patient.patientCode && p.patientCode &&
          patient.patientCode.toLowerCase() === p.patientCode.toLowerCase()) {
        return true;
      }
      // Check by name and date of birth
      if (patient.lastName && p.lastName && patient.firstName && p.firstName && patient.dob && p.dob) {
        return patient.lastName.toLowerCase() === p.lastName.toLowerCase() &&
               patient.firstName.toLowerCase() === p.firstName.toLowerCase() &&
               patient.dob === p.dob;
      }
      return false;
    });
  };

  for (let i = 0; i < csvImportState.parsedData.length; i++) {
    const row = csvImportState.parsedData[i];

    try {
      // Extract values based on mapping
      const getValue = (field) => {
        const idx = csvImportState.mapping[field];
        if (idx === undefined) return '';
        const value = row[idx];
        return value !== null && value !== undefined ? String(value).trim() : '';
      };

      // Get basic info
      const lastName = cleanString(getValue('lastName'));
      const firstName = cleanString(getValue('firstName'));

      // Skip empty rows
      if (!lastName && !firstName) {
        skipped++;
        continue;
      }

      // DÃ©tecter et combiner les colonnes d'adresse si elles sont sÃ©parÃ©es
      let fullAddress = getValue('address');

      // Chercher des colonnes CP et VILLE non mappÃ©es qui pourraient complÃ©ter l'adresse
      if (fullAddress) {
        for (let j = 0; j < csvImportState.headers.length; j++) {
          const header = csvImportState.headers[j].toLowerCase();
          const value = row[j] ? String(row[j]).trim() : '';

          // Skip if this column is already mapped
          if (Object.values(csvImportState.mapping).includes(j)) {
            continue;
          }

          // Si on trouve un code postal non encore inclus
          if ((header.includes('cp') || header.includes('code postal') || header === 'postal') && value && !fullAddress.includes(value)) {
            fullAddress += ', ' + value;
          }
          // Si on trouve une ville non encore incluse
          else if ((header.includes('ville') || header.includes('city') || header.includes('commune')) && value && !fullAddress.toLowerCase().includes(value.toLowerCase())) {
            fullAddress += ' ' + value;
          }
        }
      }

      // Get and validate email
      const email = cleanString(getValue('email'));
      if (email && !validateEmail(email)) {
        warnings.push(`Ligne ${i + 2}: Email invalide "${email}" - ignorÃ©`);
      }

      // Get and normalize phone
      let phone = cleanString(getValue('phone'));
      if (phone && !validatePhone(phone)) {
        warnings.push(`Ligne ${i + 2}: TÃ©lÃ©phone invalide "${phone}" - conservÃ© tel quel`);
      } else if (phone) {
        phone = normalizePhone(phone);
      }

      const patient = {
        id: generateId(),
        lastName: lastName,
        firstName: firstName,
        dob: convertDateFormat(getValue('dob')),
        email: email && validateEmail(email) ? email : '',
        phone: phone,
        address: cleanString(fullAddress),
        patientCode: cleanString(getValue('patientCode')),
        renewalDate: convertDateFormat(getValue('renewalDate')),
        notes: cleanString(getValue('notes')),
        createdAt: Date.now(),
        updatedAt: Date.now()
      };

      // Check for duplicates
      if (isDuplicate(patient)) {
        warnings.push(`Ligne ${i + 2}: Patient "${firstName} ${lastName}" existe dÃ©jÃ  - ignorÃ©`);
        skipped++;
        continue;
      }

      // Handle doctor
      const docName = cleanString(getValue('docName'));
      if (docName) {
        let doc = state.docs.find(d => d.name.toLowerCase() === docName.toLowerCase());
        if (!doc) {
          doc = { id: generateId(), name: docName };
          state.docs.push(doc);
        }
        patient.docId = doc.id;
      }

      // Handle center
      const centerName = cleanString(getValue('centerName'));
      if (centerName) {
        let center = state.centers.find(c => c.name.toLowerCase() === centerName.toLowerCase());
        if (!center) {
          center = { id: generateId(), name: centerName };
          state.centers.push(center);
        }
        patient.centerId = center.id;
      }

      // Handle protocol
      const protoName = cleanString(getValue('protoName'));
      if (protoName) {
        let proto = state.protos.find(p => p.name.toLowerCase() === protoName.toLowerCase());
        if (!proto) {
          proto = { id: generateId(), name: protoName };
          state.protos.push(proto);
        }
        patient.protoId = proto.id;
      }

      // Calculate cycle from renewal date
      if (patient.renewalDate) {
        const cycleInfo = getCycleFromDate(patient.renewalDate);
        if (cycleInfo) {
          patient.currentCycle = `C${cycleInfo.cycle}-${cycleInfo.year}`;
        }
      }

      // Add patient if valid
      if (patient.lastName || patient.firstName) {
        state.patients.push(patient);
        imported++;
      }
    } catch (err) {
      errors.push(`Ligne ${i + 2}: ${err.message}`);
    }
  }

  // Save and refresh
  saveDB();
  render();

  // Show results
  showModal(false, 'csvImportModal');

  let message = `âœ… ${imported} patient(s) importÃ©(s)`;
  if (skipped > 0) {
    message += ` | â­ï¸ ${skipped} ignorÃ©(s)`;
  }
  if (errors.length > 0) {
    message += ` | âŒ ${errors.length} erreur(s)`;
    console.error('Erreurs d\'import:', errors);
  }
  if (warnings.length > 0) {
    message += ` | âš ï¸ ${warnings.length} avertissement(s)`;
    console.warn('Avertissements d\'import:', warnings);
  }

  showToast(message, imported > 0 ? 'success' : (errors.length > 0 ? 'error' : 'warning'));

  // Show detailed results if there are errors or warnings
  if (errors.length > 0 || warnings.length > 0) {
    setTimeout(() => {
      let detailMessage = '';
      if (errors.length > 0) {
        detailMessage += 'ERREURS:\n' + errors.slice(0, 5).join('\n');
        if (errors.length > 5) detailMessage += `\n... et ${errors.length - 5} autre(s) erreur(s)`;
      }
      if (warnings.length > 0) {
        if (detailMessage) detailMessage += '\n\n';
        detailMessage += 'AVERTISSEMENTS:\n' + warnings.slice(0, 5).join('\n');
        if (warnings.length > 5) detailMessage += `\n... et ${warnings.length - 5} autre(s) avertissement(s)`;
      }
      if (confirm(detailMessage + '\n\nVoir la console pour plus de dÃ©tails ?')) {
        console.log('=== RAPPORT D\'IMPORT DÃ‰TAILLÃ‰ ===');
        if (errors.length > 0) {
          console.error('Erreurs:', errors);
        }
        if (warnings.length > 0) {
          console.warn('Avertissements:', warnings);
        }
      }
    }, 500);
  }
}

function convertDateFormat(dateStr) {
  if (!dateStr) return '';

  // Nettoyer la chaÃ®ne
  dateStr = String(dateStr).trim();
  if (!dateStr) return '';

  // GÃ©rer les dates au format ISO avec heures (ex: "2025-11-01 00:00:00")
  if (dateStr.includes(' ')) {
    dateStr = dateStr.split(' ')[0]; // Prendre seulement la partie date
  }

  // GÃ©rer les nombres (format Excel : nombre de jours depuis 1900-01-01)
  const asNumber = parseFloat(dateStr);
  if (!isNaN(asNumber) && asNumber > 1000 && asNumber < 100000) {
    // C'est probablement un nombre de jours Excel
    const excelEpoch = new Date(1899, 11, 30); // Excel compte Ã  partir du 30/12/1899
    const date = new Date(excelEpoch.getTime() + asNumber * 24 * 60 * 60 * 1000);
    if (!isNaN(date.getTime()) && isValidDate(date)) {
      return formatDateFR(date);
    }
  }

  // Try different date formats
  const formats = [
    /^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})$/, // DD/MM/YYYY or DD-MM-YYYY or DD.MM.YYYY
    /^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})$/,   // YYYY-MM-DD or YYYY.MM.DD
    /^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2})$/    // DD/MM/YY
  ];

  for (const format of formats) {
    const match = dateStr.match(format);
    if (match) {
      let day, month, year;

      if (format === formats[0]) {
        day = parseInt(match[1]);
        month = parseInt(match[2]);
        year = match[3].length === 2 ? parseInt('20' + match[3]) : parseInt(match[3]);
      } else if (format === formats[1]) {
        year = parseInt(match[1]);
        month = parseInt(match[2]);
        day = parseInt(match[3]);
      } else {
        day = parseInt(match[1]);
        month = parseInt(match[2]);
        year = parseInt('20' + match[3]);
      }

      // Validate the date components
      if (month < 1 || month > 12) {
        continue; // Invalid month, try next format
      }

      if (day < 1 || day > 31) {
        continue; // Invalid day, try next format
      }

      // Check if it's a valid date (e.g., not 31/02/2025)
      const testDate = new Date(year, month - 1, day);
      if (testDate.getDate() !== day || testDate.getMonth() !== month - 1 || testDate.getFullYear() !== year) {
        continue; // Invalid date
      }

      // Check year is reasonable (between 1900 and 2100)
      if (year < 1900 || year > 2100) {
        continue;
      }

      return `${String(day).padStart(2, '0')}/${String(month).padStart(2, '0')}/${year}`;
    }
  }

  // Try parsing as a Date object
  const date = new Date(dateStr);
  if (!isNaN(date.getTime()) && isValidDate(date)) {
    return formatDateFR(date);
  }

  return ''; // Return empty string if no valid format matches
}

// Helper function to validate dates
function isValidDate(date) {
  if (!(date instanceof Date) || isNaN(date.getTime())) {
    return false;
  }

  const year = date.getFullYear();
  // Accept dates between 1900 and 2100
  return year >= 1900 && year <= 2100;
}

// ===== CSV Import Advanced Functions =====
let csvCurrentData = null;
let csvCurrentMapping = {};

// Field configuration for mapping
const CSV_FIELD_CONFIG = {
  '': { label: '-- Ignorer cette colonne --', required: false },
  lastName: { label: 'Nom de famille', required: true },
  firstName: { label: 'PrÃ©nom', required: true },
  dob: { label: 'Date de naissance', required: false },
  email: { label: 'Email', required: false },
  phone: { label: 'TÃ©lÃ©phone', required: false },
  address: { label: 'Adresse', required: false },
  patientCode: { label: 'Code patient', required: false },
  docName: { label: 'MÃ©decin (nom)', required: false },
  centerName: { label: 'Centre (nom)', required: false },
  protoName: { label: 'Protocole/MatÃ©riel (nom)', required: false },
  renewalDate: { label: 'Date renouvellement', required: false },
  notes: { label: 'Notes/Remarques', required: false }
};

// Content patterns for auto-detection
const CSV_CONTENT_PATTERNS = {
  lastName: {
    keywords: ['nom', 'last_name', 'lastname', 'surname', 'name'],
    validator: (val) => /^[a-zÃ Ã¢Ã¤Ã©Ã¨ÃªÃ«Ã¯Ã®Ã´Ã¹Ã»Ã¼Ã¿Ã§Å“Ã¦\s\-']+$/i.test(val) && val.length >= 2
  },
  firstName: {
    keywords: ['prenom', 'prÃ©nom', 'first_name', 'firstname', 'givenname'],
    validator: (val) => /^[a-zÃ Ã¢Ã¤Ã©Ã¨ÃªÃ«Ã¯Ã®Ã´Ã¹Ã»Ã¼Ã¿Ã§Å“Ã¦\s\-']+$/i.test(val) && val.length >= 2
  },
  email: {
    keywords: ['email', 'mail', 'courriel', 'e-mail'],
    validator: (val) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val)
  },
  phone: {
    keywords: ['telephone', 'tÃ©lÃ©phone', 'phone', 'tel', 'mobile', 'portable'],
    validator: (val) => /^[\d\s\.\-\+\(\)]{8,}$/.test(val)
  },
  address: {
    keywords: ['adresse', 'address', 'rue', 'street', 'domicile'],
    validator: (val) => val.length >= 5
  },
  dob: {
    keywords: ['naissance', 'birth', 'dob', 'date_naissance', 'date_of_birth', 'nÃ©'],
    validator: (val) => /^\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}$/.test(val) || /^\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2}$/.test(val)
  },
  renewalDate: {
    keywords: ['renouvellement', 'renewal', 'ordonnance', 'date_renouvellement', 'renew'],
    validator: (val) => /^\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}$/.test(val) || /^\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2}$/.test(val)
  },
  docName: {
    keywords: ['medecin', 'mÃ©decin', 'doctor', 'doc', 'docteur', 'dr'],
    validator: (val) => /^[a-zÃ Ã¢Ã¤Ã©Ã¨ÃªÃ«Ã¯Ã®Ã´Ã¹Ã»Ã¼Ã¿Ã§Å“Ã¦\s\.\-']+$/i.test(val) && val.length >= 3
  },
  centerName: {
    keywords: ['centre', 'center', 'site', 'Ã©tablissement'],
    validator: (val) => val.length >= 3
  },
  protoName: {
    keywords: ['protocole', 'protocol', 'proto', 'matÃ©riel', 'materiel'],
    validator: (val) => val.length >= 3
  },
  patientCode: {
    keywords: ['code', 'id', 'identifiant', 'patient_code', 'patient_id'],
    validator: (val) => /^[a-z0-9\-]+$/i.test(val)
  },
  notes: {
    keywords: ['notes', 'note', 'commentaire', 'comment', 'remarque', 'observation'],
    validator: (val) => true
  }
};

// Initialize CSV Import
function initCSVImport() {
  const dropZone = byId('dropZone');
  const fileInput = byId('csvFileInputAdv');
  
  // Click to select
  dropZone.addEventListener('click', () => fileInput.click());
  
  // File selection
  fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
      csvHandleFile(e.target.files[0]);
    }
  });
  
  // Drag and drop
  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.style.background = 'var(--primary)';
    dropZone.style.color = 'white';
  });
  
  dropZone.addEventListener('dragleave', () => {
    dropZone.style.background = 'var(--bg-tertiary)';
    dropZone.style.color = '';
  });
  
  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.style.background = 'var(--bg-tertiary)';
    dropZone.style.color = '';
    
    if (e.dataTransfer.files.length > 0) {
      csvHandleFile(e.dataTransfer.files[0]);
    }
  });
  
  // Checkbox handlers
  byId('csvHasHeaders')?.addEventListener('change', () => {
    if (csvCurrentData) {
      csvDisplayMappingTable();
      if (byId('csvAutoDetect').checked) {
        setTimeout(() => csvAutoDetectMapping(), 300);
      }
    }
  });
}

// Handle file
function csvHandleFile(file) {
  const fileName = file.name.toLowerCase();
  const isExcel = fileName.endsWith('.xlsx') || fileName.endsWith('.xls');
  
  if (isExcel) {
    // Handle Excel files with SheetJS
    const reader = new FileReader();
    
    reader.onload = (e) => {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        
        // Get first sheet
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        
        // Convert to array of arrays
        const rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
        
        if (rawData.length === 0) {
          csvShowAlert('Fichier Excel vide', 'error');
          return;
        }
        
        const hasHeaders = byId('csvHasHeaders').checked;
        let headers = [];
        let rows = [];
        
        if (hasHeaders && rawData.length > 0) {
          headers = rawData[0].map((h, i) => String(h).trim() || `Colonne ${i + 1}`);
          rows = rawData.slice(1).filter(row => row.some(cell => cell));
        } else {
          headers = rawData[0].map((_, i) => `Colonne ${i + 1}`);
          rows = rawData.filter(row => row.some(cell => cell));
        }
        
        // Normalize rows to have same length as headers
        rows = rows.map(row => {
          const normalized = [...row];
          while (normalized.length < headers.length) {
            normalized.push('');
          }
          return normalized.slice(0, headers.length).map(v => String(v).trim());
        });
        
        const result = {
          headers,
          rows,
          separator: 'Excel',
          fileName: file.name,
          format: fileName.endsWith('.xlsx') ? 'XLSX' : 'XLS'
        };
        
        csvProcessParsedData(result);
        
      } catch (error) {
        csvShowAlert('Erreur de lecture du fichier Excel: ' + error.message, 'error');
        console.error('Excel parsing error:', error);
      }
    };
    
    reader.readAsArrayBuffer(file);
    
  } else {
    // Handle text files (CSV, TSV, TXT)
    const reader = new FileReader();
    
    reader.onload = (e) => {
      const text = e.target.result;
      const result = csvParseFile(text, file.name);
      
      if (!result) return;
      
      csvProcessParsedData(result);
    };
    
    reader.readAsText(file, 'UTF-8');
  }
}

// Process parsed data (common for both Excel and CSV)
function csvProcessParsedData(result) {
  const numCols = result.headers.length;
  const numRows = result.rows.length;
  
  // Store data
  csvCurrentData = {
    headers: result.headers,
    rows: result.rows
  };
  csvCurrentMapping = {};
  
  // Display info
  csvDisplayFileInfo(result, numCols, numRows);
  csvDisplayMappingTable();
  
  // Auto-detect if enabled
  if (byId('csvAutoDetect').checked) {
    setTimeout(() => csvAutoDetectMapping(), 300);
  }
  
  // Show containers
  byId('csvFileInfo').style.display = 'block';
  byId('csvOptionsPanel').style.display = 'block';
  byId('csvPreviewContainer').style.display = 'block';
  
  csvUpdateStats();
}

// Parse CSV file
function csvParseFile(text, fileName) {
  try {
    // Auto-detect separator
    const separators = [';', ',', '\t', '|'];
    let bestSep = ',';
    let maxCols = 0;
    
    for (const sep of separators) {
      const firstLine = text.split('\n')[0];
      const cols = firstLine.split(sep).length;
      if (cols > maxCols) {
        maxCols = cols;
        bestSep = sep;
      }
    }
    
    const lines = text.split('\n').filter(line => line.trim());
    if (lines.length === 0) {
      csvShowAlert('Fichier vide', 'error');
      return null;
    }
    
    const hasHeaders = byId('csvHasHeaders').checked;
    let headers = [];
    let startRow = 0;
    
    if (hasHeaders && lines.length > 0) {
      headers = lines[0].split(bestSep).map((h, i) => h.trim() || `Colonne ${i + 1}`);
      startRow = 1;
    } else {
      const firstRow = lines[0].split(bestSep);
      headers = firstRow.map((_, i) => `Colonne ${i + 1}`);
      startRow = 0;
    }
    
    const rows = [];
    for (let i = startRow; i < lines.length; i++) {
      const values = lines[i].split(bestSep).map(v => v.trim());
      if (values.some(v => v)) {
        rows.push(values);
      }
    }
    
    const format = fileName.endsWith('.tsv') ? 'TSV' : 
                   fileName.endsWith('.txt') ? 'TXT' : 'CSV';
    
    return {
      headers,
      rows,
      separator: bestSep,
      fileName,
      format
    };
  } catch (error) {
    csvShowAlert('Erreur de lecture du fichier: ' + error.message, 'error');
    return null;
  }
}

// Display file info
function csvDisplayFileInfo(result, numCols, numRows) {
  const content = byId('csvFileInfoContent');
  const sepInfo = result.separator ? 
    `<div style="background: white; padding: 10px; border-radius: 6px;">
      <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px;">SÃ©parateur</div>
      <div style="font-size: 16px; font-weight: 600; color: #27ae60;">${result.separator === '\t' ? 'Tabulation' : result.separator}</div>
    </div>` : '';
  
  content.innerHTML = `
    <div style="background: white; padding: 10px; border-radius: 6px;">
      <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px;">Fichier</div>
      <div style="font-size: 16px; font-weight: 600; color: #27ae60;">${result.fileName}</div>
    </div>
    <div style="background: white; padding: 10px; border-radius: 6px;">
      <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px;">Format</div>
      <div style="font-size: 16px; font-weight: 600; color: #27ae60;">${result.format}</div>
    </div>
    ${sepInfo}
    <div style="background: white; padding: 10px; border-radius: 6px;">
      <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px;">Colonnes</div>
      <div style="font-size: 16px; font-weight: 600; color: #27ae60;">${numCols}</div>
    </div>
    <div style="background: white; padding: 10px; border-radius: 6px;">
      <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px;">Lignes</div>
      <div style="font-size: 16px; font-weight: 600; color: #27ae60;">${numRows}</div>
    </div>
  `;
}

// Display mapping table
function csvDisplayMappingTable() {
  const table = byId('csvMappingTable');
  const hasHeaders = byId('csvHasHeaders').checked;
  const headers = csvCurrentData.headers;
  const rows = csvCurrentData.rows;
  const maxPreviewRows = Math.min(10, rows.length);
  
  let html = '<thead><tr><th style="background: #34495e; padding: 15px; color: white; text-align: center; position: sticky; top: 0; z-index: 10;">#</th>';
  
  // Column headers with mapping selects
  headers.forEach((header, colIndex) => {
    html += `
      <th style="background: #34495e; padding: 15px 10px; text-align: center; border-right: 1px solid #2c3e50; position: sticky; top: 0; z-index: 10;">
        <div style="color: #95a5a6; font-size: 11px; font-weight: 600; margin-bottom: 8px; text-transform: uppercase;">Colonne ${colIndex + 1}</div>
        <div style="color: #ecf0f1; font-size: 12px; font-style: italic; margin-bottom: 10px; min-height: 20px; word-break: break-word;">
          ${header && header !== 'Colonne ${colIndex + 1}' ? header : '<span style="color: #95a5a6;">(sans titre)</span>'}
        </div>
        <div>
          <select class="mapping-select" data-col-index="${colIndex}" onchange="csvOnMappingChange(${colIndex})" style="width: 100%; padding: 8px 10px; border: 2px solid #95a5a6; border-radius: 6px; background: white; font-size: 13px; cursor: pointer; transition: all 0.2s; appearance: none; background-image: url('data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'12\\' height=\\'12\\' viewBox=\\'0 0 12 12\\'%3E%3Cpath fill=\\'%23666\\' d=\\'M6 9L1 4h10z\\'/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 8px center; padding-right: 30px;">
            ${Object.entries(CSV_FIELD_CONFIG).map(([key, config]) => 
              `<option value="${key}">${config.label}</option>`
            ).join('')}
          </select>
          <div class="confidence-badge" id="csv-confidence-${colIndex}" style="display: none; margin-top: 5px; padding: 3px 8px; border-radius: 12px; font-size: 10px; font-weight: 600;"></div>
        </div>
      </th>
    `;
  });
  
  html += '</tr></thead><tbody>';
  
  // Data rows
  for (let i = 0; i < maxPreviewRows; i++) {
    html += `<tr style="border-bottom: 1px solid #ecf0f1;"><td style="background: #f8f9fa; color: #7f8c8d; font-weight: 600; text-align: center; font-size: 12px; padding: 12px 10px; border-right: 2px solid #e0e0e0;">${i + 1}</td>`;
    
    headers.forEach((_, colIndex) => {
      const value = rows[i]?.[colIndex] || '';
      const displayValue = String(value).length > 30 ? String(value).substring(0, 27) + '...' : value;
      html += `
        <td style="padding: 12px 10px; border-right: 1px solid #ecf0f1; font-size: 13px; color: var(--text-primary); max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${String(value).replace(/"/g, '&quot;')}">
          ${displayValue || '<span style="color: #95a5a6; font-style: italic;">â€”</span>'}
        </td>
      `;
    });
    
    html += '</tr>';
  }
  
  html += '</tbody>';
  
  if (rows.length > maxPreviewRows) {
    html += `<tfoot><tr><td colspan="${headers.length + 1}" style="text-align: center; padding: 15px; color: #7f8c8d; font-style: italic;">
      ... et ${rows.length - maxPreviewRows} autres lignes
    </td></tr></tfoot>`;
  }
  
  table.innerHTML = html;
}

// On mapping change
function csvOnMappingChange(colIndex) {
  const select = document.querySelector(`.mapping-select[data-col-index="${colIndex}"]`);
  const value = select.value;
  
  if (value) {
    csvCurrentMapping[colIndex] = value;
    select.style.borderColor = '#27ae60';
    select.style.backgroundColor = '#e8f5e9';
    select.style.fontWeight = '600';
    
    // Hide confidence badge when manually set
    const badge = byId(`csv-confidence-${colIndex}`);
    if (badge) badge.style.display = 'none';
  } else {
    delete csvCurrentMapping[colIndex];
    select.style.borderColor = '#95a5a6';
    select.style.backgroundColor = 'white';
    select.style.fontWeight = 'normal';
  }
  
  csvUpdateStats();
  csvValidateMapping();
}

// Auto-detect mapping
function csvAutoDetectMapping() {
  if (!csvCurrentData) return;
  
  csvShowAlert('ðŸŽ¯ DÃ©tection automatique en cours...', 'info');
  
  csvCurrentMapping = {};
  const headers = csvCurrentData.headers;
  const rows = csvCurrentData.rows;
  const hasHeaders = byId('csvHasHeaders').checked;
  
  headers.forEach((header, colIndex) => {
    const select = document.querySelector(`.mapping-select[data-col-index="${colIndex}"]`);
    const badge = byId(`csv-confidence-${colIndex}`);
    
    // Analyze column content
    const columnData = rows.slice(0, 20).map(row => row[colIndex]).filter(v => v);
    
    let bestMatch = { field: '', confidence: 0 };
    
    // Method 1: Header analysis (if present)
    if (hasHeaders && header && header !== `Colonne ${colIndex + 1}`) {
      for (const [field, pattern] of Object.entries(CSV_CONTENT_PATTERNS)) {
        if (!pattern.keywords) continue;
        const headerLower = header.toLowerCase();
        for (const keyword of pattern.keywords) {
          if (headerLower.includes(keyword)) {
            const score = 85 + (headerLower === keyword ? 15 : 0);
            if (score > bestMatch.confidence) {
              bestMatch = { field, confidence: score };
            }
          }
        }
      }
    }
    
    // Method 2: Content analysis
    if (columnData.length > 0 && bestMatch.confidence < 90) {
      for (const [field, pattern] of Object.entries(CSV_CONTENT_PATTERNS)) {
        if (!pattern.validator) continue;
        
        const validCount = columnData.filter(val => pattern.validator(val)).length;
        const validRatio = validCount / columnData.length;
        
        if (validRatio > 0.6) {
          const contentScore = Math.round(validRatio * 100);
          if (contentScore > bestMatch.confidence) {
            bestMatch = { field, confidence: contentScore };
          }
        }
      }
    }
    
    // Apply mapping if confidence sufficient
    if (bestMatch.field && bestMatch.confidence >= 60) {
      csvCurrentMapping[colIndex] = bestMatch.field;
      select.value = bestMatch.field;
      select.style.borderColor = '#f39c12';
      select.style.backgroundColor = '#fff3cd';
      
      // Show confidence badge
      const confidenceClass = bestMatch.confidence >= 85 ? 'confidence-high' : 
                             bestMatch.confidence >= 70 ? 'confidence-medium' : 'confidence-low';
      const badgeColors = {
        'confidence-high': { bg: '#d4edda', color: '#155724' },
        'confidence-medium': { bg: '#fff3cd', color: '#856404' },
        'confidence-low': { bg: '#f8d7da', color: '#721c24' }
      };
      const colors = badgeColors[confidenceClass];
      badge.style.background = colors.bg;
      badge.style.color = colors.color;
      badge.textContent = `${bestMatch.confidence}%`;
      badge.style.display = 'inline-block';
    } else {
      select.value = '';
      select.style.borderColor = '#95a5a6';
      select.style.backgroundColor = 'white';
      if (badge) badge.style.display = 'none';
    }
  });
  
  csvUpdateStats();
  csvValidateMapping();
  
  const mappedCount = Object.keys(csvCurrentMapping).length;
  if (mappedCount > 0) {
    csvShowAlert(`âœ… ${mappedCount} colonne(s) dÃ©tectÃ©e(s) automatiquement. VÃ©rifiez et ajustez si nÃ©cessaire.`, 'success');
  } else {
    csvShowAlert('âš ï¸ Aucune colonne dÃ©tectÃ©e automatiquement. Veuillez faire le mapping manuellement.', 'warning');
  }
}

// Clear mapping
function csvClearMapping() {
  csvCurrentMapping = {};
  document.querySelectorAll('.mapping-select').forEach(select => {
    select.value = '';
    select.style.borderColor = '#95a5a6';
    select.style.backgroundColor = 'white';
    select.style.fontWeight = 'normal';
  });
  document.querySelectorAll('.confidence-badge').forEach(badge => {
    badge.style.display = 'none';
  });
  csvUpdateStats();
  csvValidateMapping();
  csvShowAlert('Mapping effacÃ©', 'info');
}

// Redetect
function csvRedetect() {
  csvClearMapping();
  setTimeout(() => csvAutoDetectMapping(), 100);
}

// Update stats
function csvUpdateStats() {
  if (!csvCurrentData) return;
  
  byId('csvColCount').textContent = csvCurrentData.headers.length;
  byId('csvRowCountStat').textContent = csvCurrentData.rows.length;
  byId('csvMappedCount').textContent = Object.keys(csvCurrentMapping).length;
}

// Validate mapping
function csvValidateMapping() {
  const requiredFields = Object.entries(CSV_FIELD_CONFIG)
    .filter(([_, config]) => config.required)
    .map(([key, _]) => key);
  
  const mappedFields = Object.values(csvCurrentMapping);
  const missingRequired = requiredFields.filter(f => !mappedFields.includes(f));
  
  const btnImport = byId('csvBtnImport');
  
  if (missingRequired.length > 0) {
    btnImport.disabled = true;
    const fieldLabels = missingRequired.map(f => CSV_FIELD_CONFIG[f].label).join(', ');
    csvShowAlert(`âš ï¸ Champs obligatoires manquants: ${fieldLabels}`, 'warning');
  } else {
    btnImport.disabled = false;
    csvHideAlert();
  }
}

// Execute import
function csvExecuteImport() {
  if (!csvCurrentData || Object.keys(csvCurrentMapping).length === 0) {
    showToast('Veuillez mapper au moins une colonne', 'error');
    return;
  }
  
  // Build mapped data
  const mappedData = csvCurrentData.rows.map((row, rowIndex) => {
    const patient = {};
    
    Object.entries(csvCurrentMapping).forEach(([colIndex, fieldName]) => {
      patient[fieldName] = row[colIndex] || '';
    });
    
    return patient;
  });
  
  // Import data
  let imported = 0;
  let errors = [];
  
  for (let i = 0; i < mappedData.length; i++) {
    try {
      const data = mappedData[i];
      
      const patient = {
        id: generateId(),
        lastName: data.lastName || '',
        firstName: data.firstName || '',
        dob: convertDateFormat(data.dob || ''),
        email: data.email || '',
        phone: data.phone || '',
        address: data.address || '',
        patientCode: data.patientCode || '',
        renewalDate: convertDateFormat(data.renewalDate || ''),
        notes: data.notes || '',
        createdAt: Date.now(),
        updatedAt: Date.now(),
        history: [{
          date: Date.now(),
          type: 'created',
          field: 'CrÃ©ation',
          oldValue: '',
          newValue: 'Patient crÃ©Ã© via import CSV'
        }]
      };
      
      // Handle doctor
      if (data.docName) {
        let doc = state.docs.find(d => d.name === data.docName);
        if (!doc) {
          doc = { id: generateId(), name: data.docName };
          state.docs.push(doc);
        }
        patient.docId = doc.id;
      }
      
      // Handle center
      if (data.centerName) {
        let center = state.centers.find(c => c.name === data.centerName);
        if (!center) {
          center = { id: generateId(), name: data.centerName };
          state.centers.push(center);
        }
        patient.centerId = center.id;
      }
      
      // Handle protocol
      if (data.protoName) {
        let proto = state.protos.find(p => p.name === data.protoName);
        if (!proto) {
          proto = { id: generateId(), name: data.protoName };
          state.protos.push(proto);
        }
        patient.protoId = proto.id;
      }
      
      // Calculate cycle from renewal date
      if (patient.renewalDate) {
        const cycleInfo = getCycleFromDate(patient.renewalDate);
        if (cycleInfo) {
          patient.currentCycle = `C${cycleInfo.cycle}-${cycleInfo.year}`;
        }
      }
      
      // Add patient if valid
      if (patient.lastName || patient.firstName) {
        state.patients.push(patient);
        imported++;
      }
    } catch (err) {
      errors.push(`Ligne ${i + 2}: ${err.message}`);
    }
  }
  
  // Save and refresh
  saveDB();
  render();
  
  // Close modal
  csvReset();
  showModal(false, 'csvImportModal');
  
  // Show results
  let message = `âœ… ${imported} patient(s) importÃ©(s)`;
  if (errors.length > 0) {
    message += ` | âš ï¸ ${errors.length} erreur(s)`;
    console.log('Erreurs d\'import:', errors);
  }
  showToast(message, imported > 0 ? 'success' : 'warning');
}

// Reset
function csvReset() {
  csvCurrentData = null;
  csvCurrentMapping = {};
  byId('csvFileInfo').style.display = 'none';
  byId('csvOptionsPanel').style.display = 'none';
  byId('csvPreviewContainer').style.display = 'none';
  byId('csvFileInputAdv').value = '';
  csvHideAlert();
}

// Show alert
function csvShowAlert(message, type) {
  const alertBox = byId('csvAlertBox');
  const colors = {
    'info': { bg: 'rgba(59, 130, 246, 0.1)', border: 'var(--primary)', color: 'var(--primary)' },
    'success': { bg: '#e8f5e9', border: '#27ae60', color: '#27ae60' },
    'warning': { bg: '#fff3cd', border: '#f39c12', color: '#856404' },
    'error': { bg: '#f8d7da', border: '#ef4444', color: '#721c24' }
  };
  const style = colors[type] || colors.info;
  alertBox.style.background = style.bg;
  alertBox.style.borderLeft = `4px solid ${style.border}`;
  alertBox.style.color = style.color;
  alertBox.style.display = 'block';
  alertBox.textContent = message;
}

// Hide alert
function csvHideAlert() {
  const alertBox = byId('csvAlertBox');
  alertBox.style.display = 'none';
}

// ===== Theme Toggle =====
function toggleTheme() {
  const html = document.documentElement;
  const current = html.getAttribute('data-theme');
  const newTheme = current === 'dark' ? 'light' : 'dark';
  
  html.setAttribute('data-theme', newTheme);
  localStorage.setItem('nhc-theme', newTheme);
  
  const icon = byId('themeIcon');
  const text = byId('themeText');
  
  if (newTheme === 'dark') {
    icon.textContent = 'â˜€ï¸';
    text.textContent = 'Mode clair';
  } else {
    icon.textContent = 'ðŸŒ™';
    text.textContent = 'Mode sombre';
  }
}

// ===== Search Function =====
function performSearch(query) {
  query = query.trim().toLowerCase();
  if (!query) {
    render();
    return;
  }
  
  switchView('patients');
  const tbody = qsEl('#tblPatients tbody');
  if (!tbody) return;
  
  const filtered = state.patients.filter(p => {
    const searchText = [
      fullName(p),
      p.email || '',
      p.phone || '',
      p.address || '',
      docName(p.docId) || '',
      centerName(p.centerId) || '',
      protoName(p.protoId) || '',
      p.renewalDate || ''
    ].join(' ').toLowerCase();
    
    return searchText.includes(query);
  });
  
  tbody.innerHTML = filtered.map(p => {
    const cycleInfo = getCycleFromDate(p.renewalDate);
    const cycleLabel = cycleInfo ? `${cycleInfo.name} ${cycleInfo.year}` : 'â€”';

    return `
      <tr style="cursor: pointer;" onclick="viewPatientDetails('${p.id}')" title="Cliquer pour voir les dÃ©tails">
        <td style="font-weight: 600;">${fullName(p)}</td>
        <td>${protoName(p.protoId) || 'â€”'}</td>
        <td>${docName(p.docId) || 'â€”'}</td>
        <td>${centerName(p.centerId) || 'â€”'}</td>
        <td>${p.renewalDate ? `<div>${p.renewalDate}</div><div class="text-small text-muted">${cycleLabel}</div>` : 'â€”'}</td>
      </tr>
    `;
  }).join('');
  
  showToast(`${filtered.length} rÃ©sultat(s)`, 'info');
}

// ===== Event Bindings =====
function bindEvents() {
  // Navigation
  byId('nav')?.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-view]');
    if (btn) switchView(btn.dataset.view);
  });
  
  // Quick Actions Menu
  const qaBtn = byId('btnQuickActions');
  const qaMenu = byId('qaMenu');
  
  qaBtn?.addEventListener('click', () => {
    qaMenu.classList.toggle('show');
  });
  
  document.addEventListener('click', (e) => {
    if (!e.target.closest('#qaMenu') && !e.target.closest('#btnQuickActions')) {
      qaMenu?.classList.remove('show');
    }
  });
  
  qaMenu?.addEventListener('click', (e) => {
    const item = e.target.closest('.dropdown-item');
    if (!item) return;
    
    const action = item.dataset.qa;
    qaMenu.classList.remove('show');
    
    switch(action) {
      case 'fastCheck':
        fcOpen();
        break;
      case 'scanLegacy':
        scanLegacyBases();
        break;
      case 'restoreRefs':
        restoreRefs();
        break;
      case 'safeReset':
        if (confirm('RÃ©initialiser la base de donnÃ©es ?')) {
          localStorage.removeItem(DB_KEY);
          state = { patients: [], docs: [], centers: [], protos: [] };
          initDemoData();
          render();
          showToast('Base rÃ©initialisÃ©e', 'success');
        }
        break;
      case 'purgeAll':
        if (confirm('âš ï¸ PURGE TOTALE - Cette action est irrÃ©versible. Continuer ?')) {
          if (confirm('ÃŠtes-vous vraiment sÃ»r ?')) {
            localStorage.clear();
            state = { patients: [], docs: [], centers: [], protos: [] };
            saveDB();
            render();
            showToast('Purge totale effectuÃ©e', 'success');
          }
        }
        break;
    }
  });
  
  // Search
  byId('globalSearch')?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      performSearch(e.target.value);
    }
  });
  
  document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
      e.preventDefault();
      byId('globalSearch')?.focus();
    }
  });
  
  // Patient Modal
  byId('btnSavePatient')?.addEventListener('click', savePatient);
  byId('btnDeletePatient')?.addEventListener('click', deletePatient);
  byId('btnChangeStatus')?.addEventListener('click', changePatientStatus);
  byId('closePatient')?.addEventListener('click', () => showModal(false));
  byId('btnAddPatient')?.addEventListener('click', newPatient);
  byId('btnImportCSV')?.addEventListener('click', openCSVImport);
  
  // Renewal date input
  byId('renewalDate')?.addEventListener('input', updateCycleInfo);
  
  // Sort
  byId('sortPatients')?.addEventListener('change', render);
  byId('filterArchivedStatus')?.addEventListener('change', renderArchivedPatients);
  byId('sortArchived')?.addEventListener('change', renderArchivedPatients);
  
  // Table Actions
  document.body.addEventListener('click', (e) => {
    const action = e.target.closest('[data-action]');
    if (!action) return;
    
    const id = action.dataset.id || action.dataset.patientId;
    
    switch(action.dataset.action) {
      case 'reactivate':
        reactivatePatient(id);
        break;
      case 'viewDetails':
        viewPatientDetails(id);
        break;
      case 'open':
        openPatient(id);
        break;
      case 'delDoc':
        if (confirm('Supprimer ce mÃ©decin ?')) {
          state.docs = state.docs.filter(d => d.id !== id);
          saveDB();
          renderCatalogs();
          showToast('MÃ©decin supprimÃ©', 'success');
        }
        break;
      case 'delCenter':
        if (confirm('Supprimer ce centre ?')) {
          state.centers = state.centers.filter(c => c.id !== id);
          saveDB();
          renderCatalogs();
          showToast('Centre supprimÃ©', 'success');
        }
        break;
      case 'delProto':
        if (confirm('Supprimer ce protocole ?')) {
          state.protos = state.protos.filter(p => p.id !== id);
          saveDB();
          renderCatalogs();
          showToast('Protocole supprimÃ©', 'success');
        }
        break;
      case 'validateAppointment':
        const appointmentId = action.dataset.appointmentId;
        if (appointmentId) {
          validateAppointment(appointmentId);
        }
        break;
      case 'scheduleNext':
        const patientId = action.dataset.patientId;
        const currentAptId = action.dataset.currentAptId;
        if (patientId) {
          scheduleNextAppointment(patientId, currentAptId);
        }
        break;
    }
  });
  
  // Export/Import
  byId('btnExportJson')?.addEventListener('click', exportJson);
  byId('btnExportRefs')?.addEventListener('click', exportRefs);
  
  byId('fileImport')?.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
      try {
        const parsed = JSON.parse(reader.result);

        // Support both old and new backup formats
        let data;
        if (parsed.version && parsed.data) {
          // New format with version wrapper (v4.0+)
          data = parsed.data;
          console.log(`Importing backup version ${parsed.version} from ${parsed.exportDate}`);
        } else {
          // Old format (direct data)
          data = parsed;
        }

        // Validate data structure
        if (typeof data !== 'object' || data === null) {
          throw new Error('Format de donnÃ©es invalide');
        }

        // Validate that arrays are actually arrays
        const requiredFields = ['patients', 'docs', 'centers', 'protos', 'switches', 'appointments'];
        for (const field of requiredFields) {
          if (data[field] && !Array.isArray(data[field])) {
            throw new Error(`Le champ '${field}' doit Ãªtre un tableau`);
          }
        }

        // Validate that at least one of the expected fields exists
        const hasValidData = requiredFields.some(field => data[field] && Array.isArray(data[field]));
        if (!hasValidData) {
          throw new Error('Aucune donnÃ©e valide trouvÃ©e dans le fichier');
        }

        // Count history events in the backup for verification
        const patientHistoryCount = (data.patients || []).reduce((total, p) => total + (p.history?.length || 0), 0);
        const appointmentHistoryCount = (data.appointments || []).reduce((total, a) => total + (a.history?.length || 0), 0);
        const totalHistoryEvents = patientHistoryCount + appointmentHistoryCount;

        console.log('ðŸ“Š Data to import:', {
          patients: data.patients?.length || 0,
          docs: data.docs?.length || 0,
          centers: data.centers?.length || 0,
          protos: data.protos?.length || 0,
          switches: data.switches?.length || 0,
          appointments: data.appointments?.length || 0,
          patientHistoryEvents: patientHistoryCount,
          appointmentHistoryEvents: appointmentHistoryCount,
          totalHistoryEvents: totalHistoryEvents
        });

        if (confirm('Remplacer toutes les donnÃ©es ?')) {
          state = {
            patients: data.patients || [],
            docs: data.docs || [],
            centers: data.centers || [],
            protos: data.protos || [],
            switches: data.switches || [],
            appointments: data.appointments || []
          };
          saveDB();
          render();

          // Detailed success message
          const message = `âœ… Import rÃ©ussi !\n${state.patients.length} patients (${patientHistoryCount} Ã©vÃ©nements historique)\n${state.appointments.length} rendez-vous (${appointmentHistoryCount} Ã©vÃ©nements)\nTotal: ${totalHistoryEvents} Ã©vÃ©nements restaurÃ©s`;
          showToast(message, 'success');
        }
      } catch (error) {
        console.error('Import error:', error);
        if (error instanceof SyntaxError) {
          showToast('âŒ Fichier JSON invalide. VÃ©rifiez le format du fichier.', 'error');
        } else {
          showToast('âŒ ' + error.message, 'error');
        }
      }
    };
    reader.readAsText(file);
  });
  
  // Fast Check Controls
  byId('fcClose')?.addEventListener('click', fcClose);
  byId('fcPrev')?.addEventListener('click', fcPrev);
  byId('fcSkip')?.addEventListener('click', fcNext);
  byId('fcCorrect')?.addEventListener('click', fcCorrect);
  byId('fcUpdate')?.addEventListener('click', fcUpdate);
  byId('fcCopy')?.addEventListener('click', fcCopy);
  byId('fcEditCode')?.addEventListener('click', fcEditCode);
  byId('fcSaveCode')?.addEventListener('click', fcSaveCode);
  byId('fcOrdonnance')?.addEventListener('click', fcOpenOrdonnance);
  
  // Switch events
  byId('switchPatientId')?.addEventListener('change', updateSwitchOldProto);
  
  document.addEventListener('keydown', (e) => {
    if (byId('fastModal')?.classList.contains('active')) {
      switch(e.key) {
        case 'ArrowRight':
        case 'Enter':
          e.preventDefault();
          fcCorrect();
          break;
        case 'ArrowLeft':
          e.preventDefault();
          fcPrev();
          break;
        case 'Escape':
          e.preventDefault();
          fcClose();
          break;
      }
    }
  });
  
  // Debug
  byId('btnListKeys')?.addEventListener('click', () => {
    const keys = Object.keys(localStorage);
    byId('dbgOut').textContent = `ClÃ©s localStorage (${keys.length}):\n${keys.join('\n')}`;
  });
  
  byId('btnSwitchKey')?.addEventListener('click', () => {
    const current = localStorage.getItem(DB_KEY);
    if (current) {
      localStorage.setItem(DB_KEY + '-backup', current);
      showToast('ClÃ© dupliquÃ©e vers ' + DB_KEY + '-backup', 'success');
    }
  });
  
  byId('btnMigrateV1')?.addEventListener('click', () => {
    const legacy = localStorage.getItem(LEGACY_KEY);
    if (!legacy) {
      showToast('Aucune base v1 trouvÃ©e', 'warning');
      return;
    }
    
    try {
      const data = JSON.parse(legacy);
      state.patients = [...state.patients, ...(data.patients || [])];
      state.docs = [...state.docs, ...(data.docs || [])];
      state.centers = [...state.centers, ...(data.centers || [])];
      state.protos = [...state.protos, ...(data.protos || [])];
      saveDB();
      render();
      showToast('Migration depuis v1 rÃ©ussie', 'success');
    } catch (error) {
      showToast('Erreur de migration', 'error');
    }
  });
  
  byId('btnPurgeV1')?.addEventListener('click', () => {
    if (confirm('Supprimer la base v1 ?')) {
      localStorage.removeItem(LEGACY_KEY);
      showToast('Base v1 supprimÃ©e', 'success');
    }
  });
  
  // Cycle tabs
  document.addEventListener('click', (e) => {
    const cycleTab = e.target.closest('.cycle-tab');
    if (cycleTab) {
      const cycle = parseInt(cycleTab.dataset.cycle);
      const year = parseInt(byId('ordoYearFilter')?.value || getCurrentCycle().year);
      
      // Update active state
      document.querySelectorAll('.cycle-tab').forEach(tab => tab.classList.remove('active'));
      cycleTab.classList.add('active');
      
      // Render patients for this cycle
      renderCyclePatients(cycle, year);
    }
  });
  
  // Year filter
  byId('ordoYearFilter')?.addEventListener('change', () => {
    const activeTab = document.querySelector('.cycle-tab.active');
    const cycle = activeTab ? parseInt(activeTab.dataset.cycle) : 1;
    const year = parseInt(byId('ordoYearFilter').value);
    
    // Update cycle counts
    for (let i = 1; i <= 3; i++) {
      const patients = getPatientsByCycle(i, year);
      const countEl = byId(`cycle${i}Count`);
      if (countEl) countEl.textContent = patients.length;
    }
    
    renderCyclePatients(cycle, year);
  });
  
  // Update system events
  byId('btnSaveGithubConfig')?.addEventListener('click', saveGithubConfig);
  byId('btnCheckUpdate')?.addEventListener('click', checkGithubUpdates);
  byId('btnDownloadUpdate')?.addEventListener('click', downloadGithubUpdate);
  byId('btnInstallUpdate')?.addEventListener('click', installGithubUpdate);
}

// ===== Legacy Functions =====
function scanLegacyBases() {
  const keys = Object.keys(localStorage);
  const legacyKeys = keys.filter(k => k.includes('nhc-care') && k !== DB_KEY);
  
  if (legacyKeys.length === 0) {
    showToast('Aucune base antÃ©rieure trouvÃ©e', 'info');
    return;
  }
  
  const bases = legacyKeys.map(key => {
    try {
      const data = JSON.parse(localStorage.getItem(key));
      return {
        key,
        patients: data.patients?.length || 0,
        docs: data.docs?.length || 0,
        centers: data.centers?.length || 0,
        protos: data.protos?.length || 0
      };
    } catch {
      return null;
    }
  }).filter(Boolean);
  
  if (bases.length === 0) {
    showToast('Aucune base valide trouvÃ©e', 'warning');
    return;
  }
  
  const msg = bases.map(b => 
    `${b.key}: ${b.patients} patients, ${b.docs} mÃ©decins, ${b.centers} centres, ${b.protos} protocoles`
  ).join('\n');
  
  if (confirm(`Bases trouvÃ©es:\n\n${msg}\n\nImporter la premiÃ¨re ?`)) {
    const base = bases[0];
    const data = JSON.parse(localStorage.getItem(base.key));
    
    state.patients = [...state.patients, ...(data.patients || [])];
    state.docs = [...state.docs, ...(data.docs || [])];
    state.centers = [...state.centers, ...(data.centers || [])];
    state.protos = [...state.protos, ...(data.protos || [])];
    
    saveDB();
    render();
    showToast(`Import depuis ${base.key} rÃ©ussi`, 'success');
  }
}

function restoreRefs() {
  const keys = Object.keys(localStorage);
  const legacyKeys = keys.filter(k => k.includes('nhc-care') && k !== DB_KEY);
  
  if (legacyKeys.length === 0) {
    showToast('Aucune base antÃ©rieure trouvÃ©e', 'info');
    return;
  }
  
  const base = legacyKeys[0];
  try {
    const data = JSON.parse(localStorage.getItem(base));
    
    if (confirm('Restaurer les rÃ©fÃ©rentiels depuis ' + base + ' ?')) {
      state.docs = data.docs || state.docs;
      state.centers = data.centers || state.centers;
      state.protos = data.protos || state.protos;
      
      saveDB();
      renderCatalogs();
      showToast('RÃ©fÃ©rentiels restaurÃ©s', 'success');
    }
  } catch (error) {
    showToast('Erreur de restauration', 'error');
  }
}

// ===== PDF Export Function =====
async function exportCurrentCycleToPDF() {
  try {
    // Get active cycle from the active tab
    const activeTab = document.querySelector('.cycle-tab.active');
    if (!activeTab) {
      showToast('Aucun cycle sÃ©lectionnÃ©', 'error');
      return;
    }
    
    const cycleNum = parseInt(activeTab.dataset.cycle);
    const year = parseInt(byId('ordoYearFilter')?.value || getCurrentCycle().year);
    const cycleInfo = getCycleInfo(cycleNum, year);
    
    if (!cycleInfo) {
      showToast('Erreur de rÃ©cupÃ©ration du cycle', 'error');
      return;
    }
    
    // Get patients for this cycle
    const patients = getPatientsByCycle(cycleNum, year);
    
    if (patients.length === 0) {
      showToast('Aucun patient dans ce cycle', 'warning');
      return;
    }
    
    showToast('GÃ©nÃ©ration du PDF en cours...', 'info');

    // Load jsPDF and autoTable if not already loaded
    try {
      if (typeof window.jspdf === 'undefined') {
        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
        // Verify jsPDF loaded successfully
        if (typeof window.jspdf === 'undefined') {
          throw new Error('jsPDF n\'a pas pu Ãªtre chargÃ©');
        }
      }
      if (typeof window.jspdf.jsPDF.API.autoTable === 'undefined') {
        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js');
        // Verify autoTable loaded successfully
        if (typeof window.jspdf.jsPDF.API.autoTable === 'undefined') {
          throw new Error('jsPDF autoTable n\'a pas pu Ãªtre chargÃ©');
        }
      }
    } catch (scriptError) {
      console.error('Error loading PDF libraries:', scriptError);
      showToast('Impossible de charger les bibliothÃ¨ques PDF. VÃ©rifiez votre connexion internet.', 'error');
      return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({
      orientation: 'l',
      unit: 'mm', 
      format: 'a4',
      putOnlyUsedFonts: true,
      compress: true
    });
    
    // Helper function to clean text for PDF
    const cleanText = (text) => {
      if (!text) return '';
      return text
        .replace(/[^\x00-\x7F]/g, function(char) {
          const accents = {
            'Ã ': 'a', 'Ã¡': 'a', 'Ã¢': 'a', 'Ã£': 'a', 'Ã¤': 'a', 'Ã¥': 'a',
            'Ã¨': 'e', 'Ã©': 'e', 'Ãª': 'e', 'Ã«': 'e',
            'Ã¬': 'i', 'Ã­': 'i', 'Ã®': 'i', 'Ã¯': 'i',
            'Ã²': 'o', 'Ã³': 'o', 'Ã´': 'o', 'Ãµ': 'o', 'Ã¶': 'o',
            'Ã¹': 'u', 'Ãº': 'u', 'Ã»': 'u', 'Ã¼': 'u',
            'Ã½': 'y', 'Ã¿': 'y',
            'Ã±': 'n', 'Ã§': 'c',
            'Ã€': 'A', 'Ã': 'A', 'Ã‚': 'A', 'Ãƒ': 'A', 'Ã„': 'A', 'Ã…': 'A',
            'Ãˆ': 'E', 'Ã‰': 'E', 'ÃŠ': 'E', 'Ã‹': 'E',
            'ÃŒ': 'I', 'Ã': 'I', 'ÃŽ': 'I', 'Ã': 'I',
            'Ã’': 'O', 'Ã“': 'O', 'Ã”': 'O', 'Ã•': 'O', 'Ã–': 'O',
            'Ã™': 'U', 'Ãš': 'U', 'Ã›': 'U', 'Ãœ': 'U',
            'Ã': 'Y', 'Å¸': 'Y',
            'Ã‘': 'N', 'Ã‡': 'C',
            'Â°': 'o', 'â‚¬': 'EUR', 'Â£': 'GBP', 'Â¥': 'JPY',
            'â€“': '-', 'â€”': '-', "'": "'", "'": "'", '"': '"', '"': '"',
            'â€¦': '...', 'â€¢': '*', 'â†’': '->', 'â†': '<-',
            'Â©': '(c)', 'Â®': '(R)', 'â„¢': '(TM)'
          };
          return accents[char] || char;
        });
    };
    
    // Group patients by doctor
    const patientsByDoctor = {};
    patients.forEach(p => {
      const docId = p.docId || 'no-doctor';
      const doctorName = docId === 'no-doctor' ? 'Sans medecin attribue' : cleanText(docName(docId));
      
      if (!patientsByDoctor[doctorName]) {
        patientsByDoctor[doctorName] = [];
      }
      
      const status = getOrdonnanceStatus(p.renewalDate);
      
      patientsByDoctor[doctorName].push({
        lastName: cleanText(p.lastName || ''),
        firstName: cleanText(p.firstName || ''),
        dob: p.dob || '',
        renewalDate: p.renewalDate || 'Non defini',
        protocol: cleanText(protoName(p.protoId) || 'Non defini'),
        center: cleanText(centerName(p.centerId) || 'Non defini'),
        status: cleanText(status.label),
        statusType: status.status,
        daysRemaining: status.days !== undefined ? status.days : null
      });
    });
    
    // Compact header - Title
    doc.setFontSize(16);
    doc.setTextColor(59, 130, 246);
    doc.text(`Ordonnances - ${cycleInfo.name} ${year}`, 14, 12);
    
    doc.setFontSize(8);
    doc.setTextColor(100, 116, 139);
    const startDateStr = cycleInfo.startDate.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
    const endDateStr = cycleInfo.endDate.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
    
    const now = new Date();
    const generatedDateStr = `${now.toLocaleDateString('fr-FR')} a ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
    
    doc.text(`Periode: ${startDateStr} - ${endDateStr} | Genere: ${generatedDateStr}`, 14, 17);
    
    // Stats
    doc.setFontSize(9);
    doc.setTextColor(30, 41, 59);
    const doctorCount = Object.keys(patientsByDoctor).length;
    const doctorText = doctorCount > 1 ? 'medecins' : 'medecin';
    const patientText = patients.length > 1 ? 'patients' : 'patient';
    doc.text(`${doctorCount} ${doctorText} - ${patients.length} ${patientText}`, 14, 22);
    
    let yPosition = 26;
    
    // Sort doctors
    const doctorNames = Object.keys(patientsByDoctor).sort((a, b) => {
      if (a === 'Sans medecin attribue') return 1;
      if (b === 'Sans medecin attribue') return -1;
      return a.localeCompare(b);
    });
    
    // For each doctor
    doctorNames.forEach((doctorName, index) => {
      const doctorPatients = patientsByDoctor[doctorName];
      
      // Calculate approximate height needed for this section
      const rowHeight = 6; // Approximate height per row
      const headerHeight = 6;
      const sectionHeight = headerHeight + (doctorPatients.length * rowHeight);
      
      // Check if we need a new page (leave 15mm margin at bottom)
      if (yPosition + sectionHeight > 195) {
        doc.addPage();
        yPosition = 12;
      }
      
      // Compact doctor header
      doc.setFillColor(59, 130, 246);
      if (doctorName === 'Sans medecin attribue') {
        doc.setFillColor(239, 68, 68);
      }
      doc.rect(10, yPosition, 277, 6, 'F');
      
      doc.setFontSize(10);
      doc.setTextColor(255, 255, 255);
      doc.text(`Dr. ${doctorName}`, 12, yPosition + 4);
      
      // Count urgent cases
      const urgentCount = doctorPatients.filter(p => 
        p.statusType === 'expiree' || p.statusType === 'urgent'
      ).length;
      
      const patientCountText = doctorPatients.length > 1 ? 'patients' : 'patient';
      let countText = `${doctorPatients.length} ${patientCountText}`;
      if (urgentCount > 0) {
        const urgentText = urgentCount > 1 ? 'urgents' : 'urgent';
        countText += ` - ${urgentCount} ${urgentText}`;
      }
      doc.text(countText, 282, yPosition + 4, { align: 'right' });
      
      yPosition += 7;
      
      // Table data - abbreviated names for more compact display
      const tableData = doctorPatients.map(p => [
        `${p.lastName} ${p.firstName}`,
        p.dob,
        p.renewalDate,
        p.status,
        p.protocol,
        p.center
      ]);
      
      // Create compact table
      doc.autoTable({
        startY: yPosition,
        head: [['Patient', 'Naiss.', 'Renouvellement', 'Statut', 'Protocole', 'Centre']],
        body: tableData,
        margin: { left: 10, right: 10 },
        styles: {
          fontSize: 7.5,
          cellPadding: 1.5,
          overflow: 'linebreak',
          cellWidth: 'wrap',
          lineColor: [226, 232, 240],
          lineWidth: 0.1
        },
        headStyles: {
          fillColor: [241, 245, 249],
          textColor: [30, 41, 59],
          fontStyle: 'bold',
          halign: 'left',
          cellPadding: 2
        },
        columnStyles: {
          0: { cellWidth: 42, fontStyle: 'bold' },
          1: { cellWidth: 22 },
          2: { cellWidth: 28 },
          3: { cellWidth: 26 },
          4: { cellWidth: 48 },
          5: { cellWidth: 48 }
        },
        alternateRowStyles: {
          fillColor: [248, 250, 252]
        },
        didParseCell: function(data) {
          if (data.column.index === 3 && data.section === 'body') {
            const patient = doctorPatients[data.row.index];
            if (patient.statusType === 'expiree') {
              data.cell.styles.textColor = [239, 68, 68];
              data.cell.styles.fontStyle = 'bold';
            } else if (patient.statusType === 'urgent') {
              data.cell.styles.textColor = [245, 158, 11];
              data.cell.styles.fontStyle = 'bold';
            }
          }
        }
      });
      
      yPosition = doc.lastAutoTable.finalY + 2;
    });
    
    // Footer
    const pageCount = doc.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
      doc.setPage(i);
      doc.setFontSize(7);
      doc.setTextColor(148, 163, 184);
      doc.text(`NHC Patients Manager - Page ${i}/${pageCount}`, 10, 203);
      doc.text(`Document confidentiel`, 210, 203, { align: 'center' });
    }
    
    // Save
    doc.save(`Ordonnances_${cycleInfo.name}_${year}.pdf`);
    
    showToast('PDF genere avec succes !', 'success');
  } catch (error) {
    console.error('Error generating PDF:', error);
    showToast('Erreur lors de la generation du PDF: ' + error.message, 'error');
  }
}

// Helper function to load external scripts dynamically
function loadScript(src) {
  return new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = src;
    script.onload = resolve;
    script.onerror = reject;
    document.head.appendChild(script);
  });
}

// ===== NOUVEAU SYSTÃˆME DE MISE Ã€ JOUR - IndexedDB + SHA-256 =====
const APP_VERSION = '1.2.0';
const GITHUB_CONFIG_KEY = 'nhc-github-config';
const DB_NAME = 'NHC_UpdateManager';
const DB_VERSION = 1;
const STORE_NAME = 'updates';
const MAX_STORED_VERSIONS = 3;

let pendingUpdate = null;
let githubConfig = {
  rawUrl: '',
  autoCheck: false
};

// ===== Utilitaires IndexedDB =====

function openUpdateDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    request.onerror = () => reject(request.error);
    request.onsuccess = () => resolve(request.result);
    request.onupgradeneeded = (event) => {
      const db = event.target.result;
      if (!db.objectStoreNames.contains(STORE_NAME)) {
        const objectStore = db.createObjectStore(STORE_NAME, { keyPath: 'version' });
        objectStore.createIndex('installedAt', 'installedAt', { unique: false });
        objectStore.createIndex('active', 'active', { unique: false });
      }
    };
  });
}

async function saveUpdateToDB(updateData) {
  const db = await openUpdateDB();
  try {
    const transaction1 = db.transaction([STORE_NAME], 'readwrite');
    const objectStore1 = transaction1.objectStore(STORE_NAME);
    const allUpdates = await new Promise((resolve, reject) => {
      const request = objectStore1.getAll();
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });

    for (const update of allUpdates) {
      update.active = false;
      objectStore1.put(update);
    }

    await new Promise((resolve, reject) => {
      transaction1.oncomplete = () => resolve();
      transaction1.onerror = () => reject(transaction1.error);
    });

    const transaction2 = db.transaction([STORE_NAME], 'readwrite');
    const objectStore2 = transaction2.objectStore(STORE_NAME);
    updateData.active = true;
    updateData.installedAt = new Date().toISOString();
    objectStore2.put(updateData);

    await new Promise((resolve, reject) => {
      transaction2.oncomplete = () => resolve();
      transaction2.onerror = () => reject(transaction2.error);
    });

    await cleanOldVersions(db);
  } finally {
    db.close();
  }
}

async function cleanOldVersions(db) {
  const transaction = db.transaction([STORE_NAME], 'readwrite');
  const objectStore = transaction.objectStore(STORE_NAME);
  const index = objectStore.index('installedAt');

  const allUpdates = await new Promise((resolve, reject) => {
    const request = index.getAll();
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });

  allUpdates.sort((a, b) => new Date(b.installedAt) - new Date(a.installedAt));

  for (let i = MAX_STORED_VERSIONS; i < allUpdates.length; i++) {
    objectStore.delete(allUpdates[i].version);
    console.log(`ðŸ—‘ï¸ Version ${allUpdates[i].version} supprimÃ©e`);
  }
}

async function getAllUpdates() {
  const db = await openUpdateDB();
  try {
    const transaction = db.transaction([STORE_NAME], 'readonly');
    const objectStore = transaction.objectStore(STORE_NAME);
    return await new Promise((resolve, reject) => {
      const request = objectStore.getAll();
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
  } finally {
    db.close();
  }
}

async function deactivateAllUpdates() {
  const db = await openUpdateDB();
  try {
    const transaction = db.transaction([STORE_NAME], 'readwrite');
    const objectStore = transaction.objectStore(STORE_NAME);
    const allUpdates = await new Promise((resolve, reject) => {
      const request = objectStore.getAll();
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });

    for (const update of allUpdates) {
      update.active = false;
      objectStore.put(update);
    }

    await new Promise((resolve, reject) => {
      transaction.oncomplete = () => resolve();
      transaction.onerror = () => reject(transaction.error);
    });
  } finally {
    db.close();
  }
}

async function calculateSHA256(text) {
  const buffer = new TextEncoder().encode(text);
  const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

// ===== Configuration =====

function loadGithubConfig() {
  try {
    const stored = localStorage.getItem(GITHUB_CONFIG_KEY);
    if (stored) {
      githubConfig = JSON.parse(stored);
      const urlInput = byId('githubRawUrl');
      const autoCheckbox = byId('autoCheckUpdates');
      if (urlInput) urlInput.value = githubConfig.rawUrl || '';
      if (autoCheckbox) autoCheckbox.checked = githubConfig.autoCheck || false;
    }
  } catch (e) {
    console.error('âŒ Erreur chargement config:', e);
  }
}

function saveGithubConfig() {
  const urlInput = byId('githubRawUrl');
  const autoCheckbox = byId('autoCheckUpdates');
  if (!urlInput) return;

  const url = urlInput.value.trim();
  if (url && !url.match(/^https?:\/\/raw\.githubusercontent\.com\/.+\.json$/)) {
    showToast('âŒ URL invalide. Format: https://raw.githubusercontent.com/user/repo/main/version.json', 'error');
    return;
  }

  githubConfig = {
    rawUrl: url,
    autoCheck: autoCheckbox ? autoCheckbox.checked : false
  };

  localStorage.setItem(GITHUB_CONFIG_KEY, JSON.stringify(githubConfig));
  showToast('âœ… Configuration enregistrÃ©e !', 'success');
}

function compareVersions(v1, v2) {
  const parts1 = v1.replace(/^v/, '').split('.').map(Number);
  const parts2 = v2.replace(/^v/, '').split('.').map(Number);
  for (let i = 0; i < 3; i++) {
    if ((parts1[i] || 0) > (parts2[i] || 0)) return 1;
    if ((parts1[i] || 0) < (parts2[i] || 0)) return -1;
  }
  return 0;
}

function extractVersionFromHTML(htmlContent) {
  const titleMatch = htmlContent.match(/<title>.*?v?(\d+\.\d+\.\d+).*?<\/title>/i);
  if (titleMatch) return titleMatch[1];
  const versionMatch = htmlContent.match(/const\s+APP_VERSION\s*=\s*['"](\d+\.\d+\.\d+)['"]/);
  if (versionMatch) return versionMatch[1];
  return null;
}

// ===== VÃ©rification des mises Ã  jour =====

async function checkGithubUpdates() {
  if (!githubConfig.rawUrl) {
    showToast('âš ï¸ Configurez d\'abord l\'URL du fichier version.json', 'warning');
    return;
  }

  try {
    showToast('ðŸ” VÃ©rification des mises Ã  jour...', 'info');

    if (!githubConfig.rawUrl.endsWith('.json')) {
      showToast('âŒ Seuls les fichiers version.json sont supportÃ©s', 'error');
      return;
    }

    await checkUpdatesViaJson();
  } catch (error) {
    console.error('âŒ Erreur vÃ©rification:', error);
    showToast('âŒ Erreur: ' + error.message, 'error');
  }
}

async function checkUpdatesViaJson() {
  const response = await fetch(githubConfig.rawUrl + '?t=' + Date.now());

  if (!response.ok) {
    showToast('âŒ Erreur lors de la rÃ©cupÃ©ration: ' + response.statusText, 'error');
    return;
  }

  const versionData = await response.json();

  if (!versionData.version || !versionData.downloadUrl) {
    showToast('âŒ Fichier version.json invalide', 'error');
    return;
  }

  const remoteVersion = versionData.version;
  const lastCheckEl = byId('lastUpdateCheck');
  if (lastCheckEl) lastCheckEl.textContent = new Date().toLocaleString('fr-FR');

  console.log(`ðŸ“Š Comparaison: Remote=${remoteVersion} vs Local=${APP_VERSION}`);

  const comparison = compareVersions(remoteVersion, APP_VERSION);

  if (comparison > 0) {
    showToast('ðŸ“¥ TÃ©lÃ©chargement de la mise Ã  jour...', 'info');

    const htmlResponse = await fetch(versionData.downloadUrl + '?t=' + Date.now());
    if (!htmlResponse.ok) {
      showToast('âŒ Erreur tÃ©lÃ©chargement HTML', 'error');
      return;
    }

    const htmlContent = await htmlResponse.text();

    if (!htmlContent.includes('<!DOCTYPE html') && !htmlContent.includes('<html')) {
      showToast('âŒ Fichier HTML invalide', 'error');
      return;
    }

    // Calculer le checksum
    const calculatedChecksum = await calculateSHA256(htmlContent);
    console.log(`ðŸ” Checksum calculÃ©: ${calculatedChecksum.substring(0, 16)}...`);

    // VÃ©rifier le checksum si disponible
    if (versionData.checksum && versionData.checksum !== '') {
      if (calculatedChecksum !== versionData.checksum) {
        showToast('âŒ ERREUR: Checksum invalide ! Fichier corrompu ou modifiÃ©.', 'error');
        console.error(`Attendu: ${versionData.checksum}`);
        console.error(`ReÃ§u:    ${calculatedChecksum}`);
        return;
      }
      console.log('âœ… Checksum vÃ©rifiÃ© avec succÃ¨s');
    } else {
      console.warn('âš ï¸ Aucun checksum fourni, vÃ©rification ignorÃ©e');
    }

    const availableVersionEl = byId('availableVersion');
    const updateAvailableNoticeEl = byId('updateAvailableNotice');
    const btnDownloadUpdateEl = byId('btnDownloadUpdate');

    if (availableVersionEl) availableVersionEl.textContent = 'v' + remoteVersion;
    if (updateAvailableNoticeEl) updateAvailableNoticeEl.style.display = 'block';
    if (btnDownloadUpdateEl) btnDownloadUpdateEl.style.display = 'inline-flex';

    let releaseNotes = '';
    if (versionData.releaseNotes && versionData.releaseNotes.fr) {
      releaseNotes = '\n\nðŸ“ NouveautÃ©s :\n' + versionData.releaseNotes.fr.join('\n');
    }

    pendingUpdate = {
      version: remoteVersion,
      downloadUrl: versionData.downloadUrl,
      fileName: versionData.fileName,
      htmlContent: htmlContent,
      fileSize: new Blob([htmlContent]).size,
      releaseDate: versionData.releaseDate,
      releaseNotes: versionData.releaseNotes,
      checksum: calculatedChecksum,
      previousVersion: APP_VERSION
    };

    const updateInfoEl = byId('updateInfo');
    const updateDetailsEl = byId('updateDetails');

    if (updateInfoEl) updateInfoEl.style.display = 'block';
    if (updateDetailsEl) {
      updateDetailsEl.textContent = `Version distante: ${remoteVersion}\nVersion actuelle: ${APP_VERSION}\nFichier: ${versionData.fileName}\nTaille: ${(pendingUpdate.fileSize / 1024).toFixed(2)} KB\nDate: ${versionData.releaseDate || 'N/A'}\nChecksum: ${calculatedChecksum.substring(0, 16)}...${releaseNotes}\n\nâœ¨ Nouvelle version disponible !`;
    }

    showToast(`âœ¨ Mise Ã  jour v${remoteVersion} disponible !`, 'success');

  } else if (comparison === 0) {
    showToast('âœ… Vous avez la derniÃ¨re version', 'success');
    const updateNoticeEl = byId('updateAvailableNotice');
    const downloadBtnEl = byId('btnDownloadUpdate');
    if (updateNoticeEl) updateNoticeEl.style.display = 'none';
    if (downloadBtnEl) downloadBtnEl.style.display = 'none';

  } else {
    showToast('â„¹ï¸ Votre version est plus rÃ©cente', 'info');
    const noticeEl = byId('updateAvailableNotice');
    const dlBtnEl = byId('btnDownloadUpdate');
    if (noticeEl) noticeEl.style.display = 'none';
    if (dlBtnEl) dlBtnEl.style.display = 'none';
  }
}

async function downloadGithubUpdate() {
  if (!pendingUpdate || !pendingUpdate.htmlContent) {
    showToast('âŒ Aucune mise Ã  jour disponible', 'error');
    return;
  }

  showToast('âœ… Mise Ã  jour prÃªte Ã  Ãªtre installÃ©e !', 'success');

  const installBtnEl = byId('btnInstallUpdate');
  const downloadBtnEl = byId('btnDownloadUpdate');
  if (installBtnEl) installBtnEl.style.display = 'inline-flex';
  if (downloadBtnEl) downloadBtnEl.style.display = 'none';
}

async function installGithubUpdate() {
  if (!pendingUpdate || !pendingUpdate.htmlContent) {
    showToast('âŒ Aucune mise Ã  jour tÃ©lÃ©chargÃ©e', 'error');
    return;
  }

  if (!confirm(`Installer la mise Ã  jour v${pendingUpdate.version} ?\n\nâœ… Vos donnÃ©es seront prÃ©servÃ©es\nâœ… IntÃ©gritÃ© vÃ©rifiÃ©e par SHA-256\nâœ… ${MAX_STORED_VERSIONS} versions de backup automatiques\nâš ï¸ L'application sera rechargÃ©e`)) {
    return;
  }

  try {
    console.log(`ðŸ“¦ Installation de v${pendingUpdate.version}...`);

    await saveUpdateToDB(pendingUpdate);

    console.log('âœ… Mise Ã  jour sauvegardÃ©e dans IndexedDB');

    showToast('âœ… Mise Ã  jour installÃ©e ! Rechargement...', 'success');

    setTimeout(() => {
      window.location.reload();
    }, 1500);

  } catch (error) {
    console.error('âŒ Erreur installation:', error);
    showToast('âŒ Erreur: ' + error.message, 'error');
  }
}

// ===== Historique et Rollback =====

async function checkForUpdates() {
  try {
    const allUpdates = await getAllUpdates();
    const activeUpdate = allUpdates.find(u => u.active);

    if (activeUpdate && activeUpdate.version !== APP_VERSION) {
      const updateInfoEl = byId('updateInfo');
      if (updateInfoEl) {
        updateInfoEl.style.display = 'block';
        updateInfoEl.innerHTML = `
          <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius); border-left: 4px solid var(--success);">
            <h4 style="margin: 0 0 0.5rem 0; color: var(--success);">âœ… Mise Ã  jour active</h4>
            <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">Version ${activeUpdate.version} actuellement chargÃ©e</p>
          </div>
        `;
      }

      const rollbackBtn = byId('btnRollback');
      if (rollbackBtn) rollbackBtn.style.display = 'inline-flex';

      return true;
    }
  } catch (error) {
    console.error('âŒ Erreur vÃ©rification updates:', error);
  }
  return false;
}

async function renderUpdateHistory() {
  try {
    const allUpdates = await getAllUpdates();
    const container = byId('updateHistory');

    if (!container) return;

    if (allUpdates.length === 0) {
      container.innerHTML = '<p class="text-muted">Aucune mise Ã  jour installÃ©e</p>';
      return;
    }

    allUpdates.sort((a, b) => new Date(b.installedAt) - new Date(a.installedAt));

    container.innerHTML = allUpdates.map((update, index) => `
      <div style="padding: 0.75rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
        <div>
          <div style="font-weight: 600;">v${update.version}</div>
          <div class="text-small text-muted">${new Date(update.installedAt).toLocaleString('fr-FR')}</div>
          <div class="text-small text-muted">Checksum: ${update.checksum ? update.checksum.substring(0, 16) + '...' : 'N/A'}</div>
        </div>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
          ${update.active ? `
            <span class="badge badge-success">Active</span>
            <button class="btn btn-secondary btn-sm" onclick="rollbackUpdate()" title="Revenir au fichier original">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path>
              </svg>
              Rollback
            </button>
          ` : `
            <button class="btn btn-secondary btn-sm" onclick="activateVersion('${update.version}')" title="Activer cette version">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
              </svg>
              Activer
            </button>
          `}
        </div>
      </div>
    `).join('');

  } catch (error) {
    console.error('âŒ Erreur affichage historique:', error);
  }
}

async function activateVersion(version) {
  if (!confirm(`Activer la version ${version} ?\n\nL'application sera rechargÃ©e.`)) {
    return;
  }

  try {
    const db = await openUpdateDB();
    const transaction = db.transaction([STORE_NAME], 'readwrite');
    const objectStore = transaction.objectStore(STORE_NAME);

    const allUpdates = await new Promise((resolve, reject) => {
      const request = objectStore.getAll();
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });

    for (const update of allUpdates) {
      update.active = (update.version === version);
      objectStore.put(update);
    }

    await new Promise((resolve, reject) => {
      transaction.oncomplete = () => resolve();
      transaction.onerror = () => reject(transaction.error);
    });

    db.close();

    showToast(`âœ… Version ${version} activÃ©e ! Rechargement...`, 'success');

    setTimeout(() => {
      window.location.reload();
    }, 1000);

  } catch (error) {
    console.error('âŒ Erreur activation version:', error);
    showToast('âŒ Erreur: ' + error.message, 'error');
  }
}

async function rollbackUpdate() {
  if (!confirm('Revenir au fichier original ?\n\nToutes les mises Ã  jour seront dÃ©sactivÃ©es.\nL\'application utilisera le fichier HTML d\'origine.')) {
    return;
  }

  try {
    await deactivateAllUpdates();

    // Nettoyer aussi localStorage pour compatibilitÃ©
    localStorage.removeItem('nhc-care-update');
    localStorage.removeItem('nhc-apply-update-on-load');

    showToast('âœ… Retour au fichier original...', 'success');

    setTimeout(() => {
      window.location.reload();
    }, 1000);

  } catch (error) {
    console.error('âŒ Erreur rollback:', error);
    showToast('âŒ Erreur: ' + error.message, 'error');
  }
}

// CompatibilitÃ© avec anciennes fonctions
function loadUpdateFile() {
  showToast('âš ï¸ Chargement manuel dÃ©sactivÃ©. Utilisez GitHub pour les mises Ã  jour.', 'warning');
}

function handleUpdateFileSelect(event) {
  // DÃ©sactivÃ©
}

function installUpdate() {
  return installGithubUpdate();
}

function applyUpdate() {
  // Compatibility stub - kept for backward compatibility
  console.log('applyUpdate() called - using new IndexedDB system');
}

// ===== Initialization =====
function init() {
  // Load theme
  const savedTheme = localStorage.getItem('nhc-theme') || 'light';
  document.documentElement.setAttribute('data-theme', savedTheme);
  
  if (savedTheme === 'dark') {
    byId('themeIcon').textContent = 'â˜€ï¸';
    byId('themeText').textContent = 'Mode clair';
  }
  
  // Load database
  loadDB();
  
  // Check auto-save support
  checkFileSystemSupport();
  
  // Bind events
  bindEvents();
  
  // Setup tutorial modal
  setupTutorialModal();
  
  // Initial render
  render();
  
  // Initialize update system
  loadGithubConfig();
  checkForUpdates();
  renderUpdateHistory();
  byId('currentVersion').textContent = 'v' + APP_VERSION;

  // Check for GitHub updates automatically if enabled
  if (githubConfig.autoCheck && githubConfig.rawUrl) {
    setTimeout(() => {
      checkGithubUpdates();
    }, 2000); // Delay 2 seconds to not slow down initial load
  }
  
  // Show welcome message if first time
  if (state.patients.length === 0 && !localStorage.getItem('nhc-welcome-shown')) {
    showToast('Bienvenue dans NHC Patients Manager ! ðŸŽ‰', 'success');
    localStorage.setItem('nhc-welcome-shown', 'true');
  }
  
  // Show tutorial on first launch (unless disabled)
  if (!localStorage.getItem('nhc-tutorial-seen') && !localStorage.getItem('nhc-tutorial-disabled')) {
    setTimeout(() => {
      startTutorial();
      localStorage.setItem('nhc-tutorial-seen', 'true');
    }, 1000); // Delay for smooth UX
  }
}

// ===== Start Application =====
document.addEventListener('DOMContentLoaded', init);


// ===== Expose functions to global scope for onclick handlers =====
window.toggleTheme = toggleTheme;
window.configureAutoSave = configureAutoSave;
window.toggleAutoSave = toggleAutoSave;
window.saveNow = saveNow;
window.restoreFromAutoSave = restoreFromAutoSave;
window.refreshOrdonnances = refreshOrdonnances;
window.startBatchRenewal = startBatchRenewal;
window.openCSVImport = openCSVImport;
window.suggestRenewalDate = suggestRenewalDate;
window.showModal = showModal;
window.loadCSVFile = loadCSVFile;
window.goToMapping = goToMapping;
window.executeCSVImport = executeCSVImport;
window.renewOrdonnance = renewOrdonnance;
window.openPatient = openPatient;
window.viewPatientDetails = viewPatientDetails;
window.byId = byId;
window.newPatient = newPatient;
window.savePatient = savePatient;
window.deletePatient = deletePatient;
window.populateSelects = populateSelects;
window.render = render;
window.updateCycleInfo = updateCycleInfo;
window.addDoc = addDoc;
window.addCenter = addCenter;
window.addProto = addProto;
window.fcOpen = fcOpen;
window.fcCopy = fcCopy;
window.fcEditCode = fcEditCode;
window.fcSaveCode = fcSaveCode;
window.fcOpenOrdonnance = fcOpenOrdonnance;
window.exportToExcel = exportToExcel;
window.openSwitchModal = openSwitchModal;
window.updateSwitchOldProto = updateSwitchOldProto;
window.saveSwitch = saveSwitch;
window.validateSwitch = validateSwitch;
window.selectPrescriptionOption = selectPrescriptionOption;
window.confirmValidateSwitch = confirmValidateSwitch;
window.deleteSwitch = deleteSwitch;
window.renderSwitches = renderSwitches;
window.toggleSwitchView = toggleSwitchView;
window.renderTimeline = renderTimeline;
window.openAppointmentModal = openAppointmentModal;
window.toggleAppointmentType = toggleAppointmentType;
window.saveAppointment = saveAppointment;
window.deleteAppointment = deleteAppointment;
window.completeAppointment = completeAppointment;
window.toggleNextAppointmentType = toggleNextAppointmentType;
window.confirmCompleteAppointment = confirmCompleteAppointment;
window.renderAppointments = renderAppointments;
window.updateAppointmentStats = updateAppointmentStats;
window.exportCurrentCycleToPDF = exportCurrentCycleToPDF;
window.loadUpdateFile = loadUpdateFile;
window.installUpdate = installUpdate;
window.rollbackUpdate = rollbackUpdate;
window.checkForUpdates = checkForUpdates;
window.renderStats = renderStats;
window.compareStatistics = compareStatistics;

// Expose new CSV functions
window.csvOnMappingChange = csvOnMappingChange;
window.csvAutoDetectMapping = csvAutoDetectMapping;
window.csvClearMapping = csvClearMapping;
window.csvRedetect = csvRedetect;
window.csvExecuteImport = csvExecuteImport;
window.csvReset = csvReset;

// Expose state for debugging
window.state = state;

// ===== Tutorial System =====
let currentTutorialStep = 1;
const totalTutorialSteps = 11;

function startTutorial() {
  currentTutorialStep = 1;
  // Block body scroll
  document.body.style.overflow = 'hidden';
  showModal(true, 'tutorialModal');
  updateTutorialUI();
}

function closeTutorial() {
  // Save preference if user checked "don't show again"
  const dontShowAgain = document.getElementById('tutorialDontShowAgain');
  if (dontShowAgain && dontShowAgain.checked) {
    localStorage.setItem('nhc-tutorial-disabled', 'true');
  }
  
  // Restore body scroll
  document.body.style.overflow = '';
  showModal(false, 'tutorialModal');
}

function nextTutorialStep() {
  if (currentTutorialStep < totalTutorialSteps) {
    currentTutorialStep++;
    updateTutorialUI();
  } else {
    closeTutorial();
  }
}

function previousTutorialStep() {
  if (currentTutorialStep > 1) {
    currentTutorialStep--;
    updateTutorialUI();
  }
}

function updateTutorialUI() {
  // Update step indicator
  byId('currentStepNum').textContent = currentTutorialStep;
  byId('totalSteps').textContent = totalTutorialSteps;
  
  // Update progress dots
  const progressContainer = byId('tutorialProgress');
  progressContainer.innerHTML = '';
  for (let i = 1; i <= totalTutorialSteps; i++) {
    const dot = document.createElement('div');
    dot.className = 'tutorial-progress-dot';
    if (i < currentTutorialStep) {
      dot.classList.add('completed');
    } else if (i === currentTutorialStep) {
      dot.classList.add('active');
    }
    progressContainer.appendChild(dot);
  }
  
  // Show/hide steps
  document.querySelectorAll('.tutorial-step').forEach(step => {
    step.classList.remove('active');
  });
  const currentStep = document.querySelector(`.tutorial-step[data-step="${currentTutorialStep}"]`);
  if (currentStep) {
    currentStep.classList.add('active');
  }
  
  // Update navigation buttons
  const prevBtn = byId('tutorialPrevBtn');
  const nextBtn = byId('tutorialNextBtn');
  
  if (prevBtn) {
    prevBtn.disabled = currentTutorialStep === 1;
    prevBtn.style.opacity = currentTutorialStep === 1 ? '0.5' : '1';
  }
  
  if (nextBtn) {
    if (currentTutorialStep === totalTutorialSteps) {
      nextBtn.textContent = 'ðŸŽ‰ Terminer';
    } else {
      nextBtn.textContent = 'Suivant â†’';
    }
  }
  
  // Scroll to top of modal content
  const tutorialContent = byId('tutorialContent');
  if (tutorialContent) {
    tutorialContent.scrollTop = 0;
  }
}

// Setup tutorial modal click handler
function setupTutorialModal() {
  const tutorialModal = byId('tutorialModal');
  const tutorialContent = byId('tutorialContent');
  
  if (tutorialModal) {
    tutorialModal.addEventListener('click', (e) => {
      // Close if clicking on the overlay (not the content)
      if (e.target === tutorialModal) {
        closeTutorial();
      }
    });
  }
  
  // Prevent scroll propagation
  if (tutorialContent) {
    tutorialContent.addEventListener('wheel', (e) => {
      e.stopPropagation();
    }, { passive: true });
  }
}

// Expose tutorial functions
window.startTutorial = startTutorial;
window.closeTutorial = closeTutorial;
window.nextTutorialStep = nextTutorialStep;
window.previousTutorialStep = previousTutorialStep;


// Expose variables needed by CSV import
window.csvImportState = csvImportState;
window.CSV_FIELD_MAPPING = CSV_FIELD_MAPPING;

// ===== UI/UX ENHANCEMENTS =====

// Command Palette
let commandPaletteActive = false;
let commandPaletteSelectedIndex = 0;
let commandPaletteItems = [];

function initCommandPalette() {
  const commandPalette = document.getElementById('commandPalette');
  const commandPaletteInput = document.getElementById('commandPaletteInput');
  const commandPaletteResults = document.getElementById('commandPaletteResults');

  // Define all available commands
  const commands = [
    { id: 'new-patient', title: 'Nouveau patient', description: 'Ajouter un nouveau patient', icon: 'ðŸ‘¤', action: () => newPatient(), category: 'Actions' },
    { id: 'new-switch', title: 'Planifier un switch', description: 'Planifier un changement de pompe', icon: 'ðŸ”„', action: () => openSwitchModal(), category: 'Actions' },
    { id: 'new-appointment', title: 'Nouveau rendez-vous', description: 'CrÃ©er un nouveau RDV', icon: 'ðŸ“…', action: () => openAppointmentModal(), category: 'Actions' },
    { id: 'fast-check', title: 'Fast Check Ordonnances', description: 'VÃ©rification rapide des ordonnances', icon: 'ðŸ”', action: () => fcOpen(), category: 'Actions' },
    { id: 'export-excel', title: 'Exporter Excel', description: 'Exporter les donnÃ©es en Excel', icon: 'ðŸ“Š', action: () => exportToExcel(), category: 'Export' },
    { id: 'import-csv', title: 'Importer CSV', description: 'Importer des patients depuis CSV', icon: 'ðŸ“¥', action: () => document.getElementById('btnImportCSV').click(), category: 'Import' },
    { id: 'view-dashboard', title: 'Tableau de bord', description: 'Retour au tableau de bord', icon: 'ðŸ ', action: () => switchView('dashboard'), category: 'Navigation' },
    { id: 'view-patients', title: 'Liste des patients', description: 'Voir tous les patients actifs', icon: 'ðŸ‘¥', action: () => switchView('patients'), category: 'Navigation' },
    { id: 'view-archived', title: 'Patients archivÃ©s', description: 'Voir les patients archivÃ©s', icon: 'ðŸ“¦', action: () => switchView('archived'), category: 'Navigation' },
    { id: 'view-ordos', title: 'Ordonnances', description: 'GÃ©rer les ordonnances', icon: 'ðŸ“‹', action: () => switchView('ordos'), category: 'Navigation' },
    { id: 'view-switches', title: 'Switch Pompes', description: 'GÃ©rer les switchs de pompes', icon: 'ðŸ”„', action: () => switchView('switches'), category: 'Navigation' },
    { id: 'view-appointments', title: 'Suivis / RDV', description: 'GÃ©rer les rendez-vous', icon: 'ðŸ“…', action: () => switchView('appointments'), category: 'Navigation' },
    { id: 'view-catalogs', title: 'RÃ©fÃ©rentiels', description: 'GÃ©rer les rÃ©fÃ©rentiels', icon: 'ðŸ“š', action: () => switchView('catalogs'), category: 'Navigation' },
    { id: 'view-report', title: 'Statistiques', description: 'Voir les statistiques', icon: 'ðŸ“ˆ', action: () => switchView('report'), category: 'Navigation' },
    { id: 'toggle-theme', title: 'Changer de thÃ¨me', description: 'Mode clair / sombre', icon: 'ðŸŒ™', action: () => toggleTheme(), category: 'ParamÃ¨tres' },
    { id: 'tutorial', title: 'Tutoriel', description: 'Afficher le tutoriel', icon: 'ðŸŽ“', action: () => startTutorial(), category: 'Aide' }
  ];

  // Keyboard shortcut: Ctrl+K or Cmd+K
  document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
      e.preventDefault();
      toggleCommandPalette();
    }

    if (e.key === 'Escape' && commandPaletteActive) {
      toggleCommandPalette();
    }

    if (commandPaletteActive) {
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        commandPaletteSelectedIndex = Math.min(commandPaletteSelectedIndex + 1, commandPaletteItems.length - 1);
        renderCommandPaletteResults(commandPaletteItems);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        commandPaletteSelectedIndex = Math.max(commandPaletteSelectedIndex - 1, 0);
        renderCommandPaletteResults(commandPaletteItems);
      } else if (e.key === 'Enter') {
        e.preventDefault();
        if (commandPaletteItems[commandPaletteSelectedIndex]) {
          commandPaletteItems[commandPaletteSelectedIndex].action();
          toggleCommandPalette();
        }
      }
    }
  });

  // Click outside to close
  commandPalette.addEventListener('click', (e) => {
    if (e.target === commandPalette) {
      toggleCommandPalette();
    }
  });

  // Search input
  commandPaletteInput.addEventListener('input', (e) => {
    const query = e.target.value.toLowerCase();
    commandPaletteSelectedIndex = 0;

    if (!query) {
      commandPaletteItems = commands;
    } else {
      // Search in commands and patients
      const filteredCommands = commands.filter(cmd =>
        cmd.title.toLowerCase().includes(query) ||
        cmd.description.toLowerCase().includes(query) ||
        cmd.category.toLowerCase().includes(query)
      );

      const filteredPatients = state.patients.filter(p =>
        p.name.toLowerCase().includes(query)
      ).map(p => ({
        id: `patient-${p.id}`,
        title: p.name,
        description: `${p.protocol || ''} - ${p.doctor || ''}`,
        icon: 'ðŸ‘¤',
        action: () => {
          switchView('patients');
          // Highlight patient in list
          setTimeout(() => {
            const patientRow = document.querySelector(`[data-patient-id="${p.id}"]`);
            if (patientRow) {
              patientRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
              patientRow.classList.add('animate-wiggle');
            }
          }, 300);
        },
        category: 'Patients'
      }));

      commandPaletteItems = [...filteredCommands, ...filteredPatients];
    }

    renderCommandPaletteResults(commandPaletteItems);
  });

  function renderCommandPaletteResults(items) {
    if (items.length === 0) {
      commandPaletteResults.innerHTML = `
        <div class="command-palette-empty">
          <svg width="64" height="64" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto 1rem;">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M12 12h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <p>Aucun rÃ©sultat trouvÃ©</p>
        </div>
      `;
      return;
    }

    let lastCategory = '';
    let html = '';

    items.forEach((item, index) => {
      if (item.category !== lastCategory) {
        html += `<div style="padding: 0.5rem 1rem; font-size: 0.75rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-top: ${lastCategory ? '0.5rem' : '0'};">${item.category}</div>`;
        lastCategory = item.category;
      }

      const isSelected = index === commandPaletteSelectedIndex;
      html += `
        <div class="command-palette-item ${isSelected ? 'selected' : ''}" data-index="${index}">
          <div class="command-palette-item-icon">${item.icon}</div>
          <div class="command-palette-item-content">
            <div class="command-palette-item-title">${item.title}</div>
            <div class="command-palette-item-description">${item.description}</div>
          </div>
        </div>
      `;
    });

    commandPaletteResults.innerHTML = html;

    // Add click handlers
    commandPaletteResults.querySelectorAll('.command-palette-item').forEach((el, index) => {
      el.addEventListener('click', () => {
        items[index].action();
        toggleCommandPalette();
      });
    });

    // Scroll selected item into view
    const selectedItem = commandPaletteResults.querySelector('.command-palette-item.selected');
    if (selectedItem) {
      selectedItem.scrollIntoView({ block: 'nearest' });
    }
  }

  // Initial render
  commandPaletteItems = commands;
  renderCommandPaletteResults(commands);
}

function toggleCommandPalette() {
  const commandPalette = document.getElementById('commandPalette');
  const commandPaletteInput = document.getElementById('commandPaletteInput');

  commandPaletteActive = !commandPaletteActive;

  if (commandPaletteActive) {
    commandPalette.classList.add('active');
    commandPaletteInput.value = '';
    commandPaletteInput.focus();
    commandPaletteSelectedIndex = 0;
  } else {
    commandPalette.classList.remove('active');
  }
}

// Count-up animation for KPI cards
function animateCountUp(element, target, duration = 1000) {
  const start = 0;
  const startTime = performance.now();

  function update(currentTime) {
    const elapsed = currentTime - startTime;
    const progress = Math.min(elapsed / duration, 1);

    // Easing function (easeOutExpo)
    const value = start + (target - start) * (1 - Math.pow(2, -10 * progress));

    element.textContent = Math.floor(value);
    element.classList.add('animate-count-up');

    if (progress < 1) {
      requestAnimationFrame(update);
    } else {
      element.textContent = target;
    }
  }

  requestAnimationFrame(update);
}

// Enhanced toast notifications
let toastQueue = [];
let toastTimeout = null;

function showToast(message, type = 'success', duration = 3000) {
  const container = document.querySelector('.toast-container') || createToastContainer();

  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = `
    <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
      ${type === 'success' ? '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>' :
       type === 'error' ? '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>' :
       '<path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>'}
    </svg>
    <span>${message}</span>
    <button class="toast-close" onclick="this.parentElement.remove()">âœ•</button>
    <div class="toast-progress"></div>
  `;

  container.appendChild(toast);

  // Auto remove after duration
  setTimeout(() => {
    toast.classList.add('removing');
    setTimeout(() => toast.remove(), 300);
  }, duration);
}

function createToastContainer() {
  const container = document.createElement('div');
  container.className = 'toast-container';
  document.body.appendChild(container);
  return container;
}

// Mobile navigation
function initMobileNav() {
  const mobileNavItems = document.querySelectorAll('.mobile-nav-item[data-view]');

  mobileNavItems.forEach(item => {
    item.addEventListener('click', () => {
      const view = item.dataset.view;
      switchView(view);

      // Update active state
      mobileNavItems.forEach(i => i.classList.remove('active'));
      item.classList.add('active');
    });
  });
}

// Update breadcrumbs
function updateBreadcrumbs(viewName) {
  const breadcrumbsContainer = document.querySelector('.breadcrumbs');
  if (!breadcrumbsContainer) return;

  const viewNames = {
    'dashboard': 'Tableau de bord',
    'patients': 'Patients',
    'archived': 'ArchivÃ©s',
    'ordos': 'Ordonnances',
    'switches': 'Switch Pompes',
    'appointments': 'Suivis / RDV',
    'catalogs': 'RÃ©fÃ©rentiels',
    'report': 'Statistiques',
    'backup': 'Import/Export',
    'debug': 'Debug',
    'update': 'Mise Ã  jour',
    'about': 'Ã€ propos'
  };

  const viewIcon = {
    'dashboard': 'ðŸ ',
    'patients': 'ðŸ‘¥',
    'archived': 'ðŸ“¦',
    'ordos': 'ðŸ“‹',
    'switches': 'ðŸ”„',
    'appointments': 'ðŸ“…',
    'catalogs': 'ðŸ“š',
    'report': 'ðŸ“ˆ',
    'backup': 'ðŸ’¾',
    'debug': 'ðŸ›',
    'update': 'ðŸ”„',
    'about': 'â„¹ï¸'
  };

  breadcrumbsContainer.innerHTML = `
    <button class="breadcrumb-item" onclick="switchView('dashboard')">
      <span>ðŸ </span>
      <span>Accueil</span>
    </button>
    ${viewName !== 'dashboard' ? `
      <span class="breadcrumb-separator">â€º</span>
      <span class="breadcrumb-item active">
        <span>${viewIcon[viewName] || ''}</span>
        <span>${viewNames[viewName] || viewName}</span>
      </span>
    ` : ''}
  `;
}

// Add breadcrumbs to main section
function addBreadcrumbsToMain() {
  const main = document.querySelector('.main');
  if (!main) return;

  const breadcrumbs = document.createElement('div');
  breadcrumbs.className = 'breadcrumbs';
  main.insertBefore(breadcrumbs, main.firstChild);

  updateBreadcrumbs('dashboard');
}

// Empty state generator
function createEmptyState(config) {
  const { icon, title, description, actionText, actionCallback } = config;

  return `
    <div class="empty-state">
      <svg class="empty-state-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        ${icon}
      </svg>
      <h3 class="empty-state-title">${title}</h3>
      <p class="empty-state-description">${description}</p>
      ${actionText ? `
        <button class="empty-state-action" onclick="${actionCallback}">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
          </svg>
          ${actionText}
        </button>
      ` : ''}
    </div>
  `;
}

// Add glassmorphism to modals
function enhanceModals() {
  const modals = document.querySelectorAll('.modal:not(.tutorial-modal)');
  modals.forEach(modal => {
    modal.classList.add('glass');
  });
}

// Form validation enhancement
function enhanceFormValidation() {
  const forms = document.querySelectorAll('form');

  forms.forEach(form => {
    const inputs = form.querySelectorAll('.form-input, .form-select, .form-textarea');

    inputs.forEach(input => {
      input.addEventListener('blur', () => {
        validateField(input);
      });

      input.addEventListener('input', () => {
        const formGroup = input.closest('.form-group');
        if (formGroup && formGroup.classList.contains('has-error')) {
          validateField(input);
        }
      });
    });
  });
}

function validateField(input) {
  const formGroup = input.closest('.form-group');
  if (!formGroup) return;

  // Remove previous validation
  formGroup.classList.remove('has-error', 'has-success');
  const existingError = formGroup.querySelector('.form-error, .form-success');
  if (existingError) existingError.remove();

  // Check if required and empty
  if (input.hasAttribute('required') && !input.value.trim()) {
    formGroup.classList.add('has-error');
    const error = document.createElement('div');
    error.className = 'form-error';
    error.innerHTML = `
      <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
      </svg>
      <span>Ce champ est requis</span>
    `;
    formGroup.appendChild(error);
    return false;
  }

  // If valid and has value
  if (input.value.trim()) {
    formGroup.classList.add('has-success');
  }

  return true;
}

// Add success animation to buttons
function addSuccessAnimationToButton(button) {
  button.classList.add('animate-success');
  setTimeout(() => {
    button.classList.remove('animate-success');
  }, 600);
}

// Override the original switchView to add breadcrumbs update
const originalSwitchView = switchView;
switchView = function(viewName) {
  originalSwitchView(viewName);
  updateBreadcrumbs(viewName);

  // Update mobile nav
  const mobileNavItems = document.querySelectorAll('.mobile-nav-item[data-view]');
  mobileNavItems.forEach(item => {
    item.classList.toggle('active', item.dataset.view === viewName);
  });
};

// Initialize all UI enhancements
function initUIEnhancements() {
  initCommandPalette();
  initMobileNav();
  addBreadcrumbsToMain();
  enhanceModals();
  enhanceFormValidation();

  // Override showNotification to use new toast
  window.originalShowNotification = window.showNotification;
  window.showNotification = function(message, type = 'success') {
    showToast(message, type);
  };

  console.log('âœ¨ UI Enhancements loaded successfully!');
}

// Initialize when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initUIEnhancements);
} else {
  initUIEnhancements();
}

// Expose new functions
window.toggleCommandPalette = toggleCommandPalette;
window.showToast = showToast;
window.animateCountUp = animateCountUp;
window.createEmptyState = createEmptyState;
window.addSuccessAnimationToButton = addSuccessAnimationToButton;

})();
</script>

<!-- Tutorial Modal -->
<div class="modal tutorial-modal" id="tutorialModal">
  <div class="modal-content">
    <div class="tutorial-header">
      <h2>ðŸŽ“ Bienvenue dans NHC Patients Manager</h2>
      <p>DÃ©couvrez toutes les fonctionnalitÃ©s de l'application</p>
    </div>
    
    <div class="tutorial-progress" id="tutorialProgress"></div>
    
    <div class="tutorial-content" id="tutorialContent">
      <div class="tutorial-step active" data-step="1">
        <div class="tutorial-step-number">1</div>
        <h3>ðŸ‘‹ PrÃ©sentation de l'application</h3>
        <p>NHC Patients Manager est une application complÃ¨te pour gÃ©rer vos patients sous pompe Ã  insuline. Elle vous permet de suivre les ordonnances, planifier les switchs de pompes, gÃ©rer les rendez-vous et bien plus encore.</p>
        
        <div class="tutorial-feature">
          <h4>
            <span class="tutorial-feature-icon">ðŸ“Š</span>
            Tableau de bord complet
          </h4>
          <p>Vue d'ensemble de vos patients, ordonnances et rendez-vous Ã  venir</p>
        </div>
        
        <div class="tutorial-feature">
          <h4>
            <span class="tutorial-feature-icon">ðŸ’¾</span>
            Sauvegarde automatique
          </h4>
          <p>Vos donnÃ©es sont automatiquement sauvegardÃ©es localement dans votre navigateur</p>
        </div>
        
        <div class="tutorial-tip">
          <strong>ðŸ’¡ Astuce</strong>
          <p>Utilisez ce tutoriel Ã  tout moment en cliquant sur le bouton "ðŸŽ“ Tutoriel" dans la barre latÃ©rale</p>
        </div>
      </div>
    </div>
    
    <div class="tutorial-navigation">
      <div class="tutorial-step" data-step="2">
        <div class="tutorial-step-number">2</div>
        <h3>ðŸ‘¤ Ajouter un patient</h3>
        <p>La premiÃ¨re Ã©tape est d'ajouter vos patients au systÃ¨me. Voici comment procÃ©der :</p>
        
        <div class="tutorial-feature">
          <h4>
            <span class="tutorial-feature-icon">âž•</span>
            MÃ©thode 1 : Ajout manuel
          </h4>
          <p>Cliquez sur "Patients" dans le menu, puis sur le bouton "+ Nouveau patient"</p>
          <ul>
            <li>Remplissez les informations du patient (nom, prÃ©nom, date de naissance)</li>
            <li>Ajoutez le code patient et les informations mÃ©dicales</li>
            <li>DÃ©finissez le protocole actuel et le centre de suivi</li>
          </ul>
        </div>
        
        <div class="tutorial-feature">
          <h4>
            <span class="tutorial-feature-icon">ðŸ“„</span>
            MÃ©thode 2 : Import CSV
          </h4>
          <p>Importez plusieurs patients en une seule fois depuis un fichier CSV (voir Ã©tape 7)</p>
        </div>
        
        <div class="tutorial-tip">
          <strong>ðŸ’¡ Astuce</strong>
          <p>Vous pouvez modifier un patient Ã  tout moment en cliquant sur son nom dans la liste</p>
        </div>
      </div>
      
      <!-- Step 3: Gestion des ordonnances -->
      <div class="tutorial-step" data-step="3">
        <div class="tutorial-step-number">3</div>
        <h3>ðŸ“‹ GÃ©rer les ordonnances</h3>
        <p>Suivez les cycles d'ordonnances de vos patients et anticipez les renouvellements.</p>
        
        <div class="tutorial-feature">
          <h4>
            <span class="tutorial-feature-icon">ðŸ“</span>
            CrÃ©er une ordonnance
          </h4>
          <p>Depuis la fiche patient, cliquez sur "Nouvelle ordonnance" :</p>
          <ul>
            <li>SÃ©lectionnez le mÃ©decin prescripteur</li>
            <li>DÃ©finissez la date de dÃ©but et la durÃ©e du cycle</li>
            <li>Le systÃ¨me calcule automatiquement la date de fin</li>
          </ul>
        </div>
        
        <div class="tutorial-feature">
          <h4>
            <span class="tutorial-feature-icon">ðŸ””</span>
            Alertes de renouvellement
          </h4>
          <p>Les ordonnances qui arrivent Ã  Ã©chÃ©ance sont signalÃ©es automatiquement dans le tableau de bord</p>
        </div>
        
        <div class="tutorial-tip">
          <strong>ðŸ’¡ Astuce</strong>
          <p>Utilisez la fonction "Renouvellement groupÃ©" pour traiter plusieurs ordonnances en mÃªme temps</p>
        </div>
      </div>
      
      <!-- Step 4: Switch de pompes -->
      <div class="tutorial-step" data-step="4">
        <div class="tutorial-step-number">4</div>
        <h3>ðŸ”„ Planifier les switchs de pompes</h3>
        <p>GÃ©rez les changements de pompe Ã  insuline de vos patients avec la fonction Switch.</p>
        
        <div class="tutorial-feature">
          <h4>
            <span class="tutorial-feature-icon">ðŸ“…</span>
            CrÃ©er un switch
          </h4>
          <p>AccÃ©dez Ã  "Switch Pompes" dans le menu :</p>
          <ul>
            <li>Cliquez sur "+ Nouveau switch"</li>
            <li>SÃ©lectionnez le patient et la date du switch</li>
            <li>Choisissez l'ancien et le nouveau protocole</li>
            <li>Ajoutez des notes si nÃ©cessaire</li>
          </ul>
        </div>
        
        <div class="tutorial-feature">
          <h4>
            <span class="tutorial-feature-icon">âœ…</span>
            Valider un switch
          </h4>
          <p>Une fois le switch effectuÃ©, validez-le pour :</p>
          <ul>
            <li>Mettre Ã  jour automatiquement le protocole du patient</li>
            <li>GÃ©nÃ©rer une ordonnance si nÃ©cessaire</li>
            <li>Marquer le switch comme "EffectuÃ©"</li>
          </ul>
        </div>
        
        <div class="tutorial-tip">
          <strong>ðŸ’¡ Astuce</strong>
          <p>Utilisez la vue "Timeline" pour visualiser tous vos switchs sur 3 mois glissants (1 mois avant, 2 mois aprÃ¨s)</p>
        </div>
      </div>
      
      <!-- Step 5: Timeline -->
      <div class="tutorial-step" data-step="5">
        <div class="tutorial-step-number">5</div>
        <h3>ðŸ“† Timeline des switchs (3 mois glissants)</h3>
        <p>Visualisez tous vos switchs planifiÃ©s sur une pÃ©riode de 3 mois.</p>
        
        <div class="tutorial-feature">
          <h4>
            <span class="tutorial-feature-icon">ðŸ—“ï¸</span>
            Vue chronologique
          </h4>
          <p>La timeline affiche automatiquement :</p>
          <ul>
            <li>1 mois avant la date actuelle</li>
            <li>Le mois en cours (mis en Ã©vidence)</li>
            <li>2 mois aprÃ¨s la date actuelle</li>
          </ul>
        </div>
        
        <div class="tutorial-feature">
          <h4>
            <span class="tutorial-feature-icon">ðŸŽ¨</span>
            Codes couleur
          </h4>
          <p>Les switchs sont colorÃ©s selon leur statut :</p>
          <ul>
            <li><strong style="color: #ef4444;">Rouge</strong> : En retard</li>
            <li><strong style="color: #f59e0b;">Orange</strong> : Aujourd'hui</li>
            <li><strong style="color: #3b82f6;">Bleu</strong> : Cette semaine</li>
            <li><strong style="color: #10b981;">Vert</strong> : Ã€ venir</li>
            <li><strong style="color: #6b7280;">Gris</strong> : EffectuÃ©</li>
          </ul>
        </div>
        
        <div class="tutorial-tip">
          <strong>ðŸ’¡ Astuce</strong>
          <p>Cliquez sur un switch dans la timeline pour l'ouvrir et le modifier ou le valider directement</p>
        </div>
      </div>
      
      <!-- Step 6: Rendez-vous -->
      <div class="tutorial-step" data-step="6">
        <div class="tutorial-step-number">6</div>
        <h3>ðŸ—“ï¸ GÃ©rer les rendez-vous</h3>
        <p>Planifiez et suivez les rendez-vous de vos patients.</p>
        
        <div class="tutorial-feature">
          <h4>
            <span class="tutorial-feature-icon">âž•</span>
            CrÃ©er un rendez-vous
          </h4>
          <p>Dans "Suivis / RDV" :</p>
          <ul>
            <li>Cliquez sur "+ Nouveau rendez-vous"</li>
            <li>SÃ©lectionnez le patient et la date</li>
            <li>Choisissez le type (consultation, formation, suivi)</li>
            <li>Ajoutez des notes</li>
          </ul>
        </div>
        
        <div class="tutorial-feature">
          <h4>
            <span class="tutorial-feature-icon">âœ…</span>
            ComplÃ©ter un rendez-vous
          </h4>
          <p>AprÃ¨s le rendez-vous, marquez-le comme "EffectuÃ©" et planifiez Ã©ventuellement le prochain</p>
        </div>
        
        <div class="tutorial-tip">
          <strong>ðŸ’¡ Astuce</strong>
          <p>Les rendez-vous Ã  venir s'affichent dans le tableau de bord avec des alertes colorÃ©es</p>
        </div>
      </div>
      
      <!-- Step 7: Import CSV -->
      <div class="tutorial-step" data-step="7">
        <div class="tutorial-step-number">7</div>
        <h3>ðŸ“¥ Importer des donnÃ©es CSV</h3>
        <p>Importez plusieurs patients en une seule fois depuis un fichier CSV.</p>
        
        <div class="tutorial-feature">
          <h4>
            <span class="tutorial-feature-icon">ðŸ“„</span>
            PrÃ©parer le fichier CSV
          </h4>
          <p>Votre fichier CSV peut contenir les colonnes suivantes :</p>
          <ul>
            <li>Nom, PrÃ©nom, Date de naissance</li>
            <li>Code patient, TÃ©lÃ©phone, Email</li>
            <li>Protocole, Centre</li>
          </ul>
        </div>
        
        <div class="tutorial-feature">
          <h4>
            <span class="tutorial-feature-icon">ðŸ”„</span>
            Processus d'import
          </h4>
          <p>Dans "Import/Export" :</p>
          <ul>
            <li>SÃ©lectionnez votre fichier CSV</li>
            <li>Mappez les colonnes automatiquement ou manuellement</li>
            <li>PrÃ©visualisez les donnÃ©es avant l'import</li>
            <li>Validez l'import</li>
          </ul>
        </div>
        
        <div class="tutorial-tip">
          <strong>ðŸ’¡ Astuce</strong>
          <p>L'application dÃ©tecte automatiquement le format et le sÃ©parateur de votre fichier CSV</p>
        </div>
      </div>
      
      <!-- Step 8: Sauvegarde automatique -->
      <div class="tutorial-step" data-step="8">
        <div class="tutorial-step-number">8</div>
        <h3>ðŸ’¾ Sauvegarde automatique</h3>
        <p>Vos donnÃ©es sont protÃ©gÃ©es grÃ¢ce au systÃ¨me de sauvegarde automatique.</p>
        
        <div class="tutorial-feature">
          <h4>
            <span class="tutorial-feature-icon">âš¡</span>
            Sauvegarde locale
          </h4>
          <p>Toutes vos donnÃ©es sont automatiquement enregistrÃ©es dans le navigateur :</p>
          <ul>
            <li>Aucune connexion Internet requise</li>
            <li>DonnÃ©es stockÃ©es localement sur votre appareil</li>
            <li>Sauvegarde aprÃ¨s chaque modification</li>
          </ul>
        </div>
        
        <div class="tutorial-feature">
          <h4>
            <span class="tutorial-feature-icon">ðŸ“¤</span>
            Export de sauvegarde
          </h4>
          <p>Dans "Import/Export", vous pouvez :</p>
          <ul>
            <li>Exporter toute votre base de donnÃ©es en JSON</li>
            <li>CrÃ©er une sauvegarde manuelle Ã  tout moment</li>
            <li>Importer une sauvegarde prÃ©cÃ©dente</li>
          </ul>
        </div>
        
        <div class="tutorial-tip">
          <strong>ðŸ’¡ Astuce</strong>
          <p>Faites rÃ©guliÃ¨rement des sauvegardes manuelles en exportant vos donnÃ©es pour plus de sÃ©curitÃ©</p>
        </div>
      </div>
      
      <!-- Step 9: Export Excel/PDF -->
      <div class="tutorial-step" data-step="9">
        <div class="tutorial-step-number">9</div>
        <h3>ðŸ“Š Exporter vers Excel et PDF</h3>
        <p>CrÃ©ez des rapports professionnels en quelques clics.</p>
        
        <div class="tutorial-feature">
          <h4>
            <span class="tutorial-feature-icon">ðŸ“—</span>
            Export Excel
          </h4>
          <p>Exportez vos donnÃ©es en format Excel :</p>
          <ul>
            <li>Liste complÃ¨te des patients avec toutes leurs informations</li>
            <li>Ordonnances avec dates et cycles</li>
            <li>Switchs planifiÃ©s et historique</li>
            <li>Format compatible avec Microsoft Excel et LibreOffice</li>
          </ul>
        </div>
        
        <div class="tutorial-feature">
          <h4>
            <span class="tutorial-feature-icon">ðŸ“•</span>
            Export PDF
          </h4>
          <p>GÃ©nÃ©rez des PDF pour les cycles d'ordonnances :</p>
          <ul>
            <li>Fiche patient complÃ¨te</li>
            <li>DÃ©tails du cycle en cours</li>
            <li>Historique des ordonnances</li>
            <li>Format professionnel prÃªt Ã  imprimer</li>
          </ul>
        </div>
        
        <div class="tutorial-tip">
          <strong>ðŸ’¡ Astuce</strong>
          <p>Utilisez l'export Excel pour crÃ©er des analyses personnalisÃ©es dans votre tableur favori</p>
        </div>
      </div>
      
      <!-- Step 10: RÃ©fÃ©rentiels -->
      <div class="tutorial-step" data-step="10">
        <div class="tutorial-step-number">10</div>
        <h3>ðŸ“š GÃ©rer les rÃ©fÃ©rentiels</h3>
        <p>Configurez les protocoles, mÃ©decins et centres pour personnaliser l'application.</p>
        
        <div class="tutorial-feature">
          <h4>
            <span class="tutorial-feature-icon">ðŸ’Š</span>
            Protocoles
          </h4>
          <p>Ajoutez les diffÃ©rents types de pompes et protocoles que vous utilisez</p>
        </div>
        
        <div class="tutorial-feature">
          <h4>
            <span class="tutorial-feature-icon">ðŸ‘¨â€âš•ï¸</span>
            MÃ©decins prescripteurs
          </h4>
          <p>CrÃ©ez la liste des mÃ©decins qui prescrivent les ordonnances</p>
        </div>
        
        <div class="tutorial-feature">
          <h4>
            <span class="tutorial-feature-icon">ðŸ¥</span>
            Centres de suivi
          </h4>
          <p>DÃ©finissez les diffÃ©rents centres oÃ¹ vos patients sont suivis</p>
        </div>
        
        <div class="tutorial-tip">
          <strong>ðŸ’¡ Astuce</strong>
          <p>Configurez d'abord vos rÃ©fÃ©rentiels avant d'ajouter des patients pour une saisie plus rapide</p>
        </div>
      </div>
      
      <!-- Step 11: Fin -->
      <div class="tutorial-step" data-step="11">
        <div class="tutorial-step-number">âœ“</div>
        <h3>ðŸŽ‰ Vous Ãªtes prÃªt !</h3>
        <p>Vous connaissez maintenant toutes les fonctionnalitÃ©s principales de NHC Patients Manager.</p>
        
        <div class="tutorial-feature">
          <h4>
            <span class="tutorial-feature-icon">ðŸš€</span>
            Prochaines Ã©tapes
          </h4>
          <ul>
            <li>Configurez vos rÃ©fÃ©rentiels (protocoles, mÃ©decins, centres)</li>
            <li>Ajoutez vos premiers patients</li>
            <li>CrÃ©ez des ordonnances et planifiez des switchs</li>
            <li>Explorez les diffÃ©rentes vues et rapports</li>
          </ul>
        </div>
        
        <div class="tutorial-feature">
          <h4>
            <span class="tutorial-feature-icon">ðŸ’¡</span>
            Besoin d'aide ?
          </h4>
          <p>Vous pouvez relancer ce tutoriel Ã  tout moment en cliquant sur le bouton "ðŸŽ“ Tutoriel" dans la barre latÃ©rale</p>
        </div>
        
        <div style="text-align: center; padding: 2rem 0;">
          <div style="font-size: 4rem; margin-bottom: 1rem;">ðŸŽŠ</div>
          <p style="font-size: 1.25rem; font-weight: 600; color: var(--primary);">Bonne utilisation de l'application !</p>
        </div>
      </div>
    </div>
    
    <div class="tutorial-navigation">
      <div style="display: flex; align-items: center; gap: 0.5rem;">
        <input type="checkbox" id="tutorialDontShowAgain" style="cursor: pointer;">
        <label for="tutorialDontShowAgain" style="cursor: pointer; font-size: 0.9rem; color: var(--text-secondary); user-select: none;">
          Ne plus afficher automatiquement
        </label>
      </div>
      <div class="tutorial-step-indicator">
        <span id="currentStepNum">1</span> / <span id="totalSteps">11</span>
      </div>
      <div class="tutorial-nav-buttons">
        <button class="btn btn-secondary" id="tutorialPrevBtn" onclick="previousTutorialStep()">
          â† PrÃ©cÃ©dent
        </button>
        <button class="btn btn-secondary" onclick="closeTutorial()">
          Fermer
        </button>
        <button class="btn btn-primary" id="tutorialNextBtn" onclick="nextTutorialStep()">
          Suivant â†’
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Command Palette -->
<div class="command-palette" id="commandPalette">
  <div class="command-palette-content">
    <div class="command-palette-search">
      <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
      </svg>
      <input type="text" class="command-palette-input" id="commandPaletteInput" placeholder="Rechercher des actions ou des patients...">
    </div>
    <div class="command-palette-results" id="commandPaletteResults"></div>
  </div>
</div>

<!-- Mobile Bottom Navigation -->
<nav class="mobile-nav">
  <div class="mobile-nav-items">
    <button class="mobile-nav-item active" data-view="dashboard">
      <svg fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>
      <span>Accueil</span>
    </button>
    <button class="mobile-nav-item" data-view="patients">
      <svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>
      <span>Patients</span>
    </button>
    <button class="mobile-nav-item" data-view="ordos">
      <svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"></path></svg>
      <span>Ordos</span>
    </button>
    <button class="mobile-nav-item" data-view="switches">
      <svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path></svg>
      <span>Switch</span>
    </button>
    <button class="mobile-nav-item" onclick="toggleCommandPalette()">
      <svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>
      <span>Plus</span>
    </button>
  </div>
</nav>

</body>
</html>